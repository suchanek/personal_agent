<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>personal_agent.core API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../personal_agent.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;personal_agent</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#SimpleMCPClient">SimpleMCPClient</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SimpleMCPClient.__init__">SimpleMCPClient</a>
                        </li>
                        <li>
                                <a class="variable" href="#SimpleMCPClient.server_configs">server_configs</a>
                        </li>
                        <li>
                                <a class="variable" href="#SimpleMCPClient.active_servers">active_servers</a>
                        </li>
                        <li>
                                <a class="function" href="#SimpleMCPClient.start_server_sync">start_server_sync</a>
                        </li>
                        <li>
                                <a class="function" href="#SimpleMCPClient.call_tool_sync">call_tool_sync</a>
                        </li>
                        <li>
                                <a class="function" href="#SimpleMCPClient.list_tools_sync">list_tools_sync</a>
                        </li>
                        <li>
                                <a class="function" href="#SimpleMCPClient.stop_server_sync">stop_server_sync</a>
                        </li>
                        <li>
                                <a class="function" href="#SimpleMCPClient.start_servers">start_servers</a>
                        </li>
                        <li>
                                <a class="function" href="#SimpleMCPClient.stop_all_servers">stop_all_servers</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#setup_weaviate">setup_weaviate</a>
            </li>
            <li>
                    <a class="function" href="#is_weaviate_connected">is_weaviate_connected</a>
            </li>
            <li>
                    <a class="function" href="#reset_weaviate_if_corrupted">reset_weaviate_if_corrupted</a>
            </li>
            <li>
                    <a class="function" href="#is_agno_storage_connected">is_agno_storage_connected</a>
            </li>
            <li>
                    <a class="function" href="#is_memory_connected">is_memory_connected</a>
            </li>
            <li>
                    <a class="function" href="#create_agent_executor">create_agent_executor</a>
            </li>
            <li>
                    <a class="function" href="#create_simple_personal_agent">create_simple_personal_agent</a>
            </li>
            <li>
                    <a class="function" href="#load_agent_knowledge">load_agent_knowledge</a>
            </li>
            <li>
                    <a class="class" href="#AgentKnowledgeManager">AgentKnowledgeManager</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.__init__">AgentKnowledgeManager</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentKnowledgeManager.user_id">user_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentKnowledgeManager.storage_dir">storage_dir</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentKnowledgeManager.lightrag_url">lightrag_url</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentKnowledgeManager.lightrag_memory_url">lightrag_memory_url</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentKnowledgeManager.knowledge_base_file">knowledge_base_file</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentKnowledgeManager.knowledge_base">knowledge_base</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.add_fact">add_fact</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.get_facts">get_facts</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.set_preference">set_preference</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.get_preference">get_preference</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.get_all_preferences">get_all_preferences</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.add_entity">add_entity</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.get_entity">get_entity</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.update_entity">update_entity</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.add_relationship">add_relationship</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.get_relationships">get_relationships</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.clear_knowledge_base">clear_knowledge_base</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.sync_with_graph">sync_with_graph</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentKnowledgeManager.query_graph">query_graph</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#AgentMemoryManager">AgentMemoryManager</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AgentMemoryManager.__init__">AgentMemoryManager</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentMemoryManager.user_id">user_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentMemoryManager.storage_dir">storage_dir</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentMemoryManager.agno_memory">agno_memory</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentMemoryManager.lightrag_url">lightrag_url</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentMemoryManager.lightrag_memory_url">lightrag_memory_url</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentMemoryManager.enable_memory">enable_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.initialize">initialize</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.direct_search_memories">direct_search_memories</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.store_user_memory">store_user_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.restate_user_fact">restate_user_fact</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.seed_entity_in_graph">seed_entity_in_graph</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.check_entity_exists">check_entity_exists</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.clear_all_memories">clear_all_memories</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.query_memory">query_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.update_memory">update_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.delete_memory">delete_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.get_recent_memories">get_recent_memories</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.get_all_memories">get_all_memories</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.get_memory_stats">get_memory_stats</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.get_memories_by_topic">get_memories_by_topic</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.list_memories">list_memories</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.store_graph_memory">store_graph_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.query_graph_memory">query_graph_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.get_memory_graph_labels">get_memory_graph_labels</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentMemoryManager.delete_memories_by_topic">delete_memories_by_topic</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#AgentModelManager">AgentModelManager</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AgentModelManager.__init__">AgentModelManager</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentModelManager.model_provider">model_provider</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentModelManager.model_name">model_name</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentModelManager.ollama_base_url">ollama_base_url</a>
                        </li>
                        <li>
                                <a class="variable" href="#AgentModelManager.seed">seed</a>
                        </li>
                        <li>
                                <a class="function" href="#AgentModelManager.create_model">create_model</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MultiAgentSystem">MultiAgentSystem</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MultiAgentSystem.__init__">MultiAgentSystem</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiAgentSystem.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiAgentSystem.mcp_client">mcp_client</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiAgentSystem.weaviate_client">weaviate_client</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiAgentSystem.vector_store">vector_store</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiAgentSystem.tool_groups">tool_groups</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiAgentSystem.agent">agent</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiAgentSystem.run">run</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiAgentSystem.get_agent_info">get_agent_info</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiAgentSystem.list_available_tools">list_available_tools</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#create_multi_agent_system">create_multi_agent_system</a>
            </li>
            <li>
                    <a class="function" href="#create_smolagents_executor">create_smolagents_executor</a>
            </li>
            <li>
                    <a class="function" href="#create_smolagents_model">create_smolagents_model</a>
            </li>
            <li>
                    <a class="function" href="#create_agno_storage">create_agno_storage</a>
            </li>
            <li>
                    <a class="function" href="#create_agno_memory">create_agno_memory</a>
            </li>
            <li>
                    <a class="function" href="#create_combined_knowledge_base">create_combined_knowledge_base</a>
            </li>
            <li>
                    <a class="function" href="#load_combined_knowledge_base">load_combined_knowledge_base</a>
            </li>
            <li>
                    <a class="function" href="#load_lightrag_knowledge_base">load_lightrag_knowledge_base</a>
            </li>
            <li>
                    <a class="class" href="#AntiDuplicateMemory">AntiDuplicateMemory</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AntiDuplicateMemory.__init__">AntiDuplicateMemory</a>
                        </li>
                        <li>
                                <a class="variable" href="#AntiDuplicateMemory.similarity_threshold">similarity_threshold</a>
                        </li>
                        <li>
                                <a class="variable" href="#AntiDuplicateMemory.enable_semantic_dedup">enable_semantic_dedup</a>
                        </li>
                        <li>
                                <a class="variable" href="#AntiDuplicateMemory.enable_exact_dedup">enable_exact_dedup</a>
                        </li>
                        <li>
                                <a class="variable" href="#AntiDuplicateMemory.debug_mode">debug_mode</a>
                        </li>
                        <li>
                                <a class="variable" href="#AntiDuplicateMemory.enable_optimizations">enable_optimizations</a>
                        </li>
                        <li>
                                <a class="function" href="#AntiDuplicateMemory.add_user_memory">add_user_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#AntiDuplicateMemory.create_user_memories">create_user_memories</a>
                        </li>
                        <li>
                                <a class="function" href="#AntiDuplicateMemory.delete_user_memory">delete_user_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#AntiDuplicateMemory.get_memory_stats">get_memory_stats</a>
                        </li>
                        <li>
                                <a class="function" href="#AntiDuplicateMemory.print_memory_analysis">print_memory_analysis</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#create_anti_duplicate_memory">create_anti_duplicate_memory</a>
            </li>
            <li>
                    <a class="class" href="#SemanticMemoryManager">SemanticMemoryManager</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SemanticMemoryManager.__init__">SemanticMemoryManager</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticMemoryManager.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticMemoryManager.config">config</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticMemoryManager.topic_classifier">topic_classifier</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticMemoryManager.duplicate_detector">duplicate_detector</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticMemoryManager.memories_updated">memories_updated</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.add_memory">add_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.update_memory">update_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.delete_memory">delete_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.delete_memories_by_topic">delete_memories_by_topic</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.clear_memories">clear_memories</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.search_memories">search_memories</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.get_memories_by_topic">get_memories_by_topic</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.get_all_memories">get_all_memories</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.get_memory_stats">get_memory_stats</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.process_input">process_input</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.create_or_update_memories">create_or_update_memories</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.acreate_or_update_memories">acreate_or_update_memories</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.run_memory_task">run_memory_task</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticMemoryManager.arun_memory_task">arun_memory_task</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SemanticMemoryManagerConfig">SemanticMemoryManagerConfig</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#SemanticMemoryManagerConfig.similarity_threshold">similarity_threshold</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticMemoryManagerConfig.enable_semantic_dedup">enable_semantic_dedup</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticMemoryManagerConfig.enable_exact_dedup">enable_exact_dedup</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticMemoryManagerConfig.enable_topic_classification">enable_topic_classification</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticMemoryManagerConfig.max_memory_length">max_memory_length</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticMemoryManagerConfig.recent_memory_limit">recent_memory_limit</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticMemoryManagerConfig.debug_mode">debug_mode</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticMemoryManagerConfig.model_config">model_config</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SemanticDuplicateDetector">SemanticDuplicateDetector</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SemanticDuplicateDetector.__init__">SemanticDuplicateDetector</a>
                        </li>
                        <li>
                                <a class="variable" href="#SemanticDuplicateDetector.similarity_threshold">similarity_threshold</a>
                        </li>
                        <li>
                                <a class="function" href="#SemanticDuplicateDetector.is_duplicate">is_duplicate</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#create_semantic_memory_manager">create_semantic_memory_manager</a>
            </li>
            <li>
                    <a class="class" href="#KnowledgeCoordinator">KnowledgeCoordinator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#KnowledgeCoordinator.__init__">KnowledgeCoordinator</a>
                        </li>
                        <li>
                                <a class="variable" href="#KnowledgeCoordinator.agno_knowledge">agno_knowledge</a>
                        </li>
                        <li>
                                <a class="variable" href="#KnowledgeCoordinator.lightrag_url">lightrag_url</a>
                        </li>
                        <li>
                                <a class="variable" href="#KnowledgeCoordinator.debug">debug</a>
                        </li>
                        <li>
                                <a class="variable" href="#KnowledgeCoordinator.routing_stats">routing_stats</a>
                        </li>
                        <li>
                                <a class="function" href="#KnowledgeCoordinator.query_knowledge_base">query_knowledge_base</a>
                        </li>
                        <li>
                                <a class="function" href="#KnowledgeCoordinator.get_routing_stats">get_routing_stats</a>
                        </li>
                        <li>
                                <a class="function" href="#KnowledgeCoordinator.reset_stats">reset_stats</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#create_knowledge_coordinator">create_knowledge_coordinator</a>
            </li>
            <li>
                    <a class="function" href="#extract_entities">extract_entities</a>
            </li>
            <li>
                    <a class="function" href="#extract_relationships">extract_relationships</a>
            </li>
            <li>
                    <a class="class" href="#StructuredResponse">StructuredResponse</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#StructuredResponse.__init__">StructuredResponse</a>
                        </li>
                        <li>
                                <a class="variable" href="#StructuredResponse.content">content</a>
                        </li>
                        <li>
                                <a class="variable" href="#StructuredResponse.tool_calls">tool_calls</a>
                        </li>
                        <li>
                                <a class="variable" href="#StructuredResponse.metadata">metadata</a>
                        </li>
                        <li>
                                <a class="variable" href="#StructuredResponse.error">error</a>
                        </li>
                        <li>
                                <a class="variable" href="#StructuredResponse.has_tool_calls">has_tool_calls</a>
                        </li>
                        <li>
                                <a class="variable" href="#StructuredResponse.tool_calls_count">tool_calls_count</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#StructuredResponseParser">StructuredResponseParser</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#StructuredResponseParser.RESPONSE_SCHEMA">RESPONSE_SCHEMA</a>
                        </li>
                        <li>
                                <a class="function" href="#StructuredResponseParser.parse">parse</a>
                        </li>
                        <li>
                                <a class="function" href="#StructuredResponseParser.create_system_prompt">create_system_prompt</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ToolCall">ToolCall</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ToolCall.__init__">ToolCall</a>
                        </li>
                        <li>
                                <a class="variable" href="#ToolCall.function_name">function_name</a>
                        </li>
                        <li>
                                <a class="variable" href="#ToolCall.arguments">arguments</a>
                        </li>
                        <li>
                                <a class="variable" href="#ToolCall.reasoning">reasoning</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ResponseMetadata">ResponseMetadata</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ResponseMetadata.__init__">ResponseMetadata</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResponseMetadata.confidence">confidence</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResponseMetadata.sources">sources</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResponseMetadata.reasoning_steps">reasoning_steps</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResponseMetadata.response_type">response_type</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ResponseError">ResponseError</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ResponseError.__init__">ResponseError</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResponseError.code">code</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResponseError.message">message</a>
                        </li>
                        <li>
                                <a class="variable" href="#ResponseError.recoverable">recoverable</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#get_ollama_format_schema">get_ollama_format_schema</a>
            </li>
            <li>
                    <a class="function" href="#create_structured_instructions">create_structured_instructions</a>
            </li>
            <li>
                    <a class="class" href="#TopicClassifier">TopicClassifier</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TopicClassifier.__init__">TopicClassifier</a>
                        </li>
                        <li>
                                <a class="variable" href="#TopicClassifier.stopwords">stopwords</a>
                        </li>
                        <li>
                                <a class="variable" href="#TopicClassifier.confidence_threshold">confidence_threshold</a>
                        </li>
                        <li>
                                <a class="variable" href="#TopicClassifier.keyword_weight">keyword_weight</a>
                        </li>
                        <li>
                                <a class="variable" href="#TopicClassifier.phrase_weight">phrase_weight</a>
                        </li>
                        <li>
                                <a class="function" href="#TopicClassifier.load_config">load_config</a>
                        </li>
                        <li>
                                <a class="function" href="#TopicClassifier.clean_text">clean_text</a>
                        </li>
                        <li>
                                <a class="function" href="#TopicClassifier.classify">classify</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#RuleSet">RuleSet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#RuleSet.__init__">RuleSet</a>
                        </li>
                        <li>
                                <a class="variable" href="#RuleSet.keywords">keywords</a>
                        </li>
                        <li>
                                <a class="variable" href="#RuleSet.patterns">patterns</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#UserManager">UserManager</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#UserManager.__init__">UserManager</a>
                        </li>
                        <li>
                                <a class="variable" href="#UserManager.registry">registry</a>
                        </li>
                        <li>
                                <a class="variable" href="#UserManager.lightrag_manager">lightrag_manager</a>
                        </li>
                        <li>
                                <a class="function" href="#UserManager.get_all_users">get_all_users</a>
                        </li>
                        <li>
                                <a class="function" href="#UserManager.get_user">get_user</a>
                        </li>
                        <li>
                                <a class="function" href="#UserManager.create_user">create_user</a>
                        </li>
                        <li>
                                <a class="function" href="#UserManager.switch_user">switch_user</a>
                        </li>
                        <li>
                                <a class="function" href="#UserManager.delete_user">delete_user</a>
                        </li>
                        <li>
                                <a class="function" href="#UserManager.restart_lightrag_for_current_user">restart_lightrag_for_current_user</a>
                        </li>
                        <li>
                                <a class="function" href="#UserManager.get_lightrag_status">get_lightrag_status</a>
                        </li>
                        <li>
                                <a class="function" href="#UserManager.ensure_current_user_registered">ensure_current_user_registered</a>
                        </li>
                        <li>
                                <a class="function" href="#UserManager.update_user">update_user</a>
                        </li>
                        <li>
                                <a class="function" href="#UserManager.get_user_details">get_user_details</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#UserRegistry">UserRegistry</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#UserRegistry.__init__">UserRegistry</a>
                        </li>
                        <li>
                                <a class="variable" href="#UserRegistry.registry_file">registry_file</a>
                        </li>
                        <li>
                                <a class="function" href="#UserRegistry.add_user">add_user</a>
                        </li>
                        <li>
                                <a class="function" href="#UserRegistry.get_all_users">get_all_users</a>
                        </li>
                        <li>
                                <a class="function" href="#UserRegistry.get_user">get_user</a>
                        </li>
                        <li>
                                <a class="function" href="#UserRegistry.remove_user">remove_user</a>
                        </li>
                        <li>
                                <a class="function" href="#UserRegistry.update_last_seen">update_last_seen</a>
                        </li>
                        <li>
                                <a class="function" href="#UserRegistry.update_user">update_user</a>
                        </li>
                        <li>
                                <a class="function" href="#UserRegistry.user_exists">user_exists</a>
                        </li>
                        <li>
                                <a class="function" href="#UserRegistry.get_current_user">get_current_user</a>
                        </li>
                        <li>
                                <a class="function" href="#UserRegistry.ensure_current_user_registered">ensure_current_user_registered</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LightRAGManager">LightRAGManager</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LightRAGManager.__init__">LightRAGManager</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightRAGManager.lightrag_server_dir">lightrag_server_dir</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightRAGManager.lightrag_memory_dir">lightrag_memory_dir</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightRAGManager.project_root">project_root</a>
                        </li>
                        <li>
                                <a class="function" href="#LightRAGManager.update_docker_compose_user_id">update_docker_compose_user_id</a>
                        </li>
                        <li>
                                <a class="function" href="#LightRAGManager.restart_lightrag_services">restart_lightrag_services</a>
                        </li>
                        <li>
                                <a class="function" href="#LightRAGManager.get_service_status">get_service_status</a>
                        </li>
                        <li>
                                <a class="function" href="#LightRAGManager.stop_services">stop_services</a>
                        </li>
                        <li>
                                <a class="function" href="#LightRAGManager.start_services">start_services</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DockerIntegrationManager">DockerIntegrationManager</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DockerIntegrationManager.__init__">DockerIntegrationManager</a>
                        </li>
                        <li>
                                <a class="variable" href="#DockerIntegrationManager.user_id">user_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#DockerIntegrationManager.base_dir">base_dir</a>
                        </li>
                        <li>
                                <a class="variable" href="#DockerIntegrationManager.docker_sync">docker_sync</a>
                        </li>
                        <li>
                                <a class="function" href="#DockerIntegrationManager.check_docker_consistency">check_docker_consistency</a>
                        </li>
                        <li>
                                <a class="function" href="#DockerIntegrationManager.ensure_docker_consistency">ensure_docker_consistency</a>
                        </li>
                        <li>
                                <a class="function" href="#DockerIntegrationManager.validate_system_consistency">validate_system_consistency</a>
                        </li>
                        <li>
                                <a class="function" href="#DockerIntegrationManager.pre_initialization_check">pre_initialization_check</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#check_docker_user_consistency">check_docker_user_consistency</a>
            </li>
            <li>
                    <a class="function" href="#ensure_docker_user_consistency">ensure_docker_user_consistency</a>
            </li>
            <li>
                    <a class="function" href="#extract_content_from_smollm2_response">extract_content_from_smollm2_response</a>
            </li>
            <li>
                    <a class="function" href="#format_smollm2_system_prompt">format_smollm2_system_prompt</a>
            </li>
            <li>
                    <a class="function" href="#is_smollm2_model">is_smollm2_model</a>
            </li>
            <li>
                    <a class="function" href="#parse_smollm2_response">parse_smollm2_response</a>
            </li>
            <li>
                    <a class="function" href="#prepare_smollm2_messages">prepare_smollm2_messages</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../personal_agent.html">personal_agent</a><wbr>.core    </h1>

                        <div class="docstring"><p>Core package for Personal Agent.</p>
</div>

                        <input id="mod-core-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-core-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;Core package for Personal Agent.&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_agent_executor</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.agent_knowledge_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentKnowledgeManager</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.agent_memory_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentMemoryManager</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.agent_model_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentModelManager</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.agno_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_simple_personal_agent</span><span class="p">,</span> <span class="n">load_agent_knowledge</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.agno_storage</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>    <span class="n">create_agno_memory</span><span class="p">,</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>    <span class="n">create_agno_storage</span><span class="p">,</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>    <span class="n">create_combined_knowledge_base</span><span class="p">,</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>    <span class="n">load_combined_knowledge_base</span><span class="p">,</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>    <span class="n">load_lightrag_knowledge_base</span><span class="p">,</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="p">)</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.anti_duplicate_memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">AntiDuplicateMemory</span><span class="p">,</span> <span class="n">create_anti_duplicate_memory</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.docker_integration</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>    <span class="n">DockerIntegrationManager</span><span class="p">,</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>    <span class="n">check_docker_user_consistency</span><span class="p">,</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>    <span class="n">ensure_docker_user_consistency</span><span class="p">,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="p">)</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.knowledge_coordinator</span><span class="w"> </span><span class="kn">import</span> <span class="n">KnowledgeCoordinator</span><span class="p">,</span> <span class="n">create_knowledge_coordinator</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.lightrag_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">LightRAGManager</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.mcp_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleMCPClient</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.memory</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>    <span class="n">is_agno_storage_connected</span><span class="p">,</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>    <span class="n">is_memory_connected</span><span class="p">,</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>    <span class="n">is_weaviate_connected</span><span class="p">,</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>    <span class="n">reset_weaviate_if_corrupted</span><span class="p">,</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>    <span class="n">setup_weaviate</span><span class="p">,</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="p">)</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.multi_agent_system</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultiAgentSystem</span><span class="p">,</span> <span class="n">create_multi_agent_system</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.nlp_extractor</span><span class="w"> </span><span class="kn">import</span> <span class="n">extract_entities</span><span class="p">,</span> <span class="n">extract_relationships</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.semantic_memory_manager</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="n">SemanticDuplicateDetector</span><span class="p">,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="n">SemanticMemoryManager</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>    <span class="n">SemanticMemoryManagerConfig</span><span class="p">,</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>    <span class="n">create_semantic_memory_manager</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="p">)</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.smol_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_smolagents_executor</span><span class="p">,</span> <span class="n">create_smolagents_model</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.smollm2_parser</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>    <span class="n">extract_content_from_smollm2_response</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>    <span class="n">format_smollm2_system_prompt</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>    <span class="n">is_smollm2_model</span><span class="p">,</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>    <span class="n">parse_smollm2_response</span><span class="p">,</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>    <span class="n">prepare_smollm2_messages</span><span class="p">,</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.structured_response</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>    <span class="n">ResponseError</span><span class="p">,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>    <span class="n">ResponseMetadata</span><span class="p">,</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="n">StructuredResponse</span><span class="p">,</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>    <span class="n">StructuredResponseParser</span><span class="p">,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>    <span class="n">ToolCall</span><span class="p">,</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>    <span class="n">create_structured_instructions</span><span class="p">,</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>    <span class="n">get_ollama_format_schema</span><span class="p">,</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="p">)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.topic_classifier</span><span class="w"> </span><span class="kn">import</span> <span class="n">RuleSet</span><span class="p">,</span> <span class="n">TopicClassifier</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.user_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserManager</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.user_registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserRegistry</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>    <span class="c1"># MCP Client</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>    <span class="s2">&quot;SimpleMCPClient&quot;</span><span class="p">,</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>    <span class="c1"># Memory/Weaviate</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>    <span class="s2">&quot;setup_weaviate&quot;</span><span class="p">,</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>    <span class="s2">&quot;is_weaviate_connected&quot;</span><span class="p">,</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>    <span class="s2">&quot;reset_weaviate_if_corrupted&quot;</span><span class="p">,</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>    <span class="s2">&quot;is_agno_storage_connected&quot;</span><span class="p">,</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>    <span class="s2">&quot;is_memory_connected&quot;</span><span class="p">,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    <span class="c1"># Agent creation</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>    <span class="s2">&quot;create_agent_executor&quot;</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    <span class="s2">&quot;create_simple_personal_agent&quot;</span><span class="p">,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>    <span class="s2">&quot;load_agent_knowledge&quot;</span><span class="p">,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>    <span class="c1"># Agent managers</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>    <span class="s2">&quot;AgentKnowledgeManager&quot;</span><span class="p">,</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>    <span class="s2">&quot;AgentMemoryManager&quot;</span><span class="p">,</span> 
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>    <span class="s2">&quot;AgentModelManager&quot;</span><span class="p">,</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>    <span class="c1"># Multi-agent system</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>    <span class="s2">&quot;MultiAgentSystem&quot;</span><span class="p">,</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>    <span class="s2">&quot;create_multi_agent_system&quot;</span><span class="p">,</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>    <span class="c1"># Smolagents</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>    <span class="s2">&quot;create_smolagents_executor&quot;</span><span class="p">,</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>    <span class="s2">&quot;create_smolagents_model&quot;</span><span class="p">,</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>    <span class="c1"># Agno storage</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="s2">&quot;create_agno_storage&quot;</span><span class="p">,</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>    <span class="s2">&quot;create_agno_memory&quot;</span><span class="p">,</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>    <span class="s2">&quot;create_combined_knowledge_base&quot;</span><span class="p">,</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>    <span class="s2">&quot;load_combined_knowledge_base&quot;</span><span class="p">,</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>    <span class="s2">&quot;load_lightrag_knowledge_base&quot;</span><span class="p">,</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>    <span class="c1"># Anti-duplicate memory</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>    <span class="s2">&quot;AntiDuplicateMemory&quot;</span><span class="p">,</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>    <span class="s2">&quot;create_anti_duplicate_memory&quot;</span><span class="p">,</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>    <span class="c1"># Semantic memory manager</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>    <span class="s2">&quot;SemanticMemoryManager&quot;</span><span class="p">,</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>    <span class="s2">&quot;SemanticMemoryManagerConfig&quot;</span><span class="p">,</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>    <span class="s2">&quot;SemanticDuplicateDetector&quot;</span><span class="p">,</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>    <span class="s2">&quot;create_semantic_memory_manager&quot;</span><span class="p">,</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>    <span class="c1"># Knowledge coordinator</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>    <span class="s2">&quot;KnowledgeCoordinator&quot;</span><span class="p">,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>    <span class="s2">&quot;create_knowledge_coordinator&quot;</span><span class="p">,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>    <span class="c1"># NLP extractor</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>    <span class="s2">&quot;extract_entities&quot;</span><span class="p">,</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>    <span class="s2">&quot;extract_relationships&quot;</span><span class="p">,</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>    <span class="c1"># Structured response</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>    <span class="s2">&quot;StructuredResponse&quot;</span><span class="p">,</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>    <span class="s2">&quot;StructuredResponseParser&quot;</span><span class="p">,</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>    <span class="s2">&quot;ToolCall&quot;</span><span class="p">,</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>    <span class="s2">&quot;ResponseMetadata&quot;</span><span class="p">,</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>    <span class="s2">&quot;ResponseError&quot;</span><span class="p">,</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>    <span class="s2">&quot;get_ollama_format_schema&quot;</span><span class="p">,</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>    <span class="s2">&quot;create_structured_instructions&quot;</span><span class="p">,</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>    <span class="c1"># Topic classifier</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>    <span class="s2">&quot;TopicClassifier&quot;</span><span class="p">,</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>    <span class="s2">&quot;RuleSet&quot;</span><span class="p">,</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>    <span class="c1"># User management</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>    <span class="s2">&quot;UserManager&quot;</span><span class="p">,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>    <span class="s2">&quot;UserRegistry&quot;</span><span class="p">,</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>    <span class="c1"># LightRAG management</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>    <span class="s2">&quot;LightRAGManager&quot;</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>    <span class="c1"># Docker integration</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>    <span class="s2">&quot;DockerIntegrationManager&quot;</span><span class="p">,</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>    <span class="s2">&quot;check_docker_user_consistency&quot;</span><span class="p">,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>    <span class="s2">&quot;ensure_docker_user_consistency&quot;</span><span class="p">,</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>    <span class="c1"># SmolLM2 parsing utilities</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>    <span class="s2">&quot;extract_content_from_smollm2_response&quot;</span><span class="p">,</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>    <span class="s2">&quot;format_smollm2_system_prompt&quot;</span><span class="p">,</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>    <span class="s2">&quot;is_smollm2_model&quot;</span><span class="p">,</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>    <span class="s2">&quot;parse_smollm2_response&quot;</span><span class="p">,</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>    <span class="s2">&quot;prepare_smollm2_messages&quot;</span><span class="p">,</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="SimpleMCPClient">
                            <input id="SimpleMCPClient-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SimpleMCPClient</span>:

                <label class="view-source-button" for="SimpleMCPClient-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SimpleMCPClient"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SimpleMCPClient-16"><a href="#SimpleMCPClient-16"><span class="linenos"> 16</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SimpleMCPClient</span><span class="p">:</span>
</span><span id="SimpleMCPClient-17"><a href="#SimpleMCPClient-17"><span class="linenos"> 17</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple MCP client based on the working test_mcp.py implementation.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient-18"><a href="#SimpleMCPClient-18"><span class="linenos"> 18</span></a>
</span><span id="SimpleMCPClient-19"><a href="#SimpleMCPClient-19"><span class="linenos"> 19</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_configs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
</span><span id="SimpleMCPClient-20"><a href="#SimpleMCPClient-20"><span class="linenos"> 20</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">server_configs</span> <span class="o">=</span> <span class="n">server_configs</span>
</span><span id="SimpleMCPClient-21"><a href="#SimpleMCPClient-21"><span class="linenos"> 21</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SimpleMCPClient-22"><a href="#SimpleMCPClient-22"><span class="linenos"> 22</span></a>
</span><span id="SimpleMCPClient-23"><a href="#SimpleMCPClient-23"><span class="linenos"> 23</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start_server_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="SimpleMCPClient-24"><a href="#SimpleMCPClient-24"><span class="linenos"> 24</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start an MCP server process synchronously.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient-25"><a href="#SimpleMCPClient-25"><span class="linenos"> 25</span></a>        <span class="k">if</span> <span class="n">server_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_configs</span><span class="p">:</span>
</span><span id="SimpleMCPClient-26"><a href="#SimpleMCPClient-26"><span class="linenos"> 26</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unknown MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient-27"><a href="#SimpleMCPClient-27"><span class="linenos"> 27</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="SimpleMCPClient-28"><a href="#SimpleMCPClient-28"><span class="linenos"> 28</span></a>
</span><span id="SimpleMCPClient-29"><a href="#SimpleMCPClient-29"><span class="linenos"> 29</span></a>        <span class="k">if</span> <span class="n">server_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="p">:</span>
</span><span id="SimpleMCPClient-30"><a href="#SimpleMCPClient-30"><span class="linenos"> 30</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MCP server </span><span class="si">%s</span><span class="s2"> already running&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient-31"><a href="#SimpleMCPClient-31"><span class="linenos"> 31</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="SimpleMCPClient-32"><a href="#SimpleMCPClient-32"><span class="linenos"> 32</span></a>
</span><span id="SimpleMCPClient-33"><a href="#SimpleMCPClient-33"><span class="linenos"> 33</span></a>        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_configs</span><span class="p">[</span><span class="n">server_name</span><span class="p">]</span>
</span><span id="SimpleMCPClient-34"><a href="#SimpleMCPClient-34"><span class="linenos"> 34</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient-35"><a href="#SimpleMCPClient-35"><span class="linenos"> 35</span></a>            <span class="c1"># Start the MCP server process</span>
</span><span id="SimpleMCPClient-36"><a href="#SimpleMCPClient-36"><span class="linenos"> 36</span></a>            <span class="c1"># Set working directory based on the server root path</span>
</span><span id="SimpleMCPClient-37"><a href="#SimpleMCPClient-37"><span class="linenos"> 37</span></a>            <span class="n">cwd</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SimpleMCPClient-38"><a href="#SimpleMCPClient-38"><span class="linenos"> 38</span></a>            <span class="k">if</span> <span class="n">server_name</span> <span class="o">==</span> <span class="s2">&quot;filesystem-home&quot;</span><span class="p">:</span>
</span><span id="SimpleMCPClient-39"><a href="#SimpleMCPClient-39"><span class="linenos"> 39</span></a>                <span class="n">cwd</span> <span class="o">=</span> <span class="n">ROOT_DIR</span>
</span><span id="SimpleMCPClient-40"><a href="#SimpleMCPClient-40"><span class="linenos"> 40</span></a>            <span class="k">elif</span> <span class="n">server_name</span> <span class="o">==</span> <span class="s2">&quot;filesystem-data&quot;</span><span class="p">:</span>
</span><span id="SimpleMCPClient-41"><a href="#SimpleMCPClient-41"><span class="linenos"> 41</span></a>                <span class="n">cwd</span> <span class="o">=</span> <span class="n">DATA_DIR</span>
</span><span id="SimpleMCPClient-42"><a href="#SimpleMCPClient-42"><span class="linenos"> 42</span></a>
</span><span id="SimpleMCPClient-43"><a href="#SimpleMCPClient-43"><span class="linenos"> 43</span></a>            <span class="c1"># Prepare environment variables</span>
</span><span id="SimpleMCPClient-44"><a href="#SimpleMCPClient-44"><span class="linenos"> 44</span></a>            <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Start with current environment</span>
</span><span id="SimpleMCPClient-45"><a href="#SimpleMCPClient-45"><span class="linenos"> 45</span></a>            <span class="k">if</span> <span class="s2">&quot;env&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
</span><span id="SimpleMCPClient-46"><a href="#SimpleMCPClient-46"><span class="linenos"> 46</span></a>                <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">])</span>  <span class="c1"># Add server-specific env vars</span>
</span><span id="SimpleMCPClient-47"><a href="#SimpleMCPClient-47"><span class="linenos"> 47</span></a>
</span><span id="SimpleMCPClient-48"><a href="#SimpleMCPClient-48"><span class="linenos"> 48</span></a>            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
</span><span id="SimpleMCPClient-49"><a href="#SimpleMCPClient-49"><span class="linenos"> 49</span></a>                <span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">],</span>
</span><span id="SimpleMCPClient-50"><a href="#SimpleMCPClient-50"><span class="linenos"> 50</span></a>                <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="SimpleMCPClient-51"><a href="#SimpleMCPClient-51"><span class="linenos"> 51</span></a>                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="SimpleMCPClient-52"><a href="#SimpleMCPClient-52"><span class="linenos"> 52</span></a>                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="SimpleMCPClient-53"><a href="#SimpleMCPClient-53"><span class="linenos"> 53</span></a>                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SimpleMCPClient-54"><a href="#SimpleMCPClient-54"><span class="linenos"> 54</span></a>                <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="SimpleMCPClient-55"><a href="#SimpleMCPClient-55"><span class="linenos"> 55</span></a>                <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span>
</span><span id="SimpleMCPClient-56"><a href="#SimpleMCPClient-56"><span class="linenos"> 56</span></a>                <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>  <span class="c1"># Pass environment variables</span>
</span><span id="SimpleMCPClient-57"><a href="#SimpleMCPClient-57"><span class="linenos"> 57</span></a>            <span class="p">)</span>
</span><span id="SimpleMCPClient-58"><a href="#SimpleMCPClient-58"><span class="linenos"> 58</span></a>
</span><span id="SimpleMCPClient-59"><a href="#SimpleMCPClient-59"><span class="linenos"> 59</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="p">[</span><span class="n">server_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;process&quot;</span><span class="p">:</span> <span class="n">process</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">}</span>
</span><span id="SimpleMCPClient-60"><a href="#SimpleMCPClient-60"><span class="linenos"> 60</span></a>
</span><span id="SimpleMCPClient-61"><a href="#SimpleMCPClient-61"><span class="linenos"> 61</span></a>            <span class="c1"># Wait a moment for server to start</span>
</span><span id="SimpleMCPClient-62"><a href="#SimpleMCPClient-62"><span class="linenos"> 62</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="SimpleMCPClient-63"><a href="#SimpleMCPClient-63"><span class="linenos"> 63</span></a>
</span><span id="SimpleMCPClient-64"><a href="#SimpleMCPClient-64"><span class="linenos"> 64</span></a>            <span class="c1"># Initialize the server</span>
</span><span id="SimpleMCPClient-65"><a href="#SimpleMCPClient-65"><span class="linenos"> 65</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_server_sync</span><span class="p">(</span><span class="n">server_name</span><span class="p">):</span>
</span><span id="SimpleMCPClient-66"><a href="#SimpleMCPClient-66"><span class="linenos"> 66</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient-67"><a href="#SimpleMCPClient-67"><span class="linenos"> 67</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="SimpleMCPClient-68"><a href="#SimpleMCPClient-68"><span class="linenos"> 68</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SimpleMCPClient-69"><a href="#SimpleMCPClient-69"><span class="linenos"> 69</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to initialize MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient-70"><a href="#SimpleMCPClient-70"><span class="linenos"> 70</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="SimpleMCPClient-71"><a href="#SimpleMCPClient-71"><span class="linenos"> 71</span></a>
</span><span id="SimpleMCPClient-72"><a href="#SimpleMCPClient-72"><span class="linenos"> 72</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SimpleMCPClient-73"><a href="#SimpleMCPClient-73"><span class="linenos"> 73</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to start MCP server </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SimpleMCPClient-74"><a href="#SimpleMCPClient-74"><span class="linenos"> 74</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="SimpleMCPClient-75"><a href="#SimpleMCPClient-75"><span class="linenos"> 75</span></a>
</span><span id="SimpleMCPClient-76"><a href="#SimpleMCPClient-76"><span class="linenos"> 76</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_server_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="SimpleMCPClient-77"><a href="#SimpleMCPClient-77"><span class="linenos"> 77</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize server synchronously.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient-78"><a href="#SimpleMCPClient-78"><span class="linenos"> 78</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient-79"><a href="#SimpleMCPClient-79"><span class="linenos"> 79</span></a>            <span class="c1"># Send initialize request</span>
</span><span id="SimpleMCPClient-80"><a href="#SimpleMCPClient-80"><span class="linenos"> 80</span></a>            <span class="n">init_request</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SimpleMCPClient-81"><a href="#SimpleMCPClient-81"><span class="linenos"> 81</span></a>                <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
</span><span id="SimpleMCPClient-82"><a href="#SimpleMCPClient-82"><span class="linenos"> 82</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="SimpleMCPClient-83"><a href="#SimpleMCPClient-83"><span class="linenos"> 83</span></a>                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;initialize&quot;</span><span class="p">,</span>
</span><span id="SimpleMCPClient-84"><a href="#SimpleMCPClient-84"><span class="linenos"> 84</span></a>                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="SimpleMCPClient-85"><a href="#SimpleMCPClient-85"><span class="linenos"> 85</span></a>                    <span class="s2">&quot;protocolVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-11-05&quot;</span><span class="p">,</span>
</span><span id="SimpleMCPClient-86"><a href="#SimpleMCPClient-86"><span class="linenos"> 86</span></a>                    <span class="s2">&quot;capabilities&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="p">{}},</span>
</span><span id="SimpleMCPClient-87"><a href="#SimpleMCPClient-87"><span class="linenos"> 87</span></a>                    <span class="s2">&quot;clientInfo&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;personal-agent&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.1.0&quot;</span><span class="p">},</span>
</span><span id="SimpleMCPClient-88"><a href="#SimpleMCPClient-88"><span class="linenos"> 88</span></a>                <span class="p">},</span>
</span><span id="SimpleMCPClient-89"><a href="#SimpleMCPClient-89"><span class="linenos"> 89</span></a>            <span class="p">}</span>
</span><span id="SimpleMCPClient-90"><a href="#SimpleMCPClient-90"><span class="linenos"> 90</span></a>
</span><span id="SimpleMCPClient-91"><a href="#SimpleMCPClient-91"><span class="linenos"> 91</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_request_sync</span><span class="p">(</span><span class="n">server_name</span><span class="p">,</span> <span class="n">init_request</span><span class="p">)</span>
</span><span id="SimpleMCPClient-92"><a href="#SimpleMCPClient-92"><span class="linenos"> 92</span></a>            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">):</span>
</span><span id="SimpleMCPClient-93"><a href="#SimpleMCPClient-93"><span class="linenos"> 93</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialized MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient-94"><a href="#SimpleMCPClient-94"><span class="linenos"> 94</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="SimpleMCPClient-95"><a href="#SimpleMCPClient-95"><span class="linenos"> 95</span></a>
</span><span id="SimpleMCPClient-96"><a href="#SimpleMCPClient-96"><span class="linenos"> 96</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SimpleMCPClient-97"><a href="#SimpleMCPClient-97"><span class="linenos"> 97</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to initialize MCP server </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SimpleMCPClient-98"><a href="#SimpleMCPClient-98"><span class="linenos"> 98</span></a>
</span><span id="SimpleMCPClient-99"><a href="#SimpleMCPClient-99"><span class="linenos"> 99</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="SimpleMCPClient-100"><a href="#SimpleMCPClient-100"><span class="linenos">100</span></a>
</span><span id="SimpleMCPClient-101"><a href="#SimpleMCPClient-101"><span class="linenos">101</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_send_request_sync</span><span class="p">(</span>
</span><span id="SimpleMCPClient-102"><a href="#SimpleMCPClient-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="SimpleMCPClient-103"><a href="#SimpleMCPClient-103"><span class="linenos">103</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="SimpleMCPClient-104"><a href="#SimpleMCPClient-104"><span class="linenos">104</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a JSON-RPC request to an MCP server synchronously.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient-105"><a href="#SimpleMCPClient-105"><span class="linenos">105</span></a>        <span class="k">if</span> <span class="n">server_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="p">:</span>
</span><span id="SimpleMCPClient-106"><a href="#SimpleMCPClient-106"><span class="linenos">106</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="SimpleMCPClient-107"><a href="#SimpleMCPClient-107"><span class="linenos">107</span></a>
</span><span id="SimpleMCPClient-108"><a href="#SimpleMCPClient-108"><span class="linenos">108</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient-109"><a href="#SimpleMCPClient-109"><span class="linenos">109</span></a>            <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="p">[</span><span class="n">server_name</span><span class="p">][</span><span class="s2">&quot;process&quot;</span><span class="p">]</span>
</span><span id="SimpleMCPClient-110"><a href="#SimpleMCPClient-110"><span class="linenos">110</span></a>            <span class="n">request_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="SimpleMCPClient-111"><a href="#SimpleMCPClient-111"><span class="linenos">111</span></a>
</span><span id="SimpleMCPClient-112"><a href="#SimpleMCPClient-112"><span class="linenos">112</span></a>            <span class="c1"># Send request</span>
</span><span id="SimpleMCPClient-113"><a href="#SimpleMCPClient-113"><span class="linenos">113</span></a>            <span class="n">process</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">request_json</span><span class="p">)</span>
</span><span id="SimpleMCPClient-114"><a href="#SimpleMCPClient-114"><span class="linenos">114</span></a>            <span class="n">process</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="SimpleMCPClient-115"><a href="#SimpleMCPClient-115"><span class="linenos">115</span></a>
</span><span id="SimpleMCPClient-116"><a href="#SimpleMCPClient-116"><span class="linenos">116</span></a>            <span class="c1"># Read response</span>
</span><span id="SimpleMCPClient-117"><a href="#SimpleMCPClient-117"><span class="linenos">117</span></a>            <span class="n">response_line</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span><span id="SimpleMCPClient-118"><a href="#SimpleMCPClient-118"><span class="linenos">118</span></a>            <span class="k">if</span> <span class="n">response_line</span><span class="p">:</span>
</span><span id="SimpleMCPClient-119"><a href="#SimpleMCPClient-119"><span class="linenos">119</span></a>                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response_line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="SimpleMCPClient-120"><a href="#SimpleMCPClient-120"><span class="linenos">120</span></a>
</span><span id="SimpleMCPClient-121"><a href="#SimpleMCPClient-121"><span class="linenos">121</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SimpleMCPClient-122"><a href="#SimpleMCPClient-122"><span class="linenos">122</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error sending request to MCP server </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SimpleMCPClient-123"><a href="#SimpleMCPClient-123"><span class="linenos">123</span></a>
</span><span id="SimpleMCPClient-124"><a href="#SimpleMCPClient-124"><span class="linenos">124</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="SimpleMCPClient-125"><a href="#SimpleMCPClient-125"><span class="linenos">125</span></a>
</span><span id="SimpleMCPClient-126"><a href="#SimpleMCPClient-126"><span class="linenos">126</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_tool_sync</span><span class="p">(</span>
</span><span id="SimpleMCPClient-127"><a href="#SimpleMCPClient-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="SimpleMCPClient-128"><a href="#SimpleMCPClient-128"><span class="linenos">128</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SimpleMCPClient-129"><a href="#SimpleMCPClient-129"><span class="linenos">129</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Call a tool on an MCP server synchronously.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient-130"><a href="#SimpleMCPClient-130"><span class="linenos">130</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient-131"><a href="#SimpleMCPClient-131"><span class="linenos">131</span></a>            <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SimpleMCPClient-132"><a href="#SimpleMCPClient-132"><span class="linenos">132</span></a>                <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
</span><span id="SimpleMCPClient-133"><a href="#SimpleMCPClient-133"><span class="linenos">133</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="SimpleMCPClient-134"><a href="#SimpleMCPClient-134"><span class="linenos">134</span></a>                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;tools/call&quot;</span><span class="p">,</span>
</span><span id="SimpleMCPClient-135"><a href="#SimpleMCPClient-135"><span class="linenos">135</span></a>                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool_name</span><span class="p">,</span> <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">arguments</span><span class="p">},</span>
</span><span id="SimpleMCPClient-136"><a href="#SimpleMCPClient-136"><span class="linenos">136</span></a>            <span class="p">}</span>
</span><span id="SimpleMCPClient-137"><a href="#SimpleMCPClient-137"><span class="linenos">137</span></a>
</span><span id="SimpleMCPClient-138"><a href="#SimpleMCPClient-138"><span class="linenos">138</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_request_sync</span><span class="p">(</span><span class="n">server_name</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
</span><span id="SimpleMCPClient-139"><a href="#SimpleMCPClient-139"><span class="linenos">139</span></a>            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">):</span>
</span><span id="SimpleMCPClient-140"><a href="#SimpleMCPClient-140"><span class="linenos">140</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="SimpleMCPClient-141"><a href="#SimpleMCPClient-141"><span class="linenos">141</span></a>                <span class="k">if</span> <span class="n">content</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SimpleMCPClient-142"><a href="#SimpleMCPClient-142"><span class="linenos">142</span></a>                    <span class="k">return</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;No response&quot;</span><span class="p">)</span>
</span><span id="SimpleMCPClient-143"><a href="#SimpleMCPClient-143"><span class="linenos">143</span></a>
</span><span id="SimpleMCPClient-144"><a href="#SimpleMCPClient-144"><span class="linenos">144</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SimpleMCPClient-145"><a href="#SimpleMCPClient-145"><span class="linenos">145</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="SimpleMCPClient-146"><a href="#SimpleMCPClient-146"><span class="linenos">146</span></a>                <span class="s2">&quot;Error calling tool </span><span class="si">%s</span><span class="s2"> on server </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">e</span>
</span><span id="SimpleMCPClient-147"><a href="#SimpleMCPClient-147"><span class="linenos">147</span></a>            <span class="p">)</span>
</span><span id="SimpleMCPClient-148"><a href="#SimpleMCPClient-148"><span class="linenos">148</span></a>
</span><span id="SimpleMCPClient-149"><a href="#SimpleMCPClient-149"><span class="linenos">149</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error calling tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SimpleMCPClient-150"><a href="#SimpleMCPClient-150"><span class="linenos">150</span></a>
</span><span id="SimpleMCPClient-151"><a href="#SimpleMCPClient-151"><span class="linenos">151</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">list_tools_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="SimpleMCPClient-152"><a href="#SimpleMCPClient-152"><span class="linenos">152</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;List available tools on an MCP server synchronously.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient-153"><a href="#SimpleMCPClient-153"><span class="linenos">153</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient-154"><a href="#SimpleMCPClient-154"><span class="linenos">154</span></a>            <span class="n">request</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;tools/list&quot;</span><span class="p">}</span>
</span><span id="SimpleMCPClient-155"><a href="#SimpleMCPClient-155"><span class="linenos">155</span></a>
</span><span id="SimpleMCPClient-156"><a href="#SimpleMCPClient-156"><span class="linenos">156</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_request_sync</span><span class="p">(</span><span class="n">server_name</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
</span><span id="SimpleMCPClient-157"><a href="#SimpleMCPClient-157"><span class="linenos">157</span></a>            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">):</span>
</span><span id="SimpleMCPClient-158"><a href="#SimpleMCPClient-158"><span class="linenos">158</span></a>                <span class="n">tools</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="SimpleMCPClient-159"><a href="#SimpleMCPClient-159"><span class="linenos">159</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="SimpleMCPClient-160"><a href="#SimpleMCPClient-160"><span class="linenos">160</span></a>                    <span class="s2">&quot;Available tools on </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="SimpleMCPClient-161"><a href="#SimpleMCPClient-161"><span class="linenos">161</span></a>                    <span class="n">server_name</span><span class="p">,</span>
</span><span id="SimpleMCPClient-162"><a href="#SimpleMCPClient-162"><span class="linenos">162</span></a>                    <span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">],</span>
</span><span id="SimpleMCPClient-163"><a href="#SimpleMCPClient-163"><span class="linenos">163</span></a>                <span class="p">)</span>
</span><span id="SimpleMCPClient-164"><a href="#SimpleMCPClient-164"><span class="linenos">164</span></a>                <span class="k">return</span> <span class="n">tools</span>
</span><span id="SimpleMCPClient-165"><a href="#SimpleMCPClient-165"><span class="linenos">165</span></a>
</span><span id="SimpleMCPClient-166"><a href="#SimpleMCPClient-166"><span class="linenos">166</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SimpleMCPClient-167"><a href="#SimpleMCPClient-167"><span class="linenos">167</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error listing tools on server </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SimpleMCPClient-168"><a href="#SimpleMCPClient-168"><span class="linenos">168</span></a>
</span><span id="SimpleMCPClient-169"><a href="#SimpleMCPClient-169"><span class="linenos">169</span></a>        <span class="k">return</span> <span class="p">[]</span>
</span><span id="SimpleMCPClient-170"><a href="#SimpleMCPClient-170"><span class="linenos">170</span></a>
</span><span id="SimpleMCPClient-171"><a href="#SimpleMCPClient-171"><span class="linenos">171</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop_server_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="SimpleMCPClient-172"><a href="#SimpleMCPClient-172"><span class="linenos">172</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop a specific MCP server.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient-173"><a href="#SimpleMCPClient-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="n">server_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="p">:</span>
</span><span id="SimpleMCPClient-174"><a href="#SimpleMCPClient-174"><span class="linenos">174</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MCP server </span><span class="si">%s</span><span class="s2"> not running&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient-175"><a href="#SimpleMCPClient-175"><span class="linenos">175</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="SimpleMCPClient-176"><a href="#SimpleMCPClient-176"><span class="linenos">176</span></a>
</span><span id="SimpleMCPClient-177"><a href="#SimpleMCPClient-177"><span class="linenos">177</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient-178"><a href="#SimpleMCPClient-178"><span class="linenos">178</span></a>            <span class="n">server_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="p">[</span><span class="n">server_name</span><span class="p">]</span>
</span><span id="SimpleMCPClient-179"><a href="#SimpleMCPClient-179"><span class="linenos">179</span></a>            <span class="n">process</span> <span class="o">=</span> <span class="n">server_info</span><span class="p">[</span><span class="s2">&quot;process&quot;</span><span class="p">]</span>
</span><span id="SimpleMCPClient-180"><a href="#SimpleMCPClient-180"><span class="linenos">180</span></a>
</span><span id="SimpleMCPClient-181"><a href="#SimpleMCPClient-181"><span class="linenos">181</span></a>            <span class="c1"># Terminate the process</span>
</span><span id="SimpleMCPClient-182"><a href="#SimpleMCPClient-182"><span class="linenos">182</span></a>            <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="SimpleMCPClient-183"><a href="#SimpleMCPClient-183"><span class="linenos">183</span></a>
</span><span id="SimpleMCPClient-184"><a href="#SimpleMCPClient-184"><span class="linenos">184</span></a>            <span class="c1"># Wait for it to exit gracefully</span>
</span><span id="SimpleMCPClient-185"><a href="#SimpleMCPClient-185"><span class="linenos">185</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient-186"><a href="#SimpleMCPClient-186"><span class="linenos">186</span></a>                <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="SimpleMCPClient-187"><a href="#SimpleMCPClient-187"><span class="linenos">187</span></a>            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
</span><span id="SimpleMCPClient-188"><a href="#SimpleMCPClient-188"><span class="linenos">188</span></a>                <span class="c1"># Force kill if it doesn&#39;t exit gracefully</span>
</span><span id="SimpleMCPClient-189"><a href="#SimpleMCPClient-189"><span class="linenos">189</span></a>                <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span><span id="SimpleMCPClient-190"><a href="#SimpleMCPClient-190"><span class="linenos">190</span></a>                <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span><span id="SimpleMCPClient-191"><a href="#SimpleMCPClient-191"><span class="linenos">191</span></a>
</span><span id="SimpleMCPClient-192"><a href="#SimpleMCPClient-192"><span class="linenos">192</span></a>            <span class="c1"># Remove from active servers</span>
</span><span id="SimpleMCPClient-193"><a href="#SimpleMCPClient-193"><span class="linenos">193</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="p">[</span><span class="n">server_name</span><span class="p">]</span>
</span><span id="SimpleMCPClient-194"><a href="#SimpleMCPClient-194"><span class="linenos">194</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopped MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient-195"><a href="#SimpleMCPClient-195"><span class="linenos">195</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="SimpleMCPClient-196"><a href="#SimpleMCPClient-196"><span class="linenos">196</span></a>
</span><span id="SimpleMCPClient-197"><a href="#SimpleMCPClient-197"><span class="linenos">197</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SimpleMCPClient-198"><a href="#SimpleMCPClient-198"><span class="linenos">198</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error stopping MCP server </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SimpleMCPClient-199"><a href="#SimpleMCPClient-199"><span class="linenos">199</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="SimpleMCPClient-200"><a href="#SimpleMCPClient-200"><span class="linenos">200</span></a>
</span><span id="SimpleMCPClient-201"><a href="#SimpleMCPClient-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start_servers</span><span class="p">(</span>
</span><span id="SimpleMCPClient-202"><a href="#SimpleMCPClient-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">server_configs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SimpleMCPClient-203"><a href="#SimpleMCPClient-203"><span class="linenos">203</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="SimpleMCPClient-204"><a href="#SimpleMCPClient-204"><span class="linenos">204</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start all configured MCP servers.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient-205"><a href="#SimpleMCPClient-205"><span class="linenos">205</span></a>        <span class="n">configs</span> <span class="o">=</span> <span class="n">server_configs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_configs</span>
</span><span id="SimpleMCPClient-206"><a href="#SimpleMCPClient-206"><span class="linenos">206</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SimpleMCPClient-207"><a href="#SimpleMCPClient-207"><span class="linenos">207</span></a>
</span><span id="SimpleMCPClient-208"><a href="#SimpleMCPClient-208"><span class="linenos">208</span></a>        <span class="k">for</span> <span class="n">server_name</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
</span><span id="SimpleMCPClient-209"><a href="#SimpleMCPClient-209"><span class="linenos">209</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_server_sync</span><span class="p">(</span><span class="n">server_name</span><span class="p">):</span>
</span><span id="SimpleMCPClient-210"><a href="#SimpleMCPClient-210"><span class="linenos">210</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to start MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient-211"><a href="#SimpleMCPClient-211"><span class="linenos">211</span></a>                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SimpleMCPClient-212"><a href="#SimpleMCPClient-212"><span class="linenos">212</span></a>
</span><span id="SimpleMCPClient-213"><a href="#SimpleMCPClient-213"><span class="linenos">213</span></a>        <span class="k">return</span> <span class="n">success</span>
</span><span id="SimpleMCPClient-214"><a href="#SimpleMCPClient-214"><span class="linenos">214</span></a>
</span><span id="SimpleMCPClient-215"><a href="#SimpleMCPClient-215"><span class="linenos">215</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop_all_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SimpleMCPClient-216"><a href="#SimpleMCPClient-216"><span class="linenos">216</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop all active MCP servers.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient-217"><a href="#SimpleMCPClient-217"><span class="linenos">217</span></a>        <span class="k">for</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">server_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="SimpleMCPClient-218"><a href="#SimpleMCPClient-218"><span class="linenos">218</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient-219"><a href="#SimpleMCPClient-219"><span class="linenos">219</span></a>                <span class="n">process</span> <span class="o">=</span> <span class="n">server_info</span><span class="p">[</span><span class="s2">&quot;process&quot;</span><span class="p">]</span>
</span><span id="SimpleMCPClient-220"><a href="#SimpleMCPClient-220"><span class="linenos">220</span></a>                <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="SimpleMCPClient-221"><a href="#SimpleMCPClient-221"><span class="linenos">221</span></a>                <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Wait up to 5 seconds</span>
</span><span id="SimpleMCPClient-222"><a href="#SimpleMCPClient-222"><span class="linenos">222</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopped MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient-223"><a href="#SimpleMCPClient-223"><span class="linenos">223</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SimpleMCPClient-224"><a href="#SimpleMCPClient-224"><span class="linenos">224</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error stopping MCP server </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SimpleMCPClient-225"><a href="#SimpleMCPClient-225"><span class="linenos">225</span></a>
</span><span id="SimpleMCPClient-226"><a href="#SimpleMCPClient-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Simple MCP client based on the working test_mcp.py implementation.</p>
</div>


                            <div id="SimpleMCPClient.__init__" class="classattr">
                                        <input id="SimpleMCPClient.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SimpleMCPClient</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">server_configs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></span>)</span>

                <label class="view-source-button" for="SimpleMCPClient.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SimpleMCPClient.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SimpleMCPClient.__init__-19"><a href="#SimpleMCPClient.__init__-19"><span class="linenos">19</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_configs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
</span><span id="SimpleMCPClient.__init__-20"><a href="#SimpleMCPClient.__init__-20"><span class="linenos">20</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">server_configs</span> <span class="o">=</span> <span class="n">server_configs</span>
</span><span id="SimpleMCPClient.__init__-21"><a href="#SimpleMCPClient.__init__-21"><span class="linenos">21</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span> <span class="o">=</span> <span class="p">{}</span>
</span></pre></div>


    

                            </div>
                            <div id="SimpleMCPClient.server_configs" class="classattr">
                                <div class="attr variable">
            <span class="name">server_configs</span>

        
    </div>
    <a class="headerlink" href="#SimpleMCPClient.server_configs"></a>
    
    

                            </div>
                            <div id="SimpleMCPClient.active_servers" class="classattr">
                                <div class="attr variable">
            <span class="name">active_servers</span>

        
    </div>
    <a class="headerlink" href="#SimpleMCPClient.active_servers"></a>
    
    

                            </div>
                            <div id="SimpleMCPClient.start_server_sync" class="classattr">
                                        <input id="SimpleMCPClient.start_server_sync-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">start_server_sync</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="SimpleMCPClient.start_server_sync-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SimpleMCPClient.start_server_sync"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SimpleMCPClient.start_server_sync-23"><a href="#SimpleMCPClient.start_server_sync-23"><span class="linenos">23</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start_server_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="SimpleMCPClient.start_server_sync-24"><a href="#SimpleMCPClient.start_server_sync-24"><span class="linenos">24</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start an MCP server process synchronously.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient.start_server_sync-25"><a href="#SimpleMCPClient.start_server_sync-25"><span class="linenos">25</span></a>        <span class="k">if</span> <span class="n">server_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_configs</span><span class="p">:</span>
</span><span id="SimpleMCPClient.start_server_sync-26"><a href="#SimpleMCPClient.start_server_sync-26"><span class="linenos">26</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unknown MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient.start_server_sync-27"><a href="#SimpleMCPClient.start_server_sync-27"><span class="linenos">27</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="SimpleMCPClient.start_server_sync-28"><a href="#SimpleMCPClient.start_server_sync-28"><span class="linenos">28</span></a>
</span><span id="SimpleMCPClient.start_server_sync-29"><a href="#SimpleMCPClient.start_server_sync-29"><span class="linenos">29</span></a>        <span class="k">if</span> <span class="n">server_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="p">:</span>
</span><span id="SimpleMCPClient.start_server_sync-30"><a href="#SimpleMCPClient.start_server_sync-30"><span class="linenos">30</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MCP server </span><span class="si">%s</span><span class="s2"> already running&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient.start_server_sync-31"><a href="#SimpleMCPClient.start_server_sync-31"><span class="linenos">31</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="SimpleMCPClient.start_server_sync-32"><a href="#SimpleMCPClient.start_server_sync-32"><span class="linenos">32</span></a>
</span><span id="SimpleMCPClient.start_server_sync-33"><a href="#SimpleMCPClient.start_server_sync-33"><span class="linenos">33</span></a>        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_configs</span><span class="p">[</span><span class="n">server_name</span><span class="p">]</span>
</span><span id="SimpleMCPClient.start_server_sync-34"><a href="#SimpleMCPClient.start_server_sync-34"><span class="linenos">34</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient.start_server_sync-35"><a href="#SimpleMCPClient.start_server_sync-35"><span class="linenos">35</span></a>            <span class="c1"># Start the MCP server process</span>
</span><span id="SimpleMCPClient.start_server_sync-36"><a href="#SimpleMCPClient.start_server_sync-36"><span class="linenos">36</span></a>            <span class="c1"># Set working directory based on the server root path</span>
</span><span id="SimpleMCPClient.start_server_sync-37"><a href="#SimpleMCPClient.start_server_sync-37"><span class="linenos">37</span></a>            <span class="n">cwd</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SimpleMCPClient.start_server_sync-38"><a href="#SimpleMCPClient.start_server_sync-38"><span class="linenos">38</span></a>            <span class="k">if</span> <span class="n">server_name</span> <span class="o">==</span> <span class="s2">&quot;filesystem-home&quot;</span><span class="p">:</span>
</span><span id="SimpleMCPClient.start_server_sync-39"><a href="#SimpleMCPClient.start_server_sync-39"><span class="linenos">39</span></a>                <span class="n">cwd</span> <span class="o">=</span> <span class="n">ROOT_DIR</span>
</span><span id="SimpleMCPClient.start_server_sync-40"><a href="#SimpleMCPClient.start_server_sync-40"><span class="linenos">40</span></a>            <span class="k">elif</span> <span class="n">server_name</span> <span class="o">==</span> <span class="s2">&quot;filesystem-data&quot;</span><span class="p">:</span>
</span><span id="SimpleMCPClient.start_server_sync-41"><a href="#SimpleMCPClient.start_server_sync-41"><span class="linenos">41</span></a>                <span class="n">cwd</span> <span class="o">=</span> <span class="n">DATA_DIR</span>
</span><span id="SimpleMCPClient.start_server_sync-42"><a href="#SimpleMCPClient.start_server_sync-42"><span class="linenos">42</span></a>
</span><span id="SimpleMCPClient.start_server_sync-43"><a href="#SimpleMCPClient.start_server_sync-43"><span class="linenos">43</span></a>            <span class="c1"># Prepare environment variables</span>
</span><span id="SimpleMCPClient.start_server_sync-44"><a href="#SimpleMCPClient.start_server_sync-44"><span class="linenos">44</span></a>            <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Start with current environment</span>
</span><span id="SimpleMCPClient.start_server_sync-45"><a href="#SimpleMCPClient.start_server_sync-45"><span class="linenos">45</span></a>            <span class="k">if</span> <span class="s2">&quot;env&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
</span><span id="SimpleMCPClient.start_server_sync-46"><a href="#SimpleMCPClient.start_server_sync-46"><span class="linenos">46</span></a>                <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">])</span>  <span class="c1"># Add server-specific env vars</span>
</span><span id="SimpleMCPClient.start_server_sync-47"><a href="#SimpleMCPClient.start_server_sync-47"><span class="linenos">47</span></a>
</span><span id="SimpleMCPClient.start_server_sync-48"><a href="#SimpleMCPClient.start_server_sync-48"><span class="linenos">48</span></a>            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
</span><span id="SimpleMCPClient.start_server_sync-49"><a href="#SimpleMCPClient.start_server_sync-49"><span class="linenos">49</span></a>                <span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">],</span>
</span><span id="SimpleMCPClient.start_server_sync-50"><a href="#SimpleMCPClient.start_server_sync-50"><span class="linenos">50</span></a>                <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="SimpleMCPClient.start_server_sync-51"><a href="#SimpleMCPClient.start_server_sync-51"><span class="linenos">51</span></a>                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="SimpleMCPClient.start_server_sync-52"><a href="#SimpleMCPClient.start_server_sync-52"><span class="linenos">52</span></a>                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="SimpleMCPClient.start_server_sync-53"><a href="#SimpleMCPClient.start_server_sync-53"><span class="linenos">53</span></a>                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SimpleMCPClient.start_server_sync-54"><a href="#SimpleMCPClient.start_server_sync-54"><span class="linenos">54</span></a>                <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="SimpleMCPClient.start_server_sync-55"><a href="#SimpleMCPClient.start_server_sync-55"><span class="linenos">55</span></a>                <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span>
</span><span id="SimpleMCPClient.start_server_sync-56"><a href="#SimpleMCPClient.start_server_sync-56"><span class="linenos">56</span></a>                <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>  <span class="c1"># Pass environment variables</span>
</span><span id="SimpleMCPClient.start_server_sync-57"><a href="#SimpleMCPClient.start_server_sync-57"><span class="linenos">57</span></a>            <span class="p">)</span>
</span><span id="SimpleMCPClient.start_server_sync-58"><a href="#SimpleMCPClient.start_server_sync-58"><span class="linenos">58</span></a>
</span><span id="SimpleMCPClient.start_server_sync-59"><a href="#SimpleMCPClient.start_server_sync-59"><span class="linenos">59</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="p">[</span><span class="n">server_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;process&quot;</span><span class="p">:</span> <span class="n">process</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">}</span>
</span><span id="SimpleMCPClient.start_server_sync-60"><a href="#SimpleMCPClient.start_server_sync-60"><span class="linenos">60</span></a>
</span><span id="SimpleMCPClient.start_server_sync-61"><a href="#SimpleMCPClient.start_server_sync-61"><span class="linenos">61</span></a>            <span class="c1"># Wait a moment for server to start</span>
</span><span id="SimpleMCPClient.start_server_sync-62"><a href="#SimpleMCPClient.start_server_sync-62"><span class="linenos">62</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="SimpleMCPClient.start_server_sync-63"><a href="#SimpleMCPClient.start_server_sync-63"><span class="linenos">63</span></a>
</span><span id="SimpleMCPClient.start_server_sync-64"><a href="#SimpleMCPClient.start_server_sync-64"><span class="linenos">64</span></a>            <span class="c1"># Initialize the server</span>
</span><span id="SimpleMCPClient.start_server_sync-65"><a href="#SimpleMCPClient.start_server_sync-65"><span class="linenos">65</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_server_sync</span><span class="p">(</span><span class="n">server_name</span><span class="p">):</span>
</span><span id="SimpleMCPClient.start_server_sync-66"><a href="#SimpleMCPClient.start_server_sync-66"><span class="linenos">66</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient.start_server_sync-67"><a href="#SimpleMCPClient.start_server_sync-67"><span class="linenos">67</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="SimpleMCPClient.start_server_sync-68"><a href="#SimpleMCPClient.start_server_sync-68"><span class="linenos">68</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SimpleMCPClient.start_server_sync-69"><a href="#SimpleMCPClient.start_server_sync-69"><span class="linenos">69</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to initialize MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient.start_server_sync-70"><a href="#SimpleMCPClient.start_server_sync-70"><span class="linenos">70</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="SimpleMCPClient.start_server_sync-71"><a href="#SimpleMCPClient.start_server_sync-71"><span class="linenos">71</span></a>
</span><span id="SimpleMCPClient.start_server_sync-72"><a href="#SimpleMCPClient.start_server_sync-72"><span class="linenos">72</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SimpleMCPClient.start_server_sync-73"><a href="#SimpleMCPClient.start_server_sync-73"><span class="linenos">73</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to start MCP server </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SimpleMCPClient.start_server_sync-74"><a href="#SimpleMCPClient.start_server_sync-74"><span class="linenos">74</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Start an MCP server process synchronously.</p>
</div>


                            </div>
                            <div id="SimpleMCPClient.call_tool_sync" class="classattr">
                                        <input id="SimpleMCPClient.call_tool_sync-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">call_tool_sync</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SimpleMCPClient.call_tool_sync-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SimpleMCPClient.call_tool_sync"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SimpleMCPClient.call_tool_sync-126"><a href="#SimpleMCPClient.call_tool_sync-126"><span class="linenos">126</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_tool_sync</span><span class="p">(</span>
</span><span id="SimpleMCPClient.call_tool_sync-127"><a href="#SimpleMCPClient.call_tool_sync-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="SimpleMCPClient.call_tool_sync-128"><a href="#SimpleMCPClient.call_tool_sync-128"><span class="linenos">128</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SimpleMCPClient.call_tool_sync-129"><a href="#SimpleMCPClient.call_tool_sync-129"><span class="linenos">129</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Call a tool on an MCP server synchronously.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient.call_tool_sync-130"><a href="#SimpleMCPClient.call_tool_sync-130"><span class="linenos">130</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient.call_tool_sync-131"><a href="#SimpleMCPClient.call_tool_sync-131"><span class="linenos">131</span></a>            <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SimpleMCPClient.call_tool_sync-132"><a href="#SimpleMCPClient.call_tool_sync-132"><span class="linenos">132</span></a>                <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
</span><span id="SimpleMCPClient.call_tool_sync-133"><a href="#SimpleMCPClient.call_tool_sync-133"><span class="linenos">133</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="SimpleMCPClient.call_tool_sync-134"><a href="#SimpleMCPClient.call_tool_sync-134"><span class="linenos">134</span></a>                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;tools/call&quot;</span><span class="p">,</span>
</span><span id="SimpleMCPClient.call_tool_sync-135"><a href="#SimpleMCPClient.call_tool_sync-135"><span class="linenos">135</span></a>                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool_name</span><span class="p">,</span> <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">arguments</span><span class="p">},</span>
</span><span id="SimpleMCPClient.call_tool_sync-136"><a href="#SimpleMCPClient.call_tool_sync-136"><span class="linenos">136</span></a>            <span class="p">}</span>
</span><span id="SimpleMCPClient.call_tool_sync-137"><a href="#SimpleMCPClient.call_tool_sync-137"><span class="linenos">137</span></a>
</span><span id="SimpleMCPClient.call_tool_sync-138"><a href="#SimpleMCPClient.call_tool_sync-138"><span class="linenos">138</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_request_sync</span><span class="p">(</span><span class="n">server_name</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
</span><span id="SimpleMCPClient.call_tool_sync-139"><a href="#SimpleMCPClient.call_tool_sync-139"><span class="linenos">139</span></a>            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">):</span>
</span><span id="SimpleMCPClient.call_tool_sync-140"><a href="#SimpleMCPClient.call_tool_sync-140"><span class="linenos">140</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="SimpleMCPClient.call_tool_sync-141"><a href="#SimpleMCPClient.call_tool_sync-141"><span class="linenos">141</span></a>                <span class="k">if</span> <span class="n">content</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SimpleMCPClient.call_tool_sync-142"><a href="#SimpleMCPClient.call_tool_sync-142"><span class="linenos">142</span></a>                    <span class="k">return</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;No response&quot;</span><span class="p">)</span>
</span><span id="SimpleMCPClient.call_tool_sync-143"><a href="#SimpleMCPClient.call_tool_sync-143"><span class="linenos">143</span></a>
</span><span id="SimpleMCPClient.call_tool_sync-144"><a href="#SimpleMCPClient.call_tool_sync-144"><span class="linenos">144</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SimpleMCPClient.call_tool_sync-145"><a href="#SimpleMCPClient.call_tool_sync-145"><span class="linenos">145</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="SimpleMCPClient.call_tool_sync-146"><a href="#SimpleMCPClient.call_tool_sync-146"><span class="linenos">146</span></a>                <span class="s2">&quot;Error calling tool </span><span class="si">%s</span><span class="s2"> on server </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">e</span>
</span><span id="SimpleMCPClient.call_tool_sync-147"><a href="#SimpleMCPClient.call_tool_sync-147"><span class="linenos">147</span></a>            <span class="p">)</span>
</span><span id="SimpleMCPClient.call_tool_sync-148"><a href="#SimpleMCPClient.call_tool_sync-148"><span class="linenos">148</span></a>
</span><span id="SimpleMCPClient.call_tool_sync-149"><a href="#SimpleMCPClient.call_tool_sync-149"><span class="linenos">149</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error calling tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Call a tool on an MCP server synchronously.</p>
</div>


                            </div>
                            <div id="SimpleMCPClient.list_tools_sync" class="classattr">
                                        <input id="SimpleMCPClient.list_tools_sync-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">list_tools_sync</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="SimpleMCPClient.list_tools_sync-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SimpleMCPClient.list_tools_sync"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SimpleMCPClient.list_tools_sync-151"><a href="#SimpleMCPClient.list_tools_sync-151"><span class="linenos">151</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">list_tools_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="SimpleMCPClient.list_tools_sync-152"><a href="#SimpleMCPClient.list_tools_sync-152"><span class="linenos">152</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;List available tools on an MCP server synchronously.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient.list_tools_sync-153"><a href="#SimpleMCPClient.list_tools_sync-153"><span class="linenos">153</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient.list_tools_sync-154"><a href="#SimpleMCPClient.list_tools_sync-154"><span class="linenos">154</span></a>            <span class="n">request</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;tools/list&quot;</span><span class="p">}</span>
</span><span id="SimpleMCPClient.list_tools_sync-155"><a href="#SimpleMCPClient.list_tools_sync-155"><span class="linenos">155</span></a>
</span><span id="SimpleMCPClient.list_tools_sync-156"><a href="#SimpleMCPClient.list_tools_sync-156"><span class="linenos">156</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_request_sync</span><span class="p">(</span><span class="n">server_name</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
</span><span id="SimpleMCPClient.list_tools_sync-157"><a href="#SimpleMCPClient.list_tools_sync-157"><span class="linenos">157</span></a>            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">):</span>
</span><span id="SimpleMCPClient.list_tools_sync-158"><a href="#SimpleMCPClient.list_tools_sync-158"><span class="linenos">158</span></a>                <span class="n">tools</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="SimpleMCPClient.list_tools_sync-159"><a href="#SimpleMCPClient.list_tools_sync-159"><span class="linenos">159</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="SimpleMCPClient.list_tools_sync-160"><a href="#SimpleMCPClient.list_tools_sync-160"><span class="linenos">160</span></a>                    <span class="s2">&quot;Available tools on </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="SimpleMCPClient.list_tools_sync-161"><a href="#SimpleMCPClient.list_tools_sync-161"><span class="linenos">161</span></a>                    <span class="n">server_name</span><span class="p">,</span>
</span><span id="SimpleMCPClient.list_tools_sync-162"><a href="#SimpleMCPClient.list_tools_sync-162"><span class="linenos">162</span></a>                    <span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">],</span>
</span><span id="SimpleMCPClient.list_tools_sync-163"><a href="#SimpleMCPClient.list_tools_sync-163"><span class="linenos">163</span></a>                <span class="p">)</span>
</span><span id="SimpleMCPClient.list_tools_sync-164"><a href="#SimpleMCPClient.list_tools_sync-164"><span class="linenos">164</span></a>                <span class="k">return</span> <span class="n">tools</span>
</span><span id="SimpleMCPClient.list_tools_sync-165"><a href="#SimpleMCPClient.list_tools_sync-165"><span class="linenos">165</span></a>
</span><span id="SimpleMCPClient.list_tools_sync-166"><a href="#SimpleMCPClient.list_tools_sync-166"><span class="linenos">166</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SimpleMCPClient.list_tools_sync-167"><a href="#SimpleMCPClient.list_tools_sync-167"><span class="linenos">167</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error listing tools on server </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SimpleMCPClient.list_tools_sync-168"><a href="#SimpleMCPClient.list_tools_sync-168"><span class="linenos">168</span></a>
</span><span id="SimpleMCPClient.list_tools_sync-169"><a href="#SimpleMCPClient.list_tools_sync-169"><span class="linenos">169</span></a>        <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>List available tools on an MCP server synchronously.</p>
</div>


                            </div>
                            <div id="SimpleMCPClient.stop_server_sync" class="classattr">
                                        <input id="SimpleMCPClient.stop_server_sync-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stop_server_sync</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="SimpleMCPClient.stop_server_sync-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SimpleMCPClient.stop_server_sync"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SimpleMCPClient.stop_server_sync-171"><a href="#SimpleMCPClient.stop_server_sync-171"><span class="linenos">171</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop_server_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="SimpleMCPClient.stop_server_sync-172"><a href="#SimpleMCPClient.stop_server_sync-172"><span class="linenos">172</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop a specific MCP server.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient.stop_server_sync-173"><a href="#SimpleMCPClient.stop_server_sync-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="n">server_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="p">:</span>
</span><span id="SimpleMCPClient.stop_server_sync-174"><a href="#SimpleMCPClient.stop_server_sync-174"><span class="linenos">174</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MCP server </span><span class="si">%s</span><span class="s2"> not running&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient.stop_server_sync-175"><a href="#SimpleMCPClient.stop_server_sync-175"><span class="linenos">175</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="SimpleMCPClient.stop_server_sync-176"><a href="#SimpleMCPClient.stop_server_sync-176"><span class="linenos">176</span></a>
</span><span id="SimpleMCPClient.stop_server_sync-177"><a href="#SimpleMCPClient.stop_server_sync-177"><span class="linenos">177</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient.stop_server_sync-178"><a href="#SimpleMCPClient.stop_server_sync-178"><span class="linenos">178</span></a>            <span class="n">server_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="p">[</span><span class="n">server_name</span><span class="p">]</span>
</span><span id="SimpleMCPClient.stop_server_sync-179"><a href="#SimpleMCPClient.stop_server_sync-179"><span class="linenos">179</span></a>            <span class="n">process</span> <span class="o">=</span> <span class="n">server_info</span><span class="p">[</span><span class="s2">&quot;process&quot;</span><span class="p">]</span>
</span><span id="SimpleMCPClient.stop_server_sync-180"><a href="#SimpleMCPClient.stop_server_sync-180"><span class="linenos">180</span></a>
</span><span id="SimpleMCPClient.stop_server_sync-181"><a href="#SimpleMCPClient.stop_server_sync-181"><span class="linenos">181</span></a>            <span class="c1"># Terminate the process</span>
</span><span id="SimpleMCPClient.stop_server_sync-182"><a href="#SimpleMCPClient.stop_server_sync-182"><span class="linenos">182</span></a>            <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="SimpleMCPClient.stop_server_sync-183"><a href="#SimpleMCPClient.stop_server_sync-183"><span class="linenos">183</span></a>
</span><span id="SimpleMCPClient.stop_server_sync-184"><a href="#SimpleMCPClient.stop_server_sync-184"><span class="linenos">184</span></a>            <span class="c1"># Wait for it to exit gracefully</span>
</span><span id="SimpleMCPClient.stop_server_sync-185"><a href="#SimpleMCPClient.stop_server_sync-185"><span class="linenos">185</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient.stop_server_sync-186"><a href="#SimpleMCPClient.stop_server_sync-186"><span class="linenos">186</span></a>                <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="SimpleMCPClient.stop_server_sync-187"><a href="#SimpleMCPClient.stop_server_sync-187"><span class="linenos">187</span></a>            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
</span><span id="SimpleMCPClient.stop_server_sync-188"><a href="#SimpleMCPClient.stop_server_sync-188"><span class="linenos">188</span></a>                <span class="c1"># Force kill if it doesn&#39;t exit gracefully</span>
</span><span id="SimpleMCPClient.stop_server_sync-189"><a href="#SimpleMCPClient.stop_server_sync-189"><span class="linenos">189</span></a>                <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span><span id="SimpleMCPClient.stop_server_sync-190"><a href="#SimpleMCPClient.stop_server_sync-190"><span class="linenos">190</span></a>                <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span><span id="SimpleMCPClient.stop_server_sync-191"><a href="#SimpleMCPClient.stop_server_sync-191"><span class="linenos">191</span></a>
</span><span id="SimpleMCPClient.stop_server_sync-192"><a href="#SimpleMCPClient.stop_server_sync-192"><span class="linenos">192</span></a>            <span class="c1"># Remove from active servers</span>
</span><span id="SimpleMCPClient.stop_server_sync-193"><a href="#SimpleMCPClient.stop_server_sync-193"><span class="linenos">193</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="p">[</span><span class="n">server_name</span><span class="p">]</span>
</span><span id="SimpleMCPClient.stop_server_sync-194"><a href="#SimpleMCPClient.stop_server_sync-194"><span class="linenos">194</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopped MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient.stop_server_sync-195"><a href="#SimpleMCPClient.stop_server_sync-195"><span class="linenos">195</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="SimpleMCPClient.stop_server_sync-196"><a href="#SimpleMCPClient.stop_server_sync-196"><span class="linenos">196</span></a>
</span><span id="SimpleMCPClient.stop_server_sync-197"><a href="#SimpleMCPClient.stop_server_sync-197"><span class="linenos">197</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SimpleMCPClient.stop_server_sync-198"><a href="#SimpleMCPClient.stop_server_sync-198"><span class="linenos">198</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error stopping MCP server </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SimpleMCPClient.stop_server_sync-199"><a href="#SimpleMCPClient.stop_server_sync-199"><span class="linenos">199</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Stop a specific MCP server.</p>
</div>


                            </div>
                            <div id="SimpleMCPClient.start_servers" class="classattr">
                                        <input id="SimpleMCPClient.start_servers-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">start_servers</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">server_configs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="SimpleMCPClient.start_servers-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SimpleMCPClient.start_servers"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SimpleMCPClient.start_servers-201"><a href="#SimpleMCPClient.start_servers-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start_servers</span><span class="p">(</span>
</span><span id="SimpleMCPClient.start_servers-202"><a href="#SimpleMCPClient.start_servers-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">server_configs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SimpleMCPClient.start_servers-203"><a href="#SimpleMCPClient.start_servers-203"><span class="linenos">203</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="SimpleMCPClient.start_servers-204"><a href="#SimpleMCPClient.start_servers-204"><span class="linenos">204</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start all configured MCP servers.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient.start_servers-205"><a href="#SimpleMCPClient.start_servers-205"><span class="linenos">205</span></a>        <span class="n">configs</span> <span class="o">=</span> <span class="n">server_configs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_configs</span>
</span><span id="SimpleMCPClient.start_servers-206"><a href="#SimpleMCPClient.start_servers-206"><span class="linenos">206</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SimpleMCPClient.start_servers-207"><a href="#SimpleMCPClient.start_servers-207"><span class="linenos">207</span></a>
</span><span id="SimpleMCPClient.start_servers-208"><a href="#SimpleMCPClient.start_servers-208"><span class="linenos">208</span></a>        <span class="k">for</span> <span class="n">server_name</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
</span><span id="SimpleMCPClient.start_servers-209"><a href="#SimpleMCPClient.start_servers-209"><span class="linenos">209</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_server_sync</span><span class="p">(</span><span class="n">server_name</span><span class="p">):</span>
</span><span id="SimpleMCPClient.start_servers-210"><a href="#SimpleMCPClient.start_servers-210"><span class="linenos">210</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to start MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient.start_servers-211"><a href="#SimpleMCPClient.start_servers-211"><span class="linenos">211</span></a>                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SimpleMCPClient.start_servers-212"><a href="#SimpleMCPClient.start_servers-212"><span class="linenos">212</span></a>
</span><span id="SimpleMCPClient.start_servers-213"><a href="#SimpleMCPClient.start_servers-213"><span class="linenos">213</span></a>        <span class="k">return</span> <span class="n">success</span>
</span></pre></div>


            <div class="docstring"><p>Start all configured MCP servers.</p>
</div>


                            </div>
                            <div id="SimpleMCPClient.stop_all_servers" class="classattr">
                                        <input id="SimpleMCPClient.stop_all_servers-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stop_all_servers</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SimpleMCPClient.stop_all_servers-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SimpleMCPClient.stop_all_servers"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SimpleMCPClient.stop_all_servers-215"><a href="#SimpleMCPClient.stop_all_servers-215"><span class="linenos">215</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop_all_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SimpleMCPClient.stop_all_servers-216"><a href="#SimpleMCPClient.stop_all_servers-216"><span class="linenos">216</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop all active MCP servers.&quot;&quot;&quot;</span>
</span><span id="SimpleMCPClient.stop_all_servers-217"><a href="#SimpleMCPClient.stop_all_servers-217"><span class="linenos">217</span></a>        <span class="k">for</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">server_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="SimpleMCPClient.stop_all_servers-218"><a href="#SimpleMCPClient.stop_all_servers-218"><span class="linenos">218</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SimpleMCPClient.stop_all_servers-219"><a href="#SimpleMCPClient.stop_all_servers-219"><span class="linenos">219</span></a>                <span class="n">process</span> <span class="o">=</span> <span class="n">server_info</span><span class="p">[</span><span class="s2">&quot;process&quot;</span><span class="p">]</span>
</span><span id="SimpleMCPClient.stop_all_servers-220"><a href="#SimpleMCPClient.stop_all_servers-220"><span class="linenos">220</span></a>                <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="SimpleMCPClient.stop_all_servers-221"><a href="#SimpleMCPClient.stop_all_servers-221"><span class="linenos">221</span></a>                <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Wait up to 5 seconds</span>
</span><span id="SimpleMCPClient.stop_all_servers-222"><a href="#SimpleMCPClient.stop_all_servers-222"><span class="linenos">222</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopped MCP server: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">)</span>
</span><span id="SimpleMCPClient.stop_all_servers-223"><a href="#SimpleMCPClient.stop_all_servers-223"><span class="linenos">223</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SimpleMCPClient.stop_all_servers-224"><a href="#SimpleMCPClient.stop_all_servers-224"><span class="linenos">224</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error stopping MCP server </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SimpleMCPClient.stop_all_servers-225"><a href="#SimpleMCPClient.stop_all_servers-225"><span class="linenos">225</span></a>
</span><span id="SimpleMCPClient.stop_all_servers-226"><a href="#SimpleMCPClient.stop_all_servers-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">active_servers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Stop all active MCP servers.</p>
</div>


                            </div>
                </section>
                <section id="setup_weaviate">
                            <input id="setup_weaviate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_weaviate</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="setup_weaviate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#setup_weaviate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="setup_weaviate-31"><a href="#setup_weaviate-31"><span class="linenos"> 31</span></a><span class="k">def</span><span class="w"> </span><span class="nf">setup_weaviate</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="setup_weaviate-32"><a href="#setup_weaviate-32"><span class="linenos"> 32</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="setup_weaviate-33"><a href="#setup_weaviate-33"><span class="linenos"> 33</span></a><span class="sd">    Setup Weaviate client and vector store. Returns True if successful.</span>
</span><span id="setup_weaviate-34"><a href="#setup_weaviate-34"><span class="linenos"> 34</span></a>
</span><span id="setup_weaviate-35"><a href="#setup_weaviate-35"><span class="linenos"> 35</span></a><span class="sd">    :return: True if Weaviate setup succeeded, False otherwise</span>
</span><span id="setup_weaviate-36"><a href="#setup_weaviate-36"><span class="linenos"> 36</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="setup_weaviate-37"><a href="#setup_weaviate-37"><span class="linenos"> 37</span></a>    <span class="k">global</span> <span class="n">vector_store</span><span class="p">,</span> <span class="n">weaviate_client</span>
</span><span id="setup_weaviate-38"><a href="#setup_weaviate-38"><span class="linenos"> 38</span></a>
</span><span id="setup_weaviate-39"><a href="#setup_weaviate-39"><span class="linenos"> 39</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">USE_WEAVIATE</span><span class="p">:</span>
</span><span id="setup_weaviate-40"><a href="#setup_weaviate-40"><span class="linenos"> 40</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Weaviate disabled by configuration&quot;</span><span class="p">)</span>
</span><span id="setup_weaviate-41"><a href="#setup_weaviate-41"><span class="linenos"> 41</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="setup_weaviate-42"><a href="#setup_weaviate-42"><span class="linenos"> 42</span></a>
</span><span id="setup_weaviate-43"><a href="#setup_weaviate-43"><span class="linenos"> 43</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="setup_weaviate-44"><a href="#setup_weaviate-44"><span class="linenos"> 44</span></a>        <span class="c1"># Verify Weaviate is running with retries</span>
</span><span id="setup_weaviate-45"><a href="#setup_weaviate-45"><span class="linenos"> 45</span></a>        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
</span><span id="setup_weaviate-46"><a href="#setup_weaviate-46"><span class="linenos"> 46</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="setup_weaviate-47"><a href="#setup_weaviate-47"><span class="linenos"> 47</span></a>                <span class="s2">&quot;Attempting to connect to Weaviate at </span><span class="si">%s</span><span class="s2"> (attempt </span><span class="si">%d</span><span class="s2">/5)&quot;</span><span class="p">,</span>
</span><span id="setup_weaviate-48"><a href="#setup_weaviate-48"><span class="linenos"> 48</span></a>                <span class="n">WEAVIATE_URL</span><span class="p">,</span>
</span><span id="setup_weaviate-49"><a href="#setup_weaviate-49"><span class="linenos"> 49</span></a>                <span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="setup_weaviate-50"><a href="#setup_weaviate-50"><span class="linenos"> 50</span></a>            <span class="p">)</span>
</span><span id="setup_weaviate-51"><a href="#setup_weaviate-51"><span class="linenos"> 51</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WEAVIATE_URL</span><span class="si">}</span><span class="s2">/v1/.well-known/ready&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="setup_weaviate-52"><a href="#setup_weaviate-52"><span class="linenos"> 52</span></a>            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="setup_weaviate-53"><a href="#setup_weaviate-53"><span class="linenos"> 53</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Weaviate is ready&quot;</span><span class="p">)</span>
</span><span id="setup_weaviate-54"><a href="#setup_weaviate-54"><span class="linenos"> 54</span></a>                <span class="k">break</span>
</span><span id="setup_weaviate-55"><a href="#setup_weaviate-55"><span class="linenos"> 55</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="setup_weaviate-56"><a href="#setup_weaviate-56"><span class="linenos"> 56</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weaviate returned status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="setup_weaviate-57"><a href="#setup_weaviate-57"><span class="linenos"> 57</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="setup_weaviate-58"><a href="#setup_weaviate-58"><span class="linenos"> 58</span></a>            <span class="c1"># If we&#39;ve exhausted all attempts</span>
</span><span id="setup_weaviate-59"><a href="#setup_weaviate-59"><span class="linenos"> 59</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="setup_weaviate-60"><a href="#setup_weaviate-60"><span class="linenos"> 60</span></a>                <span class="s2">&quot;Cannot connect to Weaviate at </span><span class="si">%s</span><span class="s2"> after 5 attempts&quot;</span><span class="p">,</span>
</span><span id="setup_weaviate-61"><a href="#setup_weaviate-61"><span class="linenos"> 61</span></a>                <span class="n">WEAVIATE_URL</span><span class="p">,</span>
</span><span id="setup_weaviate-62"><a href="#setup_weaviate-62"><span class="linenos"> 62</span></a>            <span class="p">)</span>
</span><span id="setup_weaviate-63"><a href="#setup_weaviate-63"><span class="linenos"> 63</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="setup_weaviate-64"><a href="#setup_weaviate-64"><span class="linenos"> 64</span></a>
</span><span id="setup_weaviate-65"><a href="#setup_weaviate-65"><span class="linenos"> 65</span></a>    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="setup_weaviate-66"><a href="#setup_weaviate-66"><span class="linenos"> 66</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Attempt </span><span class="si">%d</span><span class="s2">/5: Error connecting to Weaviate: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="setup_weaviate-67"><a href="#setup_weaviate-67"><span class="linenos"> 67</span></a>        <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="setup_weaviate-68"><a href="#setup_weaviate-68"><span class="linenos"> 68</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="setup_weaviate-69"><a href="#setup_weaviate-69"><span class="linenos"> 69</span></a>                <span class="s2">&quot;Cannot connect to Weaviate at </span><span class="si">%s</span><span class="s2">, proceeding without Weaviate&quot;</span><span class="p">,</span>
</span><span id="setup_weaviate-70"><a href="#setup_weaviate-70"><span class="linenos"> 70</span></a>                <span class="n">WEAVIATE_URL</span><span class="p">,</span>
</span><span id="setup_weaviate-71"><a href="#setup_weaviate-71"><span class="linenos"> 71</span></a>            <span class="p">)</span>
</span><span id="setup_weaviate-72"><a href="#setup_weaviate-72"><span class="linenos"> 72</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="setup_weaviate-73"><a href="#setup_weaviate-73"><span class="linenos"> 73</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="setup_weaviate-74"><a href="#setup_weaviate-74"><span class="linenos"> 74</span></a>
</span><span id="setup_weaviate-75"><a href="#setup_weaviate-75"><span class="linenos"> 75</span></a>    <span class="c1"># Parse WEAVIATE_URL to create ConnectionParams</span>
</span><span id="setup_weaviate-76"><a href="#setup_weaviate-76"><span class="linenos"> 76</span></a>    <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">parse_url</span><span class="p">(</span><span class="n">WEAVIATE_URL</span><span class="p">)</span>
</span><span id="setup_weaviate-77"><a href="#setup_weaviate-77"><span class="linenos"> 77</span></a>    <span class="n">connection_params</span> <span class="o">=</span> <span class="n">ConnectionParams</span><span class="o">.</span><span class="n">from_params</span><span class="p">(</span>
</span><span id="setup_weaviate-78"><a href="#setup_weaviate-78"><span class="linenos"> 78</span></a>        <span class="n">http_host</span><span class="o">=</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">host</span> <span class="ow">or</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
</span><span id="setup_weaviate-79"><a href="#setup_weaviate-79"><span class="linenos"> 79</span></a>        <span class="n">http_port</span><span class="o">=</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">port</span> <span class="ow">or</span> <span class="mi">8080</span><span class="p">,</span>
</span><span id="setup_weaviate-80"><a href="#setup_weaviate-80"><span class="linenos"> 80</span></a>        <span class="n">http_secure</span><span class="o">=</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span>
</span><span id="setup_weaviate-81"><a href="#setup_weaviate-81"><span class="linenos"> 81</span></a>        <span class="n">grpc_host</span><span class="o">=</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">host</span> <span class="ow">or</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
</span><span id="setup_weaviate-82"><a href="#setup_weaviate-82"><span class="linenos"> 82</span></a>        <span class="n">grpc_port</span><span class="o">=</span><span class="mi">50051</span><span class="p">,</span>  <span class="c1"># Weaviate&#39;s default gRPC port</span>
</span><span id="setup_weaviate-83"><a href="#setup_weaviate-83"><span class="linenos"> 83</span></a>        <span class="n">grpc_secure</span><span class="o">=</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span>
</span><span id="setup_weaviate-84"><a href="#setup_weaviate-84"><span class="linenos"> 84</span></a>    <span class="p">)</span>
</span><span id="setup_weaviate-85"><a href="#setup_weaviate-85"><span class="linenos"> 85</span></a>
</span><span id="setup_weaviate-86"><a href="#setup_weaviate-86"><span class="linenos"> 86</span></a>    <span class="c1"># Initialize Weaviate client !!!</span>
</span><span id="setup_weaviate-87"><a href="#setup_weaviate-87"><span class="linenos"> 87</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="setup_weaviate-88"><a href="#setup_weaviate-88"><span class="linenos"> 88</span></a>        <span class="n">weaviate_client</span> <span class="o">=</span> <span class="n">WeaviateClient</span><span class="p">(</span>
</span><span id="setup_weaviate-89"><a href="#setup_weaviate-89"><span class="linenos"> 89</span></a>            <span class="n">connection_params</span><span class="p">,</span>
</span><span id="setup_weaviate-90"><a href="#setup_weaviate-90"><span class="linenos"> 90</span></a>            <span class="n">skip_init_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="setup_weaviate-91"><a href="#setup_weaviate-91"><span class="linenos"> 91</span></a>            <span class="n">additional_headers</span><span class="o">=</span><span class="p">{</span>
</span><span id="setup_weaviate-92"><a href="#setup_weaviate-92"><span class="linenos"> 92</span></a>                <span class="s2">&quot;X-OpenAI-Api-Key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span>
</span><span id="setup_weaviate-93"><a href="#setup_weaviate-93"><span class="linenos"> 93</span></a>                    <span class="s2">&quot;OPENAI_API_KEY&quot;</span>
</span><span id="setup_weaviate-94"><a href="#setup_weaviate-94"><span class="linenos"> 94</span></a>                <span class="p">]</span>  <span class="c1"># Add inference API keys as needed</span>
</span><span id="setup_weaviate-95"><a href="#setup_weaviate-95"><span class="linenos"> 95</span></a>            <span class="p">},</span>
</span><span id="setup_weaviate-96"><a href="#setup_weaviate-96"><span class="linenos"> 96</span></a>        <span class="p">)</span>
</span><span id="setup_weaviate-97"><a href="#setup_weaviate-97"><span class="linenos"> 97</span></a>        <span class="n">weaviate_client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>  <span class="c1"># Explicitly connect</span>
</span><span id="setup_weaviate-98"><a href="#setup_weaviate-98"><span class="linenos"> 98</span></a>        <span class="n">collection_name</span> <span class="o">=</span> <span class="s2">&quot;UserKnowledgeBase&quot;</span>
</span><span id="setup_weaviate-99"><a href="#setup_weaviate-99"><span class="linenos"> 99</span></a>
</span><span id="setup_weaviate-100"><a href="#setup_weaviate-100"><span class="linenos">100</span></a>        <span class="c1"># Create Weaviate collection if it doesn&#39;t exist</span>
</span><span id="setup_weaviate-101"><a href="#setup_weaviate-101"><span class="linenos">101</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">weaviate_client</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">collection_name</span><span class="p">):</span>
</span><span id="setup_weaviate-102"><a href="#setup_weaviate-102"><span class="linenos">102</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Weaviate collection: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span>
</span><span id="setup_weaviate-103"><a href="#setup_weaviate-103"><span class="linenos">103</span></a>            <span class="n">weaviate_client</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="setup_weaviate-104"><a href="#setup_weaviate-104"><span class="linenos">104</span></a>                <span class="n">name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
</span><span id="setup_weaviate-105"><a href="#setup_weaviate-105"><span class="linenos">105</span></a>                <span class="n">properties</span><span class="o">=</span><span class="p">[</span>
</span><span id="setup_weaviate-106"><a href="#setup_weaviate-106"><span class="linenos">106</span></a>                    <span class="n">wvc</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">wvc</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">),</span>
</span><span id="setup_weaviate-107"><a href="#setup_weaviate-107"><span class="linenos">107</span></a>                    <span class="n">wvc</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">wvc</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">DATE</span><span class="p">),</span>
</span><span id="setup_weaviate-108"><a href="#setup_weaviate-108"><span class="linenos">108</span></a>                    <span class="n">wvc</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;topic&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">wvc</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">),</span>
</span><span id="setup_weaviate-109"><a href="#setup_weaviate-109"><span class="linenos">109</span></a>                <span class="p">],</span>
</span><span id="setup_weaviate-110"><a href="#setup_weaviate-110"><span class="linenos">110</span></a>                <span class="n">vectorizer_config</span><span class="o">=</span><span class="n">wvc</span><span class="o">.</span><span class="n">Configure</span><span class="o">.</span><span class="n">Vectorizer</span><span class="o">.</span><span class="n">text2vec_ollama</span><span class="p">(</span>
</span><span id="setup_weaviate-111"><a href="#setup_weaviate-111"><span class="linenos">111</span></a>                    <span class="n">api_endpoint</span><span class="o">=</span><span class="s2">&quot;http://host.docker.internal:11434&quot;</span><span class="p">,</span>
</span><span id="setup_weaviate-112"><a href="#setup_weaviate-112"><span class="linenos">112</span></a>                    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;nomic-embed-text&quot;</span><span class="p">,</span>
</span><span id="setup_weaviate-113"><a href="#setup_weaviate-113"><span class="linenos">113</span></a>                <span class="p">),</span>
</span><span id="setup_weaviate-114"><a href="#setup_weaviate-114"><span class="linenos">114</span></a>            <span class="p">)</span>
</span><span id="setup_weaviate-115"><a href="#setup_weaviate-115"><span class="linenos">115</span></a>    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="setup_weaviate-116"><a href="#setup_weaviate-116"><span class="linenos">116</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Import error initializing Weaviate client or collection: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="setup_weaviate-117"><a href="#setup_weaviate-117"><span class="linenos">117</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="setup_weaviate-118"><a href="#setup_weaviate-118"><span class="linenos">118</span></a>    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="setup_weaviate-119"><a href="#setup_weaviate-119"><span class="linenos">119</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="setup_weaviate-120"><a href="#setup_weaviate-120"><span class="linenos">120</span></a>            <span class="s2">&quot;Attribute error initializing Weaviate client or collection: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span>
</span><span id="setup_weaviate-121"><a href="#setup_weaviate-121"><span class="linenos">121</span></a>        <span class="p">)</span>
</span><span id="setup_weaviate-122"><a href="#setup_weaviate-122"><span class="linenos">122</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="setup_weaviate-123"><a href="#setup_weaviate-123"><span class="linenos">123</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="setup_weaviate-124"><a href="#setup_weaviate-124"><span class="linenos">124</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="setup_weaviate-125"><a href="#setup_weaviate-125"><span class="linenos">125</span></a>            <span class="s2">&quot;Unexpected error initializing Weaviate client or collection: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span>
</span><span id="setup_weaviate-126"><a href="#setup_weaviate-126"><span class="linenos">126</span></a>        <span class="p">)</span>
</span><span id="setup_weaviate-127"><a href="#setup_weaviate-127"><span class="linenos">127</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="setup_weaviate-128"><a href="#setup_weaviate-128"><span class="linenos">128</span></a>
</span><span id="setup_weaviate-129"><a href="#setup_weaviate-129"><span class="linenos">129</span></a>    <span class="c1"># Initialize Weaviate vector store</span>
</span><span id="setup_weaviate-130"><a href="#setup_weaviate-130"><span class="linenos">130</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="setup_weaviate-131"><a href="#setup_weaviate-131"><span class="linenos">131</span></a>        <span class="n">vector_store</span> <span class="o">=</span> <span class="n">WeaviateVectorStore</span><span class="p">(</span>
</span><span id="setup_weaviate-132"><a href="#setup_weaviate-132"><span class="linenos">132</span></a>            <span class="n">client</span><span class="o">=</span><span class="n">weaviate_client</span><span class="p">,</span>
</span><span id="setup_weaviate-133"><a href="#setup_weaviate-133"><span class="linenos">133</span></a>            <span class="n">index_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
</span><span id="setup_weaviate-134"><a href="#setup_weaviate-134"><span class="linenos">134</span></a>            <span class="n">text_key</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
</span><span id="setup_weaviate-135"><a href="#setup_weaviate-135"><span class="linenos">135</span></a>            <span class="n">embedding</span><span class="o">=</span><span class="n">OllamaEmbeddings</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;nomic-embed-text&quot;</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">OLLAMA_URL</span><span class="p">),</span>
</span><span id="setup_weaviate-136"><a href="#setup_weaviate-136"><span class="linenos">136</span></a>            <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;topic&quot;</span><span class="p">],</span>
</span><span id="setup_weaviate-137"><a href="#setup_weaviate-137"><span class="linenos">137</span></a>        <span class="p">)</span>
</span><span id="setup_weaviate-138"><a href="#setup_weaviate-138"><span class="linenos">138</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully initialized Weaviate vector store&quot;</span><span class="p">)</span>
</span><span id="setup_weaviate-139"><a href="#setup_weaviate-139"><span class="linenos">139</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="setup_weaviate-140"><a href="#setup_weaviate-140"><span class="linenos">140</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="setup_weaviate-141"><a href="#setup_weaviate-141"><span class="linenos">141</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error initializing vector store: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="setup_weaviate-142"><a href="#setup_weaviate-142"><span class="linenos">142</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Setup Weaviate client and vector store. Returns True if successful.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>True if Weaviate setup succeeded, False otherwise</p>
</blockquote>
</div>


                </section>
                <section id="is_weaviate_connected">
                            <input id="is_weaviate_connected-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_weaviate_connected</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="is_weaviate_connected-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#is_weaviate_connected"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="is_weaviate_connected-145"><a href="#is_weaviate_connected-145"><span class="linenos">145</span></a><span class="k">def</span><span class="w"> </span><span class="nf">is_weaviate_connected</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="is_weaviate_connected-146"><a href="#is_weaviate_connected-146"><span class="linenos">146</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="is_weaviate_connected-147"><a href="#is_weaviate_connected-147"><span class="linenos">147</span></a><span class="sd">    Check if Weaviate is available and connected.</span>
</span><span id="is_weaviate_connected-148"><a href="#is_weaviate_connected-148"><span class="linenos">148</span></a>
</span><span id="is_weaviate_connected-149"><a href="#is_weaviate_connected-149"><span class="linenos">149</span></a><span class="sd">    :return: True if Weaviate is connected and ready, False otherwise</span>
</span><span id="is_weaviate_connected-150"><a href="#is_weaviate_connected-150"><span class="linenos">150</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="is_weaviate_connected-151"><a href="#is_weaviate_connected-151"><span class="linenos">151</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">USE_WEAVIATE</span><span class="p">:</span>
</span><span id="is_weaviate_connected-152"><a href="#is_weaviate_connected-152"><span class="linenos">152</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="is_weaviate_connected-153"><a href="#is_weaviate_connected-153"><span class="linenos">153</span></a>
</span><span id="is_weaviate_connected-154"><a href="#is_weaviate_connected-154"><span class="linenos">154</span></a>    <span class="k">if</span> <span class="n">weaviate_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="is_weaviate_connected-155"><a href="#is_weaviate_connected-155"><span class="linenos">155</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="is_weaviate_connected-156"><a href="#is_weaviate_connected-156"><span class="linenos">156</span></a>
</span><span id="is_weaviate_connected-157"><a href="#is_weaviate_connected-157"><span class="linenos">157</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="is_weaviate_connected-158"><a href="#is_weaviate_connected-158"><span class="linenos">158</span></a>        <span class="c1"># Check if Weaviate is ready via HTTP endpoint</span>
</span><span id="is_weaviate_connected-159"><a href="#is_weaviate_connected-159"><span class="linenos">159</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WEAVIATE_URL</span><span class="si">}</span><span class="s2">/v1/.well-known/ready&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="is_weaviate_connected-160"><a href="#is_weaviate_connected-160"><span class="linenos">160</span></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="is_weaviate_connected-161"><a href="#is_weaviate_connected-161"><span class="linenos">161</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="is_weaviate_connected-162"><a href="#is_weaviate_connected-162"><span class="linenos">162</span></a>
</span><span id="is_weaviate_connected-163"><a href="#is_weaviate_connected-163"><span class="linenos">163</span></a>        <span class="c1"># Additionally check database health and attempt recovery if needed</span>
</span><span id="is_weaviate_connected-164"><a href="#is_weaviate_connected-164"><span class="linenos">164</span></a>        <span class="k">return</span> <span class="n">reset_weaviate_if_corrupted</span><span class="p">()</span>
</span><span id="is_weaviate_connected-165"><a href="#is_weaviate_connected-165"><span class="linenos">165</span></a>
</span><span id="is_weaviate_connected-166"><a href="#is_weaviate_connected-166"><span class="linenos">166</span></a>    <span class="k">except</span> <span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="is_weaviate_connected-167"><a href="#is_weaviate_connected-167"><span class="linenos">167</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Weaviate connection check failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="is_weaviate_connected-168"><a href="#is_weaviate_connected-168"><span class="linenos">168</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Check if Weaviate is available and connected.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>True if Weaviate is connected and ready, False otherwise</p>
</blockquote>
</div>


                </section>
                <section id="reset_weaviate_if_corrupted">
                            <input id="reset_weaviate_if_corrupted-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reset_weaviate_if_corrupted</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="reset_weaviate_if_corrupted-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#reset_weaviate_if_corrupted"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="reset_weaviate_if_corrupted-171"><a href="#reset_weaviate_if_corrupted-171"><span class="linenos">171</span></a><span class="k">def</span><span class="w"> </span><span class="nf">reset_weaviate_if_corrupted</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="reset_weaviate_if_corrupted-172"><a href="#reset_weaviate_if_corrupted-172"><span class="linenos">172</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="reset_weaviate_if_corrupted-173"><a href="#reset_weaviate_if_corrupted-173"><span class="linenos">173</span></a><span class="sd">    Check for Weaviate database corruption and attempt recovery.</span>
</span><span id="reset_weaviate_if_corrupted-174"><a href="#reset_weaviate_if_corrupted-174"><span class="linenos">174</span></a>
</span><span id="reset_weaviate_if_corrupted-175"><a href="#reset_weaviate_if_corrupted-175"><span class="linenos">175</span></a><span class="sd">    :return: True if reset was successful or not needed, False if reset failed</span>
</span><span id="reset_weaviate_if_corrupted-176"><a href="#reset_weaviate_if_corrupted-176"><span class="linenos">176</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="reset_weaviate_if_corrupted-177"><a href="#reset_weaviate_if_corrupted-177"><span class="linenos">177</span></a>    <span class="k">global</span> <span class="n">vector_store</span><span class="p">,</span> <span class="n">weaviate_client</span>
</span><span id="reset_weaviate_if_corrupted-178"><a href="#reset_weaviate_if_corrupted-178"><span class="linenos">178</span></a>
</span><span id="reset_weaviate_if_corrupted-179"><a href="#reset_weaviate_if_corrupted-179"><span class="linenos">179</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">USE_WEAVIATE</span> <span class="ow">or</span> <span class="n">weaviate_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="reset_weaviate_if_corrupted-180"><a href="#reset_weaviate_if_corrupted-180"><span class="linenos">180</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="reset_weaviate_if_corrupted-181"><a href="#reset_weaviate_if_corrupted-181"><span class="linenos">181</span></a>
</span><span id="reset_weaviate_if_corrupted-182"><a href="#reset_weaviate_if_corrupted-182"><span class="linenos">182</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="reset_weaviate_if_corrupted-183"><a href="#reset_weaviate_if_corrupted-183"><span class="linenos">183</span></a>        <span class="c1"># Try a simple operation to test database health</span>
</span><span id="reset_weaviate_if_corrupted-184"><a href="#reset_weaviate_if_corrupted-184"><span class="linenos">184</span></a>        <span class="n">collection</span> <span class="o">=</span> <span class="n">weaviate_client</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;UserKnowledgeBase&quot;</span><span class="p">)</span>
</span><span id="reset_weaviate_if_corrupted-185"><a href="#reset_weaviate_if_corrupted-185"><span class="linenos">185</span></a>        <span class="c1"># Attempt to get collection info</span>
</span><span id="reset_weaviate_if_corrupted-186"><a href="#reset_weaviate_if_corrupted-186"><span class="linenos">186</span></a>        <span class="n">collection</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="reset_weaviate_if_corrupted-187"><a href="#reset_weaviate_if_corrupted-187"><span class="linenos">187</span></a>        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Database is healthy</span>
</span><span id="reset_weaviate_if_corrupted-188"><a href="#reset_weaviate_if_corrupted-188"><span class="linenos">188</span></a>
</span><span id="reset_weaviate_if_corrupted-189"><a href="#reset_weaviate_if_corrupted-189"><span class="linenos">189</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="reset_weaviate_if_corrupted-190"><a href="#reset_weaviate_if_corrupted-190"><span class="linenos">190</span></a>        <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="reset_weaviate_if_corrupted-191"><a href="#reset_weaviate_if_corrupted-191"><span class="linenos">191</span></a>
</span><span id="reset_weaviate_if_corrupted-192"><a href="#reset_weaviate_if_corrupted-192"><span class="linenos">192</span></a>        <span class="c1"># Check for common corruption indicators</span>
</span><span id="reset_weaviate_if_corrupted-193"><a href="#reset_weaviate_if_corrupted-193"><span class="linenos">193</span></a>        <span class="n">corruption_indicators</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="reset_weaviate_if_corrupted-194"><a href="#reset_weaviate_if_corrupted-194"><span class="linenos">194</span></a>            <span class="s2">&quot;no such file or directory&quot;</span><span class="p">,</span>
</span><span id="reset_weaviate_if_corrupted-195"><a href="#reset_weaviate_if_corrupted-195"><span class="linenos">195</span></a>            <span class="s2">&quot;wal&quot;</span><span class="p">,</span>
</span><span id="reset_weaviate_if_corrupted-196"><a href="#reset_weaviate_if_corrupted-196"><span class="linenos">196</span></a>            <span class="s2">&quot;segment-&quot;</span><span class="p">,</span>
</span><span id="reset_weaviate_if_corrupted-197"><a href="#reset_weaviate_if_corrupted-197"><span class="linenos">197</span></a>            <span class="s2">&quot;commit log&quot;</span><span class="p">,</span>
</span><span id="reset_weaviate_if_corrupted-198"><a href="#reset_weaviate_if_corrupted-198"><span class="linenos">198</span></a>            <span class="s2">&quot;failed to send all objects&quot;</span><span class="p">,</span>
</span><span id="reset_weaviate_if_corrupted-199"><a href="#reset_weaviate_if_corrupted-199"><span class="linenos">199</span></a>            <span class="s2">&quot;weaviateinsertmanyallfailederror&quot;</span><span class="p">,</span>
</span><span id="reset_weaviate_if_corrupted-200"><a href="#reset_weaviate_if_corrupted-200"><span class="linenos">200</span></a>        <span class="p">]</span>
</span><span id="reset_weaviate_if_corrupted-201"><a href="#reset_weaviate_if_corrupted-201"><span class="linenos">201</span></a>
</span><span id="reset_weaviate_if_corrupted-202"><a href="#reset_weaviate_if_corrupted-202"><span class="linenos">202</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">indicator</span> <span class="ow">in</span> <span class="n">error_msg</span> <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">corruption_indicators</span><span class="p">):</span>
</span><span id="reset_weaviate_if_corrupted-203"><a href="#reset_weaviate_if_corrupted-203"><span class="linenos">203</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Database corruption detected: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="reset_weaviate_if_corrupted-204"><a href="#reset_weaviate_if_corrupted-204"><span class="linenos">204</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to reconnect to Weaviate...&quot;</span><span class="p">)</span>
</span><span id="reset_weaviate_if_corrupted-205"><a href="#reset_weaviate_if_corrupted-205"><span class="linenos">205</span></a>
</span><span id="reset_weaviate_if_corrupted-206"><a href="#reset_weaviate_if_corrupted-206"><span class="linenos">206</span></a>            <span class="c1"># Close existing connection</span>
</span><span id="reset_weaviate_if_corrupted-207"><a href="#reset_weaviate_if_corrupted-207"><span class="linenos">207</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="reset_weaviate_if_corrupted-208"><a href="#reset_weaviate_if_corrupted-208"><span class="linenos">208</span></a>                <span class="k">if</span> <span class="n">weaviate_client</span><span class="p">:</span>
</span><span id="reset_weaviate_if_corrupted-209"><a href="#reset_weaviate_if_corrupted-209"><span class="linenos">209</span></a>                    <span class="n">weaviate_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="reset_weaviate_if_corrupted-210"><a href="#reset_weaviate_if_corrupted-210"><span class="linenos">210</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="reset_weaviate_if_corrupted-211"><a href="#reset_weaviate_if_corrupted-211"><span class="linenos">211</span></a>                <span class="k">pass</span>
</span><span id="reset_weaviate_if_corrupted-212"><a href="#reset_weaviate_if_corrupted-212"><span class="linenos">212</span></a>
</span><span id="reset_weaviate_if_corrupted-213"><a href="#reset_weaviate_if_corrupted-213"><span class="linenos">213</span></a>            <span class="c1"># Reset global variables</span>
</span><span id="reset_weaviate_if_corrupted-214"><a href="#reset_weaviate_if_corrupted-214"><span class="linenos">214</span></a>            <span class="n">weaviate_client</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="reset_weaviate_if_corrupted-215"><a href="#reset_weaviate_if_corrupted-215"><span class="linenos">215</span></a>            <span class="n">vector_store</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="reset_weaviate_if_corrupted-216"><a href="#reset_weaviate_if_corrupted-216"><span class="linenos">216</span></a>
</span><span id="reset_weaviate_if_corrupted-217"><a href="#reset_weaviate_if_corrupted-217"><span class="linenos">217</span></a>            <span class="c1"># Wait a moment for cleanup</span>
</span><span id="reset_weaviate_if_corrupted-218"><a href="#reset_weaviate_if_corrupted-218"><span class="linenos">218</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="reset_weaviate_if_corrupted-219"><a href="#reset_weaviate_if_corrupted-219"><span class="linenos">219</span></a>
</span><span id="reset_weaviate_if_corrupted-220"><a href="#reset_weaviate_if_corrupted-220"><span class="linenos">220</span></a>            <span class="c1"># Attempt to reconnect</span>
</span><span id="reset_weaviate_if_corrupted-221"><a href="#reset_weaviate_if_corrupted-221"><span class="linenos">221</span></a>            <span class="k">return</span> <span class="n">setup_weaviate</span><span class="p">()</span>
</span><span id="reset_weaviate_if_corrupted-222"><a href="#reset_weaviate_if_corrupted-222"><span class="linenos">222</span></a>
</span><span id="reset_weaviate_if_corrupted-223"><a href="#reset_weaviate_if_corrupted-223"><span class="linenos">223</span></a>        <span class="c1"># Not a corruption error, re-raise</span>
</span><span id="reset_weaviate_if_corrupted-224"><a href="#reset_weaviate_if_corrupted-224"><span class="linenos">224</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Non-corruption Weaviate error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="reset_weaviate_if_corrupted-225"><a href="#reset_weaviate_if_corrupted-225"><span class="linenos">225</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Check for Weaviate database corruption and attempt recovery.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>True if reset was successful or not needed, False if reset failed</p>
</blockquote>
</div>


                </section>
                <section id="is_agno_storage_connected">
                            <input id="is_agno_storage_connected-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_agno_storage_connected</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="is_agno_storage_connected-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#is_agno_storage_connected"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="is_agno_storage_connected-228"><a href="#is_agno_storage_connected-228"><span class="linenos">228</span></a><span class="k">def</span><span class="w"> </span><span class="nf">is_agno_storage_connected</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="is_agno_storage_connected-229"><a href="#is_agno_storage_connected-229"><span class="linenos">229</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="is_agno_storage_connected-230"><a href="#is_agno_storage_connected-230"><span class="linenos">230</span></a><span class="sd">    Check if Agno storage is available and connected.</span>
</span><span id="is_agno_storage_connected-231"><a href="#is_agno_storage_connected-231"><span class="linenos">231</span></a>
</span><span id="is_agno_storage_connected-232"><a href="#is_agno_storage_connected-232"><span class="linenos">232</span></a><span class="sd">    :return: True if Agno storage directories exist and are accessible, False otherwise</span>
</span><span id="is_agno_storage_connected-233"><a href="#is_agno_storage_connected-233"><span class="linenos">233</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="is_agno_storage_connected-234"><a href="#is_agno_storage_connected-234"><span class="linenos">234</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">..config</span><span class="w"> </span><span class="kn">import</span> <span class="n">STORAGE_BACKEND</span><span class="p">,</span> <span class="n">AGNO_STORAGE_DIR</span><span class="p">,</span> <span class="n">AGNO_KNOWLEDGE_DIR</span>
</span><span id="is_agno_storage_connected-235"><a href="#is_agno_storage_connected-235"><span class="linenos">235</span></a>    
</span><span id="is_agno_storage_connected-236"><a href="#is_agno_storage_connected-236"><span class="linenos">236</span></a>    <span class="k">if</span> <span class="n">STORAGE_BACKEND</span> <span class="o">!=</span> <span class="s2">&quot;agno&quot;</span><span class="p">:</span>
</span><span id="is_agno_storage_connected-237"><a href="#is_agno_storage_connected-237"><span class="linenos">237</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="is_agno_storage_connected-238"><a href="#is_agno_storage_connected-238"><span class="linenos">238</span></a>    
</span><span id="is_agno_storage_connected-239"><a href="#is_agno_storage_connected-239"><span class="linenos">239</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="is_agno_storage_connected-240"><a href="#is_agno_storage_connected-240"><span class="linenos">240</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="is_agno_storage_connected-241"><a href="#is_agno_storage_connected-241"><span class="linenos">241</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="is_agno_storage_connected-242"><a href="#is_agno_storage_connected-242"><span class="linenos">242</span></a>        
</span><span id="is_agno_storage_connected-243"><a href="#is_agno_storage_connected-243"><span class="linenos">243</span></a>        <span class="c1"># Check if storage directories exist and are accessible</span>
</span><span id="is_agno_storage_connected-244"><a href="#is_agno_storage_connected-244"><span class="linenos">244</span></a>        <span class="n">storage_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">AGNO_STORAGE_DIR</span><span class="p">)</span>
</span><span id="is_agno_storage_connected-245"><a href="#is_agno_storage_connected-245"><span class="linenos">245</span></a>        <span class="n">knowledge_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">AGNO_KNOWLEDGE_DIR</span><span class="p">)</span>
</span><span id="is_agno_storage_connected-246"><a href="#is_agno_storage_connected-246"><span class="linenos">246</span></a>        
</span><span id="is_agno_storage_connected-247"><a href="#is_agno_storage_connected-247"><span class="linenos">247</span></a>        <span class="c1"># Create directories if they don&#39;t exist (this is normal for Agno)</span>
</span><span id="is_agno_storage_connected-248"><a href="#is_agno_storage_connected-248"><span class="linenos">248</span></a>        <span class="n">storage_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="is_agno_storage_connected-249"><a href="#is_agno_storage_connected-249"><span class="linenos">249</span></a>        <span class="n">knowledge_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="is_agno_storage_connected-250"><a href="#is_agno_storage_connected-250"><span class="linenos">250</span></a>        
</span><span id="is_agno_storage_connected-251"><a href="#is_agno_storage_connected-251"><span class="linenos">251</span></a>        <span class="c1"># Test write access to storage directory</span>
</span><span id="is_agno_storage_connected-252"><a href="#is_agno_storage_connected-252"><span class="linenos">252</span></a>        <span class="n">test_file</span> <span class="o">=</span> <span class="n">storage_path</span> <span class="o">/</span> <span class="s2">&quot;.connection_test&quot;</span>
</span><span id="is_agno_storage_connected-253"><a href="#is_agno_storage_connected-253"><span class="linenos">253</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="is_agno_storage_connected-254"><a href="#is_agno_storage_connected-254"><span class="linenos">254</span></a>            <span class="n">test_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
</span><span id="is_agno_storage_connected-255"><a href="#is_agno_storage_connected-255"><span class="linenos">255</span></a>            <span class="n">test_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>  <span class="c1"># Remove test file</span>
</span><span id="is_agno_storage_connected-256"><a href="#is_agno_storage_connected-256"><span class="linenos">256</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">):</span>
</span><span id="is_agno_storage_connected-257"><a href="#is_agno_storage_connected-257"><span class="linenos">257</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cannot write to Agno storage directory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">storage_path</span><span class="p">)</span>
</span><span id="is_agno_storage_connected-258"><a href="#is_agno_storage_connected-258"><span class="linenos">258</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="is_agno_storage_connected-259"><a href="#is_agno_storage_connected-259"><span class="linenos">259</span></a>        
</span><span id="is_agno_storage_connected-260"><a href="#is_agno_storage_connected-260"><span class="linenos">260</span></a>        <span class="c1"># Check if we can import required Agno modules</span>
</span><span id="is_agno_storage_connected-261"><a href="#is_agno_storage_connected-261"><span class="linenos">261</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="is_agno_storage_connected-262"><a href="#is_agno_storage_connected-262"><span class="linenos">262</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">agno.storage.sqlite</span><span class="w"> </span><span class="kn">import</span> <span class="n">SqliteStorage</span>
</span><span id="is_agno_storage_connected-263"><a href="#is_agno_storage_connected-263"><span class="linenos">263</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">agno.memory.v2.db.sqlite</span><span class="w"> </span><span class="kn">import</span> <span class="n">SqliteMemoryDb</span>
</span><span id="is_agno_storage_connected-264"><a href="#is_agno_storage_connected-264"><span class="linenos">264</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="is_agno_storage_connected-265"><a href="#is_agno_storage_connected-265"><span class="linenos">265</span></a>        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="is_agno_storage_connected-266"><a href="#is_agno_storage_connected-266"><span class="linenos">266</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Agno modules not available: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="is_agno_storage_connected-267"><a href="#is_agno_storage_connected-267"><span class="linenos">267</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="is_agno_storage_connected-268"><a href="#is_agno_storage_connected-268"><span class="linenos">268</span></a>            
</span><span id="is_agno_storage_connected-269"><a href="#is_agno_storage_connected-269"><span class="linenos">269</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="is_agno_storage_connected-270"><a href="#is_agno_storage_connected-270"><span class="linenos">270</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Agno storage connection check failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="is_agno_storage_connected-271"><a href="#is_agno_storage_connected-271"><span class="linenos">271</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Check if Agno storage is available and connected.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>True if Agno storage directories exist and are accessible, False otherwise</p>
</blockquote>
</div>


                </section>
                <section id="is_memory_connected">
                            <input id="is_memory_connected-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_memory_connected</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="is_memory_connected-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#is_memory_connected"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="is_memory_connected-274"><a href="#is_memory_connected-274"><span class="linenos">274</span></a><span class="k">def</span><span class="w"> </span><span class="nf">is_memory_connected</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="is_memory_connected-275"><a href="#is_memory_connected-275"><span class="linenos">275</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="is_memory_connected-276"><a href="#is_memory_connected-276"><span class="linenos">276</span></a><span class="sd">    Check if the configured memory backend is connected.</span>
</span><span id="is_memory_connected-277"><a href="#is_memory_connected-277"><span class="linenos">277</span></a><span class="sd">    </span>
</span><span id="is_memory_connected-278"><a href="#is_memory_connected-278"><span class="linenos">278</span></a><span class="sd">    :return: True if the configured memory backend is connected, False otherwise</span>
</span><span id="is_memory_connected-279"><a href="#is_memory_connected-279"><span class="linenos">279</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="is_memory_connected-280"><a href="#is_memory_connected-280"><span class="linenos">280</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">..config</span><span class="w"> </span><span class="kn">import</span> <span class="n">STORAGE_BACKEND</span>
</span><span id="is_memory_connected-281"><a href="#is_memory_connected-281"><span class="linenos">281</span></a>    
</span><span id="is_memory_connected-282"><a href="#is_memory_connected-282"><span class="linenos">282</span></a>    <span class="k">if</span> <span class="n">STORAGE_BACKEND</span> <span class="o">==</span> <span class="s2">&quot;weaviate&quot;</span><span class="p">:</span>
</span><span id="is_memory_connected-283"><a href="#is_memory_connected-283"><span class="linenos">283</span></a>        <span class="k">return</span> <span class="n">is_weaviate_connected</span><span class="p">()</span>
</span><span id="is_memory_connected-284"><a href="#is_memory_connected-284"><span class="linenos">284</span></a>    <span class="k">elif</span> <span class="n">STORAGE_BACKEND</span> <span class="o">==</span> <span class="s2">&quot;agno&quot;</span><span class="p">:</span>
</span><span id="is_memory_connected-285"><a href="#is_memory_connected-285"><span class="linenos">285</span></a>        <span class="k">return</span> <span class="n">is_agno_storage_connected</span><span class="p">()</span>
</span><span id="is_memory_connected-286"><a href="#is_memory_connected-286"><span class="linenos">286</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="is_memory_connected-287"><a href="#is_memory_connected-287"><span class="linenos">287</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown storage backend: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">STORAGE_BACKEND</span><span class="p">)</span>
</span><span id="is_memory_connected-288"><a href="#is_memory_connected-288"><span class="linenos">288</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Check if the configured memory backend is connected.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>True if the configured memory backend is connected, False otherwise</p>
</blockquote>
</div>


                </section>
                <section id="create_agent_executor">
                            <input id="create_agent_executor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_agent_executor</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">langchain_core</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">BaseTool</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">langchain</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">AgentExecutor</span>:</span></span>

                <label class="view-source-button" for="create_agent_executor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_agent_executor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_agent_executor-17"><a href="#create_agent_executor-17"><span class="linenos">17</span></a><span class="k">def</span><span class="w"> </span><span class="nf">create_agent_executor</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AgentExecutor</span><span class="p">:</span>
</span><span id="create_agent_executor-18"><a href="#create_agent_executor-18"><span class="linenos">18</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the ReAct agent executor with the provided tools.&quot;&quot;&quot;</span>
</span><span id="create_agent_executor-19"><a href="#create_agent_executor-19"><span class="linenos">19</span></a>
</span><span id="create_agent_executor-20"><a href="#create_agent_executor-20"><span class="linenos">20</span></a>    <span class="c1"># Initialize Ollama LLM</span>
</span><span id="create_agent_executor-21"><a href="#create_agent_executor-21"><span class="linenos">21</span></a>    <span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOllama</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">LLM_MODEL</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">OLLAMA_URL</span><span class="p">)</span>
</span><span id="create_agent_executor-22"><a href="#create_agent_executor-22"><span class="linenos">22</span></a>
</span><span id="create_agent_executor-23"><a href="#create_agent_executor-23"><span class="linenos">23</span></a>    <span class="c1"># System prompt for the agent</span>
</span><span id="create_agent_executor-24"><a href="#create_agent_executor-24"><span class="linenos">24</span></a>    <span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are a helpful personal assistant with access to various tools for file operations, knowledge management, web search, and GitHub integration.</span>
</span><span id="create_agent_executor-25"><a href="#create_agent_executor-25"><span class="linenos">25</span></a>
</span><span id="create_agent_executor-26"><a href="#create_agent_executor-26"><span class="linenos">26</span></a><span class="s2">You have access to the following tools:</span>
</span><span id="create_agent_executor-27"><a href="#create_agent_executor-27"><span class="linenos">27</span></a><span class="si">{tools}</span>
</span><span id="create_agent_executor-28"><a href="#create_agent_executor-28"><span class="linenos">28</span></a>
</span><span id="create_agent_executor-29"><a href="#create_agent_executor-29"><span class="linenos">29</span></a><span class="s2">Use the following format:</span>
</span><span id="create_agent_executor-30"><a href="#create_agent_executor-30"><span class="linenos">30</span></a>
</span><span id="create_agent_executor-31"><a href="#create_agent_executor-31"><span class="linenos">31</span></a><span class="s2">Question: the input question you must answer</span>
</span><span id="create_agent_executor-32"><a href="#create_agent_executor-32"><span class="linenos">32</span></a><span class="s2">Thought: you should always think about what to do</span>
</span><span id="create_agent_executor-33"><a href="#create_agent_executor-33"><span class="linenos">33</span></a><span class="s2">Action: the action to take, should be one of [</span><span class="si">{tool_names}</span><span class="s2">]</span>
</span><span id="create_agent_executor-34"><a href="#create_agent_executor-34"><span class="linenos">34</span></a><span class="s2">Action Input: the input to the action as valid JSON (e.g., {{&quot;param1&quot;: &quot;value1&quot;, &quot;param2&quot;: &quot;value2&quot;}})</span>
</span><span id="create_agent_executor-35"><a href="#create_agent_executor-35"><span class="linenos">35</span></a><span class="s2">Observation: the result of the action</span>
</span><span id="create_agent_executor-36"><a href="#create_agent_executor-36"><span class="linenos">36</span></a><span class="s2">... (this Thought/Action/Action Input/Observation can repeat N times)</span>
</span><span id="create_agent_executor-37"><a href="#create_agent_executor-37"><span class="linenos">37</span></a><span class="s2">Thought: I now know the final answer</span>
</span><span id="create_agent_executor-38"><a href="#create_agent_executor-38"><span class="linenos">38</span></a><span class="s2">Final Answer: the final answer to the original input question</span>
</span><span id="create_agent_executor-39"><a href="#create_agent_executor-39"><span class="linenos">39</span></a>
</span><span id="create_agent_executor-40"><a href="#create_agent_executor-40"><span class="linenos">40</span></a><span class="s2">IMPORTANT: Action Input must be valid JSON format. For example:</span>
</span><span id="create_agent_executor-41"><a href="#create_agent_executor-41"><span class="linenos">41</span></a><span class="s2">- Correct: {{&quot;file_path&quot;: &quot;~/test.txt&quot;, &quot;content&quot;: &quot;Hello world&quot;}}</span>
</span><span id="create_agent_executor-42"><a href="#create_agent_executor-42"><span class="linenos">42</span></a><span class="s2">- Incorrect: file_path = &#39;~/test.txt&#39;, content = &#39;&#39;&#39;Hello world&#39;&#39;&#39;</span>
</span><span id="create_agent_executor-43"><a href="#create_agent_executor-43"><span class="linenos">43</span></a>
</span><span id="create_agent_executor-44"><a href="#create_agent_executor-44"><span class="linenos">44</span></a><span class="s2">When storing information, always use a relevant topic to categorize it for better retrieval.</span>
</span><span id="create_agent_executor-45"><a href="#create_agent_executor-45"><span class="linenos">45</span></a><span class="s2">When working with files, prefer using absolute paths and be careful about file permissions.</span>
</span><span id="create_agent_executor-46"><a href="#create_agent_executor-46"><span class="linenos">46</span></a><span class="s2">Always store important interactions in memory for future reference. When asked about Github</span>
</span><span id="create_agent_executor-47"><a href="#create_agent_executor-47"><span class="linenos">47</span></a><span class="s2">repositories, use the GitHub tool to search for repositories and provide relevant information.</span>
</span><span id="create_agent_executor-48"><a href="#create_agent_executor-48"><span class="linenos">48</span></a><span class="s2">When asked about the weather, use the weather tool to get current conditions. When asked about</span>
</span><span id="create_agent_executor-49"><a href="#create_agent_executor-49"><span class="linenos">49</span></a><span class="s2">the news, use the news tool to get the latest headlines.</span>
</span><span id="create_agent_executor-50"><a href="#create_agent_executor-50"><span class="linenos">50</span></a>
</span><span id="create_agent_executor-51"><a href="#create_agent_executor-51"><span class="linenos">51</span></a><span class="s2">Begin!</span>
</span><span id="create_agent_executor-52"><a href="#create_agent_executor-52"><span class="linenos">52</span></a>
</span><span id="create_agent_executor-53"><a href="#create_agent_executor-53"><span class="linenos">53</span></a><span class="s2">Question: </span><span class="si">{input}</span>
</span><span id="create_agent_executor-54"><a href="#create_agent_executor-54"><span class="linenos">54</span></a><span class="s2">Thought: </span><span class="si">{agent_scratchpad}</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="create_agent_executor-55"><a href="#create_agent_executor-55"><span class="linenos">55</span></a>
</span><span id="create_agent_executor-56"><a href="#create_agent_executor-56"><span class="linenos">56</span></a>    <span class="c1"># Create prompt template</span>
</span><span id="create_agent_executor-57"><a href="#create_agent_executor-57"><span class="linenos">57</span></a>    <span class="n">prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">)</span>
</span><span id="create_agent_executor-58"><a href="#create_agent_executor-58"><span class="linenos">58</span></a>
</span><span id="create_agent_executor-59"><a href="#create_agent_executor-59"><span class="linenos">59</span></a>    <span class="c1"># Create the ReAct agent</span>
</span><span id="create_agent_executor-60"><a href="#create_agent_executor-60"><span class="linenos">60</span></a>    <span class="n">agent</span> <span class="o">=</span> <span class="n">create_react_agent</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
</span><span id="create_agent_executor-61"><a href="#create_agent_executor-61"><span class="linenos">61</span></a>
</span><span id="create_agent_executor-62"><a href="#create_agent_executor-62"><span class="linenos">62</span></a>    <span class="c1"># Create agent executor</span>
</span><span id="create_agent_executor-63"><a href="#create_agent_executor-63"><span class="linenos">63</span></a>    <span class="n">agent_executor</span> <span class="o">=</span> <span class="n">AgentExecutor</span><span class="p">(</span>
</span><span id="create_agent_executor-64"><a href="#create_agent_executor-64"><span class="linenos">64</span></a>        <span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span>
</span><span id="create_agent_executor-65"><a href="#create_agent_executor-65"><span class="linenos">65</span></a>        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
</span><span id="create_agent_executor-66"><a href="#create_agent_executor-66"><span class="linenos">66</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="create_agent_executor-67"><a href="#create_agent_executor-67"><span class="linenos">67</span></a>        <span class="n">max_iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="create_agent_executor-68"><a href="#create_agent_executor-68"><span class="linenos">68</span></a>        <span class="n">handle_parsing_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="create_agent_executor-69"><a href="#create_agent_executor-69"><span class="linenos">69</span></a>    <span class="p">)</span>
</span><span id="create_agent_executor-70"><a href="#create_agent_executor-70"><span class="linenos">70</span></a>
</span><span id="create_agent_executor-71"><a href="#create_agent_executor-71"><span class="linenos">71</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created agent executor with </span><span class="si">%d</span><span class="s2"> tools&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tools</span><span class="p">))</span>
</span><span id="create_agent_executor-72"><a href="#create_agent_executor-72"><span class="linenos">72</span></a>    <span class="k">return</span> <span class="n">agent_executor</span>
</span></pre></div>


            <div class="docstring"><p>Create the ReAct agent executor with the provided tools.</p>
</div>


                </section>
                <section id="create_simple_personal_agent">
                            <input id="create_simple_personal_agent-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_simple_personal_agent</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">knowledge_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">model_provider</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ollama&#39;</span>,</span><span class="param">	<span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;qwen3:8b&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="create_simple_personal_agent-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_simple_personal_agent"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_simple_personal_agent-1208"><a href="#create_simple_personal_agent-1208"><span class="linenos">1208</span></a><span class="k">def</span><span class="w"> </span><span class="nf">create_simple_personal_agent</span><span class="p">(</span>
</span><span id="create_simple_personal_agent-1209"><a href="#create_simple_personal_agent-1209"><span class="linenos">1209</span></a>    <span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1210"><a href="#create_simple_personal_agent-1210"><span class="linenos">1210</span></a>    <span class="n">knowledge_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1211"><a href="#create_simple_personal_agent-1211"><span class="linenos">1211</span></a>    <span class="n">model_provider</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ollama&quot;</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1212"><a href="#create_simple_personal_agent-1212"><span class="linenos">1212</span></a>    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">LLM_MODEL</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1213"><a href="#create_simple_personal_agent-1213"><span class="linenos">1213</span></a><span class="p">):</span>
</span><span id="create_simple_personal_agent-1214"><a href="#create_simple_personal_agent-1214"><span class="linenos">1214</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a simple personal agent following the working pattern from knowledge_agent_example.py</span>
</span><span id="create_simple_personal_agent-1215"><a href="#create_simple_personal_agent-1215"><span class="linenos">1215</span></a>
</span><span id="create_simple_personal_agent-1216"><a href="#create_simple_personal_agent-1216"><span class="linenos">1216</span></a><span class="sd">    This function creates an agent with knowledge base integration using the simple</span>
</span><span id="create_simple_personal_agent-1217"><a href="#create_simple_personal_agent-1217"><span class="linenos">1217</span></a><span class="sd">    pattern that avoids async initialization complexity.</span>
</span><span id="create_simple_personal_agent-1218"><a href="#create_simple_personal_agent-1218"><span class="linenos">1218</span></a>
</span><span id="create_simple_personal_agent-1219"><a href="#create_simple_personal_agent-1219"><span class="linenos">1219</span></a><span class="sd">    Args:</span>
</span><span id="create_simple_personal_agent-1220"><a href="#create_simple_personal_agent-1220"><span class="linenos">1220</span></a><span class="sd">        storage_dir: Directory for storage files (defaults to PERSAG_ROOT/agno)</span>
</span><span id="create_simple_personal_agent-1221"><a href="#create_simple_personal_agent-1221"><span class="linenos">1221</span></a><span class="sd">        knowledge_dir: Directory containing knowledge files (defaults to PERSAG_ROOT/knowledge)</span>
</span><span id="create_simple_personal_agent-1222"><a href="#create_simple_personal_agent-1222"><span class="linenos">1222</span></a><span class="sd">        model_provider: LLM provider (&#39;ollama&#39; or &#39;openai&#39;)</span>
</span><span id="create_simple_personal_agent-1223"><a href="#create_simple_personal_agent-1223"><span class="linenos">1223</span></a><span class="sd">        model_name: Model name to use</span>
</span><span id="create_simple_personal_agent-1224"><a href="#create_simple_personal_agent-1224"><span class="linenos">1224</span></a>
</span><span id="create_simple_personal_agent-1225"><a href="#create_simple_personal_agent-1225"><span class="linenos">1225</span></a><span class="sd">    Returns:</span>
</span><span id="create_simple_personal_agent-1226"><a href="#create_simple_personal_agent-1226"><span class="linenos">1226</span></a><span class="sd">        Tuple of (Agent instance, knowledge_base) or (Agent, None) if no knowledge</span>
</span><span id="create_simple_personal_agent-1227"><a href="#create_simple_personal_agent-1227"><span class="linenos">1227</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="create_simple_personal_agent-1228"><a href="#create_simple_personal_agent-1228"><span class="linenos">1228</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">agno.knowledge.combined</span><span class="w"> </span><span class="kn">import</span> <span class="n">CombinedKnowledgeBase</span>
</span><span id="create_simple_personal_agent-1229"><a href="#create_simple_personal_agent-1229"><span class="linenos">1229</span></a>
</span><span id="create_simple_personal_agent-1230"><a href="#create_simple_personal_agent-1230"><span class="linenos">1230</span></a>    <span class="c1"># Create knowledge base (synchronous creation)</span>
</span><span id="create_simple_personal_agent-1231"><a href="#create_simple_personal_agent-1231"><span class="linenos">1231</span></a>    <span class="n">knowledge_base</span> <span class="o">=</span> <span class="n">create_combined_knowledge_base</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">,</span> <span class="n">knowledge_dir</span><span class="p">)</span>
</span><span id="create_simple_personal_agent-1232"><a href="#create_simple_personal_agent-1232"><span class="linenos">1232</span></a>
</span><span id="create_simple_personal_agent-1233"><a href="#create_simple_personal_agent-1233"><span class="linenos">1233</span></a>    <span class="c1"># Always use AgentModelManager to ensure consistent model creation</span>
</span><span id="create_simple_personal_agent-1234"><a href="#create_simple_personal_agent-1234"><span class="linenos">1234</span></a>    <span class="n">model_manager</span> <span class="o">=</span> <span class="n">AgentModelManager</span><span class="p">(</span>
</span><span id="create_simple_personal_agent-1235"><a href="#create_simple_personal_agent-1235"><span class="linenos">1235</span></a>        <span class="n">model_provider</span><span class="o">=</span><span class="n">model_provider</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1236"><a href="#create_simple_personal_agent-1236"><span class="linenos">1236</span></a>        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1237"><a href="#create_simple_personal_agent-1237"><span class="linenos">1237</span></a>        <span class="n">ollama_base_url</span><span class="o">=</span><span class="n">OLLAMA_URL</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1238"><a href="#create_simple_personal_agent-1238"><span class="linenos">1238</span></a>        <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1239"><a href="#create_simple_personal_agent-1239"><span class="linenos">1239</span></a>    <span class="p">)</span>
</span><span id="create_simple_personal_agent-1240"><a href="#create_simple_personal_agent-1240"><span class="linenos">1240</span></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">model_manager</span><span class="o">.</span><span class="n">create_model</span><span class="p">()</span>
</span><span id="create_simple_personal_agent-1241"><a href="#create_simple_personal_agent-1241"><span class="linenos">1241</span></a>
</span><span id="create_simple_personal_agent-1242"><a href="#create_simple_personal_agent-1242"><span class="linenos">1242</span></a>    <span class="c1"># Create agent with simple pattern</span>
</span><span id="create_simple_personal_agent-1243"><a href="#create_simple_personal_agent-1243"><span class="linenos">1243</span></a>    <span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="create_simple_personal_agent-1244"><a href="#create_simple_personal_agent-1244"><span class="linenos">1244</span></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Personal AI Agent&quot;</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1245"><a href="#create_simple_personal_agent-1245"><span class="linenos">1245</span></a>        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1246"><a href="#create_simple_personal_agent-1246"><span class="linenos">1246</span></a>        <span class="n">knowledge</span><span class="o">=</span><span class="n">knowledge_base</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1247"><a href="#create_simple_personal_agent-1247"><span class="linenos">1247</span></a>        <span class="n">search_knowledge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Enable automatic knowledge search</span>
</span><span id="create_simple_personal_agent-1248"><a href="#create_simple_personal_agent-1248"><span class="linenos">1248</span></a>        <span class="n">show_tool_calls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Show what tools the agent uses</span>
</span><span id="create_simple_personal_agent-1249"><a href="#create_simple_personal_agent-1249"><span class="linenos">1249</span></a>        <span class="n">markdown</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Format responses in markdown</span>
</span><span id="create_simple_personal_agent-1250"><a href="#create_simple_personal_agent-1250"><span class="linenos">1250</span></a>        <span class="n">instructions</span><span class="o">=</span><span class="p">[</span>
</span><span id="create_simple_personal_agent-1251"><a href="#create_simple_personal_agent-1251"><span class="linenos">1251</span></a>            <span class="s2">&quot;You are a personal AI assistant with access to the user&#39;s knowledge base.&quot;</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1252"><a href="#create_simple_personal_agent-1252"><span class="linenos">1252</span></a>            <span class="s2">&quot;Always search your knowledge base when asked about personal information.&quot;</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1253"><a href="#create_simple_personal_agent-1253"><span class="linenos">1253</span></a>            <span class="s2">&quot;Provide detailed responses based on the information you find.&quot;</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1254"><a href="#create_simple_personal_agent-1254"><span class="linenos">1254</span></a>            <span class="s2">&quot;If you can&#39;t find specific information, say so clearly.&quot;</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1255"><a href="#create_simple_personal_agent-1255"><span class="linenos">1255</span></a>            <span class="s2">&quot;Include relevant details from the knowledge base in your responses.&quot;</span><span class="p">,</span>
</span><span id="create_simple_personal_agent-1256"><a href="#create_simple_personal_agent-1256"><span class="linenos">1256</span></a>        <span class="p">],</span>
</span><span id="create_simple_personal_agent-1257"><a href="#create_simple_personal_agent-1257"><span class="linenos">1257</span></a>    <span class="p">)</span>
</span><span id="create_simple_personal_agent-1258"><a href="#create_simple_personal_agent-1258"><span class="linenos">1258</span></a>
</span><span id="create_simple_personal_agent-1259"><a href="#create_simple_personal_agent-1259"><span class="linenos">1259</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Created simple personal agent&quot;</span><span class="p">)</span>
</span><span id="create_simple_personal_agent-1260"><a href="#create_simple_personal_agent-1260"><span class="linenos">1260</span></a>    <span class="k">if</span> <span class="n">knowledge_base</span><span class="p">:</span>
</span><span id="create_simple_personal_agent-1261"><a href="#create_simple_personal_agent-1261"><span class="linenos">1261</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   Knowledge base: Enabled&quot;</span><span class="p">)</span>
</span><span id="create_simple_personal_agent-1262"><a href="#create_simple_personal_agent-1262"><span class="linenos">1262</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   Search enabled: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">search_knowledge</span><span class="p">)</span>
</span><span id="create_simple_personal_agent-1263"><a href="#create_simple_personal_agent-1263"><span class="linenos">1263</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="create_simple_personal_agent-1264"><a href="#create_simple_personal_agent-1264"><span class="linenos">1264</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   Knowledge base: None (no knowledge files found)&quot;</span><span class="p">)</span>
</span><span id="create_simple_personal_agent-1265"><a href="#create_simple_personal_agent-1265"><span class="linenos">1265</span></a>
</span><span id="create_simple_personal_agent-1266"><a href="#create_simple_personal_agent-1266"><span class="linenos">1266</span></a>    <span class="k">return</span> <span class="n">agent</span><span class="p">,</span> <span class="n">knowledge_base</span>
</span></pre></div>


            <div class="docstring"><p>Create a simple personal agent following the working pattern from knowledge_agent_example.py</p>

<p>This function creates an agent with knowledge base integration using the simple
pattern that avoids async initialization complexity.</p>

<p>Args:
    storage_dir: Directory for storage files (defaults to PERSAG_ROOT/agno)
    knowledge_dir: Directory containing knowledge files (defaults to PERSAG_ROOT/knowledge)
    model_provider: LLM provider ('ollama' or 'openai')
    model_name: Model name to use</p>

<p>Returns:
    Tuple of (Agent instance, knowledge_base) or (Agent, None) if no knowledge</p>
</div>


                </section>
                <section id="load_agent_knowledge">
                            <input id="load_agent_knowledge-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">load_agent_knowledge</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">knowledge_base</span>, </span><span class="param"><span class="n">recreate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="load_agent_knowledge-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#load_agent_knowledge"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="load_agent_knowledge-1269"><a href="#load_agent_knowledge-1269"><span class="linenos">1269</span></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_agent_knowledge</span><span class="p">(</span><span class="n">knowledge_base</span><span class="p">,</span> <span class="n">recreate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="load_agent_knowledge-1270"><a href="#load_agent_knowledge-1270"><span class="linenos">1270</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load knowledge base content asynchronously.</span>
</span><span id="load_agent_knowledge-1271"><a href="#load_agent_knowledge-1271"><span class="linenos">1271</span></a>
</span><span id="load_agent_knowledge-1272"><a href="#load_agent_knowledge-1272"><span class="linenos">1272</span></a><span class="sd">    This should be called after creating the agent to load the knowledge content.</span>
</span><span id="load_agent_knowledge-1273"><a href="#load_agent_knowledge-1273"><span class="linenos">1273</span></a>
</span><span id="load_agent_knowledge-1274"><a href="#load_agent_knowledge-1274"><span class="linenos">1274</span></a><span class="sd">    Args:</span>
</span><span id="load_agent_knowledge-1275"><a href="#load_agent_knowledge-1275"><span class="linenos">1275</span></a><span class="sd">        knowledge_base: Knowledge base instance to load</span>
</span><span id="load_agent_knowledge-1276"><a href="#load_agent_knowledge-1276"><span class="linenos">1276</span></a><span class="sd">        recreate: Whether to recreate the knowledge base from scratch</span>
</span><span id="load_agent_knowledge-1277"><a href="#load_agent_knowledge-1277"><span class="linenos">1277</span></a>
</span><span id="load_agent_knowledge-1278"><a href="#load_agent_knowledge-1278"><span class="linenos">1278</span></a><span class="sd">    Returns:</span>
</span><span id="load_agent_knowledge-1279"><a href="#load_agent_knowledge-1279"><span class="linenos">1279</span></a><span class="sd">        None</span>
</span><span id="load_agent_knowledge-1280"><a href="#load_agent_knowledge-1280"><span class="linenos">1280</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="load_agent_knowledge-1281"><a href="#load_agent_knowledge-1281"><span class="linenos">1281</span></a>    <span class="k">if</span> <span class="n">knowledge_base</span><span class="p">:</span>
</span><span id="load_agent_knowledge-1282"><a href="#load_agent_knowledge-1282"><span class="linenos">1282</span></a>        <span class="k">await</span> <span class="n">load_combined_knowledge_base</span><span class="p">(</span><span class="n">knowledge_base</span><span class="p">,</span> <span class="n">recreate</span><span class="o">=</span><span class="n">recreate</span><span class="p">)</span>
</span><span id="load_agent_knowledge-1283"><a href="#load_agent_knowledge-1283"><span class="linenos">1283</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Knowledge base loaded successfully&quot;</span><span class="p">)</span>
</span><span id="load_agent_knowledge-1284"><a href="#load_agent_knowledge-1284"><span class="linenos">1284</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="load_agent_knowledge-1285"><a href="#load_agent_knowledge-1285"><span class="linenos">1285</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No knowledge base to load&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load knowledge base content asynchronously.</p>

<p>This should be called after creating the agent to load the knowledge content.</p>

<p>Args:
    knowledge_base: Knowledge base instance to load
    recreate: Whether to recreate the knowledge base from scratch</p>

<p>Returns:
    None</p>
</div>


                </section>
                <section id="AgentKnowledgeManager">
                            <input id="AgentKnowledgeManager-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AgentKnowledgeManager</span>:

                <label class="view-source-button" for="AgentKnowledgeManager-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager-23"><a href="#AgentKnowledgeManager-23"><span class="linenos"> 23</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentKnowledgeManager</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-24"><a href="#AgentKnowledgeManager-24"><span class="linenos"> 24</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages knowledge operations including storage, retrieval, and updates.&quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-25"><a href="#AgentKnowledgeManager-25"><span class="linenos"> 25</span></a>    
</span><span id="AgentKnowledgeManager-26"><a href="#AgentKnowledgeManager-26"><span class="linenos"> 26</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="AgentKnowledgeManager-27"><a href="#AgentKnowledgeManager-27"><span class="linenos"> 27</span></a>                 <span class="n">lightrag_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="AgentKnowledgeManager-28"><a href="#AgentKnowledgeManager-28"><span class="linenos"> 28</span></a>                 <span class="n">lightrag_memory_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="AgentKnowledgeManager-29"><a href="#AgentKnowledgeManager-29"><span class="linenos"> 29</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the knowledge manager.</span>
</span><span id="AgentKnowledgeManager-30"><a href="#AgentKnowledgeManager-30"><span class="linenos"> 30</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-31"><a href="#AgentKnowledgeManager-31"><span class="linenos"> 31</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-32"><a href="#AgentKnowledgeManager-32"><span class="linenos"> 32</span></a><span class="sd">            user_id: User identifier for knowledge operations</span>
</span><span id="AgentKnowledgeManager-33"><a href="#AgentKnowledgeManager-33"><span class="linenos"> 33</span></a><span class="sd">            storage_dir: Directory for storage files</span>
</span><span id="AgentKnowledgeManager-34"><a href="#AgentKnowledgeManager-34"><span class="linenos"> 34</span></a><span class="sd">            lightrag_url: Optional URL for LightRAG API</span>
</span><span id="AgentKnowledgeManager-35"><a href="#AgentKnowledgeManager-35"><span class="linenos"> 35</span></a><span class="sd">            lightrag_memory_url: Optional URL for LightRAG Memory API</span>
</span><span id="AgentKnowledgeManager-36"><a href="#AgentKnowledgeManager-36"><span class="linenos"> 36</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-37"><a href="#AgentKnowledgeManager-37"><span class="linenos"> 37</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
</span><span id="AgentKnowledgeManager-38"><a href="#AgentKnowledgeManager-38"><span class="linenos"> 38</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span> <span class="o">=</span> <span class="n">storage_dir</span>
</span><span id="AgentKnowledgeManager-39"><a href="#AgentKnowledgeManager-39"><span class="linenos"> 39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_url</span> <span class="o">=</span> <span class="n">lightrag_url</span>
</span><span id="AgentKnowledgeManager-40"><a href="#AgentKnowledgeManager-40"><span class="linenos"> 40</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span> <span class="o">=</span> <span class="n">lightrag_memory_url</span>
</span><span id="AgentKnowledgeManager-41"><a href="#AgentKnowledgeManager-41"><span class="linenos"> 41</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">_knowledge.json&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-42"><a href="#AgentKnowledgeManager-42"><span class="linenos"> 42</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-43"><a href="#AgentKnowledgeManager-43"><span class="linenos"> 43</span></a>        
</span><span id="AgentKnowledgeManager-44"><a href="#AgentKnowledgeManager-44"><span class="linenos"> 44</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_knowledge_base</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-45"><a href="#AgentKnowledgeManager-45"><span class="linenos"> 45</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the knowledge base from file.</span>
</span><span id="AgentKnowledgeManager-46"><a href="#AgentKnowledgeManager-46"><span class="linenos"> 46</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-47"><a href="#AgentKnowledgeManager-47"><span class="linenos"> 47</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-48"><a href="#AgentKnowledgeManager-48"><span class="linenos"> 48</span></a><span class="sd">            Dict containing the knowledge base</span>
</span><span id="AgentKnowledgeManager-49"><a href="#AgentKnowledgeManager-49"><span class="linenos"> 49</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-50"><a href="#AgentKnowledgeManager-50"><span class="linenos"> 50</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-51"><a href="#AgentKnowledgeManager-51"><span class="linenos"> 51</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base_file</span><span class="p">):</span>
</span><span id="AgentKnowledgeManager-52"><a href="#AgentKnowledgeManager-52"><span class="linenos"> 52</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-53"><a href="#AgentKnowledgeManager-53"><span class="linenos"> 53</span></a>                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-54"><a href="#AgentKnowledgeManager-54"><span class="linenos"> 54</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-55"><a href="#AgentKnowledgeManager-55"><span class="linenos"> 55</span></a>                <span class="c1"># Initialize with empty structure</span>
</span><span id="AgentKnowledgeManager-56"><a href="#AgentKnowledgeManager-56"><span class="linenos"> 56</span></a>                <span class="n">knowledge_base</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-57"><a href="#AgentKnowledgeManager-57"><span class="linenos"> 57</span></a>                    <span class="s2">&quot;facts&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AgentKnowledgeManager-58"><a href="#AgentKnowledgeManager-58"><span class="linenos"> 58</span></a>                    <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="AgentKnowledgeManager-59"><a href="#AgentKnowledgeManager-59"><span class="linenos"> 59</span></a>                    <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="AgentKnowledgeManager-60"><a href="#AgentKnowledgeManager-60"><span class="linenos"> 60</span></a>                    <span class="s2">&quot;relationships&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AgentKnowledgeManager-61"><a href="#AgentKnowledgeManager-61"><span class="linenos"> 61</span></a>                    <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-62"><a href="#AgentKnowledgeManager-62"><span class="linenos"> 62</span></a>                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-63"><a href="#AgentKnowledgeManager-63"><span class="linenos"> 63</span></a>                        <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="kc">None</span>
</span><span id="AgentKnowledgeManager-64"><a href="#AgentKnowledgeManager-64"><span class="linenos"> 64</span></a>                    <span class="p">}</span>
</span><span id="AgentKnowledgeManager-65"><a href="#AgentKnowledgeManager-65"><span class="linenos"> 65</span></a>                <span class="p">}</span>
</span><span id="AgentKnowledgeManager-66"><a href="#AgentKnowledgeManager-66"><span class="linenos"> 66</span></a>                <span class="c1"># Save the initial structure</span>
</span><span id="AgentKnowledgeManager-67"><a href="#AgentKnowledgeManager-67"><span class="linenos"> 67</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">(</span><span class="n">knowledge_base</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-68"><a href="#AgentKnowledgeManager-68"><span class="linenos"> 68</span></a>                <span class="k">return</span> <span class="n">knowledge_base</span>
</span><span id="AgentKnowledgeManager-69"><a href="#AgentKnowledgeManager-69"><span class="linenos"> 69</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-70"><a href="#AgentKnowledgeManager-70"><span class="linenos"> 70</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading knowledge base: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-71"><a href="#AgentKnowledgeManager-71"><span class="linenos"> 71</span></a>            <span class="c1"># Return a default empty structure</span>
</span><span id="AgentKnowledgeManager-72"><a href="#AgentKnowledgeManager-72"><span class="linenos"> 72</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-73"><a href="#AgentKnowledgeManager-73"><span class="linenos"> 73</span></a>                <span class="s2">&quot;facts&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AgentKnowledgeManager-74"><a href="#AgentKnowledgeManager-74"><span class="linenos"> 74</span></a>                <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="AgentKnowledgeManager-75"><a href="#AgentKnowledgeManager-75"><span class="linenos"> 75</span></a>                <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="AgentKnowledgeManager-76"><a href="#AgentKnowledgeManager-76"><span class="linenos"> 76</span></a>                <span class="s2">&quot;relationships&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AgentKnowledgeManager-77"><a href="#AgentKnowledgeManager-77"><span class="linenos"> 77</span></a>                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-78"><a href="#AgentKnowledgeManager-78"><span class="linenos"> 78</span></a>                    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-79"><a href="#AgentKnowledgeManager-79"><span class="linenos"> 79</span></a>                    <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="kc">None</span>
</span><span id="AgentKnowledgeManager-80"><a href="#AgentKnowledgeManager-80"><span class="linenos"> 80</span></a>                <span class="p">}</span>
</span><span id="AgentKnowledgeManager-81"><a href="#AgentKnowledgeManager-81"><span class="linenos"> 81</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager-82"><a href="#AgentKnowledgeManager-82"><span class="linenos"> 82</span></a>            
</span><span id="AgentKnowledgeManager-83"><a href="#AgentKnowledgeManager-83"><span class="linenos"> 83</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_save_knowledge_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">knowledge_base</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-84"><a href="#AgentKnowledgeManager-84"><span class="linenos"> 84</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the knowledge base to file.</span>
</span><span id="AgentKnowledgeManager-85"><a href="#AgentKnowledgeManager-85"><span class="linenos"> 85</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-86"><a href="#AgentKnowledgeManager-86"><span class="linenos"> 86</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-87"><a href="#AgentKnowledgeManager-87"><span class="linenos"> 87</span></a><span class="sd">            knowledge_base: Optional knowledge base to save (uses self.knowledge_base if None)</span>
</span><span id="AgentKnowledgeManager-88"><a href="#AgentKnowledgeManager-88"><span class="linenos"> 88</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-89"><a href="#AgentKnowledgeManager-89"><span class="linenos"> 89</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-90"><a href="#AgentKnowledgeManager-90"><span class="linenos"> 90</span></a><span class="sd">            True if save was successful</span>
</span><span id="AgentKnowledgeManager-91"><a href="#AgentKnowledgeManager-91"><span class="linenos"> 91</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-92"><a href="#AgentKnowledgeManager-92"><span class="linenos"> 92</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-93"><a href="#AgentKnowledgeManager-93"><span class="linenos"> 93</span></a>            <span class="n">kb</span> <span class="o">=</span> <span class="n">knowledge_base</span> <span class="k">if</span> <span class="n">knowledge_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span>
</span><span id="AgentKnowledgeManager-94"><a href="#AgentKnowledgeManager-94"><span class="linenos"> 94</span></a>            
</span><span id="AgentKnowledgeManager-95"><a href="#AgentKnowledgeManager-95"><span class="linenos"> 95</span></a>            <span class="c1"># Create directory if it doesn&#39;t exist</span>
</span><span id="AgentKnowledgeManager-96"><a href="#AgentKnowledgeManager-96"><span class="linenos"> 96</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base_file</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-97"><a href="#AgentKnowledgeManager-97"><span class="linenos"> 97</span></a>            
</span><span id="AgentKnowledgeManager-98"><a href="#AgentKnowledgeManager-98"><span class="linenos"> 98</span></a>            <span class="c1"># Update metadata</span>
</span><span id="AgentKnowledgeManager-99"><a href="#AgentKnowledgeManager-99"><span class="linenos"> 99</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="AgentKnowledgeManager-100"><a href="#AgentKnowledgeManager-100"><span class="linenos">100</span></a>            <span class="n">kb</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-101"><a href="#AgentKnowledgeManager-101"><span class="linenos">101</span></a>            
</span><span id="AgentKnowledgeManager-102"><a href="#AgentKnowledgeManager-102"><span class="linenos">102</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-103"><a href="#AgentKnowledgeManager-103"><span class="linenos">103</span></a>                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">kb</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-104"><a href="#AgentKnowledgeManager-104"><span class="linenos">104</span></a>            
</span><span id="AgentKnowledgeManager-105"><a href="#AgentKnowledgeManager-105"><span class="linenos">105</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="AgentKnowledgeManager-106"><a href="#AgentKnowledgeManager-106"><span class="linenos">106</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-107"><a href="#AgentKnowledgeManager-107"><span class="linenos">107</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving knowledge base: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-108"><a href="#AgentKnowledgeManager-108"><span class="linenos">108</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-109"><a href="#AgentKnowledgeManager-109"><span class="linenos">109</span></a>            
</span><span id="AgentKnowledgeManager-110"><a href="#AgentKnowledgeManager-110"><span class="linenos">110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_fact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fact</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-111"><a href="#AgentKnowledgeManager-111"><span class="linenos">111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a fact to the knowledge base.</span>
</span><span id="AgentKnowledgeManager-112"><a href="#AgentKnowledgeManager-112"><span class="linenos">112</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-113"><a href="#AgentKnowledgeManager-113"><span class="linenos">113</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-114"><a href="#AgentKnowledgeManager-114"><span class="linenos">114</span></a><span class="sd">            fact: The fact to add</span>
</span><span id="AgentKnowledgeManager-115"><a href="#AgentKnowledgeManager-115"><span class="linenos">115</span></a><span class="sd">            source: Source of the fact (user, inference, etc.)</span>
</span><span id="AgentKnowledgeManager-116"><a href="#AgentKnowledgeManager-116"><span class="linenos">116</span></a><span class="sd">            confidence: Confidence score (0.0-1.0)</span>
</span><span id="AgentKnowledgeManager-117"><a href="#AgentKnowledgeManager-117"><span class="linenos">117</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-118"><a href="#AgentKnowledgeManager-118"><span class="linenos">118</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-119"><a href="#AgentKnowledgeManager-119"><span class="linenos">119</span></a><span class="sd">            True if fact was added successfully</span>
</span><span id="AgentKnowledgeManager-120"><a href="#AgentKnowledgeManager-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-121"><a href="#AgentKnowledgeManager-121"><span class="linenos">121</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-122"><a href="#AgentKnowledgeManager-122"><span class="linenos">122</span></a>            <span class="c1"># Create a fact object</span>
</span><span id="AgentKnowledgeManager-123"><a href="#AgentKnowledgeManager-123"><span class="linenos">123</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="AgentKnowledgeManager-124"><a href="#AgentKnowledgeManager-124"><span class="linenos">124</span></a>            <span class="n">fact_obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-125"><a href="#AgentKnowledgeManager-125"><span class="linenos">125</span></a>                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">fact</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-126"><a href="#AgentKnowledgeManager-126"><span class="linenos">126</span></a>                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-127"><a href="#AgentKnowledgeManager-127"><span class="linenos">127</span></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-128"><a href="#AgentKnowledgeManager-128"><span class="linenos">128</span></a>                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="AgentKnowledgeManager-129"><a href="#AgentKnowledgeManager-129"><span class="linenos">129</span></a>                <span class="s2">&quot;last_accessed&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-130"><a href="#AgentKnowledgeManager-130"><span class="linenos">130</span></a>                <span class="s2">&quot;access_count&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="AgentKnowledgeManager-131"><a href="#AgentKnowledgeManager-131"><span class="linenos">131</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager-132"><a href="#AgentKnowledgeManager-132"><span class="linenos">132</span></a>            
</span><span id="AgentKnowledgeManager-133"><a href="#AgentKnowledgeManager-133"><span class="linenos">133</span></a>            <span class="c1"># Add to knowledge base</span>
</span><span id="AgentKnowledgeManager-134"><a href="#AgentKnowledgeManager-134"><span class="linenos">134</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;facts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fact_obj</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-135"><a href="#AgentKnowledgeManager-135"><span class="linenos">135</span></a>            
</span><span id="AgentKnowledgeManager-136"><a href="#AgentKnowledgeManager-136"><span class="linenos">136</span></a>            <span class="c1"># Save knowledge base</span>
</span><span id="AgentKnowledgeManager-137"><a href="#AgentKnowledgeManager-137"><span class="linenos">137</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-138"><a href="#AgentKnowledgeManager-138"><span class="linenos">138</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-139"><a href="#AgentKnowledgeManager-139"><span class="linenos">139</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error adding fact: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-140"><a href="#AgentKnowledgeManager-140"><span class="linenos">140</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-141"><a href="#AgentKnowledgeManager-141"><span class="linenos">141</span></a>            
</span><span id="AgentKnowledgeManager-142"><a href="#AgentKnowledgeManager-142"><span class="linenos">142</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_facts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager-143"><a href="#AgentKnowledgeManager-143"><span class="linenos">143</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get facts from the knowledge base with optional filtering.</span>
</span><span id="AgentKnowledgeManager-144"><a href="#AgentKnowledgeManager-144"><span class="linenos">144</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-145"><a href="#AgentKnowledgeManager-145"><span class="linenos">145</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-146"><a href="#AgentKnowledgeManager-146"><span class="linenos">146</span></a><span class="sd">            filter_source: Optional source to filter by</span>
</span><span id="AgentKnowledgeManager-147"><a href="#AgentKnowledgeManager-147"><span class="linenos">147</span></a><span class="sd">            min_confidence: Minimum confidence threshold</span>
</span><span id="AgentKnowledgeManager-148"><a href="#AgentKnowledgeManager-148"><span class="linenos">148</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-149"><a href="#AgentKnowledgeManager-149"><span class="linenos">149</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-150"><a href="#AgentKnowledgeManager-150"><span class="linenos">150</span></a><span class="sd">            List of fact objects</span>
</span><span id="AgentKnowledgeManager-151"><a href="#AgentKnowledgeManager-151"><span class="linenos">151</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-152"><a href="#AgentKnowledgeManager-152"><span class="linenos">152</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-153"><a href="#AgentKnowledgeManager-153"><span class="linenos">153</span></a>            <span class="n">facts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;facts&quot;</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager-154"><a href="#AgentKnowledgeManager-154"><span class="linenos">154</span></a>            
</span><span id="AgentKnowledgeManager-155"><a href="#AgentKnowledgeManager-155"><span class="linenos">155</span></a>            <span class="c1"># Apply filters</span>
</span><span id="AgentKnowledgeManager-156"><a href="#AgentKnowledgeManager-156"><span class="linenos">156</span></a>            <span class="k">if</span> <span class="n">filter_source</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-157"><a href="#AgentKnowledgeManager-157"><span class="linenos">157</span></a>                <span class="n">facts</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">facts</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">filter_source</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager-158"><a href="#AgentKnowledgeManager-158"><span class="linenos">158</span></a>                
</span><span id="AgentKnowledgeManager-159"><a href="#AgentKnowledgeManager-159"><span class="linenos">159</span></a>            <span class="n">facts</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">facts</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_confidence</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager-160"><a href="#AgentKnowledgeManager-160"><span class="linenos">160</span></a>            
</span><span id="AgentKnowledgeManager-161"><a href="#AgentKnowledgeManager-161"><span class="linenos">161</span></a>            <span class="c1"># Update access metadata</span>
</span><span id="AgentKnowledgeManager-162"><a href="#AgentKnowledgeManager-162"><span class="linenos">162</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="AgentKnowledgeManager-163"><a href="#AgentKnowledgeManager-163"><span class="linenos">163</span></a>            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-164"><a href="#AgentKnowledgeManager-164"><span class="linenos">164</span></a>            
</span><span id="AgentKnowledgeManager-165"><a href="#AgentKnowledgeManager-165"><span class="linenos">165</span></a>            <span class="k">for</span> <span class="n">fact</span> <span class="ow">in</span> <span class="n">facts</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-166"><a href="#AgentKnowledgeManager-166"><span class="linenos">166</span></a>                <span class="c1"># Find the original fact in the knowledge base and update it</span>
</span><span id="AgentKnowledgeManager-167"><a href="#AgentKnowledgeManager-167"><span class="linenos">167</span></a>                <span class="k">for</span> <span class="n">kb_fact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;facts&quot;</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager-168"><a href="#AgentKnowledgeManager-168"><span class="linenos">168</span></a>                    <span class="k">if</span> <span class="n">kb_fact</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">fact</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">):</span>
</span><span id="AgentKnowledgeManager-169"><a href="#AgentKnowledgeManager-169"><span class="linenos">169</span></a>                        <span class="n">kb_fact</span><span class="p">[</span><span class="s2">&quot;last_accessed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
</span><span id="AgentKnowledgeManager-170"><a href="#AgentKnowledgeManager-170"><span class="linenos">170</span></a>                        <span class="n">kb_fact</span><span class="p">[</span><span class="s2">&quot;access_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kb_fact</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;access_count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="AgentKnowledgeManager-171"><a href="#AgentKnowledgeManager-171"><span class="linenos">171</span></a>            
</span><span id="AgentKnowledgeManager-172"><a href="#AgentKnowledgeManager-172"><span class="linenos">172</span></a>            <span class="c1"># Save the updated knowledge base</span>
</span><span id="AgentKnowledgeManager-173"><a href="#AgentKnowledgeManager-173"><span class="linenos">173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-174"><a href="#AgentKnowledgeManager-174"><span class="linenos">174</span></a>            
</span><span id="AgentKnowledgeManager-175"><a href="#AgentKnowledgeManager-175"><span class="linenos">175</span></a>            <span class="k">return</span> <span class="n">facts</span>
</span><span id="AgentKnowledgeManager-176"><a href="#AgentKnowledgeManager-176"><span class="linenos">176</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-177"><a href="#AgentKnowledgeManager-177"><span class="linenos">177</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting facts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-178"><a href="#AgentKnowledgeManager-178"><span class="linenos">178</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="AgentKnowledgeManager-179"><a href="#AgentKnowledgeManager-179"><span class="linenos">179</span></a>            
</span><span id="AgentKnowledgeManager-180"><a href="#AgentKnowledgeManager-180"><span class="linenos">180</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_preference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-181"><a href="#AgentKnowledgeManager-181"><span class="linenos">181</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a user preference.</span>
</span><span id="AgentKnowledgeManager-182"><a href="#AgentKnowledgeManager-182"><span class="linenos">182</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-183"><a href="#AgentKnowledgeManager-183"><span class="linenos">183</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-184"><a href="#AgentKnowledgeManager-184"><span class="linenos">184</span></a><span class="sd">            category: Preference category (e.g., &#39;communication&#39;, &#39;interface&#39;)</span>
</span><span id="AgentKnowledgeManager-185"><a href="#AgentKnowledgeManager-185"><span class="linenos">185</span></a><span class="sd">            key: Preference key</span>
</span><span id="AgentKnowledgeManager-186"><a href="#AgentKnowledgeManager-186"><span class="linenos">186</span></a><span class="sd">            value: Preference value</span>
</span><span id="AgentKnowledgeManager-187"><a href="#AgentKnowledgeManager-187"><span class="linenos">187</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-188"><a href="#AgentKnowledgeManager-188"><span class="linenos">188</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-189"><a href="#AgentKnowledgeManager-189"><span class="linenos">189</span></a><span class="sd">            True if preference was set successfully</span>
</span><span id="AgentKnowledgeManager-190"><a href="#AgentKnowledgeManager-190"><span class="linenos">190</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-191"><a href="#AgentKnowledgeManager-191"><span class="linenos">191</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-192"><a href="#AgentKnowledgeManager-192"><span class="linenos">192</span></a>            <span class="c1"># Initialize category if it doesn&#39;t exist</span>
</span><span id="AgentKnowledgeManager-193"><a href="#AgentKnowledgeManager-193"><span class="linenos">193</span></a>            <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager-194"><a href="#AgentKnowledgeManager-194"><span class="linenos">194</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">][</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AgentKnowledgeManager-195"><a href="#AgentKnowledgeManager-195"><span class="linenos">195</span></a>                
</span><span id="AgentKnowledgeManager-196"><a href="#AgentKnowledgeManager-196"><span class="linenos">196</span></a>            <span class="c1"># Set preference</span>
</span><span id="AgentKnowledgeManager-197"><a href="#AgentKnowledgeManager-197"><span class="linenos">197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">][</span><span class="n">category</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="AgentKnowledgeManager-198"><a href="#AgentKnowledgeManager-198"><span class="linenos">198</span></a>            
</span><span id="AgentKnowledgeManager-199"><a href="#AgentKnowledgeManager-199"><span class="linenos">199</span></a>            <span class="c1"># Save knowledge base</span>
</span><span id="AgentKnowledgeManager-200"><a href="#AgentKnowledgeManager-200"><span class="linenos">200</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-201"><a href="#AgentKnowledgeManager-201"><span class="linenos">201</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-202"><a href="#AgentKnowledgeManager-202"><span class="linenos">202</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error setting preference: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-203"><a href="#AgentKnowledgeManager-203"><span class="linenos">203</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-204"><a href="#AgentKnowledgeManager-204"><span class="linenos">204</span></a>            
</span><span id="AgentKnowledgeManager-205"><a href="#AgentKnowledgeManager-205"><span class="linenos">205</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_preference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-206"><a href="#AgentKnowledgeManager-206"><span class="linenos">206</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a user preference.</span>
</span><span id="AgentKnowledgeManager-207"><a href="#AgentKnowledgeManager-207"><span class="linenos">207</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-208"><a href="#AgentKnowledgeManager-208"><span class="linenos">208</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-209"><a href="#AgentKnowledgeManager-209"><span class="linenos">209</span></a><span class="sd">            category: Preference category</span>
</span><span id="AgentKnowledgeManager-210"><a href="#AgentKnowledgeManager-210"><span class="linenos">210</span></a><span class="sd">            key: Preference key</span>
</span><span id="AgentKnowledgeManager-211"><a href="#AgentKnowledgeManager-211"><span class="linenos">211</span></a><span class="sd">            default: Default value if preference doesn&#39;t exist</span>
</span><span id="AgentKnowledgeManager-212"><a href="#AgentKnowledgeManager-212"><span class="linenos">212</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-213"><a href="#AgentKnowledgeManager-213"><span class="linenos">213</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-214"><a href="#AgentKnowledgeManager-214"><span class="linenos">214</span></a><span class="sd">            Preference value or default</span>
</span><span id="AgentKnowledgeManager-215"><a href="#AgentKnowledgeManager-215"><span class="linenos">215</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-216"><a href="#AgentKnowledgeManager-216"><span class="linenos">216</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-217"><a href="#AgentKnowledgeManager-217"><span class="linenos">217</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-218"><a href="#AgentKnowledgeManager-218"><span class="linenos">218</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-219"><a href="#AgentKnowledgeManager-219"><span class="linenos">219</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting preference: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-220"><a href="#AgentKnowledgeManager-220"><span class="linenos">220</span></a>            <span class="k">return</span> <span class="n">default</span>
</span><span id="AgentKnowledgeManager-221"><a href="#AgentKnowledgeManager-221"><span class="linenos">221</span></a>            
</span><span id="AgentKnowledgeManager-222"><a href="#AgentKnowledgeManager-222"><span class="linenos">222</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-223"><a href="#AgentKnowledgeManager-223"><span class="linenos">223</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all preferences, optionally filtered by category.</span>
</span><span id="AgentKnowledgeManager-224"><a href="#AgentKnowledgeManager-224"><span class="linenos">224</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-225"><a href="#AgentKnowledgeManager-225"><span class="linenos">225</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-226"><a href="#AgentKnowledgeManager-226"><span class="linenos">226</span></a><span class="sd">            category: Optional category to filter by</span>
</span><span id="AgentKnowledgeManager-227"><a href="#AgentKnowledgeManager-227"><span class="linenos">227</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-228"><a href="#AgentKnowledgeManager-228"><span class="linenos">228</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-229"><a href="#AgentKnowledgeManager-229"><span class="linenos">229</span></a><span class="sd">            Dictionary of preferences</span>
</span><span id="AgentKnowledgeManager-230"><a href="#AgentKnowledgeManager-230"><span class="linenos">230</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-231"><a href="#AgentKnowledgeManager-231"><span class="linenos">231</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-232"><a href="#AgentKnowledgeManager-232"><span class="linenos">232</span></a>            <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-233"><a href="#AgentKnowledgeManager-233"><span class="linenos">233</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="AgentKnowledgeManager-234"><a href="#AgentKnowledgeManager-234"><span class="linenos">234</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-235"><a href="#AgentKnowledgeManager-235"><span class="linenos">235</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager-236"><a href="#AgentKnowledgeManager-236"><span class="linenos">236</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-237"><a href="#AgentKnowledgeManager-237"><span class="linenos">237</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting all preferences: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-238"><a href="#AgentKnowledgeManager-238"><span class="linenos">238</span></a>            <span class="k">return</span> <span class="p">{}</span>
</span><span id="AgentKnowledgeManager-239"><a href="#AgentKnowledgeManager-239"><span class="linenos">239</span></a>            
</span><span id="AgentKnowledgeManager-240"><a href="#AgentKnowledgeManager-240"><span class="linenos">240</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-241"><a href="#AgentKnowledgeManager-241"><span class="linenos">241</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an entity to the knowledge base.</span>
</span><span id="AgentKnowledgeManager-242"><a href="#AgentKnowledgeManager-242"><span class="linenos">242</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-243"><a href="#AgentKnowledgeManager-243"><span class="linenos">243</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-244"><a href="#AgentKnowledgeManager-244"><span class="linenos">244</span></a><span class="sd">            entity_name: Name of the entity</span>
</span><span id="AgentKnowledgeManager-245"><a href="#AgentKnowledgeManager-245"><span class="linenos">245</span></a><span class="sd">            entity_type: Type of the entity (person, place, thing, etc.)</span>
</span><span id="AgentKnowledgeManager-246"><a href="#AgentKnowledgeManager-246"><span class="linenos">246</span></a><span class="sd">            properties: Optional properties of the entity</span>
</span><span id="AgentKnowledgeManager-247"><a href="#AgentKnowledgeManager-247"><span class="linenos">247</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-248"><a href="#AgentKnowledgeManager-248"><span class="linenos">248</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-249"><a href="#AgentKnowledgeManager-249"><span class="linenos">249</span></a><span class="sd">            True if entity was added successfully</span>
</span><span id="AgentKnowledgeManager-250"><a href="#AgentKnowledgeManager-250"><span class="linenos">250</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-251"><a href="#AgentKnowledgeManager-251"><span class="linenos">251</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-252"><a href="#AgentKnowledgeManager-252"><span class="linenos">252</span></a>            <span class="c1"># Create entity object</span>
</span><span id="AgentKnowledgeManager-253"><a href="#AgentKnowledgeManager-253"><span class="linenos">253</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="AgentKnowledgeManager-254"><a href="#AgentKnowledgeManager-254"><span class="linenos">254</span></a>            <span class="n">entity_obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-255"><a href="#AgentKnowledgeManager-255"><span class="linenos">255</span></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">entity_name</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-256"><a href="#AgentKnowledgeManager-256"><span class="linenos">256</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">entity_type</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-257"><a href="#AgentKnowledgeManager-257"><span class="linenos">257</span></a>                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">properties</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="AgentKnowledgeManager-258"><a href="#AgentKnowledgeManager-258"><span class="linenos">258</span></a>                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="AgentKnowledgeManager-259"><a href="#AgentKnowledgeManager-259"><span class="linenos">259</span></a>                <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-260"><a href="#AgentKnowledgeManager-260"><span class="linenos">260</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager-261"><a href="#AgentKnowledgeManager-261"><span class="linenos">261</span></a>            
</span><span id="AgentKnowledgeManager-262"><a href="#AgentKnowledgeManager-262"><span class="linenos">262</span></a>            <span class="c1"># Add to knowledge base</span>
</span><span id="AgentKnowledgeManager-263"><a href="#AgentKnowledgeManager-263"><span class="linenos">263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">][</span><span class="n">entity_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity_obj</span>
</span><span id="AgentKnowledgeManager-264"><a href="#AgentKnowledgeManager-264"><span class="linenos">264</span></a>            
</span><span id="AgentKnowledgeManager-265"><a href="#AgentKnowledgeManager-265"><span class="linenos">265</span></a>            <span class="c1"># Save knowledge base</span>
</span><span id="AgentKnowledgeManager-266"><a href="#AgentKnowledgeManager-266"><span class="linenos">266</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-267"><a href="#AgentKnowledgeManager-267"><span class="linenos">267</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-268"><a href="#AgentKnowledgeManager-268"><span class="linenos">268</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error adding entity: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-269"><a href="#AgentKnowledgeManager-269"><span class="linenos">269</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-270"><a href="#AgentKnowledgeManager-270"><span class="linenos">270</span></a>            
</span><span id="AgentKnowledgeManager-271"><a href="#AgentKnowledgeManager-271"><span class="linenos">271</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager-272"><a href="#AgentKnowledgeManager-272"><span class="linenos">272</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get an entity from the knowledge base.</span>
</span><span id="AgentKnowledgeManager-273"><a href="#AgentKnowledgeManager-273"><span class="linenos">273</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-274"><a href="#AgentKnowledgeManager-274"><span class="linenos">274</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-275"><a href="#AgentKnowledgeManager-275"><span class="linenos">275</span></a><span class="sd">            entity_name: Name of the entity</span>
</span><span id="AgentKnowledgeManager-276"><a href="#AgentKnowledgeManager-276"><span class="linenos">276</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-277"><a href="#AgentKnowledgeManager-277"><span class="linenos">277</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-278"><a href="#AgentKnowledgeManager-278"><span class="linenos">278</span></a><span class="sd">            Entity object or None if not found</span>
</span><span id="AgentKnowledgeManager-279"><a href="#AgentKnowledgeManager-279"><span class="linenos">279</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-280"><a href="#AgentKnowledgeManager-280"><span class="linenos">280</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-281"><a href="#AgentKnowledgeManager-281"><span class="linenos">281</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entity_name</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-282"><a href="#AgentKnowledgeManager-282"><span class="linenos">282</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-283"><a href="#AgentKnowledgeManager-283"><span class="linenos">283</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting entity: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-284"><a href="#AgentKnowledgeManager-284"><span class="linenos">284</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="AgentKnowledgeManager-285"><a href="#AgentKnowledgeManager-285"><span class="linenos">285</span></a>            
</span><span id="AgentKnowledgeManager-286"><a href="#AgentKnowledgeManager-286"><span class="linenos">286</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-287"><a href="#AgentKnowledgeManager-287"><span class="linenos">287</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update an entity&#39;s properties.</span>
</span><span id="AgentKnowledgeManager-288"><a href="#AgentKnowledgeManager-288"><span class="linenos">288</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-289"><a href="#AgentKnowledgeManager-289"><span class="linenos">289</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-290"><a href="#AgentKnowledgeManager-290"><span class="linenos">290</span></a><span class="sd">            entity_name: Name of the entity</span>
</span><span id="AgentKnowledgeManager-291"><a href="#AgentKnowledgeManager-291"><span class="linenos">291</span></a><span class="sd">            properties: Properties to update</span>
</span><span id="AgentKnowledgeManager-292"><a href="#AgentKnowledgeManager-292"><span class="linenos">292</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-293"><a href="#AgentKnowledgeManager-293"><span class="linenos">293</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-294"><a href="#AgentKnowledgeManager-294"><span class="linenos">294</span></a><span class="sd">            True if entity was updated successfully</span>
</span><span id="AgentKnowledgeManager-295"><a href="#AgentKnowledgeManager-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-296"><a href="#AgentKnowledgeManager-296"><span class="linenos">296</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-297"><a href="#AgentKnowledgeManager-297"><span class="linenos">297</span></a>            <span class="c1"># Check if entity exists</span>
</span><span id="AgentKnowledgeManager-298"><a href="#AgentKnowledgeManager-298"><span class="linenos">298</span></a>            <span class="k">if</span> <span class="n">entity_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager-299"><a href="#AgentKnowledgeManager-299"><span class="linenos">299</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-300"><a href="#AgentKnowledgeManager-300"><span class="linenos">300</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-301"><a href="#AgentKnowledgeManager-301"><span class="linenos">301</span></a>                
</span><span id="AgentKnowledgeManager-302"><a href="#AgentKnowledgeManager-302"><span class="linenos">302</span></a>            <span class="c1"># Update properties</span>
</span><span id="AgentKnowledgeManager-303"><a href="#AgentKnowledgeManager-303"><span class="linenos">303</span></a>            <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">][</span><span class="n">entity_name</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager-304"><a href="#AgentKnowledgeManager-304"><span class="linenos">304</span></a>            <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-305"><a href="#AgentKnowledgeManager-305"><span class="linenos">305</span></a>            
</span><span id="AgentKnowledgeManager-306"><a href="#AgentKnowledgeManager-306"><span class="linenos">306</span></a>            <span class="c1"># Update the last_updated timestamp</span>
</span><span id="AgentKnowledgeManager-307"><a href="#AgentKnowledgeManager-307"><span class="linenos">307</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="AgentKnowledgeManager-308"><a href="#AgentKnowledgeManager-308"><span class="linenos">308</span></a>            <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-309"><a href="#AgentKnowledgeManager-309"><span class="linenos">309</span></a>            
</span><span id="AgentKnowledgeManager-310"><a href="#AgentKnowledgeManager-310"><span class="linenos">310</span></a>            <span class="c1"># Save knowledge base</span>
</span><span id="AgentKnowledgeManager-311"><a href="#AgentKnowledgeManager-311"><span class="linenos">311</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-312"><a href="#AgentKnowledgeManager-312"><span class="linenos">312</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-313"><a href="#AgentKnowledgeManager-313"><span class="linenos">313</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating entity: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-314"><a href="#AgentKnowledgeManager-314"><span class="linenos">314</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-315"><a href="#AgentKnowledgeManager-315"><span class="linenos">315</span></a>            
</span><span id="AgentKnowledgeManager-316"><a href="#AgentKnowledgeManager-316"><span class="linenos">316</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">relation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-317"><a href="#AgentKnowledgeManager-317"><span class="linenos">317</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a relationship between entities.</span>
</span><span id="AgentKnowledgeManager-318"><a href="#AgentKnowledgeManager-318"><span class="linenos">318</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-319"><a href="#AgentKnowledgeManager-319"><span class="linenos">319</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-320"><a href="#AgentKnowledgeManager-320"><span class="linenos">320</span></a><span class="sd">            entity1: First entity name</span>
</span><span id="AgentKnowledgeManager-321"><a href="#AgentKnowledgeManager-321"><span class="linenos">321</span></a><span class="sd">            relation: Relationship type</span>
</span><span id="AgentKnowledgeManager-322"><a href="#AgentKnowledgeManager-322"><span class="linenos">322</span></a><span class="sd">            entity2: Second entity name</span>
</span><span id="AgentKnowledgeManager-323"><a href="#AgentKnowledgeManager-323"><span class="linenos">323</span></a><span class="sd">            properties: Optional properties of the relationship</span>
</span><span id="AgentKnowledgeManager-324"><a href="#AgentKnowledgeManager-324"><span class="linenos">324</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-325"><a href="#AgentKnowledgeManager-325"><span class="linenos">325</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-326"><a href="#AgentKnowledgeManager-326"><span class="linenos">326</span></a><span class="sd">            True if relationship was added successfully</span>
</span><span id="AgentKnowledgeManager-327"><a href="#AgentKnowledgeManager-327"><span class="linenos">327</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-328"><a href="#AgentKnowledgeManager-328"><span class="linenos">328</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-329"><a href="#AgentKnowledgeManager-329"><span class="linenos">329</span></a>            <span class="c1"># Create relationship object</span>
</span><span id="AgentKnowledgeManager-330"><a href="#AgentKnowledgeManager-330"><span class="linenos">330</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="AgentKnowledgeManager-331"><a href="#AgentKnowledgeManager-331"><span class="linenos">331</span></a>            <span class="n">rel_obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-332"><a href="#AgentKnowledgeManager-332"><span class="linenos">332</span></a>                <span class="s2">&quot;entity1&quot;</span><span class="p">:</span> <span class="n">entity1</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-333"><a href="#AgentKnowledgeManager-333"><span class="linenos">333</span></a>                <span class="s2">&quot;relation&quot;</span><span class="p">:</span> <span class="n">relation</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-334"><a href="#AgentKnowledgeManager-334"><span class="linenos">334</span></a>                <span class="s2">&quot;entity2&quot;</span><span class="p">:</span> <span class="n">entity2</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-335"><a href="#AgentKnowledgeManager-335"><span class="linenos">335</span></a>                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">properties</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="AgentKnowledgeManager-336"><a href="#AgentKnowledgeManager-336"><span class="linenos">336</span></a>                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-337"><a href="#AgentKnowledgeManager-337"><span class="linenos">337</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager-338"><a href="#AgentKnowledgeManager-338"><span class="linenos">338</span></a>            
</span><span id="AgentKnowledgeManager-339"><a href="#AgentKnowledgeManager-339"><span class="linenos">339</span></a>            <span class="c1"># Add to knowledge base</span>
</span><span id="AgentKnowledgeManager-340"><a href="#AgentKnowledgeManager-340"><span class="linenos">340</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;relationships&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-341"><a href="#AgentKnowledgeManager-341"><span class="linenos">341</span></a>            
</span><span id="AgentKnowledgeManager-342"><a href="#AgentKnowledgeManager-342"><span class="linenos">342</span></a>            <span class="c1"># Save knowledge base</span>
</span><span id="AgentKnowledgeManager-343"><a href="#AgentKnowledgeManager-343"><span class="linenos">343</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-344"><a href="#AgentKnowledgeManager-344"><span class="linenos">344</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-345"><a href="#AgentKnowledgeManager-345"><span class="linenos">345</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error adding relationship: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-346"><a href="#AgentKnowledgeManager-346"><span class="linenos">346</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-347"><a href="#AgentKnowledgeManager-347"><span class="linenos">347</span></a>            
</span><span id="AgentKnowledgeManager-348"><a href="#AgentKnowledgeManager-348"><span class="linenos">348</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">relation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager-349"><a href="#AgentKnowledgeManager-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get relationships, optionally filtered by entity or relation type.</span>
</span><span id="AgentKnowledgeManager-350"><a href="#AgentKnowledgeManager-350"><span class="linenos">350</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-351"><a href="#AgentKnowledgeManager-351"><span class="linenos">351</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-352"><a href="#AgentKnowledgeManager-352"><span class="linenos">352</span></a><span class="sd">            entity: Optional entity to filter by (either entity1 or entity2)</span>
</span><span id="AgentKnowledgeManager-353"><a href="#AgentKnowledgeManager-353"><span class="linenos">353</span></a><span class="sd">            relation: Optional relation type to filter by</span>
</span><span id="AgentKnowledgeManager-354"><a href="#AgentKnowledgeManager-354"><span class="linenos">354</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-355"><a href="#AgentKnowledgeManager-355"><span class="linenos">355</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-356"><a href="#AgentKnowledgeManager-356"><span class="linenos">356</span></a><span class="sd">            List of relationship objects</span>
</span><span id="AgentKnowledgeManager-357"><a href="#AgentKnowledgeManager-357"><span class="linenos">357</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-358"><a href="#AgentKnowledgeManager-358"><span class="linenos">358</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-359"><a href="#AgentKnowledgeManager-359"><span class="linenos">359</span></a>            <span class="n">relationships</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;relationships&quot;</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager-360"><a href="#AgentKnowledgeManager-360"><span class="linenos">360</span></a>            
</span><span id="AgentKnowledgeManager-361"><a href="#AgentKnowledgeManager-361"><span class="linenos">361</span></a>            <span class="c1"># Apply filters</span>
</span><span id="AgentKnowledgeManager-362"><a href="#AgentKnowledgeManager-362"><span class="linenos">362</span></a>            <span class="k">if</span> <span class="n">entity</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-363"><a href="#AgentKnowledgeManager-363"><span class="linenos">363</span></a>                <span class="n">relationships</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentKnowledgeManager-364"><a href="#AgentKnowledgeManager-364"><span class="linenos">364</span></a>                    <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relationships</span> 
</span><span id="AgentKnowledgeManager-365"><a href="#AgentKnowledgeManager-365"><span class="linenos">365</span></a>                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entity1&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">entity</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entity2&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">entity</span>
</span><span id="AgentKnowledgeManager-366"><a href="#AgentKnowledgeManager-366"><span class="linenos">366</span></a>                <span class="p">]</span>
</span><span id="AgentKnowledgeManager-367"><a href="#AgentKnowledgeManager-367"><span class="linenos">367</span></a>                
</span><span id="AgentKnowledgeManager-368"><a href="#AgentKnowledgeManager-368"><span class="linenos">368</span></a>            <span class="k">if</span> <span class="n">relation</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-369"><a href="#AgentKnowledgeManager-369"><span class="linenos">369</span></a>                <span class="n">relationships</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relationships</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relation&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">relation</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager-370"><a href="#AgentKnowledgeManager-370"><span class="linenos">370</span></a>                
</span><span id="AgentKnowledgeManager-371"><a href="#AgentKnowledgeManager-371"><span class="linenos">371</span></a>            <span class="k">return</span> <span class="n">relationships</span>
</span><span id="AgentKnowledgeManager-372"><a href="#AgentKnowledgeManager-372"><span class="linenos">372</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-373"><a href="#AgentKnowledgeManager-373"><span class="linenos">373</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting relationships: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-374"><a href="#AgentKnowledgeManager-374"><span class="linenos">374</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="AgentKnowledgeManager-375"><a href="#AgentKnowledgeManager-375"><span class="linenos">375</span></a>            
</span><span id="AgentKnowledgeManager-376"><a href="#AgentKnowledgeManager-376"><span class="linenos">376</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_knowledge_base</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-377"><a href="#AgentKnowledgeManager-377"><span class="linenos">377</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the entire knowledge base.</span>
</span><span id="AgentKnowledgeManager-378"><a href="#AgentKnowledgeManager-378"><span class="linenos">378</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-379"><a href="#AgentKnowledgeManager-379"><span class="linenos">379</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-380"><a href="#AgentKnowledgeManager-380"><span class="linenos">380</span></a><span class="sd">            True if knowledge base was cleared successfully</span>
</span><span id="AgentKnowledgeManager-381"><a href="#AgentKnowledgeManager-381"><span class="linenos">381</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-382"><a href="#AgentKnowledgeManager-382"><span class="linenos">382</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-383"><a href="#AgentKnowledgeManager-383"><span class="linenos">383</span></a>            <span class="c1"># Reset to empty structure</span>
</span><span id="AgentKnowledgeManager-384"><a href="#AgentKnowledgeManager-384"><span class="linenos">384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-385"><a href="#AgentKnowledgeManager-385"><span class="linenos">385</span></a>                <span class="s2">&quot;facts&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AgentKnowledgeManager-386"><a href="#AgentKnowledgeManager-386"><span class="linenos">386</span></a>                <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="AgentKnowledgeManager-387"><a href="#AgentKnowledgeManager-387"><span class="linenos">387</span></a>                <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="AgentKnowledgeManager-388"><a href="#AgentKnowledgeManager-388"><span class="linenos">388</span></a>                <span class="s2">&quot;relationships&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AgentKnowledgeManager-389"><a href="#AgentKnowledgeManager-389"><span class="linenos">389</span></a>                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-390"><a href="#AgentKnowledgeManager-390"><span class="linenos">390</span></a>                    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-391"><a href="#AgentKnowledgeManager-391"><span class="linenos">391</span></a>                    <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="kc">None</span>
</span><span id="AgentKnowledgeManager-392"><a href="#AgentKnowledgeManager-392"><span class="linenos">392</span></a>                <span class="p">}</span>
</span><span id="AgentKnowledgeManager-393"><a href="#AgentKnowledgeManager-393"><span class="linenos">393</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager-394"><a href="#AgentKnowledgeManager-394"><span class="linenos">394</span></a>            
</span><span id="AgentKnowledgeManager-395"><a href="#AgentKnowledgeManager-395"><span class="linenos">395</span></a>            <span class="c1"># Save knowledge base</span>
</span><span id="AgentKnowledgeManager-396"><a href="#AgentKnowledgeManager-396"><span class="linenos">396</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-397"><a href="#AgentKnowledgeManager-397"><span class="linenos">397</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-398"><a href="#AgentKnowledgeManager-398"><span class="linenos">398</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error clearing knowledge base: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-399"><a href="#AgentKnowledgeManager-399"><span class="linenos">399</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-400"><a href="#AgentKnowledgeManager-400"><span class="linenos">400</span></a>            
</span><span id="AgentKnowledgeManager-401"><a href="#AgentKnowledgeManager-401"><span class="linenos">401</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">sync_with_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-402"><a href="#AgentKnowledgeManager-402"><span class="linenos">402</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronize the local knowledge base with the graph database.</span>
</span><span id="AgentKnowledgeManager-403"><a href="#AgentKnowledgeManager-403"><span class="linenos">403</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-404"><a href="#AgentKnowledgeManager-404"><span class="linenos">404</span></a><span class="sd">        This method syncs entities and relationships from the local knowledge base</span>
</span><span id="AgentKnowledgeManager-405"><a href="#AgentKnowledgeManager-405"><span class="linenos">405</span></a><span class="sd">        to the LightRAG graph database.</span>
</span><span id="AgentKnowledgeManager-406"><a href="#AgentKnowledgeManager-406"><span class="linenos">406</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-407"><a href="#AgentKnowledgeManager-407"><span class="linenos">407</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-408"><a href="#AgentKnowledgeManager-408"><span class="linenos">408</span></a><span class="sd">            Status message</span>
</span><span id="AgentKnowledgeManager-409"><a href="#AgentKnowledgeManager-409"><span class="linenos">409</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-410"><a href="#AgentKnowledgeManager-410"><span class="linenos">410</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-411"><a href="#AgentKnowledgeManager-411"><span class="linenos">411</span></a>            <span class="k">return</span> <span class="s2">&quot;Graph sync not available: LightRAG memory URL not configured&quot;</span>
</span><span id="AgentKnowledgeManager-412"><a href="#AgentKnowledgeManager-412"><span class="linenos">412</span></a>            
</span><span id="AgentKnowledgeManager-413"><a href="#AgentKnowledgeManager-413"><span class="linenos">413</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-414"><a href="#AgentKnowledgeManager-414"><span class="linenos">414</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentKnowledgeManager-415"><a href="#AgentKnowledgeManager-415"><span class="linenos">415</span></a>            
</span><span id="AgentKnowledgeManager-416"><a href="#AgentKnowledgeManager-416"><span class="linenos">416</span></a>            <span class="c1"># 1. Sync entities</span>
</span><span id="AgentKnowledgeManager-417"><a href="#AgentKnowledgeManager-417"><span class="linenos">417</span></a>            <span class="k">for</span> <span class="n">entity_name</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AgentKnowledgeManager-418"><a href="#AgentKnowledgeManager-418"><span class="linenos">418</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-419"><a href="#AgentKnowledgeManager-419"><span class="linenos">419</span></a>                    <span class="c1"># Check if entity exists in graph</span>
</span><span id="AgentKnowledgeManager-420"><a href="#AgentKnowledgeManager-420"><span class="linenos">420</span></a>                    <span class="n">entity_exists</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_entity_exists</span><span class="p">(</span><span class="n">entity_name</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-421"><a href="#AgentKnowledgeManager-421"><span class="linenos">421</span></a>                    
</span><span id="AgentKnowledgeManager-422"><a href="#AgentKnowledgeManager-422"><span class="linenos">422</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">entity_exists</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-423"><a href="#AgentKnowledgeManager-423"><span class="linenos">423</span></a>                        <span class="c1"># Create entity in graph</span>
</span><span id="AgentKnowledgeManager-424"><a href="#AgentKnowledgeManager-424"><span class="linenos">424</span></a>                        <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_graph_entity</span><span class="p">(</span>
</span><span id="AgentKnowledgeManager-425"><a href="#AgentKnowledgeManager-425"><span class="linenos">425</span></a>                            <span class="n">entity_name</span><span class="p">,</span> <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager-426"><a href="#AgentKnowledgeManager-426"><span class="linenos">426</span></a>                        <span class="p">)</span>
</span><span id="AgentKnowledgeManager-427"><a href="#AgentKnowledgeManager-427"><span class="linenos">427</span></a>                        
</span><span id="AgentKnowledgeManager-428"><a href="#AgentKnowledgeManager-428"><span class="linenos">428</span></a>                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-429"><a href="#AgentKnowledgeManager-429"><span class="linenos">429</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created entity: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-430"><a href="#AgentKnowledgeManager-430"><span class="linenos">430</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-431"><a href="#AgentKnowledgeManager-431"><span class="linenos">431</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create entity: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-432"><a href="#AgentKnowledgeManager-432"><span class="linenos">432</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-433"><a href="#AgentKnowledgeManager-433"><span class="linenos">433</span></a>                        <span class="c1"># Update entity in graph</span>
</span><span id="AgentKnowledgeManager-434"><a href="#AgentKnowledgeManager-434"><span class="linenos">434</span></a>                        <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_graph_entity</span><span class="p">(</span>
</span><span id="AgentKnowledgeManager-435"><a href="#AgentKnowledgeManager-435"><span class="linenos">435</span></a>                            <span class="n">entity_name</span><span class="p">,</span> <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager-436"><a href="#AgentKnowledgeManager-436"><span class="linenos">436</span></a>                        <span class="p">)</span>
</span><span id="AgentKnowledgeManager-437"><a href="#AgentKnowledgeManager-437"><span class="linenos">437</span></a>                        
</span><span id="AgentKnowledgeManager-438"><a href="#AgentKnowledgeManager-438"><span class="linenos">438</span></a>                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-439"><a href="#AgentKnowledgeManager-439"><span class="linenos">439</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated entity: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-440"><a href="#AgentKnowledgeManager-440"><span class="linenos">440</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-441"><a href="#AgentKnowledgeManager-441"><span class="linenos">441</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update entity: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-442"><a href="#AgentKnowledgeManager-442"><span class="linenos">442</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-443"><a href="#AgentKnowledgeManager-443"><span class="linenos">443</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error syncing entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-444"><a href="#AgentKnowledgeManager-444"><span class="linenos">444</span></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error syncing entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-445"><a href="#AgentKnowledgeManager-445"><span class="linenos">445</span></a>                    
</span><span id="AgentKnowledgeManager-446"><a href="#AgentKnowledgeManager-446"><span class="linenos">446</span></a>            <span class="c1"># 2. Sync relationships</span>
</span><span id="AgentKnowledgeManager-447"><a href="#AgentKnowledgeManager-447"><span class="linenos">447</span></a>            <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;relationships&quot;</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager-448"><a href="#AgentKnowledgeManager-448"><span class="linenos">448</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-449"><a href="#AgentKnowledgeManager-449"><span class="linenos">449</span></a>                    <span class="c1"># Create relationship in graph</span>
</span><span id="AgentKnowledgeManager-450"><a href="#AgentKnowledgeManager-450"><span class="linenos">450</span></a>                    <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_graph_relationship</span><span class="p">(</span>
</span><span id="AgentKnowledgeManager-451"><a href="#AgentKnowledgeManager-451"><span class="linenos">451</span></a>                        <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;entity1&quot;</span><span class="p">],</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;relation&quot;</span><span class="p">],</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;entity2&quot;</span><span class="p">],</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager-452"><a href="#AgentKnowledgeManager-452"><span class="linenos">452</span></a>                    <span class="p">)</span>
</span><span id="AgentKnowledgeManager-453"><a href="#AgentKnowledgeManager-453"><span class="linenos">453</span></a>                    
</span><span id="AgentKnowledgeManager-454"><a href="#AgentKnowledgeManager-454"><span class="linenos">454</span></a>                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-455"><a href="#AgentKnowledgeManager-455"><span class="linenos">455</span></a>                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created relationship: </span><span class="si">{</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;entity1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;entity2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-456"><a href="#AgentKnowledgeManager-456"><span class="linenos">456</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-457"><a href="#AgentKnowledgeManager-457"><span class="linenos">457</span></a>                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create relationship: </span><span class="si">{</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;entity1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;entity2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-458"><a href="#AgentKnowledgeManager-458"><span class="linenos">458</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-459"><a href="#AgentKnowledgeManager-459"><span class="linenos">459</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error syncing relationship: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-460"><a href="#AgentKnowledgeManager-460"><span class="linenos">460</span></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error syncing relationship: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-461"><a href="#AgentKnowledgeManager-461"><span class="linenos">461</span></a>                    
</span><span id="AgentKnowledgeManager-462"><a href="#AgentKnowledgeManager-462"><span class="linenos">462</span></a>            <span class="c1"># Return combined results</span>
</span><span id="AgentKnowledgeManager-463"><a href="#AgentKnowledgeManager-463"><span class="linenos">463</span></a>            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-464"><a href="#AgentKnowledgeManager-464"><span class="linenos">464</span></a>            
</span><span id="AgentKnowledgeManager-465"><a href="#AgentKnowledgeManager-465"><span class="linenos">465</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-466"><a href="#AgentKnowledgeManager-466"><span class="linenos">466</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error syncing with graph: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-467"><a href="#AgentKnowledgeManager-467"><span class="linenos">467</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error syncing with graph: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentKnowledgeManager-468"><a href="#AgentKnowledgeManager-468"><span class="linenos">468</span></a>            
</span><span id="AgentKnowledgeManager-469"><a href="#AgentKnowledgeManager-469"><span class="linenos">469</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_entity_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-470"><a href="#AgentKnowledgeManager-470"><span class="linenos">470</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if entity exists in the graph.</span>
</span><span id="AgentKnowledgeManager-471"><a href="#AgentKnowledgeManager-471"><span class="linenos">471</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-472"><a href="#AgentKnowledgeManager-472"><span class="linenos">472</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-473"><a href="#AgentKnowledgeManager-473"><span class="linenos">473</span></a><span class="sd">            entity_name: Name of the entity</span>
</span><span id="AgentKnowledgeManager-474"><a href="#AgentKnowledgeManager-474"><span class="linenos">474</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-475"><a href="#AgentKnowledgeManager-475"><span class="linenos">475</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-476"><a href="#AgentKnowledgeManager-476"><span class="linenos">476</span></a><span class="sd">            True if entity exists</span>
</span><span id="AgentKnowledgeManager-477"><a href="#AgentKnowledgeManager-477"><span class="linenos">477</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-478"><a href="#AgentKnowledgeManager-478"><span class="linenos">478</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-479"><a href="#AgentKnowledgeManager-479"><span class="linenos">479</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/entity/exists&quot;</span>
</span><span id="AgentKnowledgeManager-480"><a href="#AgentKnowledgeManager-480"><span class="linenos">480</span></a>            
</span><span id="AgentKnowledgeManager-481"><a href="#AgentKnowledgeManager-481"><span class="linenos">481</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-482"><a href="#AgentKnowledgeManager-482"><span class="linenos">482</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;entity_name&quot;</span><span class="p">:</span> <span class="n">entity_name</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-483"><a href="#AgentKnowledgeManager-483"><span class="linenos">483</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-484"><a href="#AgentKnowledgeManager-484"><span class="linenos">484</span></a>                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-485"><a href="#AgentKnowledgeManager-485"><span class="linenos">485</span></a>                        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exists&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-486"><a href="#AgentKnowledgeManager-486"><span class="linenos">486</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-487"><a href="#AgentKnowledgeManager-487"><span class="linenos">487</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to check entity existence: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-488"><a href="#AgentKnowledgeManager-488"><span class="linenos">488</span></a>                        <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-489"><a href="#AgentKnowledgeManager-489"><span class="linenos">489</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-490"><a href="#AgentKnowledgeManager-490"><span class="linenos">490</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking entity existence: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-491"><a href="#AgentKnowledgeManager-491"><span class="linenos">491</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-492"><a href="#AgentKnowledgeManager-492"><span class="linenos">492</span></a>            
</span><span id="AgentKnowledgeManager-493"><a href="#AgentKnowledgeManager-493"><span class="linenos">493</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_create_graph_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-494"><a href="#AgentKnowledgeManager-494"><span class="linenos">494</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an entity in the graph.</span>
</span><span id="AgentKnowledgeManager-495"><a href="#AgentKnowledgeManager-495"><span class="linenos">495</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-496"><a href="#AgentKnowledgeManager-496"><span class="linenos">496</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-497"><a href="#AgentKnowledgeManager-497"><span class="linenos">497</span></a><span class="sd">            entity_name: Name of the entity</span>
</span><span id="AgentKnowledgeManager-498"><a href="#AgentKnowledgeManager-498"><span class="linenos">498</span></a><span class="sd">            entity_type: Type of the entity</span>
</span><span id="AgentKnowledgeManager-499"><a href="#AgentKnowledgeManager-499"><span class="linenos">499</span></a><span class="sd">            properties: Properties of the entity</span>
</span><span id="AgentKnowledgeManager-500"><a href="#AgentKnowledgeManager-500"><span class="linenos">500</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-501"><a href="#AgentKnowledgeManager-501"><span class="linenos">501</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-502"><a href="#AgentKnowledgeManager-502"><span class="linenos">502</span></a><span class="sd">            True if entity was created successfully</span>
</span><span id="AgentKnowledgeManager-503"><a href="#AgentKnowledgeManager-503"><span class="linenos">503</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-504"><a href="#AgentKnowledgeManager-504"><span class="linenos">504</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-505"><a href="#AgentKnowledgeManager-505"><span class="linenos">505</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/entity/create&quot;</span>
</span><span id="AgentKnowledgeManager-506"><a href="#AgentKnowledgeManager-506"><span class="linenos">506</span></a>            
</span><span id="AgentKnowledgeManager-507"><a href="#AgentKnowledgeManager-507"><span class="linenos">507</span></a>            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-508"><a href="#AgentKnowledgeManager-508"><span class="linenos">508</span></a>                <span class="s2">&quot;entity_name&quot;</span><span class="p">:</span> <span class="n">entity_name</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-509"><a href="#AgentKnowledgeManager-509"><span class="linenos">509</span></a>                <span class="s2">&quot;entity_type&quot;</span><span class="p">:</span> <span class="n">entity_type</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-510"><a href="#AgentKnowledgeManager-510"><span class="linenos">510</span></a>                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">properties</span>
</span><span id="AgentKnowledgeManager-511"><a href="#AgentKnowledgeManager-511"><span class="linenos">511</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager-512"><a href="#AgentKnowledgeManager-512"><span class="linenos">512</span></a>            
</span><span id="AgentKnowledgeManager-513"><a href="#AgentKnowledgeManager-513"><span class="linenos">513</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-514"><a href="#AgentKnowledgeManager-514"><span class="linenos">514</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-515"><a href="#AgentKnowledgeManager-515"><span class="linenos">515</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager-516"><a href="#AgentKnowledgeManager-516"><span class="linenos">516</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created entity in graph: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-517"><a href="#AgentKnowledgeManager-517"><span class="linenos">517</span></a>                        <span class="k">return</span> <span class="kc">True</span>
</span><span id="AgentKnowledgeManager-518"><a href="#AgentKnowledgeManager-518"><span class="linenos">518</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-519"><a href="#AgentKnowledgeManager-519"><span class="linenos">519</span></a>                        <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-520"><a href="#AgentKnowledgeManager-520"><span class="linenos">520</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create entity in graph: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-521"><a href="#AgentKnowledgeManager-521"><span class="linenos">521</span></a>                        <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-522"><a href="#AgentKnowledgeManager-522"><span class="linenos">522</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-523"><a href="#AgentKnowledgeManager-523"><span class="linenos">523</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating graph entity: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-524"><a href="#AgentKnowledgeManager-524"><span class="linenos">524</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-525"><a href="#AgentKnowledgeManager-525"><span class="linenos">525</span></a>            
</span><span id="AgentKnowledgeManager-526"><a href="#AgentKnowledgeManager-526"><span class="linenos">526</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_update_graph_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-527"><a href="#AgentKnowledgeManager-527"><span class="linenos">527</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update an entity in the graph.</span>
</span><span id="AgentKnowledgeManager-528"><a href="#AgentKnowledgeManager-528"><span class="linenos">528</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-529"><a href="#AgentKnowledgeManager-529"><span class="linenos">529</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-530"><a href="#AgentKnowledgeManager-530"><span class="linenos">530</span></a><span class="sd">            entity_name: Name of the entity</span>
</span><span id="AgentKnowledgeManager-531"><a href="#AgentKnowledgeManager-531"><span class="linenos">531</span></a><span class="sd">            properties: Properties to update</span>
</span><span id="AgentKnowledgeManager-532"><a href="#AgentKnowledgeManager-532"><span class="linenos">532</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-533"><a href="#AgentKnowledgeManager-533"><span class="linenos">533</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-534"><a href="#AgentKnowledgeManager-534"><span class="linenos">534</span></a><span class="sd">            True if entity was updated successfully</span>
</span><span id="AgentKnowledgeManager-535"><a href="#AgentKnowledgeManager-535"><span class="linenos">535</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-536"><a href="#AgentKnowledgeManager-536"><span class="linenos">536</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-537"><a href="#AgentKnowledgeManager-537"><span class="linenos">537</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/entity/update&quot;</span>
</span><span id="AgentKnowledgeManager-538"><a href="#AgentKnowledgeManager-538"><span class="linenos">538</span></a>            
</span><span id="AgentKnowledgeManager-539"><a href="#AgentKnowledgeManager-539"><span class="linenos">539</span></a>            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-540"><a href="#AgentKnowledgeManager-540"><span class="linenos">540</span></a>                <span class="s2">&quot;entity_name&quot;</span><span class="p">:</span> <span class="n">entity_name</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-541"><a href="#AgentKnowledgeManager-541"><span class="linenos">541</span></a>                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">properties</span>
</span><span id="AgentKnowledgeManager-542"><a href="#AgentKnowledgeManager-542"><span class="linenos">542</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager-543"><a href="#AgentKnowledgeManager-543"><span class="linenos">543</span></a>            
</span><span id="AgentKnowledgeManager-544"><a href="#AgentKnowledgeManager-544"><span class="linenos">544</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-545"><a href="#AgentKnowledgeManager-545"><span class="linenos">545</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-546"><a href="#AgentKnowledgeManager-546"><span class="linenos">546</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-547"><a href="#AgentKnowledgeManager-547"><span class="linenos">547</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated entity in graph: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-548"><a href="#AgentKnowledgeManager-548"><span class="linenos">548</span></a>                        <span class="k">return</span> <span class="kc">True</span>
</span><span id="AgentKnowledgeManager-549"><a href="#AgentKnowledgeManager-549"><span class="linenos">549</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-550"><a href="#AgentKnowledgeManager-550"><span class="linenos">550</span></a>                        <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-551"><a href="#AgentKnowledgeManager-551"><span class="linenos">551</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update entity in graph: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-552"><a href="#AgentKnowledgeManager-552"><span class="linenos">552</span></a>                        <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-553"><a href="#AgentKnowledgeManager-553"><span class="linenos">553</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-554"><a href="#AgentKnowledgeManager-554"><span class="linenos">554</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating graph entity: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-555"><a href="#AgentKnowledgeManager-555"><span class="linenos">555</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-556"><a href="#AgentKnowledgeManager-556"><span class="linenos">556</span></a>            
</span><span id="AgentKnowledgeManager-557"><a href="#AgentKnowledgeManager-557"><span class="linenos">557</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_create_graph_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">relation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-558"><a href="#AgentKnowledgeManager-558"><span class="linenos">558</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a relationship in the graph.</span>
</span><span id="AgentKnowledgeManager-559"><a href="#AgentKnowledgeManager-559"><span class="linenos">559</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-560"><a href="#AgentKnowledgeManager-560"><span class="linenos">560</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-561"><a href="#AgentKnowledgeManager-561"><span class="linenos">561</span></a><span class="sd">            entity1: First entity name</span>
</span><span id="AgentKnowledgeManager-562"><a href="#AgentKnowledgeManager-562"><span class="linenos">562</span></a><span class="sd">            relation: Relationship type</span>
</span><span id="AgentKnowledgeManager-563"><a href="#AgentKnowledgeManager-563"><span class="linenos">563</span></a><span class="sd">            entity2: Second entity name</span>
</span><span id="AgentKnowledgeManager-564"><a href="#AgentKnowledgeManager-564"><span class="linenos">564</span></a><span class="sd">            properties: Properties of the relationship</span>
</span><span id="AgentKnowledgeManager-565"><a href="#AgentKnowledgeManager-565"><span class="linenos">565</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-566"><a href="#AgentKnowledgeManager-566"><span class="linenos">566</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-567"><a href="#AgentKnowledgeManager-567"><span class="linenos">567</span></a><span class="sd">            True if relationship was created successfully</span>
</span><span id="AgentKnowledgeManager-568"><a href="#AgentKnowledgeManager-568"><span class="linenos">568</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-569"><a href="#AgentKnowledgeManager-569"><span class="linenos">569</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-570"><a href="#AgentKnowledgeManager-570"><span class="linenos">570</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/relationship/create&quot;</span>
</span><span id="AgentKnowledgeManager-571"><a href="#AgentKnowledgeManager-571"><span class="linenos">571</span></a>            
</span><span id="AgentKnowledgeManager-572"><a href="#AgentKnowledgeManager-572"><span class="linenos">572</span></a>            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-573"><a href="#AgentKnowledgeManager-573"><span class="linenos">573</span></a>                <span class="s2">&quot;entity1&quot;</span><span class="p">:</span> <span class="n">entity1</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-574"><a href="#AgentKnowledgeManager-574"><span class="linenos">574</span></a>                <span class="s2">&quot;relation&quot;</span><span class="p">:</span> <span class="n">relation</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-575"><a href="#AgentKnowledgeManager-575"><span class="linenos">575</span></a>                <span class="s2">&quot;entity2&quot;</span><span class="p">:</span> <span class="n">entity2</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager-576"><a href="#AgentKnowledgeManager-576"><span class="linenos">576</span></a>                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">properties</span>
</span><span id="AgentKnowledgeManager-577"><a href="#AgentKnowledgeManager-577"><span class="linenos">577</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager-578"><a href="#AgentKnowledgeManager-578"><span class="linenos">578</span></a>            
</span><span id="AgentKnowledgeManager-579"><a href="#AgentKnowledgeManager-579"><span class="linenos">579</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-580"><a href="#AgentKnowledgeManager-580"><span class="linenos">580</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-581"><a href="#AgentKnowledgeManager-581"><span class="linenos">581</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager-582"><a href="#AgentKnowledgeManager-582"><span class="linenos">582</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created relationship in graph: </span><span class="si">{</span><span class="n">entity1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">relation</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">entity2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-583"><a href="#AgentKnowledgeManager-583"><span class="linenos">583</span></a>                        <span class="k">return</span> <span class="kc">True</span>
</span><span id="AgentKnowledgeManager-584"><a href="#AgentKnowledgeManager-584"><span class="linenos">584</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-585"><a href="#AgentKnowledgeManager-585"><span class="linenos">585</span></a>                        <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-586"><a href="#AgentKnowledgeManager-586"><span class="linenos">586</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create relationship in graph: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-587"><a href="#AgentKnowledgeManager-587"><span class="linenos">587</span></a>                        <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-588"><a href="#AgentKnowledgeManager-588"><span class="linenos">588</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-589"><a href="#AgentKnowledgeManager-589"><span class="linenos">589</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating graph relationship: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-590"><a href="#AgentKnowledgeManager-590"><span class="linenos">590</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager-591"><a href="#AgentKnowledgeManager-591"><span class="linenos">591</span></a>            
</span><span id="AgentKnowledgeManager-592"><a href="#AgentKnowledgeManager-592"><span class="linenos">592</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-593"><a href="#AgentKnowledgeManager-593"><span class="linenos">593</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query the graph database.</span>
</span><span id="AgentKnowledgeManager-594"><a href="#AgentKnowledgeManager-594"><span class="linenos">594</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager-595"><a href="#AgentKnowledgeManager-595"><span class="linenos">595</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager-596"><a href="#AgentKnowledgeManager-596"><span class="linenos">596</span></a><span class="sd">            query: Cypher query</span>
</span><span id="AgentKnowledgeManager-597"><a href="#AgentKnowledgeManager-597"><span class="linenos">597</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager-598"><a href="#AgentKnowledgeManager-598"><span class="linenos">598</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager-599"><a href="#AgentKnowledgeManager-599"><span class="linenos">599</span></a><span class="sd">            Query results</span>
</span><span id="AgentKnowledgeManager-600"><a href="#AgentKnowledgeManager-600"><span class="linenos">600</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager-601"><a href="#AgentKnowledgeManager-601"><span class="linenos">601</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-602"><a href="#AgentKnowledgeManager-602"><span class="linenos">602</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/query&quot;</span>
</span><span id="AgentKnowledgeManager-603"><a href="#AgentKnowledgeManager-603"><span class="linenos">603</span></a>            
</span><span id="AgentKnowledgeManager-604"><a href="#AgentKnowledgeManager-604"><span class="linenos">604</span></a>            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager-605"><a href="#AgentKnowledgeManager-605"><span class="linenos">605</span></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span>
</span><span id="AgentKnowledgeManager-606"><a href="#AgentKnowledgeManager-606"><span class="linenos">606</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager-607"><a href="#AgentKnowledgeManager-607"><span class="linenos">607</span></a>            
</span><span id="AgentKnowledgeManager-608"><a href="#AgentKnowledgeManager-608"><span class="linenos">608</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-609"><a href="#AgentKnowledgeManager-609"><span class="linenos">609</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-610"><a href="#AgentKnowledgeManager-610"><span class="linenos">610</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-611"><a href="#AgentKnowledgeManager-611"><span class="linenos">611</span></a>                        <span class="k">return</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-612"><a href="#AgentKnowledgeManager-612"><span class="linenos">612</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-613"><a href="#AgentKnowledgeManager-613"><span class="linenos">613</span></a>                        <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager-614"><a href="#AgentKnowledgeManager-614"><span class="linenos">614</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to query graph: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-615"><a href="#AgentKnowledgeManager-615"><span class="linenos">615</span></a>                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_text</span><span class="p">}</span>
</span><span id="AgentKnowledgeManager-616"><a href="#AgentKnowledgeManager-616"><span class="linenos">616</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager-617"><a href="#AgentKnowledgeManager-617"><span class="linenos">617</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying graph: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager-618"><a href="#AgentKnowledgeManager-618"><span class="linenos">618</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</span></pre></div>


            <div class="docstring"><p>Manages knowledge operations including storage, retrieval, and updates.</p>
</div>


                            <div id="AgentKnowledgeManager.__init__" class="classattr">
                                        <input id="AgentKnowledgeManager.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">AgentKnowledgeManager</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">lightrag_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">lightrag_memory_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="AgentKnowledgeManager.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.__init__-26"><a href="#AgentKnowledgeManager.__init__-26"><span class="linenos">26</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="AgentKnowledgeManager.__init__-27"><a href="#AgentKnowledgeManager.__init__-27"><span class="linenos">27</span></a>                 <span class="n">lightrag_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="AgentKnowledgeManager.__init__-28"><a href="#AgentKnowledgeManager.__init__-28"><span class="linenos">28</span></a>                 <span class="n">lightrag_memory_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="AgentKnowledgeManager.__init__-29"><a href="#AgentKnowledgeManager.__init__-29"><span class="linenos">29</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the knowledge manager.</span>
</span><span id="AgentKnowledgeManager.__init__-30"><a href="#AgentKnowledgeManager.__init__-30"><span class="linenos">30</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.__init__-31"><a href="#AgentKnowledgeManager.__init__-31"><span class="linenos">31</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager.__init__-32"><a href="#AgentKnowledgeManager.__init__-32"><span class="linenos">32</span></a><span class="sd">            user_id: User identifier for knowledge operations</span>
</span><span id="AgentKnowledgeManager.__init__-33"><a href="#AgentKnowledgeManager.__init__-33"><span class="linenos">33</span></a><span class="sd">            storage_dir: Directory for storage files</span>
</span><span id="AgentKnowledgeManager.__init__-34"><a href="#AgentKnowledgeManager.__init__-34"><span class="linenos">34</span></a><span class="sd">            lightrag_url: Optional URL for LightRAG API</span>
</span><span id="AgentKnowledgeManager.__init__-35"><a href="#AgentKnowledgeManager.__init__-35"><span class="linenos">35</span></a><span class="sd">            lightrag_memory_url: Optional URL for LightRAG Memory API</span>
</span><span id="AgentKnowledgeManager.__init__-36"><a href="#AgentKnowledgeManager.__init__-36"><span class="linenos">36</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.__init__-37"><a href="#AgentKnowledgeManager.__init__-37"><span class="linenos">37</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
</span><span id="AgentKnowledgeManager.__init__-38"><a href="#AgentKnowledgeManager.__init__-38"><span class="linenos">38</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span> <span class="o">=</span> <span class="n">storage_dir</span>
</span><span id="AgentKnowledgeManager.__init__-39"><a href="#AgentKnowledgeManager.__init__-39"><span class="linenos">39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_url</span> <span class="o">=</span> <span class="n">lightrag_url</span>
</span><span id="AgentKnowledgeManager.__init__-40"><a href="#AgentKnowledgeManager.__init__-40"><span class="linenos">40</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span> <span class="o">=</span> <span class="n">lightrag_memory_url</span>
</span><span id="AgentKnowledgeManager.__init__-41"><a href="#AgentKnowledgeManager.__init__-41"><span class="linenos">41</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">_knowledge.json&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.__init__-42"><a href="#AgentKnowledgeManager.__init__-42"><span class="linenos">42</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_knowledge_base</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the knowledge manager.</p>

<p>Args:
    user_id: User identifier for knowledge operations
    storage_dir: Directory for storage files
    lightrag_url: Optional URL for LightRAG API
    lightrag_memory_url: Optional URL for LightRAG Memory API</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.user_id" class="classattr">
                                <div class="attr variable">
            <span class="name">user_id</span>

        
    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.user_id"></a>
    
    

                            </div>
                            <div id="AgentKnowledgeManager.storage_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">storage_dir</span>

        
    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.storage_dir"></a>
    
    

                            </div>
                            <div id="AgentKnowledgeManager.lightrag_url" class="classattr">
                                <div class="attr variable">
            <span class="name">lightrag_url</span>

        
    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.lightrag_url"></a>
    
    

                            </div>
                            <div id="AgentKnowledgeManager.lightrag_memory_url" class="classattr">
                                <div class="attr variable">
            <span class="name">lightrag_memory_url</span>

        
    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.lightrag_memory_url"></a>
    
    

                            </div>
                            <div id="AgentKnowledgeManager.knowledge_base_file" class="classattr">
                                <div class="attr variable">
            <span class="name">knowledge_base_file</span>

        
    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.knowledge_base_file"></a>
    
    

                            </div>
                            <div id="AgentKnowledgeManager.knowledge_base" class="classattr">
                                <div class="attr variable">
            <span class="name">knowledge_base</span>

        
    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.knowledge_base"></a>
    
    

                            </div>
                            <div id="AgentKnowledgeManager.add_fact" class="classattr">
                                        <input id="AgentKnowledgeManager.add_fact-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_fact</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fact</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>, </span><span class="param"><span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.add_fact-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.add_fact"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.add_fact-110"><a href="#AgentKnowledgeManager.add_fact-110"><span class="linenos">110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_fact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fact</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.add_fact-111"><a href="#AgentKnowledgeManager.add_fact-111"><span class="linenos">111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a fact to the knowledge base.</span>
</span><span id="AgentKnowledgeManager.add_fact-112"><a href="#AgentKnowledgeManager.add_fact-112"><span class="linenos">112</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.add_fact-113"><a href="#AgentKnowledgeManager.add_fact-113"><span class="linenos">113</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager.add_fact-114"><a href="#AgentKnowledgeManager.add_fact-114"><span class="linenos">114</span></a><span class="sd">            fact: The fact to add</span>
</span><span id="AgentKnowledgeManager.add_fact-115"><a href="#AgentKnowledgeManager.add_fact-115"><span class="linenos">115</span></a><span class="sd">            source: Source of the fact (user, inference, etc.)</span>
</span><span id="AgentKnowledgeManager.add_fact-116"><a href="#AgentKnowledgeManager.add_fact-116"><span class="linenos">116</span></a><span class="sd">            confidence: Confidence score (0.0-1.0)</span>
</span><span id="AgentKnowledgeManager.add_fact-117"><a href="#AgentKnowledgeManager.add_fact-117"><span class="linenos">117</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager.add_fact-118"><a href="#AgentKnowledgeManager.add_fact-118"><span class="linenos">118</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.add_fact-119"><a href="#AgentKnowledgeManager.add_fact-119"><span class="linenos">119</span></a><span class="sd">            True if fact was added successfully</span>
</span><span id="AgentKnowledgeManager.add_fact-120"><a href="#AgentKnowledgeManager.add_fact-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.add_fact-121"><a href="#AgentKnowledgeManager.add_fact-121"><span class="linenos">121</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.add_fact-122"><a href="#AgentKnowledgeManager.add_fact-122"><span class="linenos">122</span></a>            <span class="c1"># Create a fact object</span>
</span><span id="AgentKnowledgeManager.add_fact-123"><a href="#AgentKnowledgeManager.add_fact-123"><span class="linenos">123</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="AgentKnowledgeManager.add_fact-124"><a href="#AgentKnowledgeManager.add_fact-124"><span class="linenos">124</span></a>            <span class="n">fact_obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager.add_fact-125"><a href="#AgentKnowledgeManager.add_fact-125"><span class="linenos">125</span></a>                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">fact</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager.add_fact-126"><a href="#AgentKnowledgeManager.add_fact-126"><span class="linenos">126</span></a>                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager.add_fact-127"><a href="#AgentKnowledgeManager.add_fact-127"><span class="linenos">127</span></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager.add_fact-128"><a href="#AgentKnowledgeManager.add_fact-128"><span class="linenos">128</span></a>                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="AgentKnowledgeManager.add_fact-129"><a href="#AgentKnowledgeManager.add_fact-129"><span class="linenos">129</span></a>                <span class="s2">&quot;last_accessed&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager.add_fact-130"><a href="#AgentKnowledgeManager.add_fact-130"><span class="linenos">130</span></a>                <span class="s2">&quot;access_count&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="AgentKnowledgeManager.add_fact-131"><a href="#AgentKnowledgeManager.add_fact-131"><span class="linenos">131</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager.add_fact-132"><a href="#AgentKnowledgeManager.add_fact-132"><span class="linenos">132</span></a>            
</span><span id="AgentKnowledgeManager.add_fact-133"><a href="#AgentKnowledgeManager.add_fact-133"><span class="linenos">133</span></a>            <span class="c1"># Add to knowledge base</span>
</span><span id="AgentKnowledgeManager.add_fact-134"><a href="#AgentKnowledgeManager.add_fact-134"><span class="linenos">134</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;facts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fact_obj</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.add_fact-135"><a href="#AgentKnowledgeManager.add_fact-135"><span class="linenos">135</span></a>            
</span><span id="AgentKnowledgeManager.add_fact-136"><a href="#AgentKnowledgeManager.add_fact-136"><span class="linenos">136</span></a>            <span class="c1"># Save knowledge base</span>
</span><span id="AgentKnowledgeManager.add_fact-137"><a href="#AgentKnowledgeManager.add_fact-137"><span class="linenos">137</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.add_fact-138"><a href="#AgentKnowledgeManager.add_fact-138"><span class="linenos">138</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.add_fact-139"><a href="#AgentKnowledgeManager.add_fact-139"><span class="linenos">139</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error adding fact: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.add_fact-140"><a href="#AgentKnowledgeManager.add_fact-140"><span class="linenos">140</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Add a fact to the knowledge base.</p>

<p>Args:
    fact: The fact to add
    source: Source of the fact (user, inference, etc.)
    confidence: Confidence score (0.0-1.0)</p>

<p>Returns:
    True if fact was added successfully</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.get_facts" class="classattr">
                                        <input id="AgentKnowledgeManager.get_facts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_facts</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">filter_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">min_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.get_facts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.get_facts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.get_facts-142"><a href="#AgentKnowledgeManager.get_facts-142"><span class="linenos">142</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_facts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager.get_facts-143"><a href="#AgentKnowledgeManager.get_facts-143"><span class="linenos">143</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get facts from the knowledge base with optional filtering.</span>
</span><span id="AgentKnowledgeManager.get_facts-144"><a href="#AgentKnowledgeManager.get_facts-144"><span class="linenos">144</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.get_facts-145"><a href="#AgentKnowledgeManager.get_facts-145"><span class="linenos">145</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager.get_facts-146"><a href="#AgentKnowledgeManager.get_facts-146"><span class="linenos">146</span></a><span class="sd">            filter_source: Optional source to filter by</span>
</span><span id="AgentKnowledgeManager.get_facts-147"><a href="#AgentKnowledgeManager.get_facts-147"><span class="linenos">147</span></a><span class="sd">            min_confidence: Minimum confidence threshold</span>
</span><span id="AgentKnowledgeManager.get_facts-148"><a href="#AgentKnowledgeManager.get_facts-148"><span class="linenos">148</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager.get_facts-149"><a href="#AgentKnowledgeManager.get_facts-149"><span class="linenos">149</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.get_facts-150"><a href="#AgentKnowledgeManager.get_facts-150"><span class="linenos">150</span></a><span class="sd">            List of fact objects</span>
</span><span id="AgentKnowledgeManager.get_facts-151"><a href="#AgentKnowledgeManager.get_facts-151"><span class="linenos">151</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.get_facts-152"><a href="#AgentKnowledgeManager.get_facts-152"><span class="linenos">152</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_facts-153"><a href="#AgentKnowledgeManager.get_facts-153"><span class="linenos">153</span></a>            <span class="n">facts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;facts&quot;</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager.get_facts-154"><a href="#AgentKnowledgeManager.get_facts-154"><span class="linenos">154</span></a>            
</span><span id="AgentKnowledgeManager.get_facts-155"><a href="#AgentKnowledgeManager.get_facts-155"><span class="linenos">155</span></a>            <span class="c1"># Apply filters</span>
</span><span id="AgentKnowledgeManager.get_facts-156"><a href="#AgentKnowledgeManager.get_facts-156"><span class="linenos">156</span></a>            <span class="k">if</span> <span class="n">filter_source</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_facts-157"><a href="#AgentKnowledgeManager.get_facts-157"><span class="linenos">157</span></a>                <span class="n">facts</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">facts</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">filter_source</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager.get_facts-158"><a href="#AgentKnowledgeManager.get_facts-158"><span class="linenos">158</span></a>                
</span><span id="AgentKnowledgeManager.get_facts-159"><a href="#AgentKnowledgeManager.get_facts-159"><span class="linenos">159</span></a>            <span class="n">facts</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">facts</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_confidence</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager.get_facts-160"><a href="#AgentKnowledgeManager.get_facts-160"><span class="linenos">160</span></a>            
</span><span id="AgentKnowledgeManager.get_facts-161"><a href="#AgentKnowledgeManager.get_facts-161"><span class="linenos">161</span></a>            <span class="c1"># Update access metadata</span>
</span><span id="AgentKnowledgeManager.get_facts-162"><a href="#AgentKnowledgeManager.get_facts-162"><span class="linenos">162</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="AgentKnowledgeManager.get_facts-163"><a href="#AgentKnowledgeManager.get_facts-163"><span class="linenos">163</span></a>            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.get_facts-164"><a href="#AgentKnowledgeManager.get_facts-164"><span class="linenos">164</span></a>            
</span><span id="AgentKnowledgeManager.get_facts-165"><a href="#AgentKnowledgeManager.get_facts-165"><span class="linenos">165</span></a>            <span class="k">for</span> <span class="n">fact</span> <span class="ow">in</span> <span class="n">facts</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_facts-166"><a href="#AgentKnowledgeManager.get_facts-166"><span class="linenos">166</span></a>                <span class="c1"># Find the original fact in the knowledge base and update it</span>
</span><span id="AgentKnowledgeManager.get_facts-167"><a href="#AgentKnowledgeManager.get_facts-167"><span class="linenos">167</span></a>                <span class="k">for</span> <span class="n">kb_fact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;facts&quot;</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager.get_facts-168"><a href="#AgentKnowledgeManager.get_facts-168"><span class="linenos">168</span></a>                    <span class="k">if</span> <span class="n">kb_fact</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">fact</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">):</span>
</span><span id="AgentKnowledgeManager.get_facts-169"><a href="#AgentKnowledgeManager.get_facts-169"><span class="linenos">169</span></a>                        <span class="n">kb_fact</span><span class="p">[</span><span class="s2">&quot;last_accessed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
</span><span id="AgentKnowledgeManager.get_facts-170"><a href="#AgentKnowledgeManager.get_facts-170"><span class="linenos">170</span></a>                        <span class="n">kb_fact</span><span class="p">[</span><span class="s2">&quot;access_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kb_fact</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;access_count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="AgentKnowledgeManager.get_facts-171"><a href="#AgentKnowledgeManager.get_facts-171"><span class="linenos">171</span></a>            
</span><span id="AgentKnowledgeManager.get_facts-172"><a href="#AgentKnowledgeManager.get_facts-172"><span class="linenos">172</span></a>            <span class="c1"># Save the updated knowledge base</span>
</span><span id="AgentKnowledgeManager.get_facts-173"><a href="#AgentKnowledgeManager.get_facts-173"><span class="linenos">173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.get_facts-174"><a href="#AgentKnowledgeManager.get_facts-174"><span class="linenos">174</span></a>            
</span><span id="AgentKnowledgeManager.get_facts-175"><a href="#AgentKnowledgeManager.get_facts-175"><span class="linenos">175</span></a>            <span class="k">return</span> <span class="n">facts</span>
</span><span id="AgentKnowledgeManager.get_facts-176"><a href="#AgentKnowledgeManager.get_facts-176"><span class="linenos">176</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_facts-177"><a href="#AgentKnowledgeManager.get_facts-177"><span class="linenos">177</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting facts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.get_facts-178"><a href="#AgentKnowledgeManager.get_facts-178"><span class="linenos">178</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Get facts from the knowledge base with optional filtering.</p>

<p>Args:
    filter_source: Optional source to filter by
    min_confidence: Minimum confidence threshold</p>

<p>Returns:
    List of fact objects</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.set_preference" class="classattr">
                                        <input id="AgentKnowledgeManager.set_preference-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_preference</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">category</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">key</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">value</span><span class="p">:</span> <span class="n">Any</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.set_preference-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.set_preference"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.set_preference-180"><a href="#AgentKnowledgeManager.set_preference-180"><span class="linenos">180</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_preference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.set_preference-181"><a href="#AgentKnowledgeManager.set_preference-181"><span class="linenos">181</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a user preference.</span>
</span><span id="AgentKnowledgeManager.set_preference-182"><a href="#AgentKnowledgeManager.set_preference-182"><span class="linenos">182</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.set_preference-183"><a href="#AgentKnowledgeManager.set_preference-183"><span class="linenos">183</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager.set_preference-184"><a href="#AgentKnowledgeManager.set_preference-184"><span class="linenos">184</span></a><span class="sd">            category: Preference category (e.g., &#39;communication&#39;, &#39;interface&#39;)</span>
</span><span id="AgentKnowledgeManager.set_preference-185"><a href="#AgentKnowledgeManager.set_preference-185"><span class="linenos">185</span></a><span class="sd">            key: Preference key</span>
</span><span id="AgentKnowledgeManager.set_preference-186"><a href="#AgentKnowledgeManager.set_preference-186"><span class="linenos">186</span></a><span class="sd">            value: Preference value</span>
</span><span id="AgentKnowledgeManager.set_preference-187"><a href="#AgentKnowledgeManager.set_preference-187"><span class="linenos">187</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager.set_preference-188"><a href="#AgentKnowledgeManager.set_preference-188"><span class="linenos">188</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.set_preference-189"><a href="#AgentKnowledgeManager.set_preference-189"><span class="linenos">189</span></a><span class="sd">            True if preference was set successfully</span>
</span><span id="AgentKnowledgeManager.set_preference-190"><a href="#AgentKnowledgeManager.set_preference-190"><span class="linenos">190</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.set_preference-191"><a href="#AgentKnowledgeManager.set_preference-191"><span class="linenos">191</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.set_preference-192"><a href="#AgentKnowledgeManager.set_preference-192"><span class="linenos">192</span></a>            <span class="c1"># Initialize category if it doesn&#39;t exist</span>
</span><span id="AgentKnowledgeManager.set_preference-193"><a href="#AgentKnowledgeManager.set_preference-193"><span class="linenos">193</span></a>            <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager.set_preference-194"><a href="#AgentKnowledgeManager.set_preference-194"><span class="linenos">194</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">][</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AgentKnowledgeManager.set_preference-195"><a href="#AgentKnowledgeManager.set_preference-195"><span class="linenos">195</span></a>                
</span><span id="AgentKnowledgeManager.set_preference-196"><a href="#AgentKnowledgeManager.set_preference-196"><span class="linenos">196</span></a>            <span class="c1"># Set preference</span>
</span><span id="AgentKnowledgeManager.set_preference-197"><a href="#AgentKnowledgeManager.set_preference-197"><span class="linenos">197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">][</span><span class="n">category</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="AgentKnowledgeManager.set_preference-198"><a href="#AgentKnowledgeManager.set_preference-198"><span class="linenos">198</span></a>            
</span><span id="AgentKnowledgeManager.set_preference-199"><a href="#AgentKnowledgeManager.set_preference-199"><span class="linenos">199</span></a>            <span class="c1"># Save knowledge base</span>
</span><span id="AgentKnowledgeManager.set_preference-200"><a href="#AgentKnowledgeManager.set_preference-200"><span class="linenos">200</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.set_preference-201"><a href="#AgentKnowledgeManager.set_preference-201"><span class="linenos">201</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.set_preference-202"><a href="#AgentKnowledgeManager.set_preference-202"><span class="linenos">202</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error setting preference: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.set_preference-203"><a href="#AgentKnowledgeManager.set_preference-203"><span class="linenos">203</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Set a user preference.</p>

<p>Args:
    category: Preference category (e.g., 'communication', 'interface')
    key: Preference key
    value: Preference value</p>

<p>Returns:
    True if preference was set successfully</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.get_preference" class="classattr">
                                        <input id="AgentKnowledgeManager.get_preference-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_preference</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">category</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">key</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Any</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.get_preference-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.get_preference"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.get_preference-205"><a href="#AgentKnowledgeManager.get_preference-205"><span class="linenos">205</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_preference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_preference-206"><a href="#AgentKnowledgeManager.get_preference-206"><span class="linenos">206</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a user preference.</span>
</span><span id="AgentKnowledgeManager.get_preference-207"><a href="#AgentKnowledgeManager.get_preference-207"><span class="linenos">207</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.get_preference-208"><a href="#AgentKnowledgeManager.get_preference-208"><span class="linenos">208</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager.get_preference-209"><a href="#AgentKnowledgeManager.get_preference-209"><span class="linenos">209</span></a><span class="sd">            category: Preference category</span>
</span><span id="AgentKnowledgeManager.get_preference-210"><a href="#AgentKnowledgeManager.get_preference-210"><span class="linenos">210</span></a><span class="sd">            key: Preference key</span>
</span><span id="AgentKnowledgeManager.get_preference-211"><a href="#AgentKnowledgeManager.get_preference-211"><span class="linenos">211</span></a><span class="sd">            default: Default value if preference doesn&#39;t exist</span>
</span><span id="AgentKnowledgeManager.get_preference-212"><a href="#AgentKnowledgeManager.get_preference-212"><span class="linenos">212</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager.get_preference-213"><a href="#AgentKnowledgeManager.get_preference-213"><span class="linenos">213</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.get_preference-214"><a href="#AgentKnowledgeManager.get_preference-214"><span class="linenos">214</span></a><span class="sd">            Preference value or default</span>
</span><span id="AgentKnowledgeManager.get_preference-215"><a href="#AgentKnowledgeManager.get_preference-215"><span class="linenos">215</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.get_preference-216"><a href="#AgentKnowledgeManager.get_preference-216"><span class="linenos">216</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_preference-217"><a href="#AgentKnowledgeManager.get_preference-217"><span class="linenos">217</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.get_preference-218"><a href="#AgentKnowledgeManager.get_preference-218"><span class="linenos">218</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_preference-219"><a href="#AgentKnowledgeManager.get_preference-219"><span class="linenos">219</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting preference: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.get_preference-220"><a href="#AgentKnowledgeManager.get_preference-220"><span class="linenos">220</span></a>            <span class="k">return</span> <span class="n">default</span>
</span></pre></div>


            <div class="docstring"><p>Get a user preference.</p>

<p>Args:
    category: Preference category
    key: Preference key
    default: Default value if preference doesn't exist</p>

<p>Returns:
    Preference value or default</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.get_all_preferences" class="classattr">
                                        <input id="AgentKnowledgeManager.get_all_preferences-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_all_preferences</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.get_all_preferences-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.get_all_preferences"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.get_all_preferences-222"><a href="#AgentKnowledgeManager.get_all_preferences-222"><span class="linenos">222</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-223"><a href="#AgentKnowledgeManager.get_all_preferences-223"><span class="linenos">223</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all preferences, optionally filtered by category.</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-224"><a href="#AgentKnowledgeManager.get_all_preferences-224"><span class="linenos">224</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.get_all_preferences-225"><a href="#AgentKnowledgeManager.get_all_preferences-225"><span class="linenos">225</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-226"><a href="#AgentKnowledgeManager.get_all_preferences-226"><span class="linenos">226</span></a><span class="sd">            category: Optional category to filter by</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-227"><a href="#AgentKnowledgeManager.get_all_preferences-227"><span class="linenos">227</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager.get_all_preferences-228"><a href="#AgentKnowledgeManager.get_all_preferences-228"><span class="linenos">228</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-229"><a href="#AgentKnowledgeManager.get_all_preferences-229"><span class="linenos">229</span></a><span class="sd">            Dictionary of preferences</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-230"><a href="#AgentKnowledgeManager.get_all_preferences-230"><span class="linenos">230</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-231"><a href="#AgentKnowledgeManager.get_all_preferences-231"><span class="linenos">231</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-232"><a href="#AgentKnowledgeManager.get_all_preferences-232"><span class="linenos">232</span></a>            <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-233"><a href="#AgentKnowledgeManager.get_all_preferences-233"><span class="linenos">233</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-234"><a href="#AgentKnowledgeManager.get_all_preferences-234"><span class="linenos">234</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-235"><a href="#AgentKnowledgeManager.get_all_preferences-235"><span class="linenos">235</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-236"><a href="#AgentKnowledgeManager.get_all_preferences-236"><span class="linenos">236</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-237"><a href="#AgentKnowledgeManager.get_all_preferences-237"><span class="linenos">237</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting all preferences: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.get_all_preferences-238"><a href="#AgentKnowledgeManager.get_all_preferences-238"><span class="linenos">238</span></a>            <span class="k">return</span> <span class="p">{}</span>
</span></pre></div>


            <div class="docstring"><p>Get all preferences, optionally filtered by category.</p>

<p>Args:
    category: Optional category to filter by</p>

<p>Returns:
    Dictionary of preferences</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.add_entity" class="classattr">
                                        <input id="AgentKnowledgeManager.add_entity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_entity</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.add_entity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.add_entity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.add_entity-240"><a href="#AgentKnowledgeManager.add_entity-240"><span class="linenos">240</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.add_entity-241"><a href="#AgentKnowledgeManager.add_entity-241"><span class="linenos">241</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an entity to the knowledge base.</span>
</span><span id="AgentKnowledgeManager.add_entity-242"><a href="#AgentKnowledgeManager.add_entity-242"><span class="linenos">242</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.add_entity-243"><a href="#AgentKnowledgeManager.add_entity-243"><span class="linenos">243</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager.add_entity-244"><a href="#AgentKnowledgeManager.add_entity-244"><span class="linenos">244</span></a><span class="sd">            entity_name: Name of the entity</span>
</span><span id="AgentKnowledgeManager.add_entity-245"><a href="#AgentKnowledgeManager.add_entity-245"><span class="linenos">245</span></a><span class="sd">            entity_type: Type of the entity (person, place, thing, etc.)</span>
</span><span id="AgentKnowledgeManager.add_entity-246"><a href="#AgentKnowledgeManager.add_entity-246"><span class="linenos">246</span></a><span class="sd">            properties: Optional properties of the entity</span>
</span><span id="AgentKnowledgeManager.add_entity-247"><a href="#AgentKnowledgeManager.add_entity-247"><span class="linenos">247</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager.add_entity-248"><a href="#AgentKnowledgeManager.add_entity-248"><span class="linenos">248</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.add_entity-249"><a href="#AgentKnowledgeManager.add_entity-249"><span class="linenos">249</span></a><span class="sd">            True if entity was added successfully</span>
</span><span id="AgentKnowledgeManager.add_entity-250"><a href="#AgentKnowledgeManager.add_entity-250"><span class="linenos">250</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.add_entity-251"><a href="#AgentKnowledgeManager.add_entity-251"><span class="linenos">251</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.add_entity-252"><a href="#AgentKnowledgeManager.add_entity-252"><span class="linenos">252</span></a>            <span class="c1"># Create entity object</span>
</span><span id="AgentKnowledgeManager.add_entity-253"><a href="#AgentKnowledgeManager.add_entity-253"><span class="linenos">253</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="AgentKnowledgeManager.add_entity-254"><a href="#AgentKnowledgeManager.add_entity-254"><span class="linenos">254</span></a>            <span class="n">entity_obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager.add_entity-255"><a href="#AgentKnowledgeManager.add_entity-255"><span class="linenos">255</span></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">entity_name</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager.add_entity-256"><a href="#AgentKnowledgeManager.add_entity-256"><span class="linenos">256</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">entity_type</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager.add_entity-257"><a href="#AgentKnowledgeManager.add_entity-257"><span class="linenos">257</span></a>                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">properties</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="AgentKnowledgeManager.add_entity-258"><a href="#AgentKnowledgeManager.add_entity-258"><span class="linenos">258</span></a>                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="AgentKnowledgeManager.add_entity-259"><a href="#AgentKnowledgeManager.add_entity-259"><span class="linenos">259</span></a>                <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.add_entity-260"><a href="#AgentKnowledgeManager.add_entity-260"><span class="linenos">260</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager.add_entity-261"><a href="#AgentKnowledgeManager.add_entity-261"><span class="linenos">261</span></a>            
</span><span id="AgentKnowledgeManager.add_entity-262"><a href="#AgentKnowledgeManager.add_entity-262"><span class="linenos">262</span></a>            <span class="c1"># Add to knowledge base</span>
</span><span id="AgentKnowledgeManager.add_entity-263"><a href="#AgentKnowledgeManager.add_entity-263"><span class="linenos">263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">][</span><span class="n">entity_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity_obj</span>
</span><span id="AgentKnowledgeManager.add_entity-264"><a href="#AgentKnowledgeManager.add_entity-264"><span class="linenos">264</span></a>            
</span><span id="AgentKnowledgeManager.add_entity-265"><a href="#AgentKnowledgeManager.add_entity-265"><span class="linenos">265</span></a>            <span class="c1"># Save knowledge base</span>
</span><span id="AgentKnowledgeManager.add_entity-266"><a href="#AgentKnowledgeManager.add_entity-266"><span class="linenos">266</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.add_entity-267"><a href="#AgentKnowledgeManager.add_entity-267"><span class="linenos">267</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.add_entity-268"><a href="#AgentKnowledgeManager.add_entity-268"><span class="linenos">268</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error adding entity: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.add_entity-269"><a href="#AgentKnowledgeManager.add_entity-269"><span class="linenos">269</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Add an entity to the knowledge base.</p>

<p>Args:
    entity_name: Name of the entity
    entity_type: Type of the entity (person, place, thing, etc.)
    properties: Optional properties of the entity</p>

<p>Returns:
    True if entity was added successfully</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.get_entity" class="classattr">
                                        <input id="AgentKnowledgeManager.get_entity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_entity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.get_entity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.get_entity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.get_entity-271"><a href="#AgentKnowledgeManager.get_entity-271"><span class="linenos">271</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager.get_entity-272"><a href="#AgentKnowledgeManager.get_entity-272"><span class="linenos">272</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get an entity from the knowledge base.</span>
</span><span id="AgentKnowledgeManager.get_entity-273"><a href="#AgentKnowledgeManager.get_entity-273"><span class="linenos">273</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.get_entity-274"><a href="#AgentKnowledgeManager.get_entity-274"><span class="linenos">274</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager.get_entity-275"><a href="#AgentKnowledgeManager.get_entity-275"><span class="linenos">275</span></a><span class="sd">            entity_name: Name of the entity</span>
</span><span id="AgentKnowledgeManager.get_entity-276"><a href="#AgentKnowledgeManager.get_entity-276"><span class="linenos">276</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager.get_entity-277"><a href="#AgentKnowledgeManager.get_entity-277"><span class="linenos">277</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.get_entity-278"><a href="#AgentKnowledgeManager.get_entity-278"><span class="linenos">278</span></a><span class="sd">            Entity object or None if not found</span>
</span><span id="AgentKnowledgeManager.get_entity-279"><a href="#AgentKnowledgeManager.get_entity-279"><span class="linenos">279</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.get_entity-280"><a href="#AgentKnowledgeManager.get_entity-280"><span class="linenos">280</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_entity-281"><a href="#AgentKnowledgeManager.get_entity-281"><span class="linenos">281</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entity_name</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.get_entity-282"><a href="#AgentKnowledgeManager.get_entity-282"><span class="linenos">282</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_entity-283"><a href="#AgentKnowledgeManager.get_entity-283"><span class="linenos">283</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting entity: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.get_entity-284"><a href="#AgentKnowledgeManager.get_entity-284"><span class="linenos">284</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Get an entity from the knowledge base.</p>

<p>Args:
    entity_name: Name of the entity</p>

<p>Returns:
    Entity object or None if not found</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.update_entity" class="classattr">
                                        <input id="AgentKnowledgeManager.update_entity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_entity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.update_entity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.update_entity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.update_entity-286"><a href="#AgentKnowledgeManager.update_entity-286"><span class="linenos">286</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.update_entity-287"><a href="#AgentKnowledgeManager.update_entity-287"><span class="linenos">287</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update an entity&#39;s properties.</span>
</span><span id="AgentKnowledgeManager.update_entity-288"><a href="#AgentKnowledgeManager.update_entity-288"><span class="linenos">288</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.update_entity-289"><a href="#AgentKnowledgeManager.update_entity-289"><span class="linenos">289</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager.update_entity-290"><a href="#AgentKnowledgeManager.update_entity-290"><span class="linenos">290</span></a><span class="sd">            entity_name: Name of the entity</span>
</span><span id="AgentKnowledgeManager.update_entity-291"><a href="#AgentKnowledgeManager.update_entity-291"><span class="linenos">291</span></a><span class="sd">            properties: Properties to update</span>
</span><span id="AgentKnowledgeManager.update_entity-292"><a href="#AgentKnowledgeManager.update_entity-292"><span class="linenos">292</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager.update_entity-293"><a href="#AgentKnowledgeManager.update_entity-293"><span class="linenos">293</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.update_entity-294"><a href="#AgentKnowledgeManager.update_entity-294"><span class="linenos">294</span></a><span class="sd">            True if entity was updated successfully</span>
</span><span id="AgentKnowledgeManager.update_entity-295"><a href="#AgentKnowledgeManager.update_entity-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.update_entity-296"><a href="#AgentKnowledgeManager.update_entity-296"><span class="linenos">296</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.update_entity-297"><a href="#AgentKnowledgeManager.update_entity-297"><span class="linenos">297</span></a>            <span class="c1"># Check if entity exists</span>
</span><span id="AgentKnowledgeManager.update_entity-298"><a href="#AgentKnowledgeManager.update_entity-298"><span class="linenos">298</span></a>            <span class="k">if</span> <span class="n">entity_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager.update_entity-299"><a href="#AgentKnowledgeManager.update_entity-299"><span class="linenos">299</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.update_entity-300"><a href="#AgentKnowledgeManager.update_entity-300"><span class="linenos">300</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentKnowledgeManager.update_entity-301"><a href="#AgentKnowledgeManager.update_entity-301"><span class="linenos">301</span></a>                
</span><span id="AgentKnowledgeManager.update_entity-302"><a href="#AgentKnowledgeManager.update_entity-302"><span class="linenos">302</span></a>            <span class="c1"># Update properties</span>
</span><span id="AgentKnowledgeManager.update_entity-303"><a href="#AgentKnowledgeManager.update_entity-303"><span class="linenos">303</span></a>            <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">][</span><span class="n">entity_name</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager.update_entity-304"><a href="#AgentKnowledgeManager.update_entity-304"><span class="linenos">304</span></a>            <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.update_entity-305"><a href="#AgentKnowledgeManager.update_entity-305"><span class="linenos">305</span></a>            
</span><span id="AgentKnowledgeManager.update_entity-306"><a href="#AgentKnowledgeManager.update_entity-306"><span class="linenos">306</span></a>            <span class="c1"># Update the last_updated timestamp</span>
</span><span id="AgentKnowledgeManager.update_entity-307"><a href="#AgentKnowledgeManager.update_entity-307"><span class="linenos">307</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="AgentKnowledgeManager.update_entity-308"><a href="#AgentKnowledgeManager.update_entity-308"><span class="linenos">308</span></a>            <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.update_entity-309"><a href="#AgentKnowledgeManager.update_entity-309"><span class="linenos">309</span></a>            
</span><span id="AgentKnowledgeManager.update_entity-310"><a href="#AgentKnowledgeManager.update_entity-310"><span class="linenos">310</span></a>            <span class="c1"># Save knowledge base</span>
</span><span id="AgentKnowledgeManager.update_entity-311"><a href="#AgentKnowledgeManager.update_entity-311"><span class="linenos">311</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.update_entity-312"><a href="#AgentKnowledgeManager.update_entity-312"><span class="linenos">312</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.update_entity-313"><a href="#AgentKnowledgeManager.update_entity-313"><span class="linenos">313</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating entity: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.update_entity-314"><a href="#AgentKnowledgeManager.update_entity-314"><span class="linenos">314</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Update an entity's properties.</p>

<p>Args:
    entity_name: Name of the entity
    properties: Properties to update</p>

<p>Returns:
    True if entity was updated successfully</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.add_relationship" class="classattr">
                                        <input id="AgentKnowledgeManager.add_relationship-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_relationship</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">entity1</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">relation</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">entity2</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.add_relationship-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.add_relationship"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.add_relationship-316"><a href="#AgentKnowledgeManager.add_relationship-316"><span class="linenos">316</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">relation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.add_relationship-317"><a href="#AgentKnowledgeManager.add_relationship-317"><span class="linenos">317</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a relationship between entities.</span>
</span><span id="AgentKnowledgeManager.add_relationship-318"><a href="#AgentKnowledgeManager.add_relationship-318"><span class="linenos">318</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.add_relationship-319"><a href="#AgentKnowledgeManager.add_relationship-319"><span class="linenos">319</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager.add_relationship-320"><a href="#AgentKnowledgeManager.add_relationship-320"><span class="linenos">320</span></a><span class="sd">            entity1: First entity name</span>
</span><span id="AgentKnowledgeManager.add_relationship-321"><a href="#AgentKnowledgeManager.add_relationship-321"><span class="linenos">321</span></a><span class="sd">            relation: Relationship type</span>
</span><span id="AgentKnowledgeManager.add_relationship-322"><a href="#AgentKnowledgeManager.add_relationship-322"><span class="linenos">322</span></a><span class="sd">            entity2: Second entity name</span>
</span><span id="AgentKnowledgeManager.add_relationship-323"><a href="#AgentKnowledgeManager.add_relationship-323"><span class="linenos">323</span></a><span class="sd">            properties: Optional properties of the relationship</span>
</span><span id="AgentKnowledgeManager.add_relationship-324"><a href="#AgentKnowledgeManager.add_relationship-324"><span class="linenos">324</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager.add_relationship-325"><a href="#AgentKnowledgeManager.add_relationship-325"><span class="linenos">325</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.add_relationship-326"><a href="#AgentKnowledgeManager.add_relationship-326"><span class="linenos">326</span></a><span class="sd">            True if relationship was added successfully</span>
</span><span id="AgentKnowledgeManager.add_relationship-327"><a href="#AgentKnowledgeManager.add_relationship-327"><span class="linenos">327</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.add_relationship-328"><a href="#AgentKnowledgeManager.add_relationship-328"><span class="linenos">328</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.add_relationship-329"><a href="#AgentKnowledgeManager.add_relationship-329"><span class="linenos">329</span></a>            <span class="c1"># Create relationship object</span>
</span><span id="AgentKnowledgeManager.add_relationship-330"><a href="#AgentKnowledgeManager.add_relationship-330"><span class="linenos">330</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="AgentKnowledgeManager.add_relationship-331"><a href="#AgentKnowledgeManager.add_relationship-331"><span class="linenos">331</span></a>            <span class="n">rel_obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager.add_relationship-332"><a href="#AgentKnowledgeManager.add_relationship-332"><span class="linenos">332</span></a>                <span class="s2">&quot;entity1&quot;</span><span class="p">:</span> <span class="n">entity1</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager.add_relationship-333"><a href="#AgentKnowledgeManager.add_relationship-333"><span class="linenos">333</span></a>                <span class="s2">&quot;relation&quot;</span><span class="p">:</span> <span class="n">relation</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager.add_relationship-334"><a href="#AgentKnowledgeManager.add_relationship-334"><span class="linenos">334</span></a>                <span class="s2">&quot;entity2&quot;</span><span class="p">:</span> <span class="n">entity2</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager.add_relationship-335"><a href="#AgentKnowledgeManager.add_relationship-335"><span class="linenos">335</span></a>                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">properties</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="AgentKnowledgeManager.add_relationship-336"><a href="#AgentKnowledgeManager.add_relationship-336"><span class="linenos">336</span></a>                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.add_relationship-337"><a href="#AgentKnowledgeManager.add_relationship-337"><span class="linenos">337</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager.add_relationship-338"><a href="#AgentKnowledgeManager.add_relationship-338"><span class="linenos">338</span></a>            
</span><span id="AgentKnowledgeManager.add_relationship-339"><a href="#AgentKnowledgeManager.add_relationship-339"><span class="linenos">339</span></a>            <span class="c1"># Add to knowledge base</span>
</span><span id="AgentKnowledgeManager.add_relationship-340"><a href="#AgentKnowledgeManager.add_relationship-340"><span class="linenos">340</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;relationships&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.add_relationship-341"><a href="#AgentKnowledgeManager.add_relationship-341"><span class="linenos">341</span></a>            
</span><span id="AgentKnowledgeManager.add_relationship-342"><a href="#AgentKnowledgeManager.add_relationship-342"><span class="linenos">342</span></a>            <span class="c1"># Save knowledge base</span>
</span><span id="AgentKnowledgeManager.add_relationship-343"><a href="#AgentKnowledgeManager.add_relationship-343"><span class="linenos">343</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.add_relationship-344"><a href="#AgentKnowledgeManager.add_relationship-344"><span class="linenos">344</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.add_relationship-345"><a href="#AgentKnowledgeManager.add_relationship-345"><span class="linenos">345</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error adding relationship: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.add_relationship-346"><a href="#AgentKnowledgeManager.add_relationship-346"><span class="linenos">346</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Add a relationship between entities.</p>

<p>Args:
    entity1: First entity name
    relation: Relationship type
    entity2: Second entity name
    properties: Optional properties of the relationship</p>

<p>Returns:
    True if relationship was added successfully</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.get_relationships" class="classattr">
                                        <input id="AgentKnowledgeManager.get_relationships-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_relationships</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">entity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">relation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.get_relationships-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.get_relationships"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.get_relationships-348"><a href="#AgentKnowledgeManager.get_relationships-348"><span class="linenos">348</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">relation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager.get_relationships-349"><a href="#AgentKnowledgeManager.get_relationships-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get relationships, optionally filtered by entity or relation type.</span>
</span><span id="AgentKnowledgeManager.get_relationships-350"><a href="#AgentKnowledgeManager.get_relationships-350"><span class="linenos">350</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.get_relationships-351"><a href="#AgentKnowledgeManager.get_relationships-351"><span class="linenos">351</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager.get_relationships-352"><a href="#AgentKnowledgeManager.get_relationships-352"><span class="linenos">352</span></a><span class="sd">            entity: Optional entity to filter by (either entity1 or entity2)</span>
</span><span id="AgentKnowledgeManager.get_relationships-353"><a href="#AgentKnowledgeManager.get_relationships-353"><span class="linenos">353</span></a><span class="sd">            relation: Optional relation type to filter by</span>
</span><span id="AgentKnowledgeManager.get_relationships-354"><a href="#AgentKnowledgeManager.get_relationships-354"><span class="linenos">354</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager.get_relationships-355"><a href="#AgentKnowledgeManager.get_relationships-355"><span class="linenos">355</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.get_relationships-356"><a href="#AgentKnowledgeManager.get_relationships-356"><span class="linenos">356</span></a><span class="sd">            List of relationship objects</span>
</span><span id="AgentKnowledgeManager.get_relationships-357"><a href="#AgentKnowledgeManager.get_relationships-357"><span class="linenos">357</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.get_relationships-358"><a href="#AgentKnowledgeManager.get_relationships-358"><span class="linenos">358</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_relationships-359"><a href="#AgentKnowledgeManager.get_relationships-359"><span class="linenos">359</span></a>            <span class="n">relationships</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;relationships&quot;</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager.get_relationships-360"><a href="#AgentKnowledgeManager.get_relationships-360"><span class="linenos">360</span></a>            
</span><span id="AgentKnowledgeManager.get_relationships-361"><a href="#AgentKnowledgeManager.get_relationships-361"><span class="linenos">361</span></a>            <span class="c1"># Apply filters</span>
</span><span id="AgentKnowledgeManager.get_relationships-362"><a href="#AgentKnowledgeManager.get_relationships-362"><span class="linenos">362</span></a>            <span class="k">if</span> <span class="n">entity</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_relationships-363"><a href="#AgentKnowledgeManager.get_relationships-363"><span class="linenos">363</span></a>                <span class="n">relationships</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentKnowledgeManager.get_relationships-364"><a href="#AgentKnowledgeManager.get_relationships-364"><span class="linenos">364</span></a>                    <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relationships</span> 
</span><span id="AgentKnowledgeManager.get_relationships-365"><a href="#AgentKnowledgeManager.get_relationships-365"><span class="linenos">365</span></a>                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entity1&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">entity</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entity2&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">entity</span>
</span><span id="AgentKnowledgeManager.get_relationships-366"><a href="#AgentKnowledgeManager.get_relationships-366"><span class="linenos">366</span></a>                <span class="p">]</span>
</span><span id="AgentKnowledgeManager.get_relationships-367"><a href="#AgentKnowledgeManager.get_relationships-367"><span class="linenos">367</span></a>                
</span><span id="AgentKnowledgeManager.get_relationships-368"><a href="#AgentKnowledgeManager.get_relationships-368"><span class="linenos">368</span></a>            <span class="k">if</span> <span class="n">relation</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_relationships-369"><a href="#AgentKnowledgeManager.get_relationships-369"><span class="linenos">369</span></a>                <span class="n">relationships</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relationships</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relation&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">relation</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager.get_relationships-370"><a href="#AgentKnowledgeManager.get_relationships-370"><span class="linenos">370</span></a>                
</span><span id="AgentKnowledgeManager.get_relationships-371"><a href="#AgentKnowledgeManager.get_relationships-371"><span class="linenos">371</span></a>            <span class="k">return</span> <span class="n">relationships</span>
</span><span id="AgentKnowledgeManager.get_relationships-372"><a href="#AgentKnowledgeManager.get_relationships-372"><span class="linenos">372</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.get_relationships-373"><a href="#AgentKnowledgeManager.get_relationships-373"><span class="linenos">373</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting relationships: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.get_relationships-374"><a href="#AgentKnowledgeManager.get_relationships-374"><span class="linenos">374</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Get relationships, optionally filtered by entity or relation type.</p>

<p>Args:
    entity: Optional entity to filter by (either entity1 or entity2)
    relation: Optional relation type to filter by</p>

<p>Returns:
    List of relationship objects</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.clear_knowledge_base" class="classattr">
                                        <input id="AgentKnowledgeManager.clear_knowledge_base-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear_knowledge_base</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.clear_knowledge_base-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.clear_knowledge_base"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.clear_knowledge_base-376"><a href="#AgentKnowledgeManager.clear_knowledge_base-376"><span class="linenos">376</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_knowledge_base</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-377"><a href="#AgentKnowledgeManager.clear_knowledge_base-377"><span class="linenos">377</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the entire knowledge base.</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-378"><a href="#AgentKnowledgeManager.clear_knowledge_base-378"><span class="linenos">378</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-379"><a href="#AgentKnowledgeManager.clear_knowledge_base-379"><span class="linenos">379</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-380"><a href="#AgentKnowledgeManager.clear_knowledge_base-380"><span class="linenos">380</span></a><span class="sd">            True if knowledge base was cleared successfully</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-381"><a href="#AgentKnowledgeManager.clear_knowledge_base-381"><span class="linenos">381</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-382"><a href="#AgentKnowledgeManager.clear_knowledge_base-382"><span class="linenos">382</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-383"><a href="#AgentKnowledgeManager.clear_knowledge_base-383"><span class="linenos">383</span></a>            <span class="c1"># Reset to empty structure</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-384"><a href="#AgentKnowledgeManager.clear_knowledge_base-384"><span class="linenos">384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-385"><a href="#AgentKnowledgeManager.clear_knowledge_base-385"><span class="linenos">385</span></a>                <span class="s2">&quot;facts&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-386"><a href="#AgentKnowledgeManager.clear_knowledge_base-386"><span class="linenos">386</span></a>                <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-387"><a href="#AgentKnowledgeManager.clear_knowledge_base-387"><span class="linenos">387</span></a>                <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-388"><a href="#AgentKnowledgeManager.clear_knowledge_base-388"><span class="linenos">388</span></a>                <span class="s2">&quot;relationships&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-389"><a href="#AgentKnowledgeManager.clear_knowledge_base-389"><span class="linenos">389</span></a>                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-390"><a href="#AgentKnowledgeManager.clear_knowledge_base-390"><span class="linenos">390</span></a>                    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-391"><a href="#AgentKnowledgeManager.clear_knowledge_base-391"><span class="linenos">391</span></a>                    <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="kc">None</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-392"><a href="#AgentKnowledgeManager.clear_knowledge_base-392"><span class="linenos">392</span></a>                <span class="p">}</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-393"><a href="#AgentKnowledgeManager.clear_knowledge_base-393"><span class="linenos">393</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-394"><a href="#AgentKnowledgeManager.clear_knowledge_base-394"><span class="linenos">394</span></a>            
</span><span id="AgentKnowledgeManager.clear_knowledge_base-395"><a href="#AgentKnowledgeManager.clear_knowledge_base-395"><span class="linenos">395</span></a>            <span class="c1"># Save knowledge base</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-396"><a href="#AgentKnowledgeManager.clear_knowledge_base-396"><span class="linenos">396</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_knowledge_base</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-397"><a href="#AgentKnowledgeManager.clear_knowledge_base-397"><span class="linenos">397</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-398"><a href="#AgentKnowledgeManager.clear_knowledge_base-398"><span class="linenos">398</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error clearing knowledge base: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.clear_knowledge_base-399"><a href="#AgentKnowledgeManager.clear_knowledge_base-399"><span class="linenos">399</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Clear the entire knowledge base.</p>

<p>Returns:
    True if knowledge base was cleared successfully</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.sync_with_graph" class="classattr">
                                        <input id="AgentKnowledgeManager.sync_with_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">sync_with_graph</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.sync_with_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.sync_with_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.sync_with_graph-401"><a href="#AgentKnowledgeManager.sync_with_graph-401"><span class="linenos">401</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">sync_with_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-402"><a href="#AgentKnowledgeManager.sync_with_graph-402"><span class="linenos">402</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronize the local knowledge base with the graph database.</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-403"><a href="#AgentKnowledgeManager.sync_with_graph-403"><span class="linenos">403</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.sync_with_graph-404"><a href="#AgentKnowledgeManager.sync_with_graph-404"><span class="linenos">404</span></a><span class="sd">        This method syncs entities and relationships from the local knowledge base</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-405"><a href="#AgentKnowledgeManager.sync_with_graph-405"><span class="linenos">405</span></a><span class="sd">        to the LightRAG graph database.</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-406"><a href="#AgentKnowledgeManager.sync_with_graph-406"><span class="linenos">406</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.sync_with_graph-407"><a href="#AgentKnowledgeManager.sync_with_graph-407"><span class="linenos">407</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-408"><a href="#AgentKnowledgeManager.sync_with_graph-408"><span class="linenos">408</span></a><span class="sd">            Status message</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-409"><a href="#AgentKnowledgeManager.sync_with_graph-409"><span class="linenos">409</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-410"><a href="#AgentKnowledgeManager.sync_with_graph-410"><span class="linenos">410</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-411"><a href="#AgentKnowledgeManager.sync_with_graph-411"><span class="linenos">411</span></a>            <span class="k">return</span> <span class="s2">&quot;Graph sync not available: LightRAG memory URL not configured&quot;</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-412"><a href="#AgentKnowledgeManager.sync_with_graph-412"><span class="linenos">412</span></a>            
</span><span id="AgentKnowledgeManager.sync_with_graph-413"><a href="#AgentKnowledgeManager.sync_with_graph-413"><span class="linenos">413</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-414"><a href="#AgentKnowledgeManager.sync_with_graph-414"><span class="linenos">414</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-415"><a href="#AgentKnowledgeManager.sync_with_graph-415"><span class="linenos">415</span></a>            
</span><span id="AgentKnowledgeManager.sync_with_graph-416"><a href="#AgentKnowledgeManager.sync_with_graph-416"><span class="linenos">416</span></a>            <span class="c1"># 1. Sync entities</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-417"><a href="#AgentKnowledgeManager.sync_with_graph-417"><span class="linenos">417</span></a>            <span class="k">for</span> <span class="n">entity_name</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-418"><a href="#AgentKnowledgeManager.sync_with_graph-418"><span class="linenos">418</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-419"><a href="#AgentKnowledgeManager.sync_with_graph-419"><span class="linenos">419</span></a>                    <span class="c1"># Check if entity exists in graph</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-420"><a href="#AgentKnowledgeManager.sync_with_graph-420"><span class="linenos">420</span></a>                    <span class="n">entity_exists</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_entity_exists</span><span class="p">(</span><span class="n">entity_name</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-421"><a href="#AgentKnowledgeManager.sync_with_graph-421"><span class="linenos">421</span></a>                    
</span><span id="AgentKnowledgeManager.sync_with_graph-422"><a href="#AgentKnowledgeManager.sync_with_graph-422"><span class="linenos">422</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">entity_exists</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-423"><a href="#AgentKnowledgeManager.sync_with_graph-423"><span class="linenos">423</span></a>                        <span class="c1"># Create entity in graph</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-424"><a href="#AgentKnowledgeManager.sync_with_graph-424"><span class="linenos">424</span></a>                        <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_graph_entity</span><span class="p">(</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-425"><a href="#AgentKnowledgeManager.sync_with_graph-425"><span class="linenos">425</span></a>                            <span class="n">entity_name</span><span class="p">,</span> <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-426"><a href="#AgentKnowledgeManager.sync_with_graph-426"><span class="linenos">426</span></a>                        <span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-427"><a href="#AgentKnowledgeManager.sync_with_graph-427"><span class="linenos">427</span></a>                        
</span><span id="AgentKnowledgeManager.sync_with_graph-428"><a href="#AgentKnowledgeManager.sync_with_graph-428"><span class="linenos">428</span></a>                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-429"><a href="#AgentKnowledgeManager.sync_with_graph-429"><span class="linenos">429</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created entity: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-430"><a href="#AgentKnowledgeManager.sync_with_graph-430"><span class="linenos">430</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-431"><a href="#AgentKnowledgeManager.sync_with_graph-431"><span class="linenos">431</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create entity: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-432"><a href="#AgentKnowledgeManager.sync_with_graph-432"><span class="linenos">432</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-433"><a href="#AgentKnowledgeManager.sync_with_graph-433"><span class="linenos">433</span></a>                        <span class="c1"># Update entity in graph</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-434"><a href="#AgentKnowledgeManager.sync_with_graph-434"><span class="linenos">434</span></a>                        <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_graph_entity</span><span class="p">(</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-435"><a href="#AgentKnowledgeManager.sync_with_graph-435"><span class="linenos">435</span></a>                            <span class="n">entity_name</span><span class="p">,</span> <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-436"><a href="#AgentKnowledgeManager.sync_with_graph-436"><span class="linenos">436</span></a>                        <span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-437"><a href="#AgentKnowledgeManager.sync_with_graph-437"><span class="linenos">437</span></a>                        
</span><span id="AgentKnowledgeManager.sync_with_graph-438"><a href="#AgentKnowledgeManager.sync_with_graph-438"><span class="linenos">438</span></a>                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-439"><a href="#AgentKnowledgeManager.sync_with_graph-439"><span class="linenos">439</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated entity: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-440"><a href="#AgentKnowledgeManager.sync_with_graph-440"><span class="linenos">440</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-441"><a href="#AgentKnowledgeManager.sync_with_graph-441"><span class="linenos">441</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update entity: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-442"><a href="#AgentKnowledgeManager.sync_with_graph-442"><span class="linenos">442</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-443"><a href="#AgentKnowledgeManager.sync_with_graph-443"><span class="linenos">443</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error syncing entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-444"><a href="#AgentKnowledgeManager.sync_with_graph-444"><span class="linenos">444</span></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error syncing entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-445"><a href="#AgentKnowledgeManager.sync_with_graph-445"><span class="linenos">445</span></a>                    
</span><span id="AgentKnowledgeManager.sync_with_graph-446"><a href="#AgentKnowledgeManager.sync_with_graph-446"><span class="linenos">446</span></a>            <span class="c1"># 2. Sync relationships</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-447"><a href="#AgentKnowledgeManager.sync_with_graph-447"><span class="linenos">447</span></a>            <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">[</span><span class="s2">&quot;relationships&quot;</span><span class="p">]:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-448"><a href="#AgentKnowledgeManager.sync_with_graph-448"><span class="linenos">448</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-449"><a href="#AgentKnowledgeManager.sync_with_graph-449"><span class="linenos">449</span></a>                    <span class="c1"># Create relationship in graph</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-450"><a href="#AgentKnowledgeManager.sync_with_graph-450"><span class="linenos">450</span></a>                    <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_graph_relationship</span><span class="p">(</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-451"><a href="#AgentKnowledgeManager.sync_with_graph-451"><span class="linenos">451</span></a>                        <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;entity1&quot;</span><span class="p">],</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;relation&quot;</span><span class="p">],</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;entity2&quot;</span><span class="p">],</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-452"><a href="#AgentKnowledgeManager.sync_with_graph-452"><span class="linenos">452</span></a>                    <span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-453"><a href="#AgentKnowledgeManager.sync_with_graph-453"><span class="linenos">453</span></a>                    
</span><span id="AgentKnowledgeManager.sync_with_graph-454"><a href="#AgentKnowledgeManager.sync_with_graph-454"><span class="linenos">454</span></a>                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-455"><a href="#AgentKnowledgeManager.sync_with_graph-455"><span class="linenos">455</span></a>                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created relationship: </span><span class="si">{</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;entity1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;entity2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-456"><a href="#AgentKnowledgeManager.sync_with_graph-456"><span class="linenos">456</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-457"><a href="#AgentKnowledgeManager.sync_with_graph-457"><span class="linenos">457</span></a>                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create relationship: </span><span class="si">{</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;entity1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;entity2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-458"><a href="#AgentKnowledgeManager.sync_with_graph-458"><span class="linenos">458</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-459"><a href="#AgentKnowledgeManager.sync_with_graph-459"><span class="linenos">459</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error syncing relationship: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-460"><a href="#AgentKnowledgeManager.sync_with_graph-460"><span class="linenos">460</span></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error syncing relationship: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-461"><a href="#AgentKnowledgeManager.sync_with_graph-461"><span class="linenos">461</span></a>                    
</span><span id="AgentKnowledgeManager.sync_with_graph-462"><a href="#AgentKnowledgeManager.sync_with_graph-462"><span class="linenos">462</span></a>            <span class="c1"># Return combined results</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-463"><a href="#AgentKnowledgeManager.sync_with_graph-463"><span class="linenos">463</span></a>            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-464"><a href="#AgentKnowledgeManager.sync_with_graph-464"><span class="linenos">464</span></a>            
</span><span id="AgentKnowledgeManager.sync_with_graph-465"><a href="#AgentKnowledgeManager.sync_with_graph-465"><span class="linenos">465</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-466"><a href="#AgentKnowledgeManager.sync_with_graph-466"><span class="linenos">466</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error syncing with graph: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.sync_with_graph-467"><a href="#AgentKnowledgeManager.sync_with_graph-467"><span class="linenos">467</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error syncing with graph: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Synchronize the local knowledge base with the graph database.</p>

<p>This method syncs entities and relationships from the local knowledge base
to the LightRAG graph database.</p>

<p>Returns:
    Status message</p>
</div>


                            </div>
                            <div id="AgentKnowledgeManager.query_graph" class="classattr">
                                        <input id="AgentKnowledgeManager.query_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">query_graph</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">query</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="AgentKnowledgeManager.query_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentKnowledgeManager.query_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentKnowledgeManager.query_graph-592"><a href="#AgentKnowledgeManager.query_graph-592"><span class="linenos">592</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.query_graph-593"><a href="#AgentKnowledgeManager.query_graph-593"><span class="linenos">593</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query the graph database.</span>
</span><span id="AgentKnowledgeManager.query_graph-594"><a href="#AgentKnowledgeManager.query_graph-594"><span class="linenos">594</span></a><span class="sd">        </span>
</span><span id="AgentKnowledgeManager.query_graph-595"><a href="#AgentKnowledgeManager.query_graph-595"><span class="linenos">595</span></a><span class="sd">        Args:</span>
</span><span id="AgentKnowledgeManager.query_graph-596"><a href="#AgentKnowledgeManager.query_graph-596"><span class="linenos">596</span></a><span class="sd">            query: Cypher query</span>
</span><span id="AgentKnowledgeManager.query_graph-597"><a href="#AgentKnowledgeManager.query_graph-597"><span class="linenos">597</span></a><span class="sd">            </span>
</span><span id="AgentKnowledgeManager.query_graph-598"><a href="#AgentKnowledgeManager.query_graph-598"><span class="linenos">598</span></a><span class="sd">        Returns:</span>
</span><span id="AgentKnowledgeManager.query_graph-599"><a href="#AgentKnowledgeManager.query_graph-599"><span class="linenos">599</span></a><span class="sd">            Query results</span>
</span><span id="AgentKnowledgeManager.query_graph-600"><a href="#AgentKnowledgeManager.query_graph-600"><span class="linenos">600</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentKnowledgeManager.query_graph-601"><a href="#AgentKnowledgeManager.query_graph-601"><span class="linenos">601</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.query_graph-602"><a href="#AgentKnowledgeManager.query_graph-602"><span class="linenos">602</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/query&quot;</span>
</span><span id="AgentKnowledgeManager.query_graph-603"><a href="#AgentKnowledgeManager.query_graph-603"><span class="linenos">603</span></a>            
</span><span id="AgentKnowledgeManager.query_graph-604"><a href="#AgentKnowledgeManager.query_graph-604"><span class="linenos">604</span></a>            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentKnowledgeManager.query_graph-605"><a href="#AgentKnowledgeManager.query_graph-605"><span class="linenos">605</span></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span>
</span><span id="AgentKnowledgeManager.query_graph-606"><a href="#AgentKnowledgeManager.query_graph-606"><span class="linenos">606</span></a>            <span class="p">}</span>
</span><span id="AgentKnowledgeManager.query_graph-607"><a href="#AgentKnowledgeManager.query_graph-607"><span class="linenos">607</span></a>            
</span><span id="AgentKnowledgeManager.query_graph-608"><a href="#AgentKnowledgeManager.query_graph-608"><span class="linenos">608</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.query_graph-609"><a href="#AgentKnowledgeManager.query_graph-609"><span class="linenos">609</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.query_graph-610"><a href="#AgentKnowledgeManager.query_graph-610"><span class="linenos">610</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.query_graph-611"><a href="#AgentKnowledgeManager.query_graph-611"><span class="linenos">611</span></a>                        <span class="k">return</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.query_graph-612"><a href="#AgentKnowledgeManager.query_graph-612"><span class="linenos">612</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.query_graph-613"><a href="#AgentKnowledgeManager.query_graph-613"><span class="linenos">613</span></a>                        <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentKnowledgeManager.query_graph-614"><a href="#AgentKnowledgeManager.query_graph-614"><span class="linenos">614</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to query graph: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.query_graph-615"><a href="#AgentKnowledgeManager.query_graph-615"><span class="linenos">615</span></a>                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_text</span><span class="p">}</span>
</span><span id="AgentKnowledgeManager.query_graph-616"><a href="#AgentKnowledgeManager.query_graph-616"><span class="linenos">616</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentKnowledgeManager.query_graph-617"><a href="#AgentKnowledgeManager.query_graph-617"><span class="linenos">617</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying graph: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentKnowledgeManager.query_graph-618"><a href="#AgentKnowledgeManager.query_graph-618"><span class="linenos">618</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</span></pre></div>


            <div class="docstring"><p>Query the graph database.</p>

<p>Args:
    query: Cypher query</p>

<p>Returns:
    Query results</p>
</div>


                            </div>
                </section>
                <section id="AgentMemoryManager">
                            <input id="AgentMemoryManager-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AgentMemoryManager</span>:

                <label class="view-source-button" for="AgentMemoryManager-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager-29"><a href="#AgentMemoryManager-29"><span class="linenos">  29</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentMemoryManager</span><span class="p">:</span>
</span><span id="AgentMemoryManager-30"><a href="#AgentMemoryManager-30"><span class="linenos">  30</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages memory operations including storage, retrieval, and updates.&quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-31"><a href="#AgentMemoryManager-31"><span class="linenos">  31</span></a>
</span><span id="AgentMemoryManager-32"><a href="#AgentMemoryManager-32"><span class="linenos">  32</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="AgentMemoryManager-33"><a href="#AgentMemoryManager-33"><span class="linenos">  33</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AgentMemoryManager-34"><a href="#AgentMemoryManager-34"><span class="linenos">  34</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentMemoryManager-35"><a href="#AgentMemoryManager-35"><span class="linenos">  35</span></a>        <span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentMemoryManager-36"><a href="#AgentMemoryManager-36"><span class="linenos">  36</span></a>        <span class="n">agno_memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="AgentMemoryManager-37"><a href="#AgentMemoryManager-37"><span class="linenos">  37</span></a>        <span class="n">lightrag_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AgentMemoryManager-38"><a href="#AgentMemoryManager-38"><span class="linenos">  38</span></a>        <span class="n">lightrag_memory_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AgentMemoryManager-39"><a href="#AgentMemoryManager-39"><span class="linenos">  39</span></a>        <span class="n">enable_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager-40"><a href="#AgentMemoryManager-40"><span class="linenos">  40</span></a>    <span class="p">):</span>
</span><span id="AgentMemoryManager-41"><a href="#AgentMemoryManager-41"><span class="linenos">  41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the memory manager.</span>
</span><span id="AgentMemoryManager-42"><a href="#AgentMemoryManager-42"><span class="linenos">  42</span></a>
</span><span id="AgentMemoryManager-43"><a href="#AgentMemoryManager-43"><span class="linenos">  43</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-44"><a href="#AgentMemoryManager-44"><span class="linenos">  44</span></a><span class="sd">            user_id: User identifier for memory operations</span>
</span><span id="AgentMemoryManager-45"><a href="#AgentMemoryManager-45"><span class="linenos">  45</span></a><span class="sd">            storage_dir: Directory for storage files</span>
</span><span id="AgentMemoryManager-46"><a href="#AgentMemoryManager-46"><span class="linenos">  46</span></a><span class="sd">            agno_memory: Optional initialized agno memory instance</span>
</span><span id="AgentMemoryManager-47"><a href="#AgentMemoryManager-47"><span class="linenos">  47</span></a><span class="sd">            lightrag_url: Optional URL for LightRAG API</span>
</span><span id="AgentMemoryManager-48"><a href="#AgentMemoryManager-48"><span class="linenos">  48</span></a><span class="sd">            lightrag_memory_url: Optional URL for LightRAG Memory API</span>
</span><span id="AgentMemoryManager-49"><a href="#AgentMemoryManager-49"><span class="linenos">  49</span></a><span class="sd">            enable_memory: Whether memory is enabled</span>
</span><span id="AgentMemoryManager-50"><a href="#AgentMemoryManager-50"><span class="linenos">  50</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-51"><a href="#AgentMemoryManager-51"><span class="linenos">  51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
</span><span id="AgentMemoryManager-52"><a href="#AgentMemoryManager-52"><span class="linenos">  52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span> <span class="o">=</span> <span class="n">storage_dir</span>
</span><span id="AgentMemoryManager-53"><a href="#AgentMemoryManager-53"><span class="linenos">  53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span> <span class="o">=</span> <span class="n">agno_memory</span>
</span><span id="AgentMemoryManager-54"><a href="#AgentMemoryManager-54"><span class="linenos">  54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_url</span> <span class="o">=</span> <span class="n">lightrag_url</span>
</span><span id="AgentMemoryManager-55"><a href="#AgentMemoryManager-55"><span class="linenos">  55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span> <span class="o">=</span> <span class="n">lightrag_memory_url</span>
</span><span id="AgentMemoryManager-56"><a href="#AgentMemoryManager-56"><span class="linenos">  56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_memory</span> <span class="o">=</span> <span class="n">enable_memory</span>
</span><span id="AgentMemoryManager-57"><a href="#AgentMemoryManager-57"><span class="linenos">  57</span></a>
</span><span id="AgentMemoryManager-58"><a href="#AgentMemoryManager-58"><span class="linenos">  58</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agno_memory</span><span class="p">):</span>
</span><span id="AgentMemoryManager-59"><a href="#AgentMemoryManager-59"><span class="linenos">  59</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the memory manager with agno_memory.</span>
</span><span id="AgentMemoryManager-60"><a href="#AgentMemoryManager-60"><span class="linenos">  60</span></a>
</span><span id="AgentMemoryManager-61"><a href="#AgentMemoryManager-61"><span class="linenos">  61</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-62"><a href="#AgentMemoryManager-62"><span class="linenos">  62</span></a><span class="sd">            agno_memory: The initialized agno memory instance</span>
</span><span id="AgentMemoryManager-63"><a href="#AgentMemoryManager-63"><span class="linenos">  63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-64"><a href="#AgentMemoryManager-64"><span class="linenos">  64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span> <span class="o">=</span> <span class="n">agno_memory</span>
</span><span id="AgentMemoryManager-65"><a href="#AgentMemoryManager-65"><span class="linenos">  65</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Memory manager initialized with agno_memory&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-66"><a href="#AgentMemoryManager-66"><span class="linenos">  66</span></a>
</span><span id="AgentMemoryManager-67"><a href="#AgentMemoryManager-67"><span class="linenos">  67</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">direct_search_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager-68"><a href="#AgentMemoryManager-68"><span class="linenos">  68</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span>
</span><span id="AgentMemoryManager-69"><a href="#AgentMemoryManager-69"><span class="linenos">  69</span></a>    <span class="p">):</span>
</span><span id="AgentMemoryManager-70"><a href="#AgentMemoryManager-70"><span class="linenos">  70</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Direct semantic search without agentic retrieval.</span>
</span><span id="AgentMemoryManager-71"><a href="#AgentMemoryManager-71"><span class="linenos">  71</span></a>
</span><span id="AgentMemoryManager-72"><a href="#AgentMemoryManager-72"><span class="linenos">  72</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-73"><a href="#AgentMemoryManager-73"><span class="linenos">  73</span></a><span class="sd">            query: The search query</span>
</span><span id="AgentMemoryManager-74"><a href="#AgentMemoryManager-74"><span class="linenos">  74</span></a><span class="sd">            limit: Maximum number of results to return</span>
</span><span id="AgentMemoryManager-75"><a href="#AgentMemoryManager-75"><span class="linenos">  75</span></a><span class="sd">            similarity_threshold: Minimum similarity score for results</span>
</span><span id="AgentMemoryManager-76"><a href="#AgentMemoryManager-76"><span class="linenos">  76</span></a>
</span><span id="AgentMemoryManager-77"><a href="#AgentMemoryManager-77"><span class="linenos">  77</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-78"><a href="#AgentMemoryManager-78"><span class="linenos">  78</span></a><span class="sd">            List of memory results</span>
</span><span id="AgentMemoryManager-79"><a href="#AgentMemoryManager-79"><span class="linenos">  79</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-80"><a href="#AgentMemoryManager-80"><span class="linenos">  80</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="p">:</span>
</span><span id="AgentMemoryManager-81"><a href="#AgentMemoryManager-81"><span class="linenos">  81</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-82"><a href="#AgentMemoryManager-82"><span class="linenos">  82</span></a>
</span><span id="AgentMemoryManager-83"><a href="#AgentMemoryManager-83"><span class="linenos">  83</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-84"><a href="#AgentMemoryManager-84"><span class="linenos">  84</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">search_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager-85"><a href="#AgentMemoryManager-85"><span class="linenos">  85</span></a>                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span><span id="AgentMemoryManager-86"><a href="#AgentMemoryManager-86"><span class="linenos">  86</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
</span><span id="AgentMemoryManager-87"><a href="#AgentMemoryManager-87"><span class="linenos">  87</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager-88"><a href="#AgentMemoryManager-88"><span class="linenos">  88</span></a>                <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
</span><span id="AgentMemoryManager-89"><a href="#AgentMemoryManager-89"><span class="linenos">  89</span></a>                <span class="n">similarity_threshold</span><span class="o">=</span><span class="n">similarity_threshold</span><span class="p">,</span>
</span><span id="AgentMemoryManager-90"><a href="#AgentMemoryManager-90"><span class="linenos">  90</span></a>                <span class="n">search_topics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager-91"><a href="#AgentMemoryManager-91"><span class="linenos">  91</span></a>                <span class="n">topic_boost</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="AgentMemoryManager-92"><a href="#AgentMemoryManager-92"><span class="linenos">  92</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-93"><a href="#AgentMemoryManager-93"><span class="linenos">  93</span></a>            <span class="k">return</span> <span class="n">results</span>
</span><span id="AgentMemoryManager-94"><a href="#AgentMemoryManager-94"><span class="linenos">  94</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-95"><a href="#AgentMemoryManager-95"><span class="linenos">  95</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Direct semantic search failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-96"><a href="#AgentMemoryManager-96"><span class="linenos">  96</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-97"><a href="#AgentMemoryManager-97"><span class="linenos">  97</span></a>
</span><span id="AgentMemoryManager-98"><a href="#AgentMemoryManager-98"><span class="linenos">  98</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">store_user_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager-99"><a href="#AgentMemoryManager-99"><span class="linenos">  99</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager-100"><a href="#AgentMemoryManager-100"><span class="linenos"> 100</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MemoryStorageResult</span><span class="p">:</span>
</span><span id="AgentMemoryManager-101"><a href="#AgentMemoryManager-101"><span class="linenos"> 101</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Store information as a user memory in BOTH local SQLite and LightRAG graph systems.</span>
</span><span id="AgentMemoryManager-102"><a href="#AgentMemoryManager-102"><span class="linenos"> 102</span></a>
</span><span id="AgentMemoryManager-103"><a href="#AgentMemoryManager-103"><span class="linenos"> 103</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-104"><a href="#AgentMemoryManager-104"><span class="linenos"> 104</span></a><span class="sd">            content: The information to store as a memory</span>
</span><span id="AgentMemoryManager-105"><a href="#AgentMemoryManager-105"><span class="linenos"> 105</span></a><span class="sd">            topics: Optional list of topics/categories for the memory (None = auto-classify)</span>
</span><span id="AgentMemoryManager-106"><a href="#AgentMemoryManager-106"><span class="linenos"> 106</span></a>
</span><span id="AgentMemoryManager-107"><a href="#AgentMemoryManager-107"><span class="linenos"> 107</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-108"><a href="#AgentMemoryManager-108"><span class="linenos"> 108</span></a><span class="sd">            MemoryStorageResult: Structured result with detailed status information</span>
</span><span id="AgentMemoryManager-109"><a href="#AgentMemoryManager-109"><span class="linenos"> 109</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-110"><a href="#AgentMemoryManager-110"><span class="linenos"> 110</span></a>        <span class="c1"># Validate that content is provided</span>
</span><span id="AgentMemoryManager-111"><a href="#AgentMemoryManager-111"><span class="linenos"> 111</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="AgentMemoryManager-112"><a href="#AgentMemoryManager-112"><span class="linenos"> 112</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="AgentMemoryManager-113"><a href="#AgentMemoryManager-113"><span class="linenos"> 113</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">CONTENT_EMPTY</span><span class="p">,</span>
</span><span id="AgentMemoryManager-114"><a href="#AgentMemoryManager-114"><span class="linenos"> 114</span></a>                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Content is required to store a memory. Please provide the information you want me to remember.&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-115"><a href="#AgentMemoryManager-115"><span class="linenos"> 115</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AgentMemoryManager-116"><a href="#AgentMemoryManager-116"><span class="linenos"> 116</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AgentMemoryManager-117"><a href="#AgentMemoryManager-117"><span class="linenos"> 117</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-118"><a href="#AgentMemoryManager-118"><span class="linenos"> 118</span></a>
</span><span id="AgentMemoryManager-119"><a href="#AgentMemoryManager-119"><span class="linenos"> 119</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-120"><a href="#AgentMemoryManager-120"><span class="linenos"> 120</span></a>            <span class="c1"># Restate the user fact from first-person to third-person</span>
</span><span id="AgentMemoryManager-121"><a href="#AgentMemoryManager-121"><span class="linenos"> 121</span></a>            <span class="n">restated_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restate_user_fact</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="AgentMemoryManager-122"><a href="#AgentMemoryManager-122"><span class="linenos"> 122</span></a>
</span><span id="AgentMemoryManager-123"><a href="#AgentMemoryManager-123"><span class="linenos"> 123</span></a>            <span class="c1"># SIMPLIFIED TOPIC HANDLING: Handle the common cases simply</span>
</span><span id="AgentMemoryManager-124"><a href="#AgentMemoryManager-124"><span class="linenos"> 124</span></a>            <span class="k">if</span> <span class="n">topics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AgentMemoryManager-125"><a href="#AgentMemoryManager-125"><span class="linenos"> 125</span></a>                <span class="c1"># Leave as None - let memory manager auto-classify</span>
</span><span id="AgentMemoryManager-126"><a href="#AgentMemoryManager-126"><span class="linenos"> 126</span></a>                <span class="k">pass</span>
</span><span id="AgentMemoryManager-127"><a href="#AgentMemoryManager-127"><span class="linenos"> 127</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AgentMemoryManager-128"><a href="#AgentMemoryManager-128"><span class="linenos"> 128</span></a>                <span class="c1"># Convert string to list, handle comma-separated values</span>
</span><span id="AgentMemoryManager-129"><a href="#AgentMemoryManager-129"><span class="linenos"> 129</span></a>                <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-130"><a href="#AgentMemoryManager-130"><span class="linenos"> 130</span></a>                    <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager-131"><a href="#AgentMemoryManager-131"><span class="linenos"> 131</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-132"><a href="#AgentMemoryManager-132"><span class="linenos"> 132</span></a>                    <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">if</span> <span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager-133"><a href="#AgentMemoryManager-133"><span class="linenos"> 133</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager-134"><a href="#AgentMemoryManager-134"><span class="linenos"> 134</span></a>                <span class="c1"># Clean up list - remove empty entries</span>
</span><span id="AgentMemoryManager-135"><a href="#AgentMemoryManager-135"><span class="linenos"> 135</span></a>                <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager-136"><a href="#AgentMemoryManager-136"><span class="linenos"> 136</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-137"><a href="#AgentMemoryManager-137"><span class="linenos"> 137</span></a>                    <span class="n">topics</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager-138"><a href="#AgentMemoryManager-138"><span class="linenos"> 138</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-139"><a href="#AgentMemoryManager-139"><span class="linenos"> 139</span></a>                <span class="c1"># Convert anything else to string and put in list</span>
</span><span id="AgentMemoryManager-140"><a href="#AgentMemoryManager-140"><span class="linenos"> 140</span></a>                <span class="n">topic_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AgentMemoryManager-141"><a href="#AgentMemoryManager-141"><span class="linenos"> 141</span></a>                <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">topic_str</span><span class="p">]</span> <span class="k">if</span> <span class="n">topic_str</span> <span class="ow">and</span> <span class="n">topic_str</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager-142"><a href="#AgentMemoryManager-142"><span class="linenos"> 142</span></a>
</span><span id="AgentMemoryManager-143"><a href="#AgentMemoryManager-143"><span class="linenos"> 143</span></a>            <span class="c1"># 1. Store in local SQLite memory system</span>
</span><span id="AgentMemoryManager-144"><a href="#AgentMemoryManager-144"><span class="linenos"> 144</span></a>            <span class="n">local_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">add_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager-145"><a href="#AgentMemoryManager-145"><span class="linenos"> 145</span></a>                <span class="n">memory_text</span><span class="o">=</span><span class="n">restated_content</span><span class="p">,</span>
</span><span id="AgentMemoryManager-146"><a href="#AgentMemoryManager-146"><span class="linenos"> 146</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
</span><span id="AgentMemoryManager-147"><a href="#AgentMemoryManager-147"><span class="linenos"> 147</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager-148"><a href="#AgentMemoryManager-148"><span class="linenos"> 148</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span>
</span><span id="AgentMemoryManager-149"><a href="#AgentMemoryManager-149"><span class="linenos"> 149</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-150"><a href="#AgentMemoryManager-150"><span class="linenos"> 150</span></a>
</span><span id="AgentMemoryManager-151"><a href="#AgentMemoryManager-151"><span class="linenos"> 151</span></a>            <span class="c1"># Handle different rejection cases</span>
</span><span id="AgentMemoryManager-152"><a href="#AgentMemoryManager-152"><span class="linenos"> 152</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">local_result</span><span class="o">.</span><span class="n">is_success</span><span class="p">:</span>
</span><span id="AgentMemoryManager-153"><a href="#AgentMemoryManager-153"><span class="linenos"> 153</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Local memory rejected: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">local_result</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</span><span id="AgentMemoryManager-154"><a href="#AgentMemoryManager-154"><span class="linenos"> 154</span></a>                <span class="c1"># Return the rejection status directly from the memory manager</span>
</span><span id="AgentMemoryManager-155"><a href="#AgentMemoryManager-155"><span class="linenos"> 155</span></a>                <span class="k">return</span> <span class="n">local_result</span>
</span><span id="AgentMemoryManager-156"><a href="#AgentMemoryManager-156"><span class="linenos"> 156</span></a>
</span><span id="AgentMemoryManager-157"><a href="#AgentMemoryManager-157"><span class="linenos"> 157</span></a>            <span class="c1"># Local storage succeeded</span>
</span><span id="AgentMemoryManager-158"><a href="#AgentMemoryManager-158"><span class="linenos"> 158</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-159"><a href="#AgentMemoryManager-159"><span class="linenos"> 159</span></a>                <span class="s2">&quot;Stored in local memory: </span><span class="si">%s</span><span class="s2">... (ID: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-160"><a href="#AgentMemoryManager-160"><span class="linenos"> 160</span></a>                <span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span>
</span><span id="AgentMemoryManager-161"><a href="#AgentMemoryManager-161"><span class="linenos"> 161</span></a>                <span class="n">local_result</span><span class="o">.</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager-162"><a href="#AgentMemoryManager-162"><span class="linenos"> 162</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-163"><a href="#AgentMemoryManager-163"><span class="linenos"> 163</span></a>
</span><span id="AgentMemoryManager-164"><a href="#AgentMemoryManager-164"><span class="linenos"> 164</span></a>            <span class="c1"># 2. Store in LightRAG graph memory system</span>
</span><span id="AgentMemoryManager-165"><a href="#AgentMemoryManager-165"><span class="linenos"> 165</span></a>            <span class="n">graph_success</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager-166"><a href="#AgentMemoryManager-166"><span class="linenos"> 166</span></a>            <span class="n">graph_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="AgentMemoryManager-167"><a href="#AgentMemoryManager-167"><span class="linenos"> 167</span></a>
</span><span id="AgentMemoryManager-168"><a href="#AgentMemoryManager-168"><span class="linenos"> 168</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-169"><a href="#AgentMemoryManager-169"><span class="linenos"> 169</span></a>                <span class="c1"># Store in graph memory</span>
</span><span id="AgentMemoryManager-170"><a href="#AgentMemoryManager-170"><span class="linenos"> 170</span></a>                <span class="n">graph_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_graph_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager-171"><a href="#AgentMemoryManager-171"><span class="linenos"> 171</span></a>                    <span class="n">restated_content</span><span class="p">,</span> <span class="n">local_result</span><span class="o">.</span><span class="n">topics</span><span class="p">,</span> <span class="n">local_result</span><span class="o">.</span><span class="n">memory_id</span>
</span><span id="AgentMemoryManager-172"><a href="#AgentMemoryManager-172"><span class="linenos"> 172</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-173"><a href="#AgentMemoryManager-173"><span class="linenos"> 173</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph memory result: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">graph_result</span><span class="p">)</span>
</span><span id="AgentMemoryManager-174"><a href="#AgentMemoryManager-174"><span class="linenos"> 174</span></a>                <span class="k">if</span> <span class="s2">&quot;&quot;</span> <span class="ow">in</span> <span class="n">graph_result</span><span class="p">:</span>
</span><span id="AgentMemoryManager-175"><a href="#AgentMemoryManager-175"><span class="linenos"> 175</span></a>                    <span class="n">graph_success</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AgentMemoryManager-176"><a href="#AgentMemoryManager-176"><span class="linenos"> 176</span></a>                    <span class="n">graph_message</span> <span class="o">=</span> <span class="s2">&quot;Graph memory synced successfully&quot;</span>
</span><span id="AgentMemoryManager-177"><a href="#AgentMemoryManager-177"><span class="linenos"> 177</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-178"><a href="#AgentMemoryManager-178"><span class="linenos"> 178</span></a>                    <span class="n">graph_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Graph memory sync failed: </span><span class="si">{</span><span class="n">graph_result</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-179"><a href="#AgentMemoryManager-179"><span class="linenos"> 179</span></a>
</span><span id="AgentMemoryManager-180"><a href="#AgentMemoryManager-180"><span class="linenos"> 180</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-181"><a href="#AgentMemoryManager-181"><span class="linenos"> 181</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error storing in graph memory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-182"><a href="#AgentMemoryManager-182"><span class="linenos"> 182</span></a>                <span class="n">graph_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Graph memory error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-183"><a href="#AgentMemoryManager-183"><span class="linenos"> 183</span></a>
</span><span id="AgentMemoryManager-184"><a href="#AgentMemoryManager-184"><span class="linenos"> 184</span></a>            <span class="c1"># Determine final status based on local and graph results</span>
</span><span id="AgentMemoryManager-185"><a href="#AgentMemoryManager-185"><span class="linenos"> 185</span></a>            <span class="k">if</span> <span class="n">graph_success</span><span class="p">:</span>
</span><span id="AgentMemoryManager-186"><a href="#AgentMemoryManager-186"><span class="linenos"> 186</span></a>                <span class="n">final_status</span> <span class="o">=</span> <span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">SUCCESS</span>
</span><span id="AgentMemoryManager-187"><a href="#AgentMemoryManager-187"><span class="linenos"> 187</span></a>                <span class="n">final_message</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager-188"><a href="#AgentMemoryManager-188"><span class="linenos"> 188</span></a>                    <span class="sa">f</span><span class="s2">&quot;Memory stored successfully in both systems: </span><span class="si">{</span><span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span id="AgentMemoryManager-189"><a href="#AgentMemoryManager-189"><span class="linenos"> 189</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-190"><a href="#AgentMemoryManager-190"><span class="linenos"> 190</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-191"><a href="#AgentMemoryManager-191"><span class="linenos"> 191</span></a>                    <span class="s2">&quot; DUAL STORAGE SUCCESS: Memory stored in both local SQLite and LightRAG graph&quot;</span>
</span><span id="AgentMemoryManager-192"><a href="#AgentMemoryManager-192"><span class="linenos"> 192</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-193"><a href="#AgentMemoryManager-193"><span class="linenos"> 193</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-194"><a href="#AgentMemoryManager-194"><span class="linenos"> 194</span></a>                <span class="n">final_status</span> <span class="o">=</span> <span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">SUCCESS_LOCAL_ONLY</span>
</span><span id="AgentMemoryManager-195"><a href="#AgentMemoryManager-195"><span class="linenos"> 195</span></a>                <span class="n">final_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Memory stored in local system only: </span><span class="si">{</span><span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">... | </span><span class="si">{</span><span class="n">graph_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-196"><a href="#AgentMemoryManager-196"><span class="linenos"> 196</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager-197"><a href="#AgentMemoryManager-197"><span class="linenos"> 197</span></a>                    <span class="s2">&quot; PARTIAL STORAGE: Memory stored in local SQLite only (graph sync failed)&quot;</span>
</span><span id="AgentMemoryManager-198"><a href="#AgentMemoryManager-198"><span class="linenos"> 198</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-199"><a href="#AgentMemoryManager-199"><span class="linenos"> 199</span></a>
</span><span id="AgentMemoryManager-200"><a href="#AgentMemoryManager-200"><span class="linenos"> 200</span></a>            <span class="c1"># Return the enhanced result with dual storage information</span>
</span><span id="AgentMemoryManager-201"><a href="#AgentMemoryManager-201"><span class="linenos"> 201</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="AgentMemoryManager-202"><a href="#AgentMemoryManager-202"><span class="linenos"> 202</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">final_status</span><span class="p">,</span>
</span><span id="AgentMemoryManager-203"><a href="#AgentMemoryManager-203"><span class="linenos"> 203</span></a>                <span class="n">message</span><span class="o">=</span><span class="n">final_message</span><span class="p">,</span>
</span><span id="AgentMemoryManager-204"><a href="#AgentMemoryManager-204"><span class="linenos"> 204</span></a>                <span class="n">memory_id</span><span class="o">=</span><span class="n">local_result</span><span class="o">.</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager-205"><a href="#AgentMemoryManager-205"><span class="linenos"> 205</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">local_result</span><span class="o">.</span><span class="n">topics</span><span class="p">,</span>
</span><span id="AgentMemoryManager-206"><a href="#AgentMemoryManager-206"><span class="linenos"> 206</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager-207"><a href="#AgentMemoryManager-207"><span class="linenos"> 207</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="n">graph_success</span><span class="p">,</span>
</span><span id="AgentMemoryManager-208"><a href="#AgentMemoryManager-208"><span class="linenos"> 208</span></a>                <span class="n">similarity_score</span><span class="o">=</span><span class="n">local_result</span><span class="o">.</span><span class="n">similarity_score</span><span class="p">,</span>
</span><span id="AgentMemoryManager-209"><a href="#AgentMemoryManager-209"><span class="linenos"> 209</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-210"><a href="#AgentMemoryManager-210"><span class="linenos"> 210</span></a>
</span><span id="AgentMemoryManager-211"><a href="#AgentMemoryManager-211"><span class="linenos"> 211</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-212"><a href="#AgentMemoryManager-212"><span class="linenos"> 212</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error storing user memory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-213"><a href="#AgentMemoryManager-213"><span class="linenos"> 213</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="AgentMemoryManager-214"><a href="#AgentMemoryManager-214"><span class="linenos"> 214</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">STORAGE_ERROR</span><span class="p">,</span>
</span><span id="AgentMemoryManager-215"><a href="#AgentMemoryManager-215"><span class="linenos"> 215</span></a>                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Error storing memory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-216"><a href="#AgentMemoryManager-216"><span class="linenos"> 216</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AgentMemoryManager-217"><a href="#AgentMemoryManager-217"><span class="linenos"> 217</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AgentMemoryManager-218"><a href="#AgentMemoryManager-218"><span class="linenos"> 218</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-219"><a href="#AgentMemoryManager-219"><span class="linenos"> 219</span></a>
</span><span id="AgentMemoryManager-220"><a href="#AgentMemoryManager-220"><span class="linenos"> 220</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">restate_user_fact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-221"><a href="#AgentMemoryManager-221"><span class="linenos"> 221</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Restate a user fact from first-person to third-person.</span>
</span><span id="AgentMemoryManager-222"><a href="#AgentMemoryManager-222"><span class="linenos"> 222</span></a>
</span><span id="AgentMemoryManager-223"><a href="#AgentMemoryManager-223"><span class="linenos"> 223</span></a><span class="sd">        This method converts statements like &quot;I have a PhD&quot; to &quot;{user_id} has a PhD&quot;</span>
</span><span id="AgentMemoryManager-224"><a href="#AgentMemoryManager-224"><span class="linenos"> 224</span></a><span class="sd">        to ensure correct entity mapping in the knowledge graph.</span>
</span><span id="AgentMemoryManager-225"><a href="#AgentMemoryManager-225"><span class="linenos"> 225</span></a>
</span><span id="AgentMemoryManager-226"><a href="#AgentMemoryManager-226"><span class="linenos"> 226</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-227"><a href="#AgentMemoryManager-227"><span class="linenos"> 227</span></a><span class="sd">            content: The original fact from the user</span>
</span><span id="AgentMemoryManager-228"><a href="#AgentMemoryManager-228"><span class="linenos"> 228</span></a>
</span><span id="AgentMemoryManager-229"><a href="#AgentMemoryManager-229"><span class="linenos"> 229</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-230"><a href="#AgentMemoryManager-230"><span class="linenos"> 230</span></a><span class="sd">            The restated fact</span>
</span><span id="AgentMemoryManager-231"><a href="#AgentMemoryManager-231"><span class="linenos"> 231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-232"><a href="#AgentMemoryManager-232"><span class="linenos"> 232</span></a>        <span class="c1"># Ensure user_id is a safe string for replacement</span>
</span><span id="AgentMemoryManager-233"><a href="#AgentMemoryManager-233"><span class="linenos"> 233</span></a>        <span class="n">user_id_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager-234"><a href="#AgentMemoryManager-234"><span class="linenos"> 234</span></a>
</span><span id="AgentMemoryManager-235"><a href="#AgentMemoryManager-235"><span class="linenos"> 235</span></a>        <span class="c1"># Define regex patterns for pronoun and verb replacement</span>
</span><span id="AgentMemoryManager-236"><a href="#AgentMemoryManager-236"><span class="linenos"> 236</span></a>        <span class="c1"># Using word boundaries (\b) to avoid replacing parts of words like &quot;mine&quot; in &quot;mining&quot;</span>
</span><span id="AgentMemoryManager-237"><a href="#AgentMemoryManager-237"><span class="linenos"> 237</span></a>        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager-238"><a href="#AgentMemoryManager-238"><span class="linenos"> 238</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bI am\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2"> is&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager-239"><a href="#AgentMemoryManager-239"><span class="linenos"> 239</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bI was\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2"> was&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager-240"><a href="#AgentMemoryManager-240"><span class="linenos"> 240</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bI have\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2"> has&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager-241"><a href="#AgentMemoryManager-241"><span class="linenos"> 241</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bI&#39;m\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2"> is&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager-242"><a href="#AgentMemoryManager-242"><span class="linenos"> 242</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bI&#39;ve\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2"> has&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager-243"><a href="#AgentMemoryManager-243"><span class="linenos"> 243</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bI\b&quot;</span><span class="p">,</span> <span class="n">user_id_str</span><span class="p">),</span>
</span><span id="AgentMemoryManager-244"><a href="#AgentMemoryManager-244"><span class="linenos"> 244</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bmy\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2">&#39;s&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager-245"><a href="#AgentMemoryManager-245"><span class="linenos"> 245</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bmine\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2">&#39;s&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager-246"><a href="#AgentMemoryManager-246"><span class="linenos"> 246</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bmyself\b&quot;</span><span class="p">,</span> <span class="n">user_id_str</span><span class="p">),</span>
</span><span id="AgentMemoryManager-247"><a href="#AgentMemoryManager-247"><span class="linenos"> 247</span></a>        <span class="p">]</span>
</span><span id="AgentMemoryManager-248"><a href="#AgentMemoryManager-248"><span class="linenos"> 248</span></a>
</span><span id="AgentMemoryManager-249"><a href="#AgentMemoryManager-249"><span class="linenos"> 249</span></a>        <span class="n">restated_content</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="AgentMemoryManager-250"><a href="#AgentMemoryManager-250"><span class="linenos"> 250</span></a>        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
</span><span id="AgentMemoryManager-251"><a href="#AgentMemoryManager-251"><span class="linenos"> 251</span></a>            <span class="c1"># Use re.IGNORECASE to handle variations like &quot;i&quot; vs &quot;I&quot;</span>
</span><span id="AgentMemoryManager-252"><a href="#AgentMemoryManager-252"><span class="linenos"> 252</span></a>            <span class="n">restated_content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span id="AgentMemoryManager-253"><a href="#AgentMemoryManager-253"><span class="linenos"> 253</span></a>                <span class="n">pattern</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">restated_content</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
</span><span id="AgentMemoryManager-254"><a href="#AgentMemoryManager-254"><span class="linenos"> 254</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-255"><a href="#AgentMemoryManager-255"><span class="linenos"> 255</span></a>
</span><span id="AgentMemoryManager-256"><a href="#AgentMemoryManager-256"><span class="linenos"> 256</span></a>        <span class="k">return</span> <span class="n">restated_content</span>
</span><span id="AgentMemoryManager-257"><a href="#AgentMemoryManager-257"><span class="linenos"> 257</span></a>
</span><span id="AgentMemoryManager-258"><a href="#AgentMemoryManager-258"><span class="linenos"> 258</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">seed_entity_in_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentMemoryManager-259"><a href="#AgentMemoryManager-259"><span class="linenos"> 259</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Seed an entity into the graph by creating and uploading a physical file.</span>
</span><span id="AgentMemoryManager-260"><a href="#AgentMemoryManager-260"><span class="linenos"> 260</span></a>
</span><span id="AgentMemoryManager-261"><a href="#AgentMemoryManager-261"><span class="linenos"> 261</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-262"><a href="#AgentMemoryManager-262"><span class="linenos"> 262</span></a><span class="sd">            entity_name: Name of the entity to create</span>
</span><span id="AgentMemoryManager-263"><a href="#AgentMemoryManager-263"><span class="linenos"> 263</span></a><span class="sd">            entity_type: Type of the entity</span>
</span><span id="AgentMemoryManager-264"><a href="#AgentMemoryManager-264"><span class="linenos"> 264</span></a>
</span><span id="AgentMemoryManager-265"><a href="#AgentMemoryManager-265"><span class="linenos"> 265</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-266"><a href="#AgentMemoryManager-266"><span class="linenos"> 266</span></a><span class="sd">            True if entity was successfully seeded</span>
</span><span id="AgentMemoryManager-267"><a href="#AgentMemoryManager-267"><span class="linenos"> 267</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-268"><a href="#AgentMemoryManager-268"><span class="linenos"> 268</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-269"><a href="#AgentMemoryManager-269"><span class="linenos"> 269</span></a>            <span class="c1"># Create a minimal document to seed the entity</span>
</span><span id="AgentMemoryManager-270"><a href="#AgentMemoryManager-270"><span class="linenos"> 270</span></a>            <span class="n">seed_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2"> is a </span><span class="si">{</span><span class="n">entity_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="AgentMemoryManager-271"><a href="#AgentMemoryManager-271"><span class="linenos"> 271</span></a>
</span><span id="AgentMemoryManager-272"><a href="#AgentMemoryManager-272"><span class="linenos"> 272</span></a>            <span class="c1"># Create a unique filename for this entity seed</span>
</span><span id="AgentMemoryManager-273"><a href="#AgentMemoryManager-273"><span class="linenos"> 273</span></a>            <span class="n">entity_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
</span><span id="AgentMemoryManager-274"><a href="#AgentMemoryManager-274"><span class="linenos"> 274</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span id="AgentMemoryManager-275"><a href="#AgentMemoryManager-275"><span class="linenos"> 275</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>
</span><span id="AgentMemoryManager-276"><a href="#AgentMemoryManager-276"><span class="linenos"> 276</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;entity_seed_</span><span class="si">{</span><span class="n">entity_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">entity_hash</span><span class="si">}</span><span class="s2">.txt&quot;</span>
</span><span id="AgentMemoryManager-277"><a href="#AgentMemoryManager-277"><span class="linenos"> 277</span></a>
</span><span id="AgentMemoryManager-278"><a href="#AgentMemoryManager-278"><span class="linenos"> 278</span></a>            <span class="c1"># Create a temporary file</span>
</span><span id="AgentMemoryManager-279"><a href="#AgentMemoryManager-279"><span class="linenos"> 279</span></a>            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span>
</span><span id="AgentMemoryManager-280"><a href="#AgentMemoryManager-280"><span class="linenos"> 280</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span>
</span><span id="AgentMemoryManager-281"><a href="#AgentMemoryManager-281"><span class="linenos"> 281</span></a>            <span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
</span><span id="AgentMemoryManager-282"><a href="#AgentMemoryManager-282"><span class="linenos"> 282</span></a>                <span class="n">temp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">seed_text</span><span class="p">)</span>
</span><span id="AgentMemoryManager-283"><a href="#AgentMemoryManager-283"><span class="linenos"> 283</span></a>                <span class="n">temp_file_path</span> <span class="o">=</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span>
</span><span id="AgentMemoryManager-284"><a href="#AgentMemoryManager-284"><span class="linenos"> 284</span></a>
</span><span id="AgentMemoryManager-285"><a href="#AgentMemoryManager-285"><span class="linenos"> 285</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-286"><a href="#AgentMemoryManager-286"><span class="linenos"> 286</span></a>                <span class="c1"># Upload the file using the /documents/upload endpoint</span>
</span><span id="AgentMemoryManager-287"><a href="#AgentMemoryManager-287"><span class="linenos"> 287</span></a>                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents/upload&quot;</span>
</span><span id="AgentMemoryManager-288"><a href="#AgentMemoryManager-288"><span class="linenos"> 288</span></a>
</span><span id="AgentMemoryManager-289"><a href="#AgentMemoryManager-289"><span class="linenos"> 289</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager-290"><a href="#AgentMemoryManager-290"><span class="linenos"> 290</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="AgentMemoryManager-291"><a href="#AgentMemoryManager-291"><span class="linenos"> 291</span></a>                        <span class="c1"># Create form data for file upload</span>
</span><span id="AgentMemoryManager-292"><a href="#AgentMemoryManager-292"><span class="linenos"> 292</span></a>                        <span class="n">data</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">FormData</span><span class="p">()</span>
</span><span id="AgentMemoryManager-293"><a href="#AgentMemoryManager-293"><span class="linenos"> 293</span></a>                        <span class="n">data</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
</span><span id="AgentMemoryManager-294"><a href="#AgentMemoryManager-294"><span class="linenos"> 294</span></a>                            <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span>
</span><span id="AgentMemoryManager-295"><a href="#AgentMemoryManager-295"><span class="linenos"> 295</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager-296"><a href="#AgentMemoryManager-296"><span class="linenos"> 296</span></a>
</span><span id="AgentMemoryManager-297"><a href="#AgentMemoryManager-297"><span class="linenos"> 297</span></a>                        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-298"><a href="#AgentMemoryManager-298"><span class="linenos"> 298</span></a>                            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">]:</span>
</span><span id="AgentMemoryManager-299"><a href="#AgentMemoryManager-299"><span class="linenos"> 299</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-300"><a href="#AgentMemoryManager-300"><span class="linenos"> 300</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Successfully seeded entity: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-301"><a href="#AgentMemoryManager-301"><span class="linenos"> 301</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager-302"><a href="#AgentMemoryManager-302"><span class="linenos"> 302</span></a>                                <span class="k">return</span> <span class="kc">True</span>
</span><span id="AgentMemoryManager-303"><a href="#AgentMemoryManager-303"><span class="linenos"> 303</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-304"><a href="#AgentMemoryManager-304"><span class="linenos"> 304</span></a>                                <span class="n">error_detail</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager-305"><a href="#AgentMemoryManager-305"><span class="linenos"> 305</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager-306"><a href="#AgentMemoryManager-306"><span class="linenos"> 306</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Failed to seed entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-307"><a href="#AgentMemoryManager-307"><span class="linenos"> 307</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager-308"><a href="#AgentMemoryManager-308"><span class="linenos"> 308</span></a>                                <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager-309"><a href="#AgentMemoryManager-309"><span class="linenos"> 309</span></a>
</span><span id="AgentMemoryManager-310"><a href="#AgentMemoryManager-310"><span class="linenos"> 310</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="AgentMemoryManager-311"><a href="#AgentMemoryManager-311"><span class="linenos"> 311</span></a>                <span class="c1"># Clean up the temporary file</span>
</span><span id="AgentMemoryManager-312"><a href="#AgentMemoryManager-312"><span class="linenos"> 312</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-313"><a href="#AgentMemoryManager-313"><span class="linenos"> 313</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">)</span>
</span><span id="AgentMemoryManager-314"><a href="#AgentMemoryManager-314"><span class="linenos"> 314</span></a>                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="AgentMemoryManager-315"><a href="#AgentMemoryManager-315"><span class="linenos"> 315</span></a>                    <span class="k">pass</span>  <span class="c1"># Ignore cleanup errors</span>
</span><span id="AgentMemoryManager-316"><a href="#AgentMemoryManager-316"><span class="linenos"> 316</span></a>
</span><span id="AgentMemoryManager-317"><a href="#AgentMemoryManager-317"><span class="linenos"> 317</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-318"><a href="#AgentMemoryManager-318"><span class="linenos"> 318</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error seeding entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-319"><a href="#AgentMemoryManager-319"><span class="linenos"> 319</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager-320"><a href="#AgentMemoryManager-320"><span class="linenos"> 320</span></a>
</span><span id="AgentMemoryManager-321"><a href="#AgentMemoryManager-321"><span class="linenos"> 321</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_entity_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentMemoryManager-322"><a href="#AgentMemoryManager-322"><span class="linenos"> 322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if entity exists in the graph using the correct /graph/entity/exists endpoint.</span>
</span><span id="AgentMemoryManager-323"><a href="#AgentMemoryManager-323"><span class="linenos"> 323</span></a>
</span><span id="AgentMemoryManager-324"><a href="#AgentMemoryManager-324"><span class="linenos"> 324</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-325"><a href="#AgentMemoryManager-325"><span class="linenos"> 325</span></a><span class="sd">            entity_name: Name of the entity to check</span>
</span><span id="AgentMemoryManager-326"><a href="#AgentMemoryManager-326"><span class="linenos"> 326</span></a>
</span><span id="AgentMemoryManager-327"><a href="#AgentMemoryManager-327"><span class="linenos"> 327</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-328"><a href="#AgentMemoryManager-328"><span class="linenos"> 328</span></a><span class="sd">            True if entity exists</span>
</span><span id="AgentMemoryManager-329"><a href="#AgentMemoryManager-329"><span class="linenos"> 329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-330"><a href="#AgentMemoryManager-330"><span class="linenos"> 330</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-331"><a href="#AgentMemoryManager-331"><span class="linenos"> 331</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/entity/exists&quot;</span>
</span><span id="AgentMemoryManager-332"><a href="#AgentMemoryManager-332"><span class="linenos"> 332</span></a>
</span><span id="AgentMemoryManager-333"><a href="#AgentMemoryManager-333"><span class="linenos"> 333</span></a>            <span class="c1"># Try different parameter formats that LightRAG might expect</span>
</span><span id="AgentMemoryManager-334"><a href="#AgentMemoryManager-334"><span class="linenos"> 334</span></a>            <span class="n">params_options</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager-335"><a href="#AgentMemoryManager-335"><span class="linenos"> 335</span></a>                <span class="p">{</span><span class="s2">&quot;entity_name&quot;</span><span class="p">:</span> <span class="n">entity_name</span><span class="p">},</span>
</span><span id="AgentMemoryManager-336"><a href="#AgentMemoryManager-336"><span class="linenos"> 336</span></a>                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">entity_name</span><span class="p">},</span>
</span><span id="AgentMemoryManager-337"><a href="#AgentMemoryManager-337"><span class="linenos"> 337</span></a>                <span class="p">{</span><span class="s2">&quot;entity&quot;</span><span class="p">:</span> <span class="n">entity_name</span><span class="p">},</span>
</span><span id="AgentMemoryManager-338"><a href="#AgentMemoryManager-338"><span class="linenos"> 338</span></a>            <span class="p">]</span>
</span><span id="AgentMemoryManager-339"><a href="#AgentMemoryManager-339"><span class="linenos"> 339</span></a>
</span><span id="AgentMemoryManager-340"><a href="#AgentMemoryManager-340"><span class="linenos"> 340</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager-341"><a href="#AgentMemoryManager-341"><span class="linenos"> 341</span></a>                <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_options</span><span class="p">:</span>
</span><span id="AgentMemoryManager-342"><a href="#AgentMemoryManager-342"><span class="linenos"> 342</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-343"><a href="#AgentMemoryManager-343"><span class="linenos"> 343</span></a>                        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-344"><a href="#AgentMemoryManager-344"><span class="linenos"> 344</span></a>                            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager-345"><a href="#AgentMemoryManager-345"><span class="linenos"> 345</span></a>                                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentMemoryManager-346"><a href="#AgentMemoryManager-346"><span class="linenos"> 346</span></a>                                <span class="c1"># Handle different response formats</span>
</span><span id="AgentMemoryManager-347"><a href="#AgentMemoryManager-347"><span class="linenos"> 347</span></a>                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="AgentMemoryManager-348"><a href="#AgentMemoryManager-348"><span class="linenos"> 348</span></a>                                    <span class="n">exists</span> <span class="o">=</span> <span class="n">result</span>
</span><span id="AgentMemoryManager-349"><a href="#AgentMemoryManager-349"><span class="linenos"> 349</span></a>                                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="AgentMemoryManager-350"><a href="#AgentMemoryManager-350"><span class="linenos"> 350</span></a>                                    <span class="n">exists</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exists&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="AgentMemoryManager-351"><a href="#AgentMemoryManager-351"><span class="linenos"> 351</span></a>                                        <span class="s2">&quot;found&quot;</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager-352"><a href="#AgentMemoryManager-352"><span class="linenos"> 352</span></a>                                    <span class="p">)</span>
</span><span id="AgentMemoryManager-353"><a href="#AgentMemoryManager-353"><span class="linenos"> 353</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-354"><a href="#AgentMemoryManager-354"><span class="linenos"> 354</span></a>                                    <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager-355"><a href="#AgentMemoryManager-355"><span class="linenos"> 355</span></a>
</span><span id="AgentMemoryManager-356"><a href="#AgentMemoryManager-356"><span class="linenos"> 356</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="AgentMemoryManager-357"><a href="#AgentMemoryManager-357"><span class="linenos"> 357</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2"> exists: </span><span class="si">{</span><span class="n">exists</span><span class="si">}</span><span class="s2"> (params: </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="AgentMemoryManager-358"><a href="#AgentMemoryManager-358"><span class="linenos"> 358</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager-359"><a href="#AgentMemoryManager-359"><span class="linenos"> 359</span></a>                                <span class="k">return</span> <span class="n">exists</span>
</span><span id="AgentMemoryManager-360"><a href="#AgentMemoryManager-360"><span class="linenos"> 360</span></a>                            <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
</span><span id="AgentMemoryManager-361"><a href="#AgentMemoryManager-361"><span class="linenos"> 361</span></a>                                <span class="c1"># Try next parameter format</span>
</span><span id="AgentMemoryManager-362"><a href="#AgentMemoryManager-362"><span class="linenos"> 362</span></a>                                <span class="k">continue</span>
</span><span id="AgentMemoryManager-363"><a href="#AgentMemoryManager-363"><span class="linenos"> 363</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-364"><a href="#AgentMemoryManager-364"><span class="linenos"> 364</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager-365"><a href="#AgentMemoryManager-365"><span class="linenos"> 365</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Failed to check entity existence for </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-366"><a href="#AgentMemoryManager-366"><span class="linenos"> 366</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager-367"><a href="#AgentMemoryManager-367"><span class="linenos"> 367</span></a>                                <span class="k">break</span>
</span><span id="AgentMemoryManager-368"><a href="#AgentMemoryManager-368"><span class="linenos"> 368</span></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-369"><a href="#AgentMemoryManager-369"><span class="linenos"> 369</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error with params </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-370"><a href="#AgentMemoryManager-370"><span class="linenos"> 370</span></a>                        <span class="k">continue</span>
</span><span id="AgentMemoryManager-371"><a href="#AgentMemoryManager-371"><span class="linenos"> 371</span></a>
</span><span id="AgentMemoryManager-372"><a href="#AgentMemoryManager-372"><span class="linenos"> 372</span></a>                <span class="c1"># If all parameter formats fail, fall back to label list approach</span>
</span><span id="AgentMemoryManager-373"><a href="#AgentMemoryManager-373"><span class="linenos"> 373</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="AgentMemoryManager-374"><a href="#AgentMemoryManager-374"><span class="linenos"> 374</span></a>                    <span class="sa">f</span><span class="s2">&quot;All parameter formats failed for </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">, falling back to label list&quot;</span>
</span><span id="AgentMemoryManager-375"><a href="#AgentMemoryManager-375"><span class="linenos"> 375</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-376"><a href="#AgentMemoryManager-376"><span class="linenos"> 376</span></a>                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/label/list&quot;</span>
</span><span id="AgentMemoryManager-377"><a href="#AgentMemoryManager-377"><span class="linenos"> 377</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-378"><a href="#AgentMemoryManager-378"><span class="linenos"> 378</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager-379"><a href="#AgentMemoryManager-379"><span class="linenos"> 379</span></a>                        <span class="n">labels_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentMemoryManager-380"><a href="#AgentMemoryManager-380"><span class="linenos"> 380</span></a>
</span><span id="AgentMemoryManager-381"><a href="#AgentMemoryManager-381"><span class="linenos"> 381</span></a>                        <span class="c1"># Handle both response formats: direct array or dict with &#39;labels&#39; key</span>
</span><span id="AgentMemoryManager-382"><a href="#AgentMemoryManager-382"><span class="linenos"> 382</span></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager-383"><a href="#AgentMemoryManager-383"><span class="linenos"> 383</span></a>                            <span class="n">all_labels</span> <span class="o">=</span> <span class="n">labels_data</span>
</span><span id="AgentMemoryManager-384"><a href="#AgentMemoryManager-384"><span class="linenos"> 384</span></a>                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="n">labels_data</span><span class="p">:</span>
</span><span id="AgentMemoryManager-385"><a href="#AgentMemoryManager-385"><span class="linenos"> 385</span></a>                            <span class="n">all_labels</span> <span class="o">=</span> <span class="n">labels_data</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager-386"><a href="#AgentMemoryManager-386"><span class="linenos"> 386</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-387"><a href="#AgentMemoryManager-387"><span class="linenos"> 387</span></a>                            <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-388"><a href="#AgentMemoryManager-388"><span class="linenos"> 388</span></a>
</span><span id="AgentMemoryManager-389"><a href="#AgentMemoryManager-389"><span class="linenos"> 389</span></a>                        <span class="c1"># Check if entity name exists in labels (case-insensitive)</span>
</span><span id="AgentMemoryManager-390"><a href="#AgentMemoryManager-390"><span class="linenos"> 390</span></a>                        <span class="n">exists</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="AgentMemoryManager-391"><a href="#AgentMemoryManager-391"><span class="linenos"> 391</span></a>                            <span class="n">label</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">entity_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">all_labels</span>
</span><span id="AgentMemoryManager-392"><a href="#AgentMemoryManager-392"><span class="linenos"> 392</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager-393"><a href="#AgentMemoryManager-393"><span class="linenos"> 393</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="AgentMemoryManager-394"><a href="#AgentMemoryManager-394"><span class="linenos"> 394</span></a>                            <span class="sa">f</span><span class="s2">&quot;Entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2"> exists (via labels): </span><span class="si">{</span><span class="n">exists</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-395"><a href="#AgentMemoryManager-395"><span class="linenos"> 395</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager-396"><a href="#AgentMemoryManager-396"><span class="linenos"> 396</span></a>                        <span class="k">return</span> <span class="n">exists</span>
</span><span id="AgentMemoryManager-397"><a href="#AgentMemoryManager-397"><span class="linenos"> 397</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-398"><a href="#AgentMemoryManager-398"><span class="linenos"> 398</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager-399"><a href="#AgentMemoryManager-399"><span class="linenos"> 399</span></a>                            <span class="sa">f</span><span class="s2">&quot;Failed to get graph labels for entity check: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-400"><a href="#AgentMemoryManager-400"><span class="linenos"> 400</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager-401"><a href="#AgentMemoryManager-401"><span class="linenos"> 401</span></a>                        <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager-402"><a href="#AgentMemoryManager-402"><span class="linenos"> 402</span></a>
</span><span id="AgentMemoryManager-403"><a href="#AgentMemoryManager-403"><span class="linenos"> 403</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-404"><a href="#AgentMemoryManager-404"><span class="linenos"> 404</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking entity existence for </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-405"><a href="#AgentMemoryManager-405"><span class="linenos"> 405</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager-406"><a href="#AgentMemoryManager-406"><span class="linenos"> 406</span></a>
</span><span id="AgentMemoryManager-407"><a href="#AgentMemoryManager-407"><span class="linenos"> 407</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">clear_all_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-408"><a href="#AgentMemoryManager-408"><span class="linenos"> 408</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all memories from both SQLite and LightRAG systems.</span>
</span><span id="AgentMemoryManager-409"><a href="#AgentMemoryManager-409"><span class="linenos"> 409</span></a>
</span><span id="AgentMemoryManager-410"><a href="#AgentMemoryManager-410"><span class="linenos"> 410</span></a><span class="sd">        This method provides a complete reset of the dual memory system by:</span>
</span><span id="AgentMemoryManager-411"><a href="#AgentMemoryManager-411"><span class="linenos"> 411</span></a><span class="sd">        1. Clearing all memories from the local SQLite database</span>
</span><span id="AgentMemoryManager-412"><a href="#AgentMemoryManager-412"><span class="linenos"> 412</span></a><span class="sd">        2. Clearing all documents from the LightRAG memory server</span>
</span><span id="AgentMemoryManager-413"><a href="#AgentMemoryManager-413"><span class="linenos"> 413</span></a><span class="sd">        3. Deleting the knowledge graph file</span>
</span><span id="AgentMemoryManager-414"><a href="#AgentMemoryManager-414"><span class="linenos"> 414</span></a>
</span><span id="AgentMemoryManager-415"><a href="#AgentMemoryManager-415"><span class="linenos"> 415</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-416"><a href="#AgentMemoryManager-416"><span class="linenos"> 416</span></a><span class="sd">            str: Success or error message</span>
</span><span id="AgentMemoryManager-417"><a href="#AgentMemoryManager-417"><span class="linenos"> 417</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-418"><a href="#AgentMemoryManager-418"><span class="linenos"> 418</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-419"><a href="#AgentMemoryManager-419"><span class="linenos"> 419</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-420"><a href="#AgentMemoryManager-420"><span class="linenos"> 420</span></a>
</span><span id="AgentMemoryManager-421"><a href="#AgentMemoryManager-421"><span class="linenos"> 421</span></a>            <span class="c1"># 1. Clear local SQLite memories</span>
</span><span id="AgentMemoryManager-422"><a href="#AgentMemoryManager-422"><span class="linenos"> 422</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="p">:</span>
</span><span id="AgentMemoryManager-423"><a href="#AgentMemoryManager-423"><span class="linenos"> 423</span></a>                <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">clear_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager-424"><a href="#AgentMemoryManager-424"><span class="linenos"> 424</span></a>                    <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager-425"><a href="#AgentMemoryManager-425"><span class="linenos"> 425</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-426"><a href="#AgentMemoryManager-426"><span class="linenos"> 426</span></a>
</span><span id="AgentMemoryManager-427"><a href="#AgentMemoryManager-427"><span class="linenos"> 427</span></a>                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="AgentMemoryManager-428"><a href="#AgentMemoryManager-428"><span class="linenos"> 428</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-429"><a href="#AgentMemoryManager-429"><span class="linenos"> 429</span></a>                        <span class="s2">&quot;Cleared all memories from SQLite for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager-430"><a href="#AgentMemoryManager-430"><span class="linenos"> 430</span></a>                    <span class="p">)</span>
</span><span id="AgentMemoryManager-431"><a href="#AgentMemoryManager-431"><span class="linenos"> 431</span></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Local memory: All memories cleared successfully&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-432"><a href="#AgentMemoryManager-432"><span class="linenos"> 432</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-433"><a href="#AgentMemoryManager-433"><span class="linenos"> 433</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to clear memories from SQLite: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span><span id="AgentMemoryManager-434"><a href="#AgentMemoryManager-434"><span class="linenos"> 434</span></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Local memory error: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-435"><a href="#AgentMemoryManager-435"><span class="linenos"> 435</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-436"><a href="#AgentMemoryManager-436"><span class="linenos"> 436</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager-437"><a href="#AgentMemoryManager-437"><span class="linenos"> 437</span></a>                    <span class="s2">&quot;Memory system not initialized, skipping SQLite memory clear&quot;</span>
</span><span id="AgentMemoryManager-438"><a href="#AgentMemoryManager-438"><span class="linenos"> 438</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-439"><a href="#AgentMemoryManager-439"><span class="linenos"> 439</span></a>                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Local memory: System not initialized&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-440"><a href="#AgentMemoryManager-440"><span class="linenos"> 440</span></a>
</span><span id="AgentMemoryManager-441"><a href="#AgentMemoryManager-441"><span class="linenos"> 441</span></a>            <span class="c1"># 2. Clear LightRAG graph memories</span>
</span><span id="AgentMemoryManager-442"><a href="#AgentMemoryManager-442"><span class="linenos"> 442</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-443"><a href="#AgentMemoryManager-443"><span class="linenos"> 443</span></a>                <span class="c1"># Use LightRAG API to delete all documents</span>
</span><span id="AgentMemoryManager-444"><a href="#AgentMemoryManager-444"><span class="linenos"> 444</span></a>                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents&quot;</span>
</span><span id="AgentMemoryManager-445"><a href="#AgentMemoryManager-445"><span class="linenos"> 445</span></a>
</span><span id="AgentMemoryManager-446"><a href="#AgentMemoryManager-446"><span class="linenos"> 446</span></a>                <span class="c1"># First get all documents</span>
</span><span id="AgentMemoryManager-447"><a href="#AgentMemoryManager-447"><span class="linenos"> 447</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager-448"><a href="#AgentMemoryManager-448"><span class="linenos"> 448</span></a>                    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-449"><a href="#AgentMemoryManager-449"><span class="linenos"> 449</span></a>                        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager-450"><a href="#AgentMemoryManager-450"><span class="linenos"> 450</span></a>                            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentMemoryManager-451"><a href="#AgentMemoryManager-451"><span class="linenos"> 451</span></a>                            <span class="n">all_docs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-452"><a href="#AgentMemoryManager-452"><span class="linenos"> 452</span></a>
</span><span id="AgentMemoryManager-453"><a href="#AgentMemoryManager-453"><span class="linenos"> 453</span></a>                            <span class="c1"># Extract documents from response</span>
</span><span id="AgentMemoryManager-454"><a href="#AgentMemoryManager-454"><span class="linenos"> 454</span></a>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;statuses&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="AgentMemoryManager-455"><a href="#AgentMemoryManager-455"><span class="linenos"> 455</span></a>                                <span class="n">statuses</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;statuses&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager-456"><a href="#AgentMemoryManager-456"><span class="linenos"> 456</span></a>                                <span class="k">for</span> <span class="n">status_name</span><span class="p">,</span> <span class="n">docs_list</span> <span class="ow">in</span> <span class="n">statuses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AgentMemoryManager-457"><a href="#AgentMemoryManager-457"><span class="linenos"> 457</span></a>                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager-458"><a href="#AgentMemoryManager-458"><span class="linenos"> 458</span></a>                                        <span class="n">all_docs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">docs_list</span><span class="p">)</span>
</span><span id="AgentMemoryManager-459"><a href="#AgentMemoryManager-459"><span class="linenos"> 459</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;documents&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="AgentMemoryManager-460"><a href="#AgentMemoryManager-460"><span class="linenos"> 460</span></a>                                <span class="n">all_docs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;documents&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager-461"><a href="#AgentMemoryManager-461"><span class="linenos"> 461</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager-462"><a href="#AgentMemoryManager-462"><span class="linenos"> 462</span></a>                                <span class="n">all_docs</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="AgentMemoryManager-463"><a href="#AgentMemoryManager-463"><span class="linenos"> 463</span></a>
</span><span id="AgentMemoryManager-464"><a href="#AgentMemoryManager-464"><span class="linenos"> 464</span></a>                            <span class="k">if</span> <span class="n">all_docs</span><span class="p">:</span>
</span><span id="AgentMemoryManager-465"><a href="#AgentMemoryManager-465"><span class="linenos"> 465</span></a>                                <span class="c1"># Delete all documents</span>
</span><span id="AgentMemoryManager-466"><a href="#AgentMemoryManager-466"><span class="linenos"> 466</span></a>                                <span class="n">doc_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">all_docs</span><span class="p">]</span>
</span><span id="AgentMemoryManager-467"><a href="#AgentMemoryManager-467"><span class="linenos"> 467</span></a>                                <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;doc_ids&quot;</span><span class="p">:</span> <span class="n">doc_ids</span><span class="p">,</span> <span class="s2">&quot;delete_file&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span><span id="AgentMemoryManager-468"><a href="#AgentMemoryManager-468"><span class="linenos"> 468</span></a>
</span><span id="AgentMemoryManager-469"><a href="#AgentMemoryManager-469"><span class="linenos"> 469</span></a>                                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
</span><span id="AgentMemoryManager-470"><a href="#AgentMemoryManager-470"><span class="linenos"> 470</span></a>                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents/delete_document&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-471"><a href="#AgentMemoryManager-471"><span class="linenos"> 471</span></a>                                    <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
</span><span id="AgentMemoryManager-472"><a href="#AgentMemoryManager-472"><span class="linenos"> 472</span></a>                                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
</span><span id="AgentMemoryManager-473"><a href="#AgentMemoryManager-473"><span class="linenos"> 473</span></a>                                <span class="p">)</span> <span class="k">as</span> <span class="n">del_resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-474"><a href="#AgentMemoryManager-474"><span class="linenos"> 474</span></a>                                    <span class="k">if</span> <span class="n">del_resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager-475"><a href="#AgentMemoryManager-475"><span class="linenos"> 475</span></a>                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-476"><a href="#AgentMemoryManager-476"><span class="linenos"> 476</span></a>                                            <span class="s2">&quot;Cleared all memories from LightRAG (</span><span class="si">%d</span><span class="s2"> documents)&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-477"><a href="#AgentMemoryManager-477"><span class="linenos"> 477</span></a>                                            <span class="nb">len</span><span class="p">(</span><span class="n">doc_ids</span><span class="p">),</span>
</span><span id="AgentMemoryManager-478"><a href="#AgentMemoryManager-478"><span class="linenos"> 478</span></a>                                        <span class="p">)</span>
</span><span id="AgentMemoryManager-479"><a href="#AgentMemoryManager-479"><span class="linenos"> 479</span></a>                                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AgentMemoryManager-480"><a href="#AgentMemoryManager-480"><span class="linenos"> 480</span></a>                                            <span class="sa">f</span><span class="s2">&quot; Graph memory: All memories cleared successfully (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">doc_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> documents)&quot;</span>
</span><span id="AgentMemoryManager-481"><a href="#AgentMemoryManager-481"><span class="linenos"> 481</span></a>                                        <span class="p">)</span>
</span><span id="AgentMemoryManager-482"><a href="#AgentMemoryManager-482"><span class="linenos"> 482</span></a>                                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-483"><a href="#AgentMemoryManager-483"><span class="linenos"> 483</span></a>                                        <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">del_resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager-484"><a href="#AgentMemoryManager-484"><span class="linenos"> 484</span></a>                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AgentMemoryManager-485"><a href="#AgentMemoryManager-485"><span class="linenos"> 485</span></a>                                            <span class="s2">&quot;Failed to clear memories from LightRAG: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-486"><a href="#AgentMemoryManager-486"><span class="linenos"> 486</span></a>                                            <span class="n">error_text</span><span class="p">,</span>
</span><span id="AgentMemoryManager-487"><a href="#AgentMemoryManager-487"><span class="linenos"> 487</span></a>                                        <span class="p">)</span>
</span><span id="AgentMemoryManager-488"><a href="#AgentMemoryManager-488"><span class="linenos"> 488</span></a>                                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AgentMemoryManager-489"><a href="#AgentMemoryManager-489"><span class="linenos"> 489</span></a>                                            <span class="sa">f</span><span class="s2">&quot; Graph memory error: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-490"><a href="#AgentMemoryManager-490"><span class="linenos"> 490</span></a>                                        <span class="p">)</span>
</span><span id="AgentMemoryManager-491"><a href="#AgentMemoryManager-491"><span class="linenos"> 491</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-492"><a href="#AgentMemoryManager-492"><span class="linenos"> 492</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No documents found in LightRAG to clear&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-493"><a href="#AgentMemoryManager-493"><span class="linenos"> 493</span></a>                                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AgentMemoryManager-494"><a href="#AgentMemoryManager-494"><span class="linenos"> 494</span></a>                                    <span class="s2">&quot; Graph memory: No documents found to clear&quot;</span>
</span><span id="AgentMemoryManager-495"><a href="#AgentMemoryManager-495"><span class="linenos"> 495</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager-496"><a href="#AgentMemoryManager-496"><span class="linenos"> 496</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-497"><a href="#AgentMemoryManager-497"><span class="linenos"> 497</span></a>                            <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager-498"><a href="#AgentMemoryManager-498"><span class="linenos"> 498</span></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AgentMemoryManager-499"><a href="#AgentMemoryManager-499"><span class="linenos"> 499</span></a>                                <span class="s2">&quot;Failed to get documents from LightRAG: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">error_text</span>
</span><span id="AgentMemoryManager-500"><a href="#AgentMemoryManager-500"><span class="linenos"> 500</span></a>                            <span class="p">)</span>
</span><span id="AgentMemoryManager-501"><a href="#AgentMemoryManager-501"><span class="linenos"> 501</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Graph memory error: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-502"><a href="#AgentMemoryManager-502"><span class="linenos"> 502</span></a>
</span><span id="AgentMemoryManager-503"><a href="#AgentMemoryManager-503"><span class="linenos"> 503</span></a>                    <span class="c1"># 3. Clear the knowledge graph file</span>
</span><span id="AgentMemoryManager-504"><a href="#AgentMemoryManager-504"><span class="linenos"> 504</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-505"><a href="#AgentMemoryManager-505"><span class="linenos"> 505</span></a>                        <span class="c1"># Clear cache to ensure all in-memory data is flushed</span>
</span><span id="AgentMemoryManager-506"><a href="#AgentMemoryManager-506"><span class="linenos"> 506</span></a>                        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="AgentMemoryManager-507"><a href="#AgentMemoryManager-507"><span class="linenos"> 507</span></a>                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents/clear_cache&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-508"><a href="#AgentMemoryManager-508"><span class="linenos"> 508</span></a>                            <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;modes&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
</span><span id="AgentMemoryManager-509"><a href="#AgentMemoryManager-509"><span class="linenos"> 509</span></a>                            <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
</span><span id="AgentMemoryManager-510"><a href="#AgentMemoryManager-510"><span class="linenos"> 510</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager-511"><a href="#AgentMemoryManager-511"><span class="linenos"> 511</span></a>
</span><span id="AgentMemoryManager-512"><a href="#AgentMemoryManager-512"><span class="linenos"> 512</span></a>                        <span class="c1"># Delete the knowledge graph files</span>
</span><span id="AgentMemoryManager-513"><a href="#AgentMemoryManager-513"><span class="linenos"> 513</span></a>                        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="AgentMemoryManager-514"><a href="#AgentMemoryManager-514"><span class="linenos"> 514</span></a>
</span><span id="AgentMemoryManager-515"><a href="#AgentMemoryManager-515"><span class="linenos"> 515</span></a>                        <span class="kn">from</span><span class="w"> </span><span class="nn">..config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="AgentMemoryManager-516"><a href="#AgentMemoryManager-516"><span class="linenos"> 516</span></a>                            <span class="n">LIGHTRAG_MEMORY_STORAGE_DIR</span><span class="p">,</span>
</span><span id="AgentMemoryManager-517"><a href="#AgentMemoryManager-517"><span class="linenos"> 517</span></a>                            <span class="n">LIGHTRAG_STORAGE_DIR</span><span class="p">,</span>
</span><span id="AgentMemoryManager-518"><a href="#AgentMemoryManager-518"><span class="linenos"> 518</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager-519"><a href="#AgentMemoryManager-519"><span class="linenos"> 519</span></a>
</span><span id="AgentMemoryManager-520"><a href="#AgentMemoryManager-520"><span class="linenos"> 520</span></a>                        <span class="n">graph_file_paths</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager-521"><a href="#AgentMemoryManager-521"><span class="linenos"> 521</span></a>                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="AgentMemoryManager-522"><a href="#AgentMemoryManager-522"><span class="linenos"> 522</span></a>                                <span class="n">LIGHTRAG_MEMORY_STORAGE_DIR</span><span class="p">,</span>
</span><span id="AgentMemoryManager-523"><a href="#AgentMemoryManager-523"><span class="linenos"> 523</span></a>                                <span class="s2">&quot;graph_chunk_entity_relation.graphml&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-524"><a href="#AgentMemoryManager-524"><span class="linenos"> 524</span></a>                            <span class="p">)</span>
</span><span id="AgentMemoryManager-525"><a href="#AgentMemoryManager-525"><span class="linenos"> 525</span></a>                        <span class="p">]</span>
</span><span id="AgentMemoryManager-526"><a href="#AgentMemoryManager-526"><span class="linenos"> 526</span></a>
</span><span id="AgentMemoryManager-527"><a href="#AgentMemoryManager-527"><span class="linenos"> 527</span></a>                        <span class="n">graph_deleted</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager-528"><a href="#AgentMemoryManager-528"><span class="linenos"> 528</span></a>                        <span class="k">for</span> <span class="n">graph_file_path</span> <span class="ow">in</span> <span class="n">graph_file_paths</span><span class="p">:</span>
</span><span id="AgentMemoryManager-529"><a href="#AgentMemoryManager-529"><span class="linenos"> 529</span></a>                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">graph_file_path</span><span class="p">):</span>
</span><span id="AgentMemoryManager-530"><a href="#AgentMemoryManager-530"><span class="linenos"> 530</span></a>                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">graph_file_path</span><span class="p">)</span>
</span><span id="AgentMemoryManager-531"><a href="#AgentMemoryManager-531"><span class="linenos"> 531</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-532"><a href="#AgentMemoryManager-532"><span class="linenos"> 532</span></a>                                    <span class="s2">&quot;Deleted knowledge graph file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">graph_file_path</span>
</span><span id="AgentMemoryManager-533"><a href="#AgentMemoryManager-533"><span class="linenos"> 533</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager-534"><a href="#AgentMemoryManager-534"><span class="linenos"> 534</span></a>                                <span class="n">graph_deleted</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AgentMemoryManager-535"><a href="#AgentMemoryManager-535"><span class="linenos"> 535</span></a>
</span><span id="AgentMemoryManager-536"><a href="#AgentMemoryManager-536"><span class="linenos"> 536</span></a>                        <span class="k">if</span> <span class="n">graph_deleted</span><span class="p">:</span>
</span><span id="AgentMemoryManager-537"><a href="#AgentMemoryManager-537"><span class="linenos"> 537</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AgentMemoryManager-538"><a href="#AgentMemoryManager-538"><span class="linenos"> 538</span></a>                                <span class="s2">&quot; Knowledge graph: Graph file deleted successfully&quot;</span>
</span><span id="AgentMemoryManager-539"><a href="#AgentMemoryManager-539"><span class="linenos"> 539</span></a>                            <span class="p">)</span>
</span><span id="AgentMemoryManager-540"><a href="#AgentMemoryManager-540"><span class="linenos"> 540</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-541"><a href="#AgentMemoryManager-541"><span class="linenos"> 541</span></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No knowledge graph files found to delete&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-542"><a href="#AgentMemoryManager-542"><span class="linenos"> 542</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AgentMemoryManager-543"><a href="#AgentMemoryManager-543"><span class="linenos"> 543</span></a>                                <span class="s2">&quot; Knowledge graph: No graph files found to delete&quot;</span>
</span><span id="AgentMemoryManager-544"><a href="#AgentMemoryManager-544"><span class="linenos"> 544</span></a>                            <span class="p">)</span>
</span><span id="AgentMemoryManager-545"><a href="#AgentMemoryManager-545"><span class="linenos"> 545</span></a>
</span><span id="AgentMemoryManager-546"><a href="#AgentMemoryManager-546"><span class="linenos"> 546</span></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-547"><a href="#AgentMemoryManager-547"><span class="linenos"> 547</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error deleting knowledge graph file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-548"><a href="#AgentMemoryManager-548"><span class="linenos"> 548</span></a>                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Knowledge graph error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-549"><a href="#AgentMemoryManager-549"><span class="linenos"> 549</span></a>
</span><span id="AgentMemoryManager-550"><a href="#AgentMemoryManager-550"><span class="linenos"> 550</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-551"><a href="#AgentMemoryManager-551"><span class="linenos"> 551</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error clearing LightRAG memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-552"><a href="#AgentMemoryManager-552"><span class="linenos"> 552</span></a>                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Graph memory error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-553"><a href="#AgentMemoryManager-553"><span class="linenos"> 553</span></a>
</span><span id="AgentMemoryManager-554"><a href="#AgentMemoryManager-554"><span class="linenos"> 554</span></a>            <span class="c1"># Return combined results</span>
</span><span id="AgentMemoryManager-555"><a href="#AgentMemoryManager-555"><span class="linenos"> 555</span></a>            <span class="k">return</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="AgentMemoryManager-556"><a href="#AgentMemoryManager-556"><span class="linenos"> 556</span></a>
</span><span id="AgentMemoryManager-557"><a href="#AgentMemoryManager-557"><span class="linenos"> 557</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-558"><a href="#AgentMemoryManager-558"><span class="linenos"> 558</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error clearing all memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-559"><a href="#AgentMemoryManager-559"><span class="linenos"> 559</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error clearing all memories: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-560"><a href="#AgentMemoryManager-560"><span class="linenos"> 560</span></a>
</span><span id="AgentMemoryManager-561"><a href="#AgentMemoryManager-561"><span class="linenos"> 561</span></a>    <span class="c1"># The following methods will be implemented in subsequent phases</span>
</span><span id="AgentMemoryManager-562"><a href="#AgentMemoryManager-562"><span class="linenos"> 562</span></a>    <span class="c1"># They are placeholders for now</span>
</span><span id="AgentMemoryManager-563"><a href="#AgentMemoryManager-563"><span class="linenos"> 563</span></a>
</span><span id="AgentMemoryManager-564"><a href="#AgentMemoryManager-564"><span class="linenos"> 564</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-565"><a href="#AgentMemoryManager-565"><span class="linenos"> 565</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Search user memories using direct SemanticMemoryManager calls.</span>
</span><span id="AgentMemoryManager-566"><a href="#AgentMemoryManager-566"><span class="linenos"> 566</span></a>
</span><span id="AgentMemoryManager-567"><a href="#AgentMemoryManager-567"><span class="linenos"> 567</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-568"><a href="#AgentMemoryManager-568"><span class="linenos"> 568</span></a><span class="sd">            query: The query to search for in memories</span>
</span><span id="AgentMemoryManager-569"><a href="#AgentMemoryManager-569"><span class="linenos"> 569</span></a><span class="sd">            limit: Maximum number of memories to return</span>
</span><span id="AgentMemoryManager-570"><a href="#AgentMemoryManager-570"><span class="linenos"> 570</span></a>
</span><span id="AgentMemoryManager-571"><a href="#AgentMemoryManager-571"><span class="linenos"> 571</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-572"><a href="#AgentMemoryManager-572"><span class="linenos"> 572</span></a><span class="sd">            str: Found memories or message if none found</span>
</span><span id="AgentMemoryManager-573"><a href="#AgentMemoryManager-573"><span class="linenos"> 573</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-574"><a href="#AgentMemoryManager-574"><span class="linenos"> 574</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-575"><a href="#AgentMemoryManager-575"><span class="linenos"> 575</span></a>            <span class="n">stripped_query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AgentMemoryManager-576"><a href="#AgentMemoryManager-576"><span class="linenos"> 576</span></a>
</span><span id="AgentMemoryManager-577"><a href="#AgentMemoryManager-577"><span class="linenos"> 577</span></a>            <span class="c1"># List of phrases that should trigger get_all_memories instead of search</span>
</span><span id="AgentMemoryManager-578"><a href="#AgentMemoryManager-578"><span class="linenos"> 578</span></a>            <span class="n">get_all_phrases</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager-579"><a href="#AgentMemoryManager-579"><span class="linenos"> 579</span></a>                <span class="s2">&quot;all&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-580"><a href="#AgentMemoryManager-580"><span class="linenos"> 580</span></a>                <span class="s2">&quot;all memories&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-581"><a href="#AgentMemoryManager-581"><span class="linenos"> 581</span></a>                <span class="s2">&quot;everything&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-582"><a href="#AgentMemoryManager-582"><span class="linenos"> 582</span></a>                <span class="s2">&quot;summarize all memories&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-583"><a href="#AgentMemoryManager-583"><span class="linenos"> 583</span></a>                <span class="s2">&quot;what do you know about me&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-584"><a href="#AgentMemoryManager-584"><span class="linenos"> 584</span></a>                <span class="s2">&quot;what have i told you&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-585"><a href="#AgentMemoryManager-585"><span class="linenos"> 585</span></a>                <span class="s2">&quot;list all memories&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-586"><a href="#AgentMemoryManager-586"><span class="linenos"> 586</span></a>                <span class="s2">&quot;show all memories&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-587"><a href="#AgentMemoryManager-587"><span class="linenos"> 587</span></a>                <span class="s2">&quot;tell me everything&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-588"><a href="#AgentMemoryManager-588"><span class="linenos"> 588</span></a>                <span class="s2">&quot;list everything you know&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-589"><a href="#AgentMemoryManager-589"><span class="linenos"> 589</span></a>            <span class="p">]</span>
</span><span id="AgentMemoryManager-590"><a href="#AgentMemoryManager-590"><span class="linenos"> 590</span></a>
</span><span id="AgentMemoryManager-591"><a href="#AgentMemoryManager-591"><span class="linenos"> 591</span></a>            <span class="c1"># Check for explicit &quot;do not interpret&quot; or &quot;just list&quot; requests</span>
</span><span id="AgentMemoryManager-592"><a href="#AgentMemoryManager-592"><span class="linenos"> 592</span></a>            <span class="n">no_interpret_phrases</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager-593"><a href="#AgentMemoryManager-593"><span class="linenos"> 593</span></a>                <span class="s2">&quot;do not interpret&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-594"><a href="#AgentMemoryManager-594"><span class="linenos"> 594</span></a>                <span class="s2">&quot;don&#39;t interpret&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-595"><a href="#AgentMemoryManager-595"><span class="linenos"> 595</span></a>                <span class="s2">&quot;just list&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-596"><a href="#AgentMemoryManager-596"><span class="linenos"> 596</span></a>                <span class="s2">&quot;just show&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-597"><a href="#AgentMemoryManager-597"><span class="linenos"> 597</span></a>                <span class="s2">&quot;raw list&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-598"><a href="#AgentMemoryManager-598"><span class="linenos"> 598</span></a>                <span class="s2">&quot;simple list&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-599"><a href="#AgentMemoryManager-599"><span class="linenos"> 599</span></a>                <span class="s2">&quot;list them&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-600"><a href="#AgentMemoryManager-600"><span class="linenos"> 600</span></a>                <span class="s2">&quot;show them&quot;</span>
</span><span id="AgentMemoryManager-601"><a href="#AgentMemoryManager-601"><span class="linenos"> 601</span></a>            <span class="p">]</span>
</span><span id="AgentMemoryManager-602"><a href="#AgentMemoryManager-602"><span class="linenos"> 602</span></a>            
</span><span id="AgentMemoryManager-603"><a href="#AgentMemoryManager-603"><span class="linenos"> 603</span></a>            <span class="n">should_skip_interpretation</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">phrase</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="n">no_interpret_phrases</span><span class="p">)</span>
</span><span id="AgentMemoryManager-604"><a href="#AgentMemoryManager-604"><span class="linenos"> 604</span></a>
</span><span id="AgentMemoryManager-605"><a href="#AgentMemoryManager-605"><span class="linenos"> 605</span></a>            <span class="k">if</span> <span class="n">stripped_query</span> <span class="ow">in</span> <span class="n">get_all_phrases</span> <span class="ow">or</span> <span class="s2">&quot;list all memories&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="AgentMemoryManager-606"><a href="#AgentMemoryManager-606"><span class="linenos"> 606</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-607"><a href="#AgentMemoryManager-607"><span class="linenos"> 607</span></a>                    <span class="s2">&quot;Generic/list query &#39;</span><span class="si">%s</span><span class="s2">&#39; detected. Using optimized list_memories for performance.&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-608"><a href="#AgentMemoryManager-608"><span class="linenos"> 608</span></a>                    <span class="n">query</span><span class="p">,</span>
</span><span id="AgentMemoryManager-609"><a href="#AgentMemoryManager-609"><span class="linenos"> 609</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-610"><a href="#AgentMemoryManager-610"><span class="linenos"> 610</span></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_memories</span><span class="p">()</span>
</span><span id="AgentMemoryManager-611"><a href="#AgentMemoryManager-611"><span class="linenos"> 611</span></a>
</span><span id="AgentMemoryManager-612"><a href="#AgentMemoryManager-612"><span class="linenos"> 612</span></a>            <span class="c1"># Validate query parameter</span>
</span><span id="AgentMemoryManager-613"><a href="#AgentMemoryManager-613"><span class="linenos"> 613</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="AgentMemoryManager-614"><a href="#AgentMemoryManager-614"><span class="linenos"> 614</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Empty query provided to query_memory&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-615"><a href="#AgentMemoryManager-615"><span class="linenos"> 615</span></a>                <span class="k">return</span> <span class="s2">&quot; Error: Query cannot be empty. Please provide a search term.&quot;</span>
</span><span id="AgentMemoryManager-616"><a href="#AgentMemoryManager-616"><span class="linenos"> 616</span></a>
</span><span id="AgentMemoryManager-617"><a href="#AgentMemoryManager-617"><span class="linenos"> 617</span></a>            <span class="c1"># Direct call to SemanticMemoryManager.search_memories()</span>
</span><span id="AgentMemoryManager-618"><a href="#AgentMemoryManager-618"><span class="linenos"> 618</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">search_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager-619"><a href="#AgentMemoryManager-619"><span class="linenos"> 619</span></a>                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
</span><span id="AgentMemoryManager-620"><a href="#AgentMemoryManager-620"><span class="linenos"> 620</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
</span><span id="AgentMemoryManager-621"><a href="#AgentMemoryManager-621"><span class="linenos"> 621</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager-622"><a href="#AgentMemoryManager-622"><span class="linenos"> 622</span></a>                <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
</span><span id="AgentMemoryManager-623"><a href="#AgentMemoryManager-623"><span class="linenos"> 623</span></a>                <span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="AgentMemoryManager-624"><a href="#AgentMemoryManager-624"><span class="linenos"> 624</span></a>                <span class="n">search_topics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager-625"><a href="#AgentMemoryManager-625"><span class="linenos"> 625</span></a>                <span class="n">topic_boost</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="AgentMemoryManager-626"><a href="#AgentMemoryManager-626"><span class="linenos"> 626</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-627"><a href="#AgentMemoryManager-627"><span class="linenos"> 627</span></a>
</span><span id="AgentMemoryManager-628"><a href="#AgentMemoryManager-628"><span class="linenos"> 628</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
</span><span id="AgentMemoryManager-629"><a href="#AgentMemoryManager-629"><span class="linenos"> 629</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No matching memories found for query: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
</span><span id="AgentMemoryManager-630"><a href="#AgentMemoryManager-630"><span class="linenos"> 630</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; No memories found for &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;. Try different keywords or ask me to remember something new!&quot;</span>
</span><span id="AgentMemoryManager-631"><a href="#AgentMemoryManager-631"><span class="linenos"> 631</span></a>
</span><span id="AgentMemoryManager-632"><a href="#AgentMemoryManager-632"><span class="linenos"> 632</span></a>            <span class="c1"># Format results</span>
</span><span id="AgentMemoryManager-633"><a href="#AgentMemoryManager-633"><span class="linenos"> 633</span></a>            <span class="n">display_memories</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">results</span>
</span><span id="AgentMemoryManager-634"><a href="#AgentMemoryManager-634"><span class="linenos"> 634</span></a>            <span class="n">result_note</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; MEMORY RETRIEVAL (found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> matches via semantic search)&quot;</span>
</span><span id="AgentMemoryManager-635"><a href="#AgentMemoryManager-635"><span class="linenos"> 635</span></a>
</span><span id="AgentMemoryManager-636"><a href="#AgentMemoryManager-636"><span class="linenos"> 636</span></a>            <span class="k">if</span> <span class="n">should_skip_interpretation</span><span class="p">:</span>
</span><span id="AgentMemoryManager-637"><a href="#AgentMemoryManager-637"><span class="linenos"> 637</span></a>                <span class="c1"># PERFORMANCE OPTIMIZED: Skip interpretation instructions for explicit listing requests</span>
</span><span id="AgentMemoryManager-638"><a href="#AgentMemoryManager-638"><span class="linenos"> 638</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_note</span><span class="si">}</span><span class="s2">: The following memories were found for &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-639"><a href="#AgentMemoryManager-639"><span class="linenos"> 639</span></a>                
</span><span id="AgentMemoryManager-640"><a href="#AgentMemoryManager-640"><span class="linenos"> 640</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">display_memories</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AgentMemoryManager-641"><a href="#AgentMemoryManager-641"><span class="linenos"> 641</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2"> (similarity: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-642"><a href="#AgentMemoryManager-642"><span class="linenos"> 642</span></a>                    <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-643"><a href="#AgentMemoryManager-643"><span class="linenos"> 643</span></a>                        <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-644"><a href="#AgentMemoryManager-644"><span class="linenos"> 644</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-645"><a href="#AgentMemoryManager-645"><span class="linenos"> 645</span></a>                    
</span><span id="AgentMemoryManager-646"><a href="#AgentMemoryManager-646"><span class="linenos"> 646</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> matching memories for query: </span><span class="si">%s</span><span class="s2"> (no interpretation mode)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">query</span><span class="p">)</span>
</span><span id="AgentMemoryManager-647"><a href="#AgentMemoryManager-647"><span class="linenos"> 647</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-648"><a href="#AgentMemoryManager-648"><span class="linenos"> 648</span></a>                <span class="c1"># Standard mode with interpretation instructions</span>
</span><span id="AgentMemoryManager-649"><a href="#AgentMemoryManager-649"><span class="linenos"> 649</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_note</span><span class="si">}</span><span class="s2">: The following memories were found for &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;. You must restate this information addressing the user as &#39;you&#39; (second person), not as if you are the user:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-650"><a href="#AgentMemoryManager-650"><span class="linenos"> 650</span></a>
</span><span id="AgentMemoryManager-651"><a href="#AgentMemoryManager-651"><span class="linenos"> 651</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">display_memories</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AgentMemoryManager-652"><a href="#AgentMemoryManager-652"><span class="linenos"> 652</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2"> (similarity: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-653"><a href="#AgentMemoryManager-653"><span class="linenos"> 653</span></a>                    <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-654"><a href="#AgentMemoryManager-654"><span class="linenos"> 654</span></a>                        <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-655"><a href="#AgentMemoryManager-655"><span class="linenos"> 655</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-656"><a href="#AgentMemoryManager-656"><span class="linenos"> 656</span></a>
</span><span id="AgentMemoryManager-657"><a href="#AgentMemoryManager-657"><span class="linenos"> 657</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">REMEMBER: Restate this information as an AI assistant talking ABOUT the user, not AS the user. Use &#39;you&#39; instead of &#39;I&#39; when referring to the user&#39;s information.&quot;</span>
</span><span id="AgentMemoryManager-658"><a href="#AgentMemoryManager-658"><span class="linenos"> 658</span></a>                
</span><span id="AgentMemoryManager-659"><a href="#AgentMemoryManager-659"><span class="linenos"> 659</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> matching memories for query: </span><span class="si">%s</span><span class="s2"> (standard mode)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">query</span><span class="p">)</span>
</span><span id="AgentMemoryManager-660"><a href="#AgentMemoryManager-660"><span class="linenos"> 660</span></a>
</span><span id="AgentMemoryManager-661"><a href="#AgentMemoryManager-661"><span class="linenos"> 661</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager-662"><a href="#AgentMemoryManager-662"><span class="linenos"> 662</span></a>
</span><span id="AgentMemoryManager-663"><a href="#AgentMemoryManager-663"><span class="linenos"> 663</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-664"><a href="#AgentMemoryManager-664"><span class="linenos"> 664</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error querying memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-665"><a href="#AgentMemoryManager-665"><span class="linenos"> 665</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error searching memories: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-666"><a href="#AgentMemoryManager-666"><span class="linenos"> 666</span></a>
</span><span id="AgentMemoryManager-667"><a href="#AgentMemoryManager-667"><span class="linenos"> 667</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager-668"><a href="#AgentMemoryManager-668"><span class="linenos"> 668</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager-669"><a href="#AgentMemoryManager-669"><span class="linenos"> 669</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-670"><a href="#AgentMemoryManager-670"><span class="linenos"> 670</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update an existing memory using direct SemanticMemoryManager calls.</span>
</span><span id="AgentMemoryManager-671"><a href="#AgentMemoryManager-671"><span class="linenos"> 671</span></a>
</span><span id="AgentMemoryManager-672"><a href="#AgentMemoryManager-672"><span class="linenos"> 672</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-673"><a href="#AgentMemoryManager-673"><span class="linenos"> 673</span></a><span class="sd">            memory_id: ID of the memory to update</span>
</span><span id="AgentMemoryManager-674"><a href="#AgentMemoryManager-674"><span class="linenos"> 674</span></a><span class="sd">            content: New memory content</span>
</span><span id="AgentMemoryManager-675"><a href="#AgentMemoryManager-675"><span class="linenos"> 675</span></a><span class="sd">            topics: Optional list of topics/categories for the memory</span>
</span><span id="AgentMemoryManager-676"><a href="#AgentMemoryManager-676"><span class="linenos"> 676</span></a>
</span><span id="AgentMemoryManager-677"><a href="#AgentMemoryManager-677"><span class="linenos"> 677</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-678"><a href="#AgentMemoryManager-678"><span class="linenos"> 678</span></a><span class="sd">            str: Success or error message</span>
</span><span id="AgentMemoryManager-679"><a href="#AgentMemoryManager-679"><span class="linenos"> 679</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-680"><a href="#AgentMemoryManager-680"><span class="linenos"> 680</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-681"><a href="#AgentMemoryManager-681"><span class="linenos"> 681</span></a>            <span class="c1"># SIMPLIFIED TOPIC HANDLING: Handle the common cases simply</span>
</span><span id="AgentMemoryManager-682"><a href="#AgentMemoryManager-682"><span class="linenos"> 682</span></a>            <span class="k">if</span> <span class="n">topics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AgentMemoryManager-683"><a href="#AgentMemoryManager-683"><span class="linenos"> 683</span></a>                <span class="c1"># Leave as None - let memory manager auto-classify</span>
</span><span id="AgentMemoryManager-684"><a href="#AgentMemoryManager-684"><span class="linenos"> 684</span></a>                <span class="k">pass</span>
</span><span id="AgentMemoryManager-685"><a href="#AgentMemoryManager-685"><span class="linenos"> 685</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AgentMemoryManager-686"><a href="#AgentMemoryManager-686"><span class="linenos"> 686</span></a>                <span class="c1"># Convert string to list, handle comma-separated values</span>
</span><span id="AgentMemoryManager-687"><a href="#AgentMemoryManager-687"><span class="linenos"> 687</span></a>                <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-688"><a href="#AgentMemoryManager-688"><span class="linenos"> 688</span></a>                    <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager-689"><a href="#AgentMemoryManager-689"><span class="linenos"> 689</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-690"><a href="#AgentMemoryManager-690"><span class="linenos"> 690</span></a>                    <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">if</span> <span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager-691"><a href="#AgentMemoryManager-691"><span class="linenos"> 691</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager-692"><a href="#AgentMemoryManager-692"><span class="linenos"> 692</span></a>                <span class="c1"># Clean up list - remove empty entries</span>
</span><span id="AgentMemoryManager-693"><a href="#AgentMemoryManager-693"><span class="linenos"> 693</span></a>                <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager-694"><a href="#AgentMemoryManager-694"><span class="linenos"> 694</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-695"><a href="#AgentMemoryManager-695"><span class="linenos"> 695</span></a>                    <span class="n">topics</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager-696"><a href="#AgentMemoryManager-696"><span class="linenos"> 696</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-697"><a href="#AgentMemoryManager-697"><span class="linenos"> 697</span></a>                <span class="c1"># Convert anything else to string and put in list</span>
</span><span id="AgentMemoryManager-698"><a href="#AgentMemoryManager-698"><span class="linenos"> 698</span></a>                <span class="n">topic_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AgentMemoryManager-699"><a href="#AgentMemoryManager-699"><span class="linenos"> 699</span></a>                <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">topic_str</span><span class="p">]</span> <span class="k">if</span> <span class="n">topic_str</span> <span class="ow">and</span> <span class="n">topic_str</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager-700"><a href="#AgentMemoryManager-700"><span class="linenos"> 700</span></a>
</span><span id="AgentMemoryManager-701"><a href="#AgentMemoryManager-701"><span class="linenos"> 701</span></a>            <span class="c1"># Direct call to SemanticMemoryManager.update_memory()</span>
</span><span id="AgentMemoryManager-702"><a href="#AgentMemoryManager-702"><span class="linenos"> 702</span></a>            <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">update_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager-703"><a href="#AgentMemoryManager-703"><span class="linenos"> 703</span></a>                <span class="n">memory_id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager-704"><a href="#AgentMemoryManager-704"><span class="linenos"> 704</span></a>                <span class="n">memory_text</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
</span><span id="AgentMemoryManager-705"><a href="#AgentMemoryManager-705"><span class="linenos"> 705</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
</span><span id="AgentMemoryManager-706"><a href="#AgentMemoryManager-706"><span class="linenos"> 706</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager-707"><a href="#AgentMemoryManager-707"><span class="linenos"> 707</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span>
</span><span id="AgentMemoryManager-708"><a href="#AgentMemoryManager-708"><span class="linenos"> 708</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-709"><a href="#AgentMemoryManager-709"><span class="linenos"> 709</span></a>
</span><span id="AgentMemoryManager-710"><a href="#AgentMemoryManager-710"><span class="linenos"> 710</span></a>            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="AgentMemoryManager-711"><a href="#AgentMemoryManager-711"><span class="linenos"> 711</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated memory </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">])</span>
</span><span id="AgentMemoryManager-712"><a href="#AgentMemoryManager-712"><span class="linenos"> 712</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Successfully updated memory: </span><span class="si">{</span><span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span id="AgentMemoryManager-713"><a href="#AgentMemoryManager-713"><span class="linenos"> 713</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-714"><a href="#AgentMemoryManager-714"><span class="linenos"> 714</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to update memory </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span><span id="AgentMemoryManager-715"><a href="#AgentMemoryManager-715"><span class="linenos"> 715</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error updating memory: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-716"><a href="#AgentMemoryManager-716"><span class="linenos"> 716</span></a>
</span><span id="AgentMemoryManager-717"><a href="#AgentMemoryManager-717"><span class="linenos"> 717</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-718"><a href="#AgentMemoryManager-718"><span class="linenos"> 718</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error updating memory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-719"><a href="#AgentMemoryManager-719"><span class="linenos"> 719</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error updating memory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-720"><a href="#AgentMemoryManager-720"><span class="linenos"> 720</span></a>
</span><span id="AgentMemoryManager-721"><a href="#AgentMemoryManager-721"><span class="linenos"> 721</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-722"><a href="#AgentMemoryManager-722"><span class="linenos"> 722</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a memory from both SQLite and LightRAG systems.</span>
</span><span id="AgentMemoryManager-723"><a href="#AgentMemoryManager-723"><span class="linenos"> 723</span></a>
</span><span id="AgentMemoryManager-724"><a href="#AgentMemoryManager-724"><span class="linenos"> 724</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-725"><a href="#AgentMemoryManager-725"><span class="linenos"> 725</span></a><span class="sd">            memory_id: ID of the memory to delete</span>
</span><span id="AgentMemoryManager-726"><a href="#AgentMemoryManager-726"><span class="linenos"> 726</span></a>
</span><span id="AgentMemoryManager-727"><a href="#AgentMemoryManager-727"><span class="linenos"> 727</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-728"><a href="#AgentMemoryManager-728"><span class="linenos"> 728</span></a><span class="sd">            str: Success or error message</span>
</span><span id="AgentMemoryManager-729"><a href="#AgentMemoryManager-729"><span class="linenos"> 729</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-730"><a href="#AgentMemoryManager-730"><span class="linenos"> 730</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-731"><a href="#AgentMemoryManager-731"><span class="linenos"> 731</span></a>            <span class="c1"># 1. Delete from local SQLite memory system</span>
</span><span id="AgentMemoryManager-732"><a href="#AgentMemoryManager-732"><span class="linenos"> 732</span></a>            <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager-733"><a href="#AgentMemoryManager-733"><span class="linenos"> 733</span></a>                <span class="n">memory_id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager-734"><a href="#AgentMemoryManager-734"><span class="linenos"> 734</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-735"><a href="#AgentMemoryManager-735"><span class="linenos"> 735</span></a>
</span><span id="AgentMemoryManager-736"><a href="#AgentMemoryManager-736"><span class="linenos"> 736</span></a>            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="AgentMemoryManager-737"><a href="#AgentMemoryManager-737"><span class="linenos"> 737</span></a>                <span class="n">sqlite_deleted_message</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager-738"><a href="#AgentMemoryManager-738"><span class="linenos"> 738</span></a>                    <span class="sa">f</span><span class="s2">&quot;Successfully deleted memory from SQLite: </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-739"><a href="#AgentMemoryManager-739"><span class="linenos"> 739</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-740"><a href="#AgentMemoryManager-740"><span class="linenos"> 740</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> from SQLite&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-741"><a href="#AgentMemoryManager-741"><span class="linenos"> 741</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-742"><a href="#AgentMemoryManager-742"><span class="linenos"> 742</span></a>                <span class="n">sqlite_deleted_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error deleting memory from SQLite: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-743"><a href="#AgentMemoryManager-743"><span class="linenos"> 743</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AgentMemoryManager-744"><a href="#AgentMemoryManager-744"><span class="linenos"> 744</span></a>                    <span class="sa">f</span><span class="s2">&quot;Failed to delete memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> from SQLite: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-745"><a href="#AgentMemoryManager-745"><span class="linenos"> 745</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-746"><a href="#AgentMemoryManager-746"><span class="linenos"> 746</span></a>                <span class="c1"># If local deletion fails, no need to proceed with graph deletion</span>
</span><span id="AgentMemoryManager-747"><a href="#AgentMemoryManager-747"><span class="linenos"> 747</span></a>                <span class="k">return</span> <span class="n">sqlite_deleted_message</span>
</span><span id="AgentMemoryManager-748"><a href="#AgentMemoryManager-748"><span class="linenos"> 748</span></a>
</span><span id="AgentMemoryManager-749"><a href="#AgentMemoryManager-749"><span class="linenos"> 749</span></a>            <span class="c1"># 2. Delete from LightRAG graph memory</span>
</span><span id="AgentMemoryManager-750"><a href="#AgentMemoryManager-750"><span class="linenos"> 750</span></a>            <span class="n">graph_deleted_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="AgentMemoryManager-751"><a href="#AgentMemoryManager-751"><span class="linenos"> 751</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="p">:</span>
</span><span id="AgentMemoryManager-752"><a href="#AgentMemoryManager-752"><span class="linenos"> 752</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-753"><a href="#AgentMemoryManager-753"><span class="linenos"> 753</span></a>                    <span class="c1"># Step 1: Find the document ID by its filename pattern</span>
</span><span id="AgentMemoryManager-754"><a href="#AgentMemoryManager-754"><span class="linenos"> 754</span></a>                    <span class="n">list_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents&quot;</span>
</span><span id="AgentMemoryManager-755"><a href="#AgentMemoryManager-755"><span class="linenos"> 755</span></a>                    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager-756"><a href="#AgentMemoryManager-756"><span class="linenos"> 756</span></a>                        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">list_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="AgentMemoryManager-757"><a href="#AgentMemoryManager-757"><span class="linenos"> 757</span></a>                            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager-758"><a href="#AgentMemoryManager-758"><span class="linenos"> 758</span></a>                                <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager-759"><a href="#AgentMemoryManager-759"><span class="linenos"> 759</span></a>                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="AgentMemoryManager-760"><a href="#AgentMemoryManager-760"><span class="linenos"> 760</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Failed to list documents from LightRAG: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-761"><a href="#AgentMemoryManager-761"><span class="linenos"> 761</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager-762"><a href="#AgentMemoryManager-762"><span class="linenos"> 762</span></a>                            <span class="n">docs_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentMemoryManager-763"><a href="#AgentMemoryManager-763"><span class="linenos"> 763</span></a>
</span><span id="AgentMemoryManager-764"><a href="#AgentMemoryManager-764"><span class="linenos"> 764</span></a>                            <span class="c1"># Extract documents from the actual LightRAG structure</span>
</span><span id="AgentMemoryManager-765"><a href="#AgentMemoryManager-765"><span class="linenos"> 765</span></a>                            <span class="n">documents</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-766"><a href="#AgentMemoryManager-766"><span class="linenos"> 766</span></a>                            <span class="k">if</span> <span class="p">(</span>
</span><span id="AgentMemoryManager-767"><a href="#AgentMemoryManager-767"><span class="linenos"> 767</span></a>                                <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs_response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="AgentMemoryManager-768"><a href="#AgentMemoryManager-768"><span class="linenos"> 768</span></a>                                <span class="ow">and</span> <span class="s2">&quot;statuses&quot;</span> <span class="ow">in</span> <span class="n">docs_response</span>
</span><span id="AgentMemoryManager-769"><a href="#AgentMemoryManager-769"><span class="linenos"> 769</span></a>                            <span class="p">):</span>
</span><span id="AgentMemoryManager-770"><a href="#AgentMemoryManager-770"><span class="linenos"> 770</span></a>                                <span class="n">statuses</span> <span class="o">=</span> <span class="n">docs_response</span><span class="p">[</span><span class="s2">&quot;statuses&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager-771"><a href="#AgentMemoryManager-771"><span class="linenos"> 771</span></a>                                <span class="k">for</span> <span class="n">status_name</span><span class="p">,</span> <span class="n">docs_list</span> <span class="ow">in</span> <span class="n">statuses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AgentMemoryManager-772"><a href="#AgentMemoryManager-772"><span class="linenos"> 772</span></a>                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager-773"><a href="#AgentMemoryManager-773"><span class="linenos"> 773</span></a>                                        <span class="n">documents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">docs_list</span><span class="p">)</span>
</span><span id="AgentMemoryManager-774"><a href="#AgentMemoryManager-774"><span class="linenos"> 774</span></a>                            <span class="k">elif</span> <span class="p">(</span>
</span><span id="AgentMemoryManager-775"><a href="#AgentMemoryManager-775"><span class="linenos"> 775</span></a>                                <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs_response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="AgentMemoryManager-776"><a href="#AgentMemoryManager-776"><span class="linenos"> 776</span></a>                                <span class="ow">and</span> <span class="s2">&quot;documents&quot;</span> <span class="ow">in</span> <span class="n">docs_response</span>
</span><span id="AgentMemoryManager-777"><a href="#AgentMemoryManager-777"><span class="linenos"> 777</span></a>                            <span class="p">):</span>
</span><span id="AgentMemoryManager-778"><a href="#AgentMemoryManager-778"><span class="linenos"> 778</span></a>                                <span class="n">documents</span> <span class="o">=</span> <span class="n">docs_response</span><span class="p">[</span><span class="s2">&quot;documents&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager-779"><a href="#AgentMemoryManager-779"><span class="linenos"> 779</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs_response</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager-780"><a href="#AgentMemoryManager-780"><span class="linenos"> 780</span></a>                                <span class="n">documents</span> <span class="o">=</span> <span class="n">docs_response</span>
</span><span id="AgentMemoryManager-781"><a href="#AgentMemoryManager-781"><span class="linenos"> 781</span></a>
</span><span id="AgentMemoryManager-782"><a href="#AgentMemoryManager-782"><span class="linenos"> 782</span></a>                    <span class="n">doc_id_to_delete</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager-783"><a href="#AgentMemoryManager-783"><span class="linenos"> 783</span></a>                    <span class="c1"># The filename is memory_{memory_id}_{hash}.txt</span>
</span><span id="AgentMemoryManager-784"><a href="#AgentMemoryManager-784"><span class="linenos"> 784</span></a>                    <span class="n">filename_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;memory_</span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">_&quot;</span>
</span><span id="AgentMemoryManager-785"><a href="#AgentMemoryManager-785"><span class="linenos"> 785</span></a>
</span><span id="AgentMemoryManager-786"><a href="#AgentMemoryManager-786"><span class="linenos"> 786</span></a>                    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">:</span>
</span><span id="AgentMemoryManager-787"><a href="#AgentMemoryManager-787"><span class="linenos"> 787</span></a>                        <span class="c1"># Check file_path field (not metadata.source)</span>
</span><span id="AgentMemoryManager-788"><a href="#AgentMemoryManager-788"><span class="linenos"> 788</span></a>                        <span class="n">file_path</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-789"><a href="#AgentMemoryManager-789"><span class="linenos"> 789</span></a>                        <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">filename_pattern</span><span class="p">):</span>
</span><span id="AgentMemoryManager-790"><a href="#AgentMemoryManager-790"><span class="linenos"> 790</span></a>                            <span class="n">doc_id_to_delete</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-791"><a href="#AgentMemoryManager-791"><span class="linenos"> 791</span></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-792"><a href="#AgentMemoryManager-792"><span class="linenos"> 792</span></a>                                <span class="sa">f</span><span class="s2">&quot;Found document to delete: </span><span class="si">{</span><span class="n">doc_id_to_delete</span><span class="si">}</span><span class="s2"> (file_path: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="AgentMemoryManager-793"><a href="#AgentMemoryManager-793"><span class="linenos"> 793</span></a>                            <span class="p">)</span>
</span><span id="AgentMemoryManager-794"><a href="#AgentMemoryManager-794"><span class="linenos"> 794</span></a>                            <span class="k">break</span>
</span><span id="AgentMemoryManager-795"><a href="#AgentMemoryManager-795"><span class="linenos"> 795</span></a>
</span><span id="AgentMemoryManager-796"><a href="#AgentMemoryManager-796"><span class="linenos"> 796</span></a>                    <span class="c1"># Step 2: Delete the document if found</span>
</span><span id="AgentMemoryManager-797"><a href="#AgentMemoryManager-797"><span class="linenos"> 797</span></a>                    <span class="k">if</span> <span class="n">doc_id_to_delete</span><span class="p">:</span>
</span><span id="AgentMemoryManager-798"><a href="#AgentMemoryManager-798"><span class="linenos"> 798</span></a>                        <span class="n">delete_url</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager-799"><a href="#AgentMemoryManager-799"><span class="linenos"> 799</span></a>                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents/delete_document&quot;</span>
</span><span id="AgentMemoryManager-800"><a href="#AgentMemoryManager-800"><span class="linenos"> 800</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager-801"><a href="#AgentMemoryManager-801"><span class="linenos"> 801</span></a>                        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager-802"><a href="#AgentMemoryManager-802"><span class="linenos"> 802</span></a>                            <span class="c1"># Use doc_ids (plural) as expected by the API</span>
</span><span id="AgentMemoryManager-803"><a href="#AgentMemoryManager-803"><span class="linenos"> 803</span></a>                            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
</span><span id="AgentMemoryManager-804"><a href="#AgentMemoryManager-804"><span class="linenos"> 804</span></a>                                <span class="n">delete_url</span><span class="p">,</span>
</span><span id="AgentMemoryManager-805"><a href="#AgentMemoryManager-805"><span class="linenos"> 805</span></a>                                <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;doc_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">doc_id_to_delete</span><span class="p">]},</span>
</span><span id="AgentMemoryManager-806"><a href="#AgentMemoryManager-806"><span class="linenos"> 806</span></a>                                <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
</span><span id="AgentMemoryManager-807"><a href="#AgentMemoryManager-807"><span class="linenos"> 807</span></a>                            <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="AgentMemoryManager-808"><a href="#AgentMemoryManager-808"><span class="linenos"> 808</span></a>                                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager-809"><a href="#AgentMemoryManager-809"><span class="linenos"> 809</span></a>                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-810"><a href="#AgentMemoryManager-810"><span class="linenos"> 810</span></a>                                        <span class="sa">f</span><span class="s2">&quot;Successfully deleted memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> (doc_id: </span><span class="si">{</span><span class="n">doc_id_to_delete</span><span class="si">}</span><span class="s2">) from LightRAG.&quot;</span>
</span><span id="AgentMemoryManager-811"><a href="#AgentMemoryManager-811"><span class="linenos"> 811</span></a>                                    <span class="p">)</span>
</span><span id="AgentMemoryManager-812"><a href="#AgentMemoryManager-812"><span class="linenos"> 812</span></a>                                    <span class="n">graph_deleted_message</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager-813"><a href="#AgentMemoryManager-813"><span class="linenos"> 813</span></a>                                        <span class="sa">f</span><span class="s2">&quot;Successfully deleted from graph memory&quot;</span>
</span><span id="AgentMemoryManager-814"><a href="#AgentMemoryManager-814"><span class="linenos"> 814</span></a>                                    <span class="p">)</span>
</span><span id="AgentMemoryManager-815"><a href="#AgentMemoryManager-815"><span class="linenos"> 815</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-816"><a href="#AgentMemoryManager-816"><span class="linenos"> 816</span></a>                                    <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager-817"><a href="#AgentMemoryManager-817"><span class="linenos"> 817</span></a>                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AgentMemoryManager-818"><a href="#AgentMemoryManager-818"><span class="linenos"> 818</span></a>                                        <span class="sa">f</span><span class="s2">&quot;Failed to delete document </span><span class="si">{</span><span class="n">doc_id_to_delete</span><span class="si">}</span><span class="s2"> from LightRAG: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-819"><a href="#AgentMemoryManager-819"><span class="linenos"> 819</span></a>                                    <span class="p">)</span>
</span><span id="AgentMemoryManager-820"><a href="#AgentMemoryManager-820"><span class="linenos"> 820</span></a>                                    <span class="n">graph_deleted_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; Could not delete from graph memory: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-821"><a href="#AgentMemoryManager-821"><span class="linenos"> 821</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-822"><a href="#AgentMemoryManager-822"><span class="linenos"> 822</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager-823"><a href="#AgentMemoryManager-823"><span class="linenos"> 823</span></a>                            <span class="sa">f</span><span class="s2">&quot;Memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> not found in LightRAG graph memory (searched for pattern: </span><span class="si">{</span><span class="n">filename_pattern</span><span class="si">}</span><span class="s2">).&quot;</span>
</span><span id="AgentMemoryManager-824"><a href="#AgentMemoryManager-824"><span class="linenos"> 824</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager-825"><a href="#AgentMemoryManager-825"><span class="linenos"> 825</span></a>                        <span class="c1"># Treat &quot;not found&quot; as successful deletion since the goal is achieved</span>
</span><span id="AgentMemoryManager-826"><a href="#AgentMemoryManager-826"><span class="linenos"> 826</span></a>                        <span class="n">graph_deleted_message</span> <span class="o">=</span> <span class="s2">&quot;Successfully deleted from graph memory&quot;</span>
</span><span id="AgentMemoryManager-827"><a href="#AgentMemoryManager-827"><span class="linenos"> 827</span></a>
</span><span id="AgentMemoryManager-828"><a href="#AgentMemoryManager-828"><span class="linenos"> 828</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-829"><a href="#AgentMemoryManager-829"><span class="linenos"> 829</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception deleting memory from graph: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-830"><a href="#AgentMemoryManager-830"><span class="linenos"> 830</span></a>                    <span class="n">graph_deleted_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; Could not delete from graph memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-831"><a href="#AgentMemoryManager-831"><span class="linenos"> 831</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-832"><a href="#AgentMemoryManager-832"><span class="linenos"> 832</span></a>                <span class="n">graph_deleted_message</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager-833"><a href="#AgentMemoryManager-833"><span class="linenos"> 833</span></a>                    <span class="s2">&quot;Graph memory client not configured, skipping deletion.&quot;</span>
</span><span id="AgentMemoryManager-834"><a href="#AgentMemoryManager-834"><span class="linenos"> 834</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-835"><a href="#AgentMemoryManager-835"><span class="linenos"> 835</span></a>
</span><span id="AgentMemoryManager-836"><a href="#AgentMemoryManager-836"><span class="linenos"> 836</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sqlite_deleted_message</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">graph_deleted_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AgentMemoryManager-837"><a href="#AgentMemoryManager-837"><span class="linenos"> 837</span></a>
</span><span id="AgentMemoryManager-838"><a href="#AgentMemoryManager-838"><span class="linenos"> 838</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-839"><a href="#AgentMemoryManager-839"><span class="linenos"> 839</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-840"><a href="#AgentMemoryManager-840"><span class="linenos"> 840</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error deleting memory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-841"><a href="#AgentMemoryManager-841"><span class="linenos"> 841</span></a>
</span><span id="AgentMemoryManager-842"><a href="#AgentMemoryManager-842"><span class="linenos"> 842</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_recent_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-843"><a href="#AgentMemoryManager-843"><span class="linenos"> 843</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get recent memories by searching all memories and sorting by date.</span>
</span><span id="AgentMemoryManager-844"><a href="#AgentMemoryManager-844"><span class="linenos"> 844</span></a>
</span><span id="AgentMemoryManager-845"><a href="#AgentMemoryManager-845"><span class="linenos"> 845</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-846"><a href="#AgentMemoryManager-846"><span class="linenos"> 846</span></a><span class="sd">            limit: Maximum number of memories to return</span>
</span><span id="AgentMemoryManager-847"><a href="#AgentMemoryManager-847"><span class="linenos"> 847</span></a>
</span><span id="AgentMemoryManager-848"><a href="#AgentMemoryManager-848"><span class="linenos"> 848</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-849"><a href="#AgentMemoryManager-849"><span class="linenos"> 849</span></a><span class="sd">            str: Formatted string of recent memories</span>
</span><span id="AgentMemoryManager-850"><a href="#AgentMemoryManager-850"><span class="linenos"> 850</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-851"><a href="#AgentMemoryManager-851"><span class="linenos"> 851</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-852"><a href="#AgentMemoryManager-852"><span class="linenos"> 852</span></a>            <span class="c1"># Direct call to SemanticMemoryManager.get_all_memories()</span>
</span><span id="AgentMemoryManager-853"><a href="#AgentMemoryManager-853"><span class="linenos"> 853</span></a>            <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">get_all_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager-854"><a href="#AgentMemoryManager-854"><span class="linenos"> 854</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager-855"><a href="#AgentMemoryManager-855"><span class="linenos"> 855</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-856"><a href="#AgentMemoryManager-856"><span class="linenos"> 856</span></a>
</span><span id="AgentMemoryManager-857"><a href="#AgentMemoryManager-857"><span class="linenos"> 857</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager-858"><a href="#AgentMemoryManager-858"><span class="linenos"> 858</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No memories found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager-859"><a href="#AgentMemoryManager-859"><span class="linenos"> 859</span></a>                <span class="k">return</span> <span class="s2">&quot; No memories found. Try storing some information first!&quot;</span>
</span><span id="AgentMemoryManager-860"><a href="#AgentMemoryManager-860"><span class="linenos"> 860</span></a>
</span><span id="AgentMemoryManager-861"><a href="#AgentMemoryManager-861"><span class="linenos"> 861</span></a>            <span class="c1"># Sort memories by timestamp (newest first)</span>
</span><span id="AgentMemoryManager-862"><a href="#AgentMemoryManager-862"><span class="linenos"> 862</span></a>            <span class="n">sorted_memories</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="AgentMemoryManager-863"><a href="#AgentMemoryManager-863"><span class="linenos"> 863</span></a>                <span class="n">memories</span><span class="p">,</span>
</span><span id="AgentMemoryManager-864"><a href="#AgentMemoryManager-864"><span class="linenos"> 864</span></a>                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="AgentMemoryManager-865"><a href="#AgentMemoryManager-865"><span class="linenos"> 865</span></a>                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager-866"><a href="#AgentMemoryManager-866"><span class="linenos"> 866</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-867"><a href="#AgentMemoryManager-867"><span class="linenos"> 867</span></a>
</span><span id="AgentMemoryManager-868"><a href="#AgentMemoryManager-868"><span class="linenos"> 868</span></a>            <span class="c1"># Limit the number of memories</span>
</span><span id="AgentMemoryManager-869"><a href="#AgentMemoryManager-869"><span class="linenos"> 869</span></a>            <span class="n">display_memories</span> <span class="o">=</span> <span class="n">sorted_memories</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">sorted_memories</span>
</span><span id="AgentMemoryManager-870"><a href="#AgentMemoryManager-870"><span class="linenos"> 870</span></a>
</span><span id="AgentMemoryManager-871"><a href="#AgentMemoryManager-871"><span class="linenos"> 871</span></a>            <span class="c1"># Format results</span>
</span><span id="AgentMemoryManager-872"><a href="#AgentMemoryManager-872"><span class="linenos"> 872</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; RECENT MEMORIES (showing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">display_memories</span><span class="p">)</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span><span class="si">}</span><span class="s2"> total memories):</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-873"><a href="#AgentMemoryManager-873"><span class="linenos"> 873</span></a>
</span><span id="AgentMemoryManager-874"><a href="#AgentMemoryManager-874"><span class="linenos"> 874</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">memory</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">display_memories</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AgentMemoryManager-875"><a href="#AgentMemoryManager-875"><span class="linenos"> 875</span></a>                <span class="c1"># Format the memory content</span>
</span><span id="AgentMemoryManager-876"><a href="#AgentMemoryManager-876"><span class="linenos"> 876</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-877"><a href="#AgentMemoryManager-877"><span class="linenos"> 877</span></a>
</span><span id="AgentMemoryManager-878"><a href="#AgentMemoryManager-878"><span class="linenos"> 878</span></a>                <span class="c1"># Add topics if available</span>
</span><span id="AgentMemoryManager-879"><a href="#AgentMemoryManager-879"><span class="linenos"> 879</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;topics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-880"><a href="#AgentMemoryManager-880"><span class="linenos"> 880</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-881"><a href="#AgentMemoryManager-881"><span class="linenos"> 881</span></a>
</span><span id="AgentMemoryManager-882"><a href="#AgentMemoryManager-882"><span class="linenos"> 882</span></a>                <span class="c1"># Add timestamp if available</span>
</span><span id="AgentMemoryManager-883"><a href="#AgentMemoryManager-883"><span class="linenos"> 883</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-884"><a href="#AgentMemoryManager-884"><span class="linenos"> 884</span></a>                    <span class="c1"># Convert timestamp to readable format</span>
</span><span id="AgentMemoryManager-885"><a href="#AgentMemoryManager-885"><span class="linenos"> 885</span></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="AgentMemoryManager-886"><a href="#AgentMemoryManager-886"><span class="linenos"> 886</span></a>
</span><span id="AgentMemoryManager-887"><a href="#AgentMemoryManager-887"><span class="linenos"> 887</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
</span><span id="AgentMemoryManager-888"><a href="#AgentMemoryManager-888"><span class="linenos"> 888</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Created: </span><span class="si">{</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-889"><a href="#AgentMemoryManager-889"><span class="linenos"> 889</span></a>
</span><span id="AgentMemoryManager-890"><a href="#AgentMemoryManager-890"><span class="linenos"> 890</span></a>                <span class="c1"># Add memory ID for reference</span>
</span><span id="AgentMemoryManager-891"><a href="#AgentMemoryManager-891"><span class="linenos"> 891</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   ID: </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory_id</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-892"><a href="#AgentMemoryManager-892"><span class="linenos"> 892</span></a>
</span><span id="AgentMemoryManager-893"><a href="#AgentMemoryManager-893"><span class="linenos"> 893</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-894"><a href="#AgentMemoryManager-894"><span class="linenos"> 894</span></a>                <span class="s2">&quot;Retrieved </span><span class="si">%d</span><span class="s2"> recent memories for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-895"><a href="#AgentMemoryManager-895"><span class="linenos"> 895</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">display_memories</span><span class="p">),</span>
</span><span id="AgentMemoryManager-896"><a href="#AgentMemoryManager-896"><span class="linenos"> 896</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager-897"><a href="#AgentMemoryManager-897"><span class="linenos"> 897</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-898"><a href="#AgentMemoryManager-898"><span class="linenos"> 898</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager-899"><a href="#AgentMemoryManager-899"><span class="linenos"> 899</span></a>
</span><span id="AgentMemoryManager-900"><a href="#AgentMemoryManager-900"><span class="linenos"> 900</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-901"><a href="#AgentMemoryManager-901"><span class="linenos"> 901</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error retrieving recent memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-902"><a href="#AgentMemoryManager-902"><span class="linenos"> 902</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error retrieving recent memories: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-903"><a href="#AgentMemoryManager-903"><span class="linenos"> 903</span></a>
</span><span id="AgentMemoryManager-904"><a href="#AgentMemoryManager-904"><span class="linenos"> 904</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_all_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-905"><a href="#AgentMemoryManager-905"><span class="linenos"> 905</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all user memories.</span>
</span><span id="AgentMemoryManager-906"><a href="#AgentMemoryManager-906"><span class="linenos"> 906</span></a>
</span><span id="AgentMemoryManager-907"><a href="#AgentMemoryManager-907"><span class="linenos"> 907</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-908"><a href="#AgentMemoryManager-908"><span class="linenos"> 908</span></a><span class="sd">            str: Formatted string of all memories</span>
</span><span id="AgentMemoryManager-909"><a href="#AgentMemoryManager-909"><span class="linenos"> 909</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-910"><a href="#AgentMemoryManager-910"><span class="linenos"> 910</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-911"><a href="#AgentMemoryManager-911"><span class="linenos"> 911</span></a>            <span class="c1"># Direct call to SemanticMemoryManager.get_all_memories()</span>
</span><span id="AgentMemoryManager-912"><a href="#AgentMemoryManager-912"><span class="linenos"> 912</span></a>            <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">get_all_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager-913"><a href="#AgentMemoryManager-913"><span class="linenos"> 913</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager-914"><a href="#AgentMemoryManager-914"><span class="linenos"> 914</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-915"><a href="#AgentMemoryManager-915"><span class="linenos"> 915</span></a>
</span><span id="AgentMemoryManager-916"><a href="#AgentMemoryManager-916"><span class="linenos"> 916</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager-917"><a href="#AgentMemoryManager-917"><span class="linenos"> 917</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No memories found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager-918"><a href="#AgentMemoryManager-918"><span class="linenos"> 918</span></a>                <span class="k">return</span> <span class="s2">&quot; No memories found. Try storing some information first!&quot;</span>
</span><span id="AgentMemoryManager-919"><a href="#AgentMemoryManager-919"><span class="linenos"> 919</span></a>
</span><span id="AgentMemoryManager-920"><a href="#AgentMemoryManager-920"><span class="linenos"> 920</span></a>            <span class="c1"># Sort memories by timestamp (newest first)</span>
</span><span id="AgentMemoryManager-921"><a href="#AgentMemoryManager-921"><span class="linenos"> 921</span></a>            <span class="n">sorted_memories</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="AgentMemoryManager-922"><a href="#AgentMemoryManager-922"><span class="linenos"> 922</span></a>                <span class="n">memories</span><span class="p">,</span>
</span><span id="AgentMemoryManager-923"><a href="#AgentMemoryManager-923"><span class="linenos"> 923</span></a>                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="AgentMemoryManager-924"><a href="#AgentMemoryManager-924"><span class="linenos"> 924</span></a>                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager-925"><a href="#AgentMemoryManager-925"><span class="linenos"> 925</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-926"><a href="#AgentMemoryManager-926"><span class="linenos"> 926</span></a>
</span><span id="AgentMemoryManager-927"><a href="#AgentMemoryManager-927"><span class="linenos"> 927</span></a>            <span class="c1"># Format results</span>
</span><span id="AgentMemoryManager-928"><a href="#AgentMemoryManager-928"><span class="linenos"> 928</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; ALL MEMORIES (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span><span class="si">}</span><span class="s2"> total):</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-929"><a href="#AgentMemoryManager-929"><span class="linenos"> 929</span></a>
</span><span id="AgentMemoryManager-930"><a href="#AgentMemoryManager-930"><span class="linenos"> 930</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">memory</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_memories</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AgentMemoryManager-931"><a href="#AgentMemoryManager-931"><span class="linenos"> 931</span></a>                <span class="c1"># Format the memory content</span>
</span><span id="AgentMemoryManager-932"><a href="#AgentMemoryManager-932"><span class="linenos"> 932</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-933"><a href="#AgentMemoryManager-933"><span class="linenos"> 933</span></a>
</span><span id="AgentMemoryManager-934"><a href="#AgentMemoryManager-934"><span class="linenos"> 934</span></a>                <span class="c1"># Add topics if available</span>
</span><span id="AgentMemoryManager-935"><a href="#AgentMemoryManager-935"><span class="linenos"> 935</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;topics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-936"><a href="#AgentMemoryManager-936"><span class="linenos"> 936</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-937"><a href="#AgentMemoryManager-937"><span class="linenos"> 937</span></a>
</span><span id="AgentMemoryManager-938"><a href="#AgentMemoryManager-938"><span class="linenos"> 938</span></a>                <span class="c1"># Add timestamp if available</span>
</span><span id="AgentMemoryManager-939"><a href="#AgentMemoryManager-939"><span class="linenos"> 939</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-940"><a href="#AgentMemoryManager-940"><span class="linenos"> 940</span></a>                    <span class="c1"># Convert timestamp to readable format</span>
</span><span id="AgentMemoryManager-941"><a href="#AgentMemoryManager-941"><span class="linenos"> 941</span></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="AgentMemoryManager-942"><a href="#AgentMemoryManager-942"><span class="linenos"> 942</span></a>
</span><span id="AgentMemoryManager-943"><a href="#AgentMemoryManager-943"><span class="linenos"> 943</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
</span><span id="AgentMemoryManager-944"><a href="#AgentMemoryManager-944"><span class="linenos"> 944</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Created: </span><span class="si">{</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-945"><a href="#AgentMemoryManager-945"><span class="linenos"> 945</span></a>
</span><span id="AgentMemoryManager-946"><a href="#AgentMemoryManager-946"><span class="linenos"> 946</span></a>                <span class="c1"># Add memory ID for reference</span>
</span><span id="AgentMemoryManager-947"><a href="#AgentMemoryManager-947"><span class="linenos"> 947</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   ID: </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory_id</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-948"><a href="#AgentMemoryManager-948"><span class="linenos"> 948</span></a>
</span><span id="AgentMemoryManager-949"><a href="#AgentMemoryManager-949"><span class="linenos"> 949</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-950"><a href="#AgentMemoryManager-950"><span class="linenos"> 950</span></a>                <span class="s2">&quot;Retrieved all </span><span class="si">%d</span><span class="s2"> memories for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager-951"><a href="#AgentMemoryManager-951"><span class="linenos"> 951</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-952"><a href="#AgentMemoryManager-952"><span class="linenos"> 952</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager-953"><a href="#AgentMemoryManager-953"><span class="linenos"> 953</span></a>
</span><span id="AgentMemoryManager-954"><a href="#AgentMemoryManager-954"><span class="linenos"> 954</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-955"><a href="#AgentMemoryManager-955"><span class="linenos"> 955</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error retrieving all memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-956"><a href="#AgentMemoryManager-956"><span class="linenos"> 956</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error retrieving all memories: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-957"><a href="#AgentMemoryManager-957"><span class="linenos"> 957</span></a>
</span><span id="AgentMemoryManager-958"><a href="#AgentMemoryManager-958"><span class="linenos"> 958</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-959"><a href="#AgentMemoryManager-959"><span class="linenos"> 959</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get memory statistics.</span>
</span><span id="AgentMemoryManager-960"><a href="#AgentMemoryManager-960"><span class="linenos"> 960</span></a>
</span><span id="AgentMemoryManager-961"><a href="#AgentMemoryManager-961"><span class="linenos"> 961</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-962"><a href="#AgentMemoryManager-962"><span class="linenos"> 962</span></a><span class="sd">            str: Formatted string with memory statistics</span>
</span><span id="AgentMemoryManager-963"><a href="#AgentMemoryManager-963"><span class="linenos"> 963</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-964"><a href="#AgentMemoryManager-964"><span class="linenos"> 964</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-965"><a href="#AgentMemoryManager-965"><span class="linenos"> 965</span></a>            <span class="c1"># Direct call to SemanticMemoryManager.get_all_memories()</span>
</span><span id="AgentMemoryManager-966"><a href="#AgentMemoryManager-966"><span class="linenos"> 966</span></a>            <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">get_all_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager-967"><a href="#AgentMemoryManager-967"><span class="linenos"> 967</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager-968"><a href="#AgentMemoryManager-968"><span class="linenos"> 968</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-969"><a href="#AgentMemoryManager-969"><span class="linenos"> 969</span></a>
</span><span id="AgentMemoryManager-970"><a href="#AgentMemoryManager-970"><span class="linenos"> 970</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager-971"><a href="#AgentMemoryManager-971"><span class="linenos"> 971</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No memories found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager-972"><a href="#AgentMemoryManager-972"><span class="linenos"> 972</span></a>                <span class="k">return</span> <span class="s2">&quot; No memories found. Try storing some information first!&quot;</span>
</span><span id="AgentMemoryManager-973"><a href="#AgentMemoryManager-973"><span class="linenos"> 973</span></a>
</span><span id="AgentMemoryManager-974"><a href="#AgentMemoryManager-974"><span class="linenos"> 974</span></a>            <span class="c1"># Calculate basic statistics</span>
</span><span id="AgentMemoryManager-975"><a href="#AgentMemoryManager-975"><span class="linenos"> 975</span></a>            <span class="n">total_memories</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span>
</span><span id="AgentMemoryManager-976"><a href="#AgentMemoryManager-976"><span class="linenos"> 976</span></a>
</span><span id="AgentMemoryManager-977"><a href="#AgentMemoryManager-977"><span class="linenos"> 977</span></a>            <span class="c1"># Get all unique topics</span>
</span><span id="AgentMemoryManager-978"><a href="#AgentMemoryManager-978"><span class="linenos"> 978</span></a>            <span class="n">all_topics</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AgentMemoryManager-979"><a href="#AgentMemoryManager-979"><span class="linenos"> 979</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager-980"><a href="#AgentMemoryManager-980"><span class="linenos"> 980</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;topics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-981"><a href="#AgentMemoryManager-981"><span class="linenos"> 981</span></a>                    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-982"><a href="#AgentMemoryManager-982"><span class="linenos"> 982</span></a>                        <span class="n">all_topics</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_topics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="AgentMemoryManager-983"><a href="#AgentMemoryManager-983"><span class="linenos"> 983</span></a>
</span><span id="AgentMemoryManager-984"><a href="#AgentMemoryManager-984"><span class="linenos"> 984</span></a>            <span class="c1"># Sort topics by frequency (most common first)</span>
</span><span id="AgentMemoryManager-985"><a href="#AgentMemoryManager-985"><span class="linenos"> 985</span></a>            <span class="n">sorted_topics</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_topics</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AgentMemoryManager-986"><a href="#AgentMemoryManager-986"><span class="linenos"> 986</span></a>
</span><span id="AgentMemoryManager-987"><a href="#AgentMemoryManager-987"><span class="linenos"> 987</span></a>            <span class="c1"># Calculate average memory length</span>
</span><span id="AgentMemoryManager-988"><a href="#AgentMemoryManager-988"><span class="linenos"> 988</span></a>            <span class="n">total_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">)</span>
</span><span id="AgentMemoryManager-989"><a href="#AgentMemoryManager-989"><span class="linenos"> 989</span></a>            <span class="n">avg_length</span> <span class="o">=</span> <span class="n">total_length</span> <span class="o">/</span> <span class="n">total_memories</span> <span class="k">if</span> <span class="n">total_memories</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="AgentMemoryManager-990"><a href="#AgentMemoryManager-990"><span class="linenos"> 990</span></a>
</span><span id="AgentMemoryManager-991"><a href="#AgentMemoryManager-991"><span class="linenos"> 991</span></a>            <span class="c1"># Get oldest and newest memory timestamps</span>
</span><span id="AgentMemoryManager-992"><a href="#AgentMemoryManager-992"><span class="linenos"> 992</span></a>            <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager-993"><a href="#AgentMemoryManager-993"><span class="linenos"> 993</span></a>                <span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-994"><a href="#AgentMemoryManager-994"><span class="linenos"> 994</span></a>            <span class="p">]</span>
</span><span id="AgentMemoryManager-995"><a href="#AgentMemoryManager-995"><span class="linenos"> 995</span></a>            <span class="n">oldest_timestamp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span> <span class="k">if</span> <span class="n">timestamps</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager-996"><a href="#AgentMemoryManager-996"><span class="linenos"> 996</span></a>            <span class="n">newest_timestamp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span> <span class="k">if</span> <span class="n">timestamps</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager-997"><a href="#AgentMemoryManager-997"><span class="linenos"> 997</span></a>
</span><span id="AgentMemoryManager-998"><a href="#AgentMemoryManager-998"><span class="linenos"> 998</span></a>            <span class="c1"># Format results</span>
</span><span id="AgentMemoryManager-999"><a href="#AgentMemoryManager-999"><span class="linenos"> 999</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; MEMORY STATISTICS</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1000"><a href="#AgentMemoryManager-1000"><span class="linenos">1000</span></a>            <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Total memories: </span><span class="si">{</span><span class="n">total_memories</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1001"><a href="#AgentMemoryManager-1001"><span class="linenos">1001</span></a>            <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Average memory length: </span><span class="si">{</span><span class="n">avg_length</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> characters</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1002"><a href="#AgentMemoryManager-1002"><span class="linenos">1002</span></a>
</span><span id="AgentMemoryManager-1003"><a href="#AgentMemoryManager-1003"><span class="linenos">1003</span></a>            <span class="k">if</span> <span class="n">oldest_timestamp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1004"><a href="#AgentMemoryManager-1004"><span class="linenos">1004</span></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="AgentMemoryManager-1005"><a href="#AgentMemoryManager-1005"><span class="linenos">1005</span></a>
</span><span id="AgentMemoryManager-1006"><a href="#AgentMemoryManager-1006"><span class="linenos">1006</span></a>                <span class="n">oldest_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">oldest_timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1007"><a href="#AgentMemoryManager-1007"><span class="linenos">1007</span></a>                    <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span>
</span><span id="AgentMemoryManager-1008"><a href="#AgentMemoryManager-1008"><span class="linenos">1008</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-1009"><a href="#AgentMemoryManager-1009"><span class="linenos">1009</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Oldest memory: </span><span class="si">{</span><span class="n">oldest_date</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1010"><a href="#AgentMemoryManager-1010"><span class="linenos">1010</span></a>
</span><span id="AgentMemoryManager-1011"><a href="#AgentMemoryManager-1011"><span class="linenos">1011</span></a>            <span class="k">if</span> <span class="n">newest_timestamp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1012"><a href="#AgentMemoryManager-1012"><span class="linenos">1012</span></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="AgentMemoryManager-1013"><a href="#AgentMemoryManager-1013"><span class="linenos">1013</span></a>
</span><span id="AgentMemoryManager-1014"><a href="#AgentMemoryManager-1014"><span class="linenos">1014</span></a>                <span class="n">newest_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">newest_timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1015"><a href="#AgentMemoryManager-1015"><span class="linenos">1015</span></a>                    <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span>
</span><span id="AgentMemoryManager-1016"><a href="#AgentMemoryManager-1016"><span class="linenos">1016</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-1017"><a href="#AgentMemoryManager-1017"><span class="linenos">1017</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Newest memory: </span><span class="si">{</span><span class="n">newest_date</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1018"><a href="#AgentMemoryManager-1018"><span class="linenos">1018</span></a>
</span><span id="AgentMemoryManager-1019"><a href="#AgentMemoryManager-1019"><span class="linenos">1019</span></a>            <span class="k">if</span> <span class="n">sorted_topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1020"><a href="#AgentMemoryManager-1020"><span class="linenos">1020</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top topics:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1021"><a href="#AgentMemoryManager-1021"><span class="linenos">1021</span></a>                <span class="c1"># Show top 10 topics</span>
</span><span id="AgentMemoryManager-1022"><a href="#AgentMemoryManager-1022"><span class="linenos">1022</span></a>                <span class="k">for</span> <span class="n">topic</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">sorted_topics</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>
</span><span id="AgentMemoryManager-1023"><a href="#AgentMemoryManager-1023"><span class="linenos">1023</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> memories</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1024"><a href="#AgentMemoryManager-1024"><span class="linenos">1024</span></a>
</span><span id="AgentMemoryManager-1025"><a href="#AgentMemoryManager-1025"><span class="linenos">1025</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_topics</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1026"><a href="#AgentMemoryManager-1026"><span class="linenos">1026</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_topics</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2"> more topics</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1027"><a href="#AgentMemoryManager-1027"><span class="linenos">1027</span></a>
</span><span id="AgentMemoryManager-1028"><a href="#AgentMemoryManager-1028"><span class="linenos">1028</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generated memory statistics for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1029"><a href="#AgentMemoryManager-1029"><span class="linenos">1029</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager-1030"><a href="#AgentMemoryManager-1030"><span class="linenos">1030</span></a>
</span><span id="AgentMemoryManager-1031"><a href="#AgentMemoryManager-1031"><span class="linenos">1031</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1032"><a href="#AgentMemoryManager-1032"><span class="linenos">1032</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error retrieving memory statistics: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1033"><a href="#AgentMemoryManager-1033"><span class="linenos">1033</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error retrieving memory statistics: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1034"><a href="#AgentMemoryManager-1034"><span class="linenos">1034</span></a>
</span><span id="AgentMemoryManager-1035"><a href="#AgentMemoryManager-1035"><span class="linenos">1035</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_memories_by_topic</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1036"><a href="#AgentMemoryManager-1036"><span class="linenos">1036</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager-1037"><a href="#AgentMemoryManager-1037"><span class="linenos">1037</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1038"><a href="#AgentMemoryManager-1038"><span class="linenos">1038</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get memories by topic without similarity search.</span>
</span><span id="AgentMemoryManager-1039"><a href="#AgentMemoryManager-1039"><span class="linenos">1039</span></a>
</span><span id="AgentMemoryManager-1040"><a href="#AgentMemoryManager-1040"><span class="linenos">1040</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-1041"><a href="#AgentMemoryManager-1041"><span class="linenos">1041</span></a><span class="sd">            topics: Topic or list of topics to filter memories by</span>
</span><span id="AgentMemoryManager-1042"><a href="#AgentMemoryManager-1042"><span class="linenos">1042</span></a><span class="sd">            limit: Maximum number of memories to return</span>
</span><span id="AgentMemoryManager-1043"><a href="#AgentMemoryManager-1043"><span class="linenos">1043</span></a>
</span><span id="AgentMemoryManager-1044"><a href="#AgentMemoryManager-1044"><span class="linenos">1044</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-1045"><a href="#AgentMemoryManager-1045"><span class="linenos">1045</span></a><span class="sd">            str: Formatted string of memories matching the topics</span>
</span><span id="AgentMemoryManager-1046"><a href="#AgentMemoryManager-1046"><span class="linenos">1046</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-1047"><a href="#AgentMemoryManager-1047"><span class="linenos">1047</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1048"><a href="#AgentMemoryManager-1048"><span class="linenos">1048</span></a>            <span class="c1"># Validate topics parameter</span>
</span><span id="AgentMemoryManager-1049"><a href="#AgentMemoryManager-1049"><span class="linenos">1049</span></a>            <span class="k">if</span> <span class="n">topics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1050"><a href="#AgentMemoryManager-1050"><span class="linenos">1050</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No topics provided to get_memories_by_topic&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1051"><a href="#AgentMemoryManager-1051"><span class="linenos">1051</span></a>                <span class="k">return</span> <span class="p">(</span>
</span><span id="AgentMemoryManager-1052"><a href="#AgentMemoryManager-1052"><span class="linenos">1052</span></a>                    <span class="s2">&quot; Error: No topics provided. Please specify at least one topic.&quot;</span>
</span><span id="AgentMemoryManager-1053"><a href="#AgentMemoryManager-1053"><span class="linenos">1053</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-1054"><a href="#AgentMemoryManager-1054"><span class="linenos">1054</span></a>
</span><span id="AgentMemoryManager-1055"><a href="#AgentMemoryManager-1055"><span class="linenos">1055</span></a>            <span class="c1"># Parse topics parameter</span>
</span><span id="AgentMemoryManager-1056"><a href="#AgentMemoryManager-1056"><span class="linenos">1056</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AgentMemoryManager-1057"><a href="#AgentMemoryManager-1057"><span class="linenos">1057</span></a>                <span class="c1"># Convert string to list, handle comma-separated values</span>
</span><span id="AgentMemoryManager-1058"><a href="#AgentMemoryManager-1058"><span class="linenos">1058</span></a>                <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1059"><a href="#AgentMemoryManager-1059"><span class="linenos">1059</span></a>                    <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager-1060"><a href="#AgentMemoryManager-1060"><span class="linenos">1060</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1061"><a href="#AgentMemoryManager-1061"><span class="linenos">1061</span></a>                    <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">if</span> <span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-1062"><a href="#AgentMemoryManager-1062"><span class="linenos">1062</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager-1063"><a href="#AgentMemoryManager-1063"><span class="linenos">1063</span></a>                <span class="c1"># Clean up list - remove empty entries</span>
</span><span id="AgentMemoryManager-1064"><a href="#AgentMemoryManager-1064"><span class="linenos">1064</span></a>                <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager-1065"><a href="#AgentMemoryManager-1065"><span class="linenos">1065</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1066"><a href="#AgentMemoryManager-1066"><span class="linenos">1066</span></a>                <span class="c1"># Convert anything else to string and put in list</span>
</span><span id="AgentMemoryManager-1067"><a href="#AgentMemoryManager-1067"><span class="linenos">1067</span></a>                <span class="n">topic_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AgentMemoryManager-1068"><a href="#AgentMemoryManager-1068"><span class="linenos">1068</span></a>                <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">topic_str</span><span class="p">]</span> <span class="k">if</span> <span class="n">topic_str</span> <span class="ow">and</span> <span class="n">topic_str</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-1069"><a href="#AgentMemoryManager-1069"><span class="linenos">1069</span></a>
</span><span id="AgentMemoryManager-1070"><a href="#AgentMemoryManager-1070"><span class="linenos">1070</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">topic_list</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1071"><a href="#AgentMemoryManager-1071"><span class="linenos">1071</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid topics provided after parsing&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1072"><a href="#AgentMemoryManager-1072"><span class="linenos">1072</span></a>                <span class="k">return</span> <span class="s2">&quot; Error: No valid topics provided. Please specify at least one topic.&quot;</span>
</span><span id="AgentMemoryManager-1073"><a href="#AgentMemoryManager-1073"><span class="linenos">1073</span></a>
</span><span id="AgentMemoryManager-1074"><a href="#AgentMemoryManager-1074"><span class="linenos">1074</span></a>            <span class="c1"># Get all memories first</span>
</span><span id="AgentMemoryManager-1075"><a href="#AgentMemoryManager-1075"><span class="linenos">1075</span></a>            <span class="n">all_memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">get_all_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1076"><a href="#AgentMemoryManager-1076"><span class="linenos">1076</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager-1077"><a href="#AgentMemoryManager-1077"><span class="linenos">1077</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-1078"><a href="#AgentMemoryManager-1078"><span class="linenos">1078</span></a>
</span><span id="AgentMemoryManager-1079"><a href="#AgentMemoryManager-1079"><span class="linenos">1079</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">all_memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1080"><a href="#AgentMemoryManager-1080"><span class="linenos">1080</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No memories found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1081"><a href="#AgentMemoryManager-1081"><span class="linenos">1081</span></a>                <span class="k">return</span> <span class="s2">&quot; No memories found. Try storing some information first!&quot;</span>
</span><span id="AgentMemoryManager-1082"><a href="#AgentMemoryManager-1082"><span class="linenos">1082</span></a>
</span><span id="AgentMemoryManager-1083"><a href="#AgentMemoryManager-1083"><span class="linenos">1083</span></a>            <span class="c1"># Filter memories by topic</span>
</span><span id="AgentMemoryManager-1084"><a href="#AgentMemoryManager-1084"><span class="linenos">1084</span></a>            <span class="n">filtered_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-1085"><a href="#AgentMemoryManager-1085"><span class="linenos">1085</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">all_memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1086"><a href="#AgentMemoryManager-1086"><span class="linenos">1086</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;topics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1087"><a href="#AgentMemoryManager-1087"><span class="linenos">1087</span></a>                    <span class="c1"># Check if any of the requested topics match this memory&#39;s topics</span>
</span><span id="AgentMemoryManager-1088"><a href="#AgentMemoryManager-1088"><span class="linenos">1088</span></a>                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1089"><a href="#AgentMemoryManager-1089"><span class="linenos">1089</span></a>                        <span class="n">topic</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">]</span>
</span><span id="AgentMemoryManager-1090"><a href="#AgentMemoryManager-1090"><span class="linenos">1090</span></a>                        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">topic_list</span>
</span><span id="AgentMemoryManager-1091"><a href="#AgentMemoryManager-1091"><span class="linenos">1091</span></a>                    <span class="p">):</span>
</span><span id="AgentMemoryManager-1092"><a href="#AgentMemoryManager-1092"><span class="linenos">1092</span></a>                        <span class="n">filtered_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1093"><a href="#AgentMemoryManager-1093"><span class="linenos">1093</span></a>
</span><span id="AgentMemoryManager-1094"><a href="#AgentMemoryManager-1094"><span class="linenos">1094</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1095"><a href="#AgentMemoryManager-1095"><span class="linenos">1095</span></a>                <span class="n">topics_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topic_list</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1096"><a href="#AgentMemoryManager-1096"><span class="linenos">1096</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No memories found for topics: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">topics_str</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1097"><a href="#AgentMemoryManager-1097"><span class="linenos">1097</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; No memories found for topics: </span><span class="si">{</span><span class="n">topics_str</span><span class="si">}</span><span class="s2">. Try different topics or store new memories with these topics.&quot;</span>
</span><span id="AgentMemoryManager-1098"><a href="#AgentMemoryManager-1098"><span class="linenos">1098</span></a>
</span><span id="AgentMemoryManager-1099"><a href="#AgentMemoryManager-1099"><span class="linenos">1099</span></a>            <span class="c1"># Sort memories by timestamp (newest first)</span>
</span><span id="AgentMemoryManager-1100"><a href="#AgentMemoryManager-1100"><span class="linenos">1100</span></a>            <span class="n">sorted_memories</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1101"><a href="#AgentMemoryManager-1101"><span class="linenos">1101</span></a>                <span class="n">filtered_memories</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1102"><a href="#AgentMemoryManager-1102"><span class="linenos">1102</span></a>                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1103"><a href="#AgentMemoryManager-1103"><span class="linenos">1103</span></a>                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1104"><a href="#AgentMemoryManager-1104"><span class="linenos">1104</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-1105"><a href="#AgentMemoryManager-1105"><span class="linenos">1105</span></a>
</span><span id="AgentMemoryManager-1106"><a href="#AgentMemoryManager-1106"><span class="linenos">1106</span></a>            <span class="c1"># Limit the number of memories if specified</span>
</span><span id="AgentMemoryManager-1107"><a href="#AgentMemoryManager-1107"><span class="linenos">1107</span></a>            <span class="n">display_memories</span> <span class="o">=</span> <span class="n">sorted_memories</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">sorted_memories</span>
</span><span id="AgentMemoryManager-1108"><a href="#AgentMemoryManager-1108"><span class="linenos">1108</span></a>
</span><span id="AgentMemoryManager-1109"><a href="#AgentMemoryManager-1109"><span class="linenos">1109</span></a>            <span class="c1"># Format results</span>
</span><span id="AgentMemoryManager-1110"><a href="#AgentMemoryManager-1110"><span class="linenos">1110</span></a>            <span class="n">topics_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topic_list</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1111"><a href="#AgentMemoryManager-1111"><span class="linenos">1111</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; MEMORIES BY TOPIC: </span><span class="si">{</span><span class="n">topics_str</span><span class="si">}</span><span class="s2"> (showing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">display_memories</span><span class="p">)</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_memories</span><span class="p">)</span><span class="si">}</span><span class="s2"> matching memories)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1112"><a href="#AgentMemoryManager-1112"><span class="linenos">1112</span></a>
</span><span id="AgentMemoryManager-1113"><a href="#AgentMemoryManager-1113"><span class="linenos">1113</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">memory</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">display_memories</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AgentMemoryManager-1114"><a href="#AgentMemoryManager-1114"><span class="linenos">1114</span></a>                <span class="c1"># Format the memory content</span>
</span><span id="AgentMemoryManager-1115"><a href="#AgentMemoryManager-1115"><span class="linenos">1115</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1116"><a href="#AgentMemoryManager-1116"><span class="linenos">1116</span></a>
</span><span id="AgentMemoryManager-1117"><a href="#AgentMemoryManager-1117"><span class="linenos">1117</span></a>                <span class="c1"># Add topics if available</span>
</span><span id="AgentMemoryManager-1118"><a href="#AgentMemoryManager-1118"><span class="linenos">1118</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;topics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1119"><a href="#AgentMemoryManager-1119"><span class="linenos">1119</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1120"><a href="#AgentMemoryManager-1120"><span class="linenos">1120</span></a>
</span><span id="AgentMemoryManager-1121"><a href="#AgentMemoryManager-1121"><span class="linenos">1121</span></a>                <span class="c1"># Add timestamp if available</span>
</span><span id="AgentMemoryManager-1122"><a href="#AgentMemoryManager-1122"><span class="linenos">1122</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1123"><a href="#AgentMemoryManager-1123"><span class="linenos">1123</span></a>                    <span class="c1"># Convert timestamp to readable format</span>
</span><span id="AgentMemoryManager-1124"><a href="#AgentMemoryManager-1124"><span class="linenos">1124</span></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="AgentMemoryManager-1125"><a href="#AgentMemoryManager-1125"><span class="linenos">1125</span></a>
</span><span id="AgentMemoryManager-1126"><a href="#AgentMemoryManager-1126"><span class="linenos">1126</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1127"><a href="#AgentMemoryManager-1127"><span class="linenos">1127</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Created: </span><span class="si">{</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1128"><a href="#AgentMemoryManager-1128"><span class="linenos">1128</span></a>
</span><span id="AgentMemoryManager-1129"><a href="#AgentMemoryManager-1129"><span class="linenos">1129</span></a>                <span class="c1"># Add memory ID for reference</span>
</span><span id="AgentMemoryManager-1130"><a href="#AgentMemoryManager-1130"><span class="linenos">1130</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   ID: </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory_id</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1131"><a href="#AgentMemoryManager-1131"><span class="linenos">1131</span></a>
</span><span id="AgentMemoryManager-1132"><a href="#AgentMemoryManager-1132"><span class="linenos">1132</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1133"><a href="#AgentMemoryManager-1133"><span class="linenos">1133</span></a>                <span class="s2">&quot;Retrieved </span><span class="si">%d</span><span class="s2"> memories for topics </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_memories</span><span class="p">),</span> <span class="n">topics_str</span>
</span><span id="AgentMemoryManager-1134"><a href="#AgentMemoryManager-1134"><span class="linenos">1134</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-1135"><a href="#AgentMemoryManager-1135"><span class="linenos">1135</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager-1136"><a href="#AgentMemoryManager-1136"><span class="linenos">1136</span></a>
</span><span id="AgentMemoryManager-1137"><a href="#AgentMemoryManager-1137"><span class="linenos">1137</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1138"><a href="#AgentMemoryManager-1138"><span class="linenos">1138</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error retrieving memories by topic: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1139"><a href="#AgentMemoryManager-1139"><span class="linenos">1139</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error retrieving memories by topic: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1140"><a href="#AgentMemoryManager-1140"><span class="linenos">1140</span></a>
</span><span id="AgentMemoryManager-1141"><a href="#AgentMemoryManager-1141"><span class="linenos">1141</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1142"><a href="#AgentMemoryManager-1142"><span class="linenos">1142</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;List all memories in a simple, user-friendly format.</span>
</span><span id="AgentMemoryManager-1143"><a href="#AgentMemoryManager-1143"><span class="linenos">1143</span></a>
</span><span id="AgentMemoryManager-1144"><a href="#AgentMemoryManager-1144"><span class="linenos">1144</span></a><span class="sd">        This method provides a more concise view of all memories compared to get_all_memories,</span>
</span><span id="AgentMemoryManager-1145"><a href="#AgentMemoryManager-1145"><span class="linenos">1145</span></a><span class="sd">        focusing on just the content and topics without additional metadata.</span>
</span><span id="AgentMemoryManager-1146"><a href="#AgentMemoryManager-1146"><span class="linenos">1146</span></a><span class="sd">        </span>
</span><span id="AgentMemoryManager-1147"><a href="#AgentMemoryManager-1147"><span class="linenos">1147</span></a><span class="sd">        PERFORMANCE OPTIMIZED: Returns raw memory data without interpretation instructions</span>
</span><span id="AgentMemoryManager-1148"><a href="#AgentMemoryManager-1148"><span class="linenos">1148</span></a><span class="sd">        to avoid unnecessary LLM inference when user requests simple listing.</span>
</span><span id="AgentMemoryManager-1149"><a href="#AgentMemoryManager-1149"><span class="linenos">1149</span></a>
</span><span id="AgentMemoryManager-1150"><a href="#AgentMemoryManager-1150"><span class="linenos">1150</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-1151"><a href="#AgentMemoryManager-1151"><span class="linenos">1151</span></a><span class="sd">            str: Simplified list of all memories without interpretation instructions</span>
</span><span id="AgentMemoryManager-1152"><a href="#AgentMemoryManager-1152"><span class="linenos">1152</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-1153"><a href="#AgentMemoryManager-1153"><span class="linenos">1153</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1154"><a href="#AgentMemoryManager-1154"><span class="linenos">1154</span></a>            <span class="c1"># Direct call to SemanticMemoryManager.get_all_memories()</span>
</span><span id="AgentMemoryManager-1155"><a href="#AgentMemoryManager-1155"><span class="linenos">1155</span></a>            <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">get_all_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1156"><a href="#AgentMemoryManager-1156"><span class="linenos">1156</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager-1157"><a href="#AgentMemoryManager-1157"><span class="linenos">1157</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-1158"><a href="#AgentMemoryManager-1158"><span class="linenos">1158</span></a>
</span><span id="AgentMemoryManager-1159"><a href="#AgentMemoryManager-1159"><span class="linenos">1159</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1160"><a href="#AgentMemoryManager-1160"><span class="linenos">1160</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No memories found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1161"><a href="#AgentMemoryManager-1161"><span class="linenos">1161</span></a>                <span class="k">return</span> <span class="s2">&quot; No memories found. Try storing some information first!&quot;</span>
</span><span id="AgentMemoryManager-1162"><a href="#AgentMemoryManager-1162"><span class="linenos">1162</span></a>
</span><span id="AgentMemoryManager-1163"><a href="#AgentMemoryManager-1163"><span class="linenos">1163</span></a>            <span class="c1"># Sort memories by timestamp (newest first)</span>
</span><span id="AgentMemoryManager-1164"><a href="#AgentMemoryManager-1164"><span class="linenos">1164</span></a>            <span class="n">sorted_memories</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1165"><a href="#AgentMemoryManager-1165"><span class="linenos">1165</span></a>                <span class="n">memories</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1166"><a href="#AgentMemoryManager-1166"><span class="linenos">1166</span></a>                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1167"><a href="#AgentMemoryManager-1167"><span class="linenos">1167</span></a>                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1168"><a href="#AgentMemoryManager-1168"><span class="linenos">1168</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-1169"><a href="#AgentMemoryManager-1169"><span class="linenos">1169</span></a>
</span><span id="AgentMemoryManager-1170"><a href="#AgentMemoryManager-1170"><span class="linenos">1170</span></a>            <span class="c1"># Format results in a simplified way - NO INTERPRETATION INSTRUCTIONS</span>
</span><span id="AgentMemoryManager-1171"><a href="#AgentMemoryManager-1171"><span class="linenos">1171</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; MEMORY LIST (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span><span class="si">}</span><span class="s2"> total):</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1172"><a href="#AgentMemoryManager-1172"><span class="linenos">1172</span></a>
</span><span id="AgentMemoryManager-1173"><a href="#AgentMemoryManager-1173"><span class="linenos">1173</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">memory</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_memories</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AgentMemoryManager-1174"><a href="#AgentMemoryManager-1174"><span class="linenos">1174</span></a>                <span class="c1"># Just show the memory content and topics, omit other metadata</span>
</span><span id="AgentMemoryManager-1175"><a href="#AgentMemoryManager-1175"><span class="linenos">1175</span></a>                <span class="n">memory_preview</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager-1176"><a href="#AgentMemoryManager-1176"><span class="linenos">1176</span></a>                    <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
</span><span id="AgentMemoryManager-1177"><a href="#AgentMemoryManager-1177"><span class="linenos">1177</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span>
</span><span id="AgentMemoryManager-1178"><a href="#AgentMemoryManager-1178"><span class="linenos">1178</span></a>                    <span class="k">else</span> <span class="n">memory</span><span class="o">.</span><span class="n">memory</span>
</span><span id="AgentMemoryManager-1179"><a href="#AgentMemoryManager-1179"><span class="linenos">1179</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-1180"><a href="#AgentMemoryManager-1180"><span class="linenos">1180</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">memory_preview</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1181"><a href="#AgentMemoryManager-1181"><span class="linenos">1181</span></a>
</span><span id="AgentMemoryManager-1182"><a href="#AgentMemoryManager-1182"><span class="linenos">1182</span></a>                <span class="c1"># Add topics if available</span>
</span><span id="AgentMemoryManager-1183"><a href="#AgentMemoryManager-1183"><span class="linenos">1183</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;topics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1184"><a href="#AgentMemoryManager-1184"><span class="linenos">1184</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1185"><a href="#AgentMemoryManager-1185"><span class="linenos">1185</span></a>
</span><span id="AgentMemoryManager-1186"><a href="#AgentMemoryManager-1186"><span class="linenos">1186</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1187"><a href="#AgentMemoryManager-1187"><span class="linenos">1187</span></a>
</span><span id="AgentMemoryManager-1188"><a href="#AgentMemoryManager-1188"><span class="linenos">1188</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1189"><a href="#AgentMemoryManager-1189"><span class="linenos">1189</span></a>                <span class="s2">&quot;Listed all </span><span class="si">%d</span><span class="s2"> memories for user </span><span class="si">%s</span><span class="s2"> in simplified format (performance optimized)&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1190"><a href="#AgentMemoryManager-1190"><span class="linenos">1190</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">),</span>
</span><span id="AgentMemoryManager-1191"><a href="#AgentMemoryManager-1191"><span class="linenos">1191</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1192"><a href="#AgentMemoryManager-1192"><span class="linenos">1192</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-1193"><a href="#AgentMemoryManager-1193"><span class="linenos">1193</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager-1194"><a href="#AgentMemoryManager-1194"><span class="linenos">1194</span></a>
</span><span id="AgentMemoryManager-1195"><a href="#AgentMemoryManager-1195"><span class="linenos">1195</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1196"><a href="#AgentMemoryManager-1196"><span class="linenos">1196</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error listing memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1197"><a href="#AgentMemoryManager-1197"><span class="linenos">1197</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error listing memories: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1198"><a href="#AgentMemoryManager-1198"><span class="linenos">1198</span></a>
</span><span id="AgentMemoryManager-1199"><a href="#AgentMemoryManager-1199"><span class="linenos">1199</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">store_graph_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1200"><a href="#AgentMemoryManager-1200"><span class="linenos">1200</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1201"><a href="#AgentMemoryManager-1201"><span class="linenos">1201</span></a>        <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1202"><a href="#AgentMemoryManager-1202"><span class="linenos">1202</span></a>        <span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1203"><a href="#AgentMemoryManager-1203"><span class="linenos">1203</span></a>        <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1204"><a href="#AgentMemoryManager-1204"><span class="linenos">1204</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1205"><a href="#AgentMemoryManager-1205"><span class="linenos">1205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Store a memory in the LightRAG graph database to capture relationships.</span>
</span><span id="AgentMemoryManager-1206"><a href="#AgentMemoryManager-1206"><span class="linenos">1206</span></a>
</span><span id="AgentMemoryManager-1207"><a href="#AgentMemoryManager-1207"><span class="linenos">1207</span></a><span class="sd">        This method creates a text file with the memory content and uploads it to the LightRAG</span>
</span><span id="AgentMemoryManager-1208"><a href="#AgentMemoryManager-1208"><span class="linenos">1208</span></a><span class="sd">        memory server, which then processes it to extract entities and relationships.</span>
</span><span id="AgentMemoryManager-1209"><a href="#AgentMemoryManager-1209"><span class="linenos">1209</span></a>
</span><span id="AgentMemoryManager-1210"><a href="#AgentMemoryManager-1210"><span class="linenos">1210</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-1211"><a href="#AgentMemoryManager-1211"><span class="linenos">1211</span></a><span class="sd">            content: The memory content to store</span>
</span><span id="AgentMemoryManager-1212"><a href="#AgentMemoryManager-1212"><span class="linenos">1212</span></a><span class="sd">            topics: Optional list of topics/categories for the memory</span>
</span><span id="AgentMemoryManager-1213"><a href="#AgentMemoryManager-1213"><span class="linenos">1213</span></a><span class="sd">            memory_id: Optional memory ID to link with the SQLite memory</span>
</span><span id="AgentMemoryManager-1214"><a href="#AgentMemoryManager-1214"><span class="linenos">1214</span></a>
</span><span id="AgentMemoryManager-1215"><a href="#AgentMemoryManager-1215"><span class="linenos">1215</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-1216"><a href="#AgentMemoryManager-1216"><span class="linenos">1216</span></a><span class="sd">            str: Success or error message</span>
</span><span id="AgentMemoryManager-1217"><a href="#AgentMemoryManager-1217"><span class="linenos">1217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-1218"><a href="#AgentMemoryManager-1218"><span class="linenos">1218</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1219"><a href="#AgentMemoryManager-1219"><span class="linenos">1219</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1220"><a href="#AgentMemoryManager-1220"><span class="linenos">1220</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LightRAG memory URL not configured&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1221"><a href="#AgentMemoryManager-1221"><span class="linenos">1221</span></a>                <span class="k">return</span> <span class="s2">&quot; Graph memory not configured. Memory not stored in graph database.&quot;</span>
</span><span id="AgentMemoryManager-1222"><a href="#AgentMemoryManager-1222"><span class="linenos">1222</span></a>
</span><span id="AgentMemoryManager-1223"><a href="#AgentMemoryManager-1223"><span class="linenos">1223</span></a>            <span class="c1"># Validate content</span>
</span><span id="AgentMemoryManager-1224"><a href="#AgentMemoryManager-1224"><span class="linenos">1224</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="AgentMemoryManager-1225"><a href="#AgentMemoryManager-1225"><span class="linenos">1225</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Empty content provided to store_graph_memory&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1226"><a href="#AgentMemoryManager-1226"><span class="linenos">1226</span></a>                <span class="k">return</span> <span class="s2">&quot; Error: Content cannot be empty.&quot;</span>
</span><span id="AgentMemoryManager-1227"><a href="#AgentMemoryManager-1227"><span class="linenos">1227</span></a>
</span><span id="AgentMemoryManager-1228"><a href="#AgentMemoryManager-1228"><span class="linenos">1228</span></a>            <span class="c1"># Parse topics parameter</span>
</span><span id="AgentMemoryManager-1229"><a href="#AgentMemoryManager-1229"><span class="linenos">1229</span></a>            <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-1230"><a href="#AgentMemoryManager-1230"><span class="linenos">1230</span></a>            <span class="k">if</span> <span class="n">topics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1231"><a href="#AgentMemoryManager-1231"><span class="linenos">1231</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AgentMemoryManager-1232"><a href="#AgentMemoryManager-1232"><span class="linenos">1232</span></a>                    <span class="c1"># Convert string to list, handle comma-separated values</span>
</span><span id="AgentMemoryManager-1233"><a href="#AgentMemoryManager-1233"><span class="linenos">1233</span></a>                    <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1234"><a href="#AgentMemoryManager-1234"><span class="linenos">1234</span></a>                        <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager-1235"><a href="#AgentMemoryManager-1235"><span class="linenos">1235</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1236"><a href="#AgentMemoryManager-1236"><span class="linenos">1236</span></a>                        <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">if</span> <span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-1237"><a href="#AgentMemoryManager-1237"><span class="linenos">1237</span></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager-1238"><a href="#AgentMemoryManager-1238"><span class="linenos">1238</span></a>                    <span class="c1"># Clean up list - remove empty entries</span>
</span><span id="AgentMemoryManager-1239"><a href="#AgentMemoryManager-1239"><span class="linenos">1239</span></a>                    <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager-1240"><a href="#AgentMemoryManager-1240"><span class="linenos">1240</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1241"><a href="#AgentMemoryManager-1241"><span class="linenos">1241</span></a>                    <span class="c1"># Convert anything else to string and put in list</span>
</span><span id="AgentMemoryManager-1242"><a href="#AgentMemoryManager-1242"><span class="linenos">1242</span></a>                    <span class="n">topic_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AgentMemoryManager-1243"><a href="#AgentMemoryManager-1243"><span class="linenos">1243</span></a>                    <span class="n">topic_list</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager-1244"><a href="#AgentMemoryManager-1244"><span class="linenos">1244</span></a>                        <span class="p">[</span><span class="n">topic_str</span><span class="p">]</span> <span class="k">if</span> <span class="n">topic_str</span> <span class="ow">and</span> <span class="n">topic_str</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-1245"><a href="#AgentMemoryManager-1245"><span class="linenos">1245</span></a>                    <span class="p">)</span>
</span><span id="AgentMemoryManager-1246"><a href="#AgentMemoryManager-1246"><span class="linenos">1246</span></a>
</span><span id="AgentMemoryManager-1247"><a href="#AgentMemoryManager-1247"><span class="linenos">1247</span></a>            <span class="c1"># Create a unique filename for this memory</span>
</span><span id="AgentMemoryManager-1248"><a href="#AgentMemoryManager-1248"><span class="linenos">1248</span></a>            <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span><span id="AgentMemoryManager-1249"><a href="#AgentMemoryManager-1249"><span class="linenos">1249</span></a>            <span class="n">memory_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>
</span><span id="AgentMemoryManager-1250"><a href="#AgentMemoryManager-1250"><span class="linenos">1250</span></a>
</span><span id="AgentMemoryManager-1251"><a href="#AgentMemoryManager-1251"><span class="linenos">1251</span></a>            <span class="c1"># If memory_id is provided, use it in the filename for traceability</span>
</span><span id="AgentMemoryManager-1252"><a href="#AgentMemoryManager-1252"><span class="linenos">1252</span></a>            <span class="k">if</span> <span class="n">memory_id</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1253"><a href="#AgentMemoryManager-1253"><span class="linenos">1253</span></a>                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;memory_</span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">memory_hash</span><span class="si">}</span><span class="s2">.txt&quot;</span>
</span><span id="AgentMemoryManager-1254"><a href="#AgentMemoryManager-1254"><span class="linenos">1254</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1255"><a href="#AgentMemoryManager-1255"><span class="linenos">1255</span></a>                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;memory_</span><span class="si">{</span><span class="n">memory_hash</span><span class="si">}</span><span class="s2">.txt&quot;</span>
</span><span id="AgentMemoryManager-1256"><a href="#AgentMemoryManager-1256"><span class="linenos">1256</span></a>
</span><span id="AgentMemoryManager-1257"><a href="#AgentMemoryManager-1257"><span class="linenos">1257</span></a>            <span class="c1"># Prepare the content with metadata</span>
</span><span id="AgentMemoryManager-1258"><a href="#AgentMemoryManager-1258"><span class="linenos">1258</span></a>            <span class="n">file_content</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="AgentMemoryManager-1259"><a href="#AgentMemoryManager-1259"><span class="linenos">1259</span></a>
</span><span id="AgentMemoryManager-1260"><a href="#AgentMemoryManager-1260"><span class="linenos">1260</span></a>            <span class="c1"># Add topics as metadata if available</span>
</span><span id="AgentMemoryManager-1261"><a href="#AgentMemoryManager-1261"><span class="linenos">1261</span></a>            <span class="k">if</span> <span class="n">topic_list</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1262"><a href="#AgentMemoryManager-1262"><span class="linenos">1262</span></a>                <span class="n">file_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topic_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1263"><a href="#AgentMemoryManager-1263"><span class="linenos">1263</span></a>
</span><span id="AgentMemoryManager-1264"><a href="#AgentMemoryManager-1264"><span class="linenos">1264</span></a>            <span class="c1"># Create a temporary file</span>
</span><span id="AgentMemoryManager-1265"><a href="#AgentMemoryManager-1265"><span class="linenos">1265</span></a>            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1266"><a href="#AgentMemoryManager-1266"><span class="linenos">1266</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span>
</span><span id="AgentMemoryManager-1267"><a href="#AgentMemoryManager-1267"><span class="linenos">1267</span></a>            <span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1268"><a href="#AgentMemoryManager-1268"><span class="linenos">1268</span></a>                <span class="n">temp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1269"><a href="#AgentMemoryManager-1269"><span class="linenos">1269</span></a>                <span class="n">temp_file_path</span> <span class="o">=</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span>
</span><span id="AgentMemoryManager-1270"><a href="#AgentMemoryManager-1270"><span class="linenos">1270</span></a>
</span><span id="AgentMemoryManager-1271"><a href="#AgentMemoryManager-1271"><span class="linenos">1271</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1272"><a href="#AgentMemoryManager-1272"><span class="linenos">1272</span></a>                <span class="c1"># Upload the file using the /documents/upload endpoint</span>
</span><span id="AgentMemoryManager-1273"><a href="#AgentMemoryManager-1273"><span class="linenos">1273</span></a>                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents/upload&quot;</span>
</span><span id="AgentMemoryManager-1274"><a href="#AgentMemoryManager-1274"><span class="linenos">1274</span></a>
</span><span id="AgentMemoryManager-1275"><a href="#AgentMemoryManager-1275"><span class="linenos">1275</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1276"><a href="#AgentMemoryManager-1276"><span class="linenos">1276</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1277"><a href="#AgentMemoryManager-1277"><span class="linenos">1277</span></a>                        <span class="c1"># Create form data for file upload</span>
</span><span id="AgentMemoryManager-1278"><a href="#AgentMemoryManager-1278"><span class="linenos">1278</span></a>                        <span class="n">data</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">FormData</span><span class="p">()</span>
</span><span id="AgentMemoryManager-1279"><a href="#AgentMemoryManager-1279"><span class="linenos">1279</span></a>                        <span class="n">data</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1280"><a href="#AgentMemoryManager-1280"><span class="linenos">1280</span></a>                            <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span>
</span><span id="AgentMemoryManager-1281"><a href="#AgentMemoryManager-1281"><span class="linenos">1281</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager-1282"><a href="#AgentMemoryManager-1282"><span class="linenos">1282</span></a>
</span><span id="AgentMemoryManager-1283"><a href="#AgentMemoryManager-1283"><span class="linenos">1283</span></a>                        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1284"><a href="#AgentMemoryManager-1284"><span class="linenos">1284</span></a>                            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">]:</span>
</span><span id="AgentMemoryManager-1285"><a href="#AgentMemoryManager-1285"><span class="linenos">1285</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1286"><a href="#AgentMemoryManager-1286"><span class="linenos">1286</span></a>                                    <span class="s2">&quot;Successfully stored memory in graph database: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1287"><a href="#AgentMemoryManager-1287"><span class="linenos">1287</span></a>                                    <span class="n">filename</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1288"><a href="#AgentMemoryManager-1288"><span class="linenos">1288</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager-1289"><a href="#AgentMemoryManager-1289"><span class="linenos">1289</span></a>                                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Memory successfully stored in graph database: </span><span class="si">{</span><span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span id="AgentMemoryManager-1290"><a href="#AgentMemoryManager-1290"><span class="linenos">1290</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1291"><a href="#AgentMemoryManager-1291"><span class="linenos">1291</span></a>                                <span class="n">error_detail</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager-1292"><a href="#AgentMemoryManager-1292"><span class="linenos">1292</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1293"><a href="#AgentMemoryManager-1293"><span class="linenos">1293</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Failed to store memory in graph: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1294"><a href="#AgentMemoryManager-1294"><span class="linenos">1294</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager-1295"><a href="#AgentMemoryManager-1295"><span class="linenos">1295</span></a>                                <span class="k">return</span> <span class="p">(</span>
</span><span id="AgentMemoryManager-1296"><a href="#AgentMemoryManager-1296"><span class="linenos">1296</span></a>                                    <span class="sa">f</span><span class="s2">&quot; Error storing memory in graph: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1297"><a href="#AgentMemoryManager-1297"><span class="linenos">1297</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager-1298"><a href="#AgentMemoryManager-1298"><span class="linenos">1298</span></a>
</span><span id="AgentMemoryManager-1299"><a href="#AgentMemoryManager-1299"><span class="linenos">1299</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1300"><a href="#AgentMemoryManager-1300"><span class="linenos">1300</span></a>                <span class="c1"># Clean up the temporary file</span>
</span><span id="AgentMemoryManager-1301"><a href="#AgentMemoryManager-1301"><span class="linenos">1301</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1302"><a href="#AgentMemoryManager-1302"><span class="linenos">1302</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1303"><a href="#AgentMemoryManager-1303"><span class="linenos">1303</span></a>                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1304"><a href="#AgentMemoryManager-1304"><span class="linenos">1304</span></a>                    <span class="k">pass</span>  <span class="c1"># Ignore cleanup errors</span>
</span><span id="AgentMemoryManager-1305"><a href="#AgentMemoryManager-1305"><span class="linenos">1305</span></a>
</span><span id="AgentMemoryManager-1306"><a href="#AgentMemoryManager-1306"><span class="linenos">1306</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1307"><a href="#AgentMemoryManager-1307"><span class="linenos">1307</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error storing memory in graph: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1308"><a href="#AgentMemoryManager-1308"><span class="linenos">1308</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error storing memory in graph: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1309"><a href="#AgentMemoryManager-1309"><span class="linenos">1309</span></a>
</span><span id="AgentMemoryManager-1310"><a href="#AgentMemoryManager-1310"><span class="linenos">1310</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query_graph_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1311"><a href="#AgentMemoryManager-1311"><span class="linenos">1311</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1312"><a href="#AgentMemoryManager-1312"><span class="linenos">1312</span></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1313"><a href="#AgentMemoryManager-1313"><span class="linenos">1313</span></a>        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mix&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1314"><a href="#AgentMemoryManager-1314"><span class="linenos">1314</span></a>        <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1315"><a href="#AgentMemoryManager-1315"><span class="linenos">1315</span></a>        <span class="n">response_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Multiple Paragraphs&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1316"><a href="#AgentMemoryManager-1316"><span class="linenos">1316</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1317"><a href="#AgentMemoryManager-1317"><span class="linenos">1317</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query the LightRAG memory graph to explore relationships between memories.</span>
</span><span id="AgentMemoryManager-1318"><a href="#AgentMemoryManager-1318"><span class="linenos">1318</span></a>
</span><span id="AgentMemoryManager-1319"><a href="#AgentMemoryManager-1319"><span class="linenos">1319</span></a><span class="sd">        This method sends a query to the LightRAG memory server to retrieve memories and their</span>
</span><span id="AgentMemoryManager-1320"><a href="#AgentMemoryManager-1320"><span class="linenos">1320</span></a><span class="sd">        relationships based on the query. It supports different query modes and response formats.</span>
</span><span id="AgentMemoryManager-1321"><a href="#AgentMemoryManager-1321"><span class="linenos">1321</span></a>
</span><span id="AgentMemoryManager-1322"><a href="#AgentMemoryManager-1322"><span class="linenos">1322</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager-1323"><a href="#AgentMemoryManager-1323"><span class="linenos">1323</span></a><span class="sd">            query: The query to search for in the memory graph</span>
</span><span id="AgentMemoryManager-1324"><a href="#AgentMemoryManager-1324"><span class="linenos">1324</span></a><span class="sd">            mode: Query mode - &quot;semantic&quot; (vector search), &quot;graph&quot; (graph traversal), or &quot;mix&quot; (combined)</span>
</span><span id="AgentMemoryManager-1325"><a href="#AgentMemoryManager-1325"><span class="linenos">1325</span></a><span class="sd">            top_k: Maximum number of results to return</span>
</span><span id="AgentMemoryManager-1326"><a href="#AgentMemoryManager-1326"><span class="linenos">1326</span></a><span class="sd">            response_type: Format of the response - &quot;Multiple Paragraphs&quot;, &quot;Single Paragraph&quot;, etc.</span>
</span><span id="AgentMemoryManager-1327"><a href="#AgentMemoryManager-1327"><span class="linenos">1327</span></a>
</span><span id="AgentMemoryManager-1328"><a href="#AgentMemoryManager-1328"><span class="linenos">1328</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-1329"><a href="#AgentMemoryManager-1329"><span class="linenos">1329</span></a><span class="sd">            dict: Query results with memories and their relationships</span>
</span><span id="AgentMemoryManager-1330"><a href="#AgentMemoryManager-1330"><span class="linenos">1330</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-1331"><a href="#AgentMemoryManager-1331"><span class="linenos">1331</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1332"><a href="#AgentMemoryManager-1332"><span class="linenos">1332</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1333"><a href="#AgentMemoryManager-1333"><span class="linenos">1333</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LightRAG memory URL not configured&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1334"><a href="#AgentMemoryManager-1334"><span class="linenos">1334</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="AgentMemoryManager-1335"><a href="#AgentMemoryManager-1335"><span class="linenos">1335</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Graph memory not configured. Cannot query graph database.&quot;</span>
</span><span id="AgentMemoryManager-1336"><a href="#AgentMemoryManager-1336"><span class="linenos">1336</span></a>                <span class="p">}</span>
</span><span id="AgentMemoryManager-1337"><a href="#AgentMemoryManager-1337"><span class="linenos">1337</span></a>
</span><span id="AgentMemoryManager-1338"><a href="#AgentMemoryManager-1338"><span class="linenos">1338</span></a>            <span class="c1"># Validate query</span>
</span><span id="AgentMemoryManager-1339"><a href="#AgentMemoryManager-1339"><span class="linenos">1339</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="AgentMemoryManager-1340"><a href="#AgentMemoryManager-1340"><span class="linenos">1340</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Empty query provided to query_graph_memory&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1341"><a href="#AgentMemoryManager-1341"><span class="linenos">1341</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Query cannot be empty. Please provide a search term.&quot;</span><span class="p">}</span>
</span><span id="AgentMemoryManager-1342"><a href="#AgentMemoryManager-1342"><span class="linenos">1342</span></a>
</span><span id="AgentMemoryManager-1343"><a href="#AgentMemoryManager-1343"><span class="linenos">1343</span></a>            <span class="c1"># Validate mode</span>
</span><span id="AgentMemoryManager-1344"><a href="#AgentMemoryManager-1344"><span class="linenos">1344</span></a>            <span class="n">valid_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager-1345"><a href="#AgentMemoryManager-1345"><span class="linenos">1345</span></a>            <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_modes</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1346"><a href="#AgentMemoryManager-1346"><span class="linenos">1346</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid mode &#39;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39; provided to query_graph_memory&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1347"><a href="#AgentMemoryManager-1347"><span class="linenos">1347</span></a>                <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;mix&quot;</span>  <span class="c1"># Default to mix mode</span>
</span><span id="AgentMemoryManager-1348"><a href="#AgentMemoryManager-1348"><span class="linenos">1348</span></a>
</span><span id="AgentMemoryManager-1349"><a href="#AgentMemoryManager-1349"><span class="linenos">1349</span></a>            <span class="c1"># Validate response_type</span>
</span><span id="AgentMemoryManager-1350"><a href="#AgentMemoryManager-1350"><span class="linenos">1350</span></a>            <span class="n">valid_response_types</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager-1351"><a href="#AgentMemoryManager-1351"><span class="linenos">1351</span></a>                <span class="s2">&quot;Multiple Paragraphs&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1352"><a href="#AgentMemoryManager-1352"><span class="linenos">1352</span></a>                <span class="s2">&quot;Single Paragraph&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1353"><a href="#AgentMemoryManager-1353"><span class="linenos">1353</span></a>                <span class="s2">&quot;Bullet Points&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1354"><a href="#AgentMemoryManager-1354"><span class="linenos">1354</span></a>                <span class="s2">&quot;JSON&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1355"><a href="#AgentMemoryManager-1355"><span class="linenos">1355</span></a>            <span class="p">]</span>
</span><span id="AgentMemoryManager-1356"><a href="#AgentMemoryManager-1356"><span class="linenos">1356</span></a>            <span class="k">if</span> <span class="n">response_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_response_types</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1357"><a href="#AgentMemoryManager-1357"><span class="linenos">1357</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1358"><a href="#AgentMemoryManager-1358"><span class="linenos">1358</span></a>                    <span class="sa">f</span><span class="s2">&quot;Invalid response_type &#39;</span><span class="si">{</span><span class="n">response_type</span><span class="si">}</span><span class="s2">&#39; provided to query_graph_memory&quot;</span>
</span><span id="AgentMemoryManager-1359"><a href="#AgentMemoryManager-1359"><span class="linenos">1359</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager-1360"><a href="#AgentMemoryManager-1360"><span class="linenos">1360</span></a>                <span class="n">response_type</span> <span class="o">=</span> <span class="s2">&quot;Multiple Paragraphs&quot;</span>  <span class="c1"># Default to multiple paragraphs</span>
</span><span id="AgentMemoryManager-1361"><a href="#AgentMemoryManager-1361"><span class="linenos">1361</span></a>
</span><span id="AgentMemoryManager-1362"><a href="#AgentMemoryManager-1362"><span class="linenos">1362</span></a>            <span class="c1"># Prepare the query parameters</span>
</span><span id="AgentMemoryManager-1363"><a href="#AgentMemoryManager-1363"><span class="linenos">1363</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentMemoryManager-1364"><a href="#AgentMemoryManager-1364"><span class="linenos">1364</span></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
</span><span id="AgentMemoryManager-1365"><a href="#AgentMemoryManager-1365"><span class="linenos">1365</span></a>                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1366"><a href="#AgentMemoryManager-1366"><span class="linenos">1366</span></a>                <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="n">top_k</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1367"><a href="#AgentMemoryManager-1367"><span class="linenos">1367</span></a>                <span class="s2">&quot;response_type&quot;</span><span class="p">:</span> <span class="n">response_type</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1368"><a href="#AgentMemoryManager-1368"><span class="linenos">1368</span></a>            <span class="p">}</span>
</span><span id="AgentMemoryManager-1369"><a href="#AgentMemoryManager-1369"><span class="linenos">1369</span></a>
</span><span id="AgentMemoryManager-1370"><a href="#AgentMemoryManager-1370"><span class="linenos">1370</span></a>            <span class="c1"># Send the query to the LightRAG memory server</span>
</span><span id="AgentMemoryManager-1371"><a href="#AgentMemoryManager-1371"><span class="linenos">1371</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/query&quot;</span>
</span><span id="AgentMemoryManager-1372"><a href="#AgentMemoryManager-1372"><span class="linenos">1372</span></a>
</span><span id="AgentMemoryManager-1373"><a href="#AgentMemoryManager-1373"><span class="linenos">1373</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1374"><a href="#AgentMemoryManager-1374"><span class="linenos">1374</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1375"><a href="#AgentMemoryManager-1375"><span class="linenos">1375</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1376"><a href="#AgentMemoryManager-1376"><span class="linenos">1376</span></a>                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentMemoryManager-1377"><a href="#AgentMemoryManager-1377"><span class="linenos">1377</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1378"><a href="#AgentMemoryManager-1378"><span class="linenos">1378</span></a>                            <span class="sa">f</span><span class="s2">&quot;Successfully queried graph memory: </span><span class="si">{</span><span class="n">query</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span id="AgentMemoryManager-1379"><a href="#AgentMemoryManager-1379"><span class="linenos">1379</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager-1380"><a href="#AgentMemoryManager-1380"><span class="linenos">1380</span></a>                        <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager-1381"><a href="#AgentMemoryManager-1381"><span class="linenos">1381</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1382"><a href="#AgentMemoryManager-1382"><span class="linenos">1382</span></a>                        <span class="n">error_detail</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager-1383"><a href="#AgentMemoryManager-1383"><span class="linenos">1383</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to query graph memory: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1384"><a href="#AgentMemoryManager-1384"><span class="linenos">1384</span></a>                        <span class="k">return</span> <span class="p">{</span>
</span><span id="AgentMemoryManager-1385"><a href="#AgentMemoryManager-1385"><span class="linenos">1385</span></a>                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error querying graph memory: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1386"><a href="#AgentMemoryManager-1386"><span class="linenos">1386</span></a>                            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1387"><a href="#AgentMemoryManager-1387"><span class="linenos">1387</span></a>                            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1388"><a href="#AgentMemoryManager-1388"><span class="linenos">1388</span></a>                        <span class="p">}</span>
</span><span id="AgentMemoryManager-1389"><a href="#AgentMemoryManager-1389"><span class="linenos">1389</span></a>
</span><span id="AgentMemoryManager-1390"><a href="#AgentMemoryManager-1390"><span class="linenos">1390</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1391"><a href="#AgentMemoryManager-1391"><span class="linenos">1391</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying graph memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1392"><a href="#AgentMemoryManager-1392"><span class="linenos">1392</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="AgentMemoryManager-1393"><a href="#AgentMemoryManager-1393"><span class="linenos">1393</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error querying graph memory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1394"><a href="#AgentMemoryManager-1394"><span class="linenos">1394</span></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1395"><a href="#AgentMemoryManager-1395"><span class="linenos">1395</span></a>                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
</span><span id="AgentMemoryManager-1396"><a href="#AgentMemoryManager-1396"><span class="linenos">1396</span></a>            <span class="p">}</span>
</span><span id="AgentMemoryManager-1397"><a href="#AgentMemoryManager-1397"><span class="linenos">1397</span></a>
</span><span id="AgentMemoryManager-1398"><a href="#AgentMemoryManager-1398"><span class="linenos">1398</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_graph_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1399"><a href="#AgentMemoryManager-1399"><span class="linenos">1399</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the list of all entity and relation labels from the memory graph.</span>
</span><span id="AgentMemoryManager-1400"><a href="#AgentMemoryManager-1400"><span class="linenos">1400</span></a>
</span><span id="AgentMemoryManager-1401"><a href="#AgentMemoryManager-1401"><span class="linenos">1401</span></a><span class="sd">        This method retrieves all entity and relation labels from the LightRAG memory graph,</span>
</span><span id="AgentMemoryManager-1402"><a href="#AgentMemoryManager-1402"><span class="linenos">1402</span></a><span class="sd">        providing insights into the types of information stored in the graph.</span>
</span><span id="AgentMemoryManager-1403"><a href="#AgentMemoryManager-1403"><span class="linenos">1403</span></a>
</span><span id="AgentMemoryManager-1404"><a href="#AgentMemoryManager-1404"><span class="linenos">1404</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager-1405"><a href="#AgentMemoryManager-1405"><span class="linenos">1405</span></a><span class="sd">            str: Formatted string with entity and relation labels</span>
</span><span id="AgentMemoryManager-1406"><a href="#AgentMemoryManager-1406"><span class="linenos">1406</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-1407"><a href="#AgentMemoryManager-1407"><span class="linenos">1407</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1408"><a href="#AgentMemoryManager-1408"><span class="linenos">1408</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1409"><a href="#AgentMemoryManager-1409"><span class="linenos">1409</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LightRAG memory URL not configured&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1410"><a href="#AgentMemoryManager-1410"><span class="linenos">1410</span></a>                <span class="k">return</span> <span class="s2">&quot; Graph memory not configured. Cannot retrieve graph labels.&quot;</span>
</span><span id="AgentMemoryManager-1411"><a href="#AgentMemoryManager-1411"><span class="linenos">1411</span></a>
</span><span id="AgentMemoryManager-1412"><a href="#AgentMemoryManager-1412"><span class="linenos">1412</span></a>            <span class="c1"># Send the request to the LightRAG memory server</span>
</span><span id="AgentMemoryManager-1413"><a href="#AgentMemoryManager-1413"><span class="linenos">1413</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/label/list&quot;</span>
</span><span id="AgentMemoryManager-1414"><a href="#AgentMemoryManager-1414"><span class="linenos">1414</span></a>
</span><span id="AgentMemoryManager-1415"><a href="#AgentMemoryManager-1415"><span class="linenos">1415</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1416"><a href="#AgentMemoryManager-1416"><span class="linenos">1416</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1417"><a href="#AgentMemoryManager-1417"><span class="linenos">1417</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1418"><a href="#AgentMemoryManager-1418"><span class="linenos">1418</span></a>                        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentMemoryManager-1419"><a href="#AgentMemoryManager-1419"><span class="linenos">1419</span></a>
</span><span id="AgentMemoryManager-1420"><a href="#AgentMemoryManager-1420"><span class="linenos">1420</span></a>                        <span class="c1"># Handle different response formats</span>
</span><span id="AgentMemoryManager-1421"><a href="#AgentMemoryManager-1421"><span class="linenos">1421</span></a>                        <span class="n">entity_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-1422"><a href="#AgentMemoryManager-1422"><span class="linenos">1422</span></a>                        <span class="n">relation_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager-1423"><a href="#AgentMemoryManager-1423"><span class="linenos">1423</span></a>
</span><span id="AgentMemoryManager-1424"><a href="#AgentMemoryManager-1424"><span class="linenos">1424</span></a>                        <span class="c1"># Format 1: Direct array of all labels</span>
</span><span id="AgentMemoryManager-1425"><a href="#AgentMemoryManager-1425"><span class="linenos">1425</span></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager-1426"><a href="#AgentMemoryManager-1426"><span class="linenos">1426</span></a>                            <span class="n">all_labels</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="AgentMemoryManager-1427"><a href="#AgentMemoryManager-1427"><span class="linenos">1427</span></a>                            <span class="c1"># We can&#39;t distinguish between entity and relation labels in this format</span>
</span><span id="AgentMemoryManager-1428"><a href="#AgentMemoryManager-1428"><span class="linenos">1428</span></a>                            <span class="n">entity_labels</span> <span class="o">=</span> <span class="n">all_labels</span>
</span><span id="AgentMemoryManager-1429"><a href="#AgentMemoryManager-1429"><span class="linenos">1429</span></a>
</span><span id="AgentMemoryManager-1430"><a href="#AgentMemoryManager-1430"><span class="linenos">1430</span></a>                        <span class="c1"># Format 2: Dict with &#39;labels&#39; key containing all labels</span>
</span><span id="AgentMemoryManager-1431"><a href="#AgentMemoryManager-1431"><span class="linenos">1431</span></a>                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1432"><a href="#AgentMemoryManager-1432"><span class="linenos">1432</span></a>                            <span class="n">all_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager-1433"><a href="#AgentMemoryManager-1433"><span class="linenos">1433</span></a>                            <span class="c1"># We can&#39;t distinguish between entity and relation labels in this format</span>
</span><span id="AgentMemoryManager-1434"><a href="#AgentMemoryManager-1434"><span class="linenos">1434</span></a>                            <span class="n">entity_labels</span> <span class="o">=</span> <span class="n">all_labels</span>
</span><span id="AgentMemoryManager-1435"><a href="#AgentMemoryManager-1435"><span class="linenos">1435</span></a>
</span><span id="AgentMemoryManager-1436"><a href="#AgentMemoryManager-1436"><span class="linenos">1436</span></a>                        <span class="c1"># Format 3: Dict with separate &#39;entity_labels&#39; and &#39;relation_labels&#39; keys</span>
</span><span id="AgentMemoryManager-1437"><a href="#AgentMemoryManager-1437"><span class="linenos">1437</span></a>                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="AgentMemoryManager-1438"><a href="#AgentMemoryManager-1438"><span class="linenos">1438</span></a>                            <span class="k">if</span> <span class="s2">&quot;entity_labels&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1439"><a href="#AgentMemoryManager-1439"><span class="linenos">1439</span></a>                                <span class="n">entity_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;entity_labels&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager-1440"><a href="#AgentMemoryManager-1440"><span class="linenos">1440</span></a>                            <span class="k">if</span> <span class="s2">&quot;relation_labels&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1441"><a href="#AgentMemoryManager-1441"><span class="linenos">1441</span></a>                                <span class="n">relation_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;relation_labels&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager-1442"><a href="#AgentMemoryManager-1442"><span class="linenos">1442</span></a>
</span><span id="AgentMemoryManager-1443"><a href="#AgentMemoryManager-1443"><span class="linenos">1443</span></a>                        <span class="c1"># Format the result</span>
</span><span id="AgentMemoryManager-1444"><a href="#AgentMemoryManager-1444"><span class="linenos">1444</span></a>                        <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot; MEMORY GRAPH LABELS</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1445"><a href="#AgentMemoryManager-1445"><span class="linenos">1445</span></a>
</span><span id="AgentMemoryManager-1446"><a href="#AgentMemoryManager-1446"><span class="linenos">1446</span></a>                        <span class="k">if</span> <span class="n">entity_labels</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1447"><a href="#AgentMemoryManager-1447"><span class="linenos">1447</span></a>                            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;Entity Types:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1448"><a href="#AgentMemoryManager-1448"><span class="linenos">1448</span></a>                            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">entity_labels</span><span class="p">):</span>
</span><span id="AgentMemoryManager-1449"><a href="#AgentMemoryManager-1449"><span class="linenos">1449</span></a>                                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1450"><a href="#AgentMemoryManager-1450"><span class="linenos">1450</span></a>                            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1451"><a href="#AgentMemoryManager-1451"><span class="linenos">1451</span></a>
</span><span id="AgentMemoryManager-1452"><a href="#AgentMemoryManager-1452"><span class="linenos">1452</span></a>                        <span class="k">if</span> <span class="n">relation_labels</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1453"><a href="#AgentMemoryManager-1453"><span class="linenos">1453</span></a>                            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;Relation Types:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1454"><a href="#AgentMemoryManager-1454"><span class="linenos">1454</span></a>                            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">relation_labels</span><span class="p">):</span>
</span><span id="AgentMemoryManager-1455"><a href="#AgentMemoryManager-1455"><span class="linenos">1455</span></a>                                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1456"><a href="#AgentMemoryManager-1456"><span class="linenos">1456</span></a>
</span><span id="AgentMemoryManager-1457"><a href="#AgentMemoryManager-1457"><span class="linenos">1457</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">entity_labels</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">relation_labels</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1458"><a href="#AgentMemoryManager-1458"><span class="linenos">1458</span></a>                            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;No labels found in the memory graph. Try storing some memories first!&quot;</span>
</span><span id="AgentMemoryManager-1459"><a href="#AgentMemoryManager-1459"><span class="linenos">1459</span></a>
</span><span id="AgentMemoryManager-1460"><a href="#AgentMemoryManager-1460"><span class="linenos">1460</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retrieved memory graph labels successfully&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1461"><a href="#AgentMemoryManager-1461"><span class="linenos">1461</span></a>                        <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager-1462"><a href="#AgentMemoryManager-1462"><span class="linenos">1462</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1463"><a href="#AgentMemoryManager-1463"><span class="linenos">1463</span></a>                        <span class="n">error_detail</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager-1464"><a href="#AgentMemoryManager-1464"><span class="linenos">1464</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1465"><a href="#AgentMemoryManager-1465"><span class="linenos">1465</span></a>                            <span class="sa">f</span><span class="s2">&quot;Failed to retrieve graph labels: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1466"><a href="#AgentMemoryManager-1466"><span class="linenos">1466</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager-1467"><a href="#AgentMemoryManager-1467"><span class="linenos">1467</span></a>                        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error retrieving graph labels: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1468"><a href="#AgentMemoryManager-1468"><span class="linenos">1468</span></a>
</span><span id="AgentMemoryManager-1469"><a href="#AgentMemoryManager-1469"><span class="linenos">1469</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1470"><a href="#AgentMemoryManager-1470"><span class="linenos">1470</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error retrieving memory graph labels: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1471"><a href="#AgentMemoryManager-1471"><span class="linenos">1471</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error retrieving memory graph labels: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1472"><a href="#AgentMemoryManager-1472"><span class="linenos">1472</span></a>
</span><span id="AgentMemoryManager-1473"><a href="#AgentMemoryManager-1473"><span class="linenos">1473</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_memories_by_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1474"><a href="#AgentMemoryManager-1474"><span class="linenos">1474</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete all memories associated with a specific topic or list of topics from both local and graph memory.&quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager-1475"><a href="#AgentMemoryManager-1475"><span class="linenos">1475</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1476"><a href="#AgentMemoryManager-1476"><span class="linenos">1476</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AgentMemoryManager-1477"><a href="#AgentMemoryManager-1477"><span class="linenos">1477</span></a>                <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
</span><span id="AgentMemoryManager-1478"><a href="#AgentMemoryManager-1478"><span class="linenos">1478</span></a>
</span><span id="AgentMemoryManager-1479"><a href="#AgentMemoryManager-1479"><span class="linenos">1479</span></a>            <span class="c1"># Get memories to delete from local storage</span>
</span><span id="AgentMemoryManager-1480"><a href="#AgentMemoryManager-1480"><span class="linenos">1480</span></a>            <span class="n">memories_to_delete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">get_memories_by_topic</span><span class="p">(</span>
</span><span id="AgentMemoryManager-1481"><a href="#AgentMemoryManager-1481"><span class="linenos">1481</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager-1482"><a href="#AgentMemoryManager-1482"><span class="linenos">1482</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager-1483"><a href="#AgentMemoryManager-1483"><span class="linenos">1483</span></a>
</span><span id="AgentMemoryManager-1484"><a href="#AgentMemoryManager-1484"><span class="linenos">1484</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories_to_delete</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1485"><a href="#AgentMemoryManager-1485"><span class="linenos">1485</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;No memories found for topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1486"><a href="#AgentMemoryManager-1486"><span class="linenos">1486</span></a>
</span><span id="AgentMemoryManager-1487"><a href="#AgentMemoryManager-1487"><span class="linenos">1487</span></a>            <span class="n">deleted_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AgentMemoryManager-1488"><a href="#AgentMemoryManager-1488"><span class="linenos">1488</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories_to_delete</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1489"><a href="#AgentMemoryManager-1489"><span class="linenos">1489</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">memory_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1490"><a href="#AgentMemoryManager-1490"><span class="linenos">1490</span></a>                <span class="n">deleted_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AgentMemoryManager-1491"><a href="#AgentMemoryManager-1491"><span class="linenos">1491</span></a>
</span><span id="AgentMemoryManager-1492"><a href="#AgentMemoryManager-1492"><span class="linenos">1492</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Successfully deleted </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> memories for topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager-1493"><a href="#AgentMemoryManager-1493"><span class="linenos">1493</span></a>
</span><span id="AgentMemoryManager-1494"><a href="#AgentMemoryManager-1494"><span class="linenos">1494</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager-1495"><a href="#AgentMemoryManager-1495"><span class="linenos">1495</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting memories by topic: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager-1496"><a href="#AgentMemoryManager-1496"><span class="linenos">1496</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error deleting memories by topic: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Manages memory operations including storage, retrieval, and updates.</p>
</div>


                            <div id="AgentMemoryManager.__init__" class="classattr">
                                        <input id="AgentMemoryManager.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">AgentMemoryManager</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">agno_memory</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">lightrag_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">lightrag_memory_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">enable_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="AgentMemoryManager.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.__init__-32"><a href="#AgentMemoryManager.__init__-32"><span class="linenos">32</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="AgentMemoryManager.__init__-33"><a href="#AgentMemoryManager.__init__-33"><span class="linenos">33</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AgentMemoryManager.__init__-34"><a href="#AgentMemoryManager.__init__-34"><span class="linenos">34</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentMemoryManager.__init__-35"><a href="#AgentMemoryManager.__init__-35"><span class="linenos">35</span></a>        <span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentMemoryManager.__init__-36"><a href="#AgentMemoryManager.__init__-36"><span class="linenos">36</span></a>        <span class="n">agno_memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="AgentMemoryManager.__init__-37"><a href="#AgentMemoryManager.__init__-37"><span class="linenos">37</span></a>        <span class="n">lightrag_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AgentMemoryManager.__init__-38"><a href="#AgentMemoryManager.__init__-38"><span class="linenos">38</span></a>        <span class="n">lightrag_memory_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AgentMemoryManager.__init__-39"><a href="#AgentMemoryManager.__init__-39"><span class="linenos">39</span></a>        <span class="n">enable_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager.__init__-40"><a href="#AgentMemoryManager.__init__-40"><span class="linenos">40</span></a>    <span class="p">):</span>
</span><span id="AgentMemoryManager.__init__-41"><a href="#AgentMemoryManager.__init__-41"><span class="linenos">41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the memory manager.</span>
</span><span id="AgentMemoryManager.__init__-42"><a href="#AgentMemoryManager.__init__-42"><span class="linenos">42</span></a>
</span><span id="AgentMemoryManager.__init__-43"><a href="#AgentMemoryManager.__init__-43"><span class="linenos">43</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.__init__-44"><a href="#AgentMemoryManager.__init__-44"><span class="linenos">44</span></a><span class="sd">            user_id: User identifier for memory operations</span>
</span><span id="AgentMemoryManager.__init__-45"><a href="#AgentMemoryManager.__init__-45"><span class="linenos">45</span></a><span class="sd">            storage_dir: Directory for storage files</span>
</span><span id="AgentMemoryManager.__init__-46"><a href="#AgentMemoryManager.__init__-46"><span class="linenos">46</span></a><span class="sd">            agno_memory: Optional initialized agno memory instance</span>
</span><span id="AgentMemoryManager.__init__-47"><a href="#AgentMemoryManager.__init__-47"><span class="linenos">47</span></a><span class="sd">            lightrag_url: Optional URL for LightRAG API</span>
</span><span id="AgentMemoryManager.__init__-48"><a href="#AgentMemoryManager.__init__-48"><span class="linenos">48</span></a><span class="sd">            lightrag_memory_url: Optional URL for LightRAG Memory API</span>
</span><span id="AgentMemoryManager.__init__-49"><a href="#AgentMemoryManager.__init__-49"><span class="linenos">49</span></a><span class="sd">            enable_memory: Whether memory is enabled</span>
</span><span id="AgentMemoryManager.__init__-50"><a href="#AgentMemoryManager.__init__-50"><span class="linenos">50</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.__init__-51"><a href="#AgentMemoryManager.__init__-51"><span class="linenos">51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
</span><span id="AgentMemoryManager.__init__-52"><a href="#AgentMemoryManager.__init__-52"><span class="linenos">52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span> <span class="o">=</span> <span class="n">storage_dir</span>
</span><span id="AgentMemoryManager.__init__-53"><a href="#AgentMemoryManager.__init__-53"><span class="linenos">53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span> <span class="o">=</span> <span class="n">agno_memory</span>
</span><span id="AgentMemoryManager.__init__-54"><a href="#AgentMemoryManager.__init__-54"><span class="linenos">54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_url</span> <span class="o">=</span> <span class="n">lightrag_url</span>
</span><span id="AgentMemoryManager.__init__-55"><a href="#AgentMemoryManager.__init__-55"><span class="linenos">55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span> <span class="o">=</span> <span class="n">lightrag_memory_url</span>
</span><span id="AgentMemoryManager.__init__-56"><a href="#AgentMemoryManager.__init__-56"><span class="linenos">56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_memory</span> <span class="o">=</span> <span class="n">enable_memory</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the memory manager.</p>

<p>Args:
    user_id: User identifier for memory operations
    storage_dir: Directory for storage files
    agno_memory: Optional initialized agno memory instance
    lightrag_url: Optional URL for LightRAG API
    lightrag_memory_url: Optional URL for LightRAG Memory API
    enable_memory: Whether memory is enabled</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.user_id" class="classattr">
                                <div class="attr variable">
            <span class="name">user_id</span>

        
    </div>
    <a class="headerlink" href="#AgentMemoryManager.user_id"></a>
    
    

                            </div>
                            <div id="AgentMemoryManager.storage_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">storage_dir</span>

        
    </div>
    <a class="headerlink" href="#AgentMemoryManager.storage_dir"></a>
    
    

                            </div>
                            <div id="AgentMemoryManager.agno_memory" class="classattr">
                                <div class="attr variable">
            <span class="name">agno_memory</span>

        
    </div>
    <a class="headerlink" href="#AgentMemoryManager.agno_memory"></a>
    
    

                            </div>
                            <div id="AgentMemoryManager.lightrag_url" class="classattr">
                                <div class="attr variable">
            <span class="name">lightrag_url</span>

        
    </div>
    <a class="headerlink" href="#AgentMemoryManager.lightrag_url"></a>
    
    

                            </div>
                            <div id="AgentMemoryManager.lightrag_memory_url" class="classattr">
                                <div class="attr variable">
            <span class="name">lightrag_memory_url</span>

        
    </div>
    <a class="headerlink" href="#AgentMemoryManager.lightrag_memory_url"></a>
    
    

                            </div>
                            <div id="AgentMemoryManager.enable_memory" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_memory</span>

        
    </div>
    <a class="headerlink" href="#AgentMemoryManager.enable_memory"></a>
    
    

                            </div>
                            <div id="AgentMemoryManager.initialize" class="classattr">
                                        <input id="AgentMemoryManager.initialize-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">initialize</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">agno_memory</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AgentMemoryManager.initialize-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.initialize"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.initialize-58"><a href="#AgentMemoryManager.initialize-58"><span class="linenos">58</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agno_memory</span><span class="p">):</span>
</span><span id="AgentMemoryManager.initialize-59"><a href="#AgentMemoryManager.initialize-59"><span class="linenos">59</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the memory manager with agno_memory.</span>
</span><span id="AgentMemoryManager.initialize-60"><a href="#AgentMemoryManager.initialize-60"><span class="linenos">60</span></a>
</span><span id="AgentMemoryManager.initialize-61"><a href="#AgentMemoryManager.initialize-61"><span class="linenos">61</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.initialize-62"><a href="#AgentMemoryManager.initialize-62"><span class="linenos">62</span></a><span class="sd">            agno_memory: The initialized agno memory instance</span>
</span><span id="AgentMemoryManager.initialize-63"><a href="#AgentMemoryManager.initialize-63"><span class="linenos">63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.initialize-64"><a href="#AgentMemoryManager.initialize-64"><span class="linenos">64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span> <span class="o">=</span> <span class="n">agno_memory</span>
</span><span id="AgentMemoryManager.initialize-65"><a href="#AgentMemoryManager.initialize-65"><span class="linenos">65</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Memory manager initialized with agno_memory&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the memory manager with agno_memory.</p>

<p>Args:
    agno_memory: The initialized agno memory instance</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.direct_search_memories" class="classattr">
                                        <input id="AgentMemoryManager.direct_search_memories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">direct_search_memories</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">query</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>, </span><span class="param"><span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AgentMemoryManager.direct_search_memories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.direct_search_memories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.direct_search_memories-67"><a href="#AgentMemoryManager.direct_search_memories-67"><span class="linenos">67</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">direct_search_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager.direct_search_memories-68"><a href="#AgentMemoryManager.direct_search_memories-68"><span class="linenos">68</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span>
</span><span id="AgentMemoryManager.direct_search_memories-69"><a href="#AgentMemoryManager.direct_search_memories-69"><span class="linenos">69</span></a>    <span class="p">):</span>
</span><span id="AgentMemoryManager.direct_search_memories-70"><a href="#AgentMemoryManager.direct_search_memories-70"><span class="linenos">70</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Direct semantic search without agentic retrieval.</span>
</span><span id="AgentMemoryManager.direct_search_memories-71"><a href="#AgentMemoryManager.direct_search_memories-71"><span class="linenos">71</span></a>
</span><span id="AgentMemoryManager.direct_search_memories-72"><a href="#AgentMemoryManager.direct_search_memories-72"><span class="linenos">72</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.direct_search_memories-73"><a href="#AgentMemoryManager.direct_search_memories-73"><span class="linenos">73</span></a><span class="sd">            query: The search query</span>
</span><span id="AgentMemoryManager.direct_search_memories-74"><a href="#AgentMemoryManager.direct_search_memories-74"><span class="linenos">74</span></a><span class="sd">            limit: Maximum number of results to return</span>
</span><span id="AgentMemoryManager.direct_search_memories-75"><a href="#AgentMemoryManager.direct_search_memories-75"><span class="linenos">75</span></a><span class="sd">            similarity_threshold: Minimum similarity score for results</span>
</span><span id="AgentMemoryManager.direct_search_memories-76"><a href="#AgentMemoryManager.direct_search_memories-76"><span class="linenos">76</span></a>
</span><span id="AgentMemoryManager.direct_search_memories-77"><a href="#AgentMemoryManager.direct_search_memories-77"><span class="linenos">77</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.direct_search_memories-78"><a href="#AgentMemoryManager.direct_search_memories-78"><span class="linenos">78</span></a><span class="sd">            List of memory results</span>
</span><span id="AgentMemoryManager.direct_search_memories-79"><a href="#AgentMemoryManager.direct_search_memories-79"><span class="linenos">79</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.direct_search_memories-80"><a href="#AgentMemoryManager.direct_search_memories-80"><span class="linenos">80</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="p">:</span>
</span><span id="AgentMemoryManager.direct_search_memories-81"><a href="#AgentMemoryManager.direct_search_memories-81"><span class="linenos">81</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.direct_search_memories-82"><a href="#AgentMemoryManager.direct_search_memories-82"><span class="linenos">82</span></a>
</span><span id="AgentMemoryManager.direct_search_memories-83"><a href="#AgentMemoryManager.direct_search_memories-83"><span class="linenos">83</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.direct_search_memories-84"><a href="#AgentMemoryManager.direct_search_memories-84"><span class="linenos">84</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">search_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager.direct_search_memories-85"><a href="#AgentMemoryManager.direct_search_memories-85"><span class="linenos">85</span></a>                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
</span><span id="AgentMemoryManager.direct_search_memories-86"><a href="#AgentMemoryManager.direct_search_memories-86"><span class="linenos">86</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
</span><span id="AgentMemoryManager.direct_search_memories-87"><a href="#AgentMemoryManager.direct_search_memories-87"><span class="linenos">87</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager.direct_search_memories-88"><a href="#AgentMemoryManager.direct_search_memories-88"><span class="linenos">88</span></a>                <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
</span><span id="AgentMemoryManager.direct_search_memories-89"><a href="#AgentMemoryManager.direct_search_memories-89"><span class="linenos">89</span></a>                <span class="n">similarity_threshold</span><span class="o">=</span><span class="n">similarity_threshold</span><span class="p">,</span>
</span><span id="AgentMemoryManager.direct_search_memories-90"><a href="#AgentMemoryManager.direct_search_memories-90"><span class="linenos">90</span></a>                <span class="n">search_topics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager.direct_search_memories-91"><a href="#AgentMemoryManager.direct_search_memories-91"><span class="linenos">91</span></a>                <span class="n">topic_boost</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="AgentMemoryManager.direct_search_memories-92"><a href="#AgentMemoryManager.direct_search_memories-92"><span class="linenos">92</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.direct_search_memories-93"><a href="#AgentMemoryManager.direct_search_memories-93"><span class="linenos">93</span></a>            <span class="k">return</span> <span class="n">results</span>
</span><span id="AgentMemoryManager.direct_search_memories-94"><a href="#AgentMemoryManager.direct_search_memories-94"><span class="linenos">94</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.direct_search_memories-95"><a href="#AgentMemoryManager.direct_search_memories-95"><span class="linenos">95</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Direct semantic search failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.direct_search_memories-96"><a href="#AgentMemoryManager.direct_search_memories-96"><span class="linenos">96</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Direct semantic search without agentic retrieval.</p>

<p>Args:
    query: The search query
    limit: Maximum number of results to return
    similarity_threshold: Minimum similarity score for results</p>

<p>Returns:
    List of memory results</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.store_user_memory" class="classattr">
                                        <input id="AgentMemoryManager.store_user_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">store_user_memory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">personal_agent</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">semantic_memory_manager</span><span class="o">.</span><span class="n">MemoryStorageResult</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.store_user_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.store_user_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.store_user_memory-98"><a href="#AgentMemoryManager.store_user_memory-98"><span class="linenos"> 98</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">store_user_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_user_memory-99"><a href="#AgentMemoryManager.store_user_memory-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager.store_user_memory-100"><a href="#AgentMemoryManager.store_user_memory-100"><span class="linenos">100</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MemoryStorageResult</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-101"><a href="#AgentMemoryManager.store_user_memory-101"><span class="linenos">101</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Store information as a user memory in BOTH local SQLite and LightRAG graph systems.</span>
</span><span id="AgentMemoryManager.store_user_memory-102"><a href="#AgentMemoryManager.store_user_memory-102"><span class="linenos">102</span></a>
</span><span id="AgentMemoryManager.store_user_memory-103"><a href="#AgentMemoryManager.store_user_memory-103"><span class="linenos">103</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.store_user_memory-104"><a href="#AgentMemoryManager.store_user_memory-104"><span class="linenos">104</span></a><span class="sd">            content: The information to store as a memory</span>
</span><span id="AgentMemoryManager.store_user_memory-105"><a href="#AgentMemoryManager.store_user_memory-105"><span class="linenos">105</span></a><span class="sd">            topics: Optional list of topics/categories for the memory (None = auto-classify)</span>
</span><span id="AgentMemoryManager.store_user_memory-106"><a href="#AgentMemoryManager.store_user_memory-106"><span class="linenos">106</span></a>
</span><span id="AgentMemoryManager.store_user_memory-107"><a href="#AgentMemoryManager.store_user_memory-107"><span class="linenos">107</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.store_user_memory-108"><a href="#AgentMemoryManager.store_user_memory-108"><span class="linenos">108</span></a><span class="sd">            MemoryStorageResult: Structured result with detailed status information</span>
</span><span id="AgentMemoryManager.store_user_memory-109"><a href="#AgentMemoryManager.store_user_memory-109"><span class="linenos">109</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.store_user_memory-110"><a href="#AgentMemoryManager.store_user_memory-110"><span class="linenos">110</span></a>        <span class="c1"># Validate that content is provided</span>
</span><span id="AgentMemoryManager.store_user_memory-111"><a href="#AgentMemoryManager.store_user_memory-111"><span class="linenos">111</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="AgentMemoryManager.store_user_memory-112"><a href="#AgentMemoryManager.store_user_memory-112"><span class="linenos">112</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_user_memory-113"><a href="#AgentMemoryManager.store_user_memory-113"><span class="linenos">113</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">CONTENT_EMPTY</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-114"><a href="#AgentMemoryManager.store_user_memory-114"><span class="linenos">114</span></a>                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Content is required to store a memory. Please provide the information you want me to remember.&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-115"><a href="#AgentMemoryManager.store_user_memory-115"><span class="linenos">115</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-116"><a href="#AgentMemoryManager.store_user_memory-116"><span class="linenos">116</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-117"><a href="#AgentMemoryManager.store_user_memory-117"><span class="linenos">117</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-118"><a href="#AgentMemoryManager.store_user_memory-118"><span class="linenos">118</span></a>
</span><span id="AgentMemoryManager.store_user_memory-119"><a href="#AgentMemoryManager.store_user_memory-119"><span class="linenos">119</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-120"><a href="#AgentMemoryManager.store_user_memory-120"><span class="linenos">120</span></a>            <span class="c1"># Restate the user fact from first-person to third-person</span>
</span><span id="AgentMemoryManager.store_user_memory-121"><a href="#AgentMemoryManager.store_user_memory-121"><span class="linenos">121</span></a>            <span class="n">restated_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restate_user_fact</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-122"><a href="#AgentMemoryManager.store_user_memory-122"><span class="linenos">122</span></a>
</span><span id="AgentMemoryManager.store_user_memory-123"><a href="#AgentMemoryManager.store_user_memory-123"><span class="linenos">123</span></a>            <span class="c1"># SIMPLIFIED TOPIC HANDLING: Handle the common cases simply</span>
</span><span id="AgentMemoryManager.store_user_memory-124"><a href="#AgentMemoryManager.store_user_memory-124"><span class="linenos">124</span></a>            <span class="k">if</span> <span class="n">topics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-125"><a href="#AgentMemoryManager.store_user_memory-125"><span class="linenos">125</span></a>                <span class="c1"># Leave as None - let memory manager auto-classify</span>
</span><span id="AgentMemoryManager.store_user_memory-126"><a href="#AgentMemoryManager.store_user_memory-126"><span class="linenos">126</span></a>                <span class="k">pass</span>
</span><span id="AgentMemoryManager.store_user_memory-127"><a href="#AgentMemoryManager.store_user_memory-127"><span class="linenos">127</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AgentMemoryManager.store_user_memory-128"><a href="#AgentMemoryManager.store_user_memory-128"><span class="linenos">128</span></a>                <span class="c1"># Convert string to list, handle comma-separated values</span>
</span><span id="AgentMemoryManager.store_user_memory-129"><a href="#AgentMemoryManager.store_user_memory-129"><span class="linenos">129</span></a>                <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-130"><a href="#AgentMemoryManager.store_user_memory-130"><span class="linenos">130</span></a>                    <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager.store_user_memory-131"><a href="#AgentMemoryManager.store_user_memory-131"><span class="linenos">131</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-132"><a href="#AgentMemoryManager.store_user_memory-132"><span class="linenos">132</span></a>                    <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">if</span> <span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager.store_user_memory-133"><a href="#AgentMemoryManager.store_user_memory-133"><span class="linenos">133</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager.store_user_memory-134"><a href="#AgentMemoryManager.store_user_memory-134"><span class="linenos">134</span></a>                <span class="c1"># Clean up list - remove empty entries</span>
</span><span id="AgentMemoryManager.store_user_memory-135"><a href="#AgentMemoryManager.store_user_memory-135"><span class="linenos">135</span></a>                <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager.store_user_memory-136"><a href="#AgentMemoryManager.store_user_memory-136"><span class="linenos">136</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-137"><a href="#AgentMemoryManager.store_user_memory-137"><span class="linenos">137</span></a>                    <span class="n">topics</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager.store_user_memory-138"><a href="#AgentMemoryManager.store_user_memory-138"><span class="linenos">138</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-139"><a href="#AgentMemoryManager.store_user_memory-139"><span class="linenos">139</span></a>                <span class="c1"># Convert anything else to string and put in list</span>
</span><span id="AgentMemoryManager.store_user_memory-140"><a href="#AgentMemoryManager.store_user_memory-140"><span class="linenos">140</span></a>                <span class="n">topic_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AgentMemoryManager.store_user_memory-141"><a href="#AgentMemoryManager.store_user_memory-141"><span class="linenos">141</span></a>                <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">topic_str</span><span class="p">]</span> <span class="k">if</span> <span class="n">topic_str</span> <span class="ow">and</span> <span class="n">topic_str</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager.store_user_memory-142"><a href="#AgentMemoryManager.store_user_memory-142"><span class="linenos">142</span></a>
</span><span id="AgentMemoryManager.store_user_memory-143"><a href="#AgentMemoryManager.store_user_memory-143"><span class="linenos">143</span></a>            <span class="c1"># 1. Store in local SQLite memory system</span>
</span><span id="AgentMemoryManager.store_user_memory-144"><a href="#AgentMemoryManager.store_user_memory-144"><span class="linenos">144</span></a>            <span class="n">local_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">add_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_user_memory-145"><a href="#AgentMemoryManager.store_user_memory-145"><span class="linenos">145</span></a>                <span class="n">memory_text</span><span class="o">=</span><span class="n">restated_content</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-146"><a href="#AgentMemoryManager.store_user_memory-146"><span class="linenos">146</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-147"><a href="#AgentMemoryManager.store_user_memory-147"><span class="linenos">147</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-148"><a href="#AgentMemoryManager.store_user_memory-148"><span class="linenos">148</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-149"><a href="#AgentMemoryManager.store_user_memory-149"><span class="linenos">149</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-150"><a href="#AgentMemoryManager.store_user_memory-150"><span class="linenos">150</span></a>
</span><span id="AgentMemoryManager.store_user_memory-151"><a href="#AgentMemoryManager.store_user_memory-151"><span class="linenos">151</span></a>            <span class="c1"># Handle different rejection cases</span>
</span><span id="AgentMemoryManager.store_user_memory-152"><a href="#AgentMemoryManager.store_user_memory-152"><span class="linenos">152</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">local_result</span><span class="o">.</span><span class="n">is_success</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-153"><a href="#AgentMemoryManager.store_user_memory-153"><span class="linenos">153</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Local memory rejected: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">local_result</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-154"><a href="#AgentMemoryManager.store_user_memory-154"><span class="linenos">154</span></a>                <span class="c1"># Return the rejection status directly from the memory manager</span>
</span><span id="AgentMemoryManager.store_user_memory-155"><a href="#AgentMemoryManager.store_user_memory-155"><span class="linenos">155</span></a>                <span class="k">return</span> <span class="n">local_result</span>
</span><span id="AgentMemoryManager.store_user_memory-156"><a href="#AgentMemoryManager.store_user_memory-156"><span class="linenos">156</span></a>
</span><span id="AgentMemoryManager.store_user_memory-157"><a href="#AgentMemoryManager.store_user_memory-157"><span class="linenos">157</span></a>            <span class="c1"># Local storage succeeded</span>
</span><span id="AgentMemoryManager.store_user_memory-158"><a href="#AgentMemoryManager.store_user_memory-158"><span class="linenos">158</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_user_memory-159"><a href="#AgentMemoryManager.store_user_memory-159"><span class="linenos">159</span></a>                <span class="s2">&quot;Stored in local memory: </span><span class="si">%s</span><span class="s2">... (ID: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-160"><a href="#AgentMemoryManager.store_user_memory-160"><span class="linenos">160</span></a>                <span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span>
</span><span id="AgentMemoryManager.store_user_memory-161"><a href="#AgentMemoryManager.store_user_memory-161"><span class="linenos">161</span></a>                <span class="n">local_result</span><span class="o">.</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-162"><a href="#AgentMemoryManager.store_user_memory-162"><span class="linenos">162</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-163"><a href="#AgentMemoryManager.store_user_memory-163"><span class="linenos">163</span></a>
</span><span id="AgentMemoryManager.store_user_memory-164"><a href="#AgentMemoryManager.store_user_memory-164"><span class="linenos">164</span></a>            <span class="c1"># 2. Store in LightRAG graph memory system</span>
</span><span id="AgentMemoryManager.store_user_memory-165"><a href="#AgentMemoryManager.store_user_memory-165"><span class="linenos">165</span></a>            <span class="n">graph_success</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager.store_user_memory-166"><a href="#AgentMemoryManager.store_user_memory-166"><span class="linenos">166</span></a>            <span class="n">graph_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="AgentMemoryManager.store_user_memory-167"><a href="#AgentMemoryManager.store_user_memory-167"><span class="linenos">167</span></a>
</span><span id="AgentMemoryManager.store_user_memory-168"><a href="#AgentMemoryManager.store_user_memory-168"><span class="linenos">168</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-169"><a href="#AgentMemoryManager.store_user_memory-169"><span class="linenos">169</span></a>                <span class="c1"># Store in graph memory</span>
</span><span id="AgentMemoryManager.store_user_memory-170"><a href="#AgentMemoryManager.store_user_memory-170"><span class="linenos">170</span></a>                <span class="n">graph_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_graph_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_user_memory-171"><a href="#AgentMemoryManager.store_user_memory-171"><span class="linenos">171</span></a>                    <span class="n">restated_content</span><span class="p">,</span> <span class="n">local_result</span><span class="o">.</span><span class="n">topics</span><span class="p">,</span> <span class="n">local_result</span><span class="o">.</span><span class="n">memory_id</span>
</span><span id="AgentMemoryManager.store_user_memory-172"><a href="#AgentMemoryManager.store_user_memory-172"><span class="linenos">172</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-173"><a href="#AgentMemoryManager.store_user_memory-173"><span class="linenos">173</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph memory result: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">graph_result</span><span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-174"><a href="#AgentMemoryManager.store_user_memory-174"><span class="linenos">174</span></a>                <span class="k">if</span> <span class="s2">&quot;&quot;</span> <span class="ow">in</span> <span class="n">graph_result</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-175"><a href="#AgentMemoryManager.store_user_memory-175"><span class="linenos">175</span></a>                    <span class="n">graph_success</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AgentMemoryManager.store_user_memory-176"><a href="#AgentMemoryManager.store_user_memory-176"><span class="linenos">176</span></a>                    <span class="n">graph_message</span> <span class="o">=</span> <span class="s2">&quot;Graph memory synced successfully&quot;</span>
</span><span id="AgentMemoryManager.store_user_memory-177"><a href="#AgentMemoryManager.store_user_memory-177"><span class="linenos">177</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-178"><a href="#AgentMemoryManager.store_user_memory-178"><span class="linenos">178</span></a>                    <span class="n">graph_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Graph memory sync failed: </span><span class="si">{</span><span class="n">graph_result</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.store_user_memory-179"><a href="#AgentMemoryManager.store_user_memory-179"><span class="linenos">179</span></a>
</span><span id="AgentMemoryManager.store_user_memory-180"><a href="#AgentMemoryManager.store_user_memory-180"><span class="linenos">180</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-181"><a href="#AgentMemoryManager.store_user_memory-181"><span class="linenos">181</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error storing in graph memory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-182"><a href="#AgentMemoryManager.store_user_memory-182"><span class="linenos">182</span></a>                <span class="n">graph_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Graph memory error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.store_user_memory-183"><a href="#AgentMemoryManager.store_user_memory-183"><span class="linenos">183</span></a>
</span><span id="AgentMemoryManager.store_user_memory-184"><a href="#AgentMemoryManager.store_user_memory-184"><span class="linenos">184</span></a>            <span class="c1"># Determine final status based on local and graph results</span>
</span><span id="AgentMemoryManager.store_user_memory-185"><a href="#AgentMemoryManager.store_user_memory-185"><span class="linenos">185</span></a>            <span class="k">if</span> <span class="n">graph_success</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-186"><a href="#AgentMemoryManager.store_user_memory-186"><span class="linenos">186</span></a>                <span class="n">final_status</span> <span class="o">=</span> <span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">SUCCESS</span>
</span><span id="AgentMemoryManager.store_user_memory-187"><a href="#AgentMemoryManager.store_user_memory-187"><span class="linenos">187</span></a>                <span class="n">final_message</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager.store_user_memory-188"><a href="#AgentMemoryManager.store_user_memory-188"><span class="linenos">188</span></a>                    <span class="sa">f</span><span class="s2">&quot;Memory stored successfully in both systems: </span><span class="si">{</span><span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span id="AgentMemoryManager.store_user_memory-189"><a href="#AgentMemoryManager.store_user_memory-189"><span class="linenos">189</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-190"><a href="#AgentMemoryManager.store_user_memory-190"><span class="linenos">190</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_user_memory-191"><a href="#AgentMemoryManager.store_user_memory-191"><span class="linenos">191</span></a>                    <span class="s2">&quot; DUAL STORAGE SUCCESS: Memory stored in both local SQLite and LightRAG graph&quot;</span>
</span><span id="AgentMemoryManager.store_user_memory-192"><a href="#AgentMemoryManager.store_user_memory-192"><span class="linenos">192</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-193"><a href="#AgentMemoryManager.store_user_memory-193"><span class="linenos">193</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-194"><a href="#AgentMemoryManager.store_user_memory-194"><span class="linenos">194</span></a>                <span class="n">final_status</span> <span class="o">=</span> <span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">SUCCESS_LOCAL_ONLY</span>
</span><span id="AgentMemoryManager.store_user_memory-195"><a href="#AgentMemoryManager.store_user_memory-195"><span class="linenos">195</span></a>                <span class="n">final_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Memory stored in local system only: </span><span class="si">{</span><span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">... | </span><span class="si">{</span><span class="n">graph_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.store_user_memory-196"><a href="#AgentMemoryManager.store_user_memory-196"><span class="linenos">196</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_user_memory-197"><a href="#AgentMemoryManager.store_user_memory-197"><span class="linenos">197</span></a>                    <span class="s2">&quot; PARTIAL STORAGE: Memory stored in local SQLite only (graph sync failed)&quot;</span>
</span><span id="AgentMemoryManager.store_user_memory-198"><a href="#AgentMemoryManager.store_user_memory-198"><span class="linenos">198</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-199"><a href="#AgentMemoryManager.store_user_memory-199"><span class="linenos">199</span></a>
</span><span id="AgentMemoryManager.store_user_memory-200"><a href="#AgentMemoryManager.store_user_memory-200"><span class="linenos">200</span></a>            <span class="c1"># Return the enhanced result with dual storage information</span>
</span><span id="AgentMemoryManager.store_user_memory-201"><a href="#AgentMemoryManager.store_user_memory-201"><span class="linenos">201</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_user_memory-202"><a href="#AgentMemoryManager.store_user_memory-202"><span class="linenos">202</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">final_status</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-203"><a href="#AgentMemoryManager.store_user_memory-203"><span class="linenos">203</span></a>                <span class="n">message</span><span class="o">=</span><span class="n">final_message</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-204"><a href="#AgentMemoryManager.store_user_memory-204"><span class="linenos">204</span></a>                <span class="n">memory_id</span><span class="o">=</span><span class="n">local_result</span><span class="o">.</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-205"><a href="#AgentMemoryManager.store_user_memory-205"><span class="linenos">205</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">local_result</span><span class="o">.</span><span class="n">topics</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-206"><a href="#AgentMemoryManager.store_user_memory-206"><span class="linenos">206</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-207"><a href="#AgentMemoryManager.store_user_memory-207"><span class="linenos">207</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="n">graph_success</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-208"><a href="#AgentMemoryManager.store_user_memory-208"><span class="linenos">208</span></a>                <span class="n">similarity_score</span><span class="o">=</span><span class="n">local_result</span><span class="o">.</span><span class="n">similarity_score</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-209"><a href="#AgentMemoryManager.store_user_memory-209"><span class="linenos">209</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-210"><a href="#AgentMemoryManager.store_user_memory-210"><span class="linenos">210</span></a>
</span><span id="AgentMemoryManager.store_user_memory-211"><a href="#AgentMemoryManager.store_user_memory-211"><span class="linenos">211</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_user_memory-212"><a href="#AgentMemoryManager.store_user_memory-212"><span class="linenos">212</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error storing user memory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.store_user_memory-213"><a href="#AgentMemoryManager.store_user_memory-213"><span class="linenos">213</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_user_memory-214"><a href="#AgentMemoryManager.store_user_memory-214"><span class="linenos">214</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">STORAGE_ERROR</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-215"><a href="#AgentMemoryManager.store_user_memory-215"><span class="linenos">215</span></a>                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Error storing memory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-216"><a href="#AgentMemoryManager.store_user_memory-216"><span class="linenos">216</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-217"><a href="#AgentMemoryManager.store_user_memory-217"><span class="linenos">217</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_user_memory-218"><a href="#AgentMemoryManager.store_user_memory-218"><span class="linenos">218</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Store information as a user memory in BOTH local SQLite and LightRAG graph systems.</p>

<p>Args:
    content: The information to store as a memory
    topics: Optional list of topics/categories for the memory (None = auto-classify)</p>

<p>Returns:
    MemoryStorageResult: Structured result with detailed status information</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.restate_user_fact" class="classattr">
                                        <input id="AgentMemoryManager.restate_user_fact-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">restate_user_fact</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">content</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.restate_user_fact-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.restate_user_fact"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.restate_user_fact-220"><a href="#AgentMemoryManager.restate_user_fact-220"><span class="linenos">220</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">restate_user_fact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.restate_user_fact-221"><a href="#AgentMemoryManager.restate_user_fact-221"><span class="linenos">221</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Restate a user fact from first-person to third-person.</span>
</span><span id="AgentMemoryManager.restate_user_fact-222"><a href="#AgentMemoryManager.restate_user_fact-222"><span class="linenos">222</span></a>
</span><span id="AgentMemoryManager.restate_user_fact-223"><a href="#AgentMemoryManager.restate_user_fact-223"><span class="linenos">223</span></a><span class="sd">        This method converts statements like &quot;I have a PhD&quot; to &quot;{user_id} has a PhD&quot;</span>
</span><span id="AgentMemoryManager.restate_user_fact-224"><a href="#AgentMemoryManager.restate_user_fact-224"><span class="linenos">224</span></a><span class="sd">        to ensure correct entity mapping in the knowledge graph.</span>
</span><span id="AgentMemoryManager.restate_user_fact-225"><a href="#AgentMemoryManager.restate_user_fact-225"><span class="linenos">225</span></a>
</span><span id="AgentMemoryManager.restate_user_fact-226"><a href="#AgentMemoryManager.restate_user_fact-226"><span class="linenos">226</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.restate_user_fact-227"><a href="#AgentMemoryManager.restate_user_fact-227"><span class="linenos">227</span></a><span class="sd">            content: The original fact from the user</span>
</span><span id="AgentMemoryManager.restate_user_fact-228"><a href="#AgentMemoryManager.restate_user_fact-228"><span class="linenos">228</span></a>
</span><span id="AgentMemoryManager.restate_user_fact-229"><a href="#AgentMemoryManager.restate_user_fact-229"><span class="linenos">229</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.restate_user_fact-230"><a href="#AgentMemoryManager.restate_user_fact-230"><span class="linenos">230</span></a><span class="sd">            The restated fact</span>
</span><span id="AgentMemoryManager.restate_user_fact-231"><a href="#AgentMemoryManager.restate_user_fact-231"><span class="linenos">231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.restate_user_fact-232"><a href="#AgentMemoryManager.restate_user_fact-232"><span class="linenos">232</span></a>        <span class="c1"># Ensure user_id is a safe string for replacement</span>
</span><span id="AgentMemoryManager.restate_user_fact-233"><a href="#AgentMemoryManager.restate_user_fact-233"><span class="linenos">233</span></a>        <span class="n">user_id_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager.restate_user_fact-234"><a href="#AgentMemoryManager.restate_user_fact-234"><span class="linenos">234</span></a>
</span><span id="AgentMemoryManager.restate_user_fact-235"><a href="#AgentMemoryManager.restate_user_fact-235"><span class="linenos">235</span></a>        <span class="c1"># Define regex patterns for pronoun and verb replacement</span>
</span><span id="AgentMemoryManager.restate_user_fact-236"><a href="#AgentMemoryManager.restate_user_fact-236"><span class="linenos">236</span></a>        <span class="c1"># Using word boundaries (\b) to avoid replacing parts of words like &quot;mine&quot; in &quot;mining&quot;</span>
</span><span id="AgentMemoryManager.restate_user_fact-237"><a href="#AgentMemoryManager.restate_user_fact-237"><span class="linenos">237</span></a>        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager.restate_user_fact-238"><a href="#AgentMemoryManager.restate_user_fact-238"><span class="linenos">238</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bI am\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2"> is&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager.restate_user_fact-239"><a href="#AgentMemoryManager.restate_user_fact-239"><span class="linenos">239</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bI was\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2"> was&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager.restate_user_fact-240"><a href="#AgentMemoryManager.restate_user_fact-240"><span class="linenos">240</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bI have\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2"> has&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager.restate_user_fact-241"><a href="#AgentMemoryManager.restate_user_fact-241"><span class="linenos">241</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bI&#39;m\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2"> is&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager.restate_user_fact-242"><a href="#AgentMemoryManager.restate_user_fact-242"><span class="linenos">242</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bI&#39;ve\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2"> has&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager.restate_user_fact-243"><a href="#AgentMemoryManager.restate_user_fact-243"><span class="linenos">243</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bI\b&quot;</span><span class="p">,</span> <span class="n">user_id_str</span><span class="p">),</span>
</span><span id="AgentMemoryManager.restate_user_fact-244"><a href="#AgentMemoryManager.restate_user_fact-244"><span class="linenos">244</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bmy\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2">&#39;s&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager.restate_user_fact-245"><a href="#AgentMemoryManager.restate_user_fact-245"><span class="linenos">245</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bmine\b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id_str</span><span class="si">}</span><span class="s2">&#39;s&quot;</span><span class="p">),</span>
</span><span id="AgentMemoryManager.restate_user_fact-246"><a href="#AgentMemoryManager.restate_user_fact-246"><span class="linenos">246</span></a>            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bmyself\b&quot;</span><span class="p">,</span> <span class="n">user_id_str</span><span class="p">),</span>
</span><span id="AgentMemoryManager.restate_user_fact-247"><a href="#AgentMemoryManager.restate_user_fact-247"><span class="linenos">247</span></a>        <span class="p">]</span>
</span><span id="AgentMemoryManager.restate_user_fact-248"><a href="#AgentMemoryManager.restate_user_fact-248"><span class="linenos">248</span></a>
</span><span id="AgentMemoryManager.restate_user_fact-249"><a href="#AgentMemoryManager.restate_user_fact-249"><span class="linenos">249</span></a>        <span class="n">restated_content</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="AgentMemoryManager.restate_user_fact-250"><a href="#AgentMemoryManager.restate_user_fact-250"><span class="linenos">250</span></a>        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
</span><span id="AgentMemoryManager.restate_user_fact-251"><a href="#AgentMemoryManager.restate_user_fact-251"><span class="linenos">251</span></a>            <span class="c1"># Use re.IGNORECASE to handle variations like &quot;i&quot; vs &quot;I&quot;</span>
</span><span id="AgentMemoryManager.restate_user_fact-252"><a href="#AgentMemoryManager.restate_user_fact-252"><span class="linenos">252</span></a>            <span class="n">restated_content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span id="AgentMemoryManager.restate_user_fact-253"><a href="#AgentMemoryManager.restate_user_fact-253"><span class="linenos">253</span></a>                <span class="n">pattern</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">restated_content</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
</span><span id="AgentMemoryManager.restate_user_fact-254"><a href="#AgentMemoryManager.restate_user_fact-254"><span class="linenos">254</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.restate_user_fact-255"><a href="#AgentMemoryManager.restate_user_fact-255"><span class="linenos">255</span></a>
</span><span id="AgentMemoryManager.restate_user_fact-256"><a href="#AgentMemoryManager.restate_user_fact-256"><span class="linenos">256</span></a>        <span class="k">return</span> <span class="n">restated_content</span>
</span></pre></div>


            <div class="docstring"><p>Restate a user fact from first-person to third-person.</p>

<p>This method converts statements like "I have a PhD" to "{user_id} has a PhD"
to ensure correct entity mapping in the knowledge graph.</p>

<p>Args:
    content: The original fact from the user</p>

<p>Returns:
    The restated fact</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.seed_entity_in_graph" class="classattr">
                                        <input id="AgentMemoryManager.seed_entity_in_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">seed_entity_in_graph</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.seed_entity_in_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.seed_entity_in_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.seed_entity_in_graph-258"><a href="#AgentMemoryManager.seed_entity_in_graph-258"><span class="linenos">258</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">seed_entity_in_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-259"><a href="#AgentMemoryManager.seed_entity_in_graph-259"><span class="linenos">259</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Seed an entity into the graph by creating and uploading a physical file.</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-260"><a href="#AgentMemoryManager.seed_entity_in_graph-260"><span class="linenos">260</span></a>
</span><span id="AgentMemoryManager.seed_entity_in_graph-261"><a href="#AgentMemoryManager.seed_entity_in_graph-261"><span class="linenos">261</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-262"><a href="#AgentMemoryManager.seed_entity_in_graph-262"><span class="linenos">262</span></a><span class="sd">            entity_name: Name of the entity to create</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-263"><a href="#AgentMemoryManager.seed_entity_in_graph-263"><span class="linenos">263</span></a><span class="sd">            entity_type: Type of the entity</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-264"><a href="#AgentMemoryManager.seed_entity_in_graph-264"><span class="linenos">264</span></a>
</span><span id="AgentMemoryManager.seed_entity_in_graph-265"><a href="#AgentMemoryManager.seed_entity_in_graph-265"><span class="linenos">265</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-266"><a href="#AgentMemoryManager.seed_entity_in_graph-266"><span class="linenos">266</span></a><span class="sd">            True if entity was successfully seeded</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-267"><a href="#AgentMemoryManager.seed_entity_in_graph-267"><span class="linenos">267</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-268"><a href="#AgentMemoryManager.seed_entity_in_graph-268"><span class="linenos">268</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-269"><a href="#AgentMemoryManager.seed_entity_in_graph-269"><span class="linenos">269</span></a>            <span class="c1"># Create a minimal document to seed the entity</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-270"><a href="#AgentMemoryManager.seed_entity_in_graph-270"><span class="linenos">270</span></a>            <span class="n">seed_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2"> is a </span><span class="si">{</span><span class="n">entity_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-271"><a href="#AgentMemoryManager.seed_entity_in_graph-271"><span class="linenos">271</span></a>
</span><span id="AgentMemoryManager.seed_entity_in_graph-272"><a href="#AgentMemoryManager.seed_entity_in_graph-272"><span class="linenos">272</span></a>            <span class="c1"># Create a unique filename for this entity seed</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-273"><a href="#AgentMemoryManager.seed_entity_in_graph-273"><span class="linenos">273</span></a>            <span class="n">entity_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-274"><a href="#AgentMemoryManager.seed_entity_in_graph-274"><span class="linenos">274</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-275"><a href="#AgentMemoryManager.seed_entity_in_graph-275"><span class="linenos">275</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-276"><a href="#AgentMemoryManager.seed_entity_in_graph-276"><span class="linenos">276</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;entity_seed_</span><span class="si">{</span><span class="n">entity_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">entity_hash</span><span class="si">}</span><span class="s2">.txt&quot;</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-277"><a href="#AgentMemoryManager.seed_entity_in_graph-277"><span class="linenos">277</span></a>
</span><span id="AgentMemoryManager.seed_entity_in_graph-278"><a href="#AgentMemoryManager.seed_entity_in_graph-278"><span class="linenos">278</span></a>            <span class="c1"># Create a temporary file</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-279"><a href="#AgentMemoryManager.seed_entity_in_graph-279"><span class="linenos">279</span></a>            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-280"><a href="#AgentMemoryManager.seed_entity_in_graph-280"><span class="linenos">280</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-281"><a href="#AgentMemoryManager.seed_entity_in_graph-281"><span class="linenos">281</span></a>            <span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-282"><a href="#AgentMemoryManager.seed_entity_in_graph-282"><span class="linenos">282</span></a>                <span class="n">temp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">seed_text</span><span class="p">)</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-283"><a href="#AgentMemoryManager.seed_entity_in_graph-283"><span class="linenos">283</span></a>                <span class="n">temp_file_path</span> <span class="o">=</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-284"><a href="#AgentMemoryManager.seed_entity_in_graph-284"><span class="linenos">284</span></a>
</span><span id="AgentMemoryManager.seed_entity_in_graph-285"><a href="#AgentMemoryManager.seed_entity_in_graph-285"><span class="linenos">285</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-286"><a href="#AgentMemoryManager.seed_entity_in_graph-286"><span class="linenos">286</span></a>                <span class="c1"># Upload the file using the /documents/upload endpoint</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-287"><a href="#AgentMemoryManager.seed_entity_in_graph-287"><span class="linenos">287</span></a>                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents/upload&quot;</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-288"><a href="#AgentMemoryManager.seed_entity_in_graph-288"><span class="linenos">288</span></a>
</span><span id="AgentMemoryManager.seed_entity_in_graph-289"><a href="#AgentMemoryManager.seed_entity_in_graph-289"><span class="linenos">289</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-290"><a href="#AgentMemoryManager.seed_entity_in_graph-290"><span class="linenos">290</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-291"><a href="#AgentMemoryManager.seed_entity_in_graph-291"><span class="linenos">291</span></a>                        <span class="c1"># Create form data for file upload</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-292"><a href="#AgentMemoryManager.seed_entity_in_graph-292"><span class="linenos">292</span></a>                        <span class="n">data</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">FormData</span><span class="p">()</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-293"><a href="#AgentMemoryManager.seed_entity_in_graph-293"><span class="linenos">293</span></a>                        <span class="n">data</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-294"><a href="#AgentMemoryManager.seed_entity_in_graph-294"><span class="linenos">294</span></a>                            <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-295"><a href="#AgentMemoryManager.seed_entity_in_graph-295"><span class="linenos">295</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-296"><a href="#AgentMemoryManager.seed_entity_in_graph-296"><span class="linenos">296</span></a>
</span><span id="AgentMemoryManager.seed_entity_in_graph-297"><a href="#AgentMemoryManager.seed_entity_in_graph-297"><span class="linenos">297</span></a>                        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-298"><a href="#AgentMemoryManager.seed_entity_in_graph-298"><span class="linenos">298</span></a>                            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">]:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-299"><a href="#AgentMemoryManager.seed_entity_in_graph-299"><span class="linenos">299</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-300"><a href="#AgentMemoryManager.seed_entity_in_graph-300"><span class="linenos">300</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Successfully seeded entity: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-301"><a href="#AgentMemoryManager.seed_entity_in_graph-301"><span class="linenos">301</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-302"><a href="#AgentMemoryManager.seed_entity_in_graph-302"><span class="linenos">302</span></a>                                <span class="k">return</span> <span class="kc">True</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-303"><a href="#AgentMemoryManager.seed_entity_in_graph-303"><span class="linenos">303</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-304"><a href="#AgentMemoryManager.seed_entity_in_graph-304"><span class="linenos">304</span></a>                                <span class="n">error_detail</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-305"><a href="#AgentMemoryManager.seed_entity_in_graph-305"><span class="linenos">305</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-306"><a href="#AgentMemoryManager.seed_entity_in_graph-306"><span class="linenos">306</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Failed to seed entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-307"><a href="#AgentMemoryManager.seed_entity_in_graph-307"><span class="linenos">307</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-308"><a href="#AgentMemoryManager.seed_entity_in_graph-308"><span class="linenos">308</span></a>                                <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-309"><a href="#AgentMemoryManager.seed_entity_in_graph-309"><span class="linenos">309</span></a>
</span><span id="AgentMemoryManager.seed_entity_in_graph-310"><a href="#AgentMemoryManager.seed_entity_in_graph-310"><span class="linenos">310</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-311"><a href="#AgentMemoryManager.seed_entity_in_graph-311"><span class="linenos">311</span></a>                <span class="c1"># Clean up the temporary file</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-312"><a href="#AgentMemoryManager.seed_entity_in_graph-312"><span class="linenos">312</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-313"><a href="#AgentMemoryManager.seed_entity_in_graph-313"><span class="linenos">313</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">)</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-314"><a href="#AgentMemoryManager.seed_entity_in_graph-314"><span class="linenos">314</span></a>                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-315"><a href="#AgentMemoryManager.seed_entity_in_graph-315"><span class="linenos">315</span></a>                    <span class="k">pass</span>  <span class="c1"># Ignore cleanup errors</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-316"><a href="#AgentMemoryManager.seed_entity_in_graph-316"><span class="linenos">316</span></a>
</span><span id="AgentMemoryManager.seed_entity_in_graph-317"><a href="#AgentMemoryManager.seed_entity_in_graph-317"><span class="linenos">317</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-318"><a href="#AgentMemoryManager.seed_entity_in_graph-318"><span class="linenos">318</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error seeding entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.seed_entity_in_graph-319"><a href="#AgentMemoryManager.seed_entity_in_graph-319"><span class="linenos">319</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Seed an entity into the graph by creating and uploading a physical file.</p>

<p>Args:
    entity_name: Name of the entity to create
    entity_type: Type of the entity</p>

<p>Returns:
    True if entity was successfully seeded</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.check_entity_exists" class="classattr">
                                        <input id="AgentMemoryManager.check_entity_exists-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">check_entity_exists</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.check_entity_exists-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.check_entity_exists"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.check_entity_exists-321"><a href="#AgentMemoryManager.check_entity_exists-321"><span class="linenos">321</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_entity_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-322"><a href="#AgentMemoryManager.check_entity_exists-322"><span class="linenos">322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if entity exists in the graph using the correct /graph/entity/exists endpoint.</span>
</span><span id="AgentMemoryManager.check_entity_exists-323"><a href="#AgentMemoryManager.check_entity_exists-323"><span class="linenos">323</span></a>
</span><span id="AgentMemoryManager.check_entity_exists-324"><a href="#AgentMemoryManager.check_entity_exists-324"><span class="linenos">324</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.check_entity_exists-325"><a href="#AgentMemoryManager.check_entity_exists-325"><span class="linenos">325</span></a><span class="sd">            entity_name: Name of the entity to check</span>
</span><span id="AgentMemoryManager.check_entity_exists-326"><a href="#AgentMemoryManager.check_entity_exists-326"><span class="linenos">326</span></a>
</span><span id="AgentMemoryManager.check_entity_exists-327"><a href="#AgentMemoryManager.check_entity_exists-327"><span class="linenos">327</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.check_entity_exists-328"><a href="#AgentMemoryManager.check_entity_exists-328"><span class="linenos">328</span></a><span class="sd">            True if entity exists</span>
</span><span id="AgentMemoryManager.check_entity_exists-329"><a href="#AgentMemoryManager.check_entity_exists-329"><span class="linenos">329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.check_entity_exists-330"><a href="#AgentMemoryManager.check_entity_exists-330"><span class="linenos">330</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-331"><a href="#AgentMemoryManager.check_entity_exists-331"><span class="linenos">331</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/entity/exists&quot;</span>
</span><span id="AgentMemoryManager.check_entity_exists-332"><a href="#AgentMemoryManager.check_entity_exists-332"><span class="linenos">332</span></a>
</span><span id="AgentMemoryManager.check_entity_exists-333"><a href="#AgentMemoryManager.check_entity_exists-333"><span class="linenos">333</span></a>            <span class="c1"># Try different parameter formats that LightRAG might expect</span>
</span><span id="AgentMemoryManager.check_entity_exists-334"><a href="#AgentMemoryManager.check_entity_exists-334"><span class="linenos">334</span></a>            <span class="n">params_options</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager.check_entity_exists-335"><a href="#AgentMemoryManager.check_entity_exists-335"><span class="linenos">335</span></a>                <span class="p">{</span><span class="s2">&quot;entity_name&quot;</span><span class="p">:</span> <span class="n">entity_name</span><span class="p">},</span>
</span><span id="AgentMemoryManager.check_entity_exists-336"><a href="#AgentMemoryManager.check_entity_exists-336"><span class="linenos">336</span></a>                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">entity_name</span><span class="p">},</span>
</span><span id="AgentMemoryManager.check_entity_exists-337"><a href="#AgentMemoryManager.check_entity_exists-337"><span class="linenos">337</span></a>                <span class="p">{</span><span class="s2">&quot;entity&quot;</span><span class="p">:</span> <span class="n">entity_name</span><span class="p">},</span>
</span><span id="AgentMemoryManager.check_entity_exists-338"><a href="#AgentMemoryManager.check_entity_exists-338"><span class="linenos">338</span></a>            <span class="p">]</span>
</span><span id="AgentMemoryManager.check_entity_exists-339"><a href="#AgentMemoryManager.check_entity_exists-339"><span class="linenos">339</span></a>
</span><span id="AgentMemoryManager.check_entity_exists-340"><a href="#AgentMemoryManager.check_entity_exists-340"><span class="linenos">340</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-341"><a href="#AgentMemoryManager.check_entity_exists-341"><span class="linenos">341</span></a>                <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_options</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-342"><a href="#AgentMemoryManager.check_entity_exists-342"><span class="linenos">342</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-343"><a href="#AgentMemoryManager.check_entity_exists-343"><span class="linenos">343</span></a>                        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-344"><a href="#AgentMemoryManager.check_entity_exists-344"><span class="linenos">344</span></a>                            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-345"><a href="#AgentMemoryManager.check_entity_exists-345"><span class="linenos">345</span></a>                                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentMemoryManager.check_entity_exists-346"><a href="#AgentMemoryManager.check_entity_exists-346"><span class="linenos">346</span></a>                                <span class="c1"># Handle different response formats</span>
</span><span id="AgentMemoryManager.check_entity_exists-347"><a href="#AgentMemoryManager.check_entity_exists-347"><span class="linenos">347</span></a>                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="AgentMemoryManager.check_entity_exists-348"><a href="#AgentMemoryManager.check_entity_exists-348"><span class="linenos">348</span></a>                                    <span class="n">exists</span> <span class="o">=</span> <span class="n">result</span>
</span><span id="AgentMemoryManager.check_entity_exists-349"><a href="#AgentMemoryManager.check_entity_exists-349"><span class="linenos">349</span></a>                                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="AgentMemoryManager.check_entity_exists-350"><a href="#AgentMemoryManager.check_entity_exists-350"><span class="linenos">350</span></a>                                    <span class="n">exists</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exists&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="AgentMemoryManager.check_entity_exists-351"><a href="#AgentMemoryManager.check_entity_exists-351"><span class="linenos">351</span></a>                                        <span class="s2">&quot;found&quot;</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager.check_entity_exists-352"><a href="#AgentMemoryManager.check_entity_exists-352"><span class="linenos">352</span></a>                                    <span class="p">)</span>
</span><span id="AgentMemoryManager.check_entity_exists-353"><a href="#AgentMemoryManager.check_entity_exists-353"><span class="linenos">353</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-354"><a href="#AgentMemoryManager.check_entity_exists-354"><span class="linenos">354</span></a>                                    <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager.check_entity_exists-355"><a href="#AgentMemoryManager.check_entity_exists-355"><span class="linenos">355</span></a>
</span><span id="AgentMemoryManager.check_entity_exists-356"><a href="#AgentMemoryManager.check_entity_exists-356"><span class="linenos">356</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="AgentMemoryManager.check_entity_exists-357"><a href="#AgentMemoryManager.check_entity_exists-357"><span class="linenos">357</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2"> exists: </span><span class="si">{</span><span class="n">exists</span><span class="si">}</span><span class="s2"> (params: </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="AgentMemoryManager.check_entity_exists-358"><a href="#AgentMemoryManager.check_entity_exists-358"><span class="linenos">358</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager.check_entity_exists-359"><a href="#AgentMemoryManager.check_entity_exists-359"><span class="linenos">359</span></a>                                <span class="k">return</span> <span class="n">exists</span>
</span><span id="AgentMemoryManager.check_entity_exists-360"><a href="#AgentMemoryManager.check_entity_exists-360"><span class="linenos">360</span></a>                            <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-361"><a href="#AgentMemoryManager.check_entity_exists-361"><span class="linenos">361</span></a>                                <span class="c1"># Try next parameter format</span>
</span><span id="AgentMemoryManager.check_entity_exists-362"><a href="#AgentMemoryManager.check_entity_exists-362"><span class="linenos">362</span></a>                                <span class="k">continue</span>
</span><span id="AgentMemoryManager.check_entity_exists-363"><a href="#AgentMemoryManager.check_entity_exists-363"><span class="linenos">363</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-364"><a href="#AgentMemoryManager.check_entity_exists-364"><span class="linenos">364</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager.check_entity_exists-365"><a href="#AgentMemoryManager.check_entity_exists-365"><span class="linenos">365</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Failed to check entity existence for </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.check_entity_exists-366"><a href="#AgentMemoryManager.check_entity_exists-366"><span class="linenos">366</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager.check_entity_exists-367"><a href="#AgentMemoryManager.check_entity_exists-367"><span class="linenos">367</span></a>                                <span class="k">break</span>
</span><span id="AgentMemoryManager.check_entity_exists-368"><a href="#AgentMemoryManager.check_entity_exists-368"><span class="linenos">368</span></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-369"><a href="#AgentMemoryManager.check_entity_exists-369"><span class="linenos">369</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error with params </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.check_entity_exists-370"><a href="#AgentMemoryManager.check_entity_exists-370"><span class="linenos">370</span></a>                        <span class="k">continue</span>
</span><span id="AgentMemoryManager.check_entity_exists-371"><a href="#AgentMemoryManager.check_entity_exists-371"><span class="linenos">371</span></a>
</span><span id="AgentMemoryManager.check_entity_exists-372"><a href="#AgentMemoryManager.check_entity_exists-372"><span class="linenos">372</span></a>                <span class="c1"># If all parameter formats fail, fall back to label list approach</span>
</span><span id="AgentMemoryManager.check_entity_exists-373"><a href="#AgentMemoryManager.check_entity_exists-373"><span class="linenos">373</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="AgentMemoryManager.check_entity_exists-374"><a href="#AgentMemoryManager.check_entity_exists-374"><span class="linenos">374</span></a>                    <span class="sa">f</span><span class="s2">&quot;All parameter formats failed for </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">, falling back to label list&quot;</span>
</span><span id="AgentMemoryManager.check_entity_exists-375"><a href="#AgentMemoryManager.check_entity_exists-375"><span class="linenos">375</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.check_entity_exists-376"><a href="#AgentMemoryManager.check_entity_exists-376"><span class="linenos">376</span></a>                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/label/list&quot;</span>
</span><span id="AgentMemoryManager.check_entity_exists-377"><a href="#AgentMemoryManager.check_entity_exists-377"><span class="linenos">377</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-378"><a href="#AgentMemoryManager.check_entity_exists-378"><span class="linenos">378</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-379"><a href="#AgentMemoryManager.check_entity_exists-379"><span class="linenos">379</span></a>                        <span class="n">labels_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentMemoryManager.check_entity_exists-380"><a href="#AgentMemoryManager.check_entity_exists-380"><span class="linenos">380</span></a>
</span><span id="AgentMemoryManager.check_entity_exists-381"><a href="#AgentMemoryManager.check_entity_exists-381"><span class="linenos">381</span></a>                        <span class="c1"># Handle both response formats: direct array or dict with &#39;labels&#39; key</span>
</span><span id="AgentMemoryManager.check_entity_exists-382"><a href="#AgentMemoryManager.check_entity_exists-382"><span class="linenos">382</span></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager.check_entity_exists-383"><a href="#AgentMemoryManager.check_entity_exists-383"><span class="linenos">383</span></a>                            <span class="n">all_labels</span> <span class="o">=</span> <span class="n">labels_data</span>
</span><span id="AgentMemoryManager.check_entity_exists-384"><a href="#AgentMemoryManager.check_entity_exists-384"><span class="linenos">384</span></a>                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="n">labels_data</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-385"><a href="#AgentMemoryManager.check_entity_exists-385"><span class="linenos">385</span></a>                            <span class="n">all_labels</span> <span class="o">=</span> <span class="n">labels_data</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager.check_entity_exists-386"><a href="#AgentMemoryManager.check_entity_exists-386"><span class="linenos">386</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-387"><a href="#AgentMemoryManager.check_entity_exists-387"><span class="linenos">387</span></a>                            <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.check_entity_exists-388"><a href="#AgentMemoryManager.check_entity_exists-388"><span class="linenos">388</span></a>
</span><span id="AgentMemoryManager.check_entity_exists-389"><a href="#AgentMemoryManager.check_entity_exists-389"><span class="linenos">389</span></a>                        <span class="c1"># Check if entity name exists in labels (case-insensitive)</span>
</span><span id="AgentMemoryManager.check_entity_exists-390"><a href="#AgentMemoryManager.check_entity_exists-390"><span class="linenos">390</span></a>                        <span class="n">exists</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="AgentMemoryManager.check_entity_exists-391"><a href="#AgentMemoryManager.check_entity_exists-391"><span class="linenos">391</span></a>                            <span class="n">label</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">entity_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">all_labels</span>
</span><span id="AgentMemoryManager.check_entity_exists-392"><a href="#AgentMemoryManager.check_entity_exists-392"><span class="linenos">392</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager.check_entity_exists-393"><a href="#AgentMemoryManager.check_entity_exists-393"><span class="linenos">393</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="AgentMemoryManager.check_entity_exists-394"><a href="#AgentMemoryManager.check_entity_exists-394"><span class="linenos">394</span></a>                            <span class="sa">f</span><span class="s2">&quot;Entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2"> exists (via labels): </span><span class="si">{</span><span class="n">exists</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.check_entity_exists-395"><a href="#AgentMemoryManager.check_entity_exists-395"><span class="linenos">395</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager.check_entity_exists-396"><a href="#AgentMemoryManager.check_entity_exists-396"><span class="linenos">396</span></a>                        <span class="k">return</span> <span class="n">exists</span>
</span><span id="AgentMemoryManager.check_entity_exists-397"><a href="#AgentMemoryManager.check_entity_exists-397"><span class="linenos">397</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-398"><a href="#AgentMemoryManager.check_entity_exists-398"><span class="linenos">398</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager.check_entity_exists-399"><a href="#AgentMemoryManager.check_entity_exists-399"><span class="linenos">399</span></a>                            <span class="sa">f</span><span class="s2">&quot;Failed to get graph labels for entity check: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.check_entity_exists-400"><a href="#AgentMemoryManager.check_entity_exists-400"><span class="linenos">400</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager.check_entity_exists-401"><a href="#AgentMemoryManager.check_entity_exists-401"><span class="linenos">401</span></a>                        <span class="k">return</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager.check_entity_exists-402"><a href="#AgentMemoryManager.check_entity_exists-402"><span class="linenos">402</span></a>
</span><span id="AgentMemoryManager.check_entity_exists-403"><a href="#AgentMemoryManager.check_entity_exists-403"><span class="linenos">403</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.check_entity_exists-404"><a href="#AgentMemoryManager.check_entity_exists-404"><span class="linenos">404</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking entity existence for </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.check_entity_exists-405"><a href="#AgentMemoryManager.check_entity_exists-405"><span class="linenos">405</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Check if entity exists in the graph using the correct /graph/entity/exists endpoint.</p>

<p>Args:
    entity_name: Name of the entity to check</p>

<p>Returns:
    True if entity exists</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.clear_all_memories" class="classattr">
                                        <input id="AgentMemoryManager.clear_all_memories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">clear_all_memories</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.clear_all_memories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.clear_all_memories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.clear_all_memories-407"><a href="#AgentMemoryManager.clear_all_memories-407"><span class="linenos">407</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">clear_all_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-408"><a href="#AgentMemoryManager.clear_all_memories-408"><span class="linenos">408</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all memories from both SQLite and LightRAG systems.</span>
</span><span id="AgentMemoryManager.clear_all_memories-409"><a href="#AgentMemoryManager.clear_all_memories-409"><span class="linenos">409</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-410"><a href="#AgentMemoryManager.clear_all_memories-410"><span class="linenos">410</span></a><span class="sd">        This method provides a complete reset of the dual memory system by:</span>
</span><span id="AgentMemoryManager.clear_all_memories-411"><a href="#AgentMemoryManager.clear_all_memories-411"><span class="linenos">411</span></a><span class="sd">        1. Clearing all memories from the local SQLite database</span>
</span><span id="AgentMemoryManager.clear_all_memories-412"><a href="#AgentMemoryManager.clear_all_memories-412"><span class="linenos">412</span></a><span class="sd">        2. Clearing all documents from the LightRAG memory server</span>
</span><span id="AgentMemoryManager.clear_all_memories-413"><a href="#AgentMemoryManager.clear_all_memories-413"><span class="linenos">413</span></a><span class="sd">        3. Deleting the knowledge graph file</span>
</span><span id="AgentMemoryManager.clear_all_memories-414"><a href="#AgentMemoryManager.clear_all_memories-414"><span class="linenos">414</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-415"><a href="#AgentMemoryManager.clear_all_memories-415"><span class="linenos">415</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.clear_all_memories-416"><a href="#AgentMemoryManager.clear_all_memories-416"><span class="linenos">416</span></a><span class="sd">            str: Success or error message</span>
</span><span id="AgentMemoryManager.clear_all_memories-417"><a href="#AgentMemoryManager.clear_all_memories-417"><span class="linenos">417</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.clear_all_memories-418"><a href="#AgentMemoryManager.clear_all_memories-418"><span class="linenos">418</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-419"><a href="#AgentMemoryManager.clear_all_memories-419"><span class="linenos">419</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.clear_all_memories-420"><a href="#AgentMemoryManager.clear_all_memories-420"><span class="linenos">420</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-421"><a href="#AgentMemoryManager.clear_all_memories-421"><span class="linenos">421</span></a>            <span class="c1"># 1. Clear local SQLite memories</span>
</span><span id="AgentMemoryManager.clear_all_memories-422"><a href="#AgentMemoryManager.clear_all_memories-422"><span class="linenos">422</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-423"><a href="#AgentMemoryManager.clear_all_memories-423"><span class="linenos">423</span></a>                <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">clear_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-424"><a href="#AgentMemoryManager.clear_all_memories-424"><span class="linenos">424</span></a>                    <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager.clear_all_memories-425"><a href="#AgentMemoryManager.clear_all_memories-425"><span class="linenos">425</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-426"><a href="#AgentMemoryManager.clear_all_memories-426"><span class="linenos">426</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-427"><a href="#AgentMemoryManager.clear_all_memories-427"><span class="linenos">427</span></a>                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-428"><a href="#AgentMemoryManager.clear_all_memories-428"><span class="linenos">428</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-429"><a href="#AgentMemoryManager.clear_all_memories-429"><span class="linenos">429</span></a>                        <span class="s2">&quot;Cleared all memories from SQLite for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager.clear_all_memories-430"><a href="#AgentMemoryManager.clear_all_memories-430"><span class="linenos">430</span></a>                    <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-431"><a href="#AgentMemoryManager.clear_all_memories-431"><span class="linenos">431</span></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Local memory: All memories cleared successfully&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-432"><a href="#AgentMemoryManager.clear_all_memories-432"><span class="linenos">432</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-433"><a href="#AgentMemoryManager.clear_all_memories-433"><span class="linenos">433</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to clear memories from SQLite: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-434"><a href="#AgentMemoryManager.clear_all_memories-434"><span class="linenos">434</span></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Local memory error: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-435"><a href="#AgentMemoryManager.clear_all_memories-435"><span class="linenos">435</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-436"><a href="#AgentMemoryManager.clear_all_memories-436"><span class="linenos">436</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-437"><a href="#AgentMemoryManager.clear_all_memories-437"><span class="linenos">437</span></a>                    <span class="s2">&quot;Memory system not initialized, skipping SQLite memory clear&quot;</span>
</span><span id="AgentMemoryManager.clear_all_memories-438"><a href="#AgentMemoryManager.clear_all_memories-438"><span class="linenos">438</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-439"><a href="#AgentMemoryManager.clear_all_memories-439"><span class="linenos">439</span></a>                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Local memory: System not initialized&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-440"><a href="#AgentMemoryManager.clear_all_memories-440"><span class="linenos">440</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-441"><a href="#AgentMemoryManager.clear_all_memories-441"><span class="linenos">441</span></a>            <span class="c1"># 2. Clear LightRAG graph memories</span>
</span><span id="AgentMemoryManager.clear_all_memories-442"><a href="#AgentMemoryManager.clear_all_memories-442"><span class="linenos">442</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-443"><a href="#AgentMemoryManager.clear_all_memories-443"><span class="linenos">443</span></a>                <span class="c1"># Use LightRAG API to delete all documents</span>
</span><span id="AgentMemoryManager.clear_all_memories-444"><a href="#AgentMemoryManager.clear_all_memories-444"><span class="linenos">444</span></a>                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents&quot;</span>
</span><span id="AgentMemoryManager.clear_all_memories-445"><a href="#AgentMemoryManager.clear_all_memories-445"><span class="linenos">445</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-446"><a href="#AgentMemoryManager.clear_all_memories-446"><span class="linenos">446</span></a>                <span class="c1"># First get all documents</span>
</span><span id="AgentMemoryManager.clear_all_memories-447"><a href="#AgentMemoryManager.clear_all_memories-447"><span class="linenos">447</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-448"><a href="#AgentMemoryManager.clear_all_memories-448"><span class="linenos">448</span></a>                    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-449"><a href="#AgentMemoryManager.clear_all_memories-449"><span class="linenos">449</span></a>                        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-450"><a href="#AgentMemoryManager.clear_all_memories-450"><span class="linenos">450</span></a>                            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentMemoryManager.clear_all_memories-451"><a href="#AgentMemoryManager.clear_all_memories-451"><span class="linenos">451</span></a>                            <span class="n">all_docs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.clear_all_memories-452"><a href="#AgentMemoryManager.clear_all_memories-452"><span class="linenos">452</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-453"><a href="#AgentMemoryManager.clear_all_memories-453"><span class="linenos">453</span></a>                            <span class="c1"># Extract documents from response</span>
</span><span id="AgentMemoryManager.clear_all_memories-454"><a href="#AgentMemoryManager.clear_all_memories-454"><span class="linenos">454</span></a>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;statuses&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-455"><a href="#AgentMemoryManager.clear_all_memories-455"><span class="linenos">455</span></a>                                <span class="n">statuses</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;statuses&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager.clear_all_memories-456"><a href="#AgentMemoryManager.clear_all_memories-456"><span class="linenos">456</span></a>                                <span class="k">for</span> <span class="n">status_name</span><span class="p">,</span> <span class="n">docs_list</span> <span class="ow">in</span> <span class="n">statuses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AgentMemoryManager.clear_all_memories-457"><a href="#AgentMemoryManager.clear_all_memories-457"><span class="linenos">457</span></a>                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager.clear_all_memories-458"><a href="#AgentMemoryManager.clear_all_memories-458"><span class="linenos">458</span></a>                                        <span class="n">all_docs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">docs_list</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-459"><a href="#AgentMemoryManager.clear_all_memories-459"><span class="linenos">459</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;documents&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-460"><a href="#AgentMemoryManager.clear_all_memories-460"><span class="linenos">460</span></a>                                <span class="n">all_docs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;documents&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager.clear_all_memories-461"><a href="#AgentMemoryManager.clear_all_memories-461"><span class="linenos">461</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager.clear_all_memories-462"><a href="#AgentMemoryManager.clear_all_memories-462"><span class="linenos">462</span></a>                                <span class="n">all_docs</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="AgentMemoryManager.clear_all_memories-463"><a href="#AgentMemoryManager.clear_all_memories-463"><span class="linenos">463</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-464"><a href="#AgentMemoryManager.clear_all_memories-464"><span class="linenos">464</span></a>                            <span class="k">if</span> <span class="n">all_docs</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-465"><a href="#AgentMemoryManager.clear_all_memories-465"><span class="linenos">465</span></a>                                <span class="c1"># Delete all documents</span>
</span><span id="AgentMemoryManager.clear_all_memories-466"><a href="#AgentMemoryManager.clear_all_memories-466"><span class="linenos">466</span></a>                                <span class="n">doc_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">all_docs</span><span class="p">]</span>
</span><span id="AgentMemoryManager.clear_all_memories-467"><a href="#AgentMemoryManager.clear_all_memories-467"><span class="linenos">467</span></a>                                <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;doc_ids&quot;</span><span class="p">:</span> <span class="n">doc_ids</span><span class="p">,</span> <span class="s2">&quot;delete_file&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span><span id="AgentMemoryManager.clear_all_memories-468"><a href="#AgentMemoryManager.clear_all_memories-468"><span class="linenos">468</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-469"><a href="#AgentMemoryManager.clear_all_memories-469"><span class="linenos">469</span></a>                                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-470"><a href="#AgentMemoryManager.clear_all_memories-470"><span class="linenos">470</span></a>                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents/delete_document&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.clear_all_memories-471"><a href="#AgentMemoryManager.clear_all_memories-471"><span class="linenos">471</span></a>                                    <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
</span><span id="AgentMemoryManager.clear_all_memories-472"><a href="#AgentMemoryManager.clear_all_memories-472"><span class="linenos">472</span></a>                                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
</span><span id="AgentMemoryManager.clear_all_memories-473"><a href="#AgentMemoryManager.clear_all_memories-473"><span class="linenos">473</span></a>                                <span class="p">)</span> <span class="k">as</span> <span class="n">del_resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-474"><a href="#AgentMemoryManager.clear_all_memories-474"><span class="linenos">474</span></a>                                    <span class="k">if</span> <span class="n">del_resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-475"><a href="#AgentMemoryManager.clear_all_memories-475"><span class="linenos">475</span></a>                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-476"><a href="#AgentMemoryManager.clear_all_memories-476"><span class="linenos">476</span></a>                                            <span class="s2">&quot;Cleared all memories from LightRAG (</span><span class="si">%d</span><span class="s2"> documents)&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.clear_all_memories-477"><a href="#AgentMemoryManager.clear_all_memories-477"><span class="linenos">477</span></a>                                            <span class="nb">len</span><span class="p">(</span><span class="n">doc_ids</span><span class="p">),</span>
</span><span id="AgentMemoryManager.clear_all_memories-478"><a href="#AgentMemoryManager.clear_all_memories-478"><span class="linenos">478</span></a>                                        <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-479"><a href="#AgentMemoryManager.clear_all_memories-479"><span class="linenos">479</span></a>                                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-480"><a href="#AgentMemoryManager.clear_all_memories-480"><span class="linenos">480</span></a>                                            <span class="sa">f</span><span class="s2">&quot; Graph memory: All memories cleared successfully (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">doc_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> documents)&quot;</span>
</span><span id="AgentMemoryManager.clear_all_memories-481"><a href="#AgentMemoryManager.clear_all_memories-481"><span class="linenos">481</span></a>                                        <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-482"><a href="#AgentMemoryManager.clear_all_memories-482"><span class="linenos">482</span></a>                                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-483"><a href="#AgentMemoryManager.clear_all_memories-483"><span class="linenos">483</span></a>                                        <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">del_resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager.clear_all_memories-484"><a href="#AgentMemoryManager.clear_all_memories-484"><span class="linenos">484</span></a>                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-485"><a href="#AgentMemoryManager.clear_all_memories-485"><span class="linenos">485</span></a>                                            <span class="s2">&quot;Failed to clear memories from LightRAG: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.clear_all_memories-486"><a href="#AgentMemoryManager.clear_all_memories-486"><span class="linenos">486</span></a>                                            <span class="n">error_text</span><span class="p">,</span>
</span><span id="AgentMemoryManager.clear_all_memories-487"><a href="#AgentMemoryManager.clear_all_memories-487"><span class="linenos">487</span></a>                                        <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-488"><a href="#AgentMemoryManager.clear_all_memories-488"><span class="linenos">488</span></a>                                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-489"><a href="#AgentMemoryManager.clear_all_memories-489"><span class="linenos">489</span></a>                                            <span class="sa">f</span><span class="s2">&quot; Graph memory error: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.clear_all_memories-490"><a href="#AgentMemoryManager.clear_all_memories-490"><span class="linenos">490</span></a>                                        <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-491"><a href="#AgentMemoryManager.clear_all_memories-491"><span class="linenos">491</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-492"><a href="#AgentMemoryManager.clear_all_memories-492"><span class="linenos">492</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No documents found in LightRAG to clear&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-493"><a href="#AgentMemoryManager.clear_all_memories-493"><span class="linenos">493</span></a>                                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-494"><a href="#AgentMemoryManager.clear_all_memories-494"><span class="linenos">494</span></a>                                    <span class="s2">&quot; Graph memory: No documents found to clear&quot;</span>
</span><span id="AgentMemoryManager.clear_all_memories-495"><a href="#AgentMemoryManager.clear_all_memories-495"><span class="linenos">495</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-496"><a href="#AgentMemoryManager.clear_all_memories-496"><span class="linenos">496</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-497"><a href="#AgentMemoryManager.clear_all_memories-497"><span class="linenos">497</span></a>                            <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager.clear_all_memories-498"><a href="#AgentMemoryManager.clear_all_memories-498"><span class="linenos">498</span></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-499"><a href="#AgentMemoryManager.clear_all_memories-499"><span class="linenos">499</span></a>                                <span class="s2">&quot;Failed to get documents from LightRAG: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">error_text</span>
</span><span id="AgentMemoryManager.clear_all_memories-500"><a href="#AgentMemoryManager.clear_all_memories-500"><span class="linenos">500</span></a>                            <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-501"><a href="#AgentMemoryManager.clear_all_memories-501"><span class="linenos">501</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Graph memory error: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-502"><a href="#AgentMemoryManager.clear_all_memories-502"><span class="linenos">502</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-503"><a href="#AgentMemoryManager.clear_all_memories-503"><span class="linenos">503</span></a>                    <span class="c1"># 3. Clear the knowledge graph file</span>
</span><span id="AgentMemoryManager.clear_all_memories-504"><a href="#AgentMemoryManager.clear_all_memories-504"><span class="linenos">504</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-505"><a href="#AgentMemoryManager.clear_all_memories-505"><span class="linenos">505</span></a>                        <span class="c1"># Clear cache to ensure all in-memory data is flushed</span>
</span><span id="AgentMemoryManager.clear_all_memories-506"><a href="#AgentMemoryManager.clear_all_memories-506"><span class="linenos">506</span></a>                        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-507"><a href="#AgentMemoryManager.clear_all_memories-507"><span class="linenos">507</span></a>                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents/clear_cache&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.clear_all_memories-508"><a href="#AgentMemoryManager.clear_all_memories-508"><span class="linenos">508</span></a>                            <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;modes&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
</span><span id="AgentMemoryManager.clear_all_memories-509"><a href="#AgentMemoryManager.clear_all_memories-509"><span class="linenos">509</span></a>                            <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
</span><span id="AgentMemoryManager.clear_all_memories-510"><a href="#AgentMemoryManager.clear_all_memories-510"><span class="linenos">510</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-511"><a href="#AgentMemoryManager.clear_all_memories-511"><span class="linenos">511</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-512"><a href="#AgentMemoryManager.clear_all_memories-512"><span class="linenos">512</span></a>                        <span class="c1"># Delete the knowledge graph files</span>
</span><span id="AgentMemoryManager.clear_all_memories-513"><a href="#AgentMemoryManager.clear_all_memories-513"><span class="linenos">513</span></a>                        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="AgentMemoryManager.clear_all_memories-514"><a href="#AgentMemoryManager.clear_all_memories-514"><span class="linenos">514</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-515"><a href="#AgentMemoryManager.clear_all_memories-515"><span class="linenos">515</span></a>                        <span class="kn">from</span><span class="w"> </span><span class="nn">..config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-516"><a href="#AgentMemoryManager.clear_all_memories-516"><span class="linenos">516</span></a>                            <span class="n">LIGHTRAG_MEMORY_STORAGE_DIR</span><span class="p">,</span>
</span><span id="AgentMemoryManager.clear_all_memories-517"><a href="#AgentMemoryManager.clear_all_memories-517"><span class="linenos">517</span></a>                            <span class="n">LIGHTRAG_STORAGE_DIR</span><span class="p">,</span>
</span><span id="AgentMemoryManager.clear_all_memories-518"><a href="#AgentMemoryManager.clear_all_memories-518"><span class="linenos">518</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-519"><a href="#AgentMemoryManager.clear_all_memories-519"><span class="linenos">519</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-520"><a href="#AgentMemoryManager.clear_all_memories-520"><span class="linenos">520</span></a>                        <span class="n">graph_file_paths</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager.clear_all_memories-521"><a href="#AgentMemoryManager.clear_all_memories-521"><span class="linenos">521</span></a>                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-522"><a href="#AgentMemoryManager.clear_all_memories-522"><span class="linenos">522</span></a>                                <span class="n">LIGHTRAG_MEMORY_STORAGE_DIR</span><span class="p">,</span>
</span><span id="AgentMemoryManager.clear_all_memories-523"><a href="#AgentMemoryManager.clear_all_memories-523"><span class="linenos">523</span></a>                                <span class="s2">&quot;graph_chunk_entity_relation.graphml&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.clear_all_memories-524"><a href="#AgentMemoryManager.clear_all_memories-524"><span class="linenos">524</span></a>                            <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-525"><a href="#AgentMemoryManager.clear_all_memories-525"><span class="linenos">525</span></a>                        <span class="p">]</span>
</span><span id="AgentMemoryManager.clear_all_memories-526"><a href="#AgentMemoryManager.clear_all_memories-526"><span class="linenos">526</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-527"><a href="#AgentMemoryManager.clear_all_memories-527"><span class="linenos">527</span></a>                        <span class="n">graph_deleted</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AgentMemoryManager.clear_all_memories-528"><a href="#AgentMemoryManager.clear_all_memories-528"><span class="linenos">528</span></a>                        <span class="k">for</span> <span class="n">graph_file_path</span> <span class="ow">in</span> <span class="n">graph_file_paths</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-529"><a href="#AgentMemoryManager.clear_all_memories-529"><span class="linenos">529</span></a>                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">graph_file_path</span><span class="p">):</span>
</span><span id="AgentMemoryManager.clear_all_memories-530"><a href="#AgentMemoryManager.clear_all_memories-530"><span class="linenos">530</span></a>                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">graph_file_path</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-531"><a href="#AgentMemoryManager.clear_all_memories-531"><span class="linenos">531</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-532"><a href="#AgentMemoryManager.clear_all_memories-532"><span class="linenos">532</span></a>                                    <span class="s2">&quot;Deleted knowledge graph file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">graph_file_path</span>
</span><span id="AgentMemoryManager.clear_all_memories-533"><a href="#AgentMemoryManager.clear_all_memories-533"><span class="linenos">533</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-534"><a href="#AgentMemoryManager.clear_all_memories-534"><span class="linenos">534</span></a>                                <span class="n">graph_deleted</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AgentMemoryManager.clear_all_memories-535"><a href="#AgentMemoryManager.clear_all_memories-535"><span class="linenos">535</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-536"><a href="#AgentMemoryManager.clear_all_memories-536"><span class="linenos">536</span></a>                        <span class="k">if</span> <span class="n">graph_deleted</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-537"><a href="#AgentMemoryManager.clear_all_memories-537"><span class="linenos">537</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-538"><a href="#AgentMemoryManager.clear_all_memories-538"><span class="linenos">538</span></a>                                <span class="s2">&quot; Knowledge graph: Graph file deleted successfully&quot;</span>
</span><span id="AgentMemoryManager.clear_all_memories-539"><a href="#AgentMemoryManager.clear_all_memories-539"><span class="linenos">539</span></a>                            <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-540"><a href="#AgentMemoryManager.clear_all_memories-540"><span class="linenos">540</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-541"><a href="#AgentMemoryManager.clear_all_memories-541"><span class="linenos">541</span></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No knowledge graph files found to delete&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-542"><a href="#AgentMemoryManager.clear_all_memories-542"><span class="linenos">542</span></a>                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="AgentMemoryManager.clear_all_memories-543"><a href="#AgentMemoryManager.clear_all_memories-543"><span class="linenos">543</span></a>                                <span class="s2">&quot; Knowledge graph: No graph files found to delete&quot;</span>
</span><span id="AgentMemoryManager.clear_all_memories-544"><a href="#AgentMemoryManager.clear_all_memories-544"><span class="linenos">544</span></a>                            <span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-545"><a href="#AgentMemoryManager.clear_all_memories-545"><span class="linenos">545</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-546"><a href="#AgentMemoryManager.clear_all_memories-546"><span class="linenos">546</span></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-547"><a href="#AgentMemoryManager.clear_all_memories-547"><span class="linenos">547</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error deleting knowledge graph file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-548"><a href="#AgentMemoryManager.clear_all_memories-548"><span class="linenos">548</span></a>                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Knowledge graph error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-549"><a href="#AgentMemoryManager.clear_all_memories-549"><span class="linenos">549</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-550"><a href="#AgentMemoryManager.clear_all_memories-550"><span class="linenos">550</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-551"><a href="#AgentMemoryManager.clear_all_memories-551"><span class="linenos">551</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error clearing LightRAG memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-552"><a href="#AgentMemoryManager.clear_all_memories-552"><span class="linenos">552</span></a>                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Graph memory error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-553"><a href="#AgentMemoryManager.clear_all_memories-553"><span class="linenos">553</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-554"><a href="#AgentMemoryManager.clear_all_memories-554"><span class="linenos">554</span></a>            <span class="c1"># Return combined results</span>
</span><span id="AgentMemoryManager.clear_all_memories-555"><a href="#AgentMemoryManager.clear_all_memories-555"><span class="linenos">555</span></a>            <span class="k">return</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-556"><a href="#AgentMemoryManager.clear_all_memories-556"><span class="linenos">556</span></a>
</span><span id="AgentMemoryManager.clear_all_memories-557"><a href="#AgentMemoryManager.clear_all_memories-557"><span class="linenos">557</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.clear_all_memories-558"><a href="#AgentMemoryManager.clear_all_memories-558"><span class="linenos">558</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error clearing all memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.clear_all_memories-559"><a href="#AgentMemoryManager.clear_all_memories-559"><span class="linenos">559</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error clearing all memories: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Clear all memories from both SQLite and LightRAG systems.</p>

<p>This method provides a complete reset of the dual memory system by:</p>

<ol>
<li>Clearing all memories from the local SQLite database</li>
<li>Clearing all documents from the LightRAG memory server</li>
<li>Deleting the knowledge graph file</li>
</ol>

<p>Returns:
    str: Success or error message</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.query_memory" class="classattr">
                                        <input id="AgentMemoryManager.query_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">query_memory</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">query</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.query_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.query_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.query_memory-564"><a href="#AgentMemoryManager.query_memory-564"><span class="linenos">564</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_memory-565"><a href="#AgentMemoryManager.query_memory-565"><span class="linenos">565</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Search user memories using direct SemanticMemoryManager calls.</span>
</span><span id="AgentMemoryManager.query_memory-566"><a href="#AgentMemoryManager.query_memory-566"><span class="linenos">566</span></a>
</span><span id="AgentMemoryManager.query_memory-567"><a href="#AgentMemoryManager.query_memory-567"><span class="linenos">567</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.query_memory-568"><a href="#AgentMemoryManager.query_memory-568"><span class="linenos">568</span></a><span class="sd">            query: The query to search for in memories</span>
</span><span id="AgentMemoryManager.query_memory-569"><a href="#AgentMemoryManager.query_memory-569"><span class="linenos">569</span></a><span class="sd">            limit: Maximum number of memories to return</span>
</span><span id="AgentMemoryManager.query_memory-570"><a href="#AgentMemoryManager.query_memory-570"><span class="linenos">570</span></a>
</span><span id="AgentMemoryManager.query_memory-571"><a href="#AgentMemoryManager.query_memory-571"><span class="linenos">571</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.query_memory-572"><a href="#AgentMemoryManager.query_memory-572"><span class="linenos">572</span></a><span class="sd">            str: Found memories or message if none found</span>
</span><span id="AgentMemoryManager.query_memory-573"><a href="#AgentMemoryManager.query_memory-573"><span class="linenos">573</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.query_memory-574"><a href="#AgentMemoryManager.query_memory-574"><span class="linenos">574</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_memory-575"><a href="#AgentMemoryManager.query_memory-575"><span class="linenos">575</span></a>            <span class="n">stripped_query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AgentMemoryManager.query_memory-576"><a href="#AgentMemoryManager.query_memory-576"><span class="linenos">576</span></a>
</span><span id="AgentMemoryManager.query_memory-577"><a href="#AgentMemoryManager.query_memory-577"><span class="linenos">577</span></a>            <span class="c1"># List of phrases that should trigger get_all_memories instead of search</span>
</span><span id="AgentMemoryManager.query_memory-578"><a href="#AgentMemoryManager.query_memory-578"><span class="linenos">578</span></a>            <span class="n">get_all_phrases</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager.query_memory-579"><a href="#AgentMemoryManager.query_memory-579"><span class="linenos">579</span></a>                <span class="s2">&quot;all&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-580"><a href="#AgentMemoryManager.query_memory-580"><span class="linenos">580</span></a>                <span class="s2">&quot;all memories&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-581"><a href="#AgentMemoryManager.query_memory-581"><span class="linenos">581</span></a>                <span class="s2">&quot;everything&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-582"><a href="#AgentMemoryManager.query_memory-582"><span class="linenos">582</span></a>                <span class="s2">&quot;summarize all memories&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-583"><a href="#AgentMemoryManager.query_memory-583"><span class="linenos">583</span></a>                <span class="s2">&quot;what do you know about me&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-584"><a href="#AgentMemoryManager.query_memory-584"><span class="linenos">584</span></a>                <span class="s2">&quot;what have i told you&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-585"><a href="#AgentMemoryManager.query_memory-585"><span class="linenos">585</span></a>                <span class="s2">&quot;list all memories&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-586"><a href="#AgentMemoryManager.query_memory-586"><span class="linenos">586</span></a>                <span class="s2">&quot;show all memories&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-587"><a href="#AgentMemoryManager.query_memory-587"><span class="linenos">587</span></a>                <span class="s2">&quot;tell me everything&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-588"><a href="#AgentMemoryManager.query_memory-588"><span class="linenos">588</span></a>                <span class="s2">&quot;list everything you know&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-589"><a href="#AgentMemoryManager.query_memory-589"><span class="linenos">589</span></a>            <span class="p">]</span>
</span><span id="AgentMemoryManager.query_memory-590"><a href="#AgentMemoryManager.query_memory-590"><span class="linenos">590</span></a>
</span><span id="AgentMemoryManager.query_memory-591"><a href="#AgentMemoryManager.query_memory-591"><span class="linenos">591</span></a>            <span class="c1"># Check for explicit &quot;do not interpret&quot; or &quot;just list&quot; requests</span>
</span><span id="AgentMemoryManager.query_memory-592"><a href="#AgentMemoryManager.query_memory-592"><span class="linenos">592</span></a>            <span class="n">no_interpret_phrases</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager.query_memory-593"><a href="#AgentMemoryManager.query_memory-593"><span class="linenos">593</span></a>                <span class="s2">&quot;do not interpret&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-594"><a href="#AgentMemoryManager.query_memory-594"><span class="linenos">594</span></a>                <span class="s2">&quot;don&#39;t interpret&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-595"><a href="#AgentMemoryManager.query_memory-595"><span class="linenos">595</span></a>                <span class="s2">&quot;just list&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-596"><a href="#AgentMemoryManager.query_memory-596"><span class="linenos">596</span></a>                <span class="s2">&quot;just show&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-597"><a href="#AgentMemoryManager.query_memory-597"><span class="linenos">597</span></a>                <span class="s2">&quot;raw list&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-598"><a href="#AgentMemoryManager.query_memory-598"><span class="linenos">598</span></a>                <span class="s2">&quot;simple list&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-599"><a href="#AgentMemoryManager.query_memory-599"><span class="linenos">599</span></a>                <span class="s2">&quot;list them&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-600"><a href="#AgentMemoryManager.query_memory-600"><span class="linenos">600</span></a>                <span class="s2">&quot;show them&quot;</span>
</span><span id="AgentMemoryManager.query_memory-601"><a href="#AgentMemoryManager.query_memory-601"><span class="linenos">601</span></a>            <span class="p">]</span>
</span><span id="AgentMemoryManager.query_memory-602"><a href="#AgentMemoryManager.query_memory-602"><span class="linenos">602</span></a>            
</span><span id="AgentMemoryManager.query_memory-603"><a href="#AgentMemoryManager.query_memory-603"><span class="linenos">603</span></a>            <span class="n">should_skip_interpretation</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">phrase</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="n">no_interpret_phrases</span><span class="p">)</span>
</span><span id="AgentMemoryManager.query_memory-604"><a href="#AgentMemoryManager.query_memory-604"><span class="linenos">604</span></a>
</span><span id="AgentMemoryManager.query_memory-605"><a href="#AgentMemoryManager.query_memory-605"><span class="linenos">605</span></a>            <span class="k">if</span> <span class="n">stripped_query</span> <span class="ow">in</span> <span class="n">get_all_phrases</span> <span class="ow">or</span> <span class="s2">&quot;list all memories&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="AgentMemoryManager.query_memory-606"><a href="#AgentMemoryManager.query_memory-606"><span class="linenos">606</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.query_memory-607"><a href="#AgentMemoryManager.query_memory-607"><span class="linenos">607</span></a>                    <span class="s2">&quot;Generic/list query &#39;</span><span class="si">%s</span><span class="s2">&#39; detected. Using optimized list_memories for performance.&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-608"><a href="#AgentMemoryManager.query_memory-608"><span class="linenos">608</span></a>                    <span class="n">query</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-609"><a href="#AgentMemoryManager.query_memory-609"><span class="linenos">609</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.query_memory-610"><a href="#AgentMemoryManager.query_memory-610"><span class="linenos">610</span></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_memories</span><span class="p">()</span>
</span><span id="AgentMemoryManager.query_memory-611"><a href="#AgentMemoryManager.query_memory-611"><span class="linenos">611</span></a>
</span><span id="AgentMemoryManager.query_memory-612"><a href="#AgentMemoryManager.query_memory-612"><span class="linenos">612</span></a>            <span class="c1"># Validate query parameter</span>
</span><span id="AgentMemoryManager.query_memory-613"><a href="#AgentMemoryManager.query_memory-613"><span class="linenos">613</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="AgentMemoryManager.query_memory-614"><a href="#AgentMemoryManager.query_memory-614"><span class="linenos">614</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Empty query provided to query_memory&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.query_memory-615"><a href="#AgentMemoryManager.query_memory-615"><span class="linenos">615</span></a>                <span class="k">return</span> <span class="s2">&quot; Error: Query cannot be empty. Please provide a search term.&quot;</span>
</span><span id="AgentMemoryManager.query_memory-616"><a href="#AgentMemoryManager.query_memory-616"><span class="linenos">616</span></a>
</span><span id="AgentMemoryManager.query_memory-617"><a href="#AgentMemoryManager.query_memory-617"><span class="linenos">617</span></a>            <span class="c1"># Direct call to SemanticMemoryManager.search_memories()</span>
</span><span id="AgentMemoryManager.query_memory-618"><a href="#AgentMemoryManager.query_memory-618"><span class="linenos">618</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">search_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager.query_memory-619"><a href="#AgentMemoryManager.query_memory-619"><span class="linenos">619</span></a>                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
</span><span id="AgentMemoryManager.query_memory-620"><a href="#AgentMemoryManager.query_memory-620"><span class="linenos">620</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-621"><a href="#AgentMemoryManager.query_memory-621"><span class="linenos">621</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-622"><a href="#AgentMemoryManager.query_memory-622"><span class="linenos">622</span></a>                <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-623"><a href="#AgentMemoryManager.query_memory-623"><span class="linenos">623</span></a>                <span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-624"><a href="#AgentMemoryManager.query_memory-624"><span class="linenos">624</span></a>                <span class="n">search_topics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-625"><a href="#AgentMemoryManager.query_memory-625"><span class="linenos">625</span></a>                <span class="n">topic_boost</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_memory-626"><a href="#AgentMemoryManager.query_memory-626"><span class="linenos">626</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.query_memory-627"><a href="#AgentMemoryManager.query_memory-627"><span class="linenos">627</span></a>
</span><span id="AgentMemoryManager.query_memory-628"><a href="#AgentMemoryManager.query_memory-628"><span class="linenos">628</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_memory-629"><a href="#AgentMemoryManager.query_memory-629"><span class="linenos">629</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No matching memories found for query: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
</span><span id="AgentMemoryManager.query_memory-630"><a href="#AgentMemoryManager.query_memory-630"><span class="linenos">630</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; No memories found for &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;. Try different keywords or ask me to remember something new!&quot;</span>
</span><span id="AgentMemoryManager.query_memory-631"><a href="#AgentMemoryManager.query_memory-631"><span class="linenos">631</span></a>
</span><span id="AgentMemoryManager.query_memory-632"><a href="#AgentMemoryManager.query_memory-632"><span class="linenos">632</span></a>            <span class="c1"># Format results</span>
</span><span id="AgentMemoryManager.query_memory-633"><a href="#AgentMemoryManager.query_memory-633"><span class="linenos">633</span></a>            <span class="n">display_memories</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">results</span>
</span><span id="AgentMemoryManager.query_memory-634"><a href="#AgentMemoryManager.query_memory-634"><span class="linenos">634</span></a>            <span class="n">result_note</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; MEMORY RETRIEVAL (found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> matches via semantic search)&quot;</span>
</span><span id="AgentMemoryManager.query_memory-635"><a href="#AgentMemoryManager.query_memory-635"><span class="linenos">635</span></a>
</span><span id="AgentMemoryManager.query_memory-636"><a href="#AgentMemoryManager.query_memory-636"><span class="linenos">636</span></a>            <span class="k">if</span> <span class="n">should_skip_interpretation</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_memory-637"><a href="#AgentMemoryManager.query_memory-637"><span class="linenos">637</span></a>                <span class="c1"># PERFORMANCE OPTIMIZED: Skip interpretation instructions for explicit listing requests</span>
</span><span id="AgentMemoryManager.query_memory-638"><a href="#AgentMemoryManager.query_memory-638"><span class="linenos">638</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_note</span><span class="si">}</span><span class="s2">: The following memories were found for &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.query_memory-639"><a href="#AgentMemoryManager.query_memory-639"><span class="linenos">639</span></a>                
</span><span id="AgentMemoryManager.query_memory-640"><a href="#AgentMemoryManager.query_memory-640"><span class="linenos">640</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">display_memories</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AgentMemoryManager.query_memory-641"><a href="#AgentMemoryManager.query_memory-641"><span class="linenos">641</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2"> (similarity: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.query_memory-642"><a href="#AgentMemoryManager.query_memory-642"><span class="linenos">642</span></a>                    <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_memory-643"><a href="#AgentMemoryManager.query_memory-643"><span class="linenos">643</span></a>                        <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.query_memory-644"><a href="#AgentMemoryManager.query_memory-644"><span class="linenos">644</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.query_memory-645"><a href="#AgentMemoryManager.query_memory-645"><span class="linenos">645</span></a>                    
</span><span id="AgentMemoryManager.query_memory-646"><a href="#AgentMemoryManager.query_memory-646"><span class="linenos">646</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> matching memories for query: </span><span class="si">%s</span><span class="s2"> (no interpretation mode)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">query</span><span class="p">)</span>
</span><span id="AgentMemoryManager.query_memory-647"><a href="#AgentMemoryManager.query_memory-647"><span class="linenos">647</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_memory-648"><a href="#AgentMemoryManager.query_memory-648"><span class="linenos">648</span></a>                <span class="c1"># Standard mode with interpretation instructions</span>
</span><span id="AgentMemoryManager.query_memory-649"><a href="#AgentMemoryManager.query_memory-649"><span class="linenos">649</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_note</span><span class="si">}</span><span class="s2">: The following memories were found for &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;. You must restate this information addressing the user as &#39;you&#39; (second person), not as if you are the user:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.query_memory-650"><a href="#AgentMemoryManager.query_memory-650"><span class="linenos">650</span></a>
</span><span id="AgentMemoryManager.query_memory-651"><a href="#AgentMemoryManager.query_memory-651"><span class="linenos">651</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">display_memories</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AgentMemoryManager.query_memory-652"><a href="#AgentMemoryManager.query_memory-652"><span class="linenos">652</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2"> (similarity: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.query_memory-653"><a href="#AgentMemoryManager.query_memory-653"><span class="linenos">653</span></a>                    <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_memory-654"><a href="#AgentMemoryManager.query_memory-654"><span class="linenos">654</span></a>                        <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.query_memory-655"><a href="#AgentMemoryManager.query_memory-655"><span class="linenos">655</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.query_memory-656"><a href="#AgentMemoryManager.query_memory-656"><span class="linenos">656</span></a>
</span><span id="AgentMemoryManager.query_memory-657"><a href="#AgentMemoryManager.query_memory-657"><span class="linenos">657</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">REMEMBER: Restate this information as an AI assistant talking ABOUT the user, not AS the user. Use &#39;you&#39; instead of &#39;I&#39; when referring to the user&#39;s information.&quot;</span>
</span><span id="AgentMemoryManager.query_memory-658"><a href="#AgentMemoryManager.query_memory-658"><span class="linenos">658</span></a>                
</span><span id="AgentMemoryManager.query_memory-659"><a href="#AgentMemoryManager.query_memory-659"><span class="linenos">659</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> matching memories for query: </span><span class="si">%s</span><span class="s2"> (standard mode)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">query</span><span class="p">)</span>
</span><span id="AgentMemoryManager.query_memory-660"><a href="#AgentMemoryManager.query_memory-660"><span class="linenos">660</span></a>
</span><span id="AgentMemoryManager.query_memory-661"><a href="#AgentMemoryManager.query_memory-661"><span class="linenos">661</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager.query_memory-662"><a href="#AgentMemoryManager.query_memory-662"><span class="linenos">662</span></a>
</span><span id="AgentMemoryManager.query_memory-663"><a href="#AgentMemoryManager.query_memory-663"><span class="linenos">663</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_memory-664"><a href="#AgentMemoryManager.query_memory-664"><span class="linenos">664</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error querying memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.query_memory-665"><a href="#AgentMemoryManager.query_memory-665"><span class="linenos">665</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error searching memories: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Search user memories using direct SemanticMemoryManager calls.</p>

<p>Args:
    query: The query to search for in memories
    limit: Maximum number of memories to return</p>

<p>Returns:
    str: Found memories or message if none found</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.update_memory" class="classattr">
                                        <input id="AgentMemoryManager.update_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">update_memory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">content</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.update_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.update_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.update_memory-667"><a href="#AgentMemoryManager.update_memory-667"><span class="linenos">667</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager.update_memory-668"><a href="#AgentMemoryManager.update_memory-668"><span class="linenos">668</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager.update_memory-669"><a href="#AgentMemoryManager.update_memory-669"><span class="linenos">669</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.update_memory-670"><a href="#AgentMemoryManager.update_memory-670"><span class="linenos">670</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update an existing memory using direct SemanticMemoryManager calls.</span>
</span><span id="AgentMemoryManager.update_memory-671"><a href="#AgentMemoryManager.update_memory-671"><span class="linenos">671</span></a>
</span><span id="AgentMemoryManager.update_memory-672"><a href="#AgentMemoryManager.update_memory-672"><span class="linenos">672</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.update_memory-673"><a href="#AgentMemoryManager.update_memory-673"><span class="linenos">673</span></a><span class="sd">            memory_id: ID of the memory to update</span>
</span><span id="AgentMemoryManager.update_memory-674"><a href="#AgentMemoryManager.update_memory-674"><span class="linenos">674</span></a><span class="sd">            content: New memory content</span>
</span><span id="AgentMemoryManager.update_memory-675"><a href="#AgentMemoryManager.update_memory-675"><span class="linenos">675</span></a><span class="sd">            topics: Optional list of topics/categories for the memory</span>
</span><span id="AgentMemoryManager.update_memory-676"><a href="#AgentMemoryManager.update_memory-676"><span class="linenos">676</span></a>
</span><span id="AgentMemoryManager.update_memory-677"><a href="#AgentMemoryManager.update_memory-677"><span class="linenos">677</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.update_memory-678"><a href="#AgentMemoryManager.update_memory-678"><span class="linenos">678</span></a><span class="sd">            str: Success or error message</span>
</span><span id="AgentMemoryManager.update_memory-679"><a href="#AgentMemoryManager.update_memory-679"><span class="linenos">679</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.update_memory-680"><a href="#AgentMemoryManager.update_memory-680"><span class="linenos">680</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.update_memory-681"><a href="#AgentMemoryManager.update_memory-681"><span class="linenos">681</span></a>            <span class="c1"># SIMPLIFIED TOPIC HANDLING: Handle the common cases simply</span>
</span><span id="AgentMemoryManager.update_memory-682"><a href="#AgentMemoryManager.update_memory-682"><span class="linenos">682</span></a>            <span class="k">if</span> <span class="n">topics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AgentMemoryManager.update_memory-683"><a href="#AgentMemoryManager.update_memory-683"><span class="linenos">683</span></a>                <span class="c1"># Leave as None - let memory manager auto-classify</span>
</span><span id="AgentMemoryManager.update_memory-684"><a href="#AgentMemoryManager.update_memory-684"><span class="linenos">684</span></a>                <span class="k">pass</span>
</span><span id="AgentMemoryManager.update_memory-685"><a href="#AgentMemoryManager.update_memory-685"><span class="linenos">685</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AgentMemoryManager.update_memory-686"><a href="#AgentMemoryManager.update_memory-686"><span class="linenos">686</span></a>                <span class="c1"># Convert string to list, handle comma-separated values</span>
</span><span id="AgentMemoryManager.update_memory-687"><a href="#AgentMemoryManager.update_memory-687"><span class="linenos">687</span></a>                <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.update_memory-688"><a href="#AgentMemoryManager.update_memory-688"><span class="linenos">688</span></a>                    <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager.update_memory-689"><a href="#AgentMemoryManager.update_memory-689"><span class="linenos">689</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.update_memory-690"><a href="#AgentMemoryManager.update_memory-690"><span class="linenos">690</span></a>                    <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">if</span> <span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager.update_memory-691"><a href="#AgentMemoryManager.update_memory-691"><span class="linenos">691</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager.update_memory-692"><a href="#AgentMemoryManager.update_memory-692"><span class="linenos">692</span></a>                <span class="c1"># Clean up list - remove empty entries</span>
</span><span id="AgentMemoryManager.update_memory-693"><a href="#AgentMemoryManager.update_memory-693"><span class="linenos">693</span></a>                <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager.update_memory-694"><a href="#AgentMemoryManager.update_memory-694"><span class="linenos">694</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.update_memory-695"><a href="#AgentMemoryManager.update_memory-695"><span class="linenos">695</span></a>                    <span class="n">topics</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager.update_memory-696"><a href="#AgentMemoryManager.update_memory-696"><span class="linenos">696</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.update_memory-697"><a href="#AgentMemoryManager.update_memory-697"><span class="linenos">697</span></a>                <span class="c1"># Convert anything else to string and put in list</span>
</span><span id="AgentMemoryManager.update_memory-698"><a href="#AgentMemoryManager.update_memory-698"><span class="linenos">698</span></a>                <span class="n">topic_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AgentMemoryManager.update_memory-699"><a href="#AgentMemoryManager.update_memory-699"><span class="linenos">699</span></a>                <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">topic_str</span><span class="p">]</span> <span class="k">if</span> <span class="n">topic_str</span> <span class="ow">and</span> <span class="n">topic_str</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager.update_memory-700"><a href="#AgentMemoryManager.update_memory-700"><span class="linenos">700</span></a>
</span><span id="AgentMemoryManager.update_memory-701"><a href="#AgentMemoryManager.update_memory-701"><span class="linenos">701</span></a>            <span class="c1"># Direct call to SemanticMemoryManager.update_memory()</span>
</span><span id="AgentMemoryManager.update_memory-702"><a href="#AgentMemoryManager.update_memory-702"><span class="linenos">702</span></a>            <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">update_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager.update_memory-703"><a href="#AgentMemoryManager.update_memory-703"><span class="linenos">703</span></a>                <span class="n">memory_id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager.update_memory-704"><a href="#AgentMemoryManager.update_memory-704"><span class="linenos">704</span></a>                <span class="n">memory_text</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
</span><span id="AgentMemoryManager.update_memory-705"><a href="#AgentMemoryManager.update_memory-705"><span class="linenos">705</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
</span><span id="AgentMemoryManager.update_memory-706"><a href="#AgentMemoryManager.update_memory-706"><span class="linenos">706</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager.update_memory-707"><a href="#AgentMemoryManager.update_memory-707"><span class="linenos">707</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span>
</span><span id="AgentMemoryManager.update_memory-708"><a href="#AgentMemoryManager.update_memory-708"><span class="linenos">708</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.update_memory-709"><a href="#AgentMemoryManager.update_memory-709"><span class="linenos">709</span></a>
</span><span id="AgentMemoryManager.update_memory-710"><a href="#AgentMemoryManager.update_memory-710"><span class="linenos">710</span></a>            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="AgentMemoryManager.update_memory-711"><a href="#AgentMemoryManager.update_memory-711"><span class="linenos">711</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated memory </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">])</span>
</span><span id="AgentMemoryManager.update_memory-712"><a href="#AgentMemoryManager.update_memory-712"><span class="linenos">712</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Successfully updated memory: </span><span class="si">{</span><span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span id="AgentMemoryManager.update_memory-713"><a href="#AgentMemoryManager.update_memory-713"><span class="linenos">713</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.update_memory-714"><a href="#AgentMemoryManager.update_memory-714"><span class="linenos">714</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to update memory </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span><span id="AgentMemoryManager.update_memory-715"><a href="#AgentMemoryManager.update_memory-715"><span class="linenos">715</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error updating memory: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.update_memory-716"><a href="#AgentMemoryManager.update_memory-716"><span class="linenos">716</span></a>
</span><span id="AgentMemoryManager.update_memory-717"><a href="#AgentMemoryManager.update_memory-717"><span class="linenos">717</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.update_memory-718"><a href="#AgentMemoryManager.update_memory-718"><span class="linenos">718</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error updating memory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.update_memory-719"><a href="#AgentMemoryManager.update_memory-719"><span class="linenos">719</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error updating memory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Update an existing memory using direct SemanticMemoryManager calls.</p>

<p>Args:
    memory_id: ID of the memory to update
    content: New memory content
    topics: Optional list of topics/categories for the memory</p>

<p>Returns:
    str: Success or error message</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.delete_memory" class="classattr">
                                        <input id="AgentMemoryManager.delete_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">delete_memory</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.delete_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.delete_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.delete_memory-721"><a href="#AgentMemoryManager.delete_memory-721"><span class="linenos">721</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-722"><a href="#AgentMemoryManager.delete_memory-722"><span class="linenos">722</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a memory from both SQLite and LightRAG systems.</span>
</span><span id="AgentMemoryManager.delete_memory-723"><a href="#AgentMemoryManager.delete_memory-723"><span class="linenos">723</span></a>
</span><span id="AgentMemoryManager.delete_memory-724"><a href="#AgentMemoryManager.delete_memory-724"><span class="linenos">724</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.delete_memory-725"><a href="#AgentMemoryManager.delete_memory-725"><span class="linenos">725</span></a><span class="sd">            memory_id: ID of the memory to delete</span>
</span><span id="AgentMemoryManager.delete_memory-726"><a href="#AgentMemoryManager.delete_memory-726"><span class="linenos">726</span></a>
</span><span id="AgentMemoryManager.delete_memory-727"><a href="#AgentMemoryManager.delete_memory-727"><span class="linenos">727</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.delete_memory-728"><a href="#AgentMemoryManager.delete_memory-728"><span class="linenos">728</span></a><span class="sd">            str: Success or error message</span>
</span><span id="AgentMemoryManager.delete_memory-729"><a href="#AgentMemoryManager.delete_memory-729"><span class="linenos">729</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-730"><a href="#AgentMemoryManager.delete_memory-730"><span class="linenos">730</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-731"><a href="#AgentMemoryManager.delete_memory-731"><span class="linenos">731</span></a>            <span class="c1"># 1. Delete from local SQLite memory system</span>
</span><span id="AgentMemoryManager.delete_memory-732"><a href="#AgentMemoryManager.delete_memory-732"><span class="linenos">732</span></a>            <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-733"><a href="#AgentMemoryManager.delete_memory-733"><span class="linenos">733</span></a>                <span class="n">memory_id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager.delete_memory-734"><a href="#AgentMemoryManager.delete_memory-734"><span class="linenos">734</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-735"><a href="#AgentMemoryManager.delete_memory-735"><span class="linenos">735</span></a>
</span><span id="AgentMemoryManager.delete_memory-736"><a href="#AgentMemoryManager.delete_memory-736"><span class="linenos">736</span></a>            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-737"><a href="#AgentMemoryManager.delete_memory-737"><span class="linenos">737</span></a>                <span class="n">sqlite_deleted_message</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-738"><a href="#AgentMemoryManager.delete_memory-738"><span class="linenos">738</span></a>                    <span class="sa">f</span><span class="s2">&quot;Successfully deleted memory from SQLite: </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-739"><a href="#AgentMemoryManager.delete_memory-739"><span class="linenos">739</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-740"><a href="#AgentMemoryManager.delete_memory-740"><span class="linenos">740</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> from SQLite&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-741"><a href="#AgentMemoryManager.delete_memory-741"><span class="linenos">741</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-742"><a href="#AgentMemoryManager.delete_memory-742"><span class="linenos">742</span></a>                <span class="n">sqlite_deleted_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error deleting memory from SQLite: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-743"><a href="#AgentMemoryManager.delete_memory-743"><span class="linenos">743</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-744"><a href="#AgentMemoryManager.delete_memory-744"><span class="linenos">744</span></a>                    <span class="sa">f</span><span class="s2">&quot;Failed to delete memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> from SQLite: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-745"><a href="#AgentMemoryManager.delete_memory-745"><span class="linenos">745</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-746"><a href="#AgentMemoryManager.delete_memory-746"><span class="linenos">746</span></a>                <span class="c1"># If local deletion fails, no need to proceed with graph deletion</span>
</span><span id="AgentMemoryManager.delete_memory-747"><a href="#AgentMemoryManager.delete_memory-747"><span class="linenos">747</span></a>                <span class="k">return</span> <span class="n">sqlite_deleted_message</span>
</span><span id="AgentMemoryManager.delete_memory-748"><a href="#AgentMemoryManager.delete_memory-748"><span class="linenos">748</span></a>
</span><span id="AgentMemoryManager.delete_memory-749"><a href="#AgentMemoryManager.delete_memory-749"><span class="linenos">749</span></a>            <span class="c1"># 2. Delete from LightRAG graph memory</span>
</span><span id="AgentMemoryManager.delete_memory-750"><a href="#AgentMemoryManager.delete_memory-750"><span class="linenos">750</span></a>            <span class="n">graph_deleted_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-751"><a href="#AgentMemoryManager.delete_memory-751"><span class="linenos">751</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-752"><a href="#AgentMemoryManager.delete_memory-752"><span class="linenos">752</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-753"><a href="#AgentMemoryManager.delete_memory-753"><span class="linenos">753</span></a>                    <span class="c1"># Step 1: Find the document ID by its filename pattern</span>
</span><span id="AgentMemoryManager.delete_memory-754"><a href="#AgentMemoryManager.delete_memory-754"><span class="linenos">754</span></a>                    <span class="n">list_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-755"><a href="#AgentMemoryManager.delete_memory-755"><span class="linenos">755</span></a>                    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-756"><a href="#AgentMemoryManager.delete_memory-756"><span class="linenos">756</span></a>                        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">list_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-757"><a href="#AgentMemoryManager.delete_memory-757"><span class="linenos">757</span></a>                            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-758"><a href="#AgentMemoryManager.delete_memory-758"><span class="linenos">758</span></a>                                <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager.delete_memory-759"><a href="#AgentMemoryManager.delete_memory-759"><span class="linenos">759</span></a>                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-760"><a href="#AgentMemoryManager.delete_memory-760"><span class="linenos">760</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Failed to list documents from LightRAG: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-761"><a href="#AgentMemoryManager.delete_memory-761"><span class="linenos">761</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-762"><a href="#AgentMemoryManager.delete_memory-762"><span class="linenos">762</span></a>                            <span class="n">docs_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentMemoryManager.delete_memory-763"><a href="#AgentMemoryManager.delete_memory-763"><span class="linenos">763</span></a>
</span><span id="AgentMemoryManager.delete_memory-764"><a href="#AgentMemoryManager.delete_memory-764"><span class="linenos">764</span></a>                            <span class="c1"># Extract documents from the actual LightRAG structure</span>
</span><span id="AgentMemoryManager.delete_memory-765"><a href="#AgentMemoryManager.delete_memory-765"><span class="linenos">765</span></a>                            <span class="n">documents</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.delete_memory-766"><a href="#AgentMemoryManager.delete_memory-766"><span class="linenos">766</span></a>                            <span class="k">if</span> <span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-767"><a href="#AgentMemoryManager.delete_memory-767"><span class="linenos">767</span></a>                                <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs_response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-768"><a href="#AgentMemoryManager.delete_memory-768"><span class="linenos">768</span></a>                                <span class="ow">and</span> <span class="s2">&quot;statuses&quot;</span> <span class="ow">in</span> <span class="n">docs_response</span>
</span><span id="AgentMemoryManager.delete_memory-769"><a href="#AgentMemoryManager.delete_memory-769"><span class="linenos">769</span></a>                            <span class="p">):</span>
</span><span id="AgentMemoryManager.delete_memory-770"><a href="#AgentMemoryManager.delete_memory-770"><span class="linenos">770</span></a>                                <span class="n">statuses</span> <span class="o">=</span> <span class="n">docs_response</span><span class="p">[</span><span class="s2">&quot;statuses&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager.delete_memory-771"><a href="#AgentMemoryManager.delete_memory-771"><span class="linenos">771</span></a>                                <span class="k">for</span> <span class="n">status_name</span><span class="p">,</span> <span class="n">docs_list</span> <span class="ow">in</span> <span class="n">statuses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AgentMemoryManager.delete_memory-772"><a href="#AgentMemoryManager.delete_memory-772"><span class="linenos">772</span></a>                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager.delete_memory-773"><a href="#AgentMemoryManager.delete_memory-773"><span class="linenos">773</span></a>                                        <span class="n">documents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">docs_list</span><span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-774"><a href="#AgentMemoryManager.delete_memory-774"><span class="linenos">774</span></a>                            <span class="k">elif</span> <span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-775"><a href="#AgentMemoryManager.delete_memory-775"><span class="linenos">775</span></a>                                <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs_response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-776"><a href="#AgentMemoryManager.delete_memory-776"><span class="linenos">776</span></a>                                <span class="ow">and</span> <span class="s2">&quot;documents&quot;</span> <span class="ow">in</span> <span class="n">docs_response</span>
</span><span id="AgentMemoryManager.delete_memory-777"><a href="#AgentMemoryManager.delete_memory-777"><span class="linenos">777</span></a>                            <span class="p">):</span>
</span><span id="AgentMemoryManager.delete_memory-778"><a href="#AgentMemoryManager.delete_memory-778"><span class="linenos">778</span></a>                                <span class="n">documents</span> <span class="o">=</span> <span class="n">docs_response</span><span class="p">[</span><span class="s2">&quot;documents&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager.delete_memory-779"><a href="#AgentMemoryManager.delete_memory-779"><span class="linenos">779</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs_response</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager.delete_memory-780"><a href="#AgentMemoryManager.delete_memory-780"><span class="linenos">780</span></a>                                <span class="n">documents</span> <span class="o">=</span> <span class="n">docs_response</span>
</span><span id="AgentMemoryManager.delete_memory-781"><a href="#AgentMemoryManager.delete_memory-781"><span class="linenos">781</span></a>
</span><span id="AgentMemoryManager.delete_memory-782"><a href="#AgentMemoryManager.delete_memory-782"><span class="linenos">782</span></a>                    <span class="n">doc_id_to_delete</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager.delete_memory-783"><a href="#AgentMemoryManager.delete_memory-783"><span class="linenos">783</span></a>                    <span class="c1"># The filename is memory_{memory_id}_{hash}.txt</span>
</span><span id="AgentMemoryManager.delete_memory-784"><a href="#AgentMemoryManager.delete_memory-784"><span class="linenos">784</span></a>                    <span class="n">filename_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;memory_</span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">_&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-785"><a href="#AgentMemoryManager.delete_memory-785"><span class="linenos">785</span></a>
</span><span id="AgentMemoryManager.delete_memory-786"><a href="#AgentMemoryManager.delete_memory-786"><span class="linenos">786</span></a>                    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-787"><a href="#AgentMemoryManager.delete_memory-787"><span class="linenos">787</span></a>                        <span class="c1"># Check file_path field (not metadata.source)</span>
</span><span id="AgentMemoryManager.delete_memory-788"><a href="#AgentMemoryManager.delete_memory-788"><span class="linenos">788</span></a>                        <span class="n">file_path</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-789"><a href="#AgentMemoryManager.delete_memory-789"><span class="linenos">789</span></a>                        <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">filename_pattern</span><span class="p">):</span>
</span><span id="AgentMemoryManager.delete_memory-790"><a href="#AgentMemoryManager.delete_memory-790"><span class="linenos">790</span></a>                            <span class="n">doc_id_to_delete</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-791"><a href="#AgentMemoryManager.delete_memory-791"><span class="linenos">791</span></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-792"><a href="#AgentMemoryManager.delete_memory-792"><span class="linenos">792</span></a>                                <span class="sa">f</span><span class="s2">&quot;Found document to delete: </span><span class="si">{</span><span class="n">doc_id_to_delete</span><span class="si">}</span><span class="s2"> (file_path: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-793"><a href="#AgentMemoryManager.delete_memory-793"><span class="linenos">793</span></a>                            <span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-794"><a href="#AgentMemoryManager.delete_memory-794"><span class="linenos">794</span></a>                            <span class="k">break</span>
</span><span id="AgentMemoryManager.delete_memory-795"><a href="#AgentMemoryManager.delete_memory-795"><span class="linenos">795</span></a>
</span><span id="AgentMemoryManager.delete_memory-796"><a href="#AgentMemoryManager.delete_memory-796"><span class="linenos">796</span></a>                    <span class="c1"># Step 2: Delete the document if found</span>
</span><span id="AgentMemoryManager.delete_memory-797"><a href="#AgentMemoryManager.delete_memory-797"><span class="linenos">797</span></a>                    <span class="k">if</span> <span class="n">doc_id_to_delete</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-798"><a href="#AgentMemoryManager.delete_memory-798"><span class="linenos">798</span></a>                        <span class="n">delete_url</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-799"><a href="#AgentMemoryManager.delete_memory-799"><span class="linenos">799</span></a>                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents/delete_document&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-800"><a href="#AgentMemoryManager.delete_memory-800"><span class="linenos">800</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-801"><a href="#AgentMemoryManager.delete_memory-801"><span class="linenos">801</span></a>                        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-802"><a href="#AgentMemoryManager.delete_memory-802"><span class="linenos">802</span></a>                            <span class="c1"># Use doc_ids (plural) as expected by the API</span>
</span><span id="AgentMemoryManager.delete_memory-803"><a href="#AgentMemoryManager.delete_memory-803"><span class="linenos">803</span></a>                            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-804"><a href="#AgentMemoryManager.delete_memory-804"><span class="linenos">804</span></a>                                <span class="n">delete_url</span><span class="p">,</span>
</span><span id="AgentMemoryManager.delete_memory-805"><a href="#AgentMemoryManager.delete_memory-805"><span class="linenos">805</span></a>                                <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;doc_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">doc_id_to_delete</span><span class="p">]},</span>
</span><span id="AgentMemoryManager.delete_memory-806"><a href="#AgentMemoryManager.delete_memory-806"><span class="linenos">806</span></a>                                <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
</span><span id="AgentMemoryManager.delete_memory-807"><a href="#AgentMemoryManager.delete_memory-807"><span class="linenos">807</span></a>                            <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-808"><a href="#AgentMemoryManager.delete_memory-808"><span class="linenos">808</span></a>                                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-809"><a href="#AgentMemoryManager.delete_memory-809"><span class="linenos">809</span></a>                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-810"><a href="#AgentMemoryManager.delete_memory-810"><span class="linenos">810</span></a>                                        <span class="sa">f</span><span class="s2">&quot;Successfully deleted memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> (doc_id: </span><span class="si">{</span><span class="n">doc_id_to_delete</span><span class="si">}</span><span class="s2">) from LightRAG.&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-811"><a href="#AgentMemoryManager.delete_memory-811"><span class="linenos">811</span></a>                                    <span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-812"><a href="#AgentMemoryManager.delete_memory-812"><span class="linenos">812</span></a>                                    <span class="n">graph_deleted_message</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-813"><a href="#AgentMemoryManager.delete_memory-813"><span class="linenos">813</span></a>                                        <span class="sa">f</span><span class="s2">&quot;Successfully deleted from graph memory&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-814"><a href="#AgentMemoryManager.delete_memory-814"><span class="linenos">814</span></a>                                    <span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-815"><a href="#AgentMemoryManager.delete_memory-815"><span class="linenos">815</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-816"><a href="#AgentMemoryManager.delete_memory-816"><span class="linenos">816</span></a>                                    <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager.delete_memory-817"><a href="#AgentMemoryManager.delete_memory-817"><span class="linenos">817</span></a>                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-818"><a href="#AgentMemoryManager.delete_memory-818"><span class="linenos">818</span></a>                                        <span class="sa">f</span><span class="s2">&quot;Failed to delete document </span><span class="si">{</span><span class="n">doc_id_to_delete</span><span class="si">}</span><span class="s2"> from LightRAG: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-819"><a href="#AgentMemoryManager.delete_memory-819"><span class="linenos">819</span></a>                                    <span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-820"><a href="#AgentMemoryManager.delete_memory-820"><span class="linenos">820</span></a>                                    <span class="n">graph_deleted_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; Could not delete from graph memory: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-821"><a href="#AgentMemoryManager.delete_memory-821"><span class="linenos">821</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-822"><a href="#AgentMemoryManager.delete_memory-822"><span class="linenos">822</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-823"><a href="#AgentMemoryManager.delete_memory-823"><span class="linenos">823</span></a>                            <span class="sa">f</span><span class="s2">&quot;Memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> not found in LightRAG graph memory (searched for pattern: </span><span class="si">{</span><span class="n">filename_pattern</span><span class="si">}</span><span class="s2">).&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-824"><a href="#AgentMemoryManager.delete_memory-824"><span class="linenos">824</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-825"><a href="#AgentMemoryManager.delete_memory-825"><span class="linenos">825</span></a>                        <span class="c1"># Treat &quot;not found&quot; as successful deletion since the goal is achieved</span>
</span><span id="AgentMemoryManager.delete_memory-826"><a href="#AgentMemoryManager.delete_memory-826"><span class="linenos">826</span></a>                        <span class="n">graph_deleted_message</span> <span class="o">=</span> <span class="s2">&quot;Successfully deleted from graph memory&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-827"><a href="#AgentMemoryManager.delete_memory-827"><span class="linenos">827</span></a>
</span><span id="AgentMemoryManager.delete_memory-828"><a href="#AgentMemoryManager.delete_memory-828"><span class="linenos">828</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-829"><a href="#AgentMemoryManager.delete_memory-829"><span class="linenos">829</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception deleting memory from graph: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-830"><a href="#AgentMemoryManager.delete_memory-830"><span class="linenos">830</span></a>                    <span class="n">graph_deleted_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; Could not delete from graph memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-831"><a href="#AgentMemoryManager.delete_memory-831"><span class="linenos">831</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-832"><a href="#AgentMemoryManager.delete_memory-832"><span class="linenos">832</span></a>                <span class="n">graph_deleted_message</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memory-833"><a href="#AgentMemoryManager.delete_memory-833"><span class="linenos">833</span></a>                    <span class="s2">&quot;Graph memory client not configured, skipping deletion.&quot;</span>
</span><span id="AgentMemoryManager.delete_memory-834"><a href="#AgentMemoryManager.delete_memory-834"><span class="linenos">834</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-835"><a href="#AgentMemoryManager.delete_memory-835"><span class="linenos">835</span></a>
</span><span id="AgentMemoryManager.delete_memory-836"><a href="#AgentMemoryManager.delete_memory-836"><span class="linenos">836</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sqlite_deleted_message</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">graph_deleted_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AgentMemoryManager.delete_memory-837"><a href="#AgentMemoryManager.delete_memory-837"><span class="linenos">837</span></a>
</span><span id="AgentMemoryManager.delete_memory-838"><a href="#AgentMemoryManager.delete_memory-838"><span class="linenos">838</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memory-839"><a href="#AgentMemoryManager.delete_memory-839"><span class="linenos">839</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memory-840"><a href="#AgentMemoryManager.delete_memory-840"><span class="linenos">840</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error deleting memory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Delete a memory from both SQLite and LightRAG systems.</p>

<p>Args:
    memory_id: ID of the memory to delete</p>

<p>Returns:
    str: Success or error message</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.get_recent_memories" class="classattr">
                                        <input id="AgentMemoryManager.get_recent_memories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">get_recent_memories</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.get_recent_memories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.get_recent_memories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.get_recent_memories-842"><a href="#AgentMemoryManager.get_recent_memories-842"><span class="linenos">842</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_recent_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_recent_memories-843"><a href="#AgentMemoryManager.get_recent_memories-843"><span class="linenos">843</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get recent memories by searching all memories and sorting by date.</span>
</span><span id="AgentMemoryManager.get_recent_memories-844"><a href="#AgentMemoryManager.get_recent_memories-844"><span class="linenos">844</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-845"><a href="#AgentMemoryManager.get_recent_memories-845"><span class="linenos">845</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.get_recent_memories-846"><a href="#AgentMemoryManager.get_recent_memories-846"><span class="linenos">846</span></a><span class="sd">            limit: Maximum number of memories to return</span>
</span><span id="AgentMemoryManager.get_recent_memories-847"><a href="#AgentMemoryManager.get_recent_memories-847"><span class="linenos">847</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-848"><a href="#AgentMemoryManager.get_recent_memories-848"><span class="linenos">848</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.get_recent_memories-849"><a href="#AgentMemoryManager.get_recent_memories-849"><span class="linenos">849</span></a><span class="sd">            str: Formatted string of recent memories</span>
</span><span id="AgentMemoryManager.get_recent_memories-850"><a href="#AgentMemoryManager.get_recent_memories-850"><span class="linenos">850</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.get_recent_memories-851"><a href="#AgentMemoryManager.get_recent_memories-851"><span class="linenos">851</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_recent_memories-852"><a href="#AgentMemoryManager.get_recent_memories-852"><span class="linenos">852</span></a>            <span class="c1"># Direct call to SemanticMemoryManager.get_all_memories()</span>
</span><span id="AgentMemoryManager.get_recent_memories-853"><a href="#AgentMemoryManager.get_recent_memories-853"><span class="linenos">853</span></a>            <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">get_all_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_recent_memories-854"><a href="#AgentMemoryManager.get_recent_memories-854"><span class="linenos">854</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager.get_recent_memories-855"><a href="#AgentMemoryManager.get_recent_memories-855"><span class="linenos">855</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.get_recent_memories-856"><a href="#AgentMemoryManager.get_recent_memories-856"><span class="linenos">856</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-857"><a href="#AgentMemoryManager.get_recent_memories-857"><span class="linenos">857</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_recent_memories-858"><a href="#AgentMemoryManager.get_recent_memories-858"><span class="linenos">858</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No memories found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_recent_memories-859"><a href="#AgentMemoryManager.get_recent_memories-859"><span class="linenos">859</span></a>                <span class="k">return</span> <span class="s2">&quot; No memories found. Try storing some information first!&quot;</span>
</span><span id="AgentMemoryManager.get_recent_memories-860"><a href="#AgentMemoryManager.get_recent_memories-860"><span class="linenos">860</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-861"><a href="#AgentMemoryManager.get_recent_memories-861"><span class="linenos">861</span></a>            <span class="c1"># Sort memories by timestamp (newest first)</span>
</span><span id="AgentMemoryManager.get_recent_memories-862"><a href="#AgentMemoryManager.get_recent_memories-862"><span class="linenos">862</span></a>            <span class="n">sorted_memories</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_recent_memories-863"><a href="#AgentMemoryManager.get_recent_memories-863"><span class="linenos">863</span></a>                <span class="n">memories</span><span class="p">,</span>
</span><span id="AgentMemoryManager.get_recent_memories-864"><a href="#AgentMemoryManager.get_recent_memories-864"><span class="linenos">864</span></a>                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="AgentMemoryManager.get_recent_memories-865"><a href="#AgentMemoryManager.get_recent_memories-865"><span class="linenos">865</span></a>                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager.get_recent_memories-866"><a href="#AgentMemoryManager.get_recent_memories-866"><span class="linenos">866</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.get_recent_memories-867"><a href="#AgentMemoryManager.get_recent_memories-867"><span class="linenos">867</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-868"><a href="#AgentMemoryManager.get_recent_memories-868"><span class="linenos">868</span></a>            <span class="c1"># Limit the number of memories</span>
</span><span id="AgentMemoryManager.get_recent_memories-869"><a href="#AgentMemoryManager.get_recent_memories-869"><span class="linenos">869</span></a>            <span class="n">display_memories</span> <span class="o">=</span> <span class="n">sorted_memories</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">sorted_memories</span>
</span><span id="AgentMemoryManager.get_recent_memories-870"><a href="#AgentMemoryManager.get_recent_memories-870"><span class="linenos">870</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-871"><a href="#AgentMemoryManager.get_recent_memories-871"><span class="linenos">871</span></a>            <span class="c1"># Format results</span>
</span><span id="AgentMemoryManager.get_recent_memories-872"><a href="#AgentMemoryManager.get_recent_memories-872"><span class="linenos">872</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; RECENT MEMORIES (showing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">display_memories</span><span class="p">)</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span><span class="si">}</span><span class="s2"> total memories):</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_recent_memories-873"><a href="#AgentMemoryManager.get_recent_memories-873"><span class="linenos">873</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-874"><a href="#AgentMemoryManager.get_recent_memories-874"><span class="linenos">874</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">memory</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">display_memories</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AgentMemoryManager.get_recent_memories-875"><a href="#AgentMemoryManager.get_recent_memories-875"><span class="linenos">875</span></a>                <span class="c1"># Format the memory content</span>
</span><span id="AgentMemoryManager.get_recent_memories-876"><a href="#AgentMemoryManager.get_recent_memories-876"><span class="linenos">876</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_recent_memories-877"><a href="#AgentMemoryManager.get_recent_memories-877"><span class="linenos">877</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-878"><a href="#AgentMemoryManager.get_recent_memories-878"><span class="linenos">878</span></a>                <span class="c1"># Add topics if available</span>
</span><span id="AgentMemoryManager.get_recent_memories-879"><a href="#AgentMemoryManager.get_recent_memories-879"><span class="linenos">879</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;topics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_recent_memories-880"><a href="#AgentMemoryManager.get_recent_memories-880"><span class="linenos">880</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_recent_memories-881"><a href="#AgentMemoryManager.get_recent_memories-881"><span class="linenos">881</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-882"><a href="#AgentMemoryManager.get_recent_memories-882"><span class="linenos">882</span></a>                <span class="c1"># Add timestamp if available</span>
</span><span id="AgentMemoryManager.get_recent_memories-883"><a href="#AgentMemoryManager.get_recent_memories-883"><span class="linenos">883</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_recent_memories-884"><a href="#AgentMemoryManager.get_recent_memories-884"><span class="linenos">884</span></a>                    <span class="c1"># Convert timestamp to readable format</span>
</span><span id="AgentMemoryManager.get_recent_memories-885"><a href="#AgentMemoryManager.get_recent_memories-885"><span class="linenos">885</span></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="AgentMemoryManager.get_recent_memories-886"><a href="#AgentMemoryManager.get_recent_memories-886"><span class="linenos">886</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-887"><a href="#AgentMemoryManager.get_recent_memories-887"><span class="linenos">887</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_recent_memories-888"><a href="#AgentMemoryManager.get_recent_memories-888"><span class="linenos">888</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Created: </span><span class="si">{</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_recent_memories-889"><a href="#AgentMemoryManager.get_recent_memories-889"><span class="linenos">889</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-890"><a href="#AgentMemoryManager.get_recent_memories-890"><span class="linenos">890</span></a>                <span class="c1"># Add memory ID for reference</span>
</span><span id="AgentMemoryManager.get_recent_memories-891"><a href="#AgentMemoryManager.get_recent_memories-891"><span class="linenos">891</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   ID: </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory_id</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_recent_memories-892"><a href="#AgentMemoryManager.get_recent_memories-892"><span class="linenos">892</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-893"><a href="#AgentMemoryManager.get_recent_memories-893"><span class="linenos">893</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_recent_memories-894"><a href="#AgentMemoryManager.get_recent_memories-894"><span class="linenos">894</span></a>                <span class="s2">&quot;Retrieved </span><span class="si">%d</span><span class="s2"> recent memories for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.get_recent_memories-895"><a href="#AgentMemoryManager.get_recent_memories-895"><span class="linenos">895</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">display_memories</span><span class="p">),</span>
</span><span id="AgentMemoryManager.get_recent_memories-896"><a href="#AgentMemoryManager.get_recent_memories-896"><span class="linenos">896</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager.get_recent_memories-897"><a href="#AgentMemoryManager.get_recent_memories-897"><span class="linenos">897</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.get_recent_memories-898"><a href="#AgentMemoryManager.get_recent_memories-898"><span class="linenos">898</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager.get_recent_memories-899"><a href="#AgentMemoryManager.get_recent_memories-899"><span class="linenos">899</span></a>
</span><span id="AgentMemoryManager.get_recent_memories-900"><a href="#AgentMemoryManager.get_recent_memories-900"><span class="linenos">900</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_recent_memories-901"><a href="#AgentMemoryManager.get_recent_memories-901"><span class="linenos">901</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error retrieving recent memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_recent_memories-902"><a href="#AgentMemoryManager.get_recent_memories-902"><span class="linenos">902</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error retrieving recent memories: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Get recent memories by searching all memories and sorting by date.</p>

<p>Args:
    limit: Maximum number of memories to return</p>

<p>Returns:
    str: Formatted string of recent memories</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.get_all_memories" class="classattr">
                                        <input id="AgentMemoryManager.get_all_memories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">get_all_memories</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.get_all_memories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.get_all_memories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.get_all_memories-904"><a href="#AgentMemoryManager.get_all_memories-904"><span class="linenos">904</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_all_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_all_memories-905"><a href="#AgentMemoryManager.get_all_memories-905"><span class="linenos">905</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all user memories.</span>
</span><span id="AgentMemoryManager.get_all_memories-906"><a href="#AgentMemoryManager.get_all_memories-906"><span class="linenos">906</span></a>
</span><span id="AgentMemoryManager.get_all_memories-907"><a href="#AgentMemoryManager.get_all_memories-907"><span class="linenos">907</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.get_all_memories-908"><a href="#AgentMemoryManager.get_all_memories-908"><span class="linenos">908</span></a><span class="sd">            str: Formatted string of all memories</span>
</span><span id="AgentMemoryManager.get_all_memories-909"><a href="#AgentMemoryManager.get_all_memories-909"><span class="linenos">909</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.get_all_memories-910"><a href="#AgentMemoryManager.get_all_memories-910"><span class="linenos">910</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_all_memories-911"><a href="#AgentMemoryManager.get_all_memories-911"><span class="linenos">911</span></a>            <span class="c1"># Direct call to SemanticMemoryManager.get_all_memories()</span>
</span><span id="AgentMemoryManager.get_all_memories-912"><a href="#AgentMemoryManager.get_all_memories-912"><span class="linenos">912</span></a>            <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">get_all_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_all_memories-913"><a href="#AgentMemoryManager.get_all_memories-913"><span class="linenos">913</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager.get_all_memories-914"><a href="#AgentMemoryManager.get_all_memories-914"><span class="linenos">914</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.get_all_memories-915"><a href="#AgentMemoryManager.get_all_memories-915"><span class="linenos">915</span></a>
</span><span id="AgentMemoryManager.get_all_memories-916"><a href="#AgentMemoryManager.get_all_memories-916"><span class="linenos">916</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_all_memories-917"><a href="#AgentMemoryManager.get_all_memories-917"><span class="linenos">917</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No memories found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_all_memories-918"><a href="#AgentMemoryManager.get_all_memories-918"><span class="linenos">918</span></a>                <span class="k">return</span> <span class="s2">&quot; No memories found. Try storing some information first!&quot;</span>
</span><span id="AgentMemoryManager.get_all_memories-919"><a href="#AgentMemoryManager.get_all_memories-919"><span class="linenos">919</span></a>
</span><span id="AgentMemoryManager.get_all_memories-920"><a href="#AgentMemoryManager.get_all_memories-920"><span class="linenos">920</span></a>            <span class="c1"># Sort memories by timestamp (newest first)</span>
</span><span id="AgentMemoryManager.get_all_memories-921"><a href="#AgentMemoryManager.get_all_memories-921"><span class="linenos">921</span></a>            <span class="n">sorted_memories</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_all_memories-922"><a href="#AgentMemoryManager.get_all_memories-922"><span class="linenos">922</span></a>                <span class="n">memories</span><span class="p">,</span>
</span><span id="AgentMemoryManager.get_all_memories-923"><a href="#AgentMemoryManager.get_all_memories-923"><span class="linenos">923</span></a>                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="AgentMemoryManager.get_all_memories-924"><a href="#AgentMemoryManager.get_all_memories-924"><span class="linenos">924</span></a>                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager.get_all_memories-925"><a href="#AgentMemoryManager.get_all_memories-925"><span class="linenos">925</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.get_all_memories-926"><a href="#AgentMemoryManager.get_all_memories-926"><span class="linenos">926</span></a>
</span><span id="AgentMemoryManager.get_all_memories-927"><a href="#AgentMemoryManager.get_all_memories-927"><span class="linenos">927</span></a>            <span class="c1"># Format results</span>
</span><span id="AgentMemoryManager.get_all_memories-928"><a href="#AgentMemoryManager.get_all_memories-928"><span class="linenos">928</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; ALL MEMORIES (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span><span class="si">}</span><span class="s2"> total):</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_all_memories-929"><a href="#AgentMemoryManager.get_all_memories-929"><span class="linenos">929</span></a>
</span><span id="AgentMemoryManager.get_all_memories-930"><a href="#AgentMemoryManager.get_all_memories-930"><span class="linenos">930</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">memory</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_memories</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AgentMemoryManager.get_all_memories-931"><a href="#AgentMemoryManager.get_all_memories-931"><span class="linenos">931</span></a>                <span class="c1"># Format the memory content</span>
</span><span id="AgentMemoryManager.get_all_memories-932"><a href="#AgentMemoryManager.get_all_memories-932"><span class="linenos">932</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_all_memories-933"><a href="#AgentMemoryManager.get_all_memories-933"><span class="linenos">933</span></a>
</span><span id="AgentMemoryManager.get_all_memories-934"><a href="#AgentMemoryManager.get_all_memories-934"><span class="linenos">934</span></a>                <span class="c1"># Add topics if available</span>
</span><span id="AgentMemoryManager.get_all_memories-935"><a href="#AgentMemoryManager.get_all_memories-935"><span class="linenos">935</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;topics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_all_memories-936"><a href="#AgentMemoryManager.get_all_memories-936"><span class="linenos">936</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_all_memories-937"><a href="#AgentMemoryManager.get_all_memories-937"><span class="linenos">937</span></a>
</span><span id="AgentMemoryManager.get_all_memories-938"><a href="#AgentMemoryManager.get_all_memories-938"><span class="linenos">938</span></a>                <span class="c1"># Add timestamp if available</span>
</span><span id="AgentMemoryManager.get_all_memories-939"><a href="#AgentMemoryManager.get_all_memories-939"><span class="linenos">939</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_all_memories-940"><a href="#AgentMemoryManager.get_all_memories-940"><span class="linenos">940</span></a>                    <span class="c1"># Convert timestamp to readable format</span>
</span><span id="AgentMemoryManager.get_all_memories-941"><a href="#AgentMemoryManager.get_all_memories-941"><span class="linenos">941</span></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="AgentMemoryManager.get_all_memories-942"><a href="#AgentMemoryManager.get_all_memories-942"><span class="linenos">942</span></a>
</span><span id="AgentMemoryManager.get_all_memories-943"><a href="#AgentMemoryManager.get_all_memories-943"><span class="linenos">943</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_all_memories-944"><a href="#AgentMemoryManager.get_all_memories-944"><span class="linenos">944</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Created: </span><span class="si">{</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_all_memories-945"><a href="#AgentMemoryManager.get_all_memories-945"><span class="linenos">945</span></a>
</span><span id="AgentMemoryManager.get_all_memories-946"><a href="#AgentMemoryManager.get_all_memories-946"><span class="linenos">946</span></a>                <span class="c1"># Add memory ID for reference</span>
</span><span id="AgentMemoryManager.get_all_memories-947"><a href="#AgentMemoryManager.get_all_memories-947"><span class="linenos">947</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   ID: </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory_id</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_all_memories-948"><a href="#AgentMemoryManager.get_all_memories-948"><span class="linenos">948</span></a>
</span><span id="AgentMemoryManager.get_all_memories-949"><a href="#AgentMemoryManager.get_all_memories-949"><span class="linenos">949</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_all_memories-950"><a href="#AgentMemoryManager.get_all_memories-950"><span class="linenos">950</span></a>                <span class="s2">&quot;Retrieved all </span><span class="si">%d</span><span class="s2"> memories for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager.get_all_memories-951"><a href="#AgentMemoryManager.get_all_memories-951"><span class="linenos">951</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.get_all_memories-952"><a href="#AgentMemoryManager.get_all_memories-952"><span class="linenos">952</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager.get_all_memories-953"><a href="#AgentMemoryManager.get_all_memories-953"><span class="linenos">953</span></a>
</span><span id="AgentMemoryManager.get_all_memories-954"><a href="#AgentMemoryManager.get_all_memories-954"><span class="linenos">954</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_all_memories-955"><a href="#AgentMemoryManager.get_all_memories-955"><span class="linenos">955</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error retrieving all memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_all_memories-956"><a href="#AgentMemoryManager.get_all_memories-956"><span class="linenos">956</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error retrieving all memories: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Get all user memories.</p>

<p>Returns:
    str: Formatted string of all memories</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.get_memory_stats" class="classattr">
                                        <input id="AgentMemoryManager.get_memory_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">get_memory_stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.get_memory_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.get_memory_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.get_memory_stats-958"><a href="#AgentMemoryManager.get_memory_stats-958"><span class="linenos"> 958</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_stats-959"><a href="#AgentMemoryManager.get_memory_stats-959"><span class="linenos"> 959</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get memory statistics.</span>
</span><span id="AgentMemoryManager.get_memory_stats-960"><a href="#AgentMemoryManager.get_memory_stats-960"><span class="linenos"> 960</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-961"><a href="#AgentMemoryManager.get_memory_stats-961"><span class="linenos"> 961</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.get_memory_stats-962"><a href="#AgentMemoryManager.get_memory_stats-962"><span class="linenos"> 962</span></a><span class="sd">            str: Formatted string with memory statistics</span>
</span><span id="AgentMemoryManager.get_memory_stats-963"><a href="#AgentMemoryManager.get_memory_stats-963"><span class="linenos"> 963</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.get_memory_stats-964"><a href="#AgentMemoryManager.get_memory_stats-964"><span class="linenos"> 964</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_stats-965"><a href="#AgentMemoryManager.get_memory_stats-965"><span class="linenos"> 965</span></a>            <span class="c1"># Direct call to SemanticMemoryManager.get_all_memories()</span>
</span><span id="AgentMemoryManager.get_memory_stats-966"><a href="#AgentMemoryManager.get_memory_stats-966"><span class="linenos"> 966</span></a>            <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">get_all_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_memory_stats-967"><a href="#AgentMemoryManager.get_memory_stats-967"><span class="linenos"> 967</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager.get_memory_stats-968"><a href="#AgentMemoryManager.get_memory_stats-968"><span class="linenos"> 968</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_stats-969"><a href="#AgentMemoryManager.get_memory_stats-969"><span class="linenos"> 969</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-970"><a href="#AgentMemoryManager.get_memory_stats-970"><span class="linenos"> 970</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_stats-971"><a href="#AgentMemoryManager.get_memory_stats-971"><span class="linenos"> 971</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No memories found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_stats-972"><a href="#AgentMemoryManager.get_memory_stats-972"><span class="linenos"> 972</span></a>                <span class="k">return</span> <span class="s2">&quot; No memories found. Try storing some information first!&quot;</span>
</span><span id="AgentMemoryManager.get_memory_stats-973"><a href="#AgentMemoryManager.get_memory_stats-973"><span class="linenos"> 973</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-974"><a href="#AgentMemoryManager.get_memory_stats-974"><span class="linenos"> 974</span></a>            <span class="c1"># Calculate basic statistics</span>
</span><span id="AgentMemoryManager.get_memory_stats-975"><a href="#AgentMemoryManager.get_memory_stats-975"><span class="linenos"> 975</span></a>            <span class="n">total_memories</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_stats-976"><a href="#AgentMemoryManager.get_memory_stats-976"><span class="linenos"> 976</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-977"><a href="#AgentMemoryManager.get_memory_stats-977"><span class="linenos"> 977</span></a>            <span class="c1"># Get all unique topics</span>
</span><span id="AgentMemoryManager.get_memory_stats-978"><a href="#AgentMemoryManager.get_memory_stats-978"><span class="linenos"> 978</span></a>            <span class="n">all_topics</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AgentMemoryManager.get_memory_stats-979"><a href="#AgentMemoryManager.get_memory_stats-979"><span class="linenos"> 979</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_stats-980"><a href="#AgentMemoryManager.get_memory_stats-980"><span class="linenos"> 980</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;topics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_stats-981"><a href="#AgentMemoryManager.get_memory_stats-981"><span class="linenos"> 981</span></a>                    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_stats-982"><a href="#AgentMemoryManager.get_memory_stats-982"><span class="linenos"> 982</span></a>                        <span class="n">all_topics</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_topics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="AgentMemoryManager.get_memory_stats-983"><a href="#AgentMemoryManager.get_memory_stats-983"><span class="linenos"> 983</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-984"><a href="#AgentMemoryManager.get_memory_stats-984"><span class="linenos"> 984</span></a>            <span class="c1"># Sort topics by frequency (most common first)</span>
</span><span id="AgentMemoryManager.get_memory_stats-985"><a href="#AgentMemoryManager.get_memory_stats-985"><span class="linenos"> 985</span></a>            <span class="n">sorted_topics</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_topics</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_stats-986"><a href="#AgentMemoryManager.get_memory_stats-986"><span class="linenos"> 986</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-987"><a href="#AgentMemoryManager.get_memory_stats-987"><span class="linenos"> 987</span></a>            <span class="c1"># Calculate average memory length</span>
</span><span id="AgentMemoryManager.get_memory_stats-988"><a href="#AgentMemoryManager.get_memory_stats-988"><span class="linenos"> 988</span></a>            <span class="n">total_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_stats-989"><a href="#AgentMemoryManager.get_memory_stats-989"><span class="linenos"> 989</span></a>            <span class="n">avg_length</span> <span class="o">=</span> <span class="n">total_length</span> <span class="o">/</span> <span class="n">total_memories</span> <span class="k">if</span> <span class="n">total_memories</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="AgentMemoryManager.get_memory_stats-990"><a href="#AgentMemoryManager.get_memory_stats-990"><span class="linenos"> 990</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-991"><a href="#AgentMemoryManager.get_memory_stats-991"><span class="linenos"> 991</span></a>            <span class="c1"># Get oldest and newest memory timestamps</span>
</span><span id="AgentMemoryManager.get_memory_stats-992"><a href="#AgentMemoryManager.get_memory_stats-992"><span class="linenos"> 992</span></a>            <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager.get_memory_stats-993"><a href="#AgentMemoryManager.get_memory_stats-993"><span class="linenos"> 993</span></a>                <span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_stats-994"><a href="#AgentMemoryManager.get_memory_stats-994"><span class="linenos"> 994</span></a>            <span class="p">]</span>
</span><span id="AgentMemoryManager.get_memory_stats-995"><a href="#AgentMemoryManager.get_memory_stats-995"><span class="linenos"> 995</span></a>            <span class="n">oldest_timestamp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span> <span class="k">if</span> <span class="n">timestamps</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager.get_memory_stats-996"><a href="#AgentMemoryManager.get_memory_stats-996"><span class="linenos"> 996</span></a>            <span class="n">newest_timestamp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span> <span class="k">if</span> <span class="n">timestamps</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager.get_memory_stats-997"><a href="#AgentMemoryManager.get_memory_stats-997"><span class="linenos"> 997</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-998"><a href="#AgentMemoryManager.get_memory_stats-998"><span class="linenos"> 998</span></a>            <span class="c1"># Format results</span>
</span><span id="AgentMemoryManager.get_memory_stats-999"><a href="#AgentMemoryManager.get_memory_stats-999"><span class="linenos"> 999</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; MEMORY STATISTICS</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_stats-1000"><a href="#AgentMemoryManager.get_memory_stats-1000"><span class="linenos">1000</span></a>            <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Total memories: </span><span class="si">{</span><span class="n">total_memories</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_stats-1001"><a href="#AgentMemoryManager.get_memory_stats-1001"><span class="linenos">1001</span></a>            <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Average memory length: </span><span class="si">{</span><span class="n">avg_length</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> characters</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_stats-1002"><a href="#AgentMemoryManager.get_memory_stats-1002"><span class="linenos">1002</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-1003"><a href="#AgentMemoryManager.get_memory_stats-1003"><span class="linenos">1003</span></a>            <span class="k">if</span> <span class="n">oldest_timestamp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_stats-1004"><a href="#AgentMemoryManager.get_memory_stats-1004"><span class="linenos">1004</span></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="AgentMemoryManager.get_memory_stats-1005"><a href="#AgentMemoryManager.get_memory_stats-1005"><span class="linenos">1005</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-1006"><a href="#AgentMemoryManager.get_memory_stats-1006"><span class="linenos">1006</span></a>                <span class="n">oldest_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">oldest_timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_memory_stats-1007"><a href="#AgentMemoryManager.get_memory_stats-1007"><span class="linenos">1007</span></a>                    <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span>
</span><span id="AgentMemoryManager.get_memory_stats-1008"><a href="#AgentMemoryManager.get_memory_stats-1008"><span class="linenos">1008</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_stats-1009"><a href="#AgentMemoryManager.get_memory_stats-1009"><span class="linenos">1009</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Oldest memory: </span><span class="si">{</span><span class="n">oldest_date</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_stats-1010"><a href="#AgentMemoryManager.get_memory_stats-1010"><span class="linenos">1010</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-1011"><a href="#AgentMemoryManager.get_memory_stats-1011"><span class="linenos">1011</span></a>            <span class="k">if</span> <span class="n">newest_timestamp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_stats-1012"><a href="#AgentMemoryManager.get_memory_stats-1012"><span class="linenos">1012</span></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="AgentMemoryManager.get_memory_stats-1013"><a href="#AgentMemoryManager.get_memory_stats-1013"><span class="linenos">1013</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-1014"><a href="#AgentMemoryManager.get_memory_stats-1014"><span class="linenos">1014</span></a>                <span class="n">newest_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">newest_timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_memory_stats-1015"><a href="#AgentMemoryManager.get_memory_stats-1015"><span class="linenos">1015</span></a>                    <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span>
</span><span id="AgentMemoryManager.get_memory_stats-1016"><a href="#AgentMemoryManager.get_memory_stats-1016"><span class="linenos">1016</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_stats-1017"><a href="#AgentMemoryManager.get_memory_stats-1017"><span class="linenos">1017</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Newest memory: </span><span class="si">{</span><span class="n">newest_date</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_stats-1018"><a href="#AgentMemoryManager.get_memory_stats-1018"><span class="linenos">1018</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-1019"><a href="#AgentMemoryManager.get_memory_stats-1019"><span class="linenos">1019</span></a>            <span class="k">if</span> <span class="n">sorted_topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_stats-1020"><a href="#AgentMemoryManager.get_memory_stats-1020"><span class="linenos">1020</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top topics:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_stats-1021"><a href="#AgentMemoryManager.get_memory_stats-1021"><span class="linenos">1021</span></a>                <span class="c1"># Show top 10 topics</span>
</span><span id="AgentMemoryManager.get_memory_stats-1022"><a href="#AgentMemoryManager.get_memory_stats-1022"><span class="linenos">1022</span></a>                <span class="k">for</span> <span class="n">topic</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">sorted_topics</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>
</span><span id="AgentMemoryManager.get_memory_stats-1023"><a href="#AgentMemoryManager.get_memory_stats-1023"><span class="linenos">1023</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> memories</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_stats-1024"><a href="#AgentMemoryManager.get_memory_stats-1024"><span class="linenos">1024</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-1025"><a href="#AgentMemoryManager.get_memory_stats-1025"><span class="linenos">1025</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_topics</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_stats-1026"><a href="#AgentMemoryManager.get_memory_stats-1026"><span class="linenos">1026</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_topics</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2"> more topics</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_stats-1027"><a href="#AgentMemoryManager.get_memory_stats-1027"><span class="linenos">1027</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-1028"><a href="#AgentMemoryManager.get_memory_stats-1028"><span class="linenos">1028</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generated memory statistics for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_stats-1029"><a href="#AgentMemoryManager.get_memory_stats-1029"><span class="linenos">1029</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager.get_memory_stats-1030"><a href="#AgentMemoryManager.get_memory_stats-1030"><span class="linenos">1030</span></a>
</span><span id="AgentMemoryManager.get_memory_stats-1031"><a href="#AgentMemoryManager.get_memory_stats-1031"><span class="linenos">1031</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_stats-1032"><a href="#AgentMemoryManager.get_memory_stats-1032"><span class="linenos">1032</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error retrieving memory statistics: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_stats-1033"><a href="#AgentMemoryManager.get_memory_stats-1033"><span class="linenos">1033</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error retrieving memory statistics: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Get memory statistics.</p>

<p>Returns:
    str: Formatted string with memory statistics</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.get_memories_by_topic" class="classattr">
                                        <input id="AgentMemoryManager.get_memories_by_topic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">get_memories_by_topic</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.get_memories_by_topic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.get_memories_by_topic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.get_memories_by_topic-1035"><a href="#AgentMemoryManager.get_memories_by_topic-1035"><span class="linenos">1035</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_memories_by_topic</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1036"><a href="#AgentMemoryManager.get_memories_by_topic-1036"><span class="linenos">1036</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1037"><a href="#AgentMemoryManager.get_memories_by_topic-1037"><span class="linenos">1037</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1038"><a href="#AgentMemoryManager.get_memories_by_topic-1038"><span class="linenos">1038</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get memories by topic without similarity search.</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1039"><a href="#AgentMemoryManager.get_memories_by_topic-1039"><span class="linenos">1039</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1040"><a href="#AgentMemoryManager.get_memories_by_topic-1040"><span class="linenos">1040</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1041"><a href="#AgentMemoryManager.get_memories_by_topic-1041"><span class="linenos">1041</span></a><span class="sd">            topics: Topic or list of topics to filter memories by</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1042"><a href="#AgentMemoryManager.get_memories_by_topic-1042"><span class="linenos">1042</span></a><span class="sd">            limit: Maximum number of memories to return</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1043"><a href="#AgentMemoryManager.get_memories_by_topic-1043"><span class="linenos">1043</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1044"><a href="#AgentMemoryManager.get_memories_by_topic-1044"><span class="linenos">1044</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1045"><a href="#AgentMemoryManager.get_memories_by_topic-1045"><span class="linenos">1045</span></a><span class="sd">            str: Formatted string of memories matching the topics</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1046"><a href="#AgentMemoryManager.get_memories_by_topic-1046"><span class="linenos">1046</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1047"><a href="#AgentMemoryManager.get_memories_by_topic-1047"><span class="linenos">1047</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1048"><a href="#AgentMemoryManager.get_memories_by_topic-1048"><span class="linenos">1048</span></a>            <span class="c1"># Validate topics parameter</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1049"><a href="#AgentMemoryManager.get_memories_by_topic-1049"><span class="linenos">1049</span></a>            <span class="k">if</span> <span class="n">topics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1050"><a href="#AgentMemoryManager.get_memories_by_topic-1050"><span class="linenos">1050</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No topics provided to get_memories_by_topic&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1051"><a href="#AgentMemoryManager.get_memories_by_topic-1051"><span class="linenos">1051</span></a>                <span class="k">return</span> <span class="p">(</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1052"><a href="#AgentMemoryManager.get_memories_by_topic-1052"><span class="linenos">1052</span></a>                    <span class="s2">&quot; Error: No topics provided. Please specify at least one topic.&quot;</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1053"><a href="#AgentMemoryManager.get_memories_by_topic-1053"><span class="linenos">1053</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1054"><a href="#AgentMemoryManager.get_memories_by_topic-1054"><span class="linenos">1054</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1055"><a href="#AgentMemoryManager.get_memories_by_topic-1055"><span class="linenos">1055</span></a>            <span class="c1"># Parse topics parameter</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1056"><a href="#AgentMemoryManager.get_memories_by_topic-1056"><span class="linenos">1056</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1057"><a href="#AgentMemoryManager.get_memories_by_topic-1057"><span class="linenos">1057</span></a>                <span class="c1"># Convert string to list, handle comma-separated values</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1058"><a href="#AgentMemoryManager.get_memories_by_topic-1058"><span class="linenos">1058</span></a>                <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1059"><a href="#AgentMemoryManager.get_memories_by_topic-1059"><span class="linenos">1059</span></a>                    <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1060"><a href="#AgentMemoryManager.get_memories_by_topic-1060"><span class="linenos">1060</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1061"><a href="#AgentMemoryManager.get_memories_by_topic-1061"><span class="linenos">1061</span></a>                    <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">if</span> <span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1062"><a href="#AgentMemoryManager.get_memories_by_topic-1062"><span class="linenos">1062</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1063"><a href="#AgentMemoryManager.get_memories_by_topic-1063"><span class="linenos">1063</span></a>                <span class="c1"># Clean up list - remove empty entries</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1064"><a href="#AgentMemoryManager.get_memories_by_topic-1064"><span class="linenos">1064</span></a>                <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1065"><a href="#AgentMemoryManager.get_memories_by_topic-1065"><span class="linenos">1065</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1066"><a href="#AgentMemoryManager.get_memories_by_topic-1066"><span class="linenos">1066</span></a>                <span class="c1"># Convert anything else to string and put in list</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1067"><a href="#AgentMemoryManager.get_memories_by_topic-1067"><span class="linenos">1067</span></a>                <span class="n">topic_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1068"><a href="#AgentMemoryManager.get_memories_by_topic-1068"><span class="linenos">1068</span></a>                <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">topic_str</span><span class="p">]</span> <span class="k">if</span> <span class="n">topic_str</span> <span class="ow">and</span> <span class="n">topic_str</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1069"><a href="#AgentMemoryManager.get_memories_by_topic-1069"><span class="linenos">1069</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1070"><a href="#AgentMemoryManager.get_memories_by_topic-1070"><span class="linenos">1070</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">topic_list</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1071"><a href="#AgentMemoryManager.get_memories_by_topic-1071"><span class="linenos">1071</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid topics provided after parsing&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1072"><a href="#AgentMemoryManager.get_memories_by_topic-1072"><span class="linenos">1072</span></a>                <span class="k">return</span> <span class="s2">&quot; Error: No valid topics provided. Please specify at least one topic.&quot;</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1073"><a href="#AgentMemoryManager.get_memories_by_topic-1073"><span class="linenos">1073</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1074"><a href="#AgentMemoryManager.get_memories_by_topic-1074"><span class="linenos">1074</span></a>            <span class="c1"># Get all memories first</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1075"><a href="#AgentMemoryManager.get_memories_by_topic-1075"><span class="linenos">1075</span></a>            <span class="n">all_memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">get_all_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1076"><a href="#AgentMemoryManager.get_memories_by_topic-1076"><span class="linenos">1076</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1077"><a href="#AgentMemoryManager.get_memories_by_topic-1077"><span class="linenos">1077</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1078"><a href="#AgentMemoryManager.get_memories_by_topic-1078"><span class="linenos">1078</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1079"><a href="#AgentMemoryManager.get_memories_by_topic-1079"><span class="linenos">1079</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">all_memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1080"><a href="#AgentMemoryManager.get_memories_by_topic-1080"><span class="linenos">1080</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No memories found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1081"><a href="#AgentMemoryManager.get_memories_by_topic-1081"><span class="linenos">1081</span></a>                <span class="k">return</span> <span class="s2">&quot; No memories found. Try storing some information first!&quot;</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1082"><a href="#AgentMemoryManager.get_memories_by_topic-1082"><span class="linenos">1082</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1083"><a href="#AgentMemoryManager.get_memories_by_topic-1083"><span class="linenos">1083</span></a>            <span class="c1"># Filter memories by topic</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1084"><a href="#AgentMemoryManager.get_memories_by_topic-1084"><span class="linenos">1084</span></a>            <span class="n">filtered_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1085"><a href="#AgentMemoryManager.get_memories_by_topic-1085"><span class="linenos">1085</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">all_memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1086"><a href="#AgentMemoryManager.get_memories_by_topic-1086"><span class="linenos">1086</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;topics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1087"><a href="#AgentMemoryManager.get_memories_by_topic-1087"><span class="linenos">1087</span></a>                    <span class="c1"># Check if any of the requested topics match this memory&#39;s topics</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1088"><a href="#AgentMemoryManager.get_memories_by_topic-1088"><span class="linenos">1088</span></a>                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1089"><a href="#AgentMemoryManager.get_memories_by_topic-1089"><span class="linenos">1089</span></a>                        <span class="n">topic</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">]</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1090"><a href="#AgentMemoryManager.get_memories_by_topic-1090"><span class="linenos">1090</span></a>                        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">topic_list</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1091"><a href="#AgentMemoryManager.get_memories_by_topic-1091"><span class="linenos">1091</span></a>                    <span class="p">):</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1092"><a href="#AgentMemoryManager.get_memories_by_topic-1092"><span class="linenos">1092</span></a>                        <span class="n">filtered_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1093"><a href="#AgentMemoryManager.get_memories_by_topic-1093"><span class="linenos">1093</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1094"><a href="#AgentMemoryManager.get_memories_by_topic-1094"><span class="linenos">1094</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1095"><a href="#AgentMemoryManager.get_memories_by_topic-1095"><span class="linenos">1095</span></a>                <span class="n">topics_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topic_list</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1096"><a href="#AgentMemoryManager.get_memories_by_topic-1096"><span class="linenos">1096</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No memories found for topics: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">topics_str</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1097"><a href="#AgentMemoryManager.get_memories_by_topic-1097"><span class="linenos">1097</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; No memories found for topics: </span><span class="si">{</span><span class="n">topics_str</span><span class="si">}</span><span class="s2">. Try different topics or store new memories with these topics.&quot;</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1098"><a href="#AgentMemoryManager.get_memories_by_topic-1098"><span class="linenos">1098</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1099"><a href="#AgentMemoryManager.get_memories_by_topic-1099"><span class="linenos">1099</span></a>            <span class="c1"># Sort memories by timestamp (newest first)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1100"><a href="#AgentMemoryManager.get_memories_by_topic-1100"><span class="linenos">1100</span></a>            <span class="n">sorted_memories</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1101"><a href="#AgentMemoryManager.get_memories_by_topic-1101"><span class="linenos">1101</span></a>                <span class="n">filtered_memories</span><span class="p">,</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1102"><a href="#AgentMemoryManager.get_memories_by_topic-1102"><span class="linenos">1102</span></a>                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1103"><a href="#AgentMemoryManager.get_memories_by_topic-1103"><span class="linenos">1103</span></a>                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1104"><a href="#AgentMemoryManager.get_memories_by_topic-1104"><span class="linenos">1104</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1105"><a href="#AgentMemoryManager.get_memories_by_topic-1105"><span class="linenos">1105</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1106"><a href="#AgentMemoryManager.get_memories_by_topic-1106"><span class="linenos">1106</span></a>            <span class="c1"># Limit the number of memories if specified</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1107"><a href="#AgentMemoryManager.get_memories_by_topic-1107"><span class="linenos">1107</span></a>            <span class="n">display_memories</span> <span class="o">=</span> <span class="n">sorted_memories</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">sorted_memories</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1108"><a href="#AgentMemoryManager.get_memories_by_topic-1108"><span class="linenos">1108</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1109"><a href="#AgentMemoryManager.get_memories_by_topic-1109"><span class="linenos">1109</span></a>            <span class="c1"># Format results</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1110"><a href="#AgentMemoryManager.get_memories_by_topic-1110"><span class="linenos">1110</span></a>            <span class="n">topics_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topic_list</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1111"><a href="#AgentMemoryManager.get_memories_by_topic-1111"><span class="linenos">1111</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; MEMORIES BY TOPIC: </span><span class="si">{</span><span class="n">topics_str</span><span class="si">}</span><span class="s2"> (showing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">display_memories</span><span class="p">)</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_memories</span><span class="p">)</span><span class="si">}</span><span class="s2"> matching memories)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1112"><a href="#AgentMemoryManager.get_memories_by_topic-1112"><span class="linenos">1112</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1113"><a href="#AgentMemoryManager.get_memories_by_topic-1113"><span class="linenos">1113</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">memory</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">display_memories</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1114"><a href="#AgentMemoryManager.get_memories_by_topic-1114"><span class="linenos">1114</span></a>                <span class="c1"># Format the memory content</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1115"><a href="#AgentMemoryManager.get_memories_by_topic-1115"><span class="linenos">1115</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1116"><a href="#AgentMemoryManager.get_memories_by_topic-1116"><span class="linenos">1116</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1117"><a href="#AgentMemoryManager.get_memories_by_topic-1117"><span class="linenos">1117</span></a>                <span class="c1"># Add topics if available</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1118"><a href="#AgentMemoryManager.get_memories_by_topic-1118"><span class="linenos">1118</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;topics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1119"><a href="#AgentMemoryManager.get_memories_by_topic-1119"><span class="linenos">1119</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1120"><a href="#AgentMemoryManager.get_memories_by_topic-1120"><span class="linenos">1120</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1121"><a href="#AgentMemoryManager.get_memories_by_topic-1121"><span class="linenos">1121</span></a>                <span class="c1"># Add timestamp if available</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1122"><a href="#AgentMemoryManager.get_memories_by_topic-1122"><span class="linenos">1122</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1123"><a href="#AgentMemoryManager.get_memories_by_topic-1123"><span class="linenos">1123</span></a>                    <span class="c1"># Convert timestamp to readable format</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1124"><a href="#AgentMemoryManager.get_memories_by_topic-1124"><span class="linenos">1124</span></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1125"><a href="#AgentMemoryManager.get_memories_by_topic-1125"><span class="linenos">1125</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1126"><a href="#AgentMemoryManager.get_memories_by_topic-1126"><span class="linenos">1126</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1127"><a href="#AgentMemoryManager.get_memories_by_topic-1127"><span class="linenos">1127</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Created: </span><span class="si">{</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1128"><a href="#AgentMemoryManager.get_memories_by_topic-1128"><span class="linenos">1128</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1129"><a href="#AgentMemoryManager.get_memories_by_topic-1129"><span class="linenos">1129</span></a>                <span class="c1"># Add memory ID for reference</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1130"><a href="#AgentMemoryManager.get_memories_by_topic-1130"><span class="linenos">1130</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   ID: </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory_id</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1131"><a href="#AgentMemoryManager.get_memories_by_topic-1131"><span class="linenos">1131</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1132"><a href="#AgentMemoryManager.get_memories_by_topic-1132"><span class="linenos">1132</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1133"><a href="#AgentMemoryManager.get_memories_by_topic-1133"><span class="linenos">1133</span></a>                <span class="s2">&quot;Retrieved </span><span class="si">%d</span><span class="s2"> memories for topics </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_memories</span><span class="p">),</span> <span class="n">topics_str</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1134"><a href="#AgentMemoryManager.get_memories_by_topic-1134"><span class="linenos">1134</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1135"><a href="#AgentMemoryManager.get_memories_by_topic-1135"><span class="linenos">1135</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1136"><a href="#AgentMemoryManager.get_memories_by_topic-1136"><span class="linenos">1136</span></a>
</span><span id="AgentMemoryManager.get_memories_by_topic-1137"><a href="#AgentMemoryManager.get_memories_by_topic-1137"><span class="linenos">1137</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1138"><a href="#AgentMemoryManager.get_memories_by_topic-1138"><span class="linenos">1138</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error retrieving memories by topic: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memories_by_topic-1139"><a href="#AgentMemoryManager.get_memories_by_topic-1139"><span class="linenos">1139</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error retrieving memories by topic: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Get memories by topic without similarity search.</p>

<p>Args:
    topics: Topic or list of topics to filter memories by
    limit: Maximum number of memories to return</p>

<p>Returns:
    str: Formatted string of memories matching the topics</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.list_memories" class="classattr">
                                        <input id="AgentMemoryManager.list_memories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">list_memories</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.list_memories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.list_memories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.list_memories-1141"><a href="#AgentMemoryManager.list_memories-1141"><span class="linenos">1141</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.list_memories-1142"><a href="#AgentMemoryManager.list_memories-1142"><span class="linenos">1142</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;List all memories in a simple, user-friendly format.</span>
</span><span id="AgentMemoryManager.list_memories-1143"><a href="#AgentMemoryManager.list_memories-1143"><span class="linenos">1143</span></a>
</span><span id="AgentMemoryManager.list_memories-1144"><a href="#AgentMemoryManager.list_memories-1144"><span class="linenos">1144</span></a><span class="sd">        This method provides a more concise view of all memories compared to get_all_memories,</span>
</span><span id="AgentMemoryManager.list_memories-1145"><a href="#AgentMemoryManager.list_memories-1145"><span class="linenos">1145</span></a><span class="sd">        focusing on just the content and topics without additional metadata.</span>
</span><span id="AgentMemoryManager.list_memories-1146"><a href="#AgentMemoryManager.list_memories-1146"><span class="linenos">1146</span></a><span class="sd">        </span>
</span><span id="AgentMemoryManager.list_memories-1147"><a href="#AgentMemoryManager.list_memories-1147"><span class="linenos">1147</span></a><span class="sd">        PERFORMANCE OPTIMIZED: Returns raw memory data without interpretation instructions</span>
</span><span id="AgentMemoryManager.list_memories-1148"><a href="#AgentMemoryManager.list_memories-1148"><span class="linenos">1148</span></a><span class="sd">        to avoid unnecessary LLM inference when user requests simple listing.</span>
</span><span id="AgentMemoryManager.list_memories-1149"><a href="#AgentMemoryManager.list_memories-1149"><span class="linenos">1149</span></a>
</span><span id="AgentMemoryManager.list_memories-1150"><a href="#AgentMemoryManager.list_memories-1150"><span class="linenos">1150</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.list_memories-1151"><a href="#AgentMemoryManager.list_memories-1151"><span class="linenos">1151</span></a><span class="sd">            str: Simplified list of all memories without interpretation instructions</span>
</span><span id="AgentMemoryManager.list_memories-1152"><a href="#AgentMemoryManager.list_memories-1152"><span class="linenos">1152</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.list_memories-1153"><a href="#AgentMemoryManager.list_memories-1153"><span class="linenos">1153</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.list_memories-1154"><a href="#AgentMemoryManager.list_memories-1154"><span class="linenos">1154</span></a>            <span class="c1"># Direct call to SemanticMemoryManager.get_all_memories()</span>
</span><span id="AgentMemoryManager.list_memories-1155"><a href="#AgentMemoryManager.list_memories-1155"><span class="linenos">1155</span></a>            <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">get_all_memories</span><span class="p">(</span>
</span><span id="AgentMemoryManager.list_memories-1156"><a href="#AgentMemoryManager.list_memories-1156"><span class="linenos">1156</span></a>                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager.list_memories-1157"><a href="#AgentMemoryManager.list_memories-1157"><span class="linenos">1157</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.list_memories-1158"><a href="#AgentMemoryManager.list_memories-1158"><span class="linenos">1158</span></a>
</span><span id="AgentMemoryManager.list_memories-1159"><a href="#AgentMemoryManager.list_memories-1159"><span class="linenos">1159</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AgentMemoryManager.list_memories-1160"><a href="#AgentMemoryManager.list_memories-1160"><span class="linenos">1160</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No memories found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager.list_memories-1161"><a href="#AgentMemoryManager.list_memories-1161"><span class="linenos">1161</span></a>                <span class="k">return</span> <span class="s2">&quot; No memories found. Try storing some information first!&quot;</span>
</span><span id="AgentMemoryManager.list_memories-1162"><a href="#AgentMemoryManager.list_memories-1162"><span class="linenos">1162</span></a>
</span><span id="AgentMemoryManager.list_memories-1163"><a href="#AgentMemoryManager.list_memories-1163"><span class="linenos">1163</span></a>            <span class="c1"># Sort memories by timestamp (newest first)</span>
</span><span id="AgentMemoryManager.list_memories-1164"><a href="#AgentMemoryManager.list_memories-1164"><span class="linenos">1164</span></a>            <span class="n">sorted_memories</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="AgentMemoryManager.list_memories-1165"><a href="#AgentMemoryManager.list_memories-1165"><span class="linenos">1165</span></a>                <span class="n">memories</span><span class="p">,</span>
</span><span id="AgentMemoryManager.list_memories-1166"><a href="#AgentMemoryManager.list_memories-1166"><span class="linenos">1166</span></a>                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="AgentMemoryManager.list_memories-1167"><a href="#AgentMemoryManager.list_memories-1167"><span class="linenos">1167</span></a>                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AgentMemoryManager.list_memories-1168"><a href="#AgentMemoryManager.list_memories-1168"><span class="linenos">1168</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.list_memories-1169"><a href="#AgentMemoryManager.list_memories-1169"><span class="linenos">1169</span></a>
</span><span id="AgentMemoryManager.list_memories-1170"><a href="#AgentMemoryManager.list_memories-1170"><span class="linenos">1170</span></a>            <span class="c1"># Format results in a simplified way - NO INTERPRETATION INSTRUCTIONS</span>
</span><span id="AgentMemoryManager.list_memories-1171"><a href="#AgentMemoryManager.list_memories-1171"><span class="linenos">1171</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; MEMORY LIST (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span><span class="si">}</span><span class="s2"> total):</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.list_memories-1172"><a href="#AgentMemoryManager.list_memories-1172"><span class="linenos">1172</span></a>
</span><span id="AgentMemoryManager.list_memories-1173"><a href="#AgentMemoryManager.list_memories-1173"><span class="linenos">1173</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">memory</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_memories</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AgentMemoryManager.list_memories-1174"><a href="#AgentMemoryManager.list_memories-1174"><span class="linenos">1174</span></a>                <span class="c1"># Just show the memory content and topics, omit other metadata</span>
</span><span id="AgentMemoryManager.list_memories-1175"><a href="#AgentMemoryManager.list_memories-1175"><span class="linenos">1175</span></a>                <span class="n">memory_preview</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager.list_memories-1176"><a href="#AgentMemoryManager.list_memories-1176"><span class="linenos">1176</span></a>                    <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
</span><span id="AgentMemoryManager.list_memories-1177"><a href="#AgentMemoryManager.list_memories-1177"><span class="linenos">1177</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span>
</span><span id="AgentMemoryManager.list_memories-1178"><a href="#AgentMemoryManager.list_memories-1178"><span class="linenos">1178</span></a>                    <span class="k">else</span> <span class="n">memory</span><span class="o">.</span><span class="n">memory</span>
</span><span id="AgentMemoryManager.list_memories-1179"><a href="#AgentMemoryManager.list_memories-1179"><span class="linenos">1179</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.list_memories-1180"><a href="#AgentMemoryManager.list_memories-1180"><span class="linenos">1180</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">memory_preview</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.list_memories-1181"><a href="#AgentMemoryManager.list_memories-1181"><span class="linenos">1181</span></a>
</span><span id="AgentMemoryManager.list_memories-1182"><a href="#AgentMemoryManager.list_memories-1182"><span class="linenos">1182</span></a>                <span class="c1"># Add topics if available</span>
</span><span id="AgentMemoryManager.list_memories-1183"><a href="#AgentMemoryManager.list_memories-1183"><span class="linenos">1183</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;topics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.list_memories-1184"><a href="#AgentMemoryManager.list_memories-1184"><span class="linenos">1184</span></a>                    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.list_memories-1185"><a href="#AgentMemoryManager.list_memories-1185"><span class="linenos">1185</span></a>
</span><span id="AgentMemoryManager.list_memories-1186"><a href="#AgentMemoryManager.list_memories-1186"><span class="linenos">1186</span></a>                <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.list_memories-1187"><a href="#AgentMemoryManager.list_memories-1187"><span class="linenos">1187</span></a>
</span><span id="AgentMemoryManager.list_memories-1188"><a href="#AgentMemoryManager.list_memories-1188"><span class="linenos">1188</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.list_memories-1189"><a href="#AgentMemoryManager.list_memories-1189"><span class="linenos">1189</span></a>                <span class="s2">&quot;Listed all </span><span class="si">%d</span><span class="s2"> memories for user </span><span class="si">%s</span><span class="s2"> in simplified format (performance optimized)&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.list_memories-1190"><a href="#AgentMemoryManager.list_memories-1190"><span class="linenos">1190</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">),</span>
</span><span id="AgentMemoryManager.list_memories-1191"><a href="#AgentMemoryManager.list_memories-1191"><span class="linenos">1191</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="AgentMemoryManager.list_memories-1192"><a href="#AgentMemoryManager.list_memories-1192"><span class="linenos">1192</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.list_memories-1193"><a href="#AgentMemoryManager.list_memories-1193"><span class="linenos">1193</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager.list_memories-1194"><a href="#AgentMemoryManager.list_memories-1194"><span class="linenos">1194</span></a>
</span><span id="AgentMemoryManager.list_memories-1195"><a href="#AgentMemoryManager.list_memories-1195"><span class="linenos">1195</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.list_memories-1196"><a href="#AgentMemoryManager.list_memories-1196"><span class="linenos">1196</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error listing memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.list_memories-1197"><a href="#AgentMemoryManager.list_memories-1197"><span class="linenos">1197</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error listing memories: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>List all memories in a simple, user-friendly format.</p>

<p>This method provides a more concise view of all memories compared to get_all_memories,
focusing on just the content and topics without additional metadata.</p>

<p>PERFORMANCE OPTIMIZED: Returns raw memory data without interpretation instructions
to avoid unnecessary LLM inference when user requests simple listing.</p>

<p>Returns:
    str: Simplified list of all memories without interpretation instructions</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.store_graph_memory" class="classattr">
                                        <input id="AgentMemoryManager.store_graph_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">store_graph_memory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">content</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.store_graph_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.store_graph_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.store_graph_memory-1199"><a href="#AgentMemoryManager.store_graph_memory-1199"><span class="linenos">1199</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">store_graph_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_graph_memory-1200"><a href="#AgentMemoryManager.store_graph_memory-1200"><span class="linenos">1200</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_graph_memory-1201"><a href="#AgentMemoryManager.store_graph_memory-1201"><span class="linenos">1201</span></a>        <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_graph_memory-1202"><a href="#AgentMemoryManager.store_graph_memory-1202"><span class="linenos">1202</span></a>        <span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_graph_memory-1203"><a href="#AgentMemoryManager.store_graph_memory-1203"><span class="linenos">1203</span></a>        <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_graph_memory-1204"><a href="#AgentMemoryManager.store_graph_memory-1204"><span class="linenos">1204</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1205"><a href="#AgentMemoryManager.store_graph_memory-1205"><span class="linenos">1205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Store a memory in the LightRAG graph database to capture relationships.</span>
</span><span id="AgentMemoryManager.store_graph_memory-1206"><a href="#AgentMemoryManager.store_graph_memory-1206"><span class="linenos">1206</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1207"><a href="#AgentMemoryManager.store_graph_memory-1207"><span class="linenos">1207</span></a><span class="sd">        This method creates a text file with the memory content and uploads it to the LightRAG</span>
</span><span id="AgentMemoryManager.store_graph_memory-1208"><a href="#AgentMemoryManager.store_graph_memory-1208"><span class="linenos">1208</span></a><span class="sd">        memory server, which then processes it to extract entities and relationships.</span>
</span><span id="AgentMemoryManager.store_graph_memory-1209"><a href="#AgentMemoryManager.store_graph_memory-1209"><span class="linenos">1209</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1210"><a href="#AgentMemoryManager.store_graph_memory-1210"><span class="linenos">1210</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1211"><a href="#AgentMemoryManager.store_graph_memory-1211"><span class="linenos">1211</span></a><span class="sd">            content: The memory content to store</span>
</span><span id="AgentMemoryManager.store_graph_memory-1212"><a href="#AgentMemoryManager.store_graph_memory-1212"><span class="linenos">1212</span></a><span class="sd">            topics: Optional list of topics/categories for the memory</span>
</span><span id="AgentMemoryManager.store_graph_memory-1213"><a href="#AgentMemoryManager.store_graph_memory-1213"><span class="linenos">1213</span></a><span class="sd">            memory_id: Optional memory ID to link with the SQLite memory</span>
</span><span id="AgentMemoryManager.store_graph_memory-1214"><a href="#AgentMemoryManager.store_graph_memory-1214"><span class="linenos">1214</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1215"><a href="#AgentMemoryManager.store_graph_memory-1215"><span class="linenos">1215</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1216"><a href="#AgentMemoryManager.store_graph_memory-1216"><span class="linenos">1216</span></a><span class="sd">            str: Success or error message</span>
</span><span id="AgentMemoryManager.store_graph_memory-1217"><a href="#AgentMemoryManager.store_graph_memory-1217"><span class="linenos">1217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.store_graph_memory-1218"><a href="#AgentMemoryManager.store_graph_memory-1218"><span class="linenos">1218</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1219"><a href="#AgentMemoryManager.store_graph_memory-1219"><span class="linenos">1219</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1220"><a href="#AgentMemoryManager.store_graph_memory-1220"><span class="linenos">1220</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LightRAG memory URL not configured&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.store_graph_memory-1221"><a href="#AgentMemoryManager.store_graph_memory-1221"><span class="linenos">1221</span></a>                <span class="k">return</span> <span class="s2">&quot; Graph memory not configured. Memory not stored in graph database.&quot;</span>
</span><span id="AgentMemoryManager.store_graph_memory-1222"><a href="#AgentMemoryManager.store_graph_memory-1222"><span class="linenos">1222</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1223"><a href="#AgentMemoryManager.store_graph_memory-1223"><span class="linenos">1223</span></a>            <span class="c1"># Validate content</span>
</span><span id="AgentMemoryManager.store_graph_memory-1224"><a href="#AgentMemoryManager.store_graph_memory-1224"><span class="linenos">1224</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="AgentMemoryManager.store_graph_memory-1225"><a href="#AgentMemoryManager.store_graph_memory-1225"><span class="linenos">1225</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Empty content provided to store_graph_memory&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.store_graph_memory-1226"><a href="#AgentMemoryManager.store_graph_memory-1226"><span class="linenos">1226</span></a>                <span class="k">return</span> <span class="s2">&quot; Error: Content cannot be empty.&quot;</span>
</span><span id="AgentMemoryManager.store_graph_memory-1227"><a href="#AgentMemoryManager.store_graph_memory-1227"><span class="linenos">1227</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1228"><a href="#AgentMemoryManager.store_graph_memory-1228"><span class="linenos">1228</span></a>            <span class="c1"># Parse topics parameter</span>
</span><span id="AgentMemoryManager.store_graph_memory-1229"><a href="#AgentMemoryManager.store_graph_memory-1229"><span class="linenos">1229</span></a>            <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.store_graph_memory-1230"><a href="#AgentMemoryManager.store_graph_memory-1230"><span class="linenos">1230</span></a>            <span class="k">if</span> <span class="n">topics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1231"><a href="#AgentMemoryManager.store_graph_memory-1231"><span class="linenos">1231</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AgentMemoryManager.store_graph_memory-1232"><a href="#AgentMemoryManager.store_graph_memory-1232"><span class="linenos">1232</span></a>                    <span class="c1"># Convert string to list, handle comma-separated values</span>
</span><span id="AgentMemoryManager.store_graph_memory-1233"><a href="#AgentMemoryManager.store_graph_memory-1233"><span class="linenos">1233</span></a>                    <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1234"><a href="#AgentMemoryManager.store_graph_memory-1234"><span class="linenos">1234</span></a>                        <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager.store_graph_memory-1235"><a href="#AgentMemoryManager.store_graph_memory-1235"><span class="linenos">1235</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1236"><a href="#AgentMemoryManager.store_graph_memory-1236"><span class="linenos">1236</span></a>                        <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">if</span> <span class="n">topics</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.store_graph_memory-1237"><a href="#AgentMemoryManager.store_graph_memory-1237"><span class="linenos">1237</span></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager.store_graph_memory-1238"><a href="#AgentMemoryManager.store_graph_memory-1238"><span class="linenos">1238</span></a>                    <span class="c1"># Clean up list - remove empty entries</span>
</span><span id="AgentMemoryManager.store_graph_memory-1239"><a href="#AgentMemoryManager.store_graph_memory-1239"><span class="linenos">1239</span></a>                    <span class="n">topic_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="AgentMemoryManager.store_graph_memory-1240"><a href="#AgentMemoryManager.store_graph_memory-1240"><span class="linenos">1240</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1241"><a href="#AgentMemoryManager.store_graph_memory-1241"><span class="linenos">1241</span></a>                    <span class="c1"># Convert anything else to string and put in list</span>
</span><span id="AgentMemoryManager.store_graph_memory-1242"><a href="#AgentMemoryManager.store_graph_memory-1242"><span class="linenos">1242</span></a>                    <span class="n">topic_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AgentMemoryManager.store_graph_memory-1243"><a href="#AgentMemoryManager.store_graph_memory-1243"><span class="linenos">1243</span></a>                    <span class="n">topic_list</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AgentMemoryManager.store_graph_memory-1244"><a href="#AgentMemoryManager.store_graph_memory-1244"><span class="linenos">1244</span></a>                        <span class="p">[</span><span class="n">topic_str</span><span class="p">]</span> <span class="k">if</span> <span class="n">topic_str</span> <span class="ow">and</span> <span class="n">topic_str</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.store_graph_memory-1245"><a href="#AgentMemoryManager.store_graph_memory-1245"><span class="linenos">1245</span></a>                    <span class="p">)</span>
</span><span id="AgentMemoryManager.store_graph_memory-1246"><a href="#AgentMemoryManager.store_graph_memory-1246"><span class="linenos">1246</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1247"><a href="#AgentMemoryManager.store_graph_memory-1247"><span class="linenos">1247</span></a>            <span class="c1"># Create a unique filename for this memory</span>
</span><span id="AgentMemoryManager.store_graph_memory-1248"><a href="#AgentMemoryManager.store_graph_memory-1248"><span class="linenos">1248</span></a>            <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span><span id="AgentMemoryManager.store_graph_memory-1249"><a href="#AgentMemoryManager.store_graph_memory-1249"><span class="linenos">1249</span></a>            <span class="n">memory_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>
</span><span id="AgentMemoryManager.store_graph_memory-1250"><a href="#AgentMemoryManager.store_graph_memory-1250"><span class="linenos">1250</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1251"><a href="#AgentMemoryManager.store_graph_memory-1251"><span class="linenos">1251</span></a>            <span class="c1"># If memory_id is provided, use it in the filename for traceability</span>
</span><span id="AgentMemoryManager.store_graph_memory-1252"><a href="#AgentMemoryManager.store_graph_memory-1252"><span class="linenos">1252</span></a>            <span class="k">if</span> <span class="n">memory_id</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1253"><a href="#AgentMemoryManager.store_graph_memory-1253"><span class="linenos">1253</span></a>                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;memory_</span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">memory_hash</span><span class="si">}</span><span class="s2">.txt&quot;</span>
</span><span id="AgentMemoryManager.store_graph_memory-1254"><a href="#AgentMemoryManager.store_graph_memory-1254"><span class="linenos">1254</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1255"><a href="#AgentMemoryManager.store_graph_memory-1255"><span class="linenos">1255</span></a>                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;memory_</span><span class="si">{</span><span class="n">memory_hash</span><span class="si">}</span><span class="s2">.txt&quot;</span>
</span><span id="AgentMemoryManager.store_graph_memory-1256"><a href="#AgentMemoryManager.store_graph_memory-1256"><span class="linenos">1256</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1257"><a href="#AgentMemoryManager.store_graph_memory-1257"><span class="linenos">1257</span></a>            <span class="c1"># Prepare the content with metadata</span>
</span><span id="AgentMemoryManager.store_graph_memory-1258"><a href="#AgentMemoryManager.store_graph_memory-1258"><span class="linenos">1258</span></a>            <span class="n">file_content</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="AgentMemoryManager.store_graph_memory-1259"><a href="#AgentMemoryManager.store_graph_memory-1259"><span class="linenos">1259</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1260"><a href="#AgentMemoryManager.store_graph_memory-1260"><span class="linenos">1260</span></a>            <span class="c1"># Add topics as metadata if available</span>
</span><span id="AgentMemoryManager.store_graph_memory-1261"><a href="#AgentMemoryManager.store_graph_memory-1261"><span class="linenos">1261</span></a>            <span class="k">if</span> <span class="n">topic_list</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1262"><a href="#AgentMemoryManager.store_graph_memory-1262"><span class="linenos">1262</span></a>                <span class="n">file_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topic_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.store_graph_memory-1263"><a href="#AgentMemoryManager.store_graph_memory-1263"><span class="linenos">1263</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1264"><a href="#AgentMemoryManager.store_graph_memory-1264"><span class="linenos">1264</span></a>            <span class="c1"># Create a temporary file</span>
</span><span id="AgentMemoryManager.store_graph_memory-1265"><a href="#AgentMemoryManager.store_graph_memory-1265"><span class="linenos">1265</span></a>            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_graph_memory-1266"><a href="#AgentMemoryManager.store_graph_memory-1266"><span class="linenos">1266</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span>
</span><span id="AgentMemoryManager.store_graph_memory-1267"><a href="#AgentMemoryManager.store_graph_memory-1267"><span class="linenos">1267</span></a>            <span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1268"><a href="#AgentMemoryManager.store_graph_memory-1268"><span class="linenos">1268</span></a>                <span class="n">temp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
</span><span id="AgentMemoryManager.store_graph_memory-1269"><a href="#AgentMemoryManager.store_graph_memory-1269"><span class="linenos">1269</span></a>                <span class="n">temp_file_path</span> <span class="o">=</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span>
</span><span id="AgentMemoryManager.store_graph_memory-1270"><a href="#AgentMemoryManager.store_graph_memory-1270"><span class="linenos">1270</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1271"><a href="#AgentMemoryManager.store_graph_memory-1271"><span class="linenos">1271</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1272"><a href="#AgentMemoryManager.store_graph_memory-1272"><span class="linenos">1272</span></a>                <span class="c1"># Upload the file using the /documents/upload endpoint</span>
</span><span id="AgentMemoryManager.store_graph_memory-1273"><a href="#AgentMemoryManager.store_graph_memory-1273"><span class="linenos">1273</span></a>                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/documents/upload&quot;</span>
</span><span id="AgentMemoryManager.store_graph_memory-1274"><a href="#AgentMemoryManager.store_graph_memory-1274"><span class="linenos">1274</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1275"><a href="#AgentMemoryManager.store_graph_memory-1275"><span class="linenos">1275</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1276"><a href="#AgentMemoryManager.store_graph_memory-1276"><span class="linenos">1276</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1277"><a href="#AgentMemoryManager.store_graph_memory-1277"><span class="linenos">1277</span></a>                        <span class="c1"># Create form data for file upload</span>
</span><span id="AgentMemoryManager.store_graph_memory-1278"><a href="#AgentMemoryManager.store_graph_memory-1278"><span class="linenos">1278</span></a>                        <span class="n">data</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">FormData</span><span class="p">()</span>
</span><span id="AgentMemoryManager.store_graph_memory-1279"><a href="#AgentMemoryManager.store_graph_memory-1279"><span class="linenos">1279</span></a>                        <span class="n">data</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_graph_memory-1280"><a href="#AgentMemoryManager.store_graph_memory-1280"><span class="linenos">1280</span></a>                            <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span>
</span><span id="AgentMemoryManager.store_graph_memory-1281"><a href="#AgentMemoryManager.store_graph_memory-1281"><span class="linenos">1281</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager.store_graph_memory-1282"><a href="#AgentMemoryManager.store_graph_memory-1282"><span class="linenos">1282</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1283"><a href="#AgentMemoryManager.store_graph_memory-1283"><span class="linenos">1283</span></a>                        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1284"><a href="#AgentMemoryManager.store_graph_memory-1284"><span class="linenos">1284</span></a>                            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">]:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1285"><a href="#AgentMemoryManager.store_graph_memory-1285"><span class="linenos">1285</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_graph_memory-1286"><a href="#AgentMemoryManager.store_graph_memory-1286"><span class="linenos">1286</span></a>                                    <span class="s2">&quot;Successfully stored memory in graph database: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_graph_memory-1287"><a href="#AgentMemoryManager.store_graph_memory-1287"><span class="linenos">1287</span></a>                                    <span class="n">filename</span><span class="p">,</span>
</span><span id="AgentMemoryManager.store_graph_memory-1288"><a href="#AgentMemoryManager.store_graph_memory-1288"><span class="linenos">1288</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager.store_graph_memory-1289"><a href="#AgentMemoryManager.store_graph_memory-1289"><span class="linenos">1289</span></a>                                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Memory successfully stored in graph database: </span><span class="si">{</span><span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span id="AgentMemoryManager.store_graph_memory-1290"><a href="#AgentMemoryManager.store_graph_memory-1290"><span class="linenos">1290</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1291"><a href="#AgentMemoryManager.store_graph_memory-1291"><span class="linenos">1291</span></a>                                <span class="n">error_detail</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager.store_graph_memory-1292"><a href="#AgentMemoryManager.store_graph_memory-1292"><span class="linenos">1292</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager.store_graph_memory-1293"><a href="#AgentMemoryManager.store_graph_memory-1293"><span class="linenos">1293</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Failed to store memory in graph: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.store_graph_memory-1294"><a href="#AgentMemoryManager.store_graph_memory-1294"><span class="linenos">1294</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager.store_graph_memory-1295"><a href="#AgentMemoryManager.store_graph_memory-1295"><span class="linenos">1295</span></a>                                <span class="k">return</span> <span class="p">(</span>
</span><span id="AgentMemoryManager.store_graph_memory-1296"><a href="#AgentMemoryManager.store_graph_memory-1296"><span class="linenos">1296</span></a>                                    <span class="sa">f</span><span class="s2">&quot; Error storing memory in graph: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.store_graph_memory-1297"><a href="#AgentMemoryManager.store_graph_memory-1297"><span class="linenos">1297</span></a>                                <span class="p">)</span>
</span><span id="AgentMemoryManager.store_graph_memory-1298"><a href="#AgentMemoryManager.store_graph_memory-1298"><span class="linenos">1298</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1299"><a href="#AgentMemoryManager.store_graph_memory-1299"><span class="linenos">1299</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1300"><a href="#AgentMemoryManager.store_graph_memory-1300"><span class="linenos">1300</span></a>                <span class="c1"># Clean up the temporary file</span>
</span><span id="AgentMemoryManager.store_graph_memory-1301"><a href="#AgentMemoryManager.store_graph_memory-1301"><span class="linenos">1301</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1302"><a href="#AgentMemoryManager.store_graph_memory-1302"><span class="linenos">1302</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">)</span>
</span><span id="AgentMemoryManager.store_graph_memory-1303"><a href="#AgentMemoryManager.store_graph_memory-1303"><span class="linenos">1303</span></a>                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1304"><a href="#AgentMemoryManager.store_graph_memory-1304"><span class="linenos">1304</span></a>                    <span class="k">pass</span>  <span class="c1"># Ignore cleanup errors</span>
</span><span id="AgentMemoryManager.store_graph_memory-1305"><a href="#AgentMemoryManager.store_graph_memory-1305"><span class="linenos">1305</span></a>
</span><span id="AgentMemoryManager.store_graph_memory-1306"><a href="#AgentMemoryManager.store_graph_memory-1306"><span class="linenos">1306</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.store_graph_memory-1307"><a href="#AgentMemoryManager.store_graph_memory-1307"><span class="linenos">1307</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error storing memory in graph: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AgentMemoryManager.store_graph_memory-1308"><a href="#AgentMemoryManager.store_graph_memory-1308"><span class="linenos">1308</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error storing memory in graph: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Store a memory in the LightRAG graph database to capture relationships.</p>

<p>This method creates a text file with the memory content and uploads it to the LightRAG
memory server, which then processes it to extract entities and relationships.</p>

<p>Args:
    content: The memory content to store
    topics: Optional list of topics/categories for the memory
    memory_id: Optional memory ID to link with the SQLite memory</p>

<p>Returns:
    str: Success or error message</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.query_graph_memory" class="classattr">
                                        <input id="AgentMemoryManager.query_graph_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">query_graph_memory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">query</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mix&#39;</span>,</span><span class="param">	<span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">response_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Multiple Paragraphs&#39;</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.query_graph_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.query_graph_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.query_graph_memory-1310"><a href="#AgentMemoryManager.query_graph_memory-1310"><span class="linenos">1310</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query_graph_memory</span><span class="p">(</span>
</span><span id="AgentMemoryManager.query_graph_memory-1311"><a href="#AgentMemoryManager.query_graph_memory-1311"><span class="linenos">1311</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1312"><a href="#AgentMemoryManager.query_graph_memory-1312"><span class="linenos">1312</span></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1313"><a href="#AgentMemoryManager.query_graph_memory-1313"><span class="linenos">1313</span></a>        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mix&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1314"><a href="#AgentMemoryManager.query_graph_memory-1314"><span class="linenos">1314</span></a>        <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1315"><a href="#AgentMemoryManager.query_graph_memory-1315"><span class="linenos">1315</span></a>        <span class="n">response_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Multiple Paragraphs&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1316"><a href="#AgentMemoryManager.query_graph_memory-1316"><span class="linenos">1316</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_graph_memory-1317"><a href="#AgentMemoryManager.query_graph_memory-1317"><span class="linenos">1317</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query the LightRAG memory graph to explore relationships between memories.</span>
</span><span id="AgentMemoryManager.query_graph_memory-1318"><a href="#AgentMemoryManager.query_graph_memory-1318"><span class="linenos">1318</span></a>
</span><span id="AgentMemoryManager.query_graph_memory-1319"><a href="#AgentMemoryManager.query_graph_memory-1319"><span class="linenos">1319</span></a><span class="sd">        This method sends a query to the LightRAG memory server to retrieve memories and their</span>
</span><span id="AgentMemoryManager.query_graph_memory-1320"><a href="#AgentMemoryManager.query_graph_memory-1320"><span class="linenos">1320</span></a><span class="sd">        relationships based on the query. It supports different query modes and response formats.</span>
</span><span id="AgentMemoryManager.query_graph_memory-1321"><a href="#AgentMemoryManager.query_graph_memory-1321"><span class="linenos">1321</span></a>
</span><span id="AgentMemoryManager.query_graph_memory-1322"><a href="#AgentMemoryManager.query_graph_memory-1322"><span class="linenos">1322</span></a><span class="sd">        Args:</span>
</span><span id="AgentMemoryManager.query_graph_memory-1323"><a href="#AgentMemoryManager.query_graph_memory-1323"><span class="linenos">1323</span></a><span class="sd">            query: The query to search for in the memory graph</span>
</span><span id="AgentMemoryManager.query_graph_memory-1324"><a href="#AgentMemoryManager.query_graph_memory-1324"><span class="linenos">1324</span></a><span class="sd">            mode: Query mode - &quot;semantic&quot; (vector search), &quot;graph&quot; (graph traversal), or &quot;mix&quot; (combined)</span>
</span><span id="AgentMemoryManager.query_graph_memory-1325"><a href="#AgentMemoryManager.query_graph_memory-1325"><span class="linenos">1325</span></a><span class="sd">            top_k: Maximum number of results to return</span>
</span><span id="AgentMemoryManager.query_graph_memory-1326"><a href="#AgentMemoryManager.query_graph_memory-1326"><span class="linenos">1326</span></a><span class="sd">            response_type: Format of the response - &quot;Multiple Paragraphs&quot;, &quot;Single Paragraph&quot;, etc.</span>
</span><span id="AgentMemoryManager.query_graph_memory-1327"><a href="#AgentMemoryManager.query_graph_memory-1327"><span class="linenos">1327</span></a>
</span><span id="AgentMemoryManager.query_graph_memory-1328"><a href="#AgentMemoryManager.query_graph_memory-1328"><span class="linenos">1328</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.query_graph_memory-1329"><a href="#AgentMemoryManager.query_graph_memory-1329"><span class="linenos">1329</span></a><span class="sd">            dict: Query results with memories and their relationships</span>
</span><span id="AgentMemoryManager.query_graph_memory-1330"><a href="#AgentMemoryManager.query_graph_memory-1330"><span class="linenos">1330</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.query_graph_memory-1331"><a href="#AgentMemoryManager.query_graph_memory-1331"><span class="linenos">1331</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_graph_memory-1332"><a href="#AgentMemoryManager.query_graph_memory-1332"><span class="linenos">1332</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_graph_memory-1333"><a href="#AgentMemoryManager.query_graph_memory-1333"><span class="linenos">1333</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LightRAG memory URL not configured&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.query_graph_memory-1334"><a href="#AgentMemoryManager.query_graph_memory-1334"><span class="linenos">1334</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="AgentMemoryManager.query_graph_memory-1335"><a href="#AgentMemoryManager.query_graph_memory-1335"><span class="linenos">1335</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Graph memory not configured. Cannot query graph database.&quot;</span>
</span><span id="AgentMemoryManager.query_graph_memory-1336"><a href="#AgentMemoryManager.query_graph_memory-1336"><span class="linenos">1336</span></a>                <span class="p">}</span>
</span><span id="AgentMemoryManager.query_graph_memory-1337"><a href="#AgentMemoryManager.query_graph_memory-1337"><span class="linenos">1337</span></a>
</span><span id="AgentMemoryManager.query_graph_memory-1338"><a href="#AgentMemoryManager.query_graph_memory-1338"><span class="linenos">1338</span></a>            <span class="c1"># Validate query</span>
</span><span id="AgentMemoryManager.query_graph_memory-1339"><a href="#AgentMemoryManager.query_graph_memory-1339"><span class="linenos">1339</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="AgentMemoryManager.query_graph_memory-1340"><a href="#AgentMemoryManager.query_graph_memory-1340"><span class="linenos">1340</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Empty query provided to query_graph_memory&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.query_graph_memory-1341"><a href="#AgentMemoryManager.query_graph_memory-1341"><span class="linenos">1341</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Query cannot be empty. Please provide a search term.&quot;</span><span class="p">}</span>
</span><span id="AgentMemoryManager.query_graph_memory-1342"><a href="#AgentMemoryManager.query_graph_memory-1342"><span class="linenos">1342</span></a>
</span><span id="AgentMemoryManager.query_graph_memory-1343"><a href="#AgentMemoryManager.query_graph_memory-1343"><span class="linenos">1343</span></a>            <span class="c1"># Validate mode</span>
</span><span id="AgentMemoryManager.query_graph_memory-1344"><a href="#AgentMemoryManager.query_graph_memory-1344"><span class="linenos">1344</span></a>            <span class="n">valid_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager.query_graph_memory-1345"><a href="#AgentMemoryManager.query_graph_memory-1345"><span class="linenos">1345</span></a>            <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_modes</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_graph_memory-1346"><a href="#AgentMemoryManager.query_graph_memory-1346"><span class="linenos">1346</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid mode &#39;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39; provided to query_graph_memory&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.query_graph_memory-1347"><a href="#AgentMemoryManager.query_graph_memory-1347"><span class="linenos">1347</span></a>                <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;mix&quot;</span>  <span class="c1"># Default to mix mode</span>
</span><span id="AgentMemoryManager.query_graph_memory-1348"><a href="#AgentMemoryManager.query_graph_memory-1348"><span class="linenos">1348</span></a>
</span><span id="AgentMemoryManager.query_graph_memory-1349"><a href="#AgentMemoryManager.query_graph_memory-1349"><span class="linenos">1349</span></a>            <span class="c1"># Validate response_type</span>
</span><span id="AgentMemoryManager.query_graph_memory-1350"><a href="#AgentMemoryManager.query_graph_memory-1350"><span class="linenos">1350</span></a>            <span class="n">valid_response_types</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentMemoryManager.query_graph_memory-1351"><a href="#AgentMemoryManager.query_graph_memory-1351"><span class="linenos">1351</span></a>                <span class="s2">&quot;Multiple Paragraphs&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1352"><a href="#AgentMemoryManager.query_graph_memory-1352"><span class="linenos">1352</span></a>                <span class="s2">&quot;Single Paragraph&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1353"><a href="#AgentMemoryManager.query_graph_memory-1353"><span class="linenos">1353</span></a>                <span class="s2">&quot;Bullet Points&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1354"><a href="#AgentMemoryManager.query_graph_memory-1354"><span class="linenos">1354</span></a>                <span class="s2">&quot;JSON&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1355"><a href="#AgentMemoryManager.query_graph_memory-1355"><span class="linenos">1355</span></a>            <span class="p">]</span>
</span><span id="AgentMemoryManager.query_graph_memory-1356"><a href="#AgentMemoryManager.query_graph_memory-1356"><span class="linenos">1356</span></a>            <span class="k">if</span> <span class="n">response_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_response_types</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_graph_memory-1357"><a href="#AgentMemoryManager.query_graph_memory-1357"><span class="linenos">1357</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager.query_graph_memory-1358"><a href="#AgentMemoryManager.query_graph_memory-1358"><span class="linenos">1358</span></a>                    <span class="sa">f</span><span class="s2">&quot;Invalid response_type &#39;</span><span class="si">{</span><span class="n">response_type</span><span class="si">}</span><span class="s2">&#39; provided to query_graph_memory&quot;</span>
</span><span id="AgentMemoryManager.query_graph_memory-1359"><a href="#AgentMemoryManager.query_graph_memory-1359"><span class="linenos">1359</span></a>                <span class="p">)</span>
</span><span id="AgentMemoryManager.query_graph_memory-1360"><a href="#AgentMemoryManager.query_graph_memory-1360"><span class="linenos">1360</span></a>                <span class="n">response_type</span> <span class="o">=</span> <span class="s2">&quot;Multiple Paragraphs&quot;</span>  <span class="c1"># Default to multiple paragraphs</span>
</span><span id="AgentMemoryManager.query_graph_memory-1361"><a href="#AgentMemoryManager.query_graph_memory-1361"><span class="linenos">1361</span></a>
</span><span id="AgentMemoryManager.query_graph_memory-1362"><a href="#AgentMemoryManager.query_graph_memory-1362"><span class="linenos">1362</span></a>            <span class="c1"># Prepare the query parameters</span>
</span><span id="AgentMemoryManager.query_graph_memory-1363"><a href="#AgentMemoryManager.query_graph_memory-1363"><span class="linenos">1363</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentMemoryManager.query_graph_memory-1364"><a href="#AgentMemoryManager.query_graph_memory-1364"><span class="linenos">1364</span></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
</span><span id="AgentMemoryManager.query_graph_memory-1365"><a href="#AgentMemoryManager.query_graph_memory-1365"><span class="linenos">1365</span></a>                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1366"><a href="#AgentMemoryManager.query_graph_memory-1366"><span class="linenos">1366</span></a>                <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="n">top_k</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1367"><a href="#AgentMemoryManager.query_graph_memory-1367"><span class="linenos">1367</span></a>                <span class="s2">&quot;response_type&quot;</span><span class="p">:</span> <span class="n">response_type</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1368"><a href="#AgentMemoryManager.query_graph_memory-1368"><span class="linenos">1368</span></a>            <span class="p">}</span>
</span><span id="AgentMemoryManager.query_graph_memory-1369"><a href="#AgentMemoryManager.query_graph_memory-1369"><span class="linenos">1369</span></a>
</span><span id="AgentMemoryManager.query_graph_memory-1370"><a href="#AgentMemoryManager.query_graph_memory-1370"><span class="linenos">1370</span></a>            <span class="c1"># Send the query to the LightRAG memory server</span>
</span><span id="AgentMemoryManager.query_graph_memory-1371"><a href="#AgentMemoryManager.query_graph_memory-1371"><span class="linenos">1371</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/query&quot;</span>
</span><span id="AgentMemoryManager.query_graph_memory-1372"><a href="#AgentMemoryManager.query_graph_memory-1372"><span class="linenos">1372</span></a>
</span><span id="AgentMemoryManager.query_graph_memory-1373"><a href="#AgentMemoryManager.query_graph_memory-1373"><span class="linenos">1373</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_graph_memory-1374"><a href="#AgentMemoryManager.query_graph_memory-1374"><span class="linenos">1374</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_graph_memory-1375"><a href="#AgentMemoryManager.query_graph_memory-1375"><span class="linenos">1375</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_graph_memory-1376"><a href="#AgentMemoryManager.query_graph_memory-1376"><span class="linenos">1376</span></a>                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentMemoryManager.query_graph_memory-1377"><a href="#AgentMemoryManager.query_graph_memory-1377"><span class="linenos">1377</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentMemoryManager.query_graph_memory-1378"><a href="#AgentMemoryManager.query_graph_memory-1378"><span class="linenos">1378</span></a>                            <span class="sa">f</span><span class="s2">&quot;Successfully queried graph memory: </span><span class="si">{</span><span class="n">query</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span id="AgentMemoryManager.query_graph_memory-1379"><a href="#AgentMemoryManager.query_graph_memory-1379"><span class="linenos">1379</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager.query_graph_memory-1380"><a href="#AgentMemoryManager.query_graph_memory-1380"><span class="linenos">1380</span></a>                        <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager.query_graph_memory-1381"><a href="#AgentMemoryManager.query_graph_memory-1381"><span class="linenos">1381</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_graph_memory-1382"><a href="#AgentMemoryManager.query_graph_memory-1382"><span class="linenos">1382</span></a>                        <span class="n">error_detail</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager.query_graph_memory-1383"><a href="#AgentMemoryManager.query_graph_memory-1383"><span class="linenos">1383</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to query graph memory: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.query_graph_memory-1384"><a href="#AgentMemoryManager.query_graph_memory-1384"><span class="linenos">1384</span></a>                        <span class="k">return</span> <span class="p">{</span>
</span><span id="AgentMemoryManager.query_graph_memory-1385"><a href="#AgentMemoryManager.query_graph_memory-1385"><span class="linenos">1385</span></a>                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error querying graph memory: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1386"><a href="#AgentMemoryManager.query_graph_memory-1386"><span class="linenos">1386</span></a>                            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1387"><a href="#AgentMemoryManager.query_graph_memory-1387"><span class="linenos">1387</span></a>                            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1388"><a href="#AgentMemoryManager.query_graph_memory-1388"><span class="linenos">1388</span></a>                        <span class="p">}</span>
</span><span id="AgentMemoryManager.query_graph_memory-1389"><a href="#AgentMemoryManager.query_graph_memory-1389"><span class="linenos">1389</span></a>
</span><span id="AgentMemoryManager.query_graph_memory-1390"><a href="#AgentMemoryManager.query_graph_memory-1390"><span class="linenos">1390</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.query_graph_memory-1391"><a href="#AgentMemoryManager.query_graph_memory-1391"><span class="linenos">1391</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying graph memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.query_graph_memory-1392"><a href="#AgentMemoryManager.query_graph_memory-1392"><span class="linenos">1392</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="AgentMemoryManager.query_graph_memory-1393"><a href="#AgentMemoryManager.query_graph_memory-1393"><span class="linenos">1393</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error querying graph memory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1394"><a href="#AgentMemoryManager.query_graph_memory-1394"><span class="linenos">1394</span></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1395"><a href="#AgentMemoryManager.query_graph_memory-1395"><span class="linenos">1395</span></a>                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
</span><span id="AgentMemoryManager.query_graph_memory-1396"><a href="#AgentMemoryManager.query_graph_memory-1396"><span class="linenos">1396</span></a>            <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Query the LightRAG memory graph to explore relationships between memories.</p>

<p>This method sends a query to the LightRAG memory server to retrieve memories and their
relationships based on the query. It supports different query modes and response formats.</p>

<p>Args:
    query: The query to search for in the memory graph
    mode: Query mode - "semantic" (vector search), "graph" (graph traversal), or "mix" (combined)
    top_k: Maximum number of results to return
    response_type: Format of the response - "Multiple Paragraphs", "Single Paragraph", etc.</p>

<p>Returns:
    dict: Query results with memories and their relationships</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.get_memory_graph_labels" class="classattr">
                                        <input id="AgentMemoryManager.get_memory_graph_labels-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">get_memory_graph_labels</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.get_memory_graph_labels-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.get_memory_graph_labels"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.get_memory_graph_labels-1398"><a href="#AgentMemoryManager.get_memory_graph_labels-1398"><span class="linenos">1398</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_graph_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1399"><a href="#AgentMemoryManager.get_memory_graph_labels-1399"><span class="linenos">1399</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the list of all entity and relation labels from the memory graph.</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1400"><a href="#AgentMemoryManager.get_memory_graph_labels-1400"><span class="linenos">1400</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1401"><a href="#AgentMemoryManager.get_memory_graph_labels-1401"><span class="linenos">1401</span></a><span class="sd">        This method retrieves all entity and relation labels from the LightRAG memory graph,</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1402"><a href="#AgentMemoryManager.get_memory_graph_labels-1402"><span class="linenos">1402</span></a><span class="sd">        providing insights into the types of information stored in the graph.</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1403"><a href="#AgentMemoryManager.get_memory_graph_labels-1403"><span class="linenos">1403</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1404"><a href="#AgentMemoryManager.get_memory_graph_labels-1404"><span class="linenos">1404</span></a><span class="sd">        Returns:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1405"><a href="#AgentMemoryManager.get_memory_graph_labels-1405"><span class="linenos">1405</span></a><span class="sd">            str: Formatted string with entity and relation labels</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1406"><a href="#AgentMemoryManager.get_memory_graph_labels-1406"><span class="linenos">1406</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1407"><a href="#AgentMemoryManager.get_memory_graph_labels-1407"><span class="linenos">1407</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1408"><a href="#AgentMemoryManager.get_memory_graph_labels-1408"><span class="linenos">1408</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1409"><a href="#AgentMemoryManager.get_memory_graph_labels-1409"><span class="linenos">1409</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LightRAG memory URL not configured&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1410"><a href="#AgentMemoryManager.get_memory_graph_labels-1410"><span class="linenos">1410</span></a>                <span class="k">return</span> <span class="s2">&quot; Graph memory not configured. Cannot retrieve graph labels.&quot;</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1411"><a href="#AgentMemoryManager.get_memory_graph_labels-1411"><span class="linenos">1411</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1412"><a href="#AgentMemoryManager.get_memory_graph_labels-1412"><span class="linenos">1412</span></a>            <span class="c1"># Send the request to the LightRAG memory server</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1413"><a href="#AgentMemoryManager.get_memory_graph_labels-1413"><span class="linenos">1413</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_url</span><span class="si">}</span><span class="s2">/graph/label/list&quot;</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1414"><a href="#AgentMemoryManager.get_memory_graph_labels-1414"><span class="linenos">1414</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1415"><a href="#AgentMemoryManager.get_memory_graph_labels-1415"><span class="linenos">1415</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1416"><a href="#AgentMemoryManager.get_memory_graph_labels-1416"><span class="linenos">1416</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1417"><a href="#AgentMemoryManager.get_memory_graph_labels-1417"><span class="linenos">1417</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1418"><a href="#AgentMemoryManager.get_memory_graph_labels-1418"><span class="linenos">1418</span></a>                        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1419"><a href="#AgentMemoryManager.get_memory_graph_labels-1419"><span class="linenos">1419</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1420"><a href="#AgentMemoryManager.get_memory_graph_labels-1420"><span class="linenos">1420</span></a>                        <span class="c1"># Handle different response formats</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1421"><a href="#AgentMemoryManager.get_memory_graph_labels-1421"><span class="linenos">1421</span></a>                        <span class="n">entity_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1422"><a href="#AgentMemoryManager.get_memory_graph_labels-1422"><span class="linenos">1422</span></a>                        <span class="n">relation_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1423"><a href="#AgentMemoryManager.get_memory_graph_labels-1423"><span class="linenos">1423</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1424"><a href="#AgentMemoryManager.get_memory_graph_labels-1424"><span class="linenos">1424</span></a>                        <span class="c1"># Format 1: Direct array of all labels</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1425"><a href="#AgentMemoryManager.get_memory_graph_labels-1425"><span class="linenos">1425</span></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1426"><a href="#AgentMemoryManager.get_memory_graph_labels-1426"><span class="linenos">1426</span></a>                            <span class="n">all_labels</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1427"><a href="#AgentMemoryManager.get_memory_graph_labels-1427"><span class="linenos">1427</span></a>                            <span class="c1"># We can&#39;t distinguish between entity and relation labels in this format</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1428"><a href="#AgentMemoryManager.get_memory_graph_labels-1428"><span class="linenos">1428</span></a>                            <span class="n">entity_labels</span> <span class="o">=</span> <span class="n">all_labels</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1429"><a href="#AgentMemoryManager.get_memory_graph_labels-1429"><span class="linenos">1429</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1430"><a href="#AgentMemoryManager.get_memory_graph_labels-1430"><span class="linenos">1430</span></a>                        <span class="c1"># Format 2: Dict with &#39;labels&#39; key containing all labels</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1431"><a href="#AgentMemoryManager.get_memory_graph_labels-1431"><span class="linenos">1431</span></a>                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1432"><a href="#AgentMemoryManager.get_memory_graph_labels-1432"><span class="linenos">1432</span></a>                            <span class="n">all_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1433"><a href="#AgentMemoryManager.get_memory_graph_labels-1433"><span class="linenos">1433</span></a>                            <span class="c1"># We can&#39;t distinguish between entity and relation labels in this format</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1434"><a href="#AgentMemoryManager.get_memory_graph_labels-1434"><span class="linenos">1434</span></a>                            <span class="n">entity_labels</span> <span class="o">=</span> <span class="n">all_labels</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1435"><a href="#AgentMemoryManager.get_memory_graph_labels-1435"><span class="linenos">1435</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1436"><a href="#AgentMemoryManager.get_memory_graph_labels-1436"><span class="linenos">1436</span></a>                        <span class="c1"># Format 3: Dict with separate &#39;entity_labels&#39; and &#39;relation_labels&#39; keys</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1437"><a href="#AgentMemoryManager.get_memory_graph_labels-1437"><span class="linenos">1437</span></a>                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1438"><a href="#AgentMemoryManager.get_memory_graph_labels-1438"><span class="linenos">1438</span></a>                            <span class="k">if</span> <span class="s2">&quot;entity_labels&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1439"><a href="#AgentMemoryManager.get_memory_graph_labels-1439"><span class="linenos">1439</span></a>                                <span class="n">entity_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;entity_labels&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1440"><a href="#AgentMemoryManager.get_memory_graph_labels-1440"><span class="linenos">1440</span></a>                            <span class="k">if</span> <span class="s2">&quot;relation_labels&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1441"><a href="#AgentMemoryManager.get_memory_graph_labels-1441"><span class="linenos">1441</span></a>                                <span class="n">relation_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;relation_labels&quot;</span><span class="p">]</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1442"><a href="#AgentMemoryManager.get_memory_graph_labels-1442"><span class="linenos">1442</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1443"><a href="#AgentMemoryManager.get_memory_graph_labels-1443"><span class="linenos">1443</span></a>                        <span class="c1"># Format the result</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1444"><a href="#AgentMemoryManager.get_memory_graph_labels-1444"><span class="linenos">1444</span></a>                        <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot; MEMORY GRAPH LABELS</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1445"><a href="#AgentMemoryManager.get_memory_graph_labels-1445"><span class="linenos">1445</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1446"><a href="#AgentMemoryManager.get_memory_graph_labels-1446"><span class="linenos">1446</span></a>                        <span class="k">if</span> <span class="n">entity_labels</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1447"><a href="#AgentMemoryManager.get_memory_graph_labels-1447"><span class="linenos">1447</span></a>                            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;Entity Types:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1448"><a href="#AgentMemoryManager.get_memory_graph_labels-1448"><span class="linenos">1448</span></a>                            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">entity_labels</span><span class="p">):</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1449"><a href="#AgentMemoryManager.get_memory_graph_labels-1449"><span class="linenos">1449</span></a>                                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1450"><a href="#AgentMemoryManager.get_memory_graph_labels-1450"><span class="linenos">1450</span></a>                            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1451"><a href="#AgentMemoryManager.get_memory_graph_labels-1451"><span class="linenos">1451</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1452"><a href="#AgentMemoryManager.get_memory_graph_labels-1452"><span class="linenos">1452</span></a>                        <span class="k">if</span> <span class="n">relation_labels</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1453"><a href="#AgentMemoryManager.get_memory_graph_labels-1453"><span class="linenos">1453</span></a>                            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;Relation Types:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1454"><a href="#AgentMemoryManager.get_memory_graph_labels-1454"><span class="linenos">1454</span></a>                            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">relation_labels</span><span class="p">):</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1455"><a href="#AgentMemoryManager.get_memory_graph_labels-1455"><span class="linenos">1455</span></a>                                <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1456"><a href="#AgentMemoryManager.get_memory_graph_labels-1456"><span class="linenos">1456</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1457"><a href="#AgentMemoryManager.get_memory_graph_labels-1457"><span class="linenos">1457</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">entity_labels</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">relation_labels</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1458"><a href="#AgentMemoryManager.get_memory_graph_labels-1458"><span class="linenos">1458</span></a>                            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;No labels found in the memory graph. Try storing some memories first!&quot;</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1459"><a href="#AgentMemoryManager.get_memory_graph_labels-1459"><span class="linenos">1459</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1460"><a href="#AgentMemoryManager.get_memory_graph_labels-1460"><span class="linenos">1460</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retrieved memory graph labels successfully&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1461"><a href="#AgentMemoryManager.get_memory_graph_labels-1461"><span class="linenos">1461</span></a>                        <span class="k">return</span> <span class="n">result</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1462"><a href="#AgentMemoryManager.get_memory_graph_labels-1462"><span class="linenos">1462</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1463"><a href="#AgentMemoryManager.get_memory_graph_labels-1463"><span class="linenos">1463</span></a>                        <span class="n">error_detail</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1464"><a href="#AgentMemoryManager.get_memory_graph_labels-1464"><span class="linenos">1464</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1465"><a href="#AgentMemoryManager.get_memory_graph_labels-1465"><span class="linenos">1465</span></a>                            <span class="sa">f</span><span class="s2">&quot;Failed to retrieve graph labels: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1466"><a href="#AgentMemoryManager.get_memory_graph_labels-1466"><span class="linenos">1466</span></a>                        <span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1467"><a href="#AgentMemoryManager.get_memory_graph_labels-1467"><span class="linenos">1467</span></a>                        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error retrieving graph labels: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1468"><a href="#AgentMemoryManager.get_memory_graph_labels-1468"><span class="linenos">1468</span></a>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1469"><a href="#AgentMemoryManager.get_memory_graph_labels-1469"><span class="linenos">1469</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1470"><a href="#AgentMemoryManager.get_memory_graph_labels-1470"><span class="linenos">1470</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error retrieving memory graph labels: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.get_memory_graph_labels-1471"><a href="#AgentMemoryManager.get_memory_graph_labels-1471"><span class="linenos">1471</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error retrieving memory graph labels: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Get the list of all entity and relation labels from the memory graph.</p>

<p>This method retrieves all entity and relation labels from the LightRAG memory graph,
providing insights into the types of information stored in the graph.</p>

<p>Returns:
    str: Formatted string with entity and relation labels</p>
</div>


                            </div>
                            <div id="AgentMemoryManager.delete_memories_by_topic" class="classattr">
                                        <input id="AgentMemoryManager.delete_memories_by_topic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">delete_memories_by_topic</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="AgentMemoryManager.delete_memories_by_topic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentMemoryManager.delete_memories_by_topic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentMemoryManager.delete_memories_by_topic-1473"><a href="#AgentMemoryManager.delete_memories_by_topic-1473"><span class="linenos">1473</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_memories_by_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1474"><a href="#AgentMemoryManager.delete_memories_by_topic-1474"><span class="linenos">1474</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete all memories associated with a specific topic or list of topics from both local and graph memory.&quot;&quot;&quot;</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1475"><a href="#AgentMemoryManager.delete_memories_by_topic-1475"><span class="linenos">1475</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1476"><a href="#AgentMemoryManager.delete_memories_by_topic-1476"><span class="linenos">1476</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1477"><a href="#AgentMemoryManager.delete_memories_by_topic-1477"><span class="linenos">1477</span></a>                <span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1478"><a href="#AgentMemoryManager.delete_memories_by_topic-1478"><span class="linenos">1478</span></a>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1479"><a href="#AgentMemoryManager.delete_memories_by_topic-1479"><span class="linenos">1479</span></a>            <span class="c1"># Get memories to delete from local storage</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1480"><a href="#AgentMemoryManager.delete_memories_by_topic-1480"><span class="linenos">1480</span></a>            <span class="n">memories_to_delete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">memory_manager</span><span class="o">.</span><span class="n">get_memories_by_topic</span><span class="p">(</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1481"><a href="#AgentMemoryManager.delete_memories_by_topic-1481"><span class="linenos">1481</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agno_memory</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1482"><a href="#AgentMemoryManager.delete_memories_by_topic-1482"><span class="linenos">1482</span></a>            <span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1483"><a href="#AgentMemoryManager.delete_memories_by_topic-1483"><span class="linenos">1483</span></a>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1484"><a href="#AgentMemoryManager.delete_memories_by_topic-1484"><span class="linenos">1484</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories_to_delete</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1485"><a href="#AgentMemoryManager.delete_memories_by_topic-1485"><span class="linenos">1485</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;No memories found for topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1486"><a href="#AgentMemoryManager.delete_memories_by_topic-1486"><span class="linenos">1486</span></a>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1487"><a href="#AgentMemoryManager.delete_memories_by_topic-1487"><span class="linenos">1487</span></a>            <span class="n">deleted_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1488"><a href="#AgentMemoryManager.delete_memories_by_topic-1488"><span class="linenos">1488</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories_to_delete</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1489"><a href="#AgentMemoryManager.delete_memories_by_topic-1489"><span class="linenos">1489</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">memory_id</span><span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1490"><a href="#AgentMemoryManager.delete_memories_by_topic-1490"><span class="linenos">1490</span></a>                <span class="n">deleted_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1491"><a href="#AgentMemoryManager.delete_memories_by_topic-1491"><span class="linenos">1491</span></a>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1492"><a href="#AgentMemoryManager.delete_memories_by_topic-1492"><span class="linenos">1492</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Successfully deleted </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> memories for topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1493"><a href="#AgentMemoryManager.delete_memories_by_topic-1493"><span class="linenos">1493</span></a>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1494"><a href="#AgentMemoryManager.delete_memories_by_topic-1494"><span class="linenos">1494</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1495"><a href="#AgentMemoryManager.delete_memories_by_topic-1495"><span class="linenos">1495</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting memories by topic: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentMemoryManager.delete_memories_by_topic-1496"><a href="#AgentMemoryManager.delete_memories_by_topic-1496"><span class="linenos">1496</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error deleting memories by topic: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Delete all memories associated with a specific topic or list of topics from both local and graph memory.</p>
</div>


                            </div>
                </section>
                <section id="AgentModelManager">
                            <input id="AgentModelManager-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AgentModelManager</span>:

                <label class="view-source-button" for="AgentModelManager-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentModelManager"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentModelManager-24"><a href="#AgentModelManager-24"><span class="linenos"> 24</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentModelManager</span><span class="p">:</span>
</span><span id="AgentModelManager-25"><a href="#AgentModelManager-25"><span class="linenos"> 25</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages model creation and configuration.&quot;&quot;&quot;</span>
</span><span id="AgentModelManager-26"><a href="#AgentModelManager-26"><span class="linenos"> 26</span></a>
</span><span id="AgentModelManager-27"><a href="#AgentModelManager-27"><span class="linenos"> 27</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="AgentModelManager-28"><a href="#AgentModelManager-28"><span class="linenos"> 28</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AgentModelManager-29"><a href="#AgentModelManager-29"><span class="linenos"> 29</span></a>        <span class="n">model_provider</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentModelManager-30"><a href="#AgentModelManager-30"><span class="linenos"> 30</span></a>        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentModelManager-31"><a href="#AgentModelManager-31"><span class="linenos"> 31</span></a>        <span class="n">ollama_base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentModelManager-32"><a href="#AgentModelManager-32"><span class="linenos"> 32</span></a>        <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AgentModelManager-33"><a href="#AgentModelManager-33"><span class="linenos"> 33</span></a>    <span class="p">):</span>
</span><span id="AgentModelManager-34"><a href="#AgentModelManager-34"><span class="linenos"> 34</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the model manager.</span>
</span><span id="AgentModelManager-35"><a href="#AgentModelManager-35"><span class="linenos"> 35</span></a>
</span><span id="AgentModelManager-36"><a href="#AgentModelManager-36"><span class="linenos"> 36</span></a><span class="sd">        Args:</span>
</span><span id="AgentModelManager-37"><a href="#AgentModelManager-37"><span class="linenos"> 37</span></a><span class="sd">            model_provider: LLM provider (&#39;ollama&#39; or &#39;openai&#39;)</span>
</span><span id="AgentModelManager-38"><a href="#AgentModelManager-38"><span class="linenos"> 38</span></a><span class="sd">            model_name: Model name to use</span>
</span><span id="AgentModelManager-39"><a href="#AgentModelManager-39"><span class="linenos"> 39</span></a><span class="sd">            ollama_base_url: Base URL for Ollama API</span>
</span><span id="AgentModelManager-40"><a href="#AgentModelManager-40"><span class="linenos"> 40</span></a><span class="sd">            seed: Optional seed for model reproducibility</span>
</span><span id="AgentModelManager-41"><a href="#AgentModelManager-41"><span class="linenos"> 41</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentModelManager-42"><a href="#AgentModelManager-42"><span class="linenos"> 42</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_provider</span> <span class="o">=</span> <span class="n">model_provider</span>
</span><span id="AgentModelManager-43"><a href="#AgentModelManager-43"><span class="linenos"> 43</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
</span><span id="AgentModelManager-44"><a href="#AgentModelManager-44"><span class="linenos"> 44</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ollama_base_url</span> <span class="o">=</span> <span class="n">ollama_base_url</span>
</span><span id="AgentModelManager-45"><a href="#AgentModelManager-45"><span class="linenos"> 45</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
</span><span id="AgentModelManager-46"><a href="#AgentModelManager-46"><span class="linenos"> 46</span></a>
</span><span id="AgentModelManager-47"><a href="#AgentModelManager-47"><span class="linenos"> 47</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">OpenAIChat</span><span class="p">,</span> <span class="n">Ollama</span><span class="p">]:</span>
</span><span id="AgentModelManager-48"><a href="#AgentModelManager-48"><span class="linenos"> 48</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the appropriate model instance based on provider.</span>
</span><span id="AgentModelManager-49"><a href="#AgentModelManager-49"><span class="linenos"> 49</span></a>
</span><span id="AgentModelManager-50"><a href="#AgentModelManager-50"><span class="linenos"> 50</span></a><span class="sd">        Returns:</span>
</span><span id="AgentModelManager-51"><a href="#AgentModelManager-51"><span class="linenos"> 51</span></a><span class="sd">            Configured model instance (uses regular Ollama for Qwen3 compatibility)</span>
</span><span id="AgentModelManager-52"><a href="#AgentModelManager-52"><span class="linenos"> 52</span></a>
</span><span id="AgentModelManager-53"><a href="#AgentModelManager-53"><span class="linenos"> 53</span></a><span class="sd">        Raises:</span>
</span><span id="AgentModelManager-54"><a href="#AgentModelManager-54"><span class="linenos"> 54</span></a><span class="sd">            ValueError: If unsupported model provider is specified</span>
</span><span id="AgentModelManager-55"><a href="#AgentModelManager-55"><span class="linenos"> 55</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentModelManager-56"><a href="#AgentModelManager-56"><span class="linenos"> 56</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_provider</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
</span><span id="AgentModelManager-57"><a href="#AgentModelManager-57"><span class="linenos"> 57</span></a>            <span class="c1"># Use LMStudio URL from settings when provider is openai</span>
</span><span id="AgentModelManager-58"><a href="#AgentModelManager-58"><span class="linenos"> 58</span></a>            <span class="n">lmstudio_url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">LMSTUDIO_URL</span>
</span><span id="AgentModelManager-59"><a href="#AgentModelManager-59"><span class="linenos"> 59</span></a>
</span><span id="AgentModelManager-60"><a href="#AgentModelManager-60"><span class="linenos"> 60</span></a>            <span class="c1"># Check if we&#39;re using LMStudio (localhost:1234 indicates LMStudio)</span>
</span><span id="AgentModelManager-61"><a href="#AgentModelManager-61"><span class="linenos"> 61</span></a>            <span class="k">if</span> <span class="s2">&quot;localhost:1234&quot;</span> <span class="ow">in</span> <span class="n">lmstudio_url</span> <span class="ow">or</span> <span class="s2">&quot;1234&quot;</span> <span class="ow">in</span> <span class="n">lmstudio_url</span><span class="p">:</span>
</span><span id="AgentModelManager-62"><a href="#AgentModelManager-62"><span class="linenos"> 62</span></a>                <span class="c1"># Use LMStudio with OpenAI-compatible API</span>
</span><span id="AgentModelManager-63"><a href="#AgentModelManager-63"><span class="linenos"> 63</span></a>                <span class="c1"># Ensure the base URL has the correct /v1 endpoint for LMStudio</span>
</span><span id="AgentModelManager-64"><a href="#AgentModelManager-64"><span class="linenos"> 64</span></a>                <span class="n">base_url</span> <span class="o">=</span> <span class="n">lmstudio_url</span>
</span><span id="AgentModelManager-65"><a href="#AgentModelManager-65"><span class="linenos"> 65</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/v1&quot;</span><span class="p">):</span>
</span><span id="AgentModelManager-66"><a href="#AgentModelManager-66"><span class="linenos"> 66</span></a>                    <span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/v1&quot;</span>
</span><span id="AgentModelManager-67"><a href="#AgentModelManager-67"><span class="linenos"> 67</span></a>
</span><span id="AgentModelManager-68"><a href="#AgentModelManager-68"><span class="linenos"> 68</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using LMStudio with OpenAI-compatible API at: </span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentModelManager-69"><a href="#AgentModelManager-69"><span class="linenos"> 69</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentModelManager-70"><a href="#AgentModelManager-70"><span class="linenos"> 70</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentModelManager-71"><a href="#AgentModelManager-71"><span class="linenos"> 71</span></a>                    <span class="s2">&quot;This will use /v1/chat/completions endpoint (OpenAI format)&quot;</span>
</span><span id="AgentModelManager-72"><a href="#AgentModelManager-72"><span class="linenos"> 72</span></a>                <span class="p">)</span>
</span><span id="AgentModelManager-73"><a href="#AgentModelManager-73"><span class="linenos"> 73</span></a>
</span><span id="AgentModelManager-74"><a href="#AgentModelManager-74"><span class="linenos"> 74</span></a>                <span class="c1"># Remove response_format constraint to allow native OpenAI tool calling</span>
</span><span id="AgentModelManager-75"><a href="#AgentModelManager-75"><span class="linenos"> 75</span></a>                <span class="c1"># LMStudio should support OpenAI&#39;s standard tool calling via the tools parameter</span>
</span><span id="AgentModelManager-76"><a href="#AgentModelManager-76"><span class="linenos"> 76</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">OpenAIChat</span><span class="p">(</span>
</span><span id="AgentModelManager-77"><a href="#AgentModelManager-77"><span class="linenos"> 77</span></a>                    <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
</span><span id="AgentModelManager-78"><a href="#AgentModelManager-78"><span class="linenos"> 78</span></a>                    <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>  <span class="c1"># Use corrected base URL with /v1 endpoint</span>
</span><span id="AgentModelManager-79"><a href="#AgentModelManager-79"><span class="linenos"> 79</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;lm-studio&quot;</span><span class="p">,</span>  <span class="c1"># LMStudio doesn&#39;t require a real API key</span>
</span><span id="AgentModelManager-80"><a href="#AgentModelManager-80"><span class="linenos"> 80</span></a>                    <span class="c1"># No request_params with response_format - let OpenAI handle tool calling natively</span>
</span><span id="AgentModelManager-81"><a href="#AgentModelManager-81"><span class="linenos"> 81</span></a>                <span class="p">)</span>
</span><span id="AgentModelManager-82"><a href="#AgentModelManager-82"><span class="linenos"> 82</span></a>
</span><span id="AgentModelManager-83"><a href="#AgentModelManager-83"><span class="linenos"> 83</span></a>                <span class="c1"># WORKAROUND: Fix incorrect role mapping in Agno framework</span>
</span><span id="AgentModelManager-84"><a href="#AgentModelManager-84"><span class="linenos"> 84</span></a>                <span class="c1"># The default_role_map incorrectly maps &quot;system&quot; -&gt; &quot;developer&quot;</span>
</span><span id="AgentModelManager-85"><a href="#AgentModelManager-85"><span class="linenos"> 85</span></a>                <span class="c1"># but OpenAI API only accepts: user, assistant, system, tool</span>
</span><span id="AgentModelManager-86"><a href="#AgentModelManager-86"><span class="linenos"> 86</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;role_map&quot;</span><span class="p">):</span>
</span><span id="AgentModelManager-87"><a href="#AgentModelManager-87"><span class="linenos"> 87</span></a>                    <span class="n">model</span><span class="o">.</span><span class="n">role_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentModelManager-88"><a href="#AgentModelManager-88"><span class="linenos"> 88</span></a>                        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>  <span class="c1"># Fix: should be &quot;system&quot;, not &quot;developer&quot;</span>
</span><span id="AgentModelManager-89"><a href="#AgentModelManager-89"><span class="linenos"> 89</span></a>                        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-90"><a href="#AgentModelManager-90"><span class="linenos"> 90</span></a>                        <span class="s2">&quot;assistant&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-91"><a href="#AgentModelManager-91"><span class="linenos"> 91</span></a>                        <span class="s2">&quot;tool&quot;</span><span class="p">:</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-92"><a href="#AgentModelManager-92"><span class="linenos"> 92</span></a>                        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-93"><a href="#AgentModelManager-93"><span class="linenos"> 93</span></a>                    <span class="p">}</span>
</span><span id="AgentModelManager-94"><a href="#AgentModelManager-94"><span class="linenos"> 94</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentModelManager-95"><a href="#AgentModelManager-95"><span class="linenos"> 95</span></a>                        <span class="sa">f</span><span class="s2">&quot; Applied role mapping fix to LMStudio model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentModelManager-96"><a href="#AgentModelManager-96"><span class="linenos"> 96</span></a>                    <span class="p">)</span>
</span><span id="AgentModelManager-97"><a href="#AgentModelManager-97"><span class="linenos"> 97</span></a>
</span><span id="AgentModelManager-98"><a href="#AgentModelManager-98"><span class="linenos"> 98</span></a>                <span class="k">return</span> <span class="n">model</span>
</span><span id="AgentModelManager-99"><a href="#AgentModelManager-99"><span class="linenos"> 99</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentModelManager-100"><a href="#AgentModelManager-100"><span class="linenos">100</span></a>                <span class="c1"># Standard OpenAI API</span>
</span><span id="AgentModelManager-101"><a href="#AgentModelManager-101"><span class="linenos">101</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using standard OpenAI API with model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentModelManager-102"><a href="#AgentModelManager-102"><span class="linenos">102</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">OpenAIChat</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
</span><span id="AgentModelManager-103"><a href="#AgentModelManager-103"><span class="linenos">103</span></a>
</span><span id="AgentModelManager-104"><a href="#AgentModelManager-104"><span class="linenos">104</span></a>                <span class="c1"># WORKAROUND: Fix incorrect role mapping in Agno framework</span>
</span><span id="AgentModelManager-105"><a href="#AgentModelManager-105"><span class="linenos">105</span></a>                <span class="c1"># The default_role_map incorrectly maps &quot;system&quot; -&gt; &quot;developer&quot;</span>
</span><span id="AgentModelManager-106"><a href="#AgentModelManager-106"><span class="linenos">106</span></a>                <span class="c1"># but OpenAI API only accepts: user, assistant, system, tool</span>
</span><span id="AgentModelManager-107"><a href="#AgentModelManager-107"><span class="linenos">107</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;role_map&quot;</span><span class="p">):</span>
</span><span id="AgentModelManager-108"><a href="#AgentModelManager-108"><span class="linenos">108</span></a>                    <span class="n">model</span><span class="o">.</span><span class="n">role_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentModelManager-109"><a href="#AgentModelManager-109"><span class="linenos">109</span></a>                        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>  <span class="c1"># Fix: should be &quot;system&quot;, not &quot;developer&quot;</span>
</span><span id="AgentModelManager-110"><a href="#AgentModelManager-110"><span class="linenos">110</span></a>                        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-111"><a href="#AgentModelManager-111"><span class="linenos">111</span></a>                        <span class="s2">&quot;assistant&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-112"><a href="#AgentModelManager-112"><span class="linenos">112</span></a>                        <span class="s2">&quot;tool&quot;</span><span class="p">:</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-113"><a href="#AgentModelManager-113"><span class="linenos">113</span></a>                        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-114"><a href="#AgentModelManager-114"><span class="linenos">114</span></a>                    <span class="p">}</span>
</span><span id="AgentModelManager-115"><a href="#AgentModelManager-115"><span class="linenos">115</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentModelManager-116"><a href="#AgentModelManager-116"><span class="linenos">116</span></a>                        <span class="sa">f</span><span class="s2">&quot; Applied role mapping fix to OpenAI model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentModelManager-117"><a href="#AgentModelManager-117"><span class="linenos">117</span></a>                    <span class="p">)</span>
</span><span id="AgentModelManager-118"><a href="#AgentModelManager-118"><span class="linenos">118</span></a>
</span><span id="AgentModelManager-119"><a href="#AgentModelManager-119"><span class="linenos">119</span></a>                <span class="k">return</span> <span class="n">model</span>
</span><span id="AgentModelManager-120"><a href="#AgentModelManager-120"><span class="linenos">120</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_provider</span> <span class="o">==</span> <span class="s2">&quot;ollama&quot;</span><span class="p">:</span>
</span><span id="AgentModelManager-121"><a href="#AgentModelManager-121"><span class="linenos">121</span></a>            <span class="c1"># Get dynamic context size for this model</span>
</span><span id="AgentModelManager-122"><a href="#AgentModelManager-122"><span class="linenos">122</span></a>            <span class="n">context_size</span><span class="p">,</span> <span class="n">detection_method</span> <span class="o">=</span> <span class="n">get_model_context_size_sync</span><span class="p">(</span>
</span><span id="AgentModelManager-123"><a href="#AgentModelManager-123"><span class="linenos">123</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ollama_base_url</span>
</span><span id="AgentModelManager-124"><a href="#AgentModelManager-124"><span class="linenos">124</span></a>            <span class="p">)</span>
</span><span id="AgentModelManager-125"><a href="#AgentModelManager-125"><span class="linenos">125</span></a>
</span><span id="AgentModelManager-126"><a href="#AgentModelManager-126"><span class="linenos">126</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentModelManager-127"><a href="#AgentModelManager-127"><span class="linenos">127</span></a>                <span class="s2">&quot;Using context size </span><span class="si">%d</span><span class="s2"> for model </span><span class="si">%s</span><span class="s2"> (detected via: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-128"><a href="#AgentModelManager-128"><span class="linenos">128</span></a>                <span class="n">context_size</span><span class="p">,</span>
</span><span id="AgentModelManager-129"><a href="#AgentModelManager-129"><span class="linenos">129</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
</span><span id="AgentModelManager-130"><a href="#AgentModelManager-130"><span class="linenos">130</span></a>                <span class="n">detection_method</span><span class="p">,</span>
</span><span id="AgentModelManager-131"><a href="#AgentModelManager-131"><span class="linenos">131</span></a>            <span class="p">)</span>
</span><span id="AgentModelManager-132"><a href="#AgentModelManager-132"><span class="linenos">132</span></a>
</span><span id="AgentModelManager-133"><a href="#AgentModelManager-133"><span class="linenos">133</span></a>            <span class="c1"># Use standard configuration for other models</span>
</span><span id="AgentModelManager-134"><a href="#AgentModelManager-134"><span class="linenos">134</span></a>            <span class="n">model_options</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentModelManager-135"><a href="#AgentModelManager-135"><span class="linenos">135</span></a>                <span class="s2">&quot;num_ctx&quot;</span><span class="p">:</span> <span class="n">context_size</span><span class="p">,</span>  <span class="c1"># Use dynamically detected context window</span>
</span><span id="AgentModelManager-136"><a href="#AgentModelManager-136"><span class="linenos">136</span></a>                <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>  <span class="c1"># Optional: set temperature for consistency</span>
</span><span id="AgentModelManager-137"><a href="#AgentModelManager-137"><span class="linenos">137</span></a>                <span class="s2">&quot;num_predict&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Allow unlimited prediction length</span>
</span><span id="AgentModelManager-138"><a href="#AgentModelManager-138"><span class="linenos">138</span></a>                <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
</span><span id="AgentModelManager-139"><a href="#AgentModelManager-139"><span class="linenos">139</span></a>                <span class="s2">&quot;top_p&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
</span><span id="AgentModelManager-140"><a href="#AgentModelManager-140"><span class="linenos">140</span></a>                <span class="s2">&quot;repeat_penalty&quot;</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span>
</span><span id="AgentModelManager-141"><a href="#AgentModelManager-141"><span class="linenos">141</span></a>                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
</span><span id="AgentModelManager-142"><a href="#AgentModelManager-142"><span class="linenos">142</span></a>            <span class="p">}</span>
</span><span id="AgentModelManager-143"><a href="#AgentModelManager-143"><span class="linenos">143</span></a>
</span><span id="AgentModelManager-144"><a href="#AgentModelManager-144"><span class="linenos">144</span></a>            <span class="c1"># Special handling for qwen models with optimized parameters</span>
</span><span id="AgentModelManager-145"><a href="#AgentModelManager-145"><span class="linenos">145</span></a>            <span class="k">if</span> <span class="s2">&quot;qwen&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="AgentModelManager-146"><a href="#AgentModelManager-146"><span class="linenos">146</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentModelManager-147"><a href="#AgentModelManager-147"><span class="linenos">147</span></a>                    <span class="s2">&quot;Using optimized configuration for Qwen model: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-148"><a href="#AgentModelManager-148"><span class="linenos">148</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
</span><span id="AgentModelManager-149"><a href="#AgentModelManager-149"><span class="linenos">149</span></a>                <span class="p">)</span>
</span><span id="AgentModelManager-150"><a href="#AgentModelManager-150"><span class="linenos">150</span></a>
</span><span id="AgentModelManager-151"><a href="#AgentModelManager-151"><span class="linenos">151</span></a>                <span class="c1"># Get Qwen settings from configuration</span>
</span><span id="AgentModelManager-152"><a href="#AgentModelManager-152"><span class="linenos">152</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AgentModelManager-153"><a href="#AgentModelManager-153"><span class="linenos">153</span></a>                    <span class="n">qwen_settings</span> <span class="o">=</span> <span class="n">get_qwen_instruct_settings</span><span class="p">()</span>
</span><span id="AgentModelManager-154"><a href="#AgentModelManager-154"><span class="linenos">154</span></a>
</span><span id="AgentModelManager-155"><a href="#AgentModelManager-155"><span class="linenos">155</span></a>                    <span class="n">model_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="AgentModelManager-156"><a href="#AgentModelManager-156"><span class="linenos">156</span></a>                        <span class="p">{</span>
</span><span id="AgentModelManager-157"><a href="#AgentModelManager-157"><span class="linenos">157</span></a>                            <span class="s2">&quot;num_predict&quot;</span><span class="p">:</span> <span class="mi">32768</span><span class="p">,</span>  <span class="c1"># Set specific prediction length for qwen</span>
</span><span id="AgentModelManager-158"><a href="#AgentModelManager-158"><span class="linenos">158</span></a>                            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="n">qwen_settings</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">],</span>
</span><span id="AgentModelManager-159"><a href="#AgentModelManager-159"><span class="linenos">159</span></a>                            <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="n">qwen_settings</span><span class="p">[</span><span class="s2">&quot;top_k&quot;</span><span class="p">],</span>
</span><span id="AgentModelManager-160"><a href="#AgentModelManager-160"><span class="linenos">160</span></a>                            <span class="s2">&quot;top_p&quot;</span><span class="p">:</span> <span class="n">qwen_settings</span><span class="p">[</span><span class="s2">&quot;top_p&quot;</span><span class="p">],</span>
</span><span id="AgentModelManager-161"><a href="#AgentModelManager-161"><span class="linenos">161</span></a>                            <span class="s2">&quot;min_p&quot;</span><span class="p">:</span> <span class="n">qwen_settings</span><span class="p">[</span><span class="s2">&quot;min_p&quot;</span><span class="p">],</span>
</span><span id="AgentModelManager-162"><a href="#AgentModelManager-162"><span class="linenos">162</span></a>                            <span class="s2">&quot;repeat_penalty&quot;</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span>
</span><span id="AgentModelManager-163"><a href="#AgentModelManager-163"><span class="linenos">163</span></a>                        <span class="p">}</span>
</span><span id="AgentModelManager-164"><a href="#AgentModelManager-164"><span class="linenos">164</span></a>                    <span class="p">)</span>
</span><span id="AgentModelManager-165"><a href="#AgentModelManager-165"><span class="linenos">165</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentModelManager-166"><a href="#AgentModelManager-166"><span class="linenos">166</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load Qwen settings, using defaults: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentModelManager-167"><a href="#AgentModelManager-167"><span class="linenos">167</span></a>                    <span class="c1"># Fallback to original hardcoded values</span>
</span><span id="AgentModelManager-168"><a href="#AgentModelManager-168"><span class="linenos">168</span></a>                    <span class="n">model_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="AgentModelManager-169"><a href="#AgentModelManager-169"><span class="linenos">169</span></a>                        <span class="p">{</span>
</span><span id="AgentModelManager-170"><a href="#AgentModelManager-170"><span class="linenos">170</span></a>                            <span class="s2">&quot;num_predict&quot;</span><span class="p">:</span> <span class="mi">32768</span><span class="p">,</span>
</span><span id="AgentModelManager-171"><a href="#AgentModelManager-171"><span class="linenos">171</span></a>                            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
</span><span id="AgentModelManager-172"><a href="#AgentModelManager-172"><span class="linenos">172</span></a>                            <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="AgentModelManager-173"><a href="#AgentModelManager-173"><span class="linenos">173</span></a>                            <span class="s2">&quot;top_p&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
</span><span id="AgentModelManager-174"><a href="#AgentModelManager-174"><span class="linenos">174</span></a>                            <span class="s2">&quot;min_p&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="AgentModelManager-175"><a href="#AgentModelManager-175"><span class="linenos">175</span></a>                            <span class="s2">&quot;repeat_penalty&quot;</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span>
</span><span id="AgentModelManager-176"><a href="#AgentModelManager-176"><span class="linenos">176</span></a>                        <span class="p">}</span>
</span><span id="AgentModelManager-177"><a href="#AgentModelManager-177"><span class="linenos">177</span></a>                    <span class="p">)</span>
</span><span id="AgentModelManager-178"><a href="#AgentModelManager-178"><span class="linenos">178</span></a>
</span><span id="AgentModelManager-179"><a href="#AgentModelManager-179"><span class="linenos">179</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="AgentModelManager-180"><a href="#AgentModelManager-180"><span class="linenos">180</span></a>                <span class="s2">&quot;llama3.1&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AgentModelManager-181"><a href="#AgentModelManager-181"><span class="linenos">181</span></a>                <span class="ow">or</span> <span class="s2">&quot;llama3.2&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AgentModelManager-182"><a href="#AgentModelManager-182"><span class="linenos">182</span></a>                <span class="ow">or</span> <span class="s2">&quot;llama3.3&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AgentModelManager-183"><a href="#AgentModelManager-183"><span class="linenos">183</span></a>            <span class="p">):</span>
</span><span id="AgentModelManager-184"><a href="#AgentModelManager-184"><span class="linenos">184</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentModelManager-185"><a href="#AgentModelManager-185"><span class="linenos">185</span></a>                    <span class="s2">&quot;Using optimized configuration for Llama 3.x model: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-186"><a href="#AgentModelManager-186"><span class="linenos">186</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
</span><span id="AgentModelManager-187"><a href="#AgentModelManager-187"><span class="linenos">187</span></a>                <span class="p">)</span>
</span><span id="AgentModelManager-188"><a href="#AgentModelManager-188"><span class="linenos">188</span></a>                <span class="n">model_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="AgentModelManager-189"><a href="#AgentModelManager-189"><span class="linenos">189</span></a>                    <span class="p">{</span>
</span><span id="AgentModelManager-190"><a href="#AgentModelManager-190"><span class="linenos">190</span></a>                        <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="AgentModelManager-191"><a href="#AgentModelManager-191"><span class="linenos">191</span></a>                            <span class="s2">&quot;&lt;|start_header_id|&gt;&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-192"><a href="#AgentModelManager-192"><span class="linenos">192</span></a>                            <span class="s2">&quot;&lt;|end_header_id|&gt;&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-193"><a href="#AgentModelManager-193"><span class="linenos">193</span></a>                            <span class="s2">&quot;&lt;|eot_id|&gt;&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-194"><a href="#AgentModelManager-194"><span class="linenos">194</span></a>                        <span class="p">],</span>
</span><span id="AgentModelManager-195"><a href="#AgentModelManager-195"><span class="linenos">195</span></a>                    <span class="p">}</span>
</span><span id="AgentModelManager-196"><a href="#AgentModelManager-196"><span class="linenos">196</span></a>                <span class="p">)</span>
</span><span id="AgentModelManager-197"><a href="#AgentModelManager-197"><span class="linenos">197</span></a>
</span><span id="AgentModelManager-198"><a href="#AgentModelManager-198"><span class="linenos">198</span></a>            <span class="c1"># Add reasoning support for compatible models</span>
</span><span id="AgentModelManager-199"><a href="#AgentModelManager-199"><span class="linenos">199</span></a>            <span class="n">reasoning_models</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentModelManager-200"><a href="#AgentModelManager-200"><span class="linenos">200</span></a>                <span class="s2">&quot;o1&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-201"><a href="#AgentModelManager-201"><span class="linenos">201</span></a>                <span class="s2">&quot;o1-preview&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-202"><a href="#AgentModelManager-202"><span class="linenos">202</span></a>                <span class="s2">&quot;o1-mini&quot;</span><span class="p">,</span>  <span class="c1"># OpenAI reasoning models</span>
</span><span id="AgentModelManager-203"><a href="#AgentModelManager-203"><span class="linenos">203</span></a>                <span class="s2">&quot;qwen3:8b&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-204"><a href="#AgentModelManager-204"><span class="linenos">204</span></a>                <span class="s2">&quot;qwen3:1.7b&quot;</span><span class="p">,</span>  <span class="c1"># Fixed: lowercase &#39;b&#39; to match model_contexts.py</span>
</span><span id="AgentModelManager-205"><a href="#AgentModelManager-205"><span class="linenos">205</span></a>                <span class="s2">&quot;qwen3:4b&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-206"><a href="#AgentModelManager-206"><span class="linenos">206</span></a>                <span class="s2">&quot;qwen3-4b-instruct&quot;</span><span class="p">,</span>  <span class="c1"># New Qwen model variants</span>
</span><span id="AgentModelManager-207"><a href="#AgentModelManager-207"><span class="linenos">207</span></a>                <span class="s2">&quot;hf.co/unsloth/qwen3-4b-instruct&quot;</span><span class="p">,</span>  <span class="c1"># HuggingFace Qwen model from settings</span>
</span><span id="AgentModelManager-208"><a href="#AgentModelManager-208"><span class="linenos">208</span></a>                <span class="s2">&quot;qwq&quot;</span><span class="p">,</span>  <span class="c1"># Qwen reasoning models</span>
</span><span id="AgentModelManager-209"><a href="#AgentModelManager-209"><span class="linenos">209</span></a>                <span class="s2">&quot;deepseek-r1&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-210"><a href="#AgentModelManager-210"><span class="linenos">210</span></a>                <span class="s2">&quot;deepseek-reasoner&quot;</span><span class="p">,</span>  <span class="c1"># DeepSeek reasoning models</span>
</span><span id="AgentModelManager-211"><a href="#AgentModelManager-211"><span class="linenos">211</span></a>                <span class="s2">&quot;llama3.2&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-212"><a href="#AgentModelManager-212"><span class="linenos">212</span></a>                <span class="s2">&quot;llama3.3&quot;</span><span class="p">,</span>  <span class="c1"># Recent Llama models with reasoning</span>
</span><span id="AgentModelManager-213"><a href="#AgentModelManager-213"><span class="linenos">213</span></a>                <span class="s2">&quot;mistral&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-214"><a href="#AgentModelManager-214"><span class="linenos">214</span></a>                <span class="s2">&quot;mixtral&quot;</span><span class="p">,</span>  <span class="c1"># Mistral models with reasoning capabilities</span>
</span><span id="AgentModelManager-215"><a href="#AgentModelManager-215"><span class="linenos">215</span></a>            <span class="p">]</span>
</span><span id="AgentModelManager-216"><a href="#AgentModelManager-216"><span class="linenos">216</span></a>
</span><span id="AgentModelManager-217"><a href="#AgentModelManager-217"><span class="linenos">217</span></a>            <span class="c1"># Check if current model supports reasoning</span>
</span><span id="AgentModelManager-218"><a href="#AgentModelManager-218"><span class="linenos">218</span></a>            <span class="n">model_supports_reasoning</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="AgentModelManager-219"><a href="#AgentModelManager-219"><span class="linenos">219</span></a>                <span class="n">reasoning_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AgentModelManager-220"><a href="#AgentModelManager-220"><span class="linenos">220</span></a>                <span class="k">for</span> <span class="n">reasoning_model</span> <span class="ow">in</span> <span class="n">reasoning_models</span>
</span><span id="AgentModelManager-221"><a href="#AgentModelManager-221"><span class="linenos">221</span></a>            <span class="p">)</span>
</span><span id="AgentModelManager-222"><a href="#AgentModelManager-222"><span class="linenos">222</span></a>
</span><span id="AgentModelManager-223"><a href="#AgentModelManager-223"><span class="linenos">223</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">Ollama</span><span class="p">(</span>
</span><span id="AgentModelManager-224"><a href="#AgentModelManager-224"><span class="linenos">224</span></a>                <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
</span><span id="AgentModelManager-225"><a href="#AgentModelManager-225"><span class="linenos">225</span></a>                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ollama_base_url</span><span class="p">,</span>  <span class="c1"># Use host parameter for Ollama</span>
</span><span id="AgentModelManager-226"><a href="#AgentModelManager-226"><span class="linenos">226</span></a>                <span class="n">options</span><span class="o">=</span><span class="n">model_options</span><span class="p">,</span>
</span><span id="AgentModelManager-227"><a href="#AgentModelManager-227"><span class="linenos">227</span></a>            <span class="p">)</span>
</span><span id="AgentModelManager-228"><a href="#AgentModelManager-228"><span class="linenos">228</span></a>
</span><span id="AgentModelManager-229"><a href="#AgentModelManager-229"><span class="linenos">229</span></a>            <span class="c1"># WORKAROUND: Fix incorrect role mapping in Agno framework</span>
</span><span id="AgentModelManager-230"><a href="#AgentModelManager-230"><span class="linenos">230</span></a>            <span class="c1"># The default_role_map incorrectly maps &quot;system&quot; -&gt; &quot;developer&quot;</span>
</span><span id="AgentModelManager-231"><a href="#AgentModelManager-231"><span class="linenos">231</span></a>            <span class="c1"># but OpenAI API only accepts: user, assistant, system, tool</span>
</span><span id="AgentModelManager-232"><a href="#AgentModelManager-232"><span class="linenos">232</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;role_map&quot;</span><span class="p">):</span>
</span><span id="AgentModelManager-233"><a href="#AgentModelManager-233"><span class="linenos">233</span></a>                <span class="n">model</span><span class="o">.</span><span class="n">role_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentModelManager-234"><a href="#AgentModelManager-234"><span class="linenos">234</span></a>                    <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>  <span class="c1"># Fix: should be &quot;system&quot;, not &quot;developer&quot;</span>
</span><span id="AgentModelManager-235"><a href="#AgentModelManager-235"><span class="linenos">235</span></a>                    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-236"><a href="#AgentModelManager-236"><span class="linenos">236</span></a>                    <span class="s2">&quot;assistant&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-237"><a href="#AgentModelManager-237"><span class="linenos">237</span></a>                    <span class="s2">&quot;tool&quot;</span><span class="p">:</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-238"><a href="#AgentModelManager-238"><span class="linenos">238</span></a>                    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager-239"><a href="#AgentModelManager-239"><span class="linenos">239</span></a>                <span class="p">}</span>
</span><span id="AgentModelManager-240"><a href="#AgentModelManager-240"><span class="linenos">240</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentModelManager-241"><a href="#AgentModelManager-241"><span class="linenos">241</span></a>                    <span class="sa">f</span><span class="s2">&quot; Applied role mapping fix to Ollama model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentModelManager-242"><a href="#AgentModelManager-242"><span class="linenos">242</span></a>                <span class="p">)</span>
</span><span id="AgentModelManager-243"><a href="#AgentModelManager-243"><span class="linenos">243</span></a>
</span><span id="AgentModelManager-244"><a href="#AgentModelManager-244"><span class="linenos">244</span></a>            <span class="k">return</span> <span class="n">model</span>
</span><span id="AgentModelManager-245"><a href="#AgentModelManager-245"><span class="linenos">245</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AgentModelManager-246"><a href="#AgentModelManager-246"><span class="linenos">246</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported model provider: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_provider</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Manages model creation and configuration.</p>
</div>


                            <div id="AgentModelManager.__init__" class="classattr">
                                        <input id="AgentModelManager.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">AgentModelManager</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">model_provider</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">ollama_base_url</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="AgentModelManager.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentModelManager.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentModelManager.__init__-27"><a href="#AgentModelManager.__init__-27"><span class="linenos">27</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="AgentModelManager.__init__-28"><a href="#AgentModelManager.__init__-28"><span class="linenos">28</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AgentModelManager.__init__-29"><a href="#AgentModelManager.__init__-29"><span class="linenos">29</span></a>        <span class="n">model_provider</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentModelManager.__init__-30"><a href="#AgentModelManager.__init__-30"><span class="linenos">30</span></a>        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentModelManager.__init__-31"><a href="#AgentModelManager.__init__-31"><span class="linenos">31</span></a>        <span class="n">ollama_base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AgentModelManager.__init__-32"><a href="#AgentModelManager.__init__-32"><span class="linenos">32</span></a>        <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AgentModelManager.__init__-33"><a href="#AgentModelManager.__init__-33"><span class="linenos">33</span></a>    <span class="p">):</span>
</span><span id="AgentModelManager.__init__-34"><a href="#AgentModelManager.__init__-34"><span class="linenos">34</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the model manager.</span>
</span><span id="AgentModelManager.__init__-35"><a href="#AgentModelManager.__init__-35"><span class="linenos">35</span></a>
</span><span id="AgentModelManager.__init__-36"><a href="#AgentModelManager.__init__-36"><span class="linenos">36</span></a><span class="sd">        Args:</span>
</span><span id="AgentModelManager.__init__-37"><a href="#AgentModelManager.__init__-37"><span class="linenos">37</span></a><span class="sd">            model_provider: LLM provider (&#39;ollama&#39; or &#39;openai&#39;)</span>
</span><span id="AgentModelManager.__init__-38"><a href="#AgentModelManager.__init__-38"><span class="linenos">38</span></a><span class="sd">            model_name: Model name to use</span>
</span><span id="AgentModelManager.__init__-39"><a href="#AgentModelManager.__init__-39"><span class="linenos">39</span></a><span class="sd">            ollama_base_url: Base URL for Ollama API</span>
</span><span id="AgentModelManager.__init__-40"><a href="#AgentModelManager.__init__-40"><span class="linenos">40</span></a><span class="sd">            seed: Optional seed for model reproducibility</span>
</span><span id="AgentModelManager.__init__-41"><a href="#AgentModelManager.__init__-41"><span class="linenos">41</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentModelManager.__init__-42"><a href="#AgentModelManager.__init__-42"><span class="linenos">42</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_provider</span> <span class="o">=</span> <span class="n">model_provider</span>
</span><span id="AgentModelManager.__init__-43"><a href="#AgentModelManager.__init__-43"><span class="linenos">43</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
</span><span id="AgentModelManager.__init__-44"><a href="#AgentModelManager.__init__-44"><span class="linenos">44</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ollama_base_url</span> <span class="o">=</span> <span class="n">ollama_base_url</span>
</span><span id="AgentModelManager.__init__-45"><a href="#AgentModelManager.__init__-45"><span class="linenos">45</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the model manager.</p>

<p>Args:
    model_provider: LLM provider ('ollama' or 'openai')
    model_name: Model name to use
    ollama_base_url: Base URL for Ollama API
    seed: Optional seed for model reproducibility</p>
</div>


                            </div>
                            <div id="AgentModelManager.model_provider" class="classattr">
                                <div class="attr variable">
            <span class="name">model_provider</span>

        
    </div>
    <a class="headerlink" href="#AgentModelManager.model_provider"></a>
    
    

                            </div>
                            <div id="AgentModelManager.model_name" class="classattr">
                                <div class="attr variable">
            <span class="name">model_name</span>

        
    </div>
    <a class="headerlink" href="#AgentModelManager.model_name"></a>
    
    

                            </div>
                            <div id="AgentModelManager.ollama_base_url" class="classattr">
                                <div class="attr variable">
            <span class="name">ollama_base_url</span>

        
    </div>
    <a class="headerlink" href="#AgentModelManager.ollama_base_url"></a>
    
    

                            </div>
                            <div id="AgentModelManager.seed" class="classattr">
                                <div class="attr variable">
            <span class="name">seed</span>

        
    </div>
    <a class="headerlink" href="#AgentModelManager.seed"></a>
    
    

                            </div>
                            <div id="AgentModelManager.create_model" class="classattr">
                                        <input id="AgentModelManager.create_model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_model</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Union</span><span class="p">[</span><span class="n">agno</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">openai</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">OpenAIChat</span><span class="p">,</span> <span class="n">agno</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ollama</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">Ollama</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="AgentModelManager.create_model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AgentModelManager.create_model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AgentModelManager.create_model-47"><a href="#AgentModelManager.create_model-47"><span class="linenos"> 47</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">OpenAIChat</span><span class="p">,</span> <span class="n">Ollama</span><span class="p">]:</span>
</span><span id="AgentModelManager.create_model-48"><a href="#AgentModelManager.create_model-48"><span class="linenos"> 48</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the appropriate model instance based on provider.</span>
</span><span id="AgentModelManager.create_model-49"><a href="#AgentModelManager.create_model-49"><span class="linenos"> 49</span></a>
</span><span id="AgentModelManager.create_model-50"><a href="#AgentModelManager.create_model-50"><span class="linenos"> 50</span></a><span class="sd">        Returns:</span>
</span><span id="AgentModelManager.create_model-51"><a href="#AgentModelManager.create_model-51"><span class="linenos"> 51</span></a><span class="sd">            Configured model instance (uses regular Ollama for Qwen3 compatibility)</span>
</span><span id="AgentModelManager.create_model-52"><a href="#AgentModelManager.create_model-52"><span class="linenos"> 52</span></a>
</span><span id="AgentModelManager.create_model-53"><a href="#AgentModelManager.create_model-53"><span class="linenos"> 53</span></a><span class="sd">        Raises:</span>
</span><span id="AgentModelManager.create_model-54"><a href="#AgentModelManager.create_model-54"><span class="linenos"> 54</span></a><span class="sd">            ValueError: If unsupported model provider is specified</span>
</span><span id="AgentModelManager.create_model-55"><a href="#AgentModelManager.create_model-55"><span class="linenos"> 55</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AgentModelManager.create_model-56"><a href="#AgentModelManager.create_model-56"><span class="linenos"> 56</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_provider</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
</span><span id="AgentModelManager.create_model-57"><a href="#AgentModelManager.create_model-57"><span class="linenos"> 57</span></a>            <span class="c1"># Use LMStudio URL from settings when provider is openai</span>
</span><span id="AgentModelManager.create_model-58"><a href="#AgentModelManager.create_model-58"><span class="linenos"> 58</span></a>            <span class="n">lmstudio_url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">LMSTUDIO_URL</span>
</span><span id="AgentModelManager.create_model-59"><a href="#AgentModelManager.create_model-59"><span class="linenos"> 59</span></a>
</span><span id="AgentModelManager.create_model-60"><a href="#AgentModelManager.create_model-60"><span class="linenos"> 60</span></a>            <span class="c1"># Check if we&#39;re using LMStudio (localhost:1234 indicates LMStudio)</span>
</span><span id="AgentModelManager.create_model-61"><a href="#AgentModelManager.create_model-61"><span class="linenos"> 61</span></a>            <span class="k">if</span> <span class="s2">&quot;localhost:1234&quot;</span> <span class="ow">in</span> <span class="n">lmstudio_url</span> <span class="ow">or</span> <span class="s2">&quot;1234&quot;</span> <span class="ow">in</span> <span class="n">lmstudio_url</span><span class="p">:</span>
</span><span id="AgentModelManager.create_model-62"><a href="#AgentModelManager.create_model-62"><span class="linenos"> 62</span></a>                <span class="c1"># Use LMStudio with OpenAI-compatible API</span>
</span><span id="AgentModelManager.create_model-63"><a href="#AgentModelManager.create_model-63"><span class="linenos"> 63</span></a>                <span class="c1"># Ensure the base URL has the correct /v1 endpoint for LMStudio</span>
</span><span id="AgentModelManager.create_model-64"><a href="#AgentModelManager.create_model-64"><span class="linenos"> 64</span></a>                <span class="n">base_url</span> <span class="o">=</span> <span class="n">lmstudio_url</span>
</span><span id="AgentModelManager.create_model-65"><a href="#AgentModelManager.create_model-65"><span class="linenos"> 65</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/v1&quot;</span><span class="p">):</span>
</span><span id="AgentModelManager.create_model-66"><a href="#AgentModelManager.create_model-66"><span class="linenos"> 66</span></a>                    <span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/v1&quot;</span>
</span><span id="AgentModelManager.create_model-67"><a href="#AgentModelManager.create_model-67"><span class="linenos"> 67</span></a>
</span><span id="AgentModelManager.create_model-68"><a href="#AgentModelManager.create_model-68"><span class="linenos"> 68</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using LMStudio with OpenAI-compatible API at: </span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentModelManager.create_model-69"><a href="#AgentModelManager.create_model-69"><span class="linenos"> 69</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentModelManager.create_model-70"><a href="#AgentModelManager.create_model-70"><span class="linenos"> 70</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-71"><a href="#AgentModelManager.create_model-71"><span class="linenos"> 71</span></a>                    <span class="s2">&quot;This will use /v1/chat/completions endpoint (OpenAI format)&quot;</span>
</span><span id="AgentModelManager.create_model-72"><a href="#AgentModelManager.create_model-72"><span class="linenos"> 72</span></a>                <span class="p">)</span>
</span><span id="AgentModelManager.create_model-73"><a href="#AgentModelManager.create_model-73"><span class="linenos"> 73</span></a>
</span><span id="AgentModelManager.create_model-74"><a href="#AgentModelManager.create_model-74"><span class="linenos"> 74</span></a>                <span class="c1"># Remove response_format constraint to allow native OpenAI tool calling</span>
</span><span id="AgentModelManager.create_model-75"><a href="#AgentModelManager.create_model-75"><span class="linenos"> 75</span></a>                <span class="c1"># LMStudio should support OpenAI&#39;s standard tool calling via the tools parameter</span>
</span><span id="AgentModelManager.create_model-76"><a href="#AgentModelManager.create_model-76"><span class="linenos"> 76</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">OpenAIChat</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-77"><a href="#AgentModelManager.create_model-77"><span class="linenos"> 77</span></a>                    <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-78"><a href="#AgentModelManager.create_model-78"><span class="linenos"> 78</span></a>                    <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>  <span class="c1"># Use corrected base URL with /v1 endpoint</span>
</span><span id="AgentModelManager.create_model-79"><a href="#AgentModelManager.create_model-79"><span class="linenos"> 79</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;lm-studio&quot;</span><span class="p">,</span>  <span class="c1"># LMStudio doesn&#39;t require a real API key</span>
</span><span id="AgentModelManager.create_model-80"><a href="#AgentModelManager.create_model-80"><span class="linenos"> 80</span></a>                    <span class="c1"># No request_params with response_format - let OpenAI handle tool calling natively</span>
</span><span id="AgentModelManager.create_model-81"><a href="#AgentModelManager.create_model-81"><span class="linenos"> 81</span></a>                <span class="p">)</span>
</span><span id="AgentModelManager.create_model-82"><a href="#AgentModelManager.create_model-82"><span class="linenos"> 82</span></a>
</span><span id="AgentModelManager.create_model-83"><a href="#AgentModelManager.create_model-83"><span class="linenos"> 83</span></a>                <span class="c1"># WORKAROUND: Fix incorrect role mapping in Agno framework</span>
</span><span id="AgentModelManager.create_model-84"><a href="#AgentModelManager.create_model-84"><span class="linenos"> 84</span></a>                <span class="c1"># The default_role_map incorrectly maps &quot;system&quot; -&gt; &quot;developer&quot;</span>
</span><span id="AgentModelManager.create_model-85"><a href="#AgentModelManager.create_model-85"><span class="linenos"> 85</span></a>                <span class="c1"># but OpenAI API only accepts: user, assistant, system, tool</span>
</span><span id="AgentModelManager.create_model-86"><a href="#AgentModelManager.create_model-86"><span class="linenos"> 86</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;role_map&quot;</span><span class="p">):</span>
</span><span id="AgentModelManager.create_model-87"><a href="#AgentModelManager.create_model-87"><span class="linenos"> 87</span></a>                    <span class="n">model</span><span class="o">.</span><span class="n">role_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentModelManager.create_model-88"><a href="#AgentModelManager.create_model-88"><span class="linenos"> 88</span></a>                        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>  <span class="c1"># Fix: should be &quot;system&quot;, not &quot;developer&quot;</span>
</span><span id="AgentModelManager.create_model-89"><a href="#AgentModelManager.create_model-89"><span class="linenos"> 89</span></a>                        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-90"><a href="#AgentModelManager.create_model-90"><span class="linenos"> 90</span></a>                        <span class="s2">&quot;assistant&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-91"><a href="#AgentModelManager.create_model-91"><span class="linenos"> 91</span></a>                        <span class="s2">&quot;tool&quot;</span><span class="p">:</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-92"><a href="#AgentModelManager.create_model-92"><span class="linenos"> 92</span></a>                        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-93"><a href="#AgentModelManager.create_model-93"><span class="linenos"> 93</span></a>                    <span class="p">}</span>
</span><span id="AgentModelManager.create_model-94"><a href="#AgentModelManager.create_model-94"><span class="linenos"> 94</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-95"><a href="#AgentModelManager.create_model-95"><span class="linenos"> 95</span></a>                        <span class="sa">f</span><span class="s2">&quot; Applied role mapping fix to LMStudio model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentModelManager.create_model-96"><a href="#AgentModelManager.create_model-96"><span class="linenos"> 96</span></a>                    <span class="p">)</span>
</span><span id="AgentModelManager.create_model-97"><a href="#AgentModelManager.create_model-97"><span class="linenos"> 97</span></a>
</span><span id="AgentModelManager.create_model-98"><a href="#AgentModelManager.create_model-98"><span class="linenos"> 98</span></a>                <span class="k">return</span> <span class="n">model</span>
</span><span id="AgentModelManager.create_model-99"><a href="#AgentModelManager.create_model-99"><span class="linenos"> 99</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AgentModelManager.create_model-100"><a href="#AgentModelManager.create_model-100"><span class="linenos">100</span></a>                <span class="c1"># Standard OpenAI API</span>
</span><span id="AgentModelManager.create_model-101"><a href="#AgentModelManager.create_model-101"><span class="linenos">101</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using standard OpenAI API with model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentModelManager.create_model-102"><a href="#AgentModelManager.create_model-102"><span class="linenos">102</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">OpenAIChat</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
</span><span id="AgentModelManager.create_model-103"><a href="#AgentModelManager.create_model-103"><span class="linenos">103</span></a>
</span><span id="AgentModelManager.create_model-104"><a href="#AgentModelManager.create_model-104"><span class="linenos">104</span></a>                <span class="c1"># WORKAROUND: Fix incorrect role mapping in Agno framework</span>
</span><span id="AgentModelManager.create_model-105"><a href="#AgentModelManager.create_model-105"><span class="linenos">105</span></a>                <span class="c1"># The default_role_map incorrectly maps &quot;system&quot; -&gt; &quot;developer&quot;</span>
</span><span id="AgentModelManager.create_model-106"><a href="#AgentModelManager.create_model-106"><span class="linenos">106</span></a>                <span class="c1"># but OpenAI API only accepts: user, assistant, system, tool</span>
</span><span id="AgentModelManager.create_model-107"><a href="#AgentModelManager.create_model-107"><span class="linenos">107</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;role_map&quot;</span><span class="p">):</span>
</span><span id="AgentModelManager.create_model-108"><a href="#AgentModelManager.create_model-108"><span class="linenos">108</span></a>                    <span class="n">model</span><span class="o">.</span><span class="n">role_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentModelManager.create_model-109"><a href="#AgentModelManager.create_model-109"><span class="linenos">109</span></a>                        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>  <span class="c1"># Fix: should be &quot;system&quot;, not &quot;developer&quot;</span>
</span><span id="AgentModelManager.create_model-110"><a href="#AgentModelManager.create_model-110"><span class="linenos">110</span></a>                        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-111"><a href="#AgentModelManager.create_model-111"><span class="linenos">111</span></a>                        <span class="s2">&quot;assistant&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-112"><a href="#AgentModelManager.create_model-112"><span class="linenos">112</span></a>                        <span class="s2">&quot;tool&quot;</span><span class="p">:</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-113"><a href="#AgentModelManager.create_model-113"><span class="linenos">113</span></a>                        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-114"><a href="#AgentModelManager.create_model-114"><span class="linenos">114</span></a>                    <span class="p">}</span>
</span><span id="AgentModelManager.create_model-115"><a href="#AgentModelManager.create_model-115"><span class="linenos">115</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-116"><a href="#AgentModelManager.create_model-116"><span class="linenos">116</span></a>                        <span class="sa">f</span><span class="s2">&quot; Applied role mapping fix to OpenAI model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentModelManager.create_model-117"><a href="#AgentModelManager.create_model-117"><span class="linenos">117</span></a>                    <span class="p">)</span>
</span><span id="AgentModelManager.create_model-118"><a href="#AgentModelManager.create_model-118"><span class="linenos">118</span></a>
</span><span id="AgentModelManager.create_model-119"><a href="#AgentModelManager.create_model-119"><span class="linenos">119</span></a>                <span class="k">return</span> <span class="n">model</span>
</span><span id="AgentModelManager.create_model-120"><a href="#AgentModelManager.create_model-120"><span class="linenos">120</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_provider</span> <span class="o">==</span> <span class="s2">&quot;ollama&quot;</span><span class="p">:</span>
</span><span id="AgentModelManager.create_model-121"><a href="#AgentModelManager.create_model-121"><span class="linenos">121</span></a>            <span class="c1"># Get dynamic context size for this model</span>
</span><span id="AgentModelManager.create_model-122"><a href="#AgentModelManager.create_model-122"><span class="linenos">122</span></a>            <span class="n">context_size</span><span class="p">,</span> <span class="n">detection_method</span> <span class="o">=</span> <span class="n">get_model_context_size_sync</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-123"><a href="#AgentModelManager.create_model-123"><span class="linenos">123</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ollama_base_url</span>
</span><span id="AgentModelManager.create_model-124"><a href="#AgentModelManager.create_model-124"><span class="linenos">124</span></a>            <span class="p">)</span>
</span><span id="AgentModelManager.create_model-125"><a href="#AgentModelManager.create_model-125"><span class="linenos">125</span></a>
</span><span id="AgentModelManager.create_model-126"><a href="#AgentModelManager.create_model-126"><span class="linenos">126</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-127"><a href="#AgentModelManager.create_model-127"><span class="linenos">127</span></a>                <span class="s2">&quot;Using context size </span><span class="si">%d</span><span class="s2"> for model </span><span class="si">%s</span><span class="s2"> (detected via: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-128"><a href="#AgentModelManager.create_model-128"><span class="linenos">128</span></a>                <span class="n">context_size</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-129"><a href="#AgentModelManager.create_model-129"><span class="linenos">129</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-130"><a href="#AgentModelManager.create_model-130"><span class="linenos">130</span></a>                <span class="n">detection_method</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-131"><a href="#AgentModelManager.create_model-131"><span class="linenos">131</span></a>            <span class="p">)</span>
</span><span id="AgentModelManager.create_model-132"><a href="#AgentModelManager.create_model-132"><span class="linenos">132</span></a>
</span><span id="AgentModelManager.create_model-133"><a href="#AgentModelManager.create_model-133"><span class="linenos">133</span></a>            <span class="c1"># Use standard configuration for other models</span>
</span><span id="AgentModelManager.create_model-134"><a href="#AgentModelManager.create_model-134"><span class="linenos">134</span></a>            <span class="n">model_options</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentModelManager.create_model-135"><a href="#AgentModelManager.create_model-135"><span class="linenos">135</span></a>                <span class="s2">&quot;num_ctx&quot;</span><span class="p">:</span> <span class="n">context_size</span><span class="p">,</span>  <span class="c1"># Use dynamically detected context window</span>
</span><span id="AgentModelManager.create_model-136"><a href="#AgentModelManager.create_model-136"><span class="linenos">136</span></a>                <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>  <span class="c1"># Optional: set temperature for consistency</span>
</span><span id="AgentModelManager.create_model-137"><a href="#AgentModelManager.create_model-137"><span class="linenos">137</span></a>                <span class="s2">&quot;num_predict&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Allow unlimited prediction length</span>
</span><span id="AgentModelManager.create_model-138"><a href="#AgentModelManager.create_model-138"><span class="linenos">138</span></a>                <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-139"><a href="#AgentModelManager.create_model-139"><span class="linenos">139</span></a>                <span class="s2">&quot;top_p&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-140"><a href="#AgentModelManager.create_model-140"><span class="linenos">140</span></a>                <span class="s2">&quot;repeat_penalty&quot;</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-141"><a href="#AgentModelManager.create_model-141"><span class="linenos">141</span></a>                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-142"><a href="#AgentModelManager.create_model-142"><span class="linenos">142</span></a>            <span class="p">}</span>
</span><span id="AgentModelManager.create_model-143"><a href="#AgentModelManager.create_model-143"><span class="linenos">143</span></a>
</span><span id="AgentModelManager.create_model-144"><a href="#AgentModelManager.create_model-144"><span class="linenos">144</span></a>            <span class="c1"># Special handling for qwen models with optimized parameters</span>
</span><span id="AgentModelManager.create_model-145"><a href="#AgentModelManager.create_model-145"><span class="linenos">145</span></a>            <span class="k">if</span> <span class="s2">&quot;qwen&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="AgentModelManager.create_model-146"><a href="#AgentModelManager.create_model-146"><span class="linenos">146</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-147"><a href="#AgentModelManager.create_model-147"><span class="linenos">147</span></a>                    <span class="s2">&quot;Using optimized configuration for Qwen model: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-148"><a href="#AgentModelManager.create_model-148"><span class="linenos">148</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-149"><a href="#AgentModelManager.create_model-149"><span class="linenos">149</span></a>                <span class="p">)</span>
</span><span id="AgentModelManager.create_model-150"><a href="#AgentModelManager.create_model-150"><span class="linenos">150</span></a>
</span><span id="AgentModelManager.create_model-151"><a href="#AgentModelManager.create_model-151"><span class="linenos">151</span></a>                <span class="c1"># Get Qwen settings from configuration</span>
</span><span id="AgentModelManager.create_model-152"><a href="#AgentModelManager.create_model-152"><span class="linenos">152</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AgentModelManager.create_model-153"><a href="#AgentModelManager.create_model-153"><span class="linenos">153</span></a>                    <span class="n">qwen_settings</span> <span class="o">=</span> <span class="n">get_qwen_instruct_settings</span><span class="p">()</span>
</span><span id="AgentModelManager.create_model-154"><a href="#AgentModelManager.create_model-154"><span class="linenos">154</span></a>
</span><span id="AgentModelManager.create_model-155"><a href="#AgentModelManager.create_model-155"><span class="linenos">155</span></a>                    <span class="n">model_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-156"><a href="#AgentModelManager.create_model-156"><span class="linenos">156</span></a>                        <span class="p">{</span>
</span><span id="AgentModelManager.create_model-157"><a href="#AgentModelManager.create_model-157"><span class="linenos">157</span></a>                            <span class="s2">&quot;num_predict&quot;</span><span class="p">:</span> <span class="mi">32768</span><span class="p">,</span>  <span class="c1"># Set specific prediction length for qwen</span>
</span><span id="AgentModelManager.create_model-158"><a href="#AgentModelManager.create_model-158"><span class="linenos">158</span></a>                            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="n">qwen_settings</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">],</span>
</span><span id="AgentModelManager.create_model-159"><a href="#AgentModelManager.create_model-159"><span class="linenos">159</span></a>                            <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="n">qwen_settings</span><span class="p">[</span><span class="s2">&quot;top_k&quot;</span><span class="p">],</span>
</span><span id="AgentModelManager.create_model-160"><a href="#AgentModelManager.create_model-160"><span class="linenos">160</span></a>                            <span class="s2">&quot;top_p&quot;</span><span class="p">:</span> <span class="n">qwen_settings</span><span class="p">[</span><span class="s2">&quot;top_p&quot;</span><span class="p">],</span>
</span><span id="AgentModelManager.create_model-161"><a href="#AgentModelManager.create_model-161"><span class="linenos">161</span></a>                            <span class="s2">&quot;min_p&quot;</span><span class="p">:</span> <span class="n">qwen_settings</span><span class="p">[</span><span class="s2">&quot;min_p&quot;</span><span class="p">],</span>
</span><span id="AgentModelManager.create_model-162"><a href="#AgentModelManager.create_model-162"><span class="linenos">162</span></a>                            <span class="s2">&quot;repeat_penalty&quot;</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-163"><a href="#AgentModelManager.create_model-163"><span class="linenos">163</span></a>                        <span class="p">}</span>
</span><span id="AgentModelManager.create_model-164"><a href="#AgentModelManager.create_model-164"><span class="linenos">164</span></a>                    <span class="p">)</span>
</span><span id="AgentModelManager.create_model-165"><a href="#AgentModelManager.create_model-165"><span class="linenos">165</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AgentModelManager.create_model-166"><a href="#AgentModelManager.create_model-166"><span class="linenos">166</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load Qwen settings, using defaults: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AgentModelManager.create_model-167"><a href="#AgentModelManager.create_model-167"><span class="linenos">167</span></a>                    <span class="c1"># Fallback to original hardcoded values</span>
</span><span id="AgentModelManager.create_model-168"><a href="#AgentModelManager.create_model-168"><span class="linenos">168</span></a>                    <span class="n">model_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-169"><a href="#AgentModelManager.create_model-169"><span class="linenos">169</span></a>                        <span class="p">{</span>
</span><span id="AgentModelManager.create_model-170"><a href="#AgentModelManager.create_model-170"><span class="linenos">170</span></a>                            <span class="s2">&quot;num_predict&quot;</span><span class="p">:</span> <span class="mi">32768</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-171"><a href="#AgentModelManager.create_model-171"><span class="linenos">171</span></a>                            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-172"><a href="#AgentModelManager.create_model-172"><span class="linenos">172</span></a>                            <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-173"><a href="#AgentModelManager.create_model-173"><span class="linenos">173</span></a>                            <span class="s2">&quot;top_p&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-174"><a href="#AgentModelManager.create_model-174"><span class="linenos">174</span></a>                            <span class="s2">&quot;min_p&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-175"><a href="#AgentModelManager.create_model-175"><span class="linenos">175</span></a>                            <span class="s2">&quot;repeat_penalty&quot;</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-176"><a href="#AgentModelManager.create_model-176"><span class="linenos">176</span></a>                        <span class="p">}</span>
</span><span id="AgentModelManager.create_model-177"><a href="#AgentModelManager.create_model-177"><span class="linenos">177</span></a>                    <span class="p">)</span>
</span><span id="AgentModelManager.create_model-178"><a href="#AgentModelManager.create_model-178"><span class="linenos">178</span></a>
</span><span id="AgentModelManager.create_model-179"><a href="#AgentModelManager.create_model-179"><span class="linenos">179</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="AgentModelManager.create_model-180"><a href="#AgentModelManager.create_model-180"><span class="linenos">180</span></a>                <span class="s2">&quot;llama3.1&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AgentModelManager.create_model-181"><a href="#AgentModelManager.create_model-181"><span class="linenos">181</span></a>                <span class="ow">or</span> <span class="s2">&quot;llama3.2&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AgentModelManager.create_model-182"><a href="#AgentModelManager.create_model-182"><span class="linenos">182</span></a>                <span class="ow">or</span> <span class="s2">&quot;llama3.3&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AgentModelManager.create_model-183"><a href="#AgentModelManager.create_model-183"><span class="linenos">183</span></a>            <span class="p">):</span>
</span><span id="AgentModelManager.create_model-184"><a href="#AgentModelManager.create_model-184"><span class="linenos">184</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-185"><a href="#AgentModelManager.create_model-185"><span class="linenos">185</span></a>                    <span class="s2">&quot;Using optimized configuration for Llama 3.x model: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-186"><a href="#AgentModelManager.create_model-186"><span class="linenos">186</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-187"><a href="#AgentModelManager.create_model-187"><span class="linenos">187</span></a>                <span class="p">)</span>
</span><span id="AgentModelManager.create_model-188"><a href="#AgentModelManager.create_model-188"><span class="linenos">188</span></a>                <span class="n">model_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-189"><a href="#AgentModelManager.create_model-189"><span class="linenos">189</span></a>                    <span class="p">{</span>
</span><span id="AgentModelManager.create_model-190"><a href="#AgentModelManager.create_model-190"><span class="linenos">190</span></a>                        <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="AgentModelManager.create_model-191"><a href="#AgentModelManager.create_model-191"><span class="linenos">191</span></a>                            <span class="s2">&quot;&lt;|start_header_id|&gt;&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-192"><a href="#AgentModelManager.create_model-192"><span class="linenos">192</span></a>                            <span class="s2">&quot;&lt;|end_header_id|&gt;&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-193"><a href="#AgentModelManager.create_model-193"><span class="linenos">193</span></a>                            <span class="s2">&quot;&lt;|eot_id|&gt;&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-194"><a href="#AgentModelManager.create_model-194"><span class="linenos">194</span></a>                        <span class="p">],</span>
</span><span id="AgentModelManager.create_model-195"><a href="#AgentModelManager.create_model-195"><span class="linenos">195</span></a>                    <span class="p">}</span>
</span><span id="AgentModelManager.create_model-196"><a href="#AgentModelManager.create_model-196"><span class="linenos">196</span></a>                <span class="p">)</span>
</span><span id="AgentModelManager.create_model-197"><a href="#AgentModelManager.create_model-197"><span class="linenos">197</span></a>
</span><span id="AgentModelManager.create_model-198"><a href="#AgentModelManager.create_model-198"><span class="linenos">198</span></a>            <span class="c1"># Add reasoning support for compatible models</span>
</span><span id="AgentModelManager.create_model-199"><a href="#AgentModelManager.create_model-199"><span class="linenos">199</span></a>            <span class="n">reasoning_models</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AgentModelManager.create_model-200"><a href="#AgentModelManager.create_model-200"><span class="linenos">200</span></a>                <span class="s2">&quot;o1&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-201"><a href="#AgentModelManager.create_model-201"><span class="linenos">201</span></a>                <span class="s2">&quot;o1-preview&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-202"><a href="#AgentModelManager.create_model-202"><span class="linenos">202</span></a>                <span class="s2">&quot;o1-mini&quot;</span><span class="p">,</span>  <span class="c1"># OpenAI reasoning models</span>
</span><span id="AgentModelManager.create_model-203"><a href="#AgentModelManager.create_model-203"><span class="linenos">203</span></a>                <span class="s2">&quot;qwen3:8b&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-204"><a href="#AgentModelManager.create_model-204"><span class="linenos">204</span></a>                <span class="s2">&quot;qwen3:1.7b&quot;</span><span class="p">,</span>  <span class="c1"># Fixed: lowercase &#39;b&#39; to match model_contexts.py</span>
</span><span id="AgentModelManager.create_model-205"><a href="#AgentModelManager.create_model-205"><span class="linenos">205</span></a>                <span class="s2">&quot;qwen3:4b&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-206"><a href="#AgentModelManager.create_model-206"><span class="linenos">206</span></a>                <span class="s2">&quot;qwen3-4b-instruct&quot;</span><span class="p">,</span>  <span class="c1"># New Qwen model variants</span>
</span><span id="AgentModelManager.create_model-207"><a href="#AgentModelManager.create_model-207"><span class="linenos">207</span></a>                <span class="s2">&quot;hf.co/unsloth/qwen3-4b-instruct&quot;</span><span class="p">,</span>  <span class="c1"># HuggingFace Qwen model from settings</span>
</span><span id="AgentModelManager.create_model-208"><a href="#AgentModelManager.create_model-208"><span class="linenos">208</span></a>                <span class="s2">&quot;qwq&quot;</span><span class="p">,</span>  <span class="c1"># Qwen reasoning models</span>
</span><span id="AgentModelManager.create_model-209"><a href="#AgentModelManager.create_model-209"><span class="linenos">209</span></a>                <span class="s2">&quot;deepseek-r1&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-210"><a href="#AgentModelManager.create_model-210"><span class="linenos">210</span></a>                <span class="s2">&quot;deepseek-reasoner&quot;</span><span class="p">,</span>  <span class="c1"># DeepSeek reasoning models</span>
</span><span id="AgentModelManager.create_model-211"><a href="#AgentModelManager.create_model-211"><span class="linenos">211</span></a>                <span class="s2">&quot;llama3.2&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-212"><a href="#AgentModelManager.create_model-212"><span class="linenos">212</span></a>                <span class="s2">&quot;llama3.3&quot;</span><span class="p">,</span>  <span class="c1"># Recent Llama models with reasoning</span>
</span><span id="AgentModelManager.create_model-213"><a href="#AgentModelManager.create_model-213"><span class="linenos">213</span></a>                <span class="s2">&quot;mistral&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-214"><a href="#AgentModelManager.create_model-214"><span class="linenos">214</span></a>                <span class="s2">&quot;mixtral&quot;</span><span class="p">,</span>  <span class="c1"># Mistral models with reasoning capabilities</span>
</span><span id="AgentModelManager.create_model-215"><a href="#AgentModelManager.create_model-215"><span class="linenos">215</span></a>            <span class="p">]</span>
</span><span id="AgentModelManager.create_model-216"><a href="#AgentModelManager.create_model-216"><span class="linenos">216</span></a>
</span><span id="AgentModelManager.create_model-217"><a href="#AgentModelManager.create_model-217"><span class="linenos">217</span></a>            <span class="c1"># Check if current model supports reasoning</span>
</span><span id="AgentModelManager.create_model-218"><a href="#AgentModelManager.create_model-218"><span class="linenos">218</span></a>            <span class="n">model_supports_reasoning</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-219"><a href="#AgentModelManager.create_model-219"><span class="linenos">219</span></a>                <span class="n">reasoning_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AgentModelManager.create_model-220"><a href="#AgentModelManager.create_model-220"><span class="linenos">220</span></a>                <span class="k">for</span> <span class="n">reasoning_model</span> <span class="ow">in</span> <span class="n">reasoning_models</span>
</span><span id="AgentModelManager.create_model-221"><a href="#AgentModelManager.create_model-221"><span class="linenos">221</span></a>            <span class="p">)</span>
</span><span id="AgentModelManager.create_model-222"><a href="#AgentModelManager.create_model-222"><span class="linenos">222</span></a>
</span><span id="AgentModelManager.create_model-223"><a href="#AgentModelManager.create_model-223"><span class="linenos">223</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">Ollama</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-224"><a href="#AgentModelManager.create_model-224"><span class="linenos">224</span></a>                <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-225"><a href="#AgentModelManager.create_model-225"><span class="linenos">225</span></a>                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ollama_base_url</span><span class="p">,</span>  <span class="c1"># Use host parameter for Ollama</span>
</span><span id="AgentModelManager.create_model-226"><a href="#AgentModelManager.create_model-226"><span class="linenos">226</span></a>                <span class="n">options</span><span class="o">=</span><span class="n">model_options</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-227"><a href="#AgentModelManager.create_model-227"><span class="linenos">227</span></a>            <span class="p">)</span>
</span><span id="AgentModelManager.create_model-228"><a href="#AgentModelManager.create_model-228"><span class="linenos">228</span></a>
</span><span id="AgentModelManager.create_model-229"><a href="#AgentModelManager.create_model-229"><span class="linenos">229</span></a>            <span class="c1"># WORKAROUND: Fix incorrect role mapping in Agno framework</span>
</span><span id="AgentModelManager.create_model-230"><a href="#AgentModelManager.create_model-230"><span class="linenos">230</span></a>            <span class="c1"># The default_role_map incorrectly maps &quot;system&quot; -&gt; &quot;developer&quot;</span>
</span><span id="AgentModelManager.create_model-231"><a href="#AgentModelManager.create_model-231"><span class="linenos">231</span></a>            <span class="c1"># but OpenAI API only accepts: user, assistant, system, tool</span>
</span><span id="AgentModelManager.create_model-232"><a href="#AgentModelManager.create_model-232"><span class="linenos">232</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;role_map&quot;</span><span class="p">):</span>
</span><span id="AgentModelManager.create_model-233"><a href="#AgentModelManager.create_model-233"><span class="linenos">233</span></a>                <span class="n">model</span><span class="o">.</span><span class="n">role_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AgentModelManager.create_model-234"><a href="#AgentModelManager.create_model-234"><span class="linenos">234</span></a>                    <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>  <span class="c1"># Fix: should be &quot;system&quot;, not &quot;developer&quot;</span>
</span><span id="AgentModelManager.create_model-235"><a href="#AgentModelManager.create_model-235"><span class="linenos">235</span></a>                    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-236"><a href="#AgentModelManager.create_model-236"><span class="linenos">236</span></a>                    <span class="s2">&quot;assistant&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-237"><a href="#AgentModelManager.create_model-237"><span class="linenos">237</span></a>                    <span class="s2">&quot;tool&quot;</span><span class="p">:</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-238"><a href="#AgentModelManager.create_model-238"><span class="linenos">238</span></a>                    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="AgentModelManager.create_model-239"><a href="#AgentModelManager.create_model-239"><span class="linenos">239</span></a>                <span class="p">}</span>
</span><span id="AgentModelManager.create_model-240"><a href="#AgentModelManager.create_model-240"><span class="linenos">240</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AgentModelManager.create_model-241"><a href="#AgentModelManager.create_model-241"><span class="linenos">241</span></a>                    <span class="sa">f</span><span class="s2">&quot; Applied role mapping fix to Ollama model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AgentModelManager.create_model-242"><a href="#AgentModelManager.create_model-242"><span class="linenos">242</span></a>                <span class="p">)</span>
</span><span id="AgentModelManager.create_model-243"><a href="#AgentModelManager.create_model-243"><span class="linenos">243</span></a>
</span><span id="AgentModelManager.create_model-244"><a href="#AgentModelManager.create_model-244"><span class="linenos">244</span></a>            <span class="k">return</span> <span class="n">model</span>
</span><span id="AgentModelManager.create_model-245"><a href="#AgentModelManager.create_model-245"><span class="linenos">245</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AgentModelManager.create_model-246"><a href="#AgentModelManager.create_model-246"><span class="linenos">246</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported model provider: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_provider</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create the appropriate model instance based on provider.</p>

<p>Returns:
    Configured model instance (uses regular Ollama for Qwen3 compatibility)</p>

<p>Raises:
    ValueError: If unsupported model provider is specified</p>
</div>


                            </div>
                </section>
                <section id="MultiAgentSystem">
                            <input id="MultiAgentSystem-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MultiAgentSystem</span>:

                <label class="view-source-button" for="MultiAgentSystem-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiAgentSystem"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiAgentSystem-56"><a href="#MultiAgentSystem-56"><span class="linenos"> 56</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MultiAgentSystem</span><span class="p">:</span>
</span><span id="MultiAgentSystem-57"><a href="#MultiAgentSystem-57"><span class="linenos"> 57</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-58"><a href="#MultiAgentSystem-58"><span class="linenos"> 58</span></a><span class="sd">    Multi-agent system with specialized tools for different domains.</span>
</span><span id="MultiAgentSystem-59"><a href="#MultiAgentSystem-59"><span class="linenos"> 59</span></a>
</span><span id="MultiAgentSystem-60"><a href="#MultiAgentSystem-60"><span class="linenos"> 60</span></a><span class="sd">    This system uses CodeAgent as a coordinator with all tools available directly:</span>
</span><span id="MultiAgentSystem-61"><a href="#MultiAgentSystem-61"><span class="linenos"> 61</span></a><span class="sd">    - Filesystem operations: File reading, writing, directory listing</span>
</span><span id="MultiAgentSystem-62"><a href="#MultiAgentSystem-62"><span class="linenos"> 62</span></a><span class="sd">    - Research operations: Web search, GitHub search, comprehensive research</span>
</span><span id="MultiAgentSystem-63"><a href="#MultiAgentSystem-63"><span class="linenos"> 63</span></a><span class="sd">    - Memory operations: Knowledge base storage and retrieval</span>
</span><span id="MultiAgentSystem-64"><a href="#MultiAgentSystem-64"><span class="linenos"> 64</span></a><span class="sd">    - System operations: Shell commands and system tasks</span>
</span><span id="MultiAgentSystem-65"><a href="#MultiAgentSystem-65"><span class="linenos"> 65</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-66"><a href="#MultiAgentSystem-66"><span class="linenos"> 66</span></a>
</span><span id="MultiAgentSystem-67"><a href="#MultiAgentSystem-67"><span class="linenos"> 67</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="MultiAgentSystem-68"><a href="#MultiAgentSystem-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MultiAgentSystem-69"><a href="#MultiAgentSystem-69"><span class="linenos"> 69</span></a>        <span class="n">mcp_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiAgentSystem-70"><a href="#MultiAgentSystem-70"><span class="linenos"> 70</span></a>        <span class="n">weaviate_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiAgentSystem-71"><a href="#MultiAgentSystem-71"><span class="linenos"> 71</span></a>        <span class="n">vector_store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiAgentSystem-72"><a href="#MultiAgentSystem-72"><span class="linenos"> 72</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LiteLLMModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MultiAgentSystem-73"><a href="#MultiAgentSystem-73"><span class="linenos"> 73</span></a>    <span class="p">):</span>
</span><span id="MultiAgentSystem-74"><a href="#MultiAgentSystem-74"><span class="linenos"> 74</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-75"><a href="#MultiAgentSystem-75"><span class="linenos"> 75</span></a><span class="sd">        Initialize the multi-agent system.</span>
</span><span id="MultiAgentSystem-76"><a href="#MultiAgentSystem-76"><span class="linenos"> 76</span></a>
</span><span id="MultiAgentSystem-77"><a href="#MultiAgentSystem-77"><span class="linenos"> 77</span></a><span class="sd">        Args:</span>
</span><span id="MultiAgentSystem-78"><a href="#MultiAgentSystem-78"><span class="linenos"> 78</span></a><span class="sd">            mcp_client: MCP client instance for tool functionality</span>
</span><span id="MultiAgentSystem-79"><a href="#MultiAgentSystem-79"><span class="linenos"> 79</span></a><span class="sd">            weaviate_client: Weaviate client for memory functionality</span>
</span><span id="MultiAgentSystem-80"><a href="#MultiAgentSystem-80"><span class="linenos"> 80</span></a><span class="sd">            vector_store: Vector store for memory operations</span>
</span><span id="MultiAgentSystem-81"><a href="#MultiAgentSystem-81"><span class="linenos"> 81</span></a><span class="sd">            model: Optional LiteLLM model instance</span>
</span><span id="MultiAgentSystem-82"><a href="#MultiAgentSystem-82"><span class="linenos"> 82</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-83"><a href="#MultiAgentSystem-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span> <span class="ow">or</span> <span class="n">create_smolagents_model</span><span class="p">()</span>
</span><span id="MultiAgentSystem-84"><a href="#MultiAgentSystem-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mcp_client</span> <span class="o">=</span> <span class="n">mcp_client</span>
</span><span id="MultiAgentSystem-85"><a href="#MultiAgentSystem-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weaviate_client</span> <span class="o">=</span> <span class="n">weaviate_client</span>
</span><span id="MultiAgentSystem-86"><a href="#MultiAgentSystem-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span> <span class="o">=</span> <span class="n">vector_store</span>
</span><span id="MultiAgentSystem-87"><a href="#MultiAgentSystem-87"><span class="linenos"> 87</span></a>
</span><span id="MultiAgentSystem-88"><a href="#MultiAgentSystem-88"><span class="linenos"> 88</span></a>        <span class="c1"># Set up global dependencies for tools</span>
</span><span id="MultiAgentSystem-89"><a href="#MultiAgentSystem-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="n">mcp_client</span><span class="p">:</span>
</span><span id="MultiAgentSystem-90"><a href="#MultiAgentSystem-90"><span class="linenos"> 90</span></a>            <span class="n">set_mcp_client</span><span class="p">(</span><span class="n">mcp_client</span><span class="p">)</span>
</span><span id="MultiAgentSystem-91"><a href="#MultiAgentSystem-91"><span class="linenos"> 91</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MCP client set for multi-agent tools&quot;</span><span class="p">)</span>
</span><span id="MultiAgentSystem-92"><a href="#MultiAgentSystem-92"><span class="linenos"> 92</span></a>
</span><span id="MultiAgentSystem-93"><a href="#MultiAgentSystem-93"><span class="linenos"> 93</span></a>        <span class="k">if</span> <span class="n">weaviate_client</span> <span class="ow">and</span> <span class="n">vector_store</span><span class="p">:</span>
</span><span id="MultiAgentSystem-94"><a href="#MultiAgentSystem-94"><span class="linenos"> 94</span></a>            <span class="n">set_memory_components</span><span class="p">(</span><span class="n">weaviate_client</span><span class="p">,</span> <span class="n">vector_store</span><span class="p">,</span> <span class="n">USE_WEAVIATE</span><span class="p">)</span>
</span><span id="MultiAgentSystem-95"><a href="#MultiAgentSystem-95"><span class="linenos"> 95</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Memory components set for multi-agent tools&quot;</span><span class="p">)</span>
</span><span id="MultiAgentSystem-96"><a href="#MultiAgentSystem-96"><span class="linenos"> 96</span></a>
</span><span id="MultiAgentSystem-97"><a href="#MultiAgentSystem-97"><span class="linenos"> 97</span></a>        <span class="c1"># Create specialized tool groups</span>
</span><span id="MultiAgentSystem-98"><a href="#MultiAgentSystem-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tool_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_tool_groups</span><span class="p">()</span>
</span><span id="MultiAgentSystem-99"><a href="#MultiAgentSystem-99"><span class="linenos"> 99</span></a>
</span><span id="MultiAgentSystem-100"><a href="#MultiAgentSystem-100"><span class="linenos">100</span></a>        <span class="c1"># Create the intelligent routing agent</span>
</span><span id="MultiAgentSystem-101"><a href="#MultiAgentSystem-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_routing_agent</span><span class="p">()</span>
</span><span id="MultiAgentSystem-102"><a href="#MultiAgentSystem-102"><span class="linenos">102</span></a>
</span><span id="MultiAgentSystem-103"><a href="#MultiAgentSystem-103"><span class="linenos">103</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Multi-agent system initialized with CodeAgent coordinator&quot;</span><span class="p">)</span>
</span><span id="MultiAgentSystem-104"><a href="#MultiAgentSystem-104"><span class="linenos">104</span></a>
</span><span id="MultiAgentSystem-105"><a href="#MultiAgentSystem-105"><span class="linenos">105</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_tool_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
</span><span id="MultiAgentSystem-106"><a href="#MultiAgentSystem-106"><span class="linenos">106</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-107"><a href="#MultiAgentSystem-107"><span class="linenos">107</span></a><span class="sd">        Create specialized tool groups for different domains.</span>
</span><span id="MultiAgentSystem-108"><a href="#MultiAgentSystem-108"><span class="linenos">108</span></a>
</span><span id="MultiAgentSystem-109"><a href="#MultiAgentSystem-109"><span class="linenos">109</span></a><span class="sd">        :return: Dictionary of tool groups by domain</span>
</span><span id="MultiAgentSystem-110"><a href="#MultiAgentSystem-110"><span class="linenos">110</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-111"><a href="#MultiAgentSystem-111"><span class="linenos">111</span></a>        <span class="n">tool_groups</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MultiAgentSystem-112"><a href="#MultiAgentSystem-112"><span class="linenos">112</span></a>
</span><span id="MultiAgentSystem-113"><a href="#MultiAgentSystem-113"><span class="linenos">113</span></a>        <span class="c1"># Filesystem tools</span>
</span><span id="MultiAgentSystem-114"><a href="#MultiAgentSystem-114"><span class="linenos">114</span></a>        <span class="n">tool_groups</span><span class="p">[</span><span class="s2">&quot;filesystem&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MultiAgentSystem-115"><a href="#MultiAgentSystem-115"><span class="linenos">115</span></a>            <span class="n">mcp_read_file</span><span class="p">,</span>
</span><span id="MultiAgentSystem-116"><a href="#MultiAgentSystem-116"><span class="linenos">116</span></a>            <span class="n">mcp_write_file</span><span class="p">,</span>
</span><span id="MultiAgentSystem-117"><a href="#MultiAgentSystem-117"><span class="linenos">117</span></a>            <span class="n">mcp_list_directory</span><span class="p">,</span>
</span><span id="MultiAgentSystem-118"><a href="#MultiAgentSystem-118"><span class="linenos">118</span></a>            <span class="n">mcp_create_directory</span><span class="p">,</span>
</span><span id="MultiAgentSystem-119"><a href="#MultiAgentSystem-119"><span class="linenos">119</span></a>            <span class="n">intelligent_file_search</span><span class="p">,</span>
</span><span id="MultiAgentSystem-120"><a href="#MultiAgentSystem-120"><span class="linenos">120</span></a>        <span class="p">]</span>
</span><span id="MultiAgentSystem-121"><a href="#MultiAgentSystem-121"><span class="linenos">121</span></a>
</span><span id="MultiAgentSystem-122"><a href="#MultiAgentSystem-122"><span class="linenos">122</span></a>        <span class="c1"># Research tools</span>
</span><span id="MultiAgentSystem-123"><a href="#MultiAgentSystem-123"><span class="linenos">123</span></a>        <span class="n">tool_groups</span><span class="p">[</span><span class="s2">&quot;research&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MultiAgentSystem-124"><a href="#MultiAgentSystem-124"><span class="linenos">124</span></a>            <span class="n">web_search</span><span class="p">,</span>
</span><span id="MultiAgentSystem-125"><a href="#MultiAgentSystem-125"><span class="linenos">125</span></a>            <span class="n">github_search_repositories</span><span class="p">,</span>
</span><span id="MultiAgentSystem-126"><a href="#MultiAgentSystem-126"><span class="linenos">126</span></a>            <span class="n">comprehensive_research</span><span class="p">,</span>
</span><span id="MultiAgentSystem-127"><a href="#MultiAgentSystem-127"><span class="linenos">127</span></a>            <span class="n">get_news_headlines</span><span class="p">,</span>
</span><span id="MultiAgentSystem-128"><a href="#MultiAgentSystem-128"><span class="linenos">128</span></a>            <span class="n">get_weather</span><span class="p">,</span>
</span><span id="MultiAgentSystem-129"><a href="#MultiAgentSystem-129"><span class="linenos">129</span></a>        <span class="p">]</span>
</span><span id="MultiAgentSystem-130"><a href="#MultiAgentSystem-130"><span class="linenos">130</span></a>
</span><span id="MultiAgentSystem-131"><a href="#MultiAgentSystem-131"><span class="linenos">131</span></a>        <span class="c1"># Memory tools (if available)</span>
</span><span id="MultiAgentSystem-132"><a href="#MultiAgentSystem-132"><span class="linenos">132</span></a>        <span class="k">if</span> <span class="n">USE_WEAVIATE</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">weaviate_client</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span><span class="p">:</span>
</span><span id="MultiAgentSystem-133"><a href="#MultiAgentSystem-133"><span class="linenos">133</span></a>            <span class="n">tool_groups</span><span class="p">[</span><span class="s2">&quot;memory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MultiAgentSystem-134"><a href="#MultiAgentSystem-134"><span class="linenos">134</span></a>                <span class="n">store_interaction</span><span class="p">,</span>
</span><span id="MultiAgentSystem-135"><a href="#MultiAgentSystem-135"><span class="linenos">135</span></a>                <span class="n">query_knowledge_base</span><span class="p">,</span>
</span><span id="MultiAgentSystem-136"><a href="#MultiAgentSystem-136"><span class="linenos">136</span></a>                <span class="n">clear_knowledge_base</span><span class="p">,</span>
</span><span id="MultiAgentSystem-137"><a href="#MultiAgentSystem-137"><span class="linenos">137</span></a>            <span class="p">]</span>
</span><span id="MultiAgentSystem-138"><a href="#MultiAgentSystem-138"><span class="linenos">138</span></a>
</span><span id="MultiAgentSystem-139"><a href="#MultiAgentSystem-139"><span class="linenos">139</span></a>        <span class="c1"># System tools</span>
</span><span id="MultiAgentSystem-140"><a href="#MultiAgentSystem-140"><span class="linenos">140</span></a>        <span class="n">tool_groups</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">shell_command</span><span class="p">]</span>
</span><span id="MultiAgentSystem-141"><a href="#MultiAgentSystem-141"><span class="linenos">141</span></a>        <span class="c1"># Fun tools</span>
</span><span id="MultiAgentSystem-142"><a href="#MultiAgentSystem-142"><span class="linenos">142</span></a>        <span class="n">tool_groups</span><span class="p">[</span><span class="s2">&quot;fun&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_joke</span><span class="p">,</span> <span class="n">get_random_fact</span><span class="p">]</span>
</span><span id="MultiAgentSystem-143"><a href="#MultiAgentSystem-143"><span class="linenos">143</span></a>
</span><span id="MultiAgentSystem-144"><a href="#MultiAgentSystem-144"><span class="linenos">144</span></a>        <span class="k">return</span> <span class="n">tool_groups</span>
</span><span id="MultiAgentSystem-145"><a href="#MultiAgentSystem-145"><span class="linenos">145</span></a>
</span><span id="MultiAgentSystem-146"><a href="#MultiAgentSystem-146"><span class="linenos">146</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_routing_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CodeAgent</span><span class="p">:</span>
</span><span id="MultiAgentSystem-147"><a href="#MultiAgentSystem-147"><span class="linenos">147</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-148"><a href="#MultiAgentSystem-148"><span class="linenos">148</span></a><span class="sd">        Create the routing agent that coordinates all tools directly.</span>
</span><span id="MultiAgentSystem-149"><a href="#MultiAgentSystem-149"><span class="linenos">149</span></a>
</span><span id="MultiAgentSystem-150"><a href="#MultiAgentSystem-150"><span class="linenos">150</span></a><span class="sd">        :return: Configured CodeAgent as coordinator</span>
</span><span id="MultiAgentSystem-151"><a href="#MultiAgentSystem-151"><span class="linenos">151</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-152"><a href="#MultiAgentSystem-152"><span class="linenos">152</span></a>        <span class="c1"># Combine all tools from all groups</span>
</span><span id="MultiAgentSystem-153"><a href="#MultiAgentSystem-153"><span class="linenos">153</span></a>        <span class="n">all_tools</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiAgentSystem-154"><a href="#MultiAgentSystem-154"><span class="linenos">154</span></a>        <span class="k">for</span> <span class="n">tools</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_groups</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="MultiAgentSystem-155"><a href="#MultiAgentSystem-155"><span class="linenos">155</span></a>            <span class="n">all_tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
</span><span id="MultiAgentSystem-156"><a href="#MultiAgentSystem-156"><span class="linenos">156</span></a>
</span><span id="MultiAgentSystem-157"><a href="#MultiAgentSystem-157"><span class="linenos">157</span></a>        <span class="c1"># Create the coordinating agent with all tools</span>
</span><span id="MultiAgentSystem-158"><a href="#MultiAgentSystem-158"><span class="linenos">158</span></a>        <span class="n">agent</span> <span class="o">=</span> <span class="n">CodeAgent</span><span class="p">(</span>
</span><span id="MultiAgentSystem-159"><a href="#MultiAgentSystem-159"><span class="linenos">159</span></a>            <span class="n">tools</span><span class="o">=</span><span class="n">all_tools</span><span class="p">,</span>
</span><span id="MultiAgentSystem-160"><a href="#MultiAgentSystem-160"><span class="linenos">160</span></a>            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="MultiAgentSystem-161"><a href="#MultiAgentSystem-161"><span class="linenos">161</span></a>            <span class="n">additional_authorized_imports</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;re&quot;</span><span class="p">,</span> <span class="s2">&quot;os&quot;</span><span class="p">],</span>
</span><span id="MultiAgentSystem-162"><a href="#MultiAgentSystem-162"><span class="linenos">162</span></a>            <span class="n">stream_outputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MultiAgentSystem-163"><a href="#MultiAgentSystem-163"><span class="linenos">163</span></a>            <span class="n">description</span><span class="o">=</span><span class="p">(</span>
</span><span id="MultiAgentSystem-164"><a href="#MultiAgentSystem-164"><span class="linenos">164</span></a>                <span class="s2">&quot;This agent coordinates multiple specialized tools for different domains. &quot;</span>
</span><span id="MultiAgentSystem-165"><a href="#MultiAgentSystem-165"><span class="linenos">165</span></a>                <span class="s2">&quot;It can handle filesystem operations, web research, memory management, &quot;</span>
</span><span id="MultiAgentSystem-166"><a href="#MultiAgentSystem-166"><span class="linenos">166</span></a>                <span class="s2">&quot;system commands, and fun tasks. Available specialists:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="MultiAgentSystem-167"><a href="#MultiAgentSystem-167"><span class="linenos">167</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_specialist_descriptions</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="MultiAgentSystem-168"><a href="#MultiAgentSystem-168"><span class="linenos">168</span></a>            <span class="p">),</span>
</span><span id="MultiAgentSystem-169"><a href="#MultiAgentSystem-169"><span class="linenos">169</span></a>        <span class="p">)</span>
</span><span id="MultiAgentSystem-170"><a href="#MultiAgentSystem-170"><span class="linenos">170</span></a>
</span><span id="MultiAgentSystem-171"><a href="#MultiAgentSystem-171"><span class="linenos">171</span></a>        <span class="k">return</span> <span class="n">agent</span>
</span><span id="MultiAgentSystem-172"><a href="#MultiAgentSystem-172"><span class="linenos">172</span></a>
</span><span id="MultiAgentSystem-173"><a href="#MultiAgentSystem-173"><span class="linenos">173</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_specialist_descriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="MultiAgentSystem-174"><a href="#MultiAgentSystem-174"><span class="linenos">174</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-175"><a href="#MultiAgentSystem-175"><span class="linenos">175</span></a><span class="sd">        Get descriptions of all available specialists.</span>
</span><span id="MultiAgentSystem-176"><a href="#MultiAgentSystem-176"><span class="linenos">176</span></a>
</span><span id="MultiAgentSystem-177"><a href="#MultiAgentSystem-177"><span class="linenos">177</span></a><span class="sd">        :return: Formatted string describing all specialists</span>
</span><span id="MultiAgentSystem-178"><a href="#MultiAgentSystem-178"><span class="linenos">178</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-179"><a href="#MultiAgentSystem-179"><span class="linenos">179</span></a>        <span class="n">descriptions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiAgentSystem-180"><a href="#MultiAgentSystem-180"><span class="linenos">180</span></a>        <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">tools</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="MultiAgentSystem-181"><a href="#MultiAgentSystem-181"><span class="linenos">181</span></a>            <span class="k">if</span> <span class="n">tools</span><span class="p">:</span>
</span><span id="MultiAgentSystem-182"><a href="#MultiAgentSystem-182"><span class="linenos">182</span></a>                <span class="n">tool_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
</span><span id="MultiAgentSystem-183"><a href="#MultiAgentSystem-183"><span class="linenos">183</span></a>                <span class="n">descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tool_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MultiAgentSystem-184"><a href="#MultiAgentSystem-184"><span class="linenos">184</span></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">descriptions</span><span class="p">)</span>
</span><span id="MultiAgentSystem-185"><a href="#MultiAgentSystem-185"><span class="linenos">185</span></a>
</span><span id="MultiAgentSystem-186"><a href="#MultiAgentSystem-186"><span class="linenos">186</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="MultiAgentSystem-187"><a href="#MultiAgentSystem-187"><span class="linenos">187</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-188"><a href="#MultiAgentSystem-188"><span class="linenos">188</span></a><span class="sd">        Process a query using the multi-agent system.</span>
</span><span id="MultiAgentSystem-189"><a href="#MultiAgentSystem-189"><span class="linenos">189</span></a>
</span><span id="MultiAgentSystem-190"><a href="#MultiAgentSystem-190"><span class="linenos">190</span></a><span class="sd">        Args:</span>
</span><span id="MultiAgentSystem-191"><a href="#MultiAgentSystem-191"><span class="linenos">191</span></a><span class="sd">            query: User query to process</span>
</span><span id="MultiAgentSystem-192"><a href="#MultiAgentSystem-192"><span class="linenos">192</span></a>
</span><span id="MultiAgentSystem-193"><a href="#MultiAgentSystem-193"><span class="linenos">193</span></a><span class="sd">        :return: Response from the coordinated agent system</span>
</span><span id="MultiAgentSystem-194"><a href="#MultiAgentSystem-194"><span class="linenos">194</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-195"><a href="#MultiAgentSystem-195"><span class="linenos">195</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing query with multi-agent system: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>
</span><span id="MultiAgentSystem-196"><a href="#MultiAgentSystem-196"><span class="linenos">196</span></a>
</span><span id="MultiAgentSystem-197"><a href="#MultiAgentSystem-197"><span class="linenos">197</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MultiAgentSystem-198"><a href="#MultiAgentSystem-198"><span class="linenos">198</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="MultiAgentSystem-199"><a href="#MultiAgentSystem-199"><span class="linenos">199</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Multi-agent system completed query successfully&quot;</span><span class="p">)</span>
</span><span id="MultiAgentSystem-200"><a href="#MultiAgentSystem-200"><span class="linenos">200</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="MultiAgentSystem-201"><a href="#MultiAgentSystem-201"><span class="linenos">201</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MultiAgentSystem-202"><a href="#MultiAgentSystem-202"><span class="linenos">202</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in multi-agent system: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="MultiAgentSystem-203"><a href="#MultiAgentSystem-203"><span class="linenos">203</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error processing query: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="MultiAgentSystem-204"><a href="#MultiAgentSystem-204"><span class="linenos">204</span></a>
</span><span id="MultiAgentSystem-205"><a href="#MultiAgentSystem-205"><span class="linenos">205</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_agent_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="MultiAgentSystem-206"><a href="#MultiAgentSystem-206"><span class="linenos">206</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-207"><a href="#MultiAgentSystem-207"><span class="linenos">207</span></a><span class="sd">        Get information about all available tool groups.</span>
</span><span id="MultiAgentSystem-208"><a href="#MultiAgentSystem-208"><span class="linenos">208</span></a>
</span><span id="MultiAgentSystem-209"><a href="#MultiAgentSystem-209"><span class="linenos">209</span></a><span class="sd">        :return: Dictionary with tool group names and descriptions</span>
</span><span id="MultiAgentSystem-210"><a href="#MultiAgentSystem-210"><span class="linenos">210</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-211"><a href="#MultiAgentSystem-211"><span class="linenos">211</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MultiAgentSystem-212"><a href="#MultiAgentSystem-212"><span class="linenos">212</span></a>        <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">tools</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="MultiAgentSystem-213"><a href="#MultiAgentSystem-213"><span class="linenos">213</span></a>            <span class="n">tool_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
</span><span id="MultiAgentSystem-214"><a href="#MultiAgentSystem-214"><span class="linenos">214</span></a>            <span class="n">info</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MultiAgentSystem-215"><a href="#MultiAgentSystem-215"><span class="linenos">215</span></a>                <span class="sa">f</span><span class="s2">&quot;Handles </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2"> operations with tools: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tool_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="MultiAgentSystem-216"><a href="#MultiAgentSystem-216"><span class="linenos">216</span></a>            <span class="p">)</span>
</span><span id="MultiAgentSystem-217"><a href="#MultiAgentSystem-217"><span class="linenos">217</span></a>        <span class="k">return</span> <span class="n">info</span>
</span><span id="MultiAgentSystem-218"><a href="#MultiAgentSystem-218"><span class="linenos">218</span></a>
</span><span id="MultiAgentSystem-219"><a href="#MultiAgentSystem-219"><span class="linenos">219</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">list_available_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="MultiAgentSystem-220"><a href="#MultiAgentSystem-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-221"><a href="#MultiAgentSystem-221"><span class="linenos">221</span></a><span class="sd">        List all tools available across all groups.</span>
</span><span id="MultiAgentSystem-222"><a href="#MultiAgentSystem-222"><span class="linenos">222</span></a>
</span><span id="MultiAgentSystem-223"><a href="#MultiAgentSystem-223"><span class="linenos">223</span></a><span class="sd">        :return: List of tool names</span>
</span><span id="MultiAgentSystem-224"><a href="#MultiAgentSystem-224"><span class="linenos">224</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem-225"><a href="#MultiAgentSystem-225"><span class="linenos">225</span></a>        <span class="n">all_tools</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiAgentSystem-226"><a href="#MultiAgentSystem-226"><span class="linenos">226</span></a>        <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">tools</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="MultiAgentSystem-227"><a href="#MultiAgentSystem-227"><span class="linenos">227</span></a>            <span class="n">tool_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
</span><span id="MultiAgentSystem-228"><a href="#MultiAgentSystem-228"><span class="linenos">228</span></a>            <span class="n">all_tools</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">tool</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tool_names</span><span class="p">])</span>
</span><span id="MultiAgentSystem-229"><a href="#MultiAgentSystem-229"><span class="linenos">229</span></a>        <span class="k">return</span> <span class="n">all_tools</span>
</span></pre></div>


            <div class="docstring"><p>Multi-agent system with specialized tools for different domains.</p>

<p>This system uses CodeAgent as a coordinator with all tools available directly:</p>

<ul>
<li>Filesystem operations: File reading, writing, directory listing</li>
<li>Research operations: Web search, GitHub search, comprehensive research</li>
<li>Memory operations: Knowledge base storage and retrieval</li>
<li>System operations: Shell commands and system tasks</li>
</ul>
</div>


                            <div id="MultiAgentSystem.__init__" class="classattr">
                                        <input id="MultiAgentSystem.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MultiAgentSystem</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mcp_client</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">weaviate_client</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">vector_store</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">smolagents</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">LiteLLMModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="MultiAgentSystem.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiAgentSystem.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiAgentSystem.__init__-67"><a href="#MultiAgentSystem.__init__-67"><span class="linenos"> 67</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="MultiAgentSystem.__init__-68"><a href="#MultiAgentSystem.__init__-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MultiAgentSystem.__init__-69"><a href="#MultiAgentSystem.__init__-69"><span class="linenos"> 69</span></a>        <span class="n">mcp_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiAgentSystem.__init__-70"><a href="#MultiAgentSystem.__init__-70"><span class="linenos"> 70</span></a>        <span class="n">weaviate_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiAgentSystem.__init__-71"><a href="#MultiAgentSystem.__init__-71"><span class="linenos"> 71</span></a>        <span class="n">vector_store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiAgentSystem.__init__-72"><a href="#MultiAgentSystem.__init__-72"><span class="linenos"> 72</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LiteLLMModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MultiAgentSystem.__init__-73"><a href="#MultiAgentSystem.__init__-73"><span class="linenos"> 73</span></a>    <span class="p">):</span>
</span><span id="MultiAgentSystem.__init__-74"><a href="#MultiAgentSystem.__init__-74"><span class="linenos"> 74</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem.__init__-75"><a href="#MultiAgentSystem.__init__-75"><span class="linenos"> 75</span></a><span class="sd">        Initialize the multi-agent system.</span>
</span><span id="MultiAgentSystem.__init__-76"><a href="#MultiAgentSystem.__init__-76"><span class="linenos"> 76</span></a>
</span><span id="MultiAgentSystem.__init__-77"><a href="#MultiAgentSystem.__init__-77"><span class="linenos"> 77</span></a><span class="sd">        Args:</span>
</span><span id="MultiAgentSystem.__init__-78"><a href="#MultiAgentSystem.__init__-78"><span class="linenos"> 78</span></a><span class="sd">            mcp_client: MCP client instance for tool functionality</span>
</span><span id="MultiAgentSystem.__init__-79"><a href="#MultiAgentSystem.__init__-79"><span class="linenos"> 79</span></a><span class="sd">            weaviate_client: Weaviate client for memory functionality</span>
</span><span id="MultiAgentSystem.__init__-80"><a href="#MultiAgentSystem.__init__-80"><span class="linenos"> 80</span></a><span class="sd">            vector_store: Vector store for memory operations</span>
</span><span id="MultiAgentSystem.__init__-81"><a href="#MultiAgentSystem.__init__-81"><span class="linenos"> 81</span></a><span class="sd">            model: Optional LiteLLM model instance</span>
</span><span id="MultiAgentSystem.__init__-82"><a href="#MultiAgentSystem.__init__-82"><span class="linenos"> 82</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem.__init__-83"><a href="#MultiAgentSystem.__init__-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span> <span class="ow">or</span> <span class="n">create_smolagents_model</span><span class="p">()</span>
</span><span id="MultiAgentSystem.__init__-84"><a href="#MultiAgentSystem.__init__-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mcp_client</span> <span class="o">=</span> <span class="n">mcp_client</span>
</span><span id="MultiAgentSystem.__init__-85"><a href="#MultiAgentSystem.__init__-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weaviate_client</span> <span class="o">=</span> <span class="n">weaviate_client</span>
</span><span id="MultiAgentSystem.__init__-86"><a href="#MultiAgentSystem.__init__-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span> <span class="o">=</span> <span class="n">vector_store</span>
</span><span id="MultiAgentSystem.__init__-87"><a href="#MultiAgentSystem.__init__-87"><span class="linenos"> 87</span></a>
</span><span id="MultiAgentSystem.__init__-88"><a href="#MultiAgentSystem.__init__-88"><span class="linenos"> 88</span></a>        <span class="c1"># Set up global dependencies for tools</span>
</span><span id="MultiAgentSystem.__init__-89"><a href="#MultiAgentSystem.__init__-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="n">mcp_client</span><span class="p">:</span>
</span><span id="MultiAgentSystem.__init__-90"><a href="#MultiAgentSystem.__init__-90"><span class="linenos"> 90</span></a>            <span class="n">set_mcp_client</span><span class="p">(</span><span class="n">mcp_client</span><span class="p">)</span>
</span><span id="MultiAgentSystem.__init__-91"><a href="#MultiAgentSystem.__init__-91"><span class="linenos"> 91</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MCP client set for multi-agent tools&quot;</span><span class="p">)</span>
</span><span id="MultiAgentSystem.__init__-92"><a href="#MultiAgentSystem.__init__-92"><span class="linenos"> 92</span></a>
</span><span id="MultiAgentSystem.__init__-93"><a href="#MultiAgentSystem.__init__-93"><span class="linenos"> 93</span></a>        <span class="k">if</span> <span class="n">weaviate_client</span> <span class="ow">and</span> <span class="n">vector_store</span><span class="p">:</span>
</span><span id="MultiAgentSystem.__init__-94"><a href="#MultiAgentSystem.__init__-94"><span class="linenos"> 94</span></a>            <span class="n">set_memory_components</span><span class="p">(</span><span class="n">weaviate_client</span><span class="p">,</span> <span class="n">vector_store</span><span class="p">,</span> <span class="n">USE_WEAVIATE</span><span class="p">)</span>
</span><span id="MultiAgentSystem.__init__-95"><a href="#MultiAgentSystem.__init__-95"><span class="linenos"> 95</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Memory components set for multi-agent tools&quot;</span><span class="p">)</span>
</span><span id="MultiAgentSystem.__init__-96"><a href="#MultiAgentSystem.__init__-96"><span class="linenos"> 96</span></a>
</span><span id="MultiAgentSystem.__init__-97"><a href="#MultiAgentSystem.__init__-97"><span class="linenos"> 97</span></a>        <span class="c1"># Create specialized tool groups</span>
</span><span id="MultiAgentSystem.__init__-98"><a href="#MultiAgentSystem.__init__-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tool_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_tool_groups</span><span class="p">()</span>
</span><span id="MultiAgentSystem.__init__-99"><a href="#MultiAgentSystem.__init__-99"><span class="linenos"> 99</span></a>
</span><span id="MultiAgentSystem.__init__-100"><a href="#MultiAgentSystem.__init__-100"><span class="linenos">100</span></a>        <span class="c1"># Create the intelligent routing agent</span>
</span><span id="MultiAgentSystem.__init__-101"><a href="#MultiAgentSystem.__init__-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_routing_agent</span><span class="p">()</span>
</span><span id="MultiAgentSystem.__init__-102"><a href="#MultiAgentSystem.__init__-102"><span class="linenos">102</span></a>
</span><span id="MultiAgentSystem.__init__-103"><a href="#MultiAgentSystem.__init__-103"><span class="linenos">103</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Multi-agent system initialized with CodeAgent coordinator&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the multi-agent system.</p>

<p>Args:
    mcp_client: MCP client instance for tool functionality
    weaviate_client: Weaviate client for memory functionality
    vector_store: Vector store for memory operations
    model: Optional LiteLLM model instance</p>
</div>


                            </div>
                            <div id="MultiAgentSystem.model" class="classattr">
                                <div class="attr variable">
            <span class="name">model</span>

        
    </div>
    <a class="headerlink" href="#MultiAgentSystem.model"></a>
    
    

                            </div>
                            <div id="MultiAgentSystem.mcp_client" class="classattr">
                                <div class="attr variable">
            <span class="name">mcp_client</span>

        
    </div>
    <a class="headerlink" href="#MultiAgentSystem.mcp_client"></a>
    
    

                            </div>
                            <div id="MultiAgentSystem.weaviate_client" class="classattr">
                                <div class="attr variable">
            <span class="name">weaviate_client</span>

        
    </div>
    <a class="headerlink" href="#MultiAgentSystem.weaviate_client"></a>
    
    

                            </div>
                            <div id="MultiAgentSystem.vector_store" class="classattr">
                                <div class="attr variable">
            <span class="name">vector_store</span>

        
    </div>
    <a class="headerlink" href="#MultiAgentSystem.vector_store"></a>
    
    

                            </div>
                            <div id="MultiAgentSystem.tool_groups" class="classattr">
                                <div class="attr variable">
            <span class="name">tool_groups</span>

        
    </div>
    <a class="headerlink" href="#MultiAgentSystem.tool_groups"></a>
    
    

                            </div>
                            <div id="MultiAgentSystem.agent" class="classattr">
                                <div class="attr variable">
            <span class="name">agent</span>

        
    </div>
    <a class="headerlink" href="#MultiAgentSystem.agent"></a>
    
    

                            </div>
                            <div id="MultiAgentSystem.run" class="classattr">
                                        <input id="MultiAgentSystem.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">query</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="MultiAgentSystem.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiAgentSystem.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiAgentSystem.run-186"><a href="#MultiAgentSystem.run-186"><span class="linenos">186</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="MultiAgentSystem.run-187"><a href="#MultiAgentSystem.run-187"><span class="linenos">187</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem.run-188"><a href="#MultiAgentSystem.run-188"><span class="linenos">188</span></a><span class="sd">        Process a query using the multi-agent system.</span>
</span><span id="MultiAgentSystem.run-189"><a href="#MultiAgentSystem.run-189"><span class="linenos">189</span></a>
</span><span id="MultiAgentSystem.run-190"><a href="#MultiAgentSystem.run-190"><span class="linenos">190</span></a><span class="sd">        Args:</span>
</span><span id="MultiAgentSystem.run-191"><a href="#MultiAgentSystem.run-191"><span class="linenos">191</span></a><span class="sd">            query: User query to process</span>
</span><span id="MultiAgentSystem.run-192"><a href="#MultiAgentSystem.run-192"><span class="linenos">192</span></a>
</span><span id="MultiAgentSystem.run-193"><a href="#MultiAgentSystem.run-193"><span class="linenos">193</span></a><span class="sd">        :return: Response from the coordinated agent system</span>
</span><span id="MultiAgentSystem.run-194"><a href="#MultiAgentSystem.run-194"><span class="linenos">194</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem.run-195"><a href="#MultiAgentSystem.run-195"><span class="linenos">195</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing query with multi-agent system: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>
</span><span id="MultiAgentSystem.run-196"><a href="#MultiAgentSystem.run-196"><span class="linenos">196</span></a>
</span><span id="MultiAgentSystem.run-197"><a href="#MultiAgentSystem.run-197"><span class="linenos">197</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MultiAgentSystem.run-198"><a href="#MultiAgentSystem.run-198"><span class="linenos">198</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="MultiAgentSystem.run-199"><a href="#MultiAgentSystem.run-199"><span class="linenos">199</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Multi-agent system completed query successfully&quot;</span><span class="p">)</span>
</span><span id="MultiAgentSystem.run-200"><a href="#MultiAgentSystem.run-200"><span class="linenos">200</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="MultiAgentSystem.run-201"><a href="#MultiAgentSystem.run-201"><span class="linenos">201</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="MultiAgentSystem.run-202"><a href="#MultiAgentSystem.run-202"><span class="linenos">202</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in multi-agent system: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="MultiAgentSystem.run-203"><a href="#MultiAgentSystem.run-203"><span class="linenos">203</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error processing query: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Process a query using the multi-agent system.</p>

<p>Args:
    query: User query to process</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Response from the coordinated agent system</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiAgentSystem.get_agent_info" class="classattr">
                                        <input id="MultiAgentSystem.get_agent_info-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_agent_info</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="MultiAgentSystem.get_agent_info-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiAgentSystem.get_agent_info"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiAgentSystem.get_agent_info-205"><a href="#MultiAgentSystem.get_agent_info-205"><span class="linenos">205</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_agent_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="MultiAgentSystem.get_agent_info-206"><a href="#MultiAgentSystem.get_agent_info-206"><span class="linenos">206</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem.get_agent_info-207"><a href="#MultiAgentSystem.get_agent_info-207"><span class="linenos">207</span></a><span class="sd">        Get information about all available tool groups.</span>
</span><span id="MultiAgentSystem.get_agent_info-208"><a href="#MultiAgentSystem.get_agent_info-208"><span class="linenos">208</span></a>
</span><span id="MultiAgentSystem.get_agent_info-209"><a href="#MultiAgentSystem.get_agent_info-209"><span class="linenos">209</span></a><span class="sd">        :return: Dictionary with tool group names and descriptions</span>
</span><span id="MultiAgentSystem.get_agent_info-210"><a href="#MultiAgentSystem.get_agent_info-210"><span class="linenos">210</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem.get_agent_info-211"><a href="#MultiAgentSystem.get_agent_info-211"><span class="linenos">211</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MultiAgentSystem.get_agent_info-212"><a href="#MultiAgentSystem.get_agent_info-212"><span class="linenos">212</span></a>        <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">tools</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="MultiAgentSystem.get_agent_info-213"><a href="#MultiAgentSystem.get_agent_info-213"><span class="linenos">213</span></a>            <span class="n">tool_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
</span><span id="MultiAgentSystem.get_agent_info-214"><a href="#MultiAgentSystem.get_agent_info-214"><span class="linenos">214</span></a>            <span class="n">info</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MultiAgentSystem.get_agent_info-215"><a href="#MultiAgentSystem.get_agent_info-215"><span class="linenos">215</span></a>                <span class="sa">f</span><span class="s2">&quot;Handles </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2"> operations with tools: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tool_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="MultiAgentSystem.get_agent_info-216"><a href="#MultiAgentSystem.get_agent_info-216"><span class="linenos">216</span></a>            <span class="p">)</span>
</span><span id="MultiAgentSystem.get_agent_info-217"><a href="#MultiAgentSystem.get_agent_info-217"><span class="linenos">217</span></a>        <span class="k">return</span> <span class="n">info</span>
</span></pre></div>


            <div class="docstring"><p>Get information about all available tool groups.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Dictionary with tool group names and descriptions</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiAgentSystem.list_available_tools" class="classattr">
                                        <input id="MultiAgentSystem.list_available_tools-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">list_available_tools</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="MultiAgentSystem.list_available_tools-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiAgentSystem.list_available_tools"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiAgentSystem.list_available_tools-219"><a href="#MultiAgentSystem.list_available_tools-219"><span class="linenos">219</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">list_available_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="MultiAgentSystem.list_available_tools-220"><a href="#MultiAgentSystem.list_available_tools-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem.list_available_tools-221"><a href="#MultiAgentSystem.list_available_tools-221"><span class="linenos">221</span></a><span class="sd">        List all tools available across all groups.</span>
</span><span id="MultiAgentSystem.list_available_tools-222"><a href="#MultiAgentSystem.list_available_tools-222"><span class="linenos">222</span></a>
</span><span id="MultiAgentSystem.list_available_tools-223"><a href="#MultiAgentSystem.list_available_tools-223"><span class="linenos">223</span></a><span class="sd">        :return: List of tool names</span>
</span><span id="MultiAgentSystem.list_available_tools-224"><a href="#MultiAgentSystem.list_available_tools-224"><span class="linenos">224</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiAgentSystem.list_available_tools-225"><a href="#MultiAgentSystem.list_available_tools-225"><span class="linenos">225</span></a>        <span class="n">all_tools</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiAgentSystem.list_available_tools-226"><a href="#MultiAgentSystem.list_available_tools-226"><span class="linenos">226</span></a>        <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">tools</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="MultiAgentSystem.list_available_tools-227"><a href="#MultiAgentSystem.list_available_tools-227"><span class="linenos">227</span></a>            <span class="n">tool_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
</span><span id="MultiAgentSystem.list_available_tools-228"><a href="#MultiAgentSystem.list_available_tools-228"><span class="linenos">228</span></a>            <span class="n">all_tools</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">tool</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tool_names</span><span class="p">])</span>
</span><span id="MultiAgentSystem.list_available_tools-229"><a href="#MultiAgentSystem.list_available_tools-229"><span class="linenos">229</span></a>        <span class="k">return</span> <span class="n">all_tools</span>
</span></pre></div>


            <div class="docstring"><p>List all tools available across all groups.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>List of tool names</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="create_multi_agent_system">
                            <input id="create_multi_agent_system-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_multi_agent_system</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mcp_client</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">weaviate_client</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">vector_store</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">smolagents</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">LiteLLMModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#MultiAgentSystem">MultiAgentSystem</a></span>:</span></span>

                <label class="view-source-button" for="create_multi_agent_system-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_multi_agent_system"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_multi_agent_system-232"><a href="#create_multi_agent_system-232"><span class="linenos">232</span></a><span class="k">def</span><span class="w"> </span><span class="nf">create_multi_agent_system</span><span class="p">(</span>
</span><span id="create_multi_agent_system-233"><a href="#create_multi_agent_system-233"><span class="linenos">233</span></a>    <span class="n">mcp_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="create_multi_agent_system-234"><a href="#create_multi_agent_system-234"><span class="linenos">234</span></a>    <span class="n">weaviate_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="create_multi_agent_system-235"><a href="#create_multi_agent_system-235"><span class="linenos">235</span></a>    <span class="n">vector_store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="create_multi_agent_system-236"><a href="#create_multi_agent_system-236"><span class="linenos">236</span></a>    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LiteLLMModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="create_multi_agent_system-237"><a href="#create_multi_agent_system-237"><span class="linenos">237</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MultiAgentSystem</span><span class="p">:</span>
</span><span id="create_multi_agent_system-238"><a href="#create_multi_agent_system-238"><span class="linenos">238</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="create_multi_agent_system-239"><a href="#create_multi_agent_system-239"><span class="linenos">239</span></a><span class="sd">    Create and configure the multi-agent system.</span>
</span><span id="create_multi_agent_system-240"><a href="#create_multi_agent_system-240"><span class="linenos">240</span></a>
</span><span id="create_multi_agent_system-241"><a href="#create_multi_agent_system-241"><span class="linenos">241</span></a><span class="sd">    Args:</span>
</span><span id="create_multi_agent_system-242"><a href="#create_multi_agent_system-242"><span class="linenos">242</span></a><span class="sd">        mcp_client: MCP client instance for tool functionality</span>
</span><span id="create_multi_agent_system-243"><a href="#create_multi_agent_system-243"><span class="linenos">243</span></a><span class="sd">        weaviate_client: Weaviate client for memory functionality</span>
</span><span id="create_multi_agent_system-244"><a href="#create_multi_agent_system-244"><span class="linenos">244</span></a><span class="sd">        vector_store: Vector store for memory operations</span>
</span><span id="create_multi_agent_system-245"><a href="#create_multi_agent_system-245"><span class="linenos">245</span></a><span class="sd">        model: Optional LiteLLM model instance</span>
</span><span id="create_multi_agent_system-246"><a href="#create_multi_agent_system-246"><span class="linenos">246</span></a>
</span><span id="create_multi_agent_system-247"><a href="#create_multi_agent_system-247"><span class="linenos">247</span></a><span class="sd">    :return: Configured MultiAgentSystem instance</span>
</span><span id="create_multi_agent_system-248"><a href="#create_multi_agent_system-248"><span class="linenos">248</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="create_multi_agent_system-249"><a href="#create_multi_agent_system-249"><span class="linenos">249</span></a>    <span class="k">return</span> <span class="n">MultiAgentSystem</span><span class="p">(</span>
</span><span id="create_multi_agent_system-250"><a href="#create_multi_agent_system-250"><span class="linenos">250</span></a>        <span class="n">mcp_client</span><span class="o">=</span><span class="n">mcp_client</span><span class="p">,</span>
</span><span id="create_multi_agent_system-251"><a href="#create_multi_agent_system-251"><span class="linenos">251</span></a>        <span class="n">weaviate_client</span><span class="o">=</span><span class="n">weaviate_client</span><span class="p">,</span>
</span><span id="create_multi_agent_system-252"><a href="#create_multi_agent_system-252"><span class="linenos">252</span></a>        <span class="n">vector_store</span><span class="o">=</span><span class="n">vector_store</span><span class="p">,</span>
</span><span id="create_multi_agent_system-253"><a href="#create_multi_agent_system-253"><span class="linenos">253</span></a>        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span><span id="create_multi_agent_system-254"><a href="#create_multi_agent_system-254"><span class="linenos">254</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create and configure the multi-agent system.</p>

<p>Args:
    mcp_client: MCP client instance for tool functionality
    weaviate_client: Weaviate client for memory functionality
    vector_store: Vector store for memory operations
    model: Optional LiteLLM model instance</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Configured MultiAgentSystem instance</p>
</blockquote>
</div>


                </section>
                <section id="create_smolagents_executor">
                            <input id="create_smolagents_executor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_smolagents_executor</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mcp_client</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">weaviate_client</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">vector_store</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">smolagents</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">LiteLLMModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">smolagents</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">CodeAgent</span>:</span></span>

                <label class="view-source-button" for="create_smolagents_executor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_smolagents_executor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_smolagents_executor-28"><a href="#create_smolagents_executor-28"><span class="linenos">28</span></a><span class="k">def</span><span class="w"> </span><span class="nf">create_smolagents_executor</span><span class="p">(</span>
</span><span id="create_smolagents_executor-29"><a href="#create_smolagents_executor-29"><span class="linenos">29</span></a>    <span class="n">mcp_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="create_smolagents_executor-30"><a href="#create_smolagents_executor-30"><span class="linenos">30</span></a>    <span class="n">weaviate_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="create_smolagents_executor-31"><a href="#create_smolagents_executor-31"><span class="linenos">31</span></a>    <span class="n">vector_store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="create_smolagents_executor-32"><a href="#create_smolagents_executor-32"><span class="linenos">32</span></a>    <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="create_smolagents_executor-33"><a href="#create_smolagents_executor-33"><span class="linenos">33</span></a>    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LiteLLMModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="create_smolagents_executor-34"><a href="#create_smolagents_executor-34"><span class="linenos">34</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CodeAgent</span><span class="p">:</span>
</span><span id="create_smolagents_executor-35"><a href="#create_smolagents_executor-35"><span class="linenos">35</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="create_smolagents_executor-36"><a href="#create_smolagents_executor-36"><span class="linenos">36</span></a><span class="sd">    Create smolagents CodeAgent with all tools and dependencies.</span>
</span><span id="create_smolagents_executor-37"><a href="#create_smolagents_executor-37"><span class="linenos">37</span></a>
</span><span id="create_smolagents_executor-38"><a href="#create_smolagents_executor-38"><span class="linenos">38</span></a><span class="sd">    :param mcp_client: MCP client instance for tool functionality</span>
</span><span id="create_smolagents_executor-39"><a href="#create_smolagents_executor-39"><span class="linenos">39</span></a><span class="sd">    :param weaviate_client: Weaviate client for memory functionality</span>
</span><span id="create_smolagents_executor-40"><a href="#create_smolagents_executor-40"><span class="linenos">40</span></a><span class="sd">    :param vector_store: Vector store for memory operations</span>
</span><span id="create_smolagents_executor-41"><a href="#create_smolagents_executor-41"><span class="linenos">41</span></a><span class="sd">    :param tools: Optional custom list of tools (uses ALL_TOOLS by default)</span>
</span><span id="create_smolagents_executor-42"><a href="#create_smolagents_executor-42"><span class="linenos">42</span></a><span class="sd">    :param model: Optional LiteLLM model instance</span>
</span><span id="create_smolagents_executor-43"><a href="#create_smolagents_executor-43"><span class="linenos">43</span></a><span class="sd">    :return: Configured CodeAgent</span>
</span><span id="create_smolagents_executor-44"><a href="#create_smolagents_executor-44"><span class="linenos">44</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="create_smolagents_executor-45"><a href="#create_smolagents_executor-45"><span class="linenos">45</span></a>    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="create_smolagents_executor-46"><a href="#create_smolagents_executor-46"><span class="linenos">46</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">create_smolagents_model</span><span class="p">()</span>
</span><span id="create_smolagents_executor-47"><a href="#create_smolagents_executor-47"><span class="linenos">47</span></a>
</span><span id="create_smolagents_executor-48"><a href="#create_smolagents_executor-48"><span class="linenos">48</span></a>    <span class="c1"># Set up global dependencies for tools</span>
</span><span id="create_smolagents_executor-49"><a href="#create_smolagents_executor-49"><span class="linenos">49</span></a>    <span class="k">if</span> <span class="n">mcp_client</span><span class="p">:</span>
</span><span id="create_smolagents_executor-50"><a href="#create_smolagents_executor-50"><span class="linenos">50</span></a>        <span class="n">set_mcp_client</span><span class="p">(</span><span class="n">mcp_client</span><span class="p">)</span>
</span><span id="create_smolagents_executor-51"><a href="#create_smolagents_executor-51"><span class="linenos">51</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MCP client set for smolagents tools&quot;</span><span class="p">)</span>
</span><span id="create_smolagents_executor-52"><a href="#create_smolagents_executor-52"><span class="linenos">52</span></a>
</span><span id="create_smolagents_executor-53"><a href="#create_smolagents_executor-53"><span class="linenos">53</span></a>    <span class="k">if</span> <span class="n">weaviate_client</span> <span class="ow">and</span> <span class="n">vector_store</span><span class="p">:</span>
</span><span id="create_smolagents_executor-54"><a href="#create_smolagents_executor-54"><span class="linenos">54</span></a>        <span class="n">set_memory_components</span><span class="p">(</span><span class="n">weaviate_client</span><span class="p">,</span> <span class="n">vector_store</span><span class="p">,</span> <span class="n">USE_WEAVIATE</span><span class="p">)</span>
</span><span id="create_smolagents_executor-55"><a href="#create_smolagents_executor-55"><span class="linenos">55</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Memory components set for smolagents tools&quot;</span><span class="p">)</span>
</span><span id="create_smolagents_executor-56"><a href="#create_smolagents_executor-56"><span class="linenos">56</span></a>
</span><span id="create_smolagents_executor-57"><a href="#create_smolagents_executor-57"><span class="linenos">57</span></a>    <span class="c1"># Use provided tools or default to all available tools</span>
</span><span id="create_smolagents_executor-58"><a href="#create_smolagents_executor-58"><span class="linenos">58</span></a>    <span class="k">if</span> <span class="n">tools</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="create_smolagents_executor-59"><a href="#create_smolagents_executor-59"><span class="linenos">59</span></a>        <span class="n">tools</span> <span class="o">=</span> <span class="n">ALL_TOOLS</span>
</span><span id="create_smolagents_executor-60"><a href="#create_smolagents_executor-60"><span class="linenos">60</span></a>
</span><span id="create_smolagents_executor-61"><a href="#create_smolagents_executor-61"><span class="linenos">61</span></a>    <span class="n">agent</span> <span class="o">=</span> <span class="n">CodeAgent</span><span class="p">(</span><span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
</span><span id="create_smolagents_executor-62"><a href="#create_smolagents_executor-62"><span class="linenos">62</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created smolagents CodeAgent with </span><span class="si">%d</span><span class="s2"> tools&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tools</span><span class="p">))</span>
</span><span id="create_smolagents_executor-63"><a href="#create_smolagents_executor-63"><span class="linenos">63</span></a>    <span class="k">return</span> <span class="n">agent</span>
</span></pre></div>


            <div class="docstring"><p>Create smolagents CodeAgent with all tools and dependencies.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mcp_client</strong>:  MCP client instance for tool functionality</li>
<li><strong>weaviate_client</strong>:  Weaviate client for memory functionality</li>
<li><strong>vector_store</strong>:  Vector store for memory operations</li>
<li><strong>tools</strong>:  Optional custom list of tools (uses ALL_TOOLS by default)</li>
<li><strong>model</strong>:  Optional LiteLLM model instance</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Configured CodeAgent</p>
</blockquote>
</div>


                </section>
                <section id="create_smolagents_model">
                            <input id="create_smolagents_model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_smolagents_model</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="n">smolagents</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">LiteLLMModel</span>:</span></span>

                <label class="view-source-button" for="create_smolagents_model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_smolagents_model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_smolagents_model-15"><a href="#create_smolagents_model-15"><span class="linenos">15</span></a><span class="k">def</span><span class="w"> </span><span class="nf">create_smolagents_model</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">LiteLLMModel</span><span class="p">:</span>
</span><span id="create_smolagents_model-16"><a href="#create_smolagents_model-16"><span class="linenos">16</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="create_smolagents_model-17"><a href="#create_smolagents_model-17"><span class="linenos">17</span></a><span class="sd">    Create LiteLLM model for Ollama integration.</span>
</span><span id="create_smolagents_model-18"><a href="#create_smolagents_model-18"><span class="linenos">18</span></a>
</span><span id="create_smolagents_model-19"><a href="#create_smolagents_model-19"><span class="linenos">19</span></a><span class="sd">    :return: Configured LiteLLM model instance</span>
</span><span id="create_smolagents_model-20"><a href="#create_smolagents_model-20"><span class="linenos">20</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="create_smolagents_model-21"><a href="#create_smolagents_model-21"><span class="linenos">21</span></a>    <span class="k">return</span> <span class="n">LiteLLMModel</span><span class="p">(</span>
</span><span id="create_smolagents_model-22"><a href="#create_smolagents_model-22"><span class="linenos">22</span></a>        <span class="n">model_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ollama_chat/</span><span class="si">{</span><span class="n">LLM_MODEL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="create_smolagents_model-23"><a href="#create_smolagents_model-23"><span class="linenos">23</span></a>        <span class="n">api_base</span><span class="o">=</span><span class="n">OLLAMA_URL</span><span class="p">,</span>
</span><span id="create_smolagents_model-24"><a href="#create_smolagents_model-24"><span class="linenos">24</span></a>        <span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;ollama_local&quot;</span><span class="p">,</span>
</span><span id="create_smolagents_model-25"><a href="#create_smolagents_model-25"><span class="linenos">25</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create LiteLLM model for Ollama integration.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Configured LiteLLM model instance</p>
</blockquote>
</div>


                </section>
                <section id="create_agno_storage">
                            <input id="create_agno_storage-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_agno_storage</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">agno</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">sqlite</span><span class="o">.</span><span class="n">SqliteStorage</span>:</span></span>

                <label class="view-source-button" for="create_agno_storage-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_agno_storage"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_agno_storage-78"><a href="#create_agno_storage-78"><span class="linenos">78</span></a><span class="k">def</span><span class="w"> </span><span class="nf">create_agno_storage</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SqliteStorage</span><span class="p">:</span>
</span><span id="create_agno_storage-79"><a href="#create_agno_storage-79"><span class="linenos">79</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create SQLite storage for agent sessions.</span>
</span><span id="create_agno_storage-80"><a href="#create_agno_storage-80"><span class="linenos">80</span></a>
</span><span id="create_agno_storage-81"><a href="#create_agno_storage-81"><span class="linenos">81</span></a><span class="sd">    :param storage_dir: Directory for storage files (defaults to DATA_DIR/agno)</span>
</span><span id="create_agno_storage-82"><a href="#create_agno_storage-82"><span class="linenos">82</span></a><span class="sd">    :return: Configured SQLite storage instance</span>
</span><span id="create_agno_storage-83"><a href="#create_agno_storage-83"><span class="linenos">83</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="create_agno_storage-84"><a href="#create_agno_storage-84"><span class="linenos">84</span></a>    <span class="k">if</span> <span class="n">storage_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="create_agno_storage-85"><a href="#create_agno_storage-85"><span class="linenos">85</span></a>        <span class="n">storage_dir</span> <span class="o">=</span> <span class="n">AGNO_STORAGE_DIR</span>
</span><span id="create_agno_storage-86"><a href="#create_agno_storage-86"><span class="linenos">86</span></a>
</span><span id="create_agno_storage-87"><a href="#create_agno_storage-87"><span class="linenos">87</span></a>    <span class="n">storage_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">)</span>
</span><span id="create_agno_storage-88"><a href="#create_agno_storage-88"><span class="linenos">88</span></a>    <span class="n">storage_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="create_agno_storage-89"><a href="#create_agno_storage-89"><span class="linenos">89</span></a>
</span><span id="create_agno_storage-90"><a href="#create_agno_storage-90"><span class="linenos">90</span></a>    <span class="n">storage</span> <span class="o">=</span> <span class="n">SqliteStorage</span><span class="p">(</span>
</span><span id="create_agno_storage-91"><a href="#create_agno_storage-91"><span class="linenos">91</span></a>        <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;personal_agent_sessions&quot;</span><span class="p">,</span>
</span><span id="create_agno_storage-92"><a href="#create_agno_storage-92"><span class="linenos">92</span></a>        <span class="n">db_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">storage_path</span> <span class="o">/</span> <span class="s2">&quot;agent_sessions.db&quot;</span><span class="p">),</span>
</span><span id="create_agno_storage-93"><a href="#create_agno_storage-93"><span class="linenos">93</span></a>        <span class="n">auto_upgrade_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="create_agno_storage-94"><a href="#create_agno_storage-94"><span class="linenos">94</span></a>    <span class="p">)</span>
</span><span id="create_agno_storage-95"><a href="#create_agno_storage-95"><span class="linenos">95</span></a>
</span><span id="create_agno_storage-96"><a href="#create_agno_storage-96"><span class="linenos">96</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="create_agno_storage-97"><a href="#create_agno_storage-97"><span class="linenos">97</span></a>        <span class="s2">&quot;Created Agno SQLite storage at: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">storage_path</span> <span class="o">/</span> <span class="s2">&quot;agent_sessions.db&quot;</span>
</span><span id="create_agno_storage-98"><a href="#create_agno_storage-98"><span class="linenos">98</span></a>    <span class="p">)</span>
</span><span id="create_agno_storage-99"><a href="#create_agno_storage-99"><span class="linenos">99</span></a>    <span class="k">return</span> <span class="n">storage</span>
</span></pre></div>


            <div class="docstring"><p>Create SQLite storage for agent sessions.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>storage_dir</strong>:  Directory for storage files (defaults to DATA_DIR/agno)</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Configured SQLite storage instance</p>
</blockquote>
</div>


                </section>
                <section id="create_agno_memory">
                            <input id="create_agno_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_agno_memory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">Memory</span>:</span></span>

                <label class="view-source-button" for="create_agno_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_agno_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_agno_memory-102"><a href="#create_agno_memory-102"><span class="linenos">102</span></a><span class="k">def</span><span class="w"> </span><span class="nf">create_agno_memory</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Memory</span><span class="p">:</span>
</span><span id="create_agno_memory-103"><a href="#create_agno_memory-103"><span class="linenos">103</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create Memory instance with SemanticMemoryManager for LLM-free memory management.</span>
</span><span id="create_agno_memory-104"><a href="#create_agno_memory-104"><span class="linenos">104</span></a>
</span><span id="create_agno_memory-105"><a href="#create_agno_memory-105"><span class="linenos">105</span></a><span class="sd">    Uses the advanced SemanticMemoryManager that provides intelligent duplicate detection,</span>
</span><span id="create_agno_memory-106"><a href="#create_agno_memory-106"><span class="linenos">106</span></a><span class="sd">    automatic topic classification, and semantic search capabilities without requiring</span>
</span><span id="create_agno_memory-107"><a href="#create_agno_memory-107"><span class="linenos">107</span></a><span class="sd">    LLM calls for memory operations.</span>
</span><span id="create_agno_memory-108"><a href="#create_agno_memory-108"><span class="linenos">108</span></a>
</span><span id="create_agno_memory-109"><a href="#create_agno_memory-109"><span class="linenos">109</span></a><span class="sd">    Features:</span>
</span><span id="create_agno_memory-110"><a href="#create_agno_memory-110"><span class="linenos">110</span></a><span class="sd">    - LLM-free semantic duplicate detection (similarity threshold: 0.8)</span>
</span><span id="create_agno_memory-111"><a href="#create_agno_memory-111"><span class="linenos">111</span></a><span class="sd">    - Automatic topic classification using rule-based patterns</span>
</span><span id="create_agno_memory-112"><a href="#create_agno_memory-112"><span class="linenos">112</span></a><span class="sd">    - Enhanced semantic search with topic matching</span>
</span><span id="create_agno_memory-113"><a href="#create_agno_memory-113"><span class="linenos">113</span></a><span class="sd">    - Memory deletion and clearing capabilities</span>
</span><span id="create_agno_memory-114"><a href="#create_agno_memory-114"><span class="linenos">114</span></a><span class="sd">    - Rich memory statistics and analytics</span>
</span><span id="create_agno_memory-115"><a href="#create_agno_memory-115"><span class="linenos">115</span></a><span class="sd">    - Debug mode for detailed logging</span>
</span><span id="create_agno_memory-116"><a href="#create_agno_memory-116"><span class="linenos">116</span></a>
</span><span id="create_agno_memory-117"><a href="#create_agno_memory-117"><span class="linenos">117</span></a><span class="sd">    :param storage_dir: Directory for storage files (defaults to DATA_DIR/agno)</span>
</span><span id="create_agno_memory-118"><a href="#create_agno_memory-118"><span class="linenos">118</span></a><span class="sd">    :param debug_mode: Enable debug logging for memory operations</span>
</span><span id="create_agno_memory-119"><a href="#create_agno_memory-119"><span class="linenos">119</span></a><span class="sd">    :return: Configured Memory instance with SemanticMemoryManager</span>
</span><span id="create_agno_memory-120"><a href="#create_agno_memory-120"><span class="linenos">120</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="create_agno_memory-121"><a href="#create_agno_memory-121"><span class="linenos">121</span></a>    <span class="k">if</span> <span class="n">storage_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="create_agno_memory-122"><a href="#create_agno_memory-122"><span class="linenos">122</span></a>        <span class="n">storage_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATA_DIR</span><span class="si">}</span><span class="s2">/agno&quot;</span>
</span><span id="create_agno_memory-123"><a href="#create_agno_memory-123"><span class="linenos">123</span></a>
</span><span id="create_agno_memory-124"><a href="#create_agno_memory-124"><span class="linenos">124</span></a>    <span class="n">storage_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">)</span>
</span><span id="create_agno_memory-125"><a href="#create_agno_memory-125"><span class="linenos">125</span></a>    <span class="n">storage_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="create_agno_memory-126"><a href="#create_agno_memory-126"><span class="linenos">126</span></a>
</span><span id="create_agno_memory-127"><a href="#create_agno_memory-127"><span class="linenos">127</span></a>    <span class="c1"># Create SQLite memory database</span>
</span><span id="create_agno_memory-128"><a href="#create_agno_memory-128"><span class="linenos">128</span></a>    <span class="n">memory_db</span> <span class="o">=</span> <span class="n">SqliteMemoryDb</span><span class="p">(</span>
</span><span id="create_agno_memory-129"><a href="#create_agno_memory-129"><span class="linenos">129</span></a>        <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;personal_agent_memory&quot;</span><span class="p">,</span>
</span><span id="create_agno_memory-130"><a href="#create_agno_memory-130"><span class="linenos">130</span></a>        <span class="n">db_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">storage_path</span> <span class="o">/</span> <span class="s2">&quot;agent_memory.db&quot;</span><span class="p">),</span>
</span><span id="create_agno_memory-131"><a href="#create_agno_memory-131"><span class="linenos">131</span></a>    <span class="p">)</span>
</span><span id="create_agno_memory-132"><a href="#create_agno_memory-132"><span class="linenos">132</span></a>
</span><span id="create_agno_memory-133"><a href="#create_agno_memory-133"><span class="linenos">133</span></a>    <span class="c1"># Create semantic memory manager configuration</span>
</span><span id="create_agno_memory-134"><a href="#create_agno_memory-134"><span class="linenos">134</span></a>    <span class="n">semantic_config</span> <span class="o">=</span> <span class="n">SemanticMemoryManagerConfig</span><span class="p">(</span>
</span><span id="create_agno_memory-135"><a href="#create_agno_memory-135"><span class="linenos">135</span></a>        <span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="create_agno_memory-136"><a href="#create_agno_memory-136"><span class="linenos">136</span></a>        <span class="n">enable_semantic_dedup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="create_agno_memory-137"><a href="#create_agno_memory-137"><span class="linenos">137</span></a>        <span class="n">enable_exact_dedup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="create_agno_memory-138"><a href="#create_agno_memory-138"><span class="linenos">138</span></a>        <span class="n">enable_topic_classification</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="create_agno_memory-139"><a href="#create_agno_memory-139"><span class="linenos">139</span></a>        <span class="n">debug_mode</span><span class="o">=</span><span class="n">debug_mode</span><span class="p">,</span>
</span><span id="create_agno_memory-140"><a href="#create_agno_memory-140"><span class="linenos">140</span></a>        <span class="n">max_memory_length</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
</span><span id="create_agno_memory-141"><a href="#create_agno_memory-141"><span class="linenos">141</span></a>        <span class="n">recent_memory_limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="create_agno_memory-142"><a href="#create_agno_memory-142"><span class="linenos">142</span></a>    <span class="p">)</span>
</span><span id="create_agno_memory-143"><a href="#create_agno_memory-143"><span class="linenos">143</span></a>
</span><span id="create_agno_memory-144"><a href="#create_agno_memory-144"><span class="linenos">144</span></a>    <span class="c1"># Create semantic memory manager</span>
</span><span id="create_agno_memory-145"><a href="#create_agno_memory-145"><span class="linenos">145</span></a>    <span class="n">semantic_memory_manager</span> <span class="o">=</span> <span class="n">SemanticMemoryManager</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">semantic_config</span><span class="p">)</span>
</span><span id="create_agno_memory-146"><a href="#create_agno_memory-146"><span class="linenos">146</span></a>
</span><span id="create_agno_memory-147"><a href="#create_agno_memory-147"><span class="linenos">147</span></a>    <span class="c1"># Create Agno Memory instance with SemanticMemoryManager</span>
</span><span id="create_agno_memory-148"><a href="#create_agno_memory-148"><span class="linenos">148</span></a>    <span class="n">memory</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">(</span>
</span><span id="create_agno_memory-149"><a href="#create_agno_memory-149"><span class="linenos">149</span></a>        <span class="n">db</span><span class="o">=</span><span class="n">memory_db</span><span class="p">,</span>
</span><span id="create_agno_memory-150"><a href="#create_agno_memory-150"><span class="linenos">150</span></a>        <span class="n">memory_manager</span><span class="o">=</span><span class="n">semantic_memory_manager</span><span class="p">,</span>
</span><span id="create_agno_memory-151"><a href="#create_agno_memory-151"><span class="linenos">151</span></a>    <span class="p">)</span>
</span><span id="create_agno_memory-152"><a href="#create_agno_memory-152"><span class="linenos">152</span></a>
</span><span id="create_agno_memory-153"><a href="#create_agno_memory-153"><span class="linenos">153</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="create_agno_memory-154"><a href="#create_agno_memory-154"><span class="linenos">154</span></a>        <span class="s2">&quot;Created Memory with SemanticMemoryManager at: </span><span class="si">%s</span><span class="s2"> (debug_mode=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="create_agno_memory-155"><a href="#create_agno_memory-155"><span class="linenos">155</span></a>        <span class="n">storage_path</span> <span class="o">/</span> <span class="s2">&quot;agent_memory.db&quot;</span><span class="p">,</span>
</span><span id="create_agno_memory-156"><a href="#create_agno_memory-156"><span class="linenos">156</span></a>        <span class="n">debug_mode</span><span class="p">,</span>
</span><span id="create_agno_memory-157"><a href="#create_agno_memory-157"><span class="linenos">157</span></a>    <span class="p">)</span>
</span><span id="create_agno_memory-158"><a href="#create_agno_memory-158"><span class="linenos">158</span></a>    <span class="k">return</span> <span class="n">memory</span>
</span></pre></div>


            <div class="docstring"><p>Create Memory instance with SemanticMemoryManager for LLM-free memory management.</p>

<p>Uses the advanced SemanticMemoryManager that provides intelligent duplicate detection,
automatic topic classification, and semantic search capabilities without requiring
LLM calls for memory operations.</p>

<p>Features:</p>

<ul>
<li>LLM-free semantic duplicate detection (similarity threshold: 0.8)</li>
<li>Automatic topic classification using rule-based patterns</li>
<li>Enhanced semantic search with topic matching</li>
<li>Memory deletion and clearing capabilities</li>
<li>Rich memory statistics and analytics</li>
<li>Debug mode for detailed logging</li>
</ul>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>storage_dir</strong>:  Directory for storage files (defaults to DATA_DIR/agno)</li>
<li><strong>debug_mode</strong>:  Enable debug logging for memory operations</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Configured Memory instance with SemanticMemoryManager</p>
</blockquote>
</div>


                </section>
                <section id="create_combined_knowledge_base">
                            <input id="create_combined_knowledge_base-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_combined_knowledge_base</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">knowledge_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">db_url</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">sqlite</span><span class="o">.</span><span class="n">SqliteStorage</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="n">agno</span><span class="o">.</span><span class="n">knowledge</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">CombinedKnowledgeBase</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="create_combined_knowledge_base-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_combined_knowledge_base"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_combined_knowledge_base-166"><a href="#create_combined_knowledge_base-166"><span class="linenos">166</span></a><span class="k">def</span><span class="w"> </span><span class="nf">create_combined_knowledge_base</span><span class="p">(</span>
</span><span id="create_combined_knowledge_base-167"><a href="#create_combined_knowledge_base-167"><span class="linenos">167</span></a>    <span class="n">storage_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">knowledge_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">db_url</span><span class="p">:</span> <span class="n">SqliteStorage</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="create_combined_knowledge_base-168"><a href="#create_combined_knowledge_base-168"><span class="linenos">168</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CombinedKnowledgeBase</span><span class="p">]:</span>
</span><span id="create_combined_knowledge_base-169"><a href="#create_combined_knowledge_base-169"><span class="linenos">169</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a combined knowledge base with text and PDF sources (synchronous creation).</span>
</span><span id="create_combined_knowledge_base-170"><a href="#create_combined_knowledge_base-170"><span class="linenos">170</span></a>
</span><span id="create_combined_knowledge_base-171"><a href="#create_combined_knowledge_base-171"><span class="linenos">171</span></a><span class="sd">    :param storage_dir: Directory for storage files (defaults to DATA_DIR/agno)</span>
</span><span id="create_combined_knowledge_base-172"><a href="#create_combined_knowledge_base-172"><span class="linenos">172</span></a><span class="sd">    :param knowledge_dir: Directory containing knowledge files to load (defaults to DATA_DIR/knowledge)</span>
</span><span id="create_combined_knowledge_base-173"><a href="#create_combined_knowledge_base-173"><span class="linenos">173</span></a><span class="sd">    :param db_url: SqliteStorage for the database</span>
</span><span id="create_combined_knowledge_base-174"><a href="#create_combined_knowledge_base-174"><span class="linenos">174</span></a><span class="sd">    :return: Configured CombinedKnowledgeBase instance or None if no knowledge found</span>
</span><span id="create_combined_knowledge_base-175"><a href="#create_combined_knowledge_base-175"><span class="linenos">175</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="create_combined_knowledge_base-176"><a href="#create_combined_knowledge_base-176"><span class="linenos">176</span></a>    <span class="k">if</span> <span class="n">storage_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="create_combined_knowledge_base-177"><a href="#create_combined_knowledge_base-177"><span class="linenos">177</span></a>        <span class="n">storage_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATA_DIR</span><span class="si">}</span><span class="s2">/agno&quot;</span>
</span><span id="create_combined_knowledge_base-178"><a href="#create_combined_knowledge_base-178"><span class="linenos">178</span></a>    <span class="k">if</span> <span class="n">knowledge_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="create_combined_knowledge_base-179"><a href="#create_combined_knowledge_base-179"><span class="linenos">179</span></a>        <span class="n">knowledge_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATA_DIR</span><span class="si">}</span><span class="s2">/knowledge&quot;</span>
</span><span id="create_combined_knowledge_base-180"><a href="#create_combined_knowledge_base-180"><span class="linenos">180</span></a>
</span><span id="create_combined_knowledge_base-181"><a href="#create_combined_knowledge_base-181"><span class="linenos">181</span></a>    <span class="n">storage_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-182"><a href="#create_combined_knowledge_base-182"><span class="linenos">182</span></a>    <span class="n">storage_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-183"><a href="#create_combined_knowledge_base-183"><span class="linenos">183</span></a>
</span><span id="create_combined_knowledge_base-184"><a href="#create_combined_knowledge_base-184"><span class="linenos">184</span></a>    <span class="n">knowledge_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">knowledge_dir</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-185"><a href="#create_combined_knowledge_base-185"><span class="linenos">185</span></a>    <span class="c1"># Ensure the knowledge directory exists, creating it if necessary.</span>
</span><span id="create_combined_knowledge_base-186"><a href="#create_combined_knowledge_base-186"><span class="linenos">186</span></a>    <span class="n">knowledge_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-187"><a href="#create_combined_knowledge_base-187"><span class="linenos">187</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Knowledge directory is ready at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">knowledge_path</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-188"><a href="#create_combined_knowledge_base-188"><span class="linenos">188</span></a>
</span><span id="create_combined_knowledge_base-189"><a href="#create_combined_knowledge_base-189"><span class="linenos">189</span></a>    <span class="c1"># Check for available knowledge files</span>
</span><span id="create_combined_knowledge_base-190"><a href="#create_combined_knowledge_base-190"><span class="linenos">190</span></a>    <span class="n">text_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">knowledge_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.txt&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">knowledge_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">knowledge_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.html&quot;</span><span class="p">))</span>
</span><span id="create_combined_knowledge_base-191"><a href="#create_combined_knowledge_base-191"><span class="linenos">191</span></a>    <span class="n">pdf_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">knowledge_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.pdf&quot;</span><span class="p">))</span>
</span><span id="create_combined_knowledge_base-192"><a href="#create_combined_knowledge_base-192"><span class="linenos">192</span></a>
</span><span id="create_combined_knowledge_base-193"><a href="#create_combined_knowledge_base-193"><span class="linenos">193</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="create_combined_knowledge_base-194"><a href="#create_combined_knowledge_base-194"><span class="linenos">194</span></a>        <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> text files and </span><span class="si">%d</span><span class="s2"> PDF files in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-195"><a href="#create_combined_knowledge_base-195"><span class="linenos">195</span></a>        <span class="nb">len</span><span class="p">(</span><span class="n">text_files</span><span class="p">),</span>
</span><span id="create_combined_knowledge_base-196"><a href="#create_combined_knowledge_base-196"><span class="linenos">196</span></a>        <span class="nb">len</span><span class="p">(</span><span class="n">pdf_files</span><span class="p">),</span>
</span><span id="create_combined_knowledge_base-197"><a href="#create_combined_knowledge_base-197"><span class="linenos">197</span></a>        <span class="n">knowledge_path</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-198"><a href="#create_combined_knowledge_base-198"><span class="linenos">198</span></a>    <span class="p">)</span>
</span><span id="create_combined_knowledge_base-199"><a href="#create_combined_knowledge_base-199"><span class="linenos">199</span></a>
</span><span id="create_combined_knowledge_base-200"><a href="#create_combined_knowledge_base-200"><span class="linenos">200</span></a>    <span class="c1"># Create vector databases for each knowledge type</span>
</span><span id="create_combined_knowledge_base-201"><a href="#create_combined_knowledge_base-201"><span class="linenos">201</span></a>    <span class="n">embedder</span> <span class="o">=</span> <span class="n">OllamaEmbedder</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;nomic-embed-text&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">OLLAMA_URL</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="mi">768</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-202"><a href="#create_combined_knowledge_base-202"><span class="linenos">202</span></a>
</span><span id="create_combined_knowledge_base-203"><a href="#create_combined_knowledge_base-203"><span class="linenos">203</span></a>    <span class="n">knowledge_sources</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="create_combined_knowledge_base-204"><a href="#create_combined_knowledge_base-204"><span class="linenos">204</span></a>
</span><span id="create_combined_knowledge_base-205"><a href="#create_combined_knowledge_base-205"><span class="linenos">205</span></a>    <span class="c1"># Create text knowledge base if text files exist</span>
</span><span id="create_combined_knowledge_base-206"><a href="#create_combined_knowledge_base-206"><span class="linenos">206</span></a>    <span class="k">if</span> <span class="n">text_files</span><span class="p">:</span>
</span><span id="create_combined_knowledge_base-207"><a href="#create_combined_knowledge_base-207"><span class="linenos">207</span></a>        <span class="n">text_vector_db</span> <span class="o">=</span> <span class="n">LanceDb</span><span class="p">(</span>
</span><span id="create_combined_knowledge_base-208"><a href="#create_combined_knowledge_base-208"><span class="linenos">208</span></a>            <span class="n">uri</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">storage_path</span> <span class="o">/</span> <span class="s2">&quot;lancedb&quot;</span><span class="p">),</span>
</span><span id="create_combined_knowledge_base-209"><a href="#create_combined_knowledge_base-209"><span class="linenos">209</span></a>            <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;text_knowledge&quot;</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-210"><a href="#create_combined_knowledge_base-210"><span class="linenos">210</span></a>            <span class="n">search_type</span><span class="o">=</span><span class="n">SearchType</span><span class="o">.</span><span class="n">hybrid</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-211"><a href="#create_combined_knowledge_base-211"><span class="linenos">211</span></a>            <span class="n">embedder</span><span class="o">=</span><span class="n">embedder</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-212"><a href="#create_combined_knowledge_base-212"><span class="linenos">212</span></a>        <span class="p">)</span>
</span><span id="create_combined_knowledge_base-213"><a href="#create_combined_knowledge_base-213"><span class="linenos">213</span></a>
</span><span id="create_combined_knowledge_base-214"><a href="#create_combined_knowledge_base-214"><span class="linenos">214</span></a>        <span class="n">text_kb</span> <span class="o">=</span> <span class="n">TextKnowledgeBase</span><span class="p">(</span>
</span><span id="create_combined_knowledge_base-215"><a href="#create_combined_knowledge_base-215"><span class="linenos">215</span></a>            <span class="n">path</span><span class="o">=</span><span class="n">knowledge_path</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-216"><a href="#create_combined_knowledge_base-216"><span class="linenos">216</span></a>            <span class="n">vector_db</span><span class="o">=</span><span class="n">text_vector_db</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-217"><a href="#create_combined_knowledge_base-217"><span class="linenos">217</span></a>            <span class="n">num_documents</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">text_files</span><span class="p">),</span>
</span><span id="create_combined_knowledge_base-218"><a href="#create_combined_knowledge_base-218"><span class="linenos">218</span></a>        <span class="p">)</span>
</span><span id="create_combined_knowledge_base-219"><a href="#create_combined_knowledge_base-219"><span class="linenos">219</span></a>        <span class="n">knowledge_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text_kb</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-220"><a href="#create_combined_knowledge_base-220"><span class="linenos">220</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created TextKnowledgeBase with </span><span class="si">%d</span><span class="s2"> files&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_files</span><span class="p">))</span>
</span><span id="create_combined_knowledge_base-221"><a href="#create_combined_knowledge_base-221"><span class="linenos">221</span></a>
</span><span id="create_combined_knowledge_base-222"><a href="#create_combined_knowledge_base-222"><span class="linenos">222</span></a>    <span class="c1"># Create PDF knowledge base if PDF files exist</span>
</span><span id="create_combined_knowledge_base-223"><a href="#create_combined_knowledge_base-223"><span class="linenos">223</span></a>    <span class="k">if</span> <span class="n">pdf_files</span><span class="p">:</span>
</span><span id="create_combined_knowledge_base-224"><a href="#create_combined_knowledge_base-224"><span class="linenos">224</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="create_combined_knowledge_base-225"><a href="#create_combined_knowledge_base-225"><span class="linenos">225</span></a>            <span class="n">pdf_vector_db</span> <span class="o">=</span> <span class="n">LanceDb</span><span class="p">(</span>
</span><span id="create_combined_knowledge_base-226"><a href="#create_combined_knowledge_base-226"><span class="linenos">226</span></a>                <span class="n">uri</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">storage_path</span> <span class="o">/</span> <span class="s2">&quot;lancedb&quot;</span><span class="p">),</span>
</span><span id="create_combined_knowledge_base-227"><a href="#create_combined_knowledge_base-227"><span class="linenos">227</span></a>                <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;pdf_knowledge&quot;</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-228"><a href="#create_combined_knowledge_base-228"><span class="linenos">228</span></a>                <span class="n">search_type</span><span class="o">=</span><span class="n">SearchType</span><span class="o">.</span><span class="n">hybrid</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-229"><a href="#create_combined_knowledge_base-229"><span class="linenos">229</span></a>                <span class="n">embedder</span><span class="o">=</span><span class="n">embedder</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-230"><a href="#create_combined_knowledge_base-230"><span class="linenos">230</span></a>            <span class="p">)</span>
</span><span id="create_combined_knowledge_base-231"><a href="#create_combined_knowledge_base-231"><span class="linenos">231</span></a>
</span><span id="create_combined_knowledge_base-232"><a href="#create_combined_knowledge_base-232"><span class="linenos">232</span></a>            <span class="n">pdf_kb</span> <span class="o">=</span> <span class="n">PDFKnowledgeBase</span><span class="p">(</span>
</span><span id="create_combined_knowledge_base-233"><a href="#create_combined_knowledge_base-233"><span class="linenos">233</span></a>                <span class="n">path</span><span class="o">=</span><span class="n">knowledge_path</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-234"><a href="#create_combined_knowledge_base-234"><span class="linenos">234</span></a>                <span class="n">vector_db</span><span class="o">=</span><span class="n">pdf_vector_db</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-235"><a href="#create_combined_knowledge_base-235"><span class="linenos">235</span></a>            <span class="p">)</span>
</span><span id="create_combined_knowledge_base-236"><a href="#create_combined_knowledge_base-236"><span class="linenos">236</span></a>            <span class="n">knowledge_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdf_kb</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-237"><a href="#create_combined_knowledge_base-237"><span class="linenos">237</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created PDFKnowledgeBase with </span><span class="si">%d</span><span class="s2"> files&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf_files</span><span class="p">))</span>
</span><span id="create_combined_knowledge_base-238"><a href="#create_combined_knowledge_base-238"><span class="linenos">238</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="create_combined_knowledge_base-239"><a href="#create_combined_knowledge_base-239"><span class="linenos">239</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to create PDFKnowledgeBase due to corrupted PDF files: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-240"><a href="#create_combined_knowledge_base-240"><span class="linenos">240</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skipping PDF knowledge base. Check for corrupted PDF files in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">knowledge_path</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-241"><a href="#create_combined_knowledge_base-241"><span class="linenos">241</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Consider removing or repairing corrupted PDF files like &#39;allosteric.pdf&#39;&quot;</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-242"><a href="#create_combined_knowledge_base-242"><span class="linenos">242</span></a>
</span><span id="create_combined_knowledge_base-243"><a href="#create_combined_knowledge_base-243"><span class="linenos">243</span></a>    <span class="c1"># Create a knowledge base with the ArXiv documents</span>
</span><span id="create_combined_knowledge_base-244"><a href="#create_combined_knowledge_base-244"><span class="linenos">244</span></a>    <span class="n">arxiv_vector_db</span> <span class="o">=</span> <span class="n">LanceDb</span><span class="p">(</span>
</span><span id="create_combined_knowledge_base-245"><a href="#create_combined_knowledge_base-245"><span class="linenos">245</span></a>        <span class="n">uri</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">storage_path</span> <span class="o">/</span> <span class="s2">&quot;lancedb&quot;</span><span class="p">),</span>
</span><span id="create_combined_knowledge_base-246"><a href="#create_combined_knowledge_base-246"><span class="linenos">246</span></a>        <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;arxive_knowledge&quot;</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-247"><a href="#create_combined_knowledge_base-247"><span class="linenos">247</span></a>        <span class="n">search_type</span><span class="o">=</span><span class="n">SearchType</span><span class="o">.</span><span class="n">hybrid</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-248"><a href="#create_combined_knowledge_base-248"><span class="linenos">248</span></a>        <span class="n">embedder</span><span class="o">=</span><span class="n">embedder</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-249"><a href="#create_combined_knowledge_base-249"><span class="linenos">249</span></a>    <span class="p">)</span>
</span><span id="create_combined_knowledge_base-250"><a href="#create_combined_knowledge_base-250"><span class="linenos">250</span></a>    <span class="n">arxive_kb</span> <span class="o">=</span> <span class="n">ArxivKnowledgeBase</span><span class="p">(</span><span class="n">vector_db</span><span class="o">=</span><span class="n">arxiv_vector_db</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-251"><a href="#create_combined_knowledge_base-251"><span class="linenos">251</span></a>
</span><span id="create_combined_knowledge_base-252"><a href="#create_combined_knowledge_base-252"><span class="linenos">252</span></a>    <span class="n">knowledge_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arxive_kb</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-253"><a href="#create_combined_knowledge_base-253"><span class="linenos">253</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created Arxive KnowledgeBase&quot;</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-254"><a href="#create_combined_knowledge_base-254"><span class="linenos">254</span></a>
</span><span id="create_combined_knowledge_base-255"><a href="#create_combined_knowledge_base-255"><span class="linenos">255</span></a>    <span class="c1"># Log if no local knowledge files were found, but continue with ArXiv</span>
</span><span id="create_combined_knowledge_base-256"><a href="#create_combined_knowledge_base-256"><span class="linenos">256</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">text_files</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pdf_files</span><span class="p">:</span>
</span><span id="create_combined_knowledge_base-257"><a href="#create_combined_knowledge_base-257"><span class="linenos">257</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No local knowledge files found in </span><span class="si">%s</span><span class="s2">, but ArXiv knowledge base will be available&quot;</span><span class="p">,</span> <span class="n">knowledge_path</span><span class="p">)</span>
</span><span id="create_combined_knowledge_base-258"><a href="#create_combined_knowledge_base-258"><span class="linenos">258</span></a>
</span><span id="create_combined_knowledge_base-259"><a href="#create_combined_knowledge_base-259"><span class="linenos">259</span></a>    <span class="c1"># Create combined knowledge base</span>
</span><span id="create_combined_knowledge_base-260"><a href="#create_combined_knowledge_base-260"><span class="linenos">260</span></a>    <span class="k">if</span> <span class="n">knowledge_sources</span><span class="p">:</span>
</span><span id="create_combined_knowledge_base-261"><a href="#create_combined_knowledge_base-261"><span class="linenos">261</span></a>        <span class="n">combined_vector_db</span> <span class="o">=</span> <span class="n">LanceDb</span><span class="p">(</span>
</span><span id="create_combined_knowledge_base-262"><a href="#create_combined_knowledge_base-262"><span class="linenos">262</span></a>            <span class="n">uri</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">storage_path</span> <span class="o">/</span> <span class="s2">&quot;lancedb&quot;</span><span class="p">),</span>
</span><span id="create_combined_knowledge_base-263"><a href="#create_combined_knowledge_base-263"><span class="linenos">263</span></a>            <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;combined_knowledge&quot;</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-264"><a href="#create_combined_knowledge_base-264"><span class="linenos">264</span></a>            <span class="n">search_type</span><span class="o">=</span><span class="n">SearchType</span><span class="o">.</span><span class="n">hybrid</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-265"><a href="#create_combined_knowledge_base-265"><span class="linenos">265</span></a>            <span class="n">embedder</span><span class="o">=</span><span class="n">embedder</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-266"><a href="#create_combined_knowledge_base-266"><span class="linenos">266</span></a>        <span class="p">)</span>
</span><span id="create_combined_knowledge_base-267"><a href="#create_combined_knowledge_base-267"><span class="linenos">267</span></a>
</span><span id="create_combined_knowledge_base-268"><a href="#create_combined_knowledge_base-268"><span class="linenos">268</span></a>        <span class="n">combined_kb</span> <span class="o">=</span> <span class="n">CombinedKnowledgeBase</span><span class="p">(</span>
</span><span id="create_combined_knowledge_base-269"><a href="#create_combined_knowledge_base-269"><span class="linenos">269</span></a>            <span class="n">sources</span><span class="o">=</span><span class="n">knowledge_sources</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-270"><a href="#create_combined_knowledge_base-270"><span class="linenos">270</span></a>            <span class="n">vector_db</span><span class="o">=</span><span class="n">combined_vector_db</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-271"><a href="#create_combined_knowledge_base-271"><span class="linenos">271</span></a>        <span class="p">)</span>
</span><span id="create_combined_knowledge_base-272"><a href="#create_combined_knowledge_base-272"><span class="linenos">272</span></a>
</span><span id="create_combined_knowledge_base-273"><a href="#create_combined_knowledge_base-273"><span class="linenos">273</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="create_combined_knowledge_base-274"><a href="#create_combined_knowledge_base-274"><span class="linenos">274</span></a>            <span class="s2">&quot;Successfully created combined knowledge base with </span><span class="si">%d</span><span class="s2"> sources (</span><span class="si">%d</span><span class="s2"> text, </span><span class="si">%d</span><span class="s2"> PDF)&quot;</span><span class="p">,</span>
</span><span id="create_combined_knowledge_base-275"><a href="#create_combined_knowledge_base-275"><span class="linenos">275</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">knowledge_sources</span><span class="p">),</span>
</span><span id="create_combined_knowledge_base-276"><a href="#create_combined_knowledge_base-276"><span class="linenos">276</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">text_files</span><span class="p">),</span>
</span><span id="create_combined_knowledge_base-277"><a href="#create_combined_knowledge_base-277"><span class="linenos">277</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">pdf_files</span><span class="p">),</span>
</span><span id="create_combined_knowledge_base-278"><a href="#create_combined_knowledge_base-278"><span class="linenos">278</span></a>        <span class="p">)</span>
</span><span id="create_combined_knowledge_base-279"><a href="#create_combined_knowledge_base-279"><span class="linenos">279</span></a>
</span><span id="create_combined_knowledge_base-280"><a href="#create_combined_knowledge_base-280"><span class="linenos">280</span></a>        <span class="k">return</span> <span class="n">combined_kb</span>
</span><span id="create_combined_knowledge_base-281"><a href="#create_combined_knowledge_base-281"><span class="linenos">281</span></a>
</span><span id="create_combined_knowledge_base-282"><a href="#create_combined_knowledge_base-282"><span class="linenos">282</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Create a combined knowledge base with text and PDF sources (synchronous creation).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>storage_dir</strong>:  Directory for storage files (defaults to DATA_DIR/agno)</li>
<li><strong>knowledge_dir</strong>:  Directory containing knowledge files to load (defaults to DATA_DIR/knowledge)</li>
<li><strong>db_url</strong>:  SqliteStorage for the database</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Configured CombinedKnowledgeBase instance or None if no knowledge found</p>
</blockquote>
</div>


                </section>
                <section id="load_combined_knowledge_base">
                            <input id="load_combined_knowledge_base-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">load_combined_knowledge_base</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">knowledge_base</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">knowledge</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">CombinedKnowledgeBase</span>,</span><span class="param">	<span class="n">recreate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="load_combined_knowledge_base-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#load_combined_knowledge_base"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="load_combined_knowledge_base-285"><a href="#load_combined_knowledge_base-285"><span class="linenos">285</span></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_combined_knowledge_base</span><span class="p">(</span>
</span><span id="load_combined_knowledge_base-286"><a href="#load_combined_knowledge_base-286"><span class="linenos">286</span></a>    <span class="n">knowledge_base</span><span class="p">:</span> <span class="n">CombinedKnowledgeBase</span><span class="p">,</span> <span class="n">recreate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="load_combined_knowledge_base-287"><a href="#load_combined_knowledge_base-287"><span class="linenos">287</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="load_combined_knowledge_base-288"><a href="#load_combined_knowledge_base-288"><span class="linenos">288</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load combined knowledge base content (async loading).</span>
</span><span id="load_combined_knowledge_base-289"><a href="#load_combined_knowledge_base-289"><span class="linenos">289</span></a>
</span><span id="load_combined_knowledge_base-290"><a href="#load_combined_knowledge_base-290"><span class="linenos">290</span></a><span class="sd">    :param knowledge_base: CombinedKnowledgeBase instance to load</span>
</span><span id="load_combined_knowledge_base-291"><a href="#load_combined_knowledge_base-291"><span class="linenos">291</span></a><span class="sd">    :param recreate: Whether to recreate the knowledge base from scratch</span>
</span><span id="load_combined_knowledge_base-292"><a href="#load_combined_knowledge_base-292"><span class="linenos">292</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="load_combined_knowledge_base-293"><a href="#load_combined_knowledge_base-293"><span class="linenos">293</span></a>    <span class="k">if</span> <span class="n">recreate</span><span class="p">:</span>
</span><span id="load_combined_knowledge_base-294"><a href="#load_combined_knowledge_base-294"><span class="linenos">294</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; RECREATING knowledge base from scratch (recreate=True)&quot;</span><span class="p">)</span>
</span><span id="load_combined_knowledge_base-295"><a href="#load_combined_knowledge_base-295"><span class="linenos">295</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="load_combined_knowledge_base-296"><a href="#load_combined_knowledge_base-296"><span class="linenos">296</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading combined knowledge base content...&quot;</span><span class="p">)</span>
</span><span id="load_combined_knowledge_base-297"><a href="#load_combined_knowledge_base-297"><span class="linenos">297</span></a>
</span><span id="load_combined_knowledge_base-298"><a href="#load_combined_knowledge_base-298"><span class="linenos">298</span></a>    <span class="c1"># Use synchronous load in an async context - this matches agno framework patterns</span>
</span><span id="load_combined_knowledge_base-299"><a href="#load_combined_knowledge_base-299"><span class="linenos">299</span></a>    <span class="c1"># The synchronous load method is more stable than aload which can return async generators</span>
</span><span id="load_combined_knowledge_base-300"><a href="#load_combined_knowledge_base-300"><span class="linenos">300</span></a>    <span class="n">knowledge_base</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">recreate</span><span class="o">=</span><span class="n">recreate</span><span class="p">)</span>
</span><span id="load_combined_knowledge_base-301"><a href="#load_combined_knowledge_base-301"><span class="linenos">301</span></a>
</span><span id="load_combined_knowledge_base-302"><a href="#load_combined_knowledge_base-302"><span class="linenos">302</span></a>    <span class="k">if</span> <span class="n">recreate</span><span class="p">:</span>
</span><span id="load_combined_knowledge_base-303"><a href="#load_combined_knowledge_base-303"><span class="linenos">303</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Knowledge base RECREATED successfully&quot;</span><span class="p">)</span>
</span><span id="load_combined_knowledge_base-304"><a href="#load_combined_knowledge_base-304"><span class="linenos">304</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="load_combined_knowledge_base-305"><a href="#load_combined_knowledge_base-305"><span class="linenos">305</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Combined knowledge base loaded successfully&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load combined knowledge base content (async loading).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>knowledge_base</strong>:  CombinedKnowledgeBase instance to load</li>
<li><strong>recreate</strong>:  Whether to recreate the knowledge base from scratch</li>
</ul>
</div>


                </section>
                <section id="load_lightrag_knowledge_base">
                            <input id="load_lightrag_knowledge_base-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">load_lightrag_knowledge_base</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:9621&#39;</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="load_lightrag_knowledge_base-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#load_lightrag_knowledge_base"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="load_lightrag_knowledge_base-308"><a href="#load_lightrag_knowledge_base-308"><span class="linenos">308</span></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_lightrag_knowledge_base</span><span class="p">(</span><span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:9621&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="load_lightrag_knowledge_base-309"><a href="#load_lightrag_knowledge_base-309"><span class="linenos">309</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="load_lightrag_knowledge_base-310"><a href="#load_lightrag_knowledge_base-310"><span class="linenos">310</span></a><span class="sd">    Load the LightRAG knowledge base metadata.</span>
</span><span id="load_lightrag_knowledge_base-311"><a href="#load_lightrag_knowledge_base-311"><span class="linenos">311</span></a>
</span><span id="load_lightrag_knowledge_base-312"><a href="#load_lightrag_knowledge_base-312"><span class="linenos">312</span></a><span class="sd">    :param base_url: Base URL for the LightRAG server</span>
</span><span id="load_lightrag_knowledge_base-313"><a href="#load_lightrag_knowledge_base-313"><span class="linenos">313</span></a><span class="sd">    :return: Dictionary with knowledge base status/info</span>
</span><span id="load_lightrag_knowledge_base-314"><a href="#load_lightrag_knowledge_base-314"><span class="linenos">314</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="load_lightrag_knowledge_base-315"><a href="#load_lightrag_knowledge_base-315"><span class="linenos">315</span></a>    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/documents&quot;</span>
</span><span id="load_lightrag_knowledge_base-316"><a href="#load_lightrag_knowledge_base-316"><span class="linenos">316</span></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="load_lightrag_knowledge_base-317"><a href="#load_lightrag_knowledge_base-317"><span class="linenos">317</span></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="load_lightrag_knowledge_base-318"><a href="#load_lightrag_knowledge_base-318"><span class="linenos">318</span></a>            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="load_lightrag_knowledge_base-319"><a href="#load_lightrag_knowledge_base-319"><span class="linenos">319</span></a>            <span class="k">return</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Load the LightRAG knowledge base metadata.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>base_url</strong>:  Base URL for the LightRAG server</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Dictionary with knowledge base status/info</p>
</blockquote>
</div>


                </section>
                <section id="AntiDuplicateMemory">
                            <input id="AntiDuplicateMemory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AntiDuplicateMemory</span><wbr>(<span class="base">agno.memory.v2.memory.Memory</span>):

                <label class="view-source-button" for="AntiDuplicateMemory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AntiDuplicateMemory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AntiDuplicateMemory-55"><a href="#AntiDuplicateMemory-55"><span class="linenos"> 55</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AntiDuplicateMemory</span><span class="p">(</span><span class="n">Memory</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory-56"><a href="#AntiDuplicateMemory-56"><span class="linenos"> 56</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-57"><a href="#AntiDuplicateMemory-57"><span class="linenos"> 57</span></a><span class="sd">    Enhanced Memory class that prevents duplicate memory creation.</span>
</span><span id="AntiDuplicateMemory-58"><a href="#AntiDuplicateMemory-58"><span class="linenos"> 58</span></a>
</span><span id="AntiDuplicateMemory-59"><a href="#AntiDuplicateMemory-59"><span class="linenos"> 59</span></a><span class="sd">    This class extends Agno&#39;s Memory class with intelligent duplicate detection</span>
</span><span id="AntiDuplicateMemory-60"><a href="#AntiDuplicateMemory-60"><span class="linenos"> 60</span></a><span class="sd">    and prevention mechanisms specifically designed to address the memory</span>
</span><span id="AntiDuplicateMemory-61"><a href="#AntiDuplicateMemory-61"><span class="linenos"> 61</span></a><span class="sd">    duplication issues found in Ollama models.</span>
</span><span id="AntiDuplicateMemory-62"><a href="#AntiDuplicateMemory-62"><span class="linenos"> 62</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-63"><a href="#AntiDuplicateMemory-63"><span class="linenos"> 63</span></a>
</span><span id="AntiDuplicateMemory-64"><a href="#AntiDuplicateMemory-64"><span class="linenos"> 64</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-65"><a href="#AntiDuplicateMemory-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-66"><a href="#AntiDuplicateMemory-66"><span class="linenos"> 66</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-67"><a href="#AntiDuplicateMemory-67"><span class="linenos"> 67</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-68"><a href="#AntiDuplicateMemory-68"><span class="linenos"> 68</span></a>        <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-69"><a href="#AntiDuplicateMemory-69"><span class="linenos"> 69</span></a>        <span class="n">enable_semantic_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-70"><a href="#AntiDuplicateMemory-70"><span class="linenos"> 70</span></a>        <span class="n">enable_exact_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-71"><a href="#AntiDuplicateMemory-71"><span class="linenos"> 71</span></a>        <span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-72"><a href="#AntiDuplicateMemory-72"><span class="linenos"> 72</span></a>        <span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-73"><a href="#AntiDuplicateMemory-73"><span class="linenos"> 73</span></a>        <span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-74"><a href="#AntiDuplicateMemory-74"><span class="linenos"> 74</span></a>        <span class="n">enable_optimizations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-75"><a href="#AntiDuplicateMemory-75"><span class="linenos"> 75</span></a>    <span class="p">):</span>
</span><span id="AntiDuplicateMemory-76"><a href="#AntiDuplicateMemory-76"><span class="linenos"> 76</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-77"><a href="#AntiDuplicateMemory-77"><span class="linenos"> 77</span></a><span class="sd">        Initialize the anti-duplicate memory manager.</span>
</span><span id="AntiDuplicateMemory-78"><a href="#AntiDuplicateMemory-78"><span class="linenos"> 78</span></a>
</span><span id="AntiDuplicateMemory-79"><a href="#AntiDuplicateMemory-79"><span class="linenos"> 79</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="AntiDuplicateMemory-80"><a href="#AntiDuplicateMemory-80"><span class="linenos"> 80</span></a><span class="sd">        :param model: Model for memory operations</span>
</span><span id="AntiDuplicateMemory-81"><a href="#AntiDuplicateMemory-81"><span class="linenos"> 81</span></a><span class="sd">        :param similarity_threshold: Threshold for semantic similarity (0.0-1.0)</span>
</span><span id="AntiDuplicateMemory-82"><a href="#AntiDuplicateMemory-82"><span class="linenos"> 82</span></a><span class="sd">        :param enable_semantic_dedup: Enable semantic duplicate detection</span>
</span><span id="AntiDuplicateMemory-83"><a href="#AntiDuplicateMemory-83"><span class="linenos"> 83</span></a><span class="sd">        :param enable_exact_dedup: Enable exact duplicate detection</span>
</span><span id="AntiDuplicateMemory-84"><a href="#AntiDuplicateMemory-84"><span class="linenos"> 84</span></a><span class="sd">        :param debug_mode: Enable debug logging</span>
</span><span id="AntiDuplicateMemory-85"><a href="#AntiDuplicateMemory-85"><span class="linenos"> 85</span></a><span class="sd">        :param delete_memories: Allow the agent to delete memories when needed</span>
</span><span id="AntiDuplicateMemory-86"><a href="#AntiDuplicateMemory-86"><span class="linenos"> 86</span></a><span class="sd">        :param clear_memories: Allow the agent to clear all memories</span>
</span><span id="AntiDuplicateMemory-87"><a href="#AntiDuplicateMemory-87"><span class="linenos"> 87</span></a><span class="sd">        :param enable_optimizations: Enable performance optimizations using direct read_memories calls</span>
</span><span id="AntiDuplicateMemory-88"><a href="#AntiDuplicateMemory-88"><span class="linenos"> 88</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-89"><a href="#AntiDuplicateMemory-89"><span class="linenos"> 89</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-90"><a href="#AntiDuplicateMemory-90"><span class="linenos"> 90</span></a>            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-91"><a href="#AntiDuplicateMemory-91"><span class="linenos"> 91</span></a>            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-92"><a href="#AntiDuplicateMemory-92"><span class="linenos"> 92</span></a>            <span class="n">delete_memories</span><span class="o">=</span><span class="n">delete_memories</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-93"><a href="#AntiDuplicateMemory-93"><span class="linenos"> 93</span></a>            <span class="n">clear_memories</span><span class="o">=</span><span class="n">clear_memories</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-94"><a href="#AntiDuplicateMemory-94"><span class="linenos"> 94</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory-95"><a href="#AntiDuplicateMemory-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span> <span class="o">=</span> <span class="n">similarity_threshold</span>
</span><span id="AntiDuplicateMemory-96"><a href="#AntiDuplicateMemory-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_semantic_dedup</span> <span class="o">=</span> <span class="n">enable_semantic_dedup</span>
</span><span id="AntiDuplicateMemory-97"><a href="#AntiDuplicateMemory-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_exact_dedup</span> <span class="o">=</span> <span class="n">enable_exact_dedup</span>
</span><span id="AntiDuplicateMemory-98"><a href="#AntiDuplicateMemory-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span> <span class="o">=</span> <span class="n">debug_mode</span>
</span><span id="AntiDuplicateMemory-99"><a href="#AntiDuplicateMemory-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_optimizations</span> <span class="o">=</span> <span class="n">enable_optimizations</span>
</span><span id="AntiDuplicateMemory-100"><a href="#AntiDuplicateMemory-100"><span class="linenos">100</span></a>
</span><span id="AntiDuplicateMemory-101"><a href="#AntiDuplicateMemory-101"><span class="linenos">101</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-102"><a href="#AntiDuplicateMemory-102"><span class="linenos">102</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-103"><a href="#AntiDuplicateMemory-103"><span class="linenos">103</span></a>
</span><span id="AntiDuplicateMemory-104"><a href="#AntiDuplicateMemory-104"><span class="linenos">104</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-105"><a href="#AntiDuplicateMemory-105"><span class="linenos">105</span></a>            <span class="s2">&quot;Initialized AntiDuplicateMemory with similarity_threshold=</span><span class="si">%.2f</span><span class="s2">, optimizations=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-106"><a href="#AntiDuplicateMemory-106"><span class="linenos">106</span></a>            <span class="n">similarity_threshold</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-107"><a href="#AntiDuplicateMemory-107"><span class="linenos">107</span></a>            <span class="n">enable_optimizations</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-108"><a href="#AntiDuplicateMemory-108"><span class="linenos">108</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory-109"><a href="#AntiDuplicateMemory-109"><span class="linenos">109</span></a>
</span><span id="AntiDuplicateMemory-110"><a href="#AntiDuplicateMemory-110"><span class="linenos">110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_exact_duplicate</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-111"><a href="#AntiDuplicateMemory-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">new_memory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]</span>
</span><span id="AntiDuplicateMemory-112"><a href="#AntiDuplicateMemory-112"><span class="linenos">112</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory-113"><a href="#AntiDuplicateMemory-113"><span class="linenos">113</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-114"><a href="#AntiDuplicateMemory-114"><span class="linenos">114</span></a><span class="sd">        Check for exact duplicate memories.</span>
</span><span id="AntiDuplicateMemory-115"><a href="#AntiDuplicateMemory-115"><span class="linenos">115</span></a>
</span><span id="AntiDuplicateMemory-116"><a href="#AntiDuplicateMemory-116"><span class="linenos">116</span></a><span class="sd">        :param new_memory: New memory text to check</span>
</span><span id="AntiDuplicateMemory-117"><a href="#AntiDuplicateMemory-117"><span class="linenos">117</span></a><span class="sd">        :param existing_memories: List of existing memories</span>
</span><span id="AntiDuplicateMemory-118"><a href="#AntiDuplicateMemory-118"><span class="linenos">118</span></a><span class="sd">        :return: Existing memory if duplicate found, None otherwise</span>
</span><span id="AntiDuplicateMemory-119"><a href="#AntiDuplicateMemory-119"><span class="linenos">119</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-120"><a href="#AntiDuplicateMemory-120"><span class="linenos">120</span></a>        <span class="n">new_memory_clean</span> <span class="o">=</span> <span class="n">new_memory</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-121"><a href="#AntiDuplicateMemory-121"><span class="linenos">121</span></a>
</span><span id="AntiDuplicateMemory-122"><a href="#AntiDuplicateMemory-122"><span class="linenos">122</span></a>        <span class="k">for</span> <span class="n">existing</span> <span class="ow">in</span> <span class="n">existing_memories</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-123"><a href="#AntiDuplicateMemory-123"><span class="linenos">123</span></a>            <span class="n">existing_clean</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-124"><a href="#AntiDuplicateMemory-124"><span class="linenos">124</span></a>            <span class="k">if</span> <span class="n">new_memory_clean</span> <span class="o">==</span> <span class="n">existing_clean</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-125"><a href="#AntiDuplicateMemory-125"><span class="linenos">125</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exact duplicate found: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">new_memory</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-126"><a href="#AntiDuplicateMemory-126"><span class="linenos">126</span></a>                <span class="k">return</span> <span class="n">existing</span>
</span><span id="AntiDuplicateMemory-127"><a href="#AntiDuplicateMemory-127"><span class="linenos">127</span></a>
</span><span id="AntiDuplicateMemory-128"><a href="#AntiDuplicateMemory-128"><span class="linenos">128</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="AntiDuplicateMemory-129"><a href="#AntiDuplicateMemory-129"><span class="linenos">129</span></a>
</span><span id="AntiDuplicateMemory-130"><a href="#AntiDuplicateMemory-130"><span class="linenos">130</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_semantic_duplicate</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-131"><a href="#AntiDuplicateMemory-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">new_memory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]</span>
</span><span id="AntiDuplicateMemory-132"><a href="#AntiDuplicateMemory-132"><span class="linenos">132</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory-133"><a href="#AntiDuplicateMemory-133"><span class="linenos">133</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-134"><a href="#AntiDuplicateMemory-134"><span class="linenos">134</span></a><span class="sd">        Check for semantic duplicate memories using text similarity.</span>
</span><span id="AntiDuplicateMemory-135"><a href="#AntiDuplicateMemory-135"><span class="linenos">135</span></a>
</span><span id="AntiDuplicateMemory-136"><a href="#AntiDuplicateMemory-136"><span class="linenos">136</span></a><span class="sd">        :param new_memory: New memory text to check</span>
</span><span id="AntiDuplicateMemory-137"><a href="#AntiDuplicateMemory-137"><span class="linenos">137</span></a><span class="sd">        :param existing_memories: List of existing memories</span>
</span><span id="AntiDuplicateMemory-138"><a href="#AntiDuplicateMemory-138"><span class="linenos">138</span></a><span class="sd">        :return: Existing memory if duplicate found, None otherwise</span>
</span><span id="AntiDuplicateMemory-139"><a href="#AntiDuplicateMemory-139"><span class="linenos">139</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-140"><a href="#AntiDuplicateMemory-140"><span class="linenos">140</span></a>        <span class="n">new_memory_clean</span> <span class="o">=</span> <span class="n">new_memory</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-141"><a href="#AntiDuplicateMemory-141"><span class="linenos">141</span></a>
</span><span id="AntiDuplicateMemory-142"><a href="#AntiDuplicateMemory-142"><span class="linenos">142</span></a>        <span class="k">for</span> <span class="n">existing</span> <span class="ow">in</span> <span class="n">existing_memories</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-143"><a href="#AntiDuplicateMemory-143"><span class="linenos">143</span></a>            <span class="n">existing_clean</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-144"><a href="#AntiDuplicateMemory-144"><span class="linenos">144</span></a>
</span><span id="AntiDuplicateMemory-145"><a href="#AntiDuplicateMemory-145"><span class="linenos">145</span></a>            <span class="c1"># Use difflib for similarity calculation</span>
</span><span id="AntiDuplicateMemory-146"><a href="#AntiDuplicateMemory-146"><span class="linenos">146</span></a>            <span class="n">similarity</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-147"><a href="#AntiDuplicateMemory-147"><span class="linenos">147</span></a>                <span class="kc">None</span><span class="p">,</span> <span class="n">new_memory_clean</span><span class="p">,</span> <span class="n">existing_clean</span>
</span><span id="AntiDuplicateMemory-148"><a href="#AntiDuplicateMemory-148"><span class="linenos">148</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-149"><a href="#AntiDuplicateMemory-149"><span class="linenos">149</span></a>
</span><span id="AntiDuplicateMemory-150"><a href="#AntiDuplicateMemory-150"><span class="linenos">150</span></a>            <span class="c1"># Determine appropriate similarity threshold based on content analysis</span>
</span><span id="AntiDuplicateMemory-151"><a href="#AntiDuplicateMemory-151"><span class="linenos">151</span></a>            <span class="n">semantic_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_semantic_threshold</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-152"><a href="#AntiDuplicateMemory-152"><span class="linenos">152</span></a>                <span class="n">new_memory_clean</span><span class="p">,</span> <span class="n">existing_clean</span>
</span><span id="AntiDuplicateMemory-153"><a href="#AntiDuplicateMemory-153"><span class="linenos">153</span></a>            <span class="p">)</span>
</span><span id="AntiDuplicateMemory-154"><a href="#AntiDuplicateMemory-154"><span class="linenos">154</span></a>
</span><span id="AntiDuplicateMemory-155"><a href="#AntiDuplicateMemory-155"><span class="linenos">155</span></a>            <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">semantic_threshold</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-156"><a href="#AntiDuplicateMemory-156"><span class="linenos">156</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-157"><a href="#AntiDuplicateMemory-157"><span class="linenos">157</span></a>                    <span class="s2">&quot;Semantic duplicate found (similarity: </span><span class="si">%.2f</span><span class="s2">): &#39;</span><span class="si">%s</span><span class="s2">&#39; ~ &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-158"><a href="#AntiDuplicateMemory-158"><span class="linenos">158</span></a>                    <span class="n">similarity</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-159"><a href="#AntiDuplicateMemory-159"><span class="linenos">159</span></a>                    <span class="n">new_memory</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-160"><a href="#AntiDuplicateMemory-160"><span class="linenos">160</span></a>                    <span class="n">existing</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-161"><a href="#AntiDuplicateMemory-161"><span class="linenos">161</span></a>                <span class="p">)</span>
</span><span id="AntiDuplicateMemory-162"><a href="#AntiDuplicateMemory-162"><span class="linenos">162</span></a>                <span class="k">return</span> <span class="n">existing</span>
</span><span id="AntiDuplicateMemory-163"><a href="#AntiDuplicateMemory-163"><span class="linenos">163</span></a>
</span><span id="AntiDuplicateMemory-164"><a href="#AntiDuplicateMemory-164"><span class="linenos">164</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="AntiDuplicateMemory-165"><a href="#AntiDuplicateMemory-165"><span class="linenos">165</span></a>
</span><span id="AntiDuplicateMemory-166"><a href="#AntiDuplicateMemory-166"><span class="linenos">166</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_semantic_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">memory2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-167"><a href="#AntiDuplicateMemory-167"><span class="linenos">167</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-168"><a href="#AntiDuplicateMemory-168"><span class="linenos">168</span></a><span class="sd">        Calculate the appropriate semantic similarity threshold based on memory content.</span>
</span><span id="AntiDuplicateMemory-169"><a href="#AntiDuplicateMemory-169"><span class="linenos">169</span></a>
</span><span id="AntiDuplicateMemory-170"><a href="#AntiDuplicateMemory-170"><span class="linenos">170</span></a><span class="sd">        This method analyzes the content of both memories to determine the most</span>
</span><span id="AntiDuplicateMemory-171"><a href="#AntiDuplicateMemory-171"><span class="linenos">171</span></a><span class="sd">        appropriate threshold for semantic duplicate detection.</span>
</span><span id="AntiDuplicateMemory-172"><a href="#AntiDuplicateMemory-172"><span class="linenos">172</span></a>
</span><span id="AntiDuplicateMemory-173"><a href="#AntiDuplicateMemory-173"><span class="linenos">173</span></a><span class="sd">        :param memory1: First memory text (cleaned/lowercased)</span>
</span><span id="AntiDuplicateMemory-174"><a href="#AntiDuplicateMemory-174"><span class="linenos">174</span></a><span class="sd">        :param memory2: Second memory text (cleaned/lowercased)</span>
</span><span id="AntiDuplicateMemory-175"><a href="#AntiDuplicateMemory-175"><span class="linenos">175</span></a><span class="sd">        :return: Similarity threshold to use for these memories</span>
</span><span id="AntiDuplicateMemory-176"><a href="#AntiDuplicateMemory-176"><span class="linenos">176</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-177"><a href="#AntiDuplicateMemory-177"><span class="linenos">177</span></a>        <span class="c1"># Special handling for structured test data</span>
</span><span id="AntiDuplicateMemory-178"><a href="#AntiDuplicateMemory-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_structured_test_data</span><span class="p">(</span><span class="n">memory1</span><span class="p">,</span> <span class="n">memory2</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory-179"><a href="#AntiDuplicateMemory-179"><span class="linenos">179</span></a>            <span class="c1"># For structured test data, use a much higher threshold to avoid false positives</span>
</span><span id="AntiDuplicateMemory-180"><a href="#AntiDuplicateMemory-180"><span class="linenos">180</span></a>            <span class="k">return</span> <span class="mf">0.95</span>
</span><span id="AntiDuplicateMemory-181"><a href="#AntiDuplicateMemory-181"><span class="linenos">181</span></a>
</span><span id="AntiDuplicateMemory-182"><a href="#AntiDuplicateMemory-182"><span class="linenos">182</span></a>        <span class="c1"># Check for preference-related memories that might be legitimately similar</span>
</span><span id="AntiDuplicateMemory-183"><a href="#AntiDuplicateMemory-183"><span class="linenos">183</span></a>        <span class="c1"># but represent different preferences (e.g., &quot;prefers tea&quot; vs &quot;likes tea&quot;)</span>
</span><span id="AntiDuplicateMemory-184"><a href="#AntiDuplicateMemory-184"><span class="linenos">184</span></a>        <span class="n">preference_indicators</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AntiDuplicateMemory-185"><a href="#AntiDuplicateMemory-185"><span class="linenos">185</span></a>            <span class="s2">&quot;prefer&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-186"><a href="#AntiDuplicateMemory-186"><span class="linenos">186</span></a>            <span class="s2">&quot;like&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-187"><a href="#AntiDuplicateMemory-187"><span class="linenos">187</span></a>            <span class="s2">&quot;enjoy&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-188"><a href="#AntiDuplicateMemory-188"><span class="linenos">188</span></a>            <span class="s2">&quot;love&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-189"><a href="#AntiDuplicateMemory-189"><span class="linenos">189</span></a>            <span class="s2">&quot;hate&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-190"><a href="#AntiDuplicateMemory-190"><span class="linenos">190</span></a>            <span class="s2">&quot;dislike&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-191"><a href="#AntiDuplicateMemory-191"><span class="linenos">191</span></a>            <span class="s2">&quot;favorite&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-192"><a href="#AntiDuplicateMemory-192"><span class="linenos">192</span></a>            <span class="s2">&quot;favourite&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-193"><a href="#AntiDuplicateMemory-193"><span class="linenos">193</span></a>            <span class="s2">&quot;best&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-194"><a href="#AntiDuplicateMemory-194"><span class="linenos">194</span></a>            <span class="s2">&quot;worst&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-195"><a href="#AntiDuplicateMemory-195"><span class="linenos">195</span></a>        <span class="p">]</span>
</span><span id="AntiDuplicateMemory-196"><a href="#AntiDuplicateMemory-196"><span class="linenos">196</span></a>
</span><span id="AntiDuplicateMemory-197"><a href="#AntiDuplicateMemory-197"><span class="linenos">197</span></a>        <span class="n">has_preferences</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-198"><a href="#AntiDuplicateMemory-198"><span class="linenos">198</span></a>            <span class="n">indicator</span> <span class="ow">in</span> <span class="n">memory1</span> <span class="ow">or</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">memory2</span>
</span><span id="AntiDuplicateMemory-199"><a href="#AntiDuplicateMemory-199"><span class="linenos">199</span></a>            <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">preference_indicators</span>
</span><span id="AntiDuplicateMemory-200"><a href="#AntiDuplicateMemory-200"><span class="linenos">200</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory-201"><a href="#AntiDuplicateMemory-201"><span class="linenos">201</span></a>
</span><span id="AntiDuplicateMemory-202"><a href="#AntiDuplicateMemory-202"><span class="linenos">202</span></a>        <span class="k">if</span> <span class="n">has_preferences</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-203"><a href="#AntiDuplicateMemory-203"><span class="linenos">203</span></a>            <span class="c1"># For preference-related memories, use a lower threshold to catch</span>
</span><span id="AntiDuplicateMemory-204"><a href="#AntiDuplicateMemory-204"><span class="linenos">204</span></a>            <span class="c1"># semantic duplicates like &quot;prefers tea&quot; and &quot;likes tea&quot;</span>
</span><span id="AntiDuplicateMemory-205"><a href="#AntiDuplicateMemory-205"><span class="linenos">205</span></a>            <span class="k">return</span> <span class="mf">0.65</span>
</span><span id="AntiDuplicateMemory-206"><a href="#AntiDuplicateMemory-206"><span class="linenos">206</span></a>
</span><span id="AntiDuplicateMemory-207"><a href="#AntiDuplicateMemory-207"><span class="linenos">207</span></a>        <span class="c1"># Check for factual statements that might have similar structure</span>
</span><span id="AntiDuplicateMemory-208"><a href="#AntiDuplicateMemory-208"><span class="linenos">208</span></a>        <span class="c1"># but different content (e.g., &quot;works in tech&quot; vs &quot;works in finance&quot;)</span>
</span><span id="AntiDuplicateMemory-209"><a href="#AntiDuplicateMemory-209"><span class="linenos">209</span></a>        <span class="n">factual_indicators</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AntiDuplicateMemory-210"><a href="#AntiDuplicateMemory-210"><span class="linenos">210</span></a>            <span class="s2">&quot;works&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-211"><a href="#AntiDuplicateMemory-211"><span class="linenos">211</span></a>            <span class="s2">&quot;lives&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-212"><a href="#AntiDuplicateMemory-212"><span class="linenos">212</span></a>            <span class="s2">&quot;has&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-213"><a href="#AntiDuplicateMemory-213"><span class="linenos">213</span></a>            <span class="s2">&quot;owns&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-214"><a href="#AntiDuplicateMemory-214"><span class="linenos">214</span></a>            <span class="s2">&quot;studies&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-215"><a href="#AntiDuplicateMemory-215"><span class="linenos">215</span></a>            <span class="s2">&quot;graduated&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-216"><a href="#AntiDuplicateMemory-216"><span class="linenos">216</span></a>            <span class="s2">&quot;born&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-217"><a href="#AntiDuplicateMemory-217"><span class="linenos">217</span></a>            <span class="s2">&quot;married&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-218"><a href="#AntiDuplicateMemory-218"><span class="linenos">218</span></a>            <span class="s2">&quot;single&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-219"><a href="#AntiDuplicateMemory-219"><span class="linenos">219</span></a>            <span class="s2">&quot;divorced&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-220"><a href="#AntiDuplicateMemory-220"><span class="linenos">220</span></a>        <span class="p">]</span>
</span><span id="AntiDuplicateMemory-221"><a href="#AntiDuplicateMemory-221"><span class="linenos">221</span></a>
</span><span id="AntiDuplicateMemory-222"><a href="#AntiDuplicateMemory-222"><span class="linenos">222</span></a>        <span class="n">has_factual_content</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-223"><a href="#AntiDuplicateMemory-223"><span class="linenos">223</span></a>            <span class="n">indicator</span> <span class="ow">in</span> <span class="n">memory1</span> <span class="ow">or</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">memory2</span>
</span><span id="AntiDuplicateMemory-224"><a href="#AntiDuplicateMemory-224"><span class="linenos">224</span></a>            <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">factual_indicators</span>
</span><span id="AntiDuplicateMemory-225"><a href="#AntiDuplicateMemory-225"><span class="linenos">225</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory-226"><a href="#AntiDuplicateMemory-226"><span class="linenos">226</span></a>
</span><span id="AntiDuplicateMemory-227"><a href="#AntiDuplicateMemory-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="n">has_factual_content</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-228"><a href="#AntiDuplicateMemory-228"><span class="linenos">228</span></a>            <span class="c1"># For factual content, use a moderate threshold</span>
</span><span id="AntiDuplicateMemory-229"><a href="#AntiDuplicateMemory-229"><span class="linenos">229</span></a>            <span class="k">return</span> <span class="mf">0.75</span>
</span><span id="AntiDuplicateMemory-230"><a href="#AntiDuplicateMemory-230"><span class="linenos">230</span></a>
</span><span id="AntiDuplicateMemory-231"><a href="#AntiDuplicateMemory-231"><span class="linenos">231</span></a>        <span class="c1"># Default threshold - use the configured similarity threshold but cap at 85%</span>
</span><span id="AntiDuplicateMemory-232"><a href="#AntiDuplicateMemory-232"><span class="linenos">232</span></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-233"><a href="#AntiDuplicateMemory-233"><span class="linenos">233</span></a>
</span><span id="AntiDuplicateMemory-234"><a href="#AntiDuplicateMemory-234"><span class="linenos">234</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_structured_test_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">memory2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-235"><a href="#AntiDuplicateMemory-235"><span class="linenos">235</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-236"><a href="#AntiDuplicateMemory-236"><span class="linenos">236</span></a><span class="sd">        Check if memories appear to be structured test data that might have high similarity</span>
</span><span id="AntiDuplicateMemory-237"><a href="#AntiDuplicateMemory-237"><span class="linenos">237</span></a><span class="sd">        but represent different facts.</span>
</span><span id="AntiDuplicateMemory-238"><a href="#AntiDuplicateMemory-238"><span class="linenos">238</span></a>
</span><span id="AntiDuplicateMemory-239"><a href="#AntiDuplicateMemory-239"><span class="linenos">239</span></a><span class="sd">        :param memory1: First memory text (cleaned/lowercased)</span>
</span><span id="AntiDuplicateMemory-240"><a href="#AntiDuplicateMemory-240"><span class="linenos">240</span></a><span class="sd">        :param memory2: Second memory text (cleaned/lowercased)</span>
</span><span id="AntiDuplicateMemory-241"><a href="#AntiDuplicateMemory-241"><span class="linenos">241</span></a><span class="sd">        :return: True if this appears to be structured test data</span>
</span><span id="AntiDuplicateMemory-242"><a href="#AntiDuplicateMemory-242"><span class="linenos">242</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-243"><a href="#AntiDuplicateMemory-243"><span class="linenos">243</span></a>        <span class="c1"># Common patterns in test data that might cause false positives</span>
</span><span id="AntiDuplicateMemory-244"><a href="#AntiDuplicateMemory-244"><span class="linenos">244</span></a>        <span class="n">test_patterns</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AntiDuplicateMemory-245"><a href="#AntiDuplicateMemory-245"><span class="linenos">245</span></a>            <span class="s2">&quot;user fact number&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-246"><a href="#AntiDuplicateMemory-246"><span class="linenos">246</span></a>            <span class="s2">&quot;test memory&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-247"><a href="#AntiDuplicateMemory-247"><span class="linenos">247</span></a>            <span class="s2">&quot;activity type&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-248"><a href="#AntiDuplicateMemory-248"><span class="linenos">248</span></a>            <span class="s2">&quot;enjoys activity&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-249"><a href="#AntiDuplicateMemory-249"><span class="linenos">249</span></a>            <span class="s2">&quot;fact number&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-250"><a href="#AntiDuplicateMemory-250"><span class="linenos">250</span></a>        <span class="p">]</span>
</span><span id="AntiDuplicateMemory-251"><a href="#AntiDuplicateMemory-251"><span class="linenos">251</span></a>
</span><span id="AntiDuplicateMemory-252"><a href="#AntiDuplicateMemory-252"><span class="linenos">252</span></a>        <span class="c1"># Check if both memories contain test patterns</span>
</span><span id="AntiDuplicateMemory-253"><a href="#AntiDuplicateMemory-253"><span class="linenos">253</span></a>        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">test_patterns</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-254"><a href="#AntiDuplicateMemory-254"><span class="linenos">254</span></a>            <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">memory1</span> <span class="ow">and</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">memory2</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-255"><a href="#AntiDuplicateMemory-255"><span class="linenos">255</span></a>                <span class="c1"># Check if they differ by small numeric or single character differences</span>
</span><span id="AntiDuplicateMemory-256"><a href="#AntiDuplicateMemory-256"><span class="linenos">256</span></a>                <span class="c1"># This indicates structured test data with incremental values</span>
</span><span id="AntiDuplicateMemory-257"><a href="#AntiDuplicateMemory-257"><span class="linenos">257</span></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="AntiDuplicateMemory-258"><a href="#AntiDuplicateMemory-258"><span class="linenos">258</span></a>
</span><span id="AntiDuplicateMemory-259"><a href="#AntiDuplicateMemory-259"><span class="linenos">259</span></a>                <span class="c1"># Extract numbers from both memories</span>
</span><span id="AntiDuplicateMemory-260"><a href="#AntiDuplicateMemory-260"><span class="linenos">260</span></a>                <span class="n">numbers1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">memory1</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-261"><a href="#AntiDuplicateMemory-261"><span class="linenos">261</span></a>                <span class="n">numbers2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">memory2</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-262"><a href="#AntiDuplicateMemory-262"><span class="linenos">262</span></a>
</span><span id="AntiDuplicateMemory-263"><a href="#AntiDuplicateMemory-263"><span class="linenos">263</span></a>                <span class="c1"># If they have the same number of numeric values but different values,</span>
</span><span id="AntiDuplicateMemory-264"><a href="#AntiDuplicateMemory-264"><span class="linenos">264</span></a>                <span class="c1"># this is likely structured test data</span>
</span><span id="AntiDuplicateMemory-265"><a href="#AntiDuplicateMemory-265"><span class="linenos">265</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="AntiDuplicateMemory-266"><a href="#AntiDuplicateMemory-266"><span class="linenos">266</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">numbers1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers2</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-267"><a href="#AntiDuplicateMemory-267"><span class="linenos">267</span></a>                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="AntiDuplicateMemory-268"><a href="#AntiDuplicateMemory-268"><span class="linenos">268</span></a>                    <span class="ow">and</span> <span class="n">numbers1</span> <span class="o">!=</span> <span class="n">numbers2</span>
</span><span id="AntiDuplicateMemory-269"><a href="#AntiDuplicateMemory-269"><span class="linenos">269</span></a>                <span class="p">):</span>
</span><span id="AntiDuplicateMemory-270"><a href="#AntiDuplicateMemory-270"><span class="linenos">270</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="AntiDuplicateMemory-271"><a href="#AntiDuplicateMemory-271"><span class="linenos">271</span></a>
</span><span id="AntiDuplicateMemory-272"><a href="#AntiDuplicateMemory-272"><span class="linenos">272</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="AntiDuplicateMemory-273"><a href="#AntiDuplicateMemory-273"><span class="linenos">273</span></a>
</span><span id="AntiDuplicateMemory-274"><a href="#AntiDuplicateMemory-274"><span class="linenos">274</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_contains_multiple_facts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-275"><a href="#AntiDuplicateMemory-275"><span class="linenos">275</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-276"><a href="#AntiDuplicateMemory-276"><span class="linenos">276</span></a><span class="sd">        Check if a memory contains multiple distinct facts.</span>
</span><span id="AntiDuplicateMemory-277"><a href="#AntiDuplicateMemory-277"><span class="linenos">277</span></a>
</span><span id="AntiDuplicateMemory-278"><a href="#AntiDuplicateMemory-278"><span class="linenos">278</span></a><span class="sd">        :param memory_text: Memory text to analyze</span>
</span><span id="AntiDuplicateMemory-279"><a href="#AntiDuplicateMemory-279"><span class="linenos">279</span></a><span class="sd">        :return: True if multiple facts detected</span>
</span><span id="AntiDuplicateMemory-280"><a href="#AntiDuplicateMemory-280"><span class="linenos">280</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-281"><a href="#AntiDuplicateMemory-281"><span class="linenos">281</span></a>        <span class="c1"># Common indicators of combined memories</span>
</span><span id="AntiDuplicateMemory-282"><a href="#AntiDuplicateMemory-282"><span class="linenos">282</span></a>        <span class="n">combination_indicators</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AntiDuplicateMemory-283"><a href="#AntiDuplicateMemory-283"><span class="linenos">283</span></a>            <span class="s2">&quot; and &quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-284"><a href="#AntiDuplicateMemory-284"><span class="linenos">284</span></a>            <span class="s2">&quot; &amp; &quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-285"><a href="#AntiDuplicateMemory-285"><span class="linenos">285</span></a>            <span class="s2">&quot;, and&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-286"><a href="#AntiDuplicateMemory-286"><span class="linenos">286</span></a>            <span class="s2">&quot; also &quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-287"><a href="#AntiDuplicateMemory-287"><span class="linenos">287</span></a>            <span class="s2">&quot; plus &quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-288"><a href="#AntiDuplicateMemory-288"><span class="linenos">288</span></a>            <span class="s2">&quot; as well as &quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-289"><a href="#AntiDuplicateMemory-289"><span class="linenos">289</span></a>            <span class="s2">&quot;; &quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-290"><a href="#AntiDuplicateMemory-290"><span class="linenos">290</span></a>        <span class="p">]</span>
</span><span id="AntiDuplicateMemory-291"><a href="#AntiDuplicateMemory-291"><span class="linenos">291</span></a>
</span><span id="AntiDuplicateMemory-292"><a href="#AntiDuplicateMemory-292"><span class="linenos">292</span></a>        <span class="n">memory_lower</span> <span class="o">=</span> <span class="n">memory_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-293"><a href="#AntiDuplicateMemory-293"><span class="linenos">293</span></a>        <span class="n">indicator_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-294"><a href="#AntiDuplicateMemory-294"><span class="linenos">294</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">combination_indicators</span> <span class="k">if</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">memory_lower</span>
</span><span id="AntiDuplicateMemory-295"><a href="#AntiDuplicateMemory-295"><span class="linenos">295</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory-296"><a href="#AntiDuplicateMemory-296"><span class="linenos">296</span></a>
</span><span id="AntiDuplicateMemory-297"><a href="#AntiDuplicateMemory-297"><span class="linenos">297</span></a>        <span class="c1"># More lenient detection - only reject if memory is very long AND has multiple indicators</span>
</span><span id="AntiDuplicateMemory-298"><a href="#AntiDuplicateMemory-298"><span class="linenos">298</span></a>        <span class="c1"># Or if it has many indicators regardless of length</span>
</span><span id="AntiDuplicateMemory-299"><a href="#AntiDuplicateMemory-299"><span class="linenos">299</span></a>        <span class="n">is_combined</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AntiDuplicateMemory-300"><a href="#AntiDuplicateMemory-300"><span class="linenos">300</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">memory_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="ow">and</span> <span class="n">indicator_count</span> <span class="o">&gt;=</span> <span class="mi">2</span>
</span><span id="AntiDuplicateMemory-301"><a href="#AntiDuplicateMemory-301"><span class="linenos">301</span></a>        <span class="p">)</span> <span class="ow">or</span> <span class="n">indicator_count</span> <span class="o">&gt;=</span> <span class="mi">3</span>
</span><span id="AntiDuplicateMemory-302"><a href="#AntiDuplicateMemory-302"><span class="linenos">302</span></a>
</span><span id="AntiDuplicateMemory-303"><a href="#AntiDuplicateMemory-303"><span class="linenos">303</span></a>        <span class="k">if</span> <span class="n">is_combined</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-304"><a href="#AntiDuplicateMemory-304"><span class="linenos">304</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Combined memory detected: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">memory_text</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-305"><a href="#AntiDuplicateMemory-305"><span class="linenos">305</span></a>
</span><span id="AntiDuplicateMemory-306"><a href="#AntiDuplicateMemory-306"><span class="linenos">306</span></a>        <span class="k">return</span> <span class="n">is_combined</span>
</span><span id="AntiDuplicateMemory-307"><a href="#AntiDuplicateMemory-307"><span class="linenos">307</span></a>
</span><span id="AntiDuplicateMemory-308"><a href="#AntiDuplicateMemory-308"><span class="linenos">308</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_deduplicate_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory-309"><a href="#AntiDuplicateMemory-309"><span class="linenos">309</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-310"><a href="#AntiDuplicateMemory-310"><span class="linenos">310</span></a><span class="sd">        Remove duplicates from a batch of memories.</span>
</span><span id="AntiDuplicateMemory-311"><a href="#AntiDuplicateMemory-311"><span class="linenos">311</span></a>
</span><span id="AntiDuplicateMemory-312"><a href="#AntiDuplicateMemory-312"><span class="linenos">312</span></a><span class="sd">        This method handles rapid-fire memory creation where multiple identical</span>
</span><span id="AntiDuplicateMemory-313"><a href="#AntiDuplicateMemory-313"><span class="linenos">313</span></a><span class="sd">        memories might be created in quick succession.</span>
</span><span id="AntiDuplicateMemory-314"><a href="#AntiDuplicateMemory-314"><span class="linenos">314</span></a>
</span><span id="AntiDuplicateMemory-315"><a href="#AntiDuplicateMemory-315"><span class="linenos">315</span></a><span class="sd">        :param memories: List of memories to deduplicate</span>
</span><span id="AntiDuplicateMemory-316"><a href="#AntiDuplicateMemory-316"><span class="linenos">316</span></a><span class="sd">        :return: Deduplicated list of memories</span>
</span><span id="AntiDuplicateMemory-317"><a href="#AntiDuplicateMemory-317"><span class="linenos">317</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-318"><a href="#AntiDuplicateMemory-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-319"><a href="#AntiDuplicateMemory-319"><span class="linenos">319</span></a>            <span class="k">return</span> <span class="n">memories</span>
</span><span id="AntiDuplicateMemory-320"><a href="#AntiDuplicateMemory-320"><span class="linenos">320</span></a>
</span><span id="AntiDuplicateMemory-321"><a href="#AntiDuplicateMemory-321"><span class="linenos">321</span></a>        <span class="n">unique_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AntiDuplicateMemory-322"><a href="#AntiDuplicateMemory-322"><span class="linenos">322</span></a>        <span class="n">seen_exact</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-323"><a href="#AntiDuplicateMemory-323"><span class="linenos">323</span></a>        <span class="n">seen_semantic</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AntiDuplicateMemory-324"><a href="#AntiDuplicateMemory-324"><span class="linenos">324</span></a>
</span><span id="AntiDuplicateMemory-325"><a href="#AntiDuplicateMemory-325"><span class="linenos">325</span></a>        <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-326"><a href="#AntiDuplicateMemory-326"><span class="linenos">326</span></a>            <span class="n">memory_text</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-327"><a href="#AntiDuplicateMemory-327"><span class="linenos">327</span></a>
</span><span id="AntiDuplicateMemory-328"><a href="#AntiDuplicateMemory-328"><span class="linenos">328</span></a>            <span class="c1"># Check for exact duplicates in this batch</span>
</span><span id="AntiDuplicateMemory-329"><a href="#AntiDuplicateMemory-329"><span class="linenos">329</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_exact_dedup</span> <span class="ow">and</span> <span class="n">memory_text</span> <span class="ow">in</span> <span class="n">seen_exact</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-330"><a href="#AntiDuplicateMemory-330"><span class="linenos">330</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Batch exact duplicate rejected: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-331"><a href="#AntiDuplicateMemory-331"><span class="linenos">331</span></a>                <span class="k">continue</span>
</span><span id="AntiDuplicateMemory-332"><a href="#AntiDuplicateMemory-332"><span class="linenos">332</span></a>
</span><span id="AntiDuplicateMemory-333"><a href="#AntiDuplicateMemory-333"><span class="linenos">333</span></a>            <span class="c1"># Check for semantic duplicates in this batch</span>
</span><span id="AntiDuplicateMemory-334"><a href="#AntiDuplicateMemory-334"><span class="linenos">334</span></a>            <span class="n">is_semantic_duplicate</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AntiDuplicateMemory-335"><a href="#AntiDuplicateMemory-335"><span class="linenos">335</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_semantic_dedup</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-336"><a href="#AntiDuplicateMemory-336"><span class="linenos">336</span></a>                <span class="n">semantic_threshold</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-337"><a href="#AntiDuplicateMemory-337"><span class="linenos">337</span></a>                <span class="k">for</span> <span class="n">seen_memory</span> <span class="ow">in</span> <span class="n">seen_semantic</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-338"><a href="#AntiDuplicateMemory-338"><span class="linenos">338</span></a>                    <span class="n">similarity</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-339"><a href="#AntiDuplicateMemory-339"><span class="linenos">339</span></a>                        <span class="kc">None</span><span class="p">,</span> <span class="n">memory_text</span><span class="p">,</span> <span class="n">seen_memory</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-340"><a href="#AntiDuplicateMemory-340"><span class="linenos">340</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-341"><a href="#AntiDuplicateMemory-341"><span class="linenos">341</span></a>
</span><span id="AntiDuplicateMemory-342"><a href="#AntiDuplicateMemory-342"><span class="linenos">342</span></a>                    <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">semantic_threshold</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-343"><a href="#AntiDuplicateMemory-343"><span class="linenos">343</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-344"><a href="#AntiDuplicateMemory-344"><span class="linenos">344</span></a>                            <span class="s2">&quot;Batch semantic duplicate rejected (similarity: </span><span class="si">%.2f</span><span class="s2">): &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-345"><a href="#AntiDuplicateMemory-345"><span class="linenos">345</span></a>                            <span class="n">similarity</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-346"><a href="#AntiDuplicateMemory-346"><span class="linenos">346</span></a>                            <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-347"><a href="#AntiDuplicateMemory-347"><span class="linenos">347</span></a>                        <span class="p">)</span>
</span><span id="AntiDuplicateMemory-348"><a href="#AntiDuplicateMemory-348"><span class="linenos">348</span></a>                        <span class="n">is_semantic_duplicate</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AntiDuplicateMemory-349"><a href="#AntiDuplicateMemory-349"><span class="linenos">349</span></a>                        <span class="k">break</span>
</span><span id="AntiDuplicateMemory-350"><a href="#AntiDuplicateMemory-350"><span class="linenos">350</span></a>
</span><span id="AntiDuplicateMemory-351"><a href="#AntiDuplicateMemory-351"><span class="linenos">351</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_semantic_duplicate</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-352"><a href="#AntiDuplicateMemory-352"><span class="linenos">352</span></a>                <span class="n">unique_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-353"><a href="#AntiDuplicateMemory-353"><span class="linenos">353</span></a>                <span class="n">seen_exact</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">memory_text</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-354"><a href="#AntiDuplicateMemory-354"><span class="linenos">354</span></a>                <span class="n">seen_semantic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory_text</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-355"><a href="#AntiDuplicateMemory-355"><span class="linenos">355</span></a>
</span><span id="AntiDuplicateMemory-356"><a href="#AntiDuplicateMemory-356"><span class="linenos">356</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-357"><a href="#AntiDuplicateMemory-357"><span class="linenos">357</span></a>            <span class="s2">&quot;Batch deduplication: </span><span class="si">%d</span><span class="s2"> -&gt; </span><span class="si">%d</span><span class="s2"> memories&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-358"><a href="#AntiDuplicateMemory-358"><span class="linenos">358</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">),</span>
</span><span id="AntiDuplicateMemory-359"><a href="#AntiDuplicateMemory-359"><span class="linenos">359</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">unique_memories</span><span class="p">),</span>
</span><span id="AntiDuplicateMemory-360"><a href="#AntiDuplicateMemory-360"><span class="linenos">360</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory-361"><a href="#AntiDuplicateMemory-361"><span class="linenos">361</span></a>
</span><span id="AntiDuplicateMemory-362"><a href="#AntiDuplicateMemory-362"><span class="linenos">362</span></a>        <span class="k">return</span> <span class="n">unique_memories</span>
</span><span id="AntiDuplicateMemory-363"><a href="#AntiDuplicateMemory-363"><span class="linenos">363</span></a>
</span><span id="AntiDuplicateMemory-364"><a href="#AntiDuplicateMemory-364"><span class="linenos">364</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_should_reject_memory</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-365"><a href="#AntiDuplicateMemory-365"><span class="linenos">365</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">new_memory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]</span>
</span><span id="AntiDuplicateMemory-366"><a href="#AntiDuplicateMemory-366"><span class="linenos">366</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory-367"><a href="#AntiDuplicateMemory-367"><span class="linenos">367</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-368"><a href="#AntiDuplicateMemory-368"><span class="linenos">368</span></a><span class="sd">        Determine if a memory should be rejected.</span>
</span><span id="AntiDuplicateMemory-369"><a href="#AntiDuplicateMemory-369"><span class="linenos">369</span></a>
</span><span id="AntiDuplicateMemory-370"><a href="#AntiDuplicateMemory-370"><span class="linenos">370</span></a><span class="sd">        :param new_memory: New memory text to check</span>
</span><span id="AntiDuplicateMemory-371"><a href="#AntiDuplicateMemory-371"><span class="linenos">371</span></a><span class="sd">        :param existing_memories: List of existing memories</span>
</span><span id="AntiDuplicateMemory-372"><a href="#AntiDuplicateMemory-372"><span class="linenos">372</span></a><span class="sd">        :return: Tuple of (should_reject, reason)</span>
</span><span id="AntiDuplicateMemory-373"><a href="#AntiDuplicateMemory-373"><span class="linenos">373</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-374"><a href="#AntiDuplicateMemory-374"><span class="linenos">374</span></a>        <span class="c1"># Check for exact duplicates</span>
</span><span id="AntiDuplicateMemory-375"><a href="#AntiDuplicateMemory-375"><span class="linenos">375</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_exact_dedup</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-376"><a href="#AntiDuplicateMemory-376"><span class="linenos">376</span></a>            <span class="n">exact_duplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_exact_duplicate</span><span class="p">(</span><span class="n">new_memory</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-377"><a href="#AntiDuplicateMemory-377"><span class="linenos">377</span></a>            <span class="k">if</span> <span class="n">exact_duplicate</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-378"><a href="#AntiDuplicateMemory-378"><span class="linenos">378</span></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Exact duplicate of: &#39;</span><span class="si">{</span><span class="n">exact_duplicate</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span id="AntiDuplicateMemory-379"><a href="#AntiDuplicateMemory-379"><span class="linenos">379</span></a>
</span><span id="AntiDuplicateMemory-380"><a href="#AntiDuplicateMemory-380"><span class="linenos">380</span></a>        <span class="c1"># Check for semantic duplicates</span>
</span><span id="AntiDuplicateMemory-381"><a href="#AntiDuplicateMemory-381"><span class="linenos">381</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_semantic_dedup</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-382"><a href="#AntiDuplicateMemory-382"><span class="linenos">382</span></a>            <span class="n">semantic_duplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_semantic_duplicate</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-383"><a href="#AntiDuplicateMemory-383"><span class="linenos">383</span></a>                <span class="n">new_memory</span><span class="p">,</span> <span class="n">existing_memories</span>
</span><span id="AntiDuplicateMemory-384"><a href="#AntiDuplicateMemory-384"><span class="linenos">384</span></a>            <span class="p">)</span>
</span><span id="AntiDuplicateMemory-385"><a href="#AntiDuplicateMemory-385"><span class="linenos">385</span></a>            <span class="k">if</span> <span class="n">semantic_duplicate</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-386"><a href="#AntiDuplicateMemory-386"><span class="linenos">386</span></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Semantic duplicate of: &#39;</span><span class="si">{</span><span class="n">semantic_duplicate</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span id="AntiDuplicateMemory-387"><a href="#AntiDuplicateMemory-387"><span class="linenos">387</span></a>
</span><span id="AntiDuplicateMemory-388"><a href="#AntiDuplicateMemory-388"><span class="linenos">388</span></a>        <span class="c1"># Check for combined memories (reject if too complex)</span>
</span><span id="AntiDuplicateMemory-389"><a href="#AntiDuplicateMemory-389"><span class="linenos">389</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_multiple_facts</span><span class="p">(</span><span class="n">new_memory</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory-390"><a href="#AntiDuplicateMemory-390"><span class="linenos">390</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Memory contains multiple facts (should be separated)&quot;</span>
</span><span id="AntiDuplicateMemory-391"><a href="#AntiDuplicateMemory-391"><span class="linenos">391</span></a>
</span><span id="AntiDuplicateMemory-392"><a href="#AntiDuplicateMemory-392"><span class="linenos">392</span></a>        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-393"><a href="#AntiDuplicateMemory-393"><span class="linenos">393</span></a>
</span><span id="AntiDuplicateMemory-394"><a href="#AntiDuplicateMemory-394"><span class="linenos">394</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_user_memories_optimized</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-395"><a href="#AntiDuplicateMemory-395"><span class="linenos">395</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AntiDuplicateMemory-396"><a href="#AntiDuplicateMemory-396"><span class="linenos">396</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory-397"><a href="#AntiDuplicateMemory-397"><span class="linenos">397</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-398"><a href="#AntiDuplicateMemory-398"><span class="linenos">398</span></a><span class="sd">        Optimized method to get user memories using direct read_memories call.</span>
</span><span id="AntiDuplicateMemory-399"><a href="#AntiDuplicateMemory-399"><span class="linenos">399</span></a>
</span><span id="AntiDuplicateMemory-400"><a href="#AntiDuplicateMemory-400"><span class="linenos">400</span></a><span class="sd">        This bypasses the memory cache and directly queries the database with filtering,</span>
</span><span id="AntiDuplicateMemory-401"><a href="#AntiDuplicateMemory-401"><span class="linenos">401</span></a><span class="sd">        which is more efficient for large memory datasets.</span>
</span><span id="AntiDuplicateMemory-402"><a href="#AntiDuplicateMemory-402"><span class="linenos">402</span></a>
</span><span id="AntiDuplicateMemory-403"><a href="#AntiDuplicateMemory-403"><span class="linenos">403</span></a><span class="sd">        :param user_id: User ID to filter by</span>
</span><span id="AntiDuplicateMemory-404"><a href="#AntiDuplicateMemory-404"><span class="linenos">404</span></a><span class="sd">        :param limit: Optional limit on number of memories</span>
</span><span id="AntiDuplicateMemory-405"><a href="#AntiDuplicateMemory-405"><span class="linenos">405</span></a><span class="sd">        :return: List of UserMemory objects</span>
</span><span id="AntiDuplicateMemory-406"><a href="#AntiDuplicateMemory-406"><span class="linenos">406</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-407"><a href="#AntiDuplicateMemory-407"><span class="linenos">407</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_optimizations</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-408"><a href="#AntiDuplicateMemory-408"><span class="linenos">408</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-409"><a href="#AntiDuplicateMemory-409"><span class="linenos">409</span></a>
</span><span id="AntiDuplicateMemory-410"><a href="#AntiDuplicateMemory-410"><span class="linenos">410</span></a>        <span class="c1"># Use read_memories with filtering - much more efficient</span>
</span><span id="AntiDuplicateMemory-411"><a href="#AntiDuplicateMemory-411"><span class="linenos">411</span></a>        <span class="n">memory_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">read_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-412"><a href="#AntiDuplicateMemory-412"><span class="linenos">412</span></a>
</span><span id="AntiDuplicateMemory-413"><a href="#AntiDuplicateMemory-413"><span class="linenos">413</span></a>        <span class="c1"># Convert MemoryRow to UserMemory objects</span>
</span><span id="AntiDuplicateMemory-414"><a href="#AntiDuplicateMemory-414"><span class="linenos">414</span></a>        <span class="n">user_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AntiDuplicateMemory-415"><a href="#AntiDuplicateMemory-415"><span class="linenos">415</span></a>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">memory_rows</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-416"><a href="#AntiDuplicateMemory-416"><span class="linenos">416</span></a>            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-417"><a href="#AntiDuplicateMemory-417"><span class="linenos">417</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-418"><a href="#AntiDuplicateMemory-418"><span class="linenos">418</span></a>                    <span class="n">user_memory</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-419"><a href="#AntiDuplicateMemory-419"><span class="linenos">419</span></a>                    <span class="n">user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_memory</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-420"><a href="#AntiDuplicateMemory-420"><span class="linenos">420</span></a>                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-421"><a href="#AntiDuplicateMemory-421"><span class="linenos">421</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to convert memory row to UserMemory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-422"><a href="#AntiDuplicateMemory-422"><span class="linenos">422</span></a>
</span><span id="AntiDuplicateMemory-423"><a href="#AntiDuplicateMemory-423"><span class="linenos">423</span></a>        <span class="k">return</span> <span class="n">user_memories</span>
</span><span id="AntiDuplicateMemory-424"><a href="#AntiDuplicateMemory-424"><span class="linenos">424</span></a>
</span><span id="AntiDuplicateMemory-425"><a href="#AntiDuplicateMemory-425"><span class="linenos">425</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_recent_memories_for_dedup</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-426"><a href="#AntiDuplicateMemory-426"><span class="linenos">426</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
</span><span id="AntiDuplicateMemory-427"><a href="#AntiDuplicateMemory-427"><span class="linenos">427</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory-428"><a href="#AntiDuplicateMemory-428"><span class="linenos">428</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-429"><a href="#AntiDuplicateMemory-429"><span class="linenos">429</span></a><span class="sd">        Get recent memories for duplicate checking, optimized for performance.</span>
</span><span id="AntiDuplicateMemory-430"><a href="#AntiDuplicateMemory-430"><span class="linenos">430</span></a>
</span><span id="AntiDuplicateMemory-431"><a href="#AntiDuplicateMemory-431"><span class="linenos">431</span></a><span class="sd">        For duplicate detection, we typically only need to check against recent memories,</span>
</span><span id="AntiDuplicateMemory-432"><a href="#AntiDuplicateMemory-432"><span class="linenos">432</span></a><span class="sd">        not the entire history. This method fetches only the most recent memories.</span>
</span><span id="AntiDuplicateMemory-433"><a href="#AntiDuplicateMemory-433"><span class="linenos">433</span></a>
</span><span id="AntiDuplicateMemory-434"><a href="#AntiDuplicateMemory-434"><span class="linenos">434</span></a><span class="sd">        :param user_id: User ID to filter by</span>
</span><span id="AntiDuplicateMemory-435"><a href="#AntiDuplicateMemory-435"><span class="linenos">435</span></a><span class="sd">        :param limit: Number of recent memories to check against</span>
</span><span id="AntiDuplicateMemory-436"><a href="#AntiDuplicateMemory-436"><span class="linenos">436</span></a><span class="sd">        :return: List of recent UserMemory objects</span>
</span><span id="AntiDuplicateMemory-437"><a href="#AntiDuplicateMemory-437"><span class="linenos">437</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-438"><a href="#AntiDuplicateMemory-438"><span class="linenos">438</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_optimizations</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-439"><a href="#AntiDuplicateMemory-439"><span class="linenos">439</span></a>            <span class="n">all_memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-440"><a href="#AntiDuplicateMemory-440"><span class="linenos">440</span></a>            <span class="k">return</span> <span class="n">all_memories</span><span class="p">[</span><span class="o">-</span><span class="n">limit</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_memories</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">all_memories</span>
</span><span id="AntiDuplicateMemory-441"><a href="#AntiDuplicateMemory-441"><span class="linenos">441</span></a>
</span><span id="AntiDuplicateMemory-442"><a href="#AntiDuplicateMemory-442"><span class="linenos">442</span></a>        <span class="c1"># Direct database query for recent memories only</span>
</span><span id="AntiDuplicateMemory-443"><a href="#AntiDuplicateMemory-443"><span class="linenos">443</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_memories_optimized</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-444"><a href="#AntiDuplicateMemory-444"><span class="linenos">444</span></a>
</span><span id="AntiDuplicateMemory-445"><a href="#AntiDuplicateMemory-445"><span class="linenos">445</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_user_memory</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-446"><a href="#AntiDuplicateMemory-446"><span class="linenos">446</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-447"><a href="#AntiDuplicateMemory-447"><span class="linenos">447</span></a>        <span class="n">memory</span><span class="p">:</span> <span class="n">UserMemory</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-448"><a href="#AntiDuplicateMemory-448"><span class="linenos">448</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-449"><a href="#AntiDuplicateMemory-449"><span class="linenos">449</span></a>        <span class="n">refresh_from_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-450"><a href="#AntiDuplicateMemory-450"><span class="linenos">450</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory-451"><a href="#AntiDuplicateMemory-451"><span class="linenos">451</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-452"><a href="#AntiDuplicateMemory-452"><span class="linenos">452</span></a><span class="sd">        Add a user memory with duplicate prevention.</span>
</span><span id="AntiDuplicateMemory-453"><a href="#AntiDuplicateMemory-453"><span class="linenos">453</span></a>
</span><span id="AntiDuplicateMemory-454"><a href="#AntiDuplicateMemory-454"><span class="linenos">454</span></a><span class="sd">        :param memory: UserMemory object to add</span>
</span><span id="AntiDuplicateMemory-455"><a href="#AntiDuplicateMemory-455"><span class="linenos">455</span></a><span class="sd">        :param user_id: User ID for the memory</span>
</span><span id="AntiDuplicateMemory-456"><a href="#AntiDuplicateMemory-456"><span class="linenos">456</span></a><span class="sd">        :param refresh_from_db: Whether to refresh from database before adding</span>
</span><span id="AntiDuplicateMemory-457"><a href="#AntiDuplicateMemory-457"><span class="linenos">457</span></a><span class="sd">        :return: Memory ID if added, None if rejected</span>
</span><span id="AntiDuplicateMemory-458"><a href="#AntiDuplicateMemory-458"><span class="linenos">458</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-459"><a href="#AntiDuplicateMemory-459"><span class="linenos">459</span></a>        <span class="c1"># Default user_id if not provided</span>
</span><span id="AntiDuplicateMemory-460"><a href="#AntiDuplicateMemory-460"><span class="linenos">460</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-461"><a href="#AntiDuplicateMemory-461"><span class="linenos">461</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-462"><a href="#AntiDuplicateMemory-462"><span class="linenos">462</span></a>        <span class="c1"># Handle case where topics comes in as string representation of list</span>
</span><span id="AntiDuplicateMemory-463"><a href="#AntiDuplicateMemory-463"><span class="linenos">463</span></a>        <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory-464"><a href="#AntiDuplicateMemory-464"><span class="linenos">464</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-465"><a href="#AntiDuplicateMemory-465"><span class="linenos">465</span></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="AntiDuplicateMemory-466"><a href="#AntiDuplicateMemory-466"><span class="linenos">466</span></a>
</span><span id="AntiDuplicateMemory-467"><a href="#AntiDuplicateMemory-467"><span class="linenos">467</span></a>                <span class="c1"># Try to parse as JSON</span>
</span><span id="AntiDuplicateMemory-468"><a href="#AntiDuplicateMemory-468"><span class="linenos">468</span></a>                <span class="n">parsed_topics</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-469"><a href="#AntiDuplicateMemory-469"><span class="linenos">469</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed_topics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory-470"><a href="#AntiDuplicateMemory-470"><span class="linenos">470</span></a>                    <span class="n">memory</span><span class="o">.</span><span class="n">topics</span> <span class="o">=</span> <span class="n">parsed_topics</span>
</span><span id="AntiDuplicateMemory-471"><a href="#AntiDuplicateMemory-471"><span class="linenos">471</span></a>            <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory-472"><a href="#AntiDuplicateMemory-472"><span class="linenos">472</span></a>                <span class="c1"># If JSON parsing fails, treat as a single topic</span>
</span><span id="AntiDuplicateMemory-473"><a href="#AntiDuplicateMemory-473"><span class="linenos">473</span></a>                <span class="n">memory</span><span class="o">.</span><span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">]</span>
</span><span id="AntiDuplicateMemory-474"><a href="#AntiDuplicateMemory-474"><span class="linenos">474</span></a>
</span><span id="AntiDuplicateMemory-475"><a href="#AntiDuplicateMemory-475"><span class="linenos">475</span></a>        <span class="c1"># Get existing memories for this user (optimized for recent memories only)</span>
</span><span id="AntiDuplicateMemory-476"><a href="#AntiDuplicateMemory-476"><span class="linenos">476</span></a>        <span class="n">existing_memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_recent_memories_for_dedup</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-477"><a href="#AntiDuplicateMemory-477"><span class="linenos">477</span></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span>
</span><span id="AntiDuplicateMemory-478"><a href="#AntiDuplicateMemory-478"><span class="linenos">478</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory-479"><a href="#AntiDuplicateMemory-479"><span class="linenos">479</span></a>
</span><span id="AntiDuplicateMemory-480"><a href="#AntiDuplicateMemory-480"><span class="linenos">480</span></a>        <span class="c1"># Check if this memory should be rejected</span>
</span><span id="AntiDuplicateMemory-481"><a href="#AntiDuplicateMemory-481"><span class="linenos">481</span></a>        <span class="n">should_reject</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_reject_memory</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-482"><a href="#AntiDuplicateMemory-482"><span class="linenos">482</span></a>            <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="n">existing_memories</span>
</span><span id="AntiDuplicateMemory-483"><a href="#AntiDuplicateMemory-483"><span class="linenos">483</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory-484"><a href="#AntiDuplicateMemory-484"><span class="linenos">484</span></a>
</span><span id="AntiDuplicateMemory-485"><a href="#AntiDuplicateMemory-485"><span class="linenos">485</span></a>        <span class="k">if</span> <span class="n">should_reject</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-486"><a href="#AntiDuplicateMemory-486"><span class="linenos">486</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-487"><a href="#AntiDuplicateMemory-487"><span class="linenos">487</span></a>                <span class="s2">&quot;Rejecting memory for user </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">. Memory: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-488"><a href="#AntiDuplicateMemory-488"><span class="linenos">488</span></a>                <span class="n">user_id</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-489"><a href="#AntiDuplicateMemory-489"><span class="linenos">489</span></a>                <span class="n">reason</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-490"><a href="#AntiDuplicateMemory-490"><span class="linenos">490</span></a>                <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-491"><a href="#AntiDuplicateMemory-491"><span class="linenos">491</span></a>            <span class="p">)</span>
</span><span id="AntiDuplicateMemory-492"><a href="#AntiDuplicateMemory-492"><span class="linenos">492</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-493"><a href="#AntiDuplicateMemory-493"><span class="linenos">493</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; REJECTED: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-494"><a href="#AntiDuplicateMemory-494"><span class="linenos">494</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Memory: &#39;</span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-495"><a href="#AntiDuplicateMemory-495"><span class="linenos">495</span></a>
</span><span id="AntiDuplicateMemory-496"><a href="#AntiDuplicateMemory-496"><span class="linenos">496</span></a>            <span class="c1"># Return None to indicate rejection - this is the expected behavior</span>
</span><span id="AntiDuplicateMemory-497"><a href="#AntiDuplicateMemory-497"><span class="linenos">497</span></a>            <span class="c1"># for duplicate detection and what the tests expect</span>
</span><span id="AntiDuplicateMemory-498"><a href="#AntiDuplicateMemory-498"><span class="linenos">498</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="AntiDuplicateMemory-499"><a href="#AntiDuplicateMemory-499"><span class="linenos">499</span></a>
</span><span id="AntiDuplicateMemory-500"><a href="#AntiDuplicateMemory-500"><span class="linenos">500</span></a>        <span class="c1"># Memory is unique, proceed with addition</span>
</span><span id="AntiDuplicateMemory-501"><a href="#AntiDuplicateMemory-501"><span class="linenos">501</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding unique memory for user </span><span class="si">%s</span><span class="s2">: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-502"><a href="#AntiDuplicateMemory-502"><span class="linenos">502</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-503"><a href="#AntiDuplicateMemory-503"><span class="linenos">503</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ACCEPTED: &#39;</span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-504"><a href="#AntiDuplicateMemory-504"><span class="linenos">504</span></a>
</span><span id="AntiDuplicateMemory-505"><a href="#AntiDuplicateMemory-505"><span class="linenos">505</span></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_user_memory</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-506"><a href="#AntiDuplicateMemory-506"><span class="linenos">506</span></a>
</span><span id="AntiDuplicateMemory-507"><a href="#AntiDuplicateMemory-507"><span class="linenos">507</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_user_memories</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-508"><a href="#AntiDuplicateMemory-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-509"><a href="#AntiDuplicateMemory-509"><span class="linenos">509</span></a>        <span class="n">message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-510"><a href="#AntiDuplicateMemory-510"><span class="linenos">510</span></a>        <span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-511"><a href="#AntiDuplicateMemory-511"><span class="linenos">511</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-512"><a href="#AntiDuplicateMemory-512"><span class="linenos">512</span></a>        <span class="n">refresh_from_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-513"><a href="#AntiDuplicateMemory-513"><span class="linenos">513</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory-514"><a href="#AntiDuplicateMemory-514"><span class="linenos">514</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-515"><a href="#AntiDuplicateMemory-515"><span class="linenos">515</span></a><span class="sd">        Create user memories from messages with duplicate prevention.</span>
</span><span id="AntiDuplicateMemory-516"><a href="#AntiDuplicateMemory-516"><span class="linenos">516</span></a>
</span><span id="AntiDuplicateMemory-517"><a href="#AntiDuplicateMemory-517"><span class="linenos">517</span></a><span class="sd">        :param message: Single message to create memories from</span>
</span><span id="AntiDuplicateMemory-518"><a href="#AntiDuplicateMemory-518"><span class="linenos">518</span></a><span class="sd">        :param messages: List of messages to create memories from</span>
</span><span id="AntiDuplicateMemory-519"><a href="#AntiDuplicateMemory-519"><span class="linenos">519</span></a><span class="sd">        :param user_id: User ID for the memories</span>
</span><span id="AntiDuplicateMemory-520"><a href="#AntiDuplicateMemory-520"><span class="linenos">520</span></a><span class="sd">        :param refresh_from_db: Whether to refresh from database before creating</span>
</span><span id="AntiDuplicateMemory-521"><a href="#AntiDuplicateMemory-521"><span class="linenos">521</span></a><span class="sd">        :return: List of successfully created memories</span>
</span><span id="AntiDuplicateMemory-522"><a href="#AntiDuplicateMemory-522"><span class="linenos">522</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-523"><a href="#AntiDuplicateMemory-523"><span class="linenos">523</span></a>        <span class="c1"># Default user_id if not provided</span>
</span><span id="AntiDuplicateMemory-524"><a href="#AntiDuplicateMemory-524"><span class="linenos">524</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-525"><a href="#AntiDuplicateMemory-525"><span class="linenos">525</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-526"><a href="#AntiDuplicateMemory-526"><span class="linenos">526</span></a>            
</span><span id="AntiDuplicateMemory-527"><a href="#AntiDuplicateMemory-527"><span class="linenos">527</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating memories for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-528"><a href="#AntiDuplicateMemory-528"><span class="linenos">528</span></a>        <span class="n">created_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AntiDuplicateMemory-529"><a href="#AntiDuplicateMemory-529"><span class="linenos">529</span></a>
</span><span id="AntiDuplicateMemory-530"><a href="#AntiDuplicateMemory-530"><span class="linenos">530</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-531"><a href="#AntiDuplicateMemory-531"><span class="linenos">531</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-532"><a href="#AntiDuplicateMemory-532"><span class="linenos">532</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Creating memories (existing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_recent_memories_for_dedup</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="AntiDuplicateMemory-533"><a href="#AntiDuplicateMemory-533"><span class="linenos">533</span></a>            <span class="p">)</span>
</span><span id="AntiDuplicateMemory-534"><a href="#AntiDuplicateMemory-534"><span class="linenos">534</span></a>            <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-535"><a href="#AntiDuplicateMemory-535"><span class="linenos">535</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Input: &#39;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-536"><a href="#AntiDuplicateMemory-536"><span class="linenos">536</span></a>            <span class="k">elif</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-537"><a href="#AntiDuplicateMemory-537"><span class="linenos">537</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Input: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-538"><a href="#AntiDuplicateMemory-538"><span class="linenos">538</span></a>
</span><span id="AntiDuplicateMemory-539"><a href="#AntiDuplicateMemory-539"><span class="linenos">539</span></a>        <span class="c1"># Handle a single message string</span>
</span><span id="AntiDuplicateMemory-540"><a href="#AntiDuplicateMemory-540"><span class="linenos">540</span></a>        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-541"><a href="#AntiDuplicateMemory-541"><span class="linenos">541</span></a>            <span class="n">memory_obj</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">])</span>
</span><span id="AntiDuplicateMemory-542"><a href="#AntiDuplicateMemory-542"><span class="linenos">542</span></a>            <span class="n">memory_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_user_memory</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory_obj</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-543"><a href="#AntiDuplicateMemory-543"><span class="linenos">543</span></a>            <span class="k">if</span> <span class="n">memory_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-544"><a href="#AntiDuplicateMemory-544"><span class="linenos">544</span></a>                <span class="n">memory_obj</span><span class="o">.</span><span class="n">memory_id</span> <span class="o">=</span> <span class="n">memory_id</span>
</span><span id="AntiDuplicateMemory-545"><a href="#AntiDuplicateMemory-545"><span class="linenos">545</span></a>                <span class="n">created_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory_obj</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-546"><a href="#AntiDuplicateMemory-546"><span class="linenos">546</span></a>
</span><span id="AntiDuplicateMemory-547"><a href="#AntiDuplicateMemory-547"><span class="linenos">547</span></a>        <span class="c1"># Handle a list of messages</span>
</span><span id="AntiDuplicateMemory-548"><a href="#AntiDuplicateMemory-548"><span class="linenos">548</span></a>        <span class="k">elif</span> <span class="n">messages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-549"><a href="#AntiDuplicateMemory-549"><span class="linenos">549</span></a>            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-550"><a href="#AntiDuplicateMemory-550"><span class="linenos">550</span></a>                <span class="c1"># Handle different message formats</span>
</span><span id="AntiDuplicateMemory-551"><a href="#AntiDuplicateMemory-551"><span class="linenos">551</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory-552"><a href="#AntiDuplicateMemory-552"><span class="linenos">552</span></a>                    <span class="c1"># It&#39;s a Message object</span>
</span><span id="AntiDuplicateMemory-553"><a href="#AntiDuplicateMemory-553"><span class="linenos">553</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-554"><a href="#AntiDuplicateMemory-554"><span class="linenos">554</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-555"><a href="#AntiDuplicateMemory-555"><span class="linenos">555</span></a>                    <span class="c1"># It&#39;s a string or something else</span>
</span><span id="AntiDuplicateMemory-556"><a href="#AntiDuplicateMemory-556"><span class="linenos">556</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-557"><a href="#AntiDuplicateMemory-557"><span class="linenos">557</span></a>
</span><span id="AntiDuplicateMemory-558"><a href="#AntiDuplicateMemory-558"><span class="linenos">558</span></a>                <span class="c1"># Create memory and add with deduplication</span>
</span><span id="AntiDuplicateMemory-559"><a href="#AntiDuplicateMemory-559"><span class="linenos">559</span></a>                <span class="n">memory_obj</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">])</span>
</span><span id="AntiDuplicateMemory-560"><a href="#AntiDuplicateMemory-560"><span class="linenos">560</span></a>                <span class="n">memory_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_user_memory</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory_obj</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">refresh_from_db</span><span class="o">=</span><span class="n">refresh_from_db</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-561"><a href="#AntiDuplicateMemory-561"><span class="linenos">561</span></a>                <span class="k">if</span> <span class="n">memory_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-562"><a href="#AntiDuplicateMemory-562"><span class="linenos">562</span></a>                    <span class="n">memory_obj</span><span class="o">.</span><span class="n">memory_id</span> <span class="o">=</span> <span class="n">memory_id</span>
</span><span id="AntiDuplicateMemory-563"><a href="#AntiDuplicateMemory-563"><span class="linenos">563</span></a>                    <span class="n">created_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory_obj</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-564"><a href="#AntiDuplicateMemory-564"><span class="linenos">564</span></a>
</span><span id="AntiDuplicateMemory-565"><a href="#AntiDuplicateMemory-565"><span class="linenos">565</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-566"><a href="#AntiDuplicateMemory-566"><span class="linenos">566</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Raw memories created: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">created_memories</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-567"><a href="#AntiDuplicateMemory-567"><span class="linenos">567</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Final memories after dedup: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">created_memories</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-568"><a href="#AntiDuplicateMemory-568"><span class="linenos">568</span></a>
</span><span id="AntiDuplicateMemory-569"><a href="#AntiDuplicateMemory-569"><span class="linenos">569</span></a>        <span class="k">return</span> <span class="n">created_memories</span>
</span><span id="AntiDuplicateMemory-570"><a href="#AntiDuplicateMemory-570"><span class="linenos">570</span></a>
</span><span id="AntiDuplicateMemory-571"><a href="#AntiDuplicateMemory-571"><span class="linenos">571</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_post_process_memories</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-572"><a href="#AntiDuplicateMemory-572"><span class="linenos">572</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">new_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">],</span> <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]</span>
</span><span id="AntiDuplicateMemory-573"><a href="#AntiDuplicateMemory-573"><span class="linenos">573</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory-574"><a href="#AntiDuplicateMemory-574"><span class="linenos">574</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-575"><a href="#AntiDuplicateMemory-575"><span class="linenos">575</span></a><span class="sd">        Post-process newly created memories to remove any duplicates.</span>
</span><span id="AntiDuplicateMemory-576"><a href="#AntiDuplicateMemory-576"><span class="linenos">576</span></a>
</span><span id="AntiDuplicateMemory-577"><a href="#AntiDuplicateMemory-577"><span class="linenos">577</span></a><span class="sd">        :param new_memories: Newly created memories</span>
</span><span id="AntiDuplicateMemory-578"><a href="#AntiDuplicateMemory-578"><span class="linenos">578</span></a><span class="sd">        :param existing_memories: Previously existing memories</span>
</span><span id="AntiDuplicateMemory-579"><a href="#AntiDuplicateMemory-579"><span class="linenos">579</span></a><span class="sd">        :return: Deduplicated list of new memories</span>
</span><span id="AntiDuplicateMemory-580"><a href="#AntiDuplicateMemory-580"><span class="linenos">580</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-581"><a href="#AntiDuplicateMemory-581"><span class="linenos">581</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_memories</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-582"><a href="#AntiDuplicateMemory-582"><span class="linenos">582</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="AntiDuplicateMemory-583"><a href="#AntiDuplicateMemory-583"><span class="linenos">583</span></a>
</span><span id="AntiDuplicateMemory-584"><a href="#AntiDuplicateMemory-584"><span class="linenos">584</span></a>        <span class="n">deduplicated</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AntiDuplicateMemory-585"><a href="#AntiDuplicateMemory-585"><span class="linenos">585</span></a>        <span class="n">all_existing</span> <span class="o">=</span> <span class="n">existing_memories</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-586"><a href="#AntiDuplicateMemory-586"><span class="linenos">586</span></a>
</span><span id="AntiDuplicateMemory-587"><a href="#AntiDuplicateMemory-587"><span class="linenos">587</span></a>        <span class="k">for</span> <span class="n">new_memory</span> <span class="ow">in</span> <span class="n">new_memories</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-588"><a href="#AntiDuplicateMemory-588"><span class="linenos">588</span></a>            <span class="n">should_reject</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_reject_memory</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-589"><a href="#AntiDuplicateMemory-589"><span class="linenos">589</span></a>                <span class="n">new_memory</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="n">all_existing</span>
</span><span id="AntiDuplicateMemory-590"><a href="#AntiDuplicateMemory-590"><span class="linenos">590</span></a>            <span class="p">)</span>
</span><span id="AntiDuplicateMemory-591"><a href="#AntiDuplicateMemory-591"><span class="linenos">591</span></a>
</span><span id="AntiDuplicateMemory-592"><a href="#AntiDuplicateMemory-592"><span class="linenos">592</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">should_reject</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-593"><a href="#AntiDuplicateMemory-593"><span class="linenos">593</span></a>                <span class="n">deduplicated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_memory</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-594"><a href="#AntiDuplicateMemory-594"><span class="linenos">594</span></a>                <span class="n">all_existing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_memory</span><span class="p">)</span>  <span class="c1"># Add to existing for next iteration</span>
</span><span id="AntiDuplicateMemory-595"><a href="#AntiDuplicateMemory-595"><span class="linenos">595</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Kept memory: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">new_memory</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-596"><a href="#AntiDuplicateMemory-596"><span class="linenos">596</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-597"><a href="#AntiDuplicateMemory-597"><span class="linenos">597</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-598"><a href="#AntiDuplicateMemory-598"><span class="linenos">598</span></a>                    <span class="s2">&quot;Post-processing rejected memory: </span><span class="si">%s</span><span class="s2">. Memory: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-599"><a href="#AntiDuplicateMemory-599"><span class="linenos">599</span></a>                    <span class="n">reason</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-600"><a href="#AntiDuplicateMemory-600"><span class="linenos">600</span></a>                    <span class="n">new_memory</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-601"><a href="#AntiDuplicateMemory-601"><span class="linenos">601</span></a>                <span class="p">)</span>
</span><span id="AntiDuplicateMemory-602"><a href="#AntiDuplicateMemory-602"><span class="linenos">602</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-603"><a href="#AntiDuplicateMemory-603"><span class="linenos">603</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Post-processing rejected: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-604"><a href="#AntiDuplicateMemory-604"><span class="linenos">604</span></a>
</span><span id="AntiDuplicateMemory-605"><a href="#AntiDuplicateMemory-605"><span class="linenos">605</span></a>        <span class="k">return</span> <span class="n">deduplicated</span>
</span><span id="AntiDuplicateMemory-606"><a href="#AntiDuplicateMemory-606"><span class="linenos">606</span></a>
</span><span id="AntiDuplicateMemory-607"><a href="#AntiDuplicateMemory-607"><span class="linenos">607</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_user_memory</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-608"><a href="#AntiDuplicateMemory-608"><span class="linenos">608</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-609"><a href="#AntiDuplicateMemory-609"><span class="linenos">609</span></a>        <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-610"><a href="#AntiDuplicateMemory-610"><span class="linenos">610</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-611"><a href="#AntiDuplicateMemory-611"><span class="linenos">611</span></a>        <span class="n">refresh_from_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-612"><a href="#AntiDuplicateMemory-612"><span class="linenos">612</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-613"><a href="#AntiDuplicateMemory-613"><span class="linenos">613</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-614"><a href="#AntiDuplicateMemory-614"><span class="linenos">614</span></a><span class="sd">        Delete a specific user memory.</span>
</span><span id="AntiDuplicateMemory-615"><a href="#AntiDuplicateMemory-615"><span class="linenos">615</span></a>
</span><span id="AntiDuplicateMemory-616"><a href="#AntiDuplicateMemory-616"><span class="linenos">616</span></a><span class="sd">        :param memory_id: ID of the memory to delete</span>
</span><span id="AntiDuplicateMemory-617"><a href="#AntiDuplicateMemory-617"><span class="linenos">617</span></a><span class="sd">        :param user_id: User ID for the memory</span>
</span><span id="AntiDuplicateMemory-618"><a href="#AntiDuplicateMemory-618"><span class="linenos">618</span></a><span class="sd">        :param refresh_from_db: Whether to refresh from database before deleting</span>
</span><span id="AntiDuplicateMemory-619"><a href="#AntiDuplicateMemory-619"><span class="linenos">619</span></a><span class="sd">        :return: None</span>
</span><span id="AntiDuplicateMemory-620"><a href="#AntiDuplicateMemory-620"><span class="linenos">620</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-621"><a href="#AntiDuplicateMemory-621"><span class="linenos">621</span></a>        <span class="c1"># Default user_id if not provided</span>
</span><span id="AntiDuplicateMemory-622"><a href="#AntiDuplicateMemory-622"><span class="linenos">622</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-623"><a href="#AntiDuplicateMemory-623"><span class="linenos">623</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-624"><a href="#AntiDuplicateMemory-624"><span class="linenos">624</span></a>            
</span><span id="AntiDuplicateMemory-625"><a href="#AntiDuplicateMemory-625"><span class="linenos">625</span></a>        <span class="c1"># Refresh from the DB</span>
</span><span id="AntiDuplicateMemory-626"><a href="#AntiDuplicateMemory-626"><span class="linenos">626</span></a>        <span class="k">if</span> <span class="n">refresh_from_db</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-627"><a href="#AntiDuplicateMemory-627"><span class="linenos">627</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-628"><a href="#AntiDuplicateMemory-628"><span class="linenos">628</span></a>
</span><span id="AntiDuplicateMemory-629"><a href="#AntiDuplicateMemory-629"><span class="linenos">629</span></a>        <span class="c1"># Check if memory exists in our local cache</span>
</span><span id="AntiDuplicateMemory-630"><a href="#AntiDuplicateMemory-630"><span class="linenos">630</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories</span> <span class="ow">or</span> <span class="n">memory_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories</span><span class="p">[</span><span class="n">user_id</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory-631"><a href="#AntiDuplicateMemory-631"><span class="linenos">631</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Memory </span><span class="si">%s</span><span class="s2"> not found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-632"><a href="#AntiDuplicateMemory-632"><span class="linenos">632</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-633"><a href="#AntiDuplicateMemory-633"><span class="linenos">633</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> not found for deletion&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-634"><a href="#AntiDuplicateMemory-634"><span class="linenos">634</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="AntiDuplicateMemory-635"><a href="#AntiDuplicateMemory-635"><span class="linenos">635</span></a>
</span><span id="AntiDuplicateMemory-636"><a href="#AntiDuplicateMemory-636"><span class="linenos">636</span></a>        <span class="c1"># Delete from local cache</span>
</span><span id="AntiDuplicateMemory-637"><a href="#AntiDuplicateMemory-637"><span class="linenos">637</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">memory_id</span><span class="p">]</span>
</span><span id="AntiDuplicateMemory-638"><a href="#AntiDuplicateMemory-638"><span class="linenos">638</span></a>        
</span><span id="AntiDuplicateMemory-639"><a href="#AntiDuplicateMemory-639"><span class="linenos">639</span></a>        <span class="c1"># Delete from database</span>
</span><span id="AntiDuplicateMemory-640"><a href="#AntiDuplicateMemory-640"><span class="linenos">640</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-641"><a href="#AntiDuplicateMemory-641"><span class="linenos">641</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span><span class="n">memory_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-642"><a href="#AntiDuplicateMemory-642"><span class="linenos">642</span></a>            
</span><span id="AntiDuplicateMemory-643"><a href="#AntiDuplicateMemory-643"><span class="linenos">643</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted memory </span><span class="si">%s</span><span class="s2"> for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-644"><a href="#AntiDuplicateMemory-644"><span class="linenos">644</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-645"><a href="#AntiDuplicateMemory-645"><span class="linenos">645</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Deleted memory: </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-646"><a href="#AntiDuplicateMemory-646"><span class="linenos">646</span></a>
</span><span id="AntiDuplicateMemory-647"><a href="#AntiDuplicateMemory-647"><span class="linenos">647</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-648"><a href="#AntiDuplicateMemory-648"><span class="linenos">648</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-649"><a href="#AntiDuplicateMemory-649"><span class="linenos">649</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-650"><a href="#AntiDuplicateMemory-650"><span class="linenos">650</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-651"><a href="#AntiDuplicateMemory-651"><span class="linenos">651</span></a><span class="sd">        Get statistics about memory quality and duplicates.</span>
</span><span id="AntiDuplicateMemory-652"><a href="#AntiDuplicateMemory-652"><span class="linenos">652</span></a>
</span><span id="AntiDuplicateMemory-653"><a href="#AntiDuplicateMemory-653"><span class="linenos">653</span></a><span class="sd">        :param user_id: User ID to analyze</span>
</span><span id="AntiDuplicateMemory-654"><a href="#AntiDuplicateMemory-654"><span class="linenos">654</span></a><span class="sd">        :return: Dictionary with memory statistics</span>
</span><span id="AntiDuplicateMemory-655"><a href="#AntiDuplicateMemory-655"><span class="linenos">655</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-656"><a href="#AntiDuplicateMemory-656"><span class="linenos">656</span></a>        <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-657"><a href="#AntiDuplicateMemory-657"><span class="linenos">657</span></a>
</span><span id="AntiDuplicateMemory-658"><a href="#AntiDuplicateMemory-658"><span class="linenos">658</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-659"><a href="#AntiDuplicateMemory-659"><span class="linenos">659</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total_memories&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="AntiDuplicateMemory-660"><a href="#AntiDuplicateMemory-660"><span class="linenos">660</span></a>
</span><span id="AntiDuplicateMemory-661"><a href="#AntiDuplicateMemory-661"><span class="linenos">661</span></a>        <span class="c1"># Analyze for potential issues</span>
</span><span id="AntiDuplicateMemory-662"><a href="#AntiDuplicateMemory-662"><span class="linenos">662</span></a>        <span class="n">memory_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">memory</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">]</span>
</span><span id="AntiDuplicateMemory-663"><a href="#AntiDuplicateMemory-663"><span class="linenos">663</span></a>        <span class="n">unique_texts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">memory_texts</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-664"><a href="#AntiDuplicateMemory-664"><span class="linenos">664</span></a>
</span><span id="AntiDuplicateMemory-665"><a href="#AntiDuplicateMemory-665"><span class="linenos">665</span></a>        <span class="c1"># Find potential duplicates</span>
</span><span id="AntiDuplicateMemory-666"><a href="#AntiDuplicateMemory-666"><span class="linenos">666</span></a>        <span class="n">potential_duplicates</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AntiDuplicateMemory-667"><a href="#AntiDuplicateMemory-667"><span class="linenos">667</span></a>        <span class="n">semantic_threshold</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-668"><a href="#AntiDuplicateMemory-668"><span class="linenos">668</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mem1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">memories</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory-669"><a href="#AntiDuplicateMemory-669"><span class="linenos">669</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mem2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">memories</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory-670"><a href="#AntiDuplicateMemory-670"><span class="linenos">670</span></a>                <span class="n">similarity</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-671"><a href="#AntiDuplicateMemory-671"><span class="linenos">671</span></a>                    <span class="kc">None</span><span class="p">,</span> <span class="n">mem1</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">mem2</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-672"><a href="#AntiDuplicateMemory-672"><span class="linenos">672</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-673"><a href="#AntiDuplicateMemory-673"><span class="linenos">673</span></a>                <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">semantic_threshold</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-674"><a href="#AntiDuplicateMemory-674"><span class="linenos">674</span></a>                    <span class="n">potential_duplicates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">similarity</span><span class="p">))</span>
</span><span id="AntiDuplicateMemory-675"><a href="#AntiDuplicateMemory-675"><span class="linenos">675</span></a>
</span><span id="AntiDuplicateMemory-676"><a href="#AntiDuplicateMemory-676"><span class="linenos">676</span></a>        <span class="c1"># Find combined memories</span>
</span><span id="AntiDuplicateMemory-677"><a href="#AntiDuplicateMemory-677"><span class="linenos">677</span></a>        <span class="n">combined_memories</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AntiDuplicateMemory-678"><a href="#AntiDuplicateMemory-678"><span class="linenos">678</span></a>            <span class="n">i</span>
</span><span id="AntiDuplicateMemory-679"><a href="#AntiDuplicateMemory-679"><span class="linenos">679</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-680"><a href="#AntiDuplicateMemory-680"><span class="linenos">680</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_multiple_facts</span><span class="p">(</span><span class="n">mem</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-681"><a href="#AntiDuplicateMemory-681"><span class="linenos">681</span></a>        <span class="p">]</span>
</span><span id="AntiDuplicateMemory-682"><a href="#AntiDuplicateMemory-682"><span class="linenos">682</span></a>
</span><span id="AntiDuplicateMemory-683"><a href="#AntiDuplicateMemory-683"><span class="linenos">683</span></a>        <span class="c1"># Calculate average memory length</span>
</span><span id="AntiDuplicateMemory-684"><a href="#AntiDuplicateMemory-684"><span class="linenos">684</span></a>        <span class="n">avg_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-685"><a href="#AntiDuplicateMemory-685"><span class="linenos">685</span></a>
</span><span id="AntiDuplicateMemory-686"><a href="#AntiDuplicateMemory-686"><span class="linenos">686</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="AntiDuplicateMemory-687"><a href="#AntiDuplicateMemory-687"><span class="linenos">687</span></a>            <span class="s2">&quot;total_memories&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">),</span>
</span><span id="AntiDuplicateMemory-688"><a href="#AntiDuplicateMemory-688"><span class="linenos">688</span></a>            <span class="s2">&quot;unique_texts&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_texts</span><span class="p">),</span>
</span><span id="AntiDuplicateMemory-689"><a href="#AntiDuplicateMemory-689"><span class="linenos">689</span></a>            <span class="s2">&quot;exact_duplicates&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory_texts</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_texts</span><span class="p">),</span>
</span><span id="AntiDuplicateMemory-690"><a href="#AntiDuplicateMemory-690"><span class="linenos">690</span></a>            <span class="s2">&quot;potential_semantic_duplicates&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">potential_duplicates</span><span class="p">),</span>
</span><span id="AntiDuplicateMemory-691"><a href="#AntiDuplicateMemory-691"><span class="linenos">691</span></a>            <span class="s2">&quot;combined_memories&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_memories</span><span class="p">),</span>
</span><span id="AntiDuplicateMemory-692"><a href="#AntiDuplicateMemory-692"><span class="linenos">692</span></a>            <span class="s2">&quot;average_memory_length&quot;</span><span class="p">:</span> <span class="n">avg_length</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-693"><a href="#AntiDuplicateMemory-693"><span class="linenos">693</span></a>            <span class="s2">&quot;duplicate_pairs&quot;</span><span class="p">:</span> <span class="n">potential_duplicates</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-694"><a href="#AntiDuplicateMemory-694"><span class="linenos">694</span></a>            <span class="s2">&quot;combined_memory_indices&quot;</span><span class="p">:</span> <span class="n">combined_memories</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory-695"><a href="#AntiDuplicateMemory-695"><span class="linenos">695</span></a>        <span class="p">}</span>
</span><span id="AntiDuplicateMemory-696"><a href="#AntiDuplicateMemory-696"><span class="linenos">696</span></a>
</span><span id="AntiDuplicateMemory-697"><a href="#AntiDuplicateMemory-697"><span class="linenos">697</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_memory_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory-698"><a href="#AntiDuplicateMemory-698"><span class="linenos">698</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-699"><a href="#AntiDuplicateMemory-699"><span class="linenos">699</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory-700"><a href="#AntiDuplicateMemory-700"><span class="linenos">700</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-701"><a href="#AntiDuplicateMemory-701"><span class="linenos">701</span></a><span class="sd">        Print a detailed analysis of memory quality.</span>
</span><span id="AntiDuplicateMemory-702"><a href="#AntiDuplicateMemory-702"><span class="linenos">702</span></a>
</span><span id="AntiDuplicateMemory-703"><a href="#AntiDuplicateMemory-703"><span class="linenos">703</span></a><span class="sd">        :param user_id: User ID to analyze</span>
</span><span id="AntiDuplicateMemory-704"><a href="#AntiDuplicateMemory-704"><span class="linenos">704</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory-705"><a href="#AntiDuplicateMemory-705"><span class="linenos">705</span></a>        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_memory_stats</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-706"><a href="#AntiDuplicateMemory-706"><span class="linenos">706</span></a>        <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-707"><a href="#AntiDuplicateMemory-707"><span class="linenos">707</span></a>
</span><span id="AntiDuplicateMemory-708"><a href="#AntiDuplicateMemory-708"><span class="linenos">708</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> MEMORY ANALYSIS FOR USER: </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-709"><a href="#AntiDuplicateMemory-709"><span class="linenos">709</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-710"><a href="#AntiDuplicateMemory-710"><span class="linenos">710</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total memories: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_memories&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-711"><a href="#AntiDuplicateMemory-711"><span class="linenos">711</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unique texts: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;unique_texts&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-712"><a href="#AntiDuplicateMemory-712"><span class="linenos">712</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exact duplicates: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;exact_duplicates&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-713"><a href="#AntiDuplicateMemory-713"><span class="linenos">713</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory-714"><a href="#AntiDuplicateMemory-714"><span class="linenos">714</span></a>            <span class="sa">f</span><span class="s2">&quot;Potential semantic duplicates: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;potential_semantic_duplicates&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AntiDuplicateMemory-715"><a href="#AntiDuplicateMemory-715"><span class="linenos">715</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory-716"><a href="#AntiDuplicateMemory-716"><span class="linenos">716</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined memories: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;combined_memories&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-717"><a href="#AntiDuplicateMemory-717"><span class="linenos">717</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average memory length: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;average_memory_length&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> chars&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-718"><a href="#AntiDuplicateMemory-718"><span class="linenos">718</span></a>
</span><span id="AntiDuplicateMemory-719"><a href="#AntiDuplicateMemory-719"><span class="linenos">719</span></a>        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;exact_duplicates&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-720"><a href="#AntiDuplicateMemory-720"><span class="linenos">720</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  EXACT DUPLICATES DETECTED!&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-721"><a href="#AntiDuplicateMemory-721"><span class="linenos">721</span></a>
</span><span id="AntiDuplicateMemory-722"><a href="#AntiDuplicateMemory-722"><span class="linenos">722</span></a>        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;potential_semantic_duplicates&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-723"><a href="#AntiDuplicateMemory-723"><span class="linenos">723</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> POTENTIAL SEMANTIC DUPLICATES:&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-724"><a href="#AntiDuplicateMemory-724"><span class="linenos">724</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">similarity</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;duplicate_pairs&quot;</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory-725"><a href="#AntiDuplicateMemory-725"><span class="linenos">725</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">similarity</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> similarity:&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-726"><a href="#AntiDuplicateMemory-726"><span class="linenos">726</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    [</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">memories</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-727"><a href="#AntiDuplicateMemory-727"><span class="linenos">727</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    [</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">memories</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-728"><a href="#AntiDuplicateMemory-728"><span class="linenos">728</span></a>
</span><span id="AntiDuplicateMemory-729"><a href="#AntiDuplicateMemory-729"><span class="linenos">729</span></a>        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;combined_memories&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory-730"><a href="#AntiDuplicateMemory-730"><span class="linenos">730</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> COMBINED MEMORIES:&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-731"><a href="#AntiDuplicateMemory-731"><span class="linenos">731</span></a>            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;combined_memory_indices&quot;</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory-732"><a href="#AntiDuplicateMemory-732"><span class="linenos">732</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Memory: &#39;</span><span class="si">{</span><span class="n">memories</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory-733"><a href="#AntiDuplicateMemory-733"><span class="linenos">733</span></a>
</span><span id="AntiDuplicateMemory-734"><a href="#AntiDuplicateMemory-734"><span class="linenos">734</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="AntiDuplicateMemory-735"><a href="#AntiDuplicateMemory-735"><span class="linenos">735</span></a>            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;exact_duplicates&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="AntiDuplicateMemory-736"><a href="#AntiDuplicateMemory-736"><span class="linenos">736</span></a>            <span class="ow">and</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;potential_semantic_duplicates&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="AntiDuplicateMemory-737"><a href="#AntiDuplicateMemory-737"><span class="linenos">737</span></a>            <span class="ow">and</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;combined_memories&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="AntiDuplicateMemory-738"><a href="#AntiDuplicateMemory-738"><span class="linenos">738</span></a>        <span class="p">):</span>
</span><span id="AntiDuplicateMemory-739"><a href="#AntiDuplicateMemory-739"><span class="linenos">739</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> EXCELLENT: No duplicates or combined memories detected!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Enhanced Memory class that prevents duplicate memory creation.</p>

<p>This class extends Agno's Memory class with intelligent duplicate detection
and prevention mechanisms specifically designed to address the memory
duplication issues found in Ollama models.</p>
</div>


                            <div id="AntiDuplicateMemory.__init__" class="classattr">
                                        <input id="AntiDuplicateMemory.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">AntiDuplicateMemory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">agno</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>,</span><span class="param">	<span class="n">enable_semantic_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">enable_exact_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">enable_optimizations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="AntiDuplicateMemory.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AntiDuplicateMemory.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AntiDuplicateMemory.__init__-64"><a href="#AntiDuplicateMemory.__init__-64"><span class="linenos"> 64</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory.__init__-65"><a href="#AntiDuplicateMemory.__init__-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-66"><a href="#AntiDuplicateMemory.__init__-66"><span class="linenos"> 66</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-67"><a href="#AntiDuplicateMemory.__init__-67"><span class="linenos"> 67</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-68"><a href="#AntiDuplicateMemory.__init__-68"><span class="linenos"> 68</span></a>        <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-69"><a href="#AntiDuplicateMemory.__init__-69"><span class="linenos"> 69</span></a>        <span class="n">enable_semantic_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-70"><a href="#AntiDuplicateMemory.__init__-70"><span class="linenos"> 70</span></a>        <span class="n">enable_exact_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-71"><a href="#AntiDuplicateMemory.__init__-71"><span class="linenos"> 71</span></a>        <span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-72"><a href="#AntiDuplicateMemory.__init__-72"><span class="linenos"> 72</span></a>        <span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-73"><a href="#AntiDuplicateMemory.__init__-73"><span class="linenos"> 73</span></a>        <span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-74"><a href="#AntiDuplicateMemory.__init__-74"><span class="linenos"> 74</span></a>        <span class="n">enable_optimizations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-75"><a href="#AntiDuplicateMemory.__init__-75"><span class="linenos"> 75</span></a>    <span class="p">):</span>
</span><span id="AntiDuplicateMemory.__init__-76"><a href="#AntiDuplicateMemory.__init__-76"><span class="linenos"> 76</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory.__init__-77"><a href="#AntiDuplicateMemory.__init__-77"><span class="linenos"> 77</span></a><span class="sd">        Initialize the anti-duplicate memory manager.</span>
</span><span id="AntiDuplicateMemory.__init__-78"><a href="#AntiDuplicateMemory.__init__-78"><span class="linenos"> 78</span></a>
</span><span id="AntiDuplicateMemory.__init__-79"><a href="#AntiDuplicateMemory.__init__-79"><span class="linenos"> 79</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="AntiDuplicateMemory.__init__-80"><a href="#AntiDuplicateMemory.__init__-80"><span class="linenos"> 80</span></a><span class="sd">        :param model: Model for memory operations</span>
</span><span id="AntiDuplicateMemory.__init__-81"><a href="#AntiDuplicateMemory.__init__-81"><span class="linenos"> 81</span></a><span class="sd">        :param similarity_threshold: Threshold for semantic similarity (0.0-1.0)</span>
</span><span id="AntiDuplicateMemory.__init__-82"><a href="#AntiDuplicateMemory.__init__-82"><span class="linenos"> 82</span></a><span class="sd">        :param enable_semantic_dedup: Enable semantic duplicate detection</span>
</span><span id="AntiDuplicateMemory.__init__-83"><a href="#AntiDuplicateMemory.__init__-83"><span class="linenos"> 83</span></a><span class="sd">        :param enable_exact_dedup: Enable exact duplicate detection</span>
</span><span id="AntiDuplicateMemory.__init__-84"><a href="#AntiDuplicateMemory.__init__-84"><span class="linenos"> 84</span></a><span class="sd">        :param debug_mode: Enable debug logging</span>
</span><span id="AntiDuplicateMemory.__init__-85"><a href="#AntiDuplicateMemory.__init__-85"><span class="linenos"> 85</span></a><span class="sd">        :param delete_memories: Allow the agent to delete memories when needed</span>
</span><span id="AntiDuplicateMemory.__init__-86"><a href="#AntiDuplicateMemory.__init__-86"><span class="linenos"> 86</span></a><span class="sd">        :param clear_memories: Allow the agent to clear all memories</span>
</span><span id="AntiDuplicateMemory.__init__-87"><a href="#AntiDuplicateMemory.__init__-87"><span class="linenos"> 87</span></a><span class="sd">        :param enable_optimizations: Enable performance optimizations using direct read_memories calls</span>
</span><span id="AntiDuplicateMemory.__init__-88"><a href="#AntiDuplicateMemory.__init__-88"><span class="linenos"> 88</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory.__init__-89"><a href="#AntiDuplicateMemory.__init__-89"><span class="linenos"> 89</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory.__init__-90"><a href="#AntiDuplicateMemory.__init__-90"><span class="linenos"> 90</span></a>            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-91"><a href="#AntiDuplicateMemory.__init__-91"><span class="linenos"> 91</span></a>            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-92"><a href="#AntiDuplicateMemory.__init__-92"><span class="linenos"> 92</span></a>            <span class="n">delete_memories</span><span class="o">=</span><span class="n">delete_memories</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-93"><a href="#AntiDuplicateMemory.__init__-93"><span class="linenos"> 93</span></a>            <span class="n">clear_memories</span><span class="o">=</span><span class="n">clear_memories</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-94"><a href="#AntiDuplicateMemory.__init__-94"><span class="linenos"> 94</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory.__init__-95"><a href="#AntiDuplicateMemory.__init__-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span> <span class="o">=</span> <span class="n">similarity_threshold</span>
</span><span id="AntiDuplicateMemory.__init__-96"><a href="#AntiDuplicateMemory.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_semantic_dedup</span> <span class="o">=</span> <span class="n">enable_semantic_dedup</span>
</span><span id="AntiDuplicateMemory.__init__-97"><a href="#AntiDuplicateMemory.__init__-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_exact_dedup</span> <span class="o">=</span> <span class="n">enable_exact_dedup</span>
</span><span id="AntiDuplicateMemory.__init__-98"><a href="#AntiDuplicateMemory.__init__-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span> <span class="o">=</span> <span class="n">debug_mode</span>
</span><span id="AntiDuplicateMemory.__init__-99"><a href="#AntiDuplicateMemory.__init__-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_optimizations</span> <span class="o">=</span> <span class="n">enable_optimizations</span>
</span><span id="AntiDuplicateMemory.__init__-100"><a href="#AntiDuplicateMemory.__init__-100"><span class="linenos">100</span></a>
</span><span id="AntiDuplicateMemory.__init__-101"><a href="#AntiDuplicateMemory.__init__-101"><span class="linenos">101</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.__init__-102"><a href="#AntiDuplicateMemory.__init__-102"><span class="linenos">102</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.__init__-103"><a href="#AntiDuplicateMemory.__init__-103"><span class="linenos">103</span></a>
</span><span id="AntiDuplicateMemory.__init__-104"><a href="#AntiDuplicateMemory.__init__-104"><span class="linenos">104</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory.__init__-105"><a href="#AntiDuplicateMemory.__init__-105"><span class="linenos">105</span></a>            <span class="s2">&quot;Initialized AntiDuplicateMemory with similarity_threshold=</span><span class="si">%.2f</span><span class="s2">, optimizations=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-106"><a href="#AntiDuplicateMemory.__init__-106"><span class="linenos">106</span></a>            <span class="n">similarity_threshold</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-107"><a href="#AntiDuplicateMemory.__init__-107"><span class="linenos">107</span></a>            <span class="n">enable_optimizations</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.__init__-108"><a href="#AntiDuplicateMemory.__init__-108"><span class="linenos">108</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the anti-duplicate memory manager.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>model</strong>:  Model for memory operations</li>
<li><strong>similarity_threshold</strong>:  Threshold for semantic similarity (0.0-1.0)</li>
<li><strong>enable_semantic_dedup</strong>:  Enable semantic duplicate detection</li>
<li><strong>enable_exact_dedup</strong>:  Enable exact duplicate detection</li>
<li><strong>debug_mode</strong>:  Enable debug logging</li>
<li><strong>delete_memories</strong>:  Allow the agent to delete memories when needed</li>
<li><strong>clear_memories</strong>:  Allow the agent to clear all memories</li>
<li><strong>enable_optimizations</strong>:  Enable performance optimizations using direct read_memories calls</li>
</ul>
</div>


                            </div>
                            <div id="AntiDuplicateMemory.similarity_threshold" class="classattr">
                                <div class="attr variable">
            <span class="name">similarity_threshold</span>

        
    </div>
    <a class="headerlink" href="#AntiDuplicateMemory.similarity_threshold"></a>
    
    

                            </div>
                            <div id="AntiDuplicateMemory.enable_semantic_dedup" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_semantic_dedup</span>

        
    </div>
    <a class="headerlink" href="#AntiDuplicateMemory.enable_semantic_dedup"></a>
    
    

                            </div>
                            <div id="AntiDuplicateMemory.enable_exact_dedup" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_exact_dedup</span>

        
    </div>
    <a class="headerlink" href="#AntiDuplicateMemory.enable_exact_dedup"></a>
    
    

                            </div>
                            <div id="AntiDuplicateMemory.debug_mode" class="classattr">
                                <div class="attr variable">
            <span class="name">debug_mode</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#AntiDuplicateMemory.debug_mode"></a>
    
    

                            </div>
                            <div id="AntiDuplicateMemory.enable_optimizations" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_optimizations</span>

        
    </div>
    <a class="headerlink" href="#AntiDuplicateMemory.enable_optimizations"></a>
    
    

                            </div>
                            <div id="AntiDuplicateMemory.add_user_memory" class="classattr">
                                        <input id="AntiDuplicateMemory.add_user_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_user_memory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">memory</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">UserMemory</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">refresh_from_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="AntiDuplicateMemory.add_user_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AntiDuplicateMemory.add_user_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AntiDuplicateMemory.add_user_memory-445"><a href="#AntiDuplicateMemory.add_user_memory-445"><span class="linenos">445</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_user_memory</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory.add_user_memory-446"><a href="#AntiDuplicateMemory.add_user_memory-446"><span class="linenos">446</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.add_user_memory-447"><a href="#AntiDuplicateMemory.add_user_memory-447"><span class="linenos">447</span></a>        <span class="n">memory</span><span class="p">:</span> <span class="n">UserMemory</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.add_user_memory-448"><a href="#AntiDuplicateMemory.add_user_memory-448"><span class="linenos">448</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.add_user_memory-449"><a href="#AntiDuplicateMemory.add_user_memory-449"><span class="linenos">449</span></a>        <span class="n">refresh_from_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.add_user_memory-450"><a href="#AntiDuplicateMemory.add_user_memory-450"><span class="linenos">450</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory.add_user_memory-451"><a href="#AntiDuplicateMemory.add_user_memory-451"><span class="linenos">451</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory.add_user_memory-452"><a href="#AntiDuplicateMemory.add_user_memory-452"><span class="linenos">452</span></a><span class="sd">        Add a user memory with duplicate prevention.</span>
</span><span id="AntiDuplicateMemory.add_user_memory-453"><a href="#AntiDuplicateMemory.add_user_memory-453"><span class="linenos">453</span></a>
</span><span id="AntiDuplicateMemory.add_user_memory-454"><a href="#AntiDuplicateMemory.add_user_memory-454"><span class="linenos">454</span></a><span class="sd">        :param memory: UserMemory object to add</span>
</span><span id="AntiDuplicateMemory.add_user_memory-455"><a href="#AntiDuplicateMemory.add_user_memory-455"><span class="linenos">455</span></a><span class="sd">        :param user_id: User ID for the memory</span>
</span><span id="AntiDuplicateMemory.add_user_memory-456"><a href="#AntiDuplicateMemory.add_user_memory-456"><span class="linenos">456</span></a><span class="sd">        :param refresh_from_db: Whether to refresh from database before adding</span>
</span><span id="AntiDuplicateMemory.add_user_memory-457"><a href="#AntiDuplicateMemory.add_user_memory-457"><span class="linenos">457</span></a><span class="sd">        :return: Memory ID if added, None if rejected</span>
</span><span id="AntiDuplicateMemory.add_user_memory-458"><a href="#AntiDuplicateMemory.add_user_memory-458"><span class="linenos">458</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory.add_user_memory-459"><a href="#AntiDuplicateMemory.add_user_memory-459"><span class="linenos">459</span></a>        <span class="c1"># Default user_id if not provided</span>
</span><span id="AntiDuplicateMemory.add_user_memory-460"><a href="#AntiDuplicateMemory.add_user_memory-460"><span class="linenos">460</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.add_user_memory-461"><a href="#AntiDuplicateMemory.add_user_memory-461"><span class="linenos">461</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory.add_user_memory-462"><a href="#AntiDuplicateMemory.add_user_memory-462"><span class="linenos">462</span></a>        <span class="c1"># Handle case where topics comes in as string representation of list</span>
</span><span id="AntiDuplicateMemory.add_user_memory-463"><a href="#AntiDuplicateMemory.add_user_memory-463"><span class="linenos">463</span></a>        <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory.add_user_memory-464"><a href="#AntiDuplicateMemory.add_user_memory-464"><span class="linenos">464</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.add_user_memory-465"><a href="#AntiDuplicateMemory.add_user_memory-465"><span class="linenos">465</span></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="AntiDuplicateMemory.add_user_memory-466"><a href="#AntiDuplicateMemory.add_user_memory-466"><span class="linenos">466</span></a>
</span><span id="AntiDuplicateMemory.add_user_memory-467"><a href="#AntiDuplicateMemory.add_user_memory-467"><span class="linenos">467</span></a>                <span class="c1"># Try to parse as JSON</span>
</span><span id="AntiDuplicateMemory.add_user_memory-468"><a href="#AntiDuplicateMemory.add_user_memory-468"><span class="linenos">468</span></a>                <span class="n">parsed_topics</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.add_user_memory-469"><a href="#AntiDuplicateMemory.add_user_memory-469"><span class="linenos">469</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed_topics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory.add_user_memory-470"><a href="#AntiDuplicateMemory.add_user_memory-470"><span class="linenos">470</span></a>                    <span class="n">memory</span><span class="o">.</span><span class="n">topics</span> <span class="o">=</span> <span class="n">parsed_topics</span>
</span><span id="AntiDuplicateMemory.add_user_memory-471"><a href="#AntiDuplicateMemory.add_user_memory-471"><span class="linenos">471</span></a>            <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory.add_user_memory-472"><a href="#AntiDuplicateMemory.add_user_memory-472"><span class="linenos">472</span></a>                <span class="c1"># If JSON parsing fails, treat as a single topic</span>
</span><span id="AntiDuplicateMemory.add_user_memory-473"><a href="#AntiDuplicateMemory.add_user_memory-473"><span class="linenos">473</span></a>                <span class="n">memory</span><span class="o">.</span><span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">]</span>
</span><span id="AntiDuplicateMemory.add_user_memory-474"><a href="#AntiDuplicateMemory.add_user_memory-474"><span class="linenos">474</span></a>
</span><span id="AntiDuplicateMemory.add_user_memory-475"><a href="#AntiDuplicateMemory.add_user_memory-475"><span class="linenos">475</span></a>        <span class="c1"># Get existing memories for this user (optimized for recent memories only)</span>
</span><span id="AntiDuplicateMemory.add_user_memory-476"><a href="#AntiDuplicateMemory.add_user_memory-476"><span class="linenos">476</span></a>        <span class="n">existing_memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_recent_memories_for_dedup</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory.add_user_memory-477"><a href="#AntiDuplicateMemory.add_user_memory-477"><span class="linenos">477</span></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span>
</span><span id="AntiDuplicateMemory.add_user_memory-478"><a href="#AntiDuplicateMemory.add_user_memory-478"><span class="linenos">478</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory.add_user_memory-479"><a href="#AntiDuplicateMemory.add_user_memory-479"><span class="linenos">479</span></a>
</span><span id="AntiDuplicateMemory.add_user_memory-480"><a href="#AntiDuplicateMemory.add_user_memory-480"><span class="linenos">480</span></a>        <span class="c1"># Check if this memory should be rejected</span>
</span><span id="AntiDuplicateMemory.add_user_memory-481"><a href="#AntiDuplicateMemory.add_user_memory-481"><span class="linenos">481</span></a>        <span class="n">should_reject</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_reject_memory</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory.add_user_memory-482"><a href="#AntiDuplicateMemory.add_user_memory-482"><span class="linenos">482</span></a>            <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="n">existing_memories</span>
</span><span id="AntiDuplicateMemory.add_user_memory-483"><a href="#AntiDuplicateMemory.add_user_memory-483"><span class="linenos">483</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory.add_user_memory-484"><a href="#AntiDuplicateMemory.add_user_memory-484"><span class="linenos">484</span></a>
</span><span id="AntiDuplicateMemory.add_user_memory-485"><a href="#AntiDuplicateMemory.add_user_memory-485"><span class="linenos">485</span></a>        <span class="k">if</span> <span class="n">should_reject</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.add_user_memory-486"><a href="#AntiDuplicateMemory.add_user_memory-486"><span class="linenos">486</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory.add_user_memory-487"><a href="#AntiDuplicateMemory.add_user_memory-487"><span class="linenos">487</span></a>                <span class="s2">&quot;Rejecting memory for user </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">. Memory: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.add_user_memory-488"><a href="#AntiDuplicateMemory.add_user_memory-488"><span class="linenos">488</span></a>                <span class="n">user_id</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.add_user_memory-489"><a href="#AntiDuplicateMemory.add_user_memory-489"><span class="linenos">489</span></a>                <span class="n">reason</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.add_user_memory-490"><a href="#AntiDuplicateMemory.add_user_memory-490"><span class="linenos">490</span></a>                <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.add_user_memory-491"><a href="#AntiDuplicateMemory.add_user_memory-491"><span class="linenos">491</span></a>            <span class="p">)</span>
</span><span id="AntiDuplicateMemory.add_user_memory-492"><a href="#AntiDuplicateMemory.add_user_memory-492"><span class="linenos">492</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.add_user_memory-493"><a href="#AntiDuplicateMemory.add_user_memory-493"><span class="linenos">493</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; REJECTED: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.add_user_memory-494"><a href="#AntiDuplicateMemory.add_user_memory-494"><span class="linenos">494</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Memory: &#39;</span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.add_user_memory-495"><a href="#AntiDuplicateMemory.add_user_memory-495"><span class="linenos">495</span></a>
</span><span id="AntiDuplicateMemory.add_user_memory-496"><a href="#AntiDuplicateMemory.add_user_memory-496"><span class="linenos">496</span></a>            <span class="c1"># Return None to indicate rejection - this is the expected behavior</span>
</span><span id="AntiDuplicateMemory.add_user_memory-497"><a href="#AntiDuplicateMemory.add_user_memory-497"><span class="linenos">497</span></a>            <span class="c1"># for duplicate detection and what the tests expect</span>
</span><span id="AntiDuplicateMemory.add_user_memory-498"><a href="#AntiDuplicateMemory.add_user_memory-498"><span class="linenos">498</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="AntiDuplicateMemory.add_user_memory-499"><a href="#AntiDuplicateMemory.add_user_memory-499"><span class="linenos">499</span></a>
</span><span id="AntiDuplicateMemory.add_user_memory-500"><a href="#AntiDuplicateMemory.add_user_memory-500"><span class="linenos">500</span></a>        <span class="c1"># Memory is unique, proceed with addition</span>
</span><span id="AntiDuplicateMemory.add_user_memory-501"><a href="#AntiDuplicateMemory.add_user_memory-501"><span class="linenos">501</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding unique memory for user </span><span class="si">%s</span><span class="s2">: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.add_user_memory-502"><a href="#AntiDuplicateMemory.add_user_memory-502"><span class="linenos">502</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.add_user_memory-503"><a href="#AntiDuplicateMemory.add_user_memory-503"><span class="linenos">503</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ACCEPTED: &#39;</span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.add_user_memory-504"><a href="#AntiDuplicateMemory.add_user_memory-504"><span class="linenos">504</span></a>
</span><span id="AntiDuplicateMemory.add_user_memory-505"><a href="#AntiDuplicateMemory.add_user_memory-505"><span class="linenos">505</span></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_user_memory</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Add a user memory with duplicate prevention.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>memory</strong>:  UserMemory object to add</li>
<li><strong>user_id</strong>:  User ID for the memory</li>
<li><strong>refresh_from_db</strong>:  Whether to refresh from database before adding</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Memory ID if added, None if rejected</p>
</blockquote>
</div>


                            </div>
                            <div id="AntiDuplicateMemory.create_user_memories" class="classattr">
                                        <input id="AntiDuplicateMemory.create_user_memories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_user_memories</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">refresh_from_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">UserMemory</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="AntiDuplicateMemory.create_user_memories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AntiDuplicateMemory.create_user_memories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AntiDuplicateMemory.create_user_memories-507"><a href="#AntiDuplicateMemory.create_user_memories-507"><span class="linenos">507</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_user_memories</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory.create_user_memories-508"><a href="#AntiDuplicateMemory.create_user_memories-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.create_user_memories-509"><a href="#AntiDuplicateMemory.create_user_memories-509"><span class="linenos">509</span></a>        <span class="n">message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.create_user_memories-510"><a href="#AntiDuplicateMemory.create_user_memories-510"><span class="linenos">510</span></a>        <span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.create_user_memories-511"><a href="#AntiDuplicateMemory.create_user_memories-511"><span class="linenos">511</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.create_user_memories-512"><a href="#AntiDuplicateMemory.create_user_memories-512"><span class="linenos">512</span></a>        <span class="n">refresh_from_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.create_user_memories-513"><a href="#AntiDuplicateMemory.create_user_memories-513"><span class="linenos">513</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory.create_user_memories-514"><a href="#AntiDuplicateMemory.create_user_memories-514"><span class="linenos">514</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory.create_user_memories-515"><a href="#AntiDuplicateMemory.create_user_memories-515"><span class="linenos">515</span></a><span class="sd">        Create user memories from messages with duplicate prevention.</span>
</span><span id="AntiDuplicateMemory.create_user_memories-516"><a href="#AntiDuplicateMemory.create_user_memories-516"><span class="linenos">516</span></a>
</span><span id="AntiDuplicateMemory.create_user_memories-517"><a href="#AntiDuplicateMemory.create_user_memories-517"><span class="linenos">517</span></a><span class="sd">        :param message: Single message to create memories from</span>
</span><span id="AntiDuplicateMemory.create_user_memories-518"><a href="#AntiDuplicateMemory.create_user_memories-518"><span class="linenos">518</span></a><span class="sd">        :param messages: List of messages to create memories from</span>
</span><span id="AntiDuplicateMemory.create_user_memories-519"><a href="#AntiDuplicateMemory.create_user_memories-519"><span class="linenos">519</span></a><span class="sd">        :param user_id: User ID for the memories</span>
</span><span id="AntiDuplicateMemory.create_user_memories-520"><a href="#AntiDuplicateMemory.create_user_memories-520"><span class="linenos">520</span></a><span class="sd">        :param refresh_from_db: Whether to refresh from database before creating</span>
</span><span id="AntiDuplicateMemory.create_user_memories-521"><a href="#AntiDuplicateMemory.create_user_memories-521"><span class="linenos">521</span></a><span class="sd">        :return: List of successfully created memories</span>
</span><span id="AntiDuplicateMemory.create_user_memories-522"><a href="#AntiDuplicateMemory.create_user_memories-522"><span class="linenos">522</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory.create_user_memories-523"><a href="#AntiDuplicateMemory.create_user_memories-523"><span class="linenos">523</span></a>        <span class="c1"># Default user_id if not provided</span>
</span><span id="AntiDuplicateMemory.create_user_memories-524"><a href="#AntiDuplicateMemory.create_user_memories-524"><span class="linenos">524</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.create_user_memories-525"><a href="#AntiDuplicateMemory.create_user_memories-525"><span class="linenos">525</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory.create_user_memories-526"><a href="#AntiDuplicateMemory.create_user_memories-526"><span class="linenos">526</span></a>            
</span><span id="AntiDuplicateMemory.create_user_memories-527"><a href="#AntiDuplicateMemory.create_user_memories-527"><span class="linenos">527</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating memories for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.create_user_memories-528"><a href="#AntiDuplicateMemory.create_user_memories-528"><span class="linenos">528</span></a>        <span class="n">created_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AntiDuplicateMemory.create_user_memories-529"><a href="#AntiDuplicateMemory.create_user_memories-529"><span class="linenos">529</span></a>
</span><span id="AntiDuplicateMemory.create_user_memories-530"><a href="#AntiDuplicateMemory.create_user_memories-530"><span class="linenos">530</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.create_user_memories-531"><a href="#AntiDuplicateMemory.create_user_memories-531"><span class="linenos">531</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory.create_user_memories-532"><a href="#AntiDuplicateMemory.create_user_memories-532"><span class="linenos">532</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Creating memories (existing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_recent_memories_for_dedup</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="AntiDuplicateMemory.create_user_memories-533"><a href="#AntiDuplicateMemory.create_user_memories-533"><span class="linenos">533</span></a>            <span class="p">)</span>
</span><span id="AntiDuplicateMemory.create_user_memories-534"><a href="#AntiDuplicateMemory.create_user_memories-534"><span class="linenos">534</span></a>            <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.create_user_memories-535"><a href="#AntiDuplicateMemory.create_user_memories-535"><span class="linenos">535</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Input: &#39;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.create_user_memories-536"><a href="#AntiDuplicateMemory.create_user_memories-536"><span class="linenos">536</span></a>            <span class="k">elif</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.create_user_memories-537"><a href="#AntiDuplicateMemory.create_user_memories-537"><span class="linenos">537</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Input: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.create_user_memories-538"><a href="#AntiDuplicateMemory.create_user_memories-538"><span class="linenos">538</span></a>
</span><span id="AntiDuplicateMemory.create_user_memories-539"><a href="#AntiDuplicateMemory.create_user_memories-539"><span class="linenos">539</span></a>        <span class="c1"># Handle a single message string</span>
</span><span id="AntiDuplicateMemory.create_user_memories-540"><a href="#AntiDuplicateMemory.create_user_memories-540"><span class="linenos">540</span></a>        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.create_user_memories-541"><a href="#AntiDuplicateMemory.create_user_memories-541"><span class="linenos">541</span></a>            <span class="n">memory_obj</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">])</span>
</span><span id="AntiDuplicateMemory.create_user_memories-542"><a href="#AntiDuplicateMemory.create_user_memories-542"><span class="linenos">542</span></a>            <span class="n">memory_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_user_memory</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory_obj</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.create_user_memories-543"><a href="#AntiDuplicateMemory.create_user_memories-543"><span class="linenos">543</span></a>            <span class="k">if</span> <span class="n">memory_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.create_user_memories-544"><a href="#AntiDuplicateMemory.create_user_memories-544"><span class="linenos">544</span></a>                <span class="n">memory_obj</span><span class="o">.</span><span class="n">memory_id</span> <span class="o">=</span> <span class="n">memory_id</span>
</span><span id="AntiDuplicateMemory.create_user_memories-545"><a href="#AntiDuplicateMemory.create_user_memories-545"><span class="linenos">545</span></a>                <span class="n">created_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory_obj</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.create_user_memories-546"><a href="#AntiDuplicateMemory.create_user_memories-546"><span class="linenos">546</span></a>
</span><span id="AntiDuplicateMemory.create_user_memories-547"><a href="#AntiDuplicateMemory.create_user_memories-547"><span class="linenos">547</span></a>        <span class="c1"># Handle a list of messages</span>
</span><span id="AntiDuplicateMemory.create_user_memories-548"><a href="#AntiDuplicateMemory.create_user_memories-548"><span class="linenos">548</span></a>        <span class="k">elif</span> <span class="n">messages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.create_user_memories-549"><a href="#AntiDuplicateMemory.create_user_memories-549"><span class="linenos">549</span></a>            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.create_user_memories-550"><a href="#AntiDuplicateMemory.create_user_memories-550"><span class="linenos">550</span></a>                <span class="c1"># Handle different message formats</span>
</span><span id="AntiDuplicateMemory.create_user_memories-551"><a href="#AntiDuplicateMemory.create_user_memories-551"><span class="linenos">551</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory.create_user_memories-552"><a href="#AntiDuplicateMemory.create_user_memories-552"><span class="linenos">552</span></a>                    <span class="c1"># It&#39;s a Message object</span>
</span><span id="AntiDuplicateMemory.create_user_memories-553"><a href="#AntiDuplicateMemory.create_user_memories-553"><span class="linenos">553</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.create_user_memories-554"><a href="#AntiDuplicateMemory.create_user_memories-554"><span class="linenos">554</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.create_user_memories-555"><a href="#AntiDuplicateMemory.create_user_memories-555"><span class="linenos">555</span></a>                    <span class="c1"># It&#39;s a string or something else</span>
</span><span id="AntiDuplicateMemory.create_user_memories-556"><a href="#AntiDuplicateMemory.create_user_memories-556"><span class="linenos">556</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.create_user_memories-557"><a href="#AntiDuplicateMemory.create_user_memories-557"><span class="linenos">557</span></a>
</span><span id="AntiDuplicateMemory.create_user_memories-558"><a href="#AntiDuplicateMemory.create_user_memories-558"><span class="linenos">558</span></a>                <span class="c1"># Create memory and add with deduplication</span>
</span><span id="AntiDuplicateMemory.create_user_memories-559"><a href="#AntiDuplicateMemory.create_user_memories-559"><span class="linenos">559</span></a>                <span class="n">memory_obj</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">])</span>
</span><span id="AntiDuplicateMemory.create_user_memories-560"><a href="#AntiDuplicateMemory.create_user_memories-560"><span class="linenos">560</span></a>                <span class="n">memory_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_user_memory</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory_obj</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">refresh_from_db</span><span class="o">=</span><span class="n">refresh_from_db</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.create_user_memories-561"><a href="#AntiDuplicateMemory.create_user_memories-561"><span class="linenos">561</span></a>                <span class="k">if</span> <span class="n">memory_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.create_user_memories-562"><a href="#AntiDuplicateMemory.create_user_memories-562"><span class="linenos">562</span></a>                    <span class="n">memory_obj</span><span class="o">.</span><span class="n">memory_id</span> <span class="o">=</span> <span class="n">memory_id</span>
</span><span id="AntiDuplicateMemory.create_user_memories-563"><a href="#AntiDuplicateMemory.create_user_memories-563"><span class="linenos">563</span></a>                    <span class="n">created_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory_obj</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.create_user_memories-564"><a href="#AntiDuplicateMemory.create_user_memories-564"><span class="linenos">564</span></a>
</span><span id="AntiDuplicateMemory.create_user_memories-565"><a href="#AntiDuplicateMemory.create_user_memories-565"><span class="linenos">565</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.create_user_memories-566"><a href="#AntiDuplicateMemory.create_user_memories-566"><span class="linenos">566</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Raw memories created: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">created_memories</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.create_user_memories-567"><a href="#AntiDuplicateMemory.create_user_memories-567"><span class="linenos">567</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Final memories after dedup: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">created_memories</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.create_user_memories-568"><a href="#AntiDuplicateMemory.create_user_memories-568"><span class="linenos">568</span></a>
</span><span id="AntiDuplicateMemory.create_user_memories-569"><a href="#AntiDuplicateMemory.create_user_memories-569"><span class="linenos">569</span></a>        <span class="k">return</span> <span class="n">created_memories</span>
</span></pre></div>


            <div class="docstring"><p>Create user memories from messages with duplicate prevention.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>message</strong>:  Single message to create memories from</li>
<li><strong>messages</strong>:  List of messages to create memories from</li>
<li><strong>user_id</strong>:  User ID for the memories</li>
<li><strong>refresh_from_db</strong>:  Whether to refresh from database before creating</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>List of successfully created memories</p>
</blockquote>
</div>


                            </div>
                            <div id="AntiDuplicateMemory.delete_user_memory" class="classattr">
                                        <input id="AntiDuplicateMemory.delete_user_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_user_memory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">refresh_from_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="AntiDuplicateMemory.delete_user_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AntiDuplicateMemory.delete_user_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AntiDuplicateMemory.delete_user_memory-607"><a href="#AntiDuplicateMemory.delete_user_memory-607"><span class="linenos">607</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_user_memory</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-608"><a href="#AntiDuplicateMemory.delete_user_memory-608"><span class="linenos">608</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-609"><a href="#AntiDuplicateMemory.delete_user_memory-609"><span class="linenos">609</span></a>        <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-610"><a href="#AntiDuplicateMemory.delete_user_memory-610"><span class="linenos">610</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-611"><a href="#AntiDuplicateMemory.delete_user_memory-611"><span class="linenos">611</span></a>        <span class="n">refresh_from_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-612"><a href="#AntiDuplicateMemory.delete_user_memory-612"><span class="linenos">612</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-613"><a href="#AntiDuplicateMemory.delete_user_memory-613"><span class="linenos">613</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-614"><a href="#AntiDuplicateMemory.delete_user_memory-614"><span class="linenos">614</span></a><span class="sd">        Delete a specific user memory.</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-615"><a href="#AntiDuplicateMemory.delete_user_memory-615"><span class="linenos">615</span></a>
</span><span id="AntiDuplicateMemory.delete_user_memory-616"><a href="#AntiDuplicateMemory.delete_user_memory-616"><span class="linenos">616</span></a><span class="sd">        :param memory_id: ID of the memory to delete</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-617"><a href="#AntiDuplicateMemory.delete_user_memory-617"><span class="linenos">617</span></a><span class="sd">        :param user_id: User ID for the memory</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-618"><a href="#AntiDuplicateMemory.delete_user_memory-618"><span class="linenos">618</span></a><span class="sd">        :param refresh_from_db: Whether to refresh from database before deleting</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-619"><a href="#AntiDuplicateMemory.delete_user_memory-619"><span class="linenos">619</span></a><span class="sd">        :return: None</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-620"><a href="#AntiDuplicateMemory.delete_user_memory-620"><span class="linenos">620</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-621"><a href="#AntiDuplicateMemory.delete_user_memory-621"><span class="linenos">621</span></a>        <span class="c1"># Default user_id if not provided</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-622"><a href="#AntiDuplicateMemory.delete_user_memory-622"><span class="linenos">622</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-623"><a href="#AntiDuplicateMemory.delete_user_memory-623"><span class="linenos">623</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-624"><a href="#AntiDuplicateMemory.delete_user_memory-624"><span class="linenos">624</span></a>            
</span><span id="AntiDuplicateMemory.delete_user_memory-625"><a href="#AntiDuplicateMemory.delete_user_memory-625"><span class="linenos">625</span></a>        <span class="c1"># Refresh from the DB</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-626"><a href="#AntiDuplicateMemory.delete_user_memory-626"><span class="linenos">626</span></a>        <span class="k">if</span> <span class="n">refresh_from_db</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-627"><a href="#AntiDuplicateMemory.delete_user_memory-627"><span class="linenos">627</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-628"><a href="#AntiDuplicateMemory.delete_user_memory-628"><span class="linenos">628</span></a>
</span><span id="AntiDuplicateMemory.delete_user_memory-629"><a href="#AntiDuplicateMemory.delete_user_memory-629"><span class="linenos">629</span></a>        <span class="c1"># Check if memory exists in our local cache</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-630"><a href="#AntiDuplicateMemory.delete_user_memory-630"><span class="linenos">630</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories</span> <span class="ow">or</span> <span class="n">memory_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories</span><span class="p">[</span><span class="n">user_id</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-631"><a href="#AntiDuplicateMemory.delete_user_memory-631"><span class="linenos">631</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Memory </span><span class="si">%s</span><span class="s2"> not found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-632"><a href="#AntiDuplicateMemory.delete_user_memory-632"><span class="linenos">632</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-633"><a href="#AntiDuplicateMemory.delete_user_memory-633"><span class="linenos">633</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> not found for deletion&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-634"><a href="#AntiDuplicateMemory.delete_user_memory-634"><span class="linenos">634</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-635"><a href="#AntiDuplicateMemory.delete_user_memory-635"><span class="linenos">635</span></a>
</span><span id="AntiDuplicateMemory.delete_user_memory-636"><a href="#AntiDuplicateMemory.delete_user_memory-636"><span class="linenos">636</span></a>        <span class="c1"># Delete from local cache</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-637"><a href="#AntiDuplicateMemory.delete_user_memory-637"><span class="linenos">637</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">memory_id</span><span class="p">]</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-638"><a href="#AntiDuplicateMemory.delete_user_memory-638"><span class="linenos">638</span></a>        
</span><span id="AntiDuplicateMemory.delete_user_memory-639"><a href="#AntiDuplicateMemory.delete_user_memory-639"><span class="linenos">639</span></a>        <span class="c1"># Delete from database</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-640"><a href="#AntiDuplicateMemory.delete_user_memory-640"><span class="linenos">640</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-641"><a href="#AntiDuplicateMemory.delete_user_memory-641"><span class="linenos">641</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span><span class="n">memory_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-642"><a href="#AntiDuplicateMemory.delete_user_memory-642"><span class="linenos">642</span></a>            
</span><span id="AntiDuplicateMemory.delete_user_memory-643"><a href="#AntiDuplicateMemory.delete_user_memory-643"><span class="linenos">643</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted memory </span><span class="si">%s</span><span class="s2"> for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-644"><a href="#AntiDuplicateMemory.delete_user_memory-644"><span class="linenos">644</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.delete_user_memory-645"><a href="#AntiDuplicateMemory.delete_user_memory-645"><span class="linenos">645</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Deleted memory: </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Delete a specific user memory.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>memory_id</strong>:  ID of the memory to delete</li>
<li><strong>user_id</strong>:  User ID for the memory</li>
<li><strong>refresh_from_db</strong>:  Whether to refresh from database before deleting</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="AntiDuplicateMemory.get_memory_stats" class="classattr">
                                        <input id="AntiDuplicateMemory.get_memory_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_memory_stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="AntiDuplicateMemory.get_memory_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AntiDuplicateMemory.get_memory_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AntiDuplicateMemory.get_memory_stats-647"><a href="#AntiDuplicateMemory.get_memory_stats-647"><span class="linenos">647</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-648"><a href="#AntiDuplicateMemory.get_memory_stats-648"><span class="linenos">648</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-649"><a href="#AntiDuplicateMemory.get_memory_stats-649"><span class="linenos">649</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-650"><a href="#AntiDuplicateMemory.get_memory_stats-650"><span class="linenos">650</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-651"><a href="#AntiDuplicateMemory.get_memory_stats-651"><span class="linenos">651</span></a><span class="sd">        Get statistics about memory quality and duplicates.</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-652"><a href="#AntiDuplicateMemory.get_memory_stats-652"><span class="linenos">652</span></a>
</span><span id="AntiDuplicateMemory.get_memory_stats-653"><a href="#AntiDuplicateMemory.get_memory_stats-653"><span class="linenos">653</span></a><span class="sd">        :param user_id: User ID to analyze</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-654"><a href="#AntiDuplicateMemory.get_memory_stats-654"><span class="linenos">654</span></a><span class="sd">        :return: Dictionary with memory statistics</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-655"><a href="#AntiDuplicateMemory.get_memory_stats-655"><span class="linenos">655</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-656"><a href="#AntiDuplicateMemory.get_memory_stats-656"><span class="linenos">656</span></a>        <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-657"><a href="#AntiDuplicateMemory.get_memory_stats-657"><span class="linenos">657</span></a>
</span><span id="AntiDuplicateMemory.get_memory_stats-658"><a href="#AntiDuplicateMemory.get_memory_stats-658"><span class="linenos">658</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-659"><a href="#AntiDuplicateMemory.get_memory_stats-659"><span class="linenos">659</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total_memories&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-660"><a href="#AntiDuplicateMemory.get_memory_stats-660"><span class="linenos">660</span></a>
</span><span id="AntiDuplicateMemory.get_memory_stats-661"><a href="#AntiDuplicateMemory.get_memory_stats-661"><span class="linenos">661</span></a>        <span class="c1"># Analyze for potential issues</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-662"><a href="#AntiDuplicateMemory.get_memory_stats-662"><span class="linenos">662</span></a>        <span class="n">memory_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">memory</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">]</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-663"><a href="#AntiDuplicateMemory.get_memory_stats-663"><span class="linenos">663</span></a>        <span class="n">unique_texts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">memory_texts</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-664"><a href="#AntiDuplicateMemory.get_memory_stats-664"><span class="linenos">664</span></a>
</span><span id="AntiDuplicateMemory.get_memory_stats-665"><a href="#AntiDuplicateMemory.get_memory_stats-665"><span class="linenos">665</span></a>        <span class="c1"># Find potential duplicates</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-666"><a href="#AntiDuplicateMemory.get_memory_stats-666"><span class="linenos">666</span></a>        <span class="n">potential_duplicates</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-667"><a href="#AntiDuplicateMemory.get_memory_stats-667"><span class="linenos">667</span></a>        <span class="n">semantic_threshold</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-668"><a href="#AntiDuplicateMemory.get_memory_stats-668"><span class="linenos">668</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mem1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">memories</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-669"><a href="#AntiDuplicateMemory.get_memory_stats-669"><span class="linenos">669</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mem2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">memories</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-670"><a href="#AntiDuplicateMemory.get_memory_stats-670"><span class="linenos">670</span></a>                <span class="n">similarity</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-671"><a href="#AntiDuplicateMemory.get_memory_stats-671"><span class="linenos">671</span></a>                    <span class="kc">None</span><span class="p">,</span> <span class="n">mem1</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">mem2</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-672"><a href="#AntiDuplicateMemory.get_memory_stats-672"><span class="linenos">672</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-673"><a href="#AntiDuplicateMemory.get_memory_stats-673"><span class="linenos">673</span></a>                <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">semantic_threshold</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-674"><a href="#AntiDuplicateMemory.get_memory_stats-674"><span class="linenos">674</span></a>                    <span class="n">potential_duplicates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">similarity</span><span class="p">))</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-675"><a href="#AntiDuplicateMemory.get_memory_stats-675"><span class="linenos">675</span></a>
</span><span id="AntiDuplicateMemory.get_memory_stats-676"><a href="#AntiDuplicateMemory.get_memory_stats-676"><span class="linenos">676</span></a>        <span class="c1"># Find combined memories</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-677"><a href="#AntiDuplicateMemory.get_memory_stats-677"><span class="linenos">677</span></a>        <span class="n">combined_memories</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-678"><a href="#AntiDuplicateMemory.get_memory_stats-678"><span class="linenos">678</span></a>            <span class="n">i</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-679"><a href="#AntiDuplicateMemory.get_memory_stats-679"><span class="linenos">679</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-680"><a href="#AntiDuplicateMemory.get_memory_stats-680"><span class="linenos">680</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_multiple_facts</span><span class="p">(</span><span class="n">mem</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-681"><a href="#AntiDuplicateMemory.get_memory_stats-681"><span class="linenos">681</span></a>        <span class="p">]</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-682"><a href="#AntiDuplicateMemory.get_memory_stats-682"><span class="linenos">682</span></a>
</span><span id="AntiDuplicateMemory.get_memory_stats-683"><a href="#AntiDuplicateMemory.get_memory_stats-683"><span class="linenos">683</span></a>        <span class="c1"># Calculate average memory length</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-684"><a href="#AntiDuplicateMemory.get_memory_stats-684"><span class="linenos">684</span></a>        <span class="n">avg_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-685"><a href="#AntiDuplicateMemory.get_memory_stats-685"><span class="linenos">685</span></a>
</span><span id="AntiDuplicateMemory.get_memory_stats-686"><a href="#AntiDuplicateMemory.get_memory_stats-686"><span class="linenos">686</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-687"><a href="#AntiDuplicateMemory.get_memory_stats-687"><span class="linenos">687</span></a>            <span class="s2">&quot;total_memories&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">),</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-688"><a href="#AntiDuplicateMemory.get_memory_stats-688"><span class="linenos">688</span></a>            <span class="s2">&quot;unique_texts&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_texts</span><span class="p">),</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-689"><a href="#AntiDuplicateMemory.get_memory_stats-689"><span class="linenos">689</span></a>            <span class="s2">&quot;exact_duplicates&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory_texts</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_texts</span><span class="p">),</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-690"><a href="#AntiDuplicateMemory.get_memory_stats-690"><span class="linenos">690</span></a>            <span class="s2">&quot;potential_semantic_duplicates&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">potential_duplicates</span><span class="p">),</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-691"><a href="#AntiDuplicateMemory.get_memory_stats-691"><span class="linenos">691</span></a>            <span class="s2">&quot;combined_memories&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_memories</span><span class="p">),</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-692"><a href="#AntiDuplicateMemory.get_memory_stats-692"><span class="linenos">692</span></a>            <span class="s2">&quot;average_memory_length&quot;</span><span class="p">:</span> <span class="n">avg_length</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-693"><a href="#AntiDuplicateMemory.get_memory_stats-693"><span class="linenos">693</span></a>            <span class="s2">&quot;duplicate_pairs&quot;</span><span class="p">:</span> <span class="n">potential_duplicates</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-694"><a href="#AntiDuplicateMemory.get_memory_stats-694"><span class="linenos">694</span></a>            <span class="s2">&quot;combined_memory_indices&quot;</span><span class="p">:</span> <span class="n">combined_memories</span><span class="p">,</span>
</span><span id="AntiDuplicateMemory.get_memory_stats-695"><a href="#AntiDuplicateMemory.get_memory_stats-695"><span class="linenos">695</span></a>        <span class="p">}</span>
</span></pre></div>


    

                            </div>
                            <div id="AntiDuplicateMemory.print_memory_analysis" class="classattr">
                                        <input id="AntiDuplicateMemory.print_memory_analysis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">print_memory_analysis</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AntiDuplicateMemory.print_memory_analysis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AntiDuplicateMemory.print_memory_analysis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AntiDuplicateMemory.print_memory_analysis-697"><a href="#AntiDuplicateMemory.print_memory_analysis-697"><span class="linenos">697</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_memory_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-698"><a href="#AntiDuplicateMemory.print_memory_analysis-698"><span class="linenos">698</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-699"><a href="#AntiDuplicateMemory.print_memory_analysis-699"><span class="linenos">699</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-700"><a href="#AntiDuplicateMemory.print_memory_analysis-700"><span class="linenos">700</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-701"><a href="#AntiDuplicateMemory.print_memory_analysis-701"><span class="linenos">701</span></a><span class="sd">        Print a detailed analysis of memory quality.</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-702"><a href="#AntiDuplicateMemory.print_memory_analysis-702"><span class="linenos">702</span></a>
</span><span id="AntiDuplicateMemory.print_memory_analysis-703"><a href="#AntiDuplicateMemory.print_memory_analysis-703"><span class="linenos">703</span></a><span class="sd">        :param user_id: User ID to analyze</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-704"><a href="#AntiDuplicateMemory.print_memory_analysis-704"><span class="linenos">704</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-705"><a href="#AntiDuplicateMemory.print_memory_analysis-705"><span class="linenos">705</span></a>        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_memory_stats</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-706"><a href="#AntiDuplicateMemory.print_memory_analysis-706"><span class="linenos">706</span></a>        <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-707"><a href="#AntiDuplicateMemory.print_memory_analysis-707"><span class="linenos">707</span></a>
</span><span id="AntiDuplicateMemory.print_memory_analysis-708"><a href="#AntiDuplicateMemory.print_memory_analysis-708"><span class="linenos">708</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> MEMORY ANALYSIS FOR USER: </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-709"><a href="#AntiDuplicateMemory.print_memory_analysis-709"><span class="linenos">709</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-710"><a href="#AntiDuplicateMemory.print_memory_analysis-710"><span class="linenos">710</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total memories: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_memories&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-711"><a href="#AntiDuplicateMemory.print_memory_analysis-711"><span class="linenos">711</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unique texts: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;unique_texts&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-712"><a href="#AntiDuplicateMemory.print_memory_analysis-712"><span class="linenos">712</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exact duplicates: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;exact_duplicates&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-713"><a href="#AntiDuplicateMemory.print_memory_analysis-713"><span class="linenos">713</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-714"><a href="#AntiDuplicateMemory.print_memory_analysis-714"><span class="linenos">714</span></a>            <span class="sa">f</span><span class="s2">&quot;Potential semantic duplicates: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;potential_semantic_duplicates&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-715"><a href="#AntiDuplicateMemory.print_memory_analysis-715"><span class="linenos">715</span></a>        <span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-716"><a href="#AntiDuplicateMemory.print_memory_analysis-716"><span class="linenos">716</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined memories: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;combined_memories&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-717"><a href="#AntiDuplicateMemory.print_memory_analysis-717"><span class="linenos">717</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average memory length: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;average_memory_length&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> chars&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-718"><a href="#AntiDuplicateMemory.print_memory_analysis-718"><span class="linenos">718</span></a>
</span><span id="AntiDuplicateMemory.print_memory_analysis-719"><a href="#AntiDuplicateMemory.print_memory_analysis-719"><span class="linenos">719</span></a>        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;exact_duplicates&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-720"><a href="#AntiDuplicateMemory.print_memory_analysis-720"><span class="linenos">720</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  EXACT DUPLICATES DETECTED!&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-721"><a href="#AntiDuplicateMemory.print_memory_analysis-721"><span class="linenos">721</span></a>
</span><span id="AntiDuplicateMemory.print_memory_analysis-722"><a href="#AntiDuplicateMemory.print_memory_analysis-722"><span class="linenos">722</span></a>        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;potential_semantic_duplicates&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-723"><a href="#AntiDuplicateMemory.print_memory_analysis-723"><span class="linenos">723</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> POTENTIAL SEMANTIC DUPLICATES:&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-724"><a href="#AntiDuplicateMemory.print_memory_analysis-724"><span class="linenos">724</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">similarity</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;duplicate_pairs&quot;</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-725"><a href="#AntiDuplicateMemory.print_memory_analysis-725"><span class="linenos">725</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">similarity</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> similarity:&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-726"><a href="#AntiDuplicateMemory.print_memory_analysis-726"><span class="linenos">726</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    [</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">memories</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-727"><a href="#AntiDuplicateMemory.print_memory_analysis-727"><span class="linenos">727</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    [</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">memories</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-728"><a href="#AntiDuplicateMemory.print_memory_analysis-728"><span class="linenos">728</span></a>
</span><span id="AntiDuplicateMemory.print_memory_analysis-729"><a href="#AntiDuplicateMemory.print_memory_analysis-729"><span class="linenos">729</span></a>        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;combined_memories&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-730"><a href="#AntiDuplicateMemory.print_memory_analysis-730"><span class="linenos">730</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> COMBINED MEMORIES:&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-731"><a href="#AntiDuplicateMemory.print_memory_analysis-731"><span class="linenos">731</span></a>            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;combined_memory_indices&quot;</span><span class="p">]:</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-732"><a href="#AntiDuplicateMemory.print_memory_analysis-732"><span class="linenos">732</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Memory: &#39;</span><span class="si">{</span><span class="n">memories</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-733"><a href="#AntiDuplicateMemory.print_memory_analysis-733"><span class="linenos">733</span></a>
</span><span id="AntiDuplicateMemory.print_memory_analysis-734"><a href="#AntiDuplicateMemory.print_memory_analysis-734"><span class="linenos">734</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-735"><a href="#AntiDuplicateMemory.print_memory_analysis-735"><span class="linenos">735</span></a>            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;exact_duplicates&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-736"><a href="#AntiDuplicateMemory.print_memory_analysis-736"><span class="linenos">736</span></a>            <span class="ow">and</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;potential_semantic_duplicates&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-737"><a href="#AntiDuplicateMemory.print_memory_analysis-737"><span class="linenos">737</span></a>            <span class="ow">and</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;combined_memories&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-738"><a href="#AntiDuplicateMemory.print_memory_analysis-738"><span class="linenos">738</span></a>        <span class="p">):</span>
</span><span id="AntiDuplicateMemory.print_memory_analysis-739"><a href="#AntiDuplicateMemory.print_memory_analysis-739"><span class="linenos">739</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> EXCELLENT: No duplicates or combined memories detected!&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="create_anti_duplicate_memory">
                            <input id="create_anti_duplicate_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_anti_duplicate_memory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">db</span>,</span><span class="param">	<span class="n">model</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>,</span><span class="param">	<span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n"><a href="#AntiDuplicateMemory">AntiDuplicateMemory</a></span>:</span></span>

                <label class="view-source-button" for="create_anti_duplicate_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_anti_duplicate_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_anti_duplicate_memory-743"><a href="#create_anti_duplicate_memory-743"><span class="linenos">743</span></a><span class="k">def</span><span class="w"> </span><span class="nf">create_anti_duplicate_memory</span><span class="p">(</span>
</span><span id="create_anti_duplicate_memory-744"><a href="#create_anti_duplicate_memory-744"><span class="linenos">744</span></a>    <span class="n">db</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="create_anti_duplicate_memory-745"><a href="#create_anti_duplicate_memory-745"><span class="linenos">745</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AntiDuplicateMemory</span><span class="p">:</span>
</span><span id="create_anti_duplicate_memory-746"><a href="#create_anti_duplicate_memory-746"><span class="linenos">746</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="create_anti_duplicate_memory-747"><a href="#create_anti_duplicate_memory-747"><span class="linenos">747</span></a><span class="sd">    Create an AntiDuplicateMemory instance with sensible defaults.</span>
</span><span id="create_anti_duplicate_memory-748"><a href="#create_anti_duplicate_memory-748"><span class="linenos">748</span></a>
</span><span id="create_anti_duplicate_memory-749"><a href="#create_anti_duplicate_memory-749"><span class="linenos">749</span></a><span class="sd">    :param db: Memory database instance</span>
</span><span id="create_anti_duplicate_memory-750"><a href="#create_anti_duplicate_memory-750"><span class="linenos">750</span></a><span class="sd">    :param model: Model for memory operations</span>
</span><span id="create_anti_duplicate_memory-751"><a href="#create_anti_duplicate_memory-751"><span class="linenos">751</span></a><span class="sd">    :param similarity_threshold: Threshold for semantic similarity</span>
</span><span id="create_anti_duplicate_memory-752"><a href="#create_anti_duplicate_memory-752"><span class="linenos">752</span></a><span class="sd">    :param debug_mode: Enable debug output</span>
</span><span id="create_anti_duplicate_memory-753"><a href="#create_anti_duplicate_memory-753"><span class="linenos">753</span></a><span class="sd">    :return: Configured AntiDuplicateMemory instance</span>
</span><span id="create_anti_duplicate_memory-754"><a href="#create_anti_duplicate_memory-754"><span class="linenos">754</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="create_anti_duplicate_memory-755"><a href="#create_anti_duplicate_memory-755"><span class="linenos">755</span></a>    <span class="k">return</span> <span class="n">AntiDuplicateMemory</span><span class="p">(</span>
</span><span id="create_anti_duplicate_memory-756"><a href="#create_anti_duplicate_memory-756"><span class="linenos">756</span></a>        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="create_anti_duplicate_memory-757"><a href="#create_anti_duplicate_memory-757"><span class="linenos">757</span></a>        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span><span id="create_anti_duplicate_memory-758"><a href="#create_anti_duplicate_memory-758"><span class="linenos">758</span></a>        <span class="n">similarity_threshold</span><span class="o">=</span><span class="n">similarity_threshold</span><span class="p">,</span>
</span><span id="create_anti_duplicate_memory-759"><a href="#create_anti_duplicate_memory-759"><span class="linenos">759</span></a>        <span class="n">enable_semantic_dedup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="create_anti_duplicate_memory-760"><a href="#create_anti_duplicate_memory-760"><span class="linenos">760</span></a>        <span class="n">enable_exact_dedup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="create_anti_duplicate_memory-761"><a href="#create_anti_duplicate_memory-761"><span class="linenos">761</span></a>        <span class="n">debug_mode</span><span class="o">=</span><span class="n">debug_mode</span><span class="p">,</span>
</span><span id="create_anti_duplicate_memory-762"><a href="#create_anti_duplicate_memory-762"><span class="linenos">762</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create an AntiDuplicateMemory instance with sensible defaults.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>model</strong>:  Model for memory operations</li>
<li><strong>similarity_threshold</strong>:  Threshold for semantic similarity</li>
<li><strong>debug_mode</strong>:  Enable debug output</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Configured AntiDuplicateMemory instance</p>
</blockquote>
</div>


                </section>
                <section id="SemanticMemoryManager">
                            <input id="SemanticMemoryManager-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">SemanticMemoryManager</span>:

                <label class="view-source-button" for="SemanticMemoryManager-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager-299"><a href="#SemanticMemoryManager-299"><span class="linenos"> 299</span></a><span class="nd">@dataclass</span>
</span><span id="SemanticMemoryManager-300"><a href="#SemanticMemoryManager-300"><span class="linenos"> 300</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SemanticMemoryManager</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-301"><a href="#SemanticMemoryManager-301"><span class="linenos"> 301</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-302"><a href="#SemanticMemoryManager-302"><span class="linenos"> 302</span></a><span class="sd">    Semantic Memory Manager that provides LLM-free memory management.</span>
</span><span id="SemanticMemoryManager-303"><a href="#SemanticMemoryManager-303"><span class="linenos"> 303</span></a>
</span><span id="SemanticMemoryManager-304"><a href="#SemanticMemoryManager-304"><span class="linenos"> 304</span></a><span class="sd">    This manager combines the structure of Agno&#39;s MemoryManager with semantic search</span>
</span><span id="SemanticMemoryManager-305"><a href="#SemanticMemoryManager-305"><span class="linenos"> 305</span></a><span class="sd">    and duplicate detection capabilities, without requiring LLM invocation.</span>
</span><span id="SemanticMemoryManager-306"><a href="#SemanticMemoryManager-306"><span class="linenos"> 306</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-307"><a href="#SemanticMemoryManager-307"><span class="linenos"> 307</span></a>
</span><span id="SemanticMemoryManager-308"><a href="#SemanticMemoryManager-308"><span class="linenos"> 308</span></a>    <span class="c1"># Required by Agno Memory class - model attribute</span>
</span><span id="SemanticMemoryManager-309"><a href="#SemanticMemoryManager-309"><span class="linenos"> 309</span></a>    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-310"><a href="#SemanticMemoryManager-310"><span class="linenos"> 310</span></a>
</span><span id="SemanticMemoryManager-311"><a href="#SemanticMemoryManager-311"><span class="linenos"> 311</span></a>    <span class="c1"># Configuration</span>
</span><span id="SemanticMemoryManager-312"><a href="#SemanticMemoryManager-312"><span class="linenos"> 312</span></a>    <span class="n">config</span><span class="p">:</span> <span class="n">SemanticMemoryManagerConfig</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-313"><a href="#SemanticMemoryManager-313"><span class="linenos"> 313</span></a>        <span class="n">default_factory</span><span class="o">=</span><span class="n">SemanticMemoryManagerConfig</span>
</span><span id="SemanticMemoryManager-314"><a href="#SemanticMemoryManager-314"><span class="linenos"> 314</span></a>    <span class="p">)</span>
</span><span id="SemanticMemoryManager-315"><a href="#SemanticMemoryManager-315"><span class="linenos"> 315</span></a>
</span><span id="SemanticMemoryManager-316"><a href="#SemanticMemoryManager-316"><span class="linenos"> 316</span></a>    <span class="c1"># Components</span>
</span><span id="SemanticMemoryManager-317"><a href="#SemanticMemoryManager-317"><span class="linenos"> 317</span></a>    <span class="n">topic_classifier</span><span class="p">:</span> <span class="n">TopicClassifier</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">TopicClassifier</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-318"><a href="#SemanticMemoryManager-318"><span class="linenos"> 318</span></a>    <span class="n">duplicate_detector</span><span class="p">:</span> <span class="n">SemanticDuplicateDetector</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-319"><a href="#SemanticMemoryManager-319"><span class="linenos"> 319</span></a>
</span><span id="SemanticMemoryManager-320"><a href="#SemanticMemoryManager-320"><span class="linenos"> 320</span></a>    <span class="c1"># State tracking</span>
</span><span id="SemanticMemoryManager-321"><a href="#SemanticMemoryManager-321"><span class="linenos"> 321</span></a>    <span class="n">memories_updated</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-322"><a href="#SemanticMemoryManager-322"><span class="linenos"> 322</span></a>
</span><span id="SemanticMemoryManager-323"><a href="#SemanticMemoryManager-323"><span class="linenos"> 323</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-324"><a href="#SemanticMemoryManager-324"><span class="linenos"> 324</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-325"><a href="#SemanticMemoryManager-325"><span class="linenos"> 325</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-326"><a href="#SemanticMemoryManager-326"><span class="linenos"> 326</span></a>        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SemanticMemoryManagerConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-327"><a href="#SemanticMemoryManager-327"><span class="linenos"> 327</span></a>        <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-328"><a href="#SemanticMemoryManager-328"><span class="linenos"> 328</span></a>        <span class="n">enable_semantic_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-329"><a href="#SemanticMemoryManager-329"><span class="linenos"> 329</span></a>        <span class="n">enable_exact_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-330"><a href="#SemanticMemoryManager-330"><span class="linenos"> 330</span></a>        <span class="n">enable_topic_classification</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-331"><a href="#SemanticMemoryManager-331"><span class="linenos"> 331</span></a>        <span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-332"><a href="#SemanticMemoryManager-332"><span class="linenos"> 332</span></a>    <span class="p">):</span>
</span><span id="SemanticMemoryManager-333"><a href="#SemanticMemoryManager-333"><span class="linenos"> 333</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Semantic Memory Manager.&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-334"><a href="#SemanticMemoryManager-334"><span class="linenos"> 334</span></a>        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-335"><a href="#SemanticMemoryManager-335"><span class="linenos"> 335</span></a>            <span class="n">config</span> <span class="o">=</span> <span class="n">SemanticMemoryManagerConfig</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-336"><a href="#SemanticMemoryManager-336"><span class="linenos"> 336</span></a>                <span class="n">similarity_threshold</span><span class="o">=</span><span class="n">similarity_threshold</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-337"><a href="#SemanticMemoryManager-337"><span class="linenos"> 337</span></a>                <span class="n">enable_semantic_dedup</span><span class="o">=</span><span class="n">enable_semantic_dedup</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-338"><a href="#SemanticMemoryManager-338"><span class="linenos"> 338</span></a>                <span class="n">enable_exact_dedup</span><span class="o">=</span><span class="n">enable_exact_dedup</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-339"><a href="#SemanticMemoryManager-339"><span class="linenos"> 339</span></a>                <span class="n">enable_topic_classification</span><span class="o">=</span><span class="n">enable_topic_classification</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-340"><a href="#SemanticMemoryManager-340"><span class="linenos"> 340</span></a>                <span class="n">debug_mode</span><span class="o">=</span><span class="n">debug_mode</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-341"><a href="#SemanticMemoryManager-341"><span class="linenos"> 341</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-342"><a href="#SemanticMemoryManager-342"><span class="linenos"> 342</span></a>
</span><span id="SemanticMemoryManager-343"><a href="#SemanticMemoryManager-343"><span class="linenos"> 343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>  <span class="c1"># Required by Agno Memory class</span>
</span><span id="SemanticMemoryManager-344"><a href="#SemanticMemoryManager-344"><span class="linenos"> 344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="SemanticMemoryManager-345"><a href="#SemanticMemoryManager-345"><span class="linenos"> 345</span></a>
</span><span id="SemanticMemoryManager-346"><a href="#SemanticMemoryManager-346"><span class="linenos"> 346</span></a>        <span class="c1"># Get the correct path to topics.yaml</span>
</span><span id="SemanticMemoryManager-347"><a href="#SemanticMemoryManager-347"><span class="linenos"> 347</span></a>        <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="SemanticMemoryManager-348"><a href="#SemanticMemoryManager-348"><span class="linenos"> 348</span></a>        <span class="n">topics_yaml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s2">&quot;topics.yaml&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-349"><a href="#SemanticMemoryManager-349"><span class="linenos"> 349</span></a>
</span><span id="SemanticMemoryManager-350"><a href="#SemanticMemoryManager-350"><span class="linenos"> 350</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">topic_classifier</span> <span class="o">=</span> <span class="n">TopicClassifier</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="n">topics_yaml_path</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-351"><a href="#SemanticMemoryManager-351"><span class="linenos"> 351</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_detector</span> <span class="o">=</span> <span class="n">SemanticDuplicateDetector</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-352"><a href="#SemanticMemoryManager-352"><span class="linenos"> 352</span></a>            <span class="n">similarity_threshold</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">similarity_threshold</span>
</span><span id="SemanticMemoryManager-353"><a href="#SemanticMemoryManager-353"><span class="linenos"> 353</span></a>        <span class="p">)</span>
</span><span id="SemanticMemoryManager-354"><a href="#SemanticMemoryManager-354"><span class="linenos"> 354</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SemanticMemoryManager-355"><a href="#SemanticMemoryManager-355"><span class="linenos"> 355</span></a>
</span><span id="SemanticMemoryManager-356"><a href="#SemanticMemoryManager-356"><span class="linenos"> 356</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-357"><a href="#SemanticMemoryManager-357"><span class="linenos"> 357</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-358"><a href="#SemanticMemoryManager-358"><span class="linenos"> 358</span></a>
</span><span id="SemanticMemoryManager-359"><a href="#SemanticMemoryManager-359"><span class="linenos"> 359</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-360"><a href="#SemanticMemoryManager-360"><span class="linenos"> 360</span></a>            <span class="s2">&quot;Initialized SemanticMemoryManager with similarity_threshold=</span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-361"><a href="#SemanticMemoryManager-361"><span class="linenos"> 361</span></a>            <span class="n">config</span><span class="o">.</span><span class="n">similarity_threshold</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-362"><a href="#SemanticMemoryManager-362"><span class="linenos"> 362</span></a>        <span class="p">)</span>
</span><span id="SemanticMemoryManager-363"><a href="#SemanticMemoryManager-363"><span class="linenos"> 363</span></a>
</span><span id="SemanticMemoryManager-364"><a href="#SemanticMemoryManager-364"><span class="linenos"> 364</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_exact_duplicate</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-365"><a href="#SemanticMemoryManager-365"><span class="linenos"> 365</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">new_memory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]</span>
</span><span id="SemanticMemoryManager-366"><a href="#SemanticMemoryManager-366"><span class="linenos"> 366</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-367"><a href="#SemanticMemoryManager-367"><span class="linenos"> 367</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for exact duplicate memories.&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-368"><a href="#SemanticMemoryManager-368"><span class="linenos"> 368</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_exact_dedup</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-369"><a href="#SemanticMemoryManager-369"><span class="linenos"> 369</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="SemanticMemoryManager-370"><a href="#SemanticMemoryManager-370"><span class="linenos"> 370</span></a>
</span><span id="SemanticMemoryManager-371"><a href="#SemanticMemoryManager-371"><span class="linenos"> 371</span></a>        <span class="n">new_memory_clean</span> <span class="o">=</span> <span class="n">new_memory</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-372"><a href="#SemanticMemoryManager-372"><span class="linenos"> 372</span></a>
</span><span id="SemanticMemoryManager-373"><a href="#SemanticMemoryManager-373"><span class="linenos"> 373</span></a>        <span class="k">for</span> <span class="n">existing</span> <span class="ow">in</span> <span class="n">existing_memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-374"><a href="#SemanticMemoryManager-374"><span class="linenos"> 374</span></a>            <span class="n">existing_clean</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-375"><a href="#SemanticMemoryManager-375"><span class="linenos"> 375</span></a>            <span class="k">if</span> <span class="n">new_memory_clean</span> <span class="o">==</span> <span class="n">existing_clean</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-376"><a href="#SemanticMemoryManager-376"><span class="linenos"> 376</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exact duplicate found: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">new_memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-377"><a href="#SemanticMemoryManager-377"><span class="linenos"> 377</span></a>                <span class="k">return</span> <span class="n">existing</span>
</span><span id="SemanticMemoryManager-378"><a href="#SemanticMemoryManager-378"><span class="linenos"> 378</span></a>
</span><span id="SemanticMemoryManager-379"><a href="#SemanticMemoryManager-379"><span class="linenos"> 379</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="SemanticMemoryManager-380"><a href="#SemanticMemoryManager-380"><span class="linenos"> 380</span></a>
</span><span id="SemanticMemoryManager-381"><a href="#SemanticMemoryManager-381"><span class="linenos"> 381</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_semantic_duplicate</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-382"><a href="#SemanticMemoryManager-382"><span class="linenos"> 382</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">new_memory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]</span>
</span><span id="SemanticMemoryManager-383"><a href="#SemanticMemoryManager-383"><span class="linenos"> 383</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-384"><a href="#SemanticMemoryManager-384"><span class="linenos"> 384</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for semantic duplicate memories.&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-385"><a href="#SemanticMemoryManager-385"><span class="linenos"> 385</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_semantic_dedup</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-386"><a href="#SemanticMemoryManager-386"><span class="linenos"> 386</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="SemanticMemoryManager-387"><a href="#SemanticMemoryManager-387"><span class="linenos"> 387</span></a>
</span><span id="SemanticMemoryManager-388"><a href="#SemanticMemoryManager-388"><span class="linenos"> 388</span></a>        <span class="n">existing_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">mem</span><span class="o">.</span><span class="n">memory</span> <span class="k">for</span> <span class="n">mem</span> <span class="ow">in</span> <span class="n">existing_memories</span><span class="p">]</span>
</span><span id="SemanticMemoryManager-389"><a href="#SemanticMemoryManager-389"><span class="linenos"> 389</span></a>        <span class="n">is_dup</span><span class="p">,</span> <span class="n">best_match</span><span class="p">,</span> <span class="n">similarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_detector</span><span class="o">.</span><span class="n">is_duplicate</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-390"><a href="#SemanticMemoryManager-390"><span class="linenos"> 390</span></a>            <span class="n">new_memory</span><span class="p">,</span> <span class="n">existing_texts</span>
</span><span id="SemanticMemoryManager-391"><a href="#SemanticMemoryManager-391"><span class="linenos"> 391</span></a>        <span class="p">)</span>
</span><span id="SemanticMemoryManager-392"><a href="#SemanticMemoryManager-392"><span class="linenos"> 392</span></a>
</span><span id="SemanticMemoryManager-393"><a href="#SemanticMemoryManager-393"><span class="linenos"> 393</span></a>        <span class="k">if</span> <span class="n">is_dup</span> <span class="ow">and</span> <span class="n">best_match</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-394"><a href="#SemanticMemoryManager-394"><span class="linenos"> 394</span></a>            <span class="c1"># Find the matching memory object</span>
</span><span id="SemanticMemoryManager-395"><a href="#SemanticMemoryManager-395"><span class="linenos"> 395</span></a>            <span class="k">for</span> <span class="n">existing</span> <span class="ow">in</span> <span class="n">existing_memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-396"><a href="#SemanticMemoryManager-396"><span class="linenos"> 396</span></a>                <span class="k">if</span> <span class="n">existing</span><span class="o">.</span><span class="n">memory</span> <span class="o">==</span> <span class="n">best_match</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-397"><a href="#SemanticMemoryManager-397"><span class="linenos"> 397</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-398"><a href="#SemanticMemoryManager-398"><span class="linenos"> 398</span></a>                        <span class="s2">&quot;Semantic duplicate found (similarity: </span><span class="si">%.2f</span><span class="s2">): &#39;</span><span class="si">%s</span><span class="s2">&#39; ~ &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-399"><a href="#SemanticMemoryManager-399"><span class="linenos"> 399</span></a>                        <span class="n">similarity</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-400"><a href="#SemanticMemoryManager-400"><span class="linenos"> 400</span></a>                        <span class="n">new_memory</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-401"><a href="#SemanticMemoryManager-401"><span class="linenos"> 401</span></a>                        <span class="n">existing</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-402"><a href="#SemanticMemoryManager-402"><span class="linenos"> 402</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager-403"><a href="#SemanticMemoryManager-403"><span class="linenos"> 403</span></a>                    <span class="k">return</span> <span class="n">existing</span>
</span><span id="SemanticMemoryManager-404"><a href="#SemanticMemoryManager-404"><span class="linenos"> 404</span></a>
</span><span id="SemanticMemoryManager-405"><a href="#SemanticMemoryManager-405"><span class="linenos"> 405</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="SemanticMemoryManager-406"><a href="#SemanticMemoryManager-406"><span class="linenos"> 406</span></a>
</span><span id="SemanticMemoryManager-407"><a href="#SemanticMemoryManager-407"><span class="linenos"> 407</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_should_reject_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-408"><a href="#SemanticMemoryManager-408"><span class="linenos"> 408</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">new_memory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]</span>
</span><span id="SemanticMemoryManager-409"><a href="#SemanticMemoryManager-409"><span class="linenos"> 409</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-410"><a href="#SemanticMemoryManager-410"><span class="linenos"> 410</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if a memory should be rejected.&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-411"><a href="#SemanticMemoryManager-411"><span class="linenos"> 411</span></a>        <span class="c1"># Check memory length</span>
</span><span id="SemanticMemoryManager-412"><a href="#SemanticMemoryManager-412"><span class="linenos"> 412</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_memory</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_memory_length</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-413"><a href="#SemanticMemoryManager-413"><span class="linenos"> 413</span></a>            <span class="k">return</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager-414"><a href="#SemanticMemoryManager-414"><span class="linenos"> 414</span></a>                <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-415"><a href="#SemanticMemoryManager-415"><span class="linenos"> 415</span></a>                <span class="sa">f</span><span class="s2">&quot;Memory too long (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_memory</span><span class="p">)</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_memory_length</span><span class="si">}</span><span class="s2"> chars)&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-416"><a href="#SemanticMemoryManager-416"><span class="linenos"> 416</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-417"><a href="#SemanticMemoryManager-417"><span class="linenos"> 417</span></a>
</span><span id="SemanticMemoryManager-418"><a href="#SemanticMemoryManager-418"><span class="linenos"> 418</span></a>        <span class="c1"># Check for exact duplicates</span>
</span><span id="SemanticMemoryManager-419"><a href="#SemanticMemoryManager-419"><span class="linenos"> 419</span></a>        <span class="n">exact_duplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_exact_duplicate</span><span class="p">(</span><span class="n">new_memory</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-420"><a href="#SemanticMemoryManager-420"><span class="linenos"> 420</span></a>        <span class="k">if</span> <span class="n">exact_duplicate</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-421"><a href="#SemanticMemoryManager-421"><span class="linenos"> 421</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Exact duplicate of: &#39;</span><span class="si">{</span><span class="n">exact_duplicate</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span id="SemanticMemoryManager-422"><a href="#SemanticMemoryManager-422"><span class="linenos"> 422</span></a>
</span><span id="SemanticMemoryManager-423"><a href="#SemanticMemoryManager-423"><span class="linenos"> 423</span></a>        <span class="c1"># Check for semantic duplicates</span>
</span><span id="SemanticMemoryManager-424"><a href="#SemanticMemoryManager-424"><span class="linenos"> 424</span></a>        <span class="n">semantic_duplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_semantic_duplicate</span><span class="p">(</span><span class="n">new_memory</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-425"><a href="#SemanticMemoryManager-425"><span class="linenos"> 425</span></a>        <span class="k">if</span> <span class="n">semantic_duplicate</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-426"><a href="#SemanticMemoryManager-426"><span class="linenos"> 426</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Semantic duplicate of: &#39;</span><span class="si">{</span><span class="n">semantic_duplicate</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span id="SemanticMemoryManager-427"><a href="#SemanticMemoryManager-427"><span class="linenos"> 427</span></a>
</span><span id="SemanticMemoryManager-428"><a href="#SemanticMemoryManager-428"><span class="linenos"> 428</span></a>        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
</span><span id="SemanticMemoryManager-429"><a href="#SemanticMemoryManager-429"><span class="linenos"> 429</span></a>
</span><span id="SemanticMemoryManager-430"><a href="#SemanticMemoryManager-430"><span class="linenos"> 430</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_recent_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-431"><a href="#SemanticMemoryManager-431"><span class="linenos"> 431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get recent memories for duplicate checking.&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-432"><a href="#SemanticMemoryManager-432"><span class="linenos"> 432</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-433"><a href="#SemanticMemoryManager-433"><span class="linenos"> 433</span></a>            <span class="n">memory_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_memories</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-434"><a href="#SemanticMemoryManager-434"><span class="linenos"> 434</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">recent_memory_limit</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span>
</span><span id="SemanticMemoryManager-435"><a href="#SemanticMemoryManager-435"><span class="linenos"> 435</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-436"><a href="#SemanticMemoryManager-436"><span class="linenos"> 436</span></a>
</span><span id="SemanticMemoryManager-437"><a href="#SemanticMemoryManager-437"><span class="linenos"> 437</span></a>            <span class="n">user_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-438"><a href="#SemanticMemoryManager-438"><span class="linenos"> 438</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">memory_rows</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-439"><a href="#SemanticMemoryManager-439"><span class="linenos"> 439</span></a>                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-440"><a href="#SemanticMemoryManager-440"><span class="linenos"> 440</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-441"><a href="#SemanticMemoryManager-441"><span class="linenos"> 441</span></a>                        <span class="n">user_memory</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-442"><a href="#SemanticMemoryManager-442"><span class="linenos"> 442</span></a>                        <span class="n">user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-443"><a href="#SemanticMemoryManager-443"><span class="linenos"> 443</span></a>                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-444"><a href="#SemanticMemoryManager-444"><span class="linenos"> 444</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-445"><a href="#SemanticMemoryManager-445"><span class="linenos"> 445</span></a>                            <span class="s2">&quot;Failed to convert memory row to UserMemory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span>
</span><span id="SemanticMemoryManager-446"><a href="#SemanticMemoryManager-446"><span class="linenos"> 446</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager-447"><a href="#SemanticMemoryManager-447"><span class="linenos"> 447</span></a>
</span><span id="SemanticMemoryManager-448"><a href="#SemanticMemoryManager-448"><span class="linenos"> 448</span></a>            <span class="k">return</span> <span class="n">user_memories</span>
</span><span id="SemanticMemoryManager-449"><a href="#SemanticMemoryManager-449"><span class="linenos"> 449</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-450"><a href="#SemanticMemoryManager-450"><span class="linenos"> 450</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error retrieving recent memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-451"><a href="#SemanticMemoryManager-451"><span class="linenos"> 451</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-452"><a href="#SemanticMemoryManager-452"><span class="linenos"> 452</span></a>
</span><span id="SemanticMemoryManager-453"><a href="#SemanticMemoryManager-453"><span class="linenos"> 453</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-454"><a href="#SemanticMemoryManager-454"><span class="linenos"> 454</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-455"><a href="#SemanticMemoryManager-455"><span class="linenos"> 455</span></a>        <span class="n">memory_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-456"><a href="#SemanticMemoryManager-456"><span class="linenos"> 456</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-457"><a href="#SemanticMemoryManager-457"><span class="linenos"> 457</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-458"><a href="#SemanticMemoryManager-458"><span class="linenos"> 458</span></a>        <span class="n">topics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-459"><a href="#SemanticMemoryManager-459"><span class="linenos"> 459</span></a>        <span class="n">input_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-460"><a href="#SemanticMemoryManager-460"><span class="linenos"> 460</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MemoryStorageResult</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-461"><a href="#SemanticMemoryManager-461"><span class="linenos"> 461</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-462"><a href="#SemanticMemoryManager-462"><span class="linenos"> 462</span></a><span class="sd">        Add a memory with duplicate detection and topic classification.</span>
</span><span id="SemanticMemoryManager-463"><a href="#SemanticMemoryManager-463"><span class="linenos"> 463</span></a>
</span><span id="SemanticMemoryManager-464"><a href="#SemanticMemoryManager-464"><span class="linenos"> 464</span></a><span class="sd">        :param memory_text: The memory text to add</span>
</span><span id="SemanticMemoryManager-465"><a href="#SemanticMemoryManager-465"><span class="linenos"> 465</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager-466"><a href="#SemanticMemoryManager-466"><span class="linenos"> 466</span></a><span class="sd">        :param user_id: User ID for the memory</span>
</span><span id="SemanticMemoryManager-467"><a href="#SemanticMemoryManager-467"><span class="linenos"> 467</span></a><span class="sd">        :param topics: Optional list of topics (will be auto-classified if not provided)</span>
</span><span id="SemanticMemoryManager-468"><a href="#SemanticMemoryManager-468"><span class="linenos"> 468</span></a><span class="sd">        :param input_text: Optional input text that generated this memory</span>
</span><span id="SemanticMemoryManager-469"><a href="#SemanticMemoryManager-469"><span class="linenos"> 469</span></a><span class="sd">        :return: MemoryStorageResult with detailed status information</span>
</span><span id="SemanticMemoryManager-470"><a href="#SemanticMemoryManager-470"><span class="linenos"> 470</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-471"><a href="#SemanticMemoryManager-471"><span class="linenos"> 471</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager-472"><a href="#SemanticMemoryManager-472"><span class="linenos"> 472</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-473"><a href="#SemanticMemoryManager-473"><span class="linenos"> 473</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-474"><a href="#SemanticMemoryManager-474"><span class="linenos"> 474</span></a>            
</span><span id="SemanticMemoryManager-475"><a href="#SemanticMemoryManager-475"><span class="linenos"> 475</span></a>        <span class="c1"># Validate input</span>
</span><span id="SemanticMemoryManager-476"><a href="#SemanticMemoryManager-476"><span class="linenos"> 476</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">memory_text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">memory_text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="SemanticMemoryManager-477"><a href="#SemanticMemoryManager-477"><span class="linenos"> 477</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-478"><a href="#SemanticMemoryManager-478"><span class="linenos"> 478</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">CONTENT_EMPTY</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-479"><a href="#SemanticMemoryManager-479"><span class="linenos"> 479</span></a>                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Memory content cannot be empty&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-480"><a href="#SemanticMemoryManager-480"><span class="linenos"> 480</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-481"><a href="#SemanticMemoryManager-481"><span class="linenos"> 481</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SemanticMemoryManager-482"><a href="#SemanticMemoryManager-482"><span class="linenos"> 482</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-483"><a href="#SemanticMemoryManager-483"><span class="linenos"> 483</span></a>
</span><span id="SemanticMemoryManager-484"><a href="#SemanticMemoryManager-484"><span class="linenos"> 484</span></a>        <span class="c1"># Get recent memories for duplicate checking</span>
</span><span id="SemanticMemoryManager-485"><a href="#SemanticMemoryManager-485"><span class="linenos"> 485</span></a>        <span class="n">existing_memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_recent_memories</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-486"><a href="#SemanticMemoryManager-486"><span class="linenos"> 486</span></a>
</span><span id="SemanticMemoryManager-487"><a href="#SemanticMemoryManager-487"><span class="linenos"> 487</span></a>        <span class="c1"># Check memory length</span>
</span><span id="SemanticMemoryManager-488"><a href="#SemanticMemoryManager-488"><span class="linenos"> 488</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_memory_length</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-489"><a href="#SemanticMemoryManager-489"><span class="linenos"> 489</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-490"><a href="#SemanticMemoryManager-490"><span class="linenos"> 490</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">CONTENT_TOO_LONG</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-491"><a href="#SemanticMemoryManager-491"><span class="linenos"> 491</span></a>                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Memory too long (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memory_text</span><span class="p">)</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_memory_length</span><span class="si">}</span><span class="s2"> chars)&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-492"><a href="#SemanticMemoryManager-492"><span class="linenos"> 492</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-493"><a href="#SemanticMemoryManager-493"><span class="linenos"> 493</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SemanticMemoryManager-494"><a href="#SemanticMemoryManager-494"><span class="linenos"> 494</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-495"><a href="#SemanticMemoryManager-495"><span class="linenos"> 495</span></a>
</span><span id="SemanticMemoryManager-496"><a href="#SemanticMemoryManager-496"><span class="linenos"> 496</span></a>        <span class="c1"># Check for exact duplicates</span>
</span><span id="SemanticMemoryManager-497"><a href="#SemanticMemoryManager-497"><span class="linenos"> 497</span></a>        <span class="n">exact_duplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_exact_duplicate</span><span class="p">(</span><span class="n">memory_text</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-498"><a href="#SemanticMemoryManager-498"><span class="linenos"> 498</span></a>        <span class="k">if</span> <span class="n">exact_duplicate</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-499"><a href="#SemanticMemoryManager-499"><span class="linenos"> 499</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-500"><a href="#SemanticMemoryManager-500"><span class="linenos"> 500</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">DUPLICATE_EXACT</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-501"><a href="#SemanticMemoryManager-501"><span class="linenos"> 501</span></a>                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Exact duplicate of: &#39;</span><span class="si">{</span><span class="n">exact_duplicate</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-502"><a href="#SemanticMemoryManager-502"><span class="linenos"> 502</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-503"><a href="#SemanticMemoryManager-503"><span class="linenos"> 503</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-504"><a href="#SemanticMemoryManager-504"><span class="linenos"> 504</span></a>                <span class="n">similarity_score</span><span class="o">=</span><span class="mf">1.0</span>
</span><span id="SemanticMemoryManager-505"><a href="#SemanticMemoryManager-505"><span class="linenos"> 505</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-506"><a href="#SemanticMemoryManager-506"><span class="linenos"> 506</span></a>
</span><span id="SemanticMemoryManager-507"><a href="#SemanticMemoryManager-507"><span class="linenos"> 507</span></a>        <span class="c1"># Check for semantic duplicates</span>
</span><span id="SemanticMemoryManager-508"><a href="#SemanticMemoryManager-508"><span class="linenos"> 508</span></a>        <span class="n">semantic_duplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_semantic_duplicate</span><span class="p">(</span><span class="n">memory_text</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-509"><a href="#SemanticMemoryManager-509"><span class="linenos"> 509</span></a>        <span class="k">if</span> <span class="n">semantic_duplicate</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-510"><a href="#SemanticMemoryManager-510"><span class="linenos"> 510</span></a>            <span class="c1"># Get similarity score for the duplicate</span>
</span><span id="SemanticMemoryManager-511"><a href="#SemanticMemoryManager-511"><span class="linenos"> 511</span></a>            <span class="n">existing_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">mem</span><span class="o">.</span><span class="n">memory</span> <span class="k">for</span> <span class="n">mem</span> <span class="ow">in</span> <span class="n">existing_memories</span><span class="p">]</span>
</span><span id="SemanticMemoryManager-512"><a href="#SemanticMemoryManager-512"><span class="linenos"> 512</span></a>            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">similarity_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_detector</span><span class="o">.</span><span class="n">is_duplicate</span><span class="p">(</span><span class="n">memory_text</span><span class="p">,</span> <span class="n">existing_texts</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-513"><a href="#SemanticMemoryManager-513"><span class="linenos"> 513</span></a>            
</span><span id="SemanticMemoryManager-514"><a href="#SemanticMemoryManager-514"><span class="linenos"> 514</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-515"><a href="#SemanticMemoryManager-515"><span class="linenos"> 515</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">DUPLICATE_SEMANTIC</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-516"><a href="#SemanticMemoryManager-516"><span class="linenos"> 516</span></a>                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Semantic duplicate of: &#39;</span><span class="si">{</span><span class="n">semantic_duplicate</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-517"><a href="#SemanticMemoryManager-517"><span class="linenos"> 517</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-518"><a href="#SemanticMemoryManager-518"><span class="linenos"> 518</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-519"><a href="#SemanticMemoryManager-519"><span class="linenos"> 519</span></a>                <span class="n">similarity_score</span><span class="o">=</span><span class="n">similarity_score</span>
</span><span id="SemanticMemoryManager-520"><a href="#SemanticMemoryManager-520"><span class="linenos"> 520</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-521"><a href="#SemanticMemoryManager-521"><span class="linenos"> 521</span></a>
</span><span id="SemanticMemoryManager-522"><a href="#SemanticMemoryManager-522"><span class="linenos"> 522</span></a>        <span class="c1"># Auto-classify topics if not provided</span>
</span><span id="SemanticMemoryManager-523"><a href="#SemanticMemoryManager-523"><span class="linenos"> 523</span></a>        <span class="k">if</span> <span class="n">topics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_topic_classification</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-524"><a href="#SemanticMemoryManager-524"><span class="linenos"> 524</span></a>            <span class="n">topics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_classifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">memory_text</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-525"><a href="#SemanticMemoryManager-525"><span class="linenos"> 525</span></a>
</span><span id="SemanticMemoryManager-526"><a href="#SemanticMemoryManager-526"><span class="linenos"> 526</span></a>        <span class="c1"># Create the memory</span>
</span><span id="SemanticMemoryManager-527"><a href="#SemanticMemoryManager-527"><span class="linenos"> 527</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-528"><a href="#SemanticMemoryManager-528"><span class="linenos"> 528</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid4</span>
</span><span id="SemanticMemoryManager-529"><a href="#SemanticMemoryManager-529"><span class="linenos"> 529</span></a>
</span><span id="SemanticMemoryManager-530"><a href="#SemanticMemoryManager-530"><span class="linenos"> 530</span></a>            <span class="n">memory_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="SemanticMemoryManager-531"><a href="#SemanticMemoryManager-531"><span class="linenos"> 531</span></a>            <span class="n">last_updated</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-532"><a href="#SemanticMemoryManager-532"><span class="linenos"> 532</span></a>
</span><span id="SemanticMemoryManager-533"><a href="#SemanticMemoryManager-533"><span class="linenos"> 533</span></a>            <span class="n">user_memory</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-534"><a href="#SemanticMemoryManager-534"><span class="linenos"> 534</span></a>                <span class="n">memory_id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-535"><a href="#SemanticMemoryManager-535"><span class="linenos"> 535</span></a>                <span class="n">memory</span><span class="o">=</span><span class="n">memory_text</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-536"><a href="#SemanticMemoryManager-536"><span class="linenos"> 536</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-537"><a href="#SemanticMemoryManager-537"><span class="linenos"> 537</span></a>                <span class="n">last_updated</span><span class="o">=</span><span class="n">last_updated</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-538"><a href="#SemanticMemoryManager-538"><span class="linenos"> 538</span></a>                <span class="nb">input</span><span class="o">=</span><span class="n">input_text</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-539"><a href="#SemanticMemoryManager-539"><span class="linenos"> 539</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-540"><a href="#SemanticMemoryManager-540"><span class="linenos"> 540</span></a>
</span><span id="SemanticMemoryManager-541"><a href="#SemanticMemoryManager-541"><span class="linenos"> 541</span></a>            <span class="n">memory_row</span> <span class="o">=</span> <span class="n">MemoryRow</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-542"><a href="#SemanticMemoryManager-542"><span class="linenos"> 542</span></a>                <span class="nb">id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-543"><a href="#SemanticMemoryManager-543"><span class="linenos"> 543</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-544"><a href="#SemanticMemoryManager-544"><span class="linenos"> 544</span></a>                <span class="n">memory</span><span class="o">=</span><span class="n">user_memory</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
</span><span id="SemanticMemoryManager-545"><a href="#SemanticMemoryManager-545"><span class="linenos"> 545</span></a>                <span class="n">last_updated</span><span class="o">=</span><span class="n">last_updated</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-546"><a href="#SemanticMemoryManager-546"><span class="linenos"> 546</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-547"><a href="#SemanticMemoryManager-547"><span class="linenos"> 547</span></a>
</span><span id="SemanticMemoryManager-548"><a href="#SemanticMemoryManager-548"><span class="linenos"> 548</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">upsert_memory</span><span class="p">(</span><span class="n">memory_row</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-549"><a href="#SemanticMemoryManager-549"><span class="linenos"> 549</span></a>
</span><span id="SemanticMemoryManager-550"><a href="#SemanticMemoryManager-550"><span class="linenos"> 550</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager-551"><a href="#SemanticMemoryManager-551"><span class="linenos"> 551</span></a>
</span><span id="SemanticMemoryManager-552"><a href="#SemanticMemoryManager-552"><span class="linenos"> 552</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-553"><a href="#SemanticMemoryManager-553"><span class="linenos"> 553</span></a>                <span class="s2">&quot;Added memory for user </span><span class="si">%s</span><span class="s2">: &#39;</span><span class="si">%s</span><span class="s2">&#39; (topics: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-554"><a href="#SemanticMemoryManager-554"><span class="linenos"> 554</span></a>                <span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-555"><a href="#SemanticMemoryManager-555"><span class="linenos"> 555</span></a>                <span class="n">memory_text</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-556"><a href="#SemanticMemoryManager-556"><span class="linenos"> 556</span></a>                <span class="n">topics</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-557"><a href="#SemanticMemoryManager-557"><span class="linenos"> 557</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-558"><a href="#SemanticMemoryManager-558"><span class="linenos"> 558</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-559"><a href="#SemanticMemoryManager-559"><span class="linenos"> 559</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ACCEPTED: &#39;</span><span class="si">{</span><span class="n">memory_text</span><span class="si">}</span><span class="s2">&#39; (topics: </span><span class="si">{</span><span class="n">topics</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-560"><a href="#SemanticMemoryManager-560"><span class="linenos"> 560</span></a>
</span><span id="SemanticMemoryManager-561"><a href="#SemanticMemoryManager-561"><span class="linenos"> 561</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-562"><a href="#SemanticMemoryManager-562"><span class="linenos"> 562</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-563"><a href="#SemanticMemoryManager-563"><span class="linenos"> 563</span></a>                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Memory added successfully&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-564"><a href="#SemanticMemoryManager-564"><span class="linenos"> 564</span></a>                <span class="n">memory_id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-565"><a href="#SemanticMemoryManager-565"><span class="linenos"> 565</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-566"><a href="#SemanticMemoryManager-566"><span class="linenos"> 566</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-567"><a href="#SemanticMemoryManager-567"><span class="linenos"> 567</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Will be updated by the caller for dual storage</span>
</span><span id="SemanticMemoryManager-568"><a href="#SemanticMemoryManager-568"><span class="linenos"> 568</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-569"><a href="#SemanticMemoryManager-569"><span class="linenos"> 569</span></a>
</span><span id="SemanticMemoryManager-570"><a href="#SemanticMemoryManager-570"><span class="linenos"> 570</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-571"><a href="#SemanticMemoryManager-571"><span class="linenos"> 571</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error adding memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager-572"><a href="#SemanticMemoryManager-572"><span class="linenos"> 572</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-573"><a href="#SemanticMemoryManager-573"><span class="linenos"> 573</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-574"><a href="#SemanticMemoryManager-574"><span class="linenos"> 574</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">STORAGE_ERROR</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-575"><a href="#SemanticMemoryManager-575"><span class="linenos"> 575</span></a>                <span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-576"><a href="#SemanticMemoryManager-576"><span class="linenos"> 576</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-577"><a href="#SemanticMemoryManager-577"><span class="linenos"> 577</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SemanticMemoryManager-578"><a href="#SemanticMemoryManager-578"><span class="linenos"> 578</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-579"><a href="#SemanticMemoryManager-579"><span class="linenos"> 579</span></a>
</span><span id="SemanticMemoryManager-580"><a href="#SemanticMemoryManager-580"><span class="linenos"> 580</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-581"><a href="#SemanticMemoryManager-581"><span class="linenos"> 581</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-582"><a href="#SemanticMemoryManager-582"><span class="linenos"> 582</span></a>        <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-583"><a href="#SemanticMemoryManager-583"><span class="linenos"> 583</span></a>        <span class="n">memory_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-584"><a href="#SemanticMemoryManager-584"><span class="linenos"> 584</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-585"><a href="#SemanticMemoryManager-585"><span class="linenos"> 585</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-586"><a href="#SemanticMemoryManager-586"><span class="linenos"> 586</span></a>        <span class="n">topics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-587"><a href="#SemanticMemoryManager-587"><span class="linenos"> 587</span></a>        <span class="n">input_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-588"><a href="#SemanticMemoryManager-588"><span class="linenos"> 588</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-589"><a href="#SemanticMemoryManager-589"><span class="linenos"> 589</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-590"><a href="#SemanticMemoryManager-590"><span class="linenos"> 590</span></a><span class="sd">        Update an existing memory.</span>
</span><span id="SemanticMemoryManager-591"><a href="#SemanticMemoryManager-591"><span class="linenos"> 591</span></a>
</span><span id="SemanticMemoryManager-592"><a href="#SemanticMemoryManager-592"><span class="linenos"> 592</span></a><span class="sd">        :param memory_id: ID of the memory to update</span>
</span><span id="SemanticMemoryManager-593"><a href="#SemanticMemoryManager-593"><span class="linenos"> 593</span></a><span class="sd">        :param memory_text: New memory text</span>
</span><span id="SemanticMemoryManager-594"><a href="#SemanticMemoryManager-594"><span class="linenos"> 594</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager-595"><a href="#SemanticMemoryManager-595"><span class="linenos"> 595</span></a><span class="sd">        :param user_id: User ID for the memory</span>
</span><span id="SemanticMemoryManager-596"><a href="#SemanticMemoryManager-596"><span class="linenos"> 596</span></a><span class="sd">        :param topics: Optional list of topics (will be auto-classified if not provided)</span>
</span><span id="SemanticMemoryManager-597"><a href="#SemanticMemoryManager-597"><span class="linenos"> 597</span></a><span class="sd">        :param input_text: Optional input text that generated this memory</span>
</span><span id="SemanticMemoryManager-598"><a href="#SemanticMemoryManager-598"><span class="linenos"> 598</span></a><span class="sd">        :return: Tuple of (success, message)</span>
</span><span id="SemanticMemoryManager-599"><a href="#SemanticMemoryManager-599"><span class="linenos"> 599</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-600"><a href="#SemanticMemoryManager-600"><span class="linenos"> 600</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager-601"><a href="#SemanticMemoryManager-601"><span class="linenos"> 601</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-602"><a href="#SemanticMemoryManager-602"><span class="linenos"> 602</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-603"><a href="#SemanticMemoryManager-603"><span class="linenos"> 603</span></a>            
</span><span id="SemanticMemoryManager-604"><a href="#SemanticMemoryManager-604"><span class="linenos"> 604</span></a>        <span class="c1"># Auto-classify topics if not provided</span>
</span><span id="SemanticMemoryManager-605"><a href="#SemanticMemoryManager-605"><span class="linenos"> 605</span></a>        <span class="k">if</span> <span class="n">topics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_topic_classification</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-606"><a href="#SemanticMemoryManager-606"><span class="linenos"> 606</span></a>            <span class="n">topics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_classifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">memory_text</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-607"><a href="#SemanticMemoryManager-607"><span class="linenos"> 607</span></a>
</span><span id="SemanticMemoryManager-608"><a href="#SemanticMemoryManager-608"><span class="linenos"> 608</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-609"><a href="#SemanticMemoryManager-609"><span class="linenos"> 609</span></a>            <span class="n">last_updated</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-610"><a href="#SemanticMemoryManager-610"><span class="linenos"> 610</span></a>
</span><span id="SemanticMemoryManager-611"><a href="#SemanticMemoryManager-611"><span class="linenos"> 611</span></a>            <span class="n">user_memory</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-612"><a href="#SemanticMemoryManager-612"><span class="linenos"> 612</span></a>                <span class="n">memory_id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-613"><a href="#SemanticMemoryManager-613"><span class="linenos"> 613</span></a>                <span class="n">memory</span><span class="o">=</span><span class="n">memory_text</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-614"><a href="#SemanticMemoryManager-614"><span class="linenos"> 614</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-615"><a href="#SemanticMemoryManager-615"><span class="linenos"> 615</span></a>                <span class="n">last_updated</span><span class="o">=</span><span class="n">last_updated</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-616"><a href="#SemanticMemoryManager-616"><span class="linenos"> 616</span></a>                <span class="nb">input</span><span class="o">=</span><span class="n">input_text</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-617"><a href="#SemanticMemoryManager-617"><span class="linenos"> 617</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-618"><a href="#SemanticMemoryManager-618"><span class="linenos"> 618</span></a>
</span><span id="SemanticMemoryManager-619"><a href="#SemanticMemoryManager-619"><span class="linenos"> 619</span></a>            <span class="n">memory_row</span> <span class="o">=</span> <span class="n">MemoryRow</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-620"><a href="#SemanticMemoryManager-620"><span class="linenos"> 620</span></a>                <span class="nb">id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-621"><a href="#SemanticMemoryManager-621"><span class="linenos"> 621</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-622"><a href="#SemanticMemoryManager-622"><span class="linenos"> 622</span></a>                <span class="n">memory</span><span class="o">=</span><span class="n">user_memory</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
</span><span id="SemanticMemoryManager-623"><a href="#SemanticMemoryManager-623"><span class="linenos"> 623</span></a>                <span class="n">last_updated</span><span class="o">=</span><span class="n">last_updated</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-624"><a href="#SemanticMemoryManager-624"><span class="linenos"> 624</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-625"><a href="#SemanticMemoryManager-625"><span class="linenos"> 625</span></a>
</span><span id="SemanticMemoryManager-626"><a href="#SemanticMemoryManager-626"><span class="linenos"> 626</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">upsert_memory</span><span class="p">(</span><span class="n">memory_row</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-627"><a href="#SemanticMemoryManager-627"><span class="linenos"> 627</span></a>
</span><span id="SemanticMemoryManager-628"><a href="#SemanticMemoryManager-628"><span class="linenos"> 628</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager-629"><a href="#SemanticMemoryManager-629"><span class="linenos"> 629</span></a>
</span><span id="SemanticMemoryManager-630"><a href="#SemanticMemoryManager-630"><span class="linenos"> 630</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-631"><a href="#SemanticMemoryManager-631"><span class="linenos"> 631</span></a>                <span class="s2">&quot;Updated memory </span><span class="si">%s</span><span class="s2"> for user </span><span class="si">%s</span><span class="s2">: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">memory_text</span>
</span><span id="SemanticMemoryManager-632"><a href="#SemanticMemoryManager-632"><span class="linenos"> 632</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-633"><a href="#SemanticMemoryManager-633"><span class="linenos"> 633</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-634"><a href="#SemanticMemoryManager-634"><span class="linenos"> 634</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; UPDATED: &#39;</span><span class="si">{</span><span class="n">memory_text</span><span class="si">}</span><span class="s2">&#39; (topics: </span><span class="si">{</span><span class="n">topics</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-635"><a href="#SemanticMemoryManager-635"><span class="linenos"> 635</span></a>
</span><span id="SemanticMemoryManager-636"><a href="#SemanticMemoryManager-636"><span class="linenos"> 636</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Memory updated successfully&quot;</span>
</span><span id="SemanticMemoryManager-637"><a href="#SemanticMemoryManager-637"><span class="linenos"> 637</span></a>
</span><span id="SemanticMemoryManager-638"><a href="#SemanticMemoryManager-638"><span class="linenos"> 638</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-639"><a href="#SemanticMemoryManager-639"><span class="linenos"> 639</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error updating memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager-640"><a href="#SemanticMemoryManager-640"><span class="linenos"> 640</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-641"><a href="#SemanticMemoryManager-641"><span class="linenos"> 641</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span><span id="SemanticMemoryManager-642"><a href="#SemanticMemoryManager-642"><span class="linenos"> 642</span></a>
</span><span id="SemanticMemoryManager-643"><a href="#SemanticMemoryManager-643"><span class="linenos"> 643</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-644"><a href="#SemanticMemoryManager-644"><span class="linenos"> 644</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SemanticMemoryManager-645"><a href="#SemanticMemoryManager-645"><span class="linenos"> 645</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-646"><a href="#SemanticMemoryManager-646"><span class="linenos"> 646</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-647"><a href="#SemanticMemoryManager-647"><span class="linenos"> 647</span></a><span class="sd">        Delete a memory.</span>
</span><span id="SemanticMemoryManager-648"><a href="#SemanticMemoryManager-648"><span class="linenos"> 648</span></a>
</span><span id="SemanticMemoryManager-649"><a href="#SemanticMemoryManager-649"><span class="linenos"> 649</span></a><span class="sd">        :param memory_id: ID of the memory to delete</span>
</span><span id="SemanticMemoryManager-650"><a href="#SemanticMemoryManager-650"><span class="linenos"> 650</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager-651"><a href="#SemanticMemoryManager-651"><span class="linenos"> 651</span></a><span class="sd">        :param user_id: User ID for the memory</span>
</span><span id="SemanticMemoryManager-652"><a href="#SemanticMemoryManager-652"><span class="linenos"> 652</span></a><span class="sd">        :return: Tuple of (success, message)</span>
</span><span id="SemanticMemoryManager-653"><a href="#SemanticMemoryManager-653"><span class="linenos"> 653</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-654"><a href="#SemanticMemoryManager-654"><span class="linenos"> 654</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-655"><a href="#SemanticMemoryManager-655"><span class="linenos"> 655</span></a>            <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager-656"><a href="#SemanticMemoryManager-656"><span class="linenos"> 656</span></a>            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-657"><a href="#SemanticMemoryManager-657"><span class="linenos"> 657</span></a>                <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-658"><a href="#SemanticMemoryManager-658"><span class="linenos"> 658</span></a>                
</span><span id="SemanticMemoryManager-659"><a href="#SemanticMemoryManager-659"><span class="linenos"> 659</span></a>            <span class="c1"># First check if the memory exists</span>
</span><span id="SemanticMemoryManager-660"><a href="#SemanticMemoryManager-660"><span class="linenos"> 660</span></a>            <span class="n">memory_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-661"><a href="#SemanticMemoryManager-661"><span class="linenos"> 661</span></a>            <span class="n">memory_exists</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SemanticMemoryManager-662"><a href="#SemanticMemoryManager-662"><span class="linenos"> 662</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">memory_rows</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-663"><a href="#SemanticMemoryManager-663"><span class="linenos"> 663</span></a>                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">memory_id</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-664"><a href="#SemanticMemoryManager-664"><span class="linenos"> 664</span></a>                    <span class="n">memory_exists</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager-665"><a href="#SemanticMemoryManager-665"><span class="linenos"> 665</span></a>                    <span class="k">break</span>
</span><span id="SemanticMemoryManager-666"><a href="#SemanticMemoryManager-666"><span class="linenos"> 666</span></a>            
</span><span id="SemanticMemoryManager-667"><a href="#SemanticMemoryManager-667"><span class="linenos"> 667</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memory_exists</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-668"><a href="#SemanticMemoryManager-668"><span class="linenos"> 668</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Memory </span><span class="si">%s</span><span class="s2"> not found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-669"><a href="#SemanticMemoryManager-669"><span class="linenos"> 669</span></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> not found&quot;</span>
</span><span id="SemanticMemoryManager-670"><a href="#SemanticMemoryManager-670"><span class="linenos"> 670</span></a>            
</span><span id="SemanticMemoryManager-671"><a href="#SemanticMemoryManager-671"><span class="linenos"> 671</span></a>            <span class="c1"># Delete the memory</span>
</span><span id="SemanticMemoryManager-672"><a href="#SemanticMemoryManager-672"><span class="linenos"> 672</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span><span class="n">memory_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-673"><a href="#SemanticMemoryManager-673"><span class="linenos"> 673</span></a>
</span><span id="SemanticMemoryManager-674"><a href="#SemanticMemoryManager-674"><span class="linenos"> 674</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager-675"><a href="#SemanticMemoryManager-675"><span class="linenos"> 675</span></a>
</span><span id="SemanticMemoryManager-676"><a href="#SemanticMemoryManager-676"><span class="linenos"> 676</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted memory </span><span class="si">%s</span><span class="s2"> for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-677"><a href="#SemanticMemoryManager-677"><span class="linenos"> 677</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-678"><a href="#SemanticMemoryManager-678"><span class="linenos"> 678</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DELETED: </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-679"><a href="#SemanticMemoryManager-679"><span class="linenos"> 679</span></a>
</span><span id="SemanticMemoryManager-680"><a href="#SemanticMemoryManager-680"><span class="linenos"> 680</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> deleted successfully&quot;</span>
</span><span id="SemanticMemoryManager-681"><a href="#SemanticMemoryManager-681"><span class="linenos"> 681</span></a>
</span><span id="SemanticMemoryManager-682"><a href="#SemanticMemoryManager-682"><span class="linenos"> 682</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-683"><a href="#SemanticMemoryManager-683"><span class="linenos"> 683</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error deleting memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager-684"><a href="#SemanticMemoryManager-684"><span class="linenos"> 684</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-685"><a href="#SemanticMemoryManager-685"><span class="linenos"> 685</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span><span id="SemanticMemoryManager-686"><a href="#SemanticMemoryManager-686"><span class="linenos"> 686</span></a>
</span><span id="SemanticMemoryManager-687"><a href="#SemanticMemoryManager-687"><span class="linenos"> 687</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_memories_by_topic</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-688"><a href="#SemanticMemoryManager-688"><span class="linenos"> 688</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SemanticMemoryManager-689"><a href="#SemanticMemoryManager-689"><span class="linenos"> 689</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-690"><a href="#SemanticMemoryManager-690"><span class="linenos"> 690</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-691"><a href="#SemanticMemoryManager-691"><span class="linenos"> 691</span></a><span class="sd">        Delete all memories associated with a specific topic or list of topics.</span>
</span><span id="SemanticMemoryManager-692"><a href="#SemanticMemoryManager-692"><span class="linenos"> 692</span></a>
</span><span id="SemanticMemoryManager-693"><a href="#SemanticMemoryManager-693"><span class="linenos"> 693</span></a><span class="sd">        :param topics: A list of topics to delete memories for.</span>
</span><span id="SemanticMemoryManager-694"><a href="#SemanticMemoryManager-694"><span class="linenos"> 694</span></a><span class="sd">        :param db: Memory database instance.</span>
</span><span id="SemanticMemoryManager-695"><a href="#SemanticMemoryManager-695"><span class="linenos"> 695</span></a><span class="sd">        :param user_id: User ID for the memories.</span>
</span><span id="SemanticMemoryManager-696"><a href="#SemanticMemoryManager-696"><span class="linenos"> 696</span></a><span class="sd">        :return: Tuple of (success, message).</span>
</span><span id="SemanticMemoryManager-697"><a href="#SemanticMemoryManager-697"><span class="linenos"> 697</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-698"><a href="#SemanticMemoryManager-698"><span class="linenos"> 698</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager-699"><a href="#SemanticMemoryManager-699"><span class="linenos"> 699</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-700"><a href="#SemanticMemoryManager-700"><span class="linenos"> 700</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-701"><a href="#SemanticMemoryManager-701"><span class="linenos"> 701</span></a>            
</span><span id="SemanticMemoryManager-702"><a href="#SemanticMemoryManager-702"><span class="linenos"> 702</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-703"><a href="#SemanticMemoryManager-703"><span class="linenos"> 703</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;No topics provided for deletion.&quot;</span>
</span><span id="SemanticMemoryManager-704"><a href="#SemanticMemoryManager-704"><span class="linenos"> 704</span></a>
</span><span id="SemanticMemoryManager-705"><a href="#SemanticMemoryManager-705"><span class="linenos"> 705</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-706"><a href="#SemanticMemoryManager-706"><span class="linenos"> 706</span></a>            <span class="c1"># Get all memories for the specified topics</span>
</span><span id="SemanticMemoryManager-707"><a href="#SemanticMemoryManager-707"><span class="linenos"> 707</span></a>            <span class="n">memories_to_delete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_memories_by_topic</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-708"><a href="#SemanticMemoryManager-708"><span class="linenos"> 708</span></a>                <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">topics</span><span class="o">=</span><span class="n">topics</span>
</span><span id="SemanticMemoryManager-709"><a href="#SemanticMemoryManager-709"><span class="linenos"> 709</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-710"><a href="#SemanticMemoryManager-710"><span class="linenos"> 710</span></a>
</span><span id="SemanticMemoryManager-711"><a href="#SemanticMemoryManager-711"><span class="linenos"> 711</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories_to_delete</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-712"><a href="#SemanticMemoryManager-712"><span class="linenos"> 712</span></a>                <span class="k">return</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager-713"><a href="#SemanticMemoryManager-713"><span class="linenos"> 713</span></a>                    <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-714"><a href="#SemanticMemoryManager-714"><span class="linenos"> 714</span></a>                    <span class="sa">f</span><span class="s2">&quot;No memories found for topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-715"><a href="#SemanticMemoryManager-715"><span class="linenos"> 715</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager-716"><a href="#SemanticMemoryManager-716"><span class="linenos"> 716</span></a>
</span><span id="SemanticMemoryManager-717"><a href="#SemanticMemoryManager-717"><span class="linenos"> 717</span></a>            <span class="n">deleted_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager-718"><a href="#SemanticMemoryManager-718"><span class="linenos"> 718</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories_to_delete</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-719"><a href="#SemanticMemoryManager-719"><span class="linenos"> 719</span></a>                <span class="n">success</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-720"><a href="#SemanticMemoryManager-720"><span class="linenos"> 720</span></a>                    <span class="n">memory_id</span><span class="o">=</span><span class="n">memory</span><span class="o">.</span><span class="n">memory_id</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span>
</span><span id="SemanticMemoryManager-721"><a href="#SemanticMemoryManager-721"><span class="linenos"> 721</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager-722"><a href="#SemanticMemoryManager-722"><span class="linenos"> 722</span></a>                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-723"><a href="#SemanticMemoryManager-723"><span class="linenos"> 723</span></a>                    <span class="n">deleted_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager-724"><a href="#SemanticMemoryManager-724"><span class="linenos"> 724</span></a>
</span><span id="SemanticMemoryManager-725"><a href="#SemanticMemoryManager-725"><span class="linenos"> 725</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager-726"><a href="#SemanticMemoryManager-726"><span class="linenos"> 726</span></a>
</span><span id="SemanticMemoryManager-727"><a href="#SemanticMemoryManager-727"><span class="linenos"> 727</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-728"><a href="#SemanticMemoryManager-728"><span class="linenos"> 728</span></a>                <span class="s2">&quot;Deleted </span><span class="si">%d</span><span class="s2"> memories for topics &#39;</span><span class="si">%s</span><span class="s2">&#39; for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-729"><a href="#SemanticMemoryManager-729"><span class="linenos"> 729</span></a>                <span class="n">deleted_count</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-730"><a href="#SemanticMemoryManager-730"><span class="linenos"> 730</span></a>                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topics</span><span class="p">),</span>
</span><span id="SemanticMemoryManager-731"><a href="#SemanticMemoryManager-731"><span class="linenos"> 731</span></a>                <span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-732"><a href="#SemanticMemoryManager-732"><span class="linenos"> 732</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-733"><a href="#SemanticMemoryManager-733"><span class="linenos"> 733</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-734"><a href="#SemanticMemoryManager-734"><span class="linenos"> 734</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-735"><a href="#SemanticMemoryManager-735"><span class="linenos"> 735</span></a>                    <span class="sa">f</span><span class="s2">&quot; DELETED BY TOPIC: </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> memories for topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager-736"><a href="#SemanticMemoryManager-736"><span class="linenos"> 736</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager-737"><a href="#SemanticMemoryManager-737"><span class="linenos"> 737</span></a>
</span><span id="SemanticMemoryManager-738"><a href="#SemanticMemoryManager-738"><span class="linenos"> 738</span></a>            <span class="k">return</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager-739"><a href="#SemanticMemoryManager-739"><span class="linenos"> 739</span></a>                <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-740"><a href="#SemanticMemoryManager-740"><span class="linenos"> 740</span></a>                <span class="sa">f</span><span class="s2">&quot;Successfully deleted </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> memories for topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-741"><a href="#SemanticMemoryManager-741"><span class="linenos"> 741</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-742"><a href="#SemanticMemoryManager-742"><span class="linenos"> 742</span></a>
</span><span id="SemanticMemoryManager-743"><a href="#SemanticMemoryManager-743"><span class="linenos"> 743</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-744"><a href="#SemanticMemoryManager-744"><span class="linenos"> 744</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error deleting memories by topic: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager-745"><a href="#SemanticMemoryManager-745"><span class="linenos"> 745</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-746"><a href="#SemanticMemoryManager-746"><span class="linenos"> 746</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span><span id="SemanticMemoryManager-747"><a href="#SemanticMemoryManager-747"><span class="linenos"> 747</span></a>
</span><span id="SemanticMemoryManager-748"><a href="#SemanticMemoryManager-748"><span class="linenos"> 748</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-749"><a href="#SemanticMemoryManager-749"><span class="linenos"> 749</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-750"><a href="#SemanticMemoryManager-750"><span class="linenos"> 750</span></a><span class="sd">        Clear all memories for a user.</span>
</span><span id="SemanticMemoryManager-751"><a href="#SemanticMemoryManager-751"><span class="linenos"> 751</span></a>
</span><span id="SemanticMemoryManager-752"><a href="#SemanticMemoryManager-752"><span class="linenos"> 752</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager-753"><a href="#SemanticMemoryManager-753"><span class="linenos"> 753</span></a><span class="sd">        :param user_id: User ID for the memories</span>
</span><span id="SemanticMemoryManager-754"><a href="#SemanticMemoryManager-754"><span class="linenos"> 754</span></a><span class="sd">        :return: Tuple of (success, message)</span>
</span><span id="SemanticMemoryManager-755"><a href="#SemanticMemoryManager-755"><span class="linenos"> 755</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-756"><a href="#SemanticMemoryManager-756"><span class="linenos"> 756</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager-757"><a href="#SemanticMemoryManager-757"><span class="linenos"> 757</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-758"><a href="#SemanticMemoryManager-758"><span class="linenos"> 758</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-759"><a href="#SemanticMemoryManager-759"><span class="linenos"> 759</span></a>            
</span><span id="SemanticMemoryManager-760"><a href="#SemanticMemoryManager-760"><span class="linenos"> 760</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-761"><a href="#SemanticMemoryManager-761"><span class="linenos"> 761</span></a>            <span class="c1"># Get all memories for the user first</span>
</span><span id="SemanticMemoryManager-762"><a href="#SemanticMemoryManager-762"><span class="linenos"> 762</span></a>            <span class="n">memory_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-763"><a href="#SemanticMemoryManager-763"><span class="linenos"> 763</span></a>
</span><span id="SemanticMemoryManager-764"><a href="#SemanticMemoryManager-764"><span class="linenos"> 764</span></a>            <span class="c1"># Delete each memory</span>
</span><span id="SemanticMemoryManager-765"><a href="#SemanticMemoryManager-765"><span class="linenos"> 765</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">memory_rows</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-766"><a href="#SemanticMemoryManager-766"><span class="linenos"> 766</span></a>                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-767"><a href="#SemanticMemoryManager-767"><span class="linenos"> 767</span></a>                    <span class="n">db</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-768"><a href="#SemanticMemoryManager-768"><span class="linenos"> 768</span></a>
</span><span id="SemanticMemoryManager-769"><a href="#SemanticMemoryManager-769"><span class="linenos"> 769</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager-770"><a href="#SemanticMemoryManager-770"><span class="linenos"> 770</span></a>
</span><span id="SemanticMemoryManager-771"><a href="#SemanticMemoryManager-771"><span class="linenos"> 771</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleared all memories for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-772"><a href="#SemanticMemoryManager-772"><span class="linenos"> 772</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-773"><a href="#SemanticMemoryManager-773"><span class="linenos"> 773</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; CLEARED: All memories for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-774"><a href="#SemanticMemoryManager-774"><span class="linenos"> 774</span></a>
</span><span id="SemanticMemoryManager-775"><a href="#SemanticMemoryManager-775"><span class="linenos"> 775</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Cleared </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memory_rows</span><span class="p">)</span><span class="si">}</span><span class="s2"> memories successfully&quot;</span>
</span><span id="SemanticMemoryManager-776"><a href="#SemanticMemoryManager-776"><span class="linenos"> 776</span></a>
</span><span id="SemanticMemoryManager-777"><a href="#SemanticMemoryManager-777"><span class="linenos"> 777</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-778"><a href="#SemanticMemoryManager-778"><span class="linenos"> 778</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error clearing memories: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager-779"><a href="#SemanticMemoryManager-779"><span class="linenos"> 779</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-780"><a href="#SemanticMemoryManager-780"><span class="linenos"> 780</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span><span id="SemanticMemoryManager-781"><a href="#SemanticMemoryManager-781"><span class="linenos"> 781</span></a>
</span><span id="SemanticMemoryManager-782"><a href="#SemanticMemoryManager-782"><span class="linenos"> 782</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">search_memories</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-783"><a href="#SemanticMemoryManager-783"><span class="linenos"> 783</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-784"><a href="#SemanticMemoryManager-784"><span class="linenos"> 784</span></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-785"><a href="#SemanticMemoryManager-785"><span class="linenos"> 785</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-786"><a href="#SemanticMemoryManager-786"><span class="linenos"> 786</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-787"><a href="#SemanticMemoryManager-787"><span class="linenos"> 787</span></a>        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-788"><a href="#SemanticMemoryManager-788"><span class="linenos"> 788</span></a>        <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-789"><a href="#SemanticMemoryManager-789"><span class="linenos"> 789</span></a>        <span class="n">search_topics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-790"><a href="#SemanticMemoryManager-790"><span class="linenos"> 790</span></a>        <span class="n">topic_boost</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-791"><a href="#SemanticMemoryManager-791"><span class="linenos"> 791</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
</span><span id="SemanticMemoryManager-792"><a href="#SemanticMemoryManager-792"><span class="linenos"> 792</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-793"><a href="#SemanticMemoryManager-793"><span class="linenos"> 793</span></a><span class="sd">        Search memories using semantic similarity and topic matching with enhanced query expansion.</span>
</span><span id="SemanticMemoryManager-794"><a href="#SemanticMemoryManager-794"><span class="linenos"> 794</span></a>
</span><span id="SemanticMemoryManager-795"><a href="#SemanticMemoryManager-795"><span class="linenos"> 795</span></a><span class="sd">        :param query: Search query</span>
</span><span id="SemanticMemoryManager-796"><a href="#SemanticMemoryManager-796"><span class="linenos"> 796</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager-797"><a href="#SemanticMemoryManager-797"><span class="linenos"> 797</span></a><span class="sd">        :param user_id: User ID to search within</span>
</span><span id="SemanticMemoryManager-798"><a href="#SemanticMemoryManager-798"><span class="linenos"> 798</span></a><span class="sd">        :param limit: Maximum number of results</span>
</span><span id="SemanticMemoryManager-799"><a href="#SemanticMemoryManager-799"><span class="linenos"> 799</span></a><span class="sd">        :param similarity_threshold: Minimum similarity threshold for content</span>
</span><span id="SemanticMemoryManager-800"><a href="#SemanticMemoryManager-800"><span class="linenos"> 800</span></a><span class="sd">        :param search_topics: Whether to include topic search (default: True)</span>
</span><span id="SemanticMemoryManager-801"><a href="#SemanticMemoryManager-801"><span class="linenos"> 801</span></a><span class="sd">        :param topic_boost: Score boost for topic matches (default: 0.5)</span>
</span><span id="SemanticMemoryManager-802"><a href="#SemanticMemoryManager-802"><span class="linenos"> 802</span></a><span class="sd">        :return: List of (UserMemory, combined_score) tuples</span>
</span><span id="SemanticMemoryManager-803"><a href="#SemanticMemoryManager-803"><span class="linenos"> 803</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-804"><a href="#SemanticMemoryManager-804"><span class="linenos"> 804</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="SemanticMemoryManager-805"><a href="#SemanticMemoryManager-805"><span class="linenos"> 805</span></a>        
</span><span id="SemanticMemoryManager-806"><a href="#SemanticMemoryManager-806"><span class="linenos"> 806</span></a>        <span class="c1"># LATENCY DEBUG: Start timing memory search</span>
</span><span id="SemanticMemoryManager-807"><a href="#SemanticMemoryManager-807"><span class="linenos"> 807</span></a>        <span class="n">search_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-808"><a href="#SemanticMemoryManager-808"><span class="linenos"> 808</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Starting search_memories for query: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">[:</span><span class="mi">50</span><span class="p">])</span>
</span><span id="SemanticMemoryManager-809"><a href="#SemanticMemoryManager-809"><span class="linenos"> 809</span></a>        
</span><span id="SemanticMemoryManager-810"><a href="#SemanticMemoryManager-810"><span class="linenos"> 810</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager-811"><a href="#SemanticMemoryManager-811"><span class="linenos"> 811</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-812"><a href="#SemanticMemoryManager-812"><span class="linenos"> 812</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-813"><a href="#SemanticMemoryManager-813"><span class="linenos"> 813</span></a>            
</span><span id="SemanticMemoryManager-814"><a href="#SemanticMemoryManager-814"><span class="linenos"> 814</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-815"><a href="#SemanticMemoryManager-815"><span class="linenos"> 815</span></a>            <span class="c1"># LATENCY DEBUG: Time query expansion</span>
</span><span id="SemanticMemoryManager-816"><a href="#SemanticMemoryManager-816"><span class="linenos"> 816</span></a>            <span class="n">expand_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-817"><a href="#SemanticMemoryManager-817"><span class="linenos"> 817</span></a>            <span class="n">expanded_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-818"><a href="#SemanticMemoryManager-818"><span class="linenos"> 818</span></a>            <span class="n">expand_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">expand_start</span>
</span><span id="SemanticMemoryManager-819"><a href="#SemanticMemoryManager-819"><span class="linenos"> 819</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Query expansion took </span><span class="si">%.3f</span><span class="s2"> seconds (</span><span class="si">%d</span><span class="s2"> queries)&quot;</span><span class="p">,</span> <span class="n">expand_time</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">expanded_queries</span><span class="p">))</span>
</span><span id="SemanticMemoryManager-820"><a href="#SemanticMemoryManager-820"><span class="linenos"> 820</span></a>
</span><span id="SemanticMemoryManager-821"><a href="#SemanticMemoryManager-821"><span class="linenos"> 821</span></a>            <span class="c1"># LATENCY DEBUG: Time database read</span>
</span><span id="SemanticMemoryManager-822"><a href="#SemanticMemoryManager-822"><span class="linenos"> 822</span></a>            <span class="n">db_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-823"><a href="#SemanticMemoryManager-823"><span class="linenos"> 823</span></a>            <span class="n">memory_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-824"><a href="#SemanticMemoryManager-824"><span class="linenos"> 824</span></a>            <span class="n">db_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">db_start</span>
</span><span id="SemanticMemoryManager-825"><a href="#SemanticMemoryManager-825"><span class="linenos"> 825</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Database read took </span><span class="si">%.3f</span><span class="s2"> seconds (</span><span class="si">%d</span><span class="s2"> rows)&quot;</span><span class="p">,</span> <span class="n">db_time</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory_rows</span><span class="p">))</span>
</span><span id="SemanticMemoryManager-826"><a href="#SemanticMemoryManager-826"><span class="linenos"> 826</span></a>
</span><span id="SemanticMemoryManager-827"><a href="#SemanticMemoryManager-827"><span class="linenos"> 827</span></a>            <span class="c1"># LATENCY DEBUG: Time memory conversion</span>
</span><span id="SemanticMemoryManager-828"><a href="#SemanticMemoryManager-828"><span class="linenos"> 828</span></a>            <span class="n">convert_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-829"><a href="#SemanticMemoryManager-829"><span class="linenos"> 829</span></a>            <span class="n">user_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-830"><a href="#SemanticMemoryManager-830"><span class="linenos"> 830</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">memory_rows</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-831"><a href="#SemanticMemoryManager-831"><span class="linenos"> 831</span></a>                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-832"><a href="#SemanticMemoryManager-832"><span class="linenos"> 832</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-833"><a href="#SemanticMemoryManager-833"><span class="linenos"> 833</span></a>                        <span class="n">user_memory</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-834"><a href="#SemanticMemoryManager-834"><span class="linenos"> 834</span></a>                        <span class="n">user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-835"><a href="#SemanticMemoryManager-835"><span class="linenos"> 835</span></a>                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-836"><a href="#SemanticMemoryManager-836"><span class="linenos"> 836</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-837"><a href="#SemanticMemoryManager-837"><span class="linenos"> 837</span></a>                            <span class="s2">&quot;Failed to convert memory row to UserMemory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span>
</span><span id="SemanticMemoryManager-838"><a href="#SemanticMemoryManager-838"><span class="linenos"> 838</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager-839"><a href="#SemanticMemoryManager-839"><span class="linenos"> 839</span></a>            <span class="n">convert_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">convert_start</span>
</span><span id="SemanticMemoryManager-840"><a href="#SemanticMemoryManager-840"><span class="linenos"> 840</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Memory conversion took </span><span class="si">%.3f</span><span class="s2"> seconds (</span><span class="si">%d</span><span class="s2"> memories)&quot;</span><span class="p">,</span> <span class="n">convert_time</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_memories</span><span class="p">))</span>
</span><span id="SemanticMemoryManager-841"><a href="#SemanticMemoryManager-841"><span class="linenos"> 841</span></a>
</span><span id="SemanticMemoryManager-842"><a href="#SemanticMemoryManager-842"><span class="linenos"> 842</span></a>            <span class="c1"># LATENCY DEBUG: Time similarity calculations</span>
</span><span id="SemanticMemoryManager-843"><a href="#SemanticMemoryManager-843"><span class="linenos"> 843</span></a>            <span class="n">similarity_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-844"><a href="#SemanticMemoryManager-844"><span class="linenos"> 844</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-845"><a href="#SemanticMemoryManager-845"><span class="linenos"> 845</span></a>            <span class="n">query_lower</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-846"><a href="#SemanticMemoryManager-846"><span class="linenos"> 846</span></a>
</span><span id="SemanticMemoryManager-847"><a href="#SemanticMemoryManager-847"><span class="linenos"> 847</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">user_memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-848"><a href="#SemanticMemoryManager-848"><span class="linenos"> 848</span></a>                <span class="n">max_similarity</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SemanticMemoryManager-849"><a href="#SemanticMemoryManager-849"><span class="linenos"> 849</span></a>                <span class="n">best_query</span> <span class="o">=</span> <span class="n">query</span>
</span><span id="SemanticMemoryManager-850"><a href="#SemanticMemoryManager-850"><span class="linenos"> 850</span></a>
</span><span id="SemanticMemoryManager-851"><a href="#SemanticMemoryManager-851"><span class="linenos"> 851</span></a>                <span class="c1"># Test original query and all expanded queries</span>
</span><span id="SemanticMemoryManager-852"><a href="#SemanticMemoryManager-852"><span class="linenos"> 852</span></a>                <span class="k">for</span> <span class="n">test_query</span> <span class="ow">in</span> <span class="n">expanded_queries</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-853"><a href="#SemanticMemoryManager-853"><span class="linenos"> 853</span></a>                    <span class="n">content_similarity</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager-854"><a href="#SemanticMemoryManager-854"><span class="linenos"> 854</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_detector</span><span class="o">.</span><span class="n">_calculate_semantic_similarity</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-855"><a href="#SemanticMemoryManager-855"><span class="linenos"> 855</span></a>                            <span class="n">test_query</span><span class="p">,</span> <span class="n">memory</span><span class="o">.</span><span class="n">memory</span>
</span><span id="SemanticMemoryManager-856"><a href="#SemanticMemoryManager-856"><span class="linenos"> 856</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager-857"><a href="#SemanticMemoryManager-857"><span class="linenos"> 857</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager-858"><a href="#SemanticMemoryManager-858"><span class="linenos"> 858</span></a>                    <span class="k">if</span> <span class="n">content_similarity</span> <span class="o">&gt;</span> <span class="n">max_similarity</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-859"><a href="#SemanticMemoryManager-859"><span class="linenos"> 859</span></a>                        <span class="n">max_similarity</span> <span class="o">=</span> <span class="n">content_similarity</span>
</span><span id="SemanticMemoryManager-860"><a href="#SemanticMemoryManager-860"><span class="linenos"> 860</span></a>                        <span class="n">best_query</span> <span class="o">=</span> <span class="n">test_query</span>
</span><span id="SemanticMemoryManager-861"><a href="#SemanticMemoryManager-861"><span class="linenos"> 861</span></a>
</span><span id="SemanticMemoryManager-862"><a href="#SemanticMemoryManager-862"><span class="linenos"> 862</span></a>                <span class="c1"># Topic matching with enhanced search</span>
</span><span id="SemanticMemoryManager-863"><a href="#SemanticMemoryManager-863"><span class="linenos"> 863</span></a>                <span class="n">topic_score</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SemanticMemoryManager-864"><a href="#SemanticMemoryManager-864"><span class="linenos"> 864</span></a>                <span class="n">topic_matches</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-865"><a href="#SemanticMemoryManager-865"><span class="linenos"> 865</span></a>
</span><span id="SemanticMemoryManager-866"><a href="#SemanticMemoryManager-866"><span class="linenos"> 866</span></a>                <span class="k">if</span> <span class="n">search_topics</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-867"><a href="#SemanticMemoryManager-867"><span class="linenos"> 867</span></a>                    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-868"><a href="#SemanticMemoryManager-868"><span class="linenos"> 868</span></a>                        <span class="c1"># Check original query and expanded queries against topics</span>
</span><span id="SemanticMemoryManager-869"><a href="#SemanticMemoryManager-869"><span class="linenos"> 869</span></a>                        <span class="k">for</span> <span class="n">test_query</span> <span class="ow">in</span> <span class="n">expanded_queries</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-870"><a href="#SemanticMemoryManager-870"><span class="linenos"> 870</span></a>                            <span class="n">test_query_lower</span> <span class="o">=</span> <span class="n">test_query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-871"><a href="#SemanticMemoryManager-871"><span class="linenos"> 871</span></a>                            <span class="k">if</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager-872"><a href="#SemanticMemoryManager-872"><span class="linenos"> 872</span></a>                                <span class="n">test_query_lower</span> <span class="ow">in</span> <span class="n">topic</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-873"><a href="#SemanticMemoryManager-873"><span class="linenos"> 873</span></a>                                <span class="ow">or</span> <span class="n">topic</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">test_query_lower</span>
</span><span id="SemanticMemoryManager-874"><a href="#SemanticMemoryManager-874"><span class="linenos"> 874</span></a>                            <span class="p">):</span>
</span><span id="SemanticMemoryManager-875"><a href="#SemanticMemoryManager-875"><span class="linenos"> 875</span></a>                                <span class="k">if</span> <span class="n">test_query_lower</span> <span class="o">==</span> <span class="n">topic</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="SemanticMemoryManager-876"><a href="#SemanticMemoryManager-876"><span class="linenos"> 876</span></a>                                    <span class="n">topic_score</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Exact topic match</span>
</span><span id="SemanticMemoryManager-877"><a href="#SemanticMemoryManager-877"><span class="linenos"> 877</span></a>                                    <span class="n">topic_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-878"><a href="#SemanticMemoryManager-878"><span class="linenos"> 878</span></a>                                    <span class="k">break</span>
</span><span id="SemanticMemoryManager-879"><a href="#SemanticMemoryManager-879"><span class="linenos"> 879</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-880"><a href="#SemanticMemoryManager-880"><span class="linenos"> 880</span></a>                                    <span class="n">topic_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-881"><a href="#SemanticMemoryManager-881"><span class="linenos"> 881</span></a>                                        <span class="n">topic_score</span><span class="p">,</span> <span class="mf">0.8</span>
</span><span id="SemanticMemoryManager-882"><a href="#SemanticMemoryManager-882"><span class="linenos"> 882</span></a>                                    <span class="p">)</span>  <span class="c1"># Partial topic match</span>
</span><span id="SemanticMemoryManager-883"><a href="#SemanticMemoryManager-883"><span class="linenos"> 883</span></a>                                    <span class="n">topic_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-884"><a href="#SemanticMemoryManager-884"><span class="linenos"> 884</span></a>
</span><span id="SemanticMemoryManager-885"><a href="#SemanticMemoryManager-885"><span class="linenos"> 885</span></a>                <span class="c1"># Enhanced keyword matching for work-related queries</span>
</span><span id="SemanticMemoryManager-886"><a href="#SemanticMemoryManager-886"><span class="linenos"> 886</span></a>                <span class="n">keyword_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_keyword_score</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-887"><a href="#SemanticMemoryManager-887"><span class="linenos"> 887</span></a>                    <span class="n">expanded_queries</span><span class="p">,</span> <span class="n">memory</span><span class="o">.</span><span class="n">memory</span>
</span><span id="SemanticMemoryManager-888"><a href="#SemanticMemoryManager-888"><span class="linenos"> 888</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager-889"><a href="#SemanticMemoryManager-889"><span class="linenos"> 889</span></a>
</span><span id="SemanticMemoryManager-890"><a href="#SemanticMemoryManager-890"><span class="linenos"> 890</span></a>                <span class="c1"># Combined scoring: use the best of content similarity, topic match, or keyword match</span>
</span><span id="SemanticMemoryManager-891"><a href="#SemanticMemoryManager-891"><span class="linenos"> 891</span></a>                <span class="n">final_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-892"><a href="#SemanticMemoryManager-892"><span class="linenos"> 892</span></a>                    <span class="n">max_similarity</span><span class="p">,</span> <span class="n">topic_score</span> <span class="o">*</span> <span class="n">topic_boost</span><span class="p">,</span> <span class="n">keyword_score</span>
</span><span id="SemanticMemoryManager-893"><a href="#SemanticMemoryManager-893"><span class="linenos"> 893</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager-894"><a href="#SemanticMemoryManager-894"><span class="linenos"> 894</span></a>
</span><span id="SemanticMemoryManager-895"><a href="#SemanticMemoryManager-895"><span class="linenos"> 895</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager-896"><a href="#SemanticMemoryManager-896"><span class="linenos"> 896</span></a>                    <span class="n">final_score</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span>
</span><span id="SemanticMemoryManager-897"><a href="#SemanticMemoryManager-897"><span class="linenos"> 897</span></a>                    <span class="ow">or</span> <span class="n">topic_score</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager-898"><a href="#SemanticMemoryManager-898"><span class="linenos"> 898</span></a>                    <span class="ow">or</span> <span class="n">keyword_score</span> <span class="o">&gt;</span> <span class="mf">0.4</span>
</span><span id="SemanticMemoryManager-899"><a href="#SemanticMemoryManager-899"><span class="linenos"> 899</span></a>                <span class="p">):</span>
</span><span id="SemanticMemoryManager-900"><a href="#SemanticMemoryManager-900"><span class="linenos"> 900</span></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">memory</span><span class="p">,</span> <span class="n">final_score</span><span class="p">))</span>
</span><span id="SemanticMemoryManager-901"><a href="#SemanticMemoryManager-901"><span class="linenos"> 901</span></a>
</span><span id="SemanticMemoryManager-902"><a href="#SemanticMemoryManager-902"><span class="linenos"> 902</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager-903"><a href="#SemanticMemoryManager-903"><span class="linenos"> 903</span></a>                        <span class="n">topic_matches</span> <span class="ow">or</span> <span class="n">keyword_score</span> <span class="o">&gt;</span> <span class="mf">0.4</span>
</span><span id="SemanticMemoryManager-904"><a href="#SemanticMemoryManager-904"><span class="linenos"> 904</span></a>                    <span class="p">):</span>
</span><span id="SemanticMemoryManager-905"><a href="#SemanticMemoryManager-905"><span class="linenos"> 905</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-906"><a href="#SemanticMemoryManager-906"><span class="linenos"> 906</span></a>                            <span class="s2">&quot;Enhanced match for query &#39;</span><span class="si">%s</span><span class="s2">&#39;: memory=&#39;</span><span class="si">%s</span><span class="s2">&#39;, topics=</span><span class="si">%s</span><span class="s2">, final_score=</span><span class="si">%.3f</span><span class="s2"> (content=</span><span class="si">%.3f</span><span class="s2">, topic=</span><span class="si">%.3f</span><span class="s2">, keyword=</span><span class="si">%.3f</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-907"><a href="#SemanticMemoryManager-907"><span class="linenos"> 907</span></a>                            <span class="n">query</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-908"><a href="#SemanticMemoryManager-908"><span class="linenos"> 908</span></a>                            <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-909"><a href="#SemanticMemoryManager-909"><span class="linenos"> 909</span></a>                            <span class="n">topic_matches</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-910"><a href="#SemanticMemoryManager-910"><span class="linenos"> 910</span></a>                            <span class="n">final_score</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-911"><a href="#SemanticMemoryManager-911"><span class="linenos"> 911</span></a>                            <span class="n">max_similarity</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-912"><a href="#SemanticMemoryManager-912"><span class="linenos"> 912</span></a>                            <span class="n">topic_score</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-913"><a href="#SemanticMemoryManager-913"><span class="linenos"> 913</span></a>                            <span class="n">keyword_score</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-914"><a href="#SemanticMemoryManager-914"><span class="linenos"> 914</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager-915"><a href="#SemanticMemoryManager-915"><span class="linenos"> 915</span></a>
</span><span id="SemanticMemoryManager-916"><a href="#SemanticMemoryManager-916"><span class="linenos"> 916</span></a>            <span class="n">similarity_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">similarity_start</span>
</span><span id="SemanticMemoryManager-917"><a href="#SemanticMemoryManager-917"><span class="linenos"> 917</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Similarity calculations took </span><span class="si">%.3f</span><span class="s2"> seconds (</span><span class="si">%d</span><span class="s2"> memories processed)&quot;</span><span class="p">,</span> <span class="n">similarity_time</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_memories</span><span class="p">))</span>
</span><span id="SemanticMemoryManager-918"><a href="#SemanticMemoryManager-918"><span class="linenos"> 918</span></a>
</span><span id="SemanticMemoryManager-919"><a href="#SemanticMemoryManager-919"><span class="linenos"> 919</span></a>            <span class="c1"># LATENCY DEBUG: Time sorting</span>
</span><span id="SemanticMemoryManager-920"><a href="#SemanticMemoryManager-920"><span class="linenos"> 920</span></a>            <span class="n">sort_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-921"><a href="#SemanticMemoryManager-921"><span class="linenos"> 921</span></a>            <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-922"><a href="#SemanticMemoryManager-922"><span class="linenos"> 922</span></a>            <span class="n">sort_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">sort_start</span>
</span><span id="SemanticMemoryManager-923"><a href="#SemanticMemoryManager-923"><span class="linenos"> 923</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Sorting took </span><span class="si">%.3f</span><span class="s2"> seconds&quot;</span><span class="p">,</span> <span class="n">sort_time</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-924"><a href="#SemanticMemoryManager-924"><span class="linenos"> 924</span></a>
</span><span id="SemanticMemoryManager-925"><a href="#SemanticMemoryManager-925"><span class="linenos"> 925</span></a>            <span class="c1"># LATENCY DEBUG: Total timing</span>
</span><span id="SemanticMemoryManager-926"><a href="#SemanticMemoryManager-926"><span class="linenos"> 926</span></a>            <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">search_start_time</span>
</span><span id="SemanticMemoryManager-927"><a href="#SemanticMemoryManager-927"><span class="linenos"> 927</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Total search_memories time: </span><span class="si">%.3f</span><span class="s2"> seconds (expand: </span><span class="si">%.3f</span><span class="s2">, db: </span><span class="si">%.3f</span><span class="s2">, convert: </span><span class="si">%.3f</span><span class="s2">, similarity: </span><span class="si">%.3f</span><span class="s2">, sort: </span><span class="si">%.3f</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-928"><a href="#SemanticMemoryManager-928"><span class="linenos"> 928</span></a>                       <span class="n">total_time</span><span class="p">,</span> <span class="n">expand_time</span><span class="p">,</span> <span class="n">db_time</span><span class="p">,</span> <span class="n">convert_time</span><span class="p">,</span> <span class="n">similarity_time</span><span class="p">,</span> <span class="n">sort_time</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-929"><a href="#SemanticMemoryManager-929"><span class="linenos"> 929</span></a>
</span><span id="SemanticMemoryManager-930"><a href="#SemanticMemoryManager-930"><span class="linenos"> 930</span></a>            <span class="k">return</span> <span class="n">results</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
</span><span id="SemanticMemoryManager-931"><a href="#SemanticMemoryManager-931"><span class="linenos"> 931</span></a>
</span><span id="SemanticMemoryManager-932"><a href="#SemanticMemoryManager-932"><span class="linenos"> 932</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-933"><a href="#SemanticMemoryManager-933"><span class="linenos"> 933</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error searching memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-934"><a href="#SemanticMemoryManager-934"><span class="linenos"> 934</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-935"><a href="#SemanticMemoryManager-935"><span class="linenos"> 935</span></a>
</span><span id="SemanticMemoryManager-936"><a href="#SemanticMemoryManager-936"><span class="linenos"> 936</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_memories_by_topic</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-937"><a href="#SemanticMemoryManager-937"><span class="linenos"> 937</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-938"><a href="#SemanticMemoryManager-938"><span class="linenos"> 938</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-939"><a href="#SemanticMemoryManager-939"><span class="linenos"> 939</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-940"><a href="#SemanticMemoryManager-940"><span class="linenos"> 940</span></a>        <span class="n">topics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-941"><a href="#SemanticMemoryManager-941"><span class="linenos"> 941</span></a>        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-942"><a href="#SemanticMemoryManager-942"><span class="linenos"> 942</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-943"><a href="#SemanticMemoryManager-943"><span class="linenos"> 943</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-944"><a href="#SemanticMemoryManager-944"><span class="linenos"> 944</span></a><span class="sd">        Get memories filtered by a list of topics, without similarity search.</span>
</span><span id="SemanticMemoryManager-945"><a href="#SemanticMemoryManager-945"><span class="linenos"> 945</span></a>
</span><span id="SemanticMemoryManager-946"><a href="#SemanticMemoryManager-946"><span class="linenos"> 946</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager-947"><a href="#SemanticMemoryManager-947"><span class="linenos"> 947</span></a><span class="sd">        :param user_id: User ID to search within</span>
</span><span id="SemanticMemoryManager-948"><a href="#SemanticMemoryManager-948"><span class="linenos"> 948</span></a><span class="sd">        :param topics: Optional list of topics to filter by. If None, returns all memories.</span>
</span><span id="SemanticMemoryManager-949"><a href="#SemanticMemoryManager-949"><span class="linenos"> 949</span></a><span class="sd">        :param limit: Maximum number of results to return</span>
</span><span id="SemanticMemoryManager-950"><a href="#SemanticMemoryManager-950"><span class="linenos"> 950</span></a><span class="sd">        :return: List of UserMemory objects matching the topics.</span>
</span><span id="SemanticMemoryManager-951"><a href="#SemanticMemoryManager-951"><span class="linenos"> 951</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-952"><a href="#SemanticMemoryManager-952"><span class="linenos"> 952</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager-953"><a href="#SemanticMemoryManager-953"><span class="linenos"> 953</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-954"><a href="#SemanticMemoryManager-954"><span class="linenos"> 954</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-955"><a href="#SemanticMemoryManager-955"><span class="linenos"> 955</span></a>            
</span><span id="SemanticMemoryManager-956"><a href="#SemanticMemoryManager-956"><span class="linenos"> 956</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-957"><a href="#SemanticMemoryManager-957"><span class="linenos"> 957</span></a>            <span class="c1"># Get all memories for the user</span>
</span><span id="SemanticMemoryManager-958"><a href="#SemanticMemoryManager-958"><span class="linenos"> 958</span></a>            <span class="n">memory_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-959"><a href="#SemanticMemoryManager-959"><span class="linenos"> 959</span></a>
</span><span id="SemanticMemoryManager-960"><a href="#SemanticMemoryManager-960"><span class="linenos"> 960</span></a>            <span class="n">user_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-961"><a href="#SemanticMemoryManager-961"><span class="linenos"> 961</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">memory_rows</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-962"><a href="#SemanticMemoryManager-962"><span class="linenos"> 962</span></a>                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-963"><a href="#SemanticMemoryManager-963"><span class="linenos"> 963</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-964"><a href="#SemanticMemoryManager-964"><span class="linenos"> 964</span></a>                        <span class="n">user_memory</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-965"><a href="#SemanticMemoryManager-965"><span class="linenos"> 965</span></a>                        <span class="n">user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-966"><a href="#SemanticMemoryManager-966"><span class="linenos"> 966</span></a>                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-967"><a href="#SemanticMemoryManager-967"><span class="linenos"> 967</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-968"><a href="#SemanticMemoryManager-968"><span class="linenos"> 968</span></a>                            <span class="s2">&quot;Failed to convert memory row to UserMemory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span>
</span><span id="SemanticMemoryManager-969"><a href="#SemanticMemoryManager-969"><span class="linenos"> 969</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager-970"><a href="#SemanticMemoryManager-970"><span class="linenos"> 970</span></a>
</span><span id="SemanticMemoryManager-971"><a href="#SemanticMemoryManager-971"><span class="linenos"> 971</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-972"><a href="#SemanticMemoryManager-972"><span class="linenos"> 972</span></a>                <span class="c1"># If no topics are specified, return all memories up to the limit</span>
</span><span id="SemanticMemoryManager-973"><a href="#SemanticMemoryManager-973"><span class="linenos"> 973</span></a>                <span class="k">return</span> <span class="n">user_memories</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
</span><span id="SemanticMemoryManager-974"><a href="#SemanticMemoryManager-974"><span class="linenos"> 974</span></a>
</span><span id="SemanticMemoryManager-975"><a href="#SemanticMemoryManager-975"><span class="linenos"> 975</span></a>            <span class="c1"># Filter memories by the given topics</span>
</span><span id="SemanticMemoryManager-976"><a href="#SemanticMemoryManager-976"><span class="linenos"> 976</span></a>            <span class="n">filtered_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-977"><a href="#SemanticMemoryManager-977"><span class="linenos"> 977</span></a>            <span class="n">topic_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">}</span>
</span><span id="SemanticMemoryManager-978"><a href="#SemanticMemoryManager-978"><span class="linenos"> 978</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">user_memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-979"><a href="#SemanticMemoryManager-979"><span class="linenos"> 979</span></a>                <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-980"><a href="#SemanticMemoryManager-980"><span class="linenos"> 980</span></a>                    <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">topic_set</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span>
</span><span id="SemanticMemoryManager-981"><a href="#SemanticMemoryManager-981"><span class="linenos"> 981</span></a>                <span class="p">):</span>
</span><span id="SemanticMemoryManager-982"><a href="#SemanticMemoryManager-982"><span class="linenos"> 982</span></a>                    <span class="n">filtered_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-983"><a href="#SemanticMemoryManager-983"><span class="linenos"> 983</span></a>
</span><span id="SemanticMemoryManager-984"><a href="#SemanticMemoryManager-984"><span class="linenos"> 984</span></a>            <span class="c1"># Sort by date (already sorted by read_memories) and limit</span>
</span><span id="SemanticMemoryManager-985"><a href="#SemanticMemoryManager-985"><span class="linenos"> 985</span></a>            <span class="k">return</span> <span class="n">filtered_memories</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
</span><span id="SemanticMemoryManager-986"><a href="#SemanticMemoryManager-986"><span class="linenos"> 986</span></a>
</span><span id="SemanticMemoryManager-987"><a href="#SemanticMemoryManager-987"><span class="linenos"> 987</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-988"><a href="#SemanticMemoryManager-988"><span class="linenos"> 988</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error getting memories by topic: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-989"><a href="#SemanticMemoryManager-989"><span class="linenos"> 989</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-990"><a href="#SemanticMemoryManager-990"><span class="linenos"> 990</span></a>
</span><span id="SemanticMemoryManager-991"><a href="#SemanticMemoryManager-991"><span class="linenos"> 991</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_expand_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-992"><a href="#SemanticMemoryManager-992"><span class="linenos"> 992</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-993"><a href="#SemanticMemoryManager-993"><span class="linenos"> 993</span></a><span class="sd">        Expand query with synonyms and related terms for better semantic matching.</span>
</span><span id="SemanticMemoryManager-994"><a href="#SemanticMemoryManager-994"><span class="linenos"> 994</span></a>
</span><span id="SemanticMemoryManager-995"><a href="#SemanticMemoryManager-995"><span class="linenos"> 995</span></a><span class="sd">        :param query: Original search query</span>
</span><span id="SemanticMemoryManager-996"><a href="#SemanticMemoryManager-996"><span class="linenos"> 996</span></a><span class="sd">        :return: List of expanded queries including the original</span>
</span><span id="SemanticMemoryManager-997"><a href="#SemanticMemoryManager-997"><span class="linenos"> 997</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-998"><a href="#SemanticMemoryManager-998"><span class="linenos"> 998</span></a>        <span class="n">query_lower</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-999"><a href="#SemanticMemoryManager-999"><span class="linenos"> 999</span></a>        <span class="n">expanded</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span><span class="p">]</span>  <span class="c1"># Always include original query</span>
</span><span id="SemanticMemoryManager-1000"><a href="#SemanticMemoryManager-1000"><span class="linenos">1000</span></a>
</span><span id="SemanticMemoryManager-1001"><a href="#SemanticMemoryManager-1001"><span class="linenos">1001</span></a>        <span class="c1"># Work-related expansions</span>
</span><span id="SemanticMemoryManager-1002"><a href="#SemanticMemoryManager-1002"><span class="linenos">1002</span></a>        <span class="n">work_synonyms</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SemanticMemoryManager-1003"><a href="#SemanticMemoryManager-1003"><span class="linenos">1003</span></a>            <span class="s2">&quot;work&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="SemanticMemoryManager-1004"><a href="#SemanticMemoryManager-1004"><span class="linenos">1004</span></a>                <span class="s2">&quot;job&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1005"><a href="#SemanticMemoryManager-1005"><span class="linenos">1005</span></a>                <span class="s2">&quot;employment&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1006"><a href="#SemanticMemoryManager-1006"><span class="linenos">1006</span></a>                <span class="s2">&quot;career&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1007"><a href="#SemanticMemoryManager-1007"><span class="linenos">1007</span></a>                <span class="s2">&quot;occupation&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1008"><a href="#SemanticMemoryManager-1008"><span class="linenos">1008</span></a>                <span class="s2">&quot;position&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1009"><a href="#SemanticMemoryManager-1009"><span class="linenos">1009</span></a>                <span class="s2">&quot;company&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1010"><a href="#SemanticMemoryManager-1010"><span class="linenos">1010</span></a>                <span class="s2">&quot;employer&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1011"><a href="#SemanticMemoryManager-1011"><span class="linenos">1011</span></a>                <span class="s2">&quot;workplace&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1012"><a href="#SemanticMemoryManager-1012"><span class="linenos">1012</span></a>            <span class="p">],</span>
</span><span id="SemanticMemoryManager-1013"><a href="#SemanticMemoryManager-1013"><span class="linenos">1013</span></a>            <span class="s2">&quot;workplace&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;work&quot;</span><span class="p">,</span> <span class="s2">&quot;job&quot;</span><span class="p">,</span> <span class="s2">&quot;office&quot;</span><span class="p">,</span> <span class="s2">&quot;company&quot;</span><span class="p">,</span> <span class="s2">&quot;employer&quot;</span><span class="p">,</span> <span class="s2">&quot;business&quot;</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-1014"><a href="#SemanticMemoryManager-1014"><span class="linenos">1014</span></a>            <span class="s2">&quot;job&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;work&quot;</span><span class="p">,</span> <span class="s2">&quot;employment&quot;</span><span class="p">,</span> <span class="s2">&quot;career&quot;</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;occupation&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-1015"><a href="#SemanticMemoryManager-1015"><span class="linenos">1015</span></a>            <span class="s2">&quot;company&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;employer&quot;</span><span class="p">,</span> <span class="s2">&quot;business&quot;</span><span class="p">,</span> <span class="s2">&quot;organization&quot;</span><span class="p">,</span> <span class="s2">&quot;workplace&quot;</span><span class="p">,</span> <span class="s2">&quot;firm&quot;</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-1016"><a href="#SemanticMemoryManager-1016"><span class="linenos">1016</span></a>            <span class="s2">&quot;career&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">,</span> <span class="s2">&quot;work&quot;</span><span class="p">,</span> <span class="s2">&quot;profession&quot;</span><span class="p">,</span> <span class="s2">&quot;occupation&quot;</span><span class="p">,</span> <span class="s2">&quot;employment&quot;</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-1017"><a href="#SemanticMemoryManager-1017"><span class="linenos">1017</span></a>        <span class="p">}</span>
</span><span id="SemanticMemoryManager-1018"><a href="#SemanticMemoryManager-1018"><span class="linenos">1018</span></a>
</span><span id="SemanticMemoryManager-1019"><a href="#SemanticMemoryManager-1019"><span class="linenos">1019</span></a>        <span class="c1"># Education-related expansions</span>
</span><span id="SemanticMemoryManager-1020"><a href="#SemanticMemoryManager-1020"><span class="linenos">1020</span></a>        <span class="n">education_synonyms</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SemanticMemoryManager-1021"><a href="#SemanticMemoryManager-1021"><span class="linenos">1021</span></a>            <span class="s2">&quot;school&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;university&quot;</span><span class="p">,</span> <span class="s2">&quot;college&quot;</span><span class="p">,</span> <span class="s2">&quot;education&quot;</span><span class="p">,</span> <span class="s2">&quot;academic&quot;</span><span class="p">,</span> <span class="s2">&quot;institution&quot;</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-1022"><a href="#SemanticMemoryManager-1022"><span class="linenos">1022</span></a>            <span class="s2">&quot;university&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;college&quot;</span><span class="p">,</span> <span class="s2">&quot;school&quot;</span><span class="p">,</span> <span class="s2">&quot;education&quot;</span><span class="p">,</span> <span class="s2">&quot;academic&quot;</span><span class="p">,</span> <span class="s2">&quot;institution&quot;</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-1023"><a href="#SemanticMemoryManager-1023"><span class="linenos">1023</span></a>            <span class="s2">&quot;degree&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">,</span> <span class="s2">&quot;qualification&quot;</span><span class="p">,</span> <span class="s2">&quot;diploma&quot;</span><span class="p">,</span> <span class="s2">&quot;certification&quot;</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-1024"><a href="#SemanticMemoryManager-1024"><span class="linenos">1024</span></a>            <span class="s2">&quot;study&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">,</span> <span class="s2">&quot;learning&quot;</span><span class="p">,</span> <span class="s2">&quot;academic&quot;</span><span class="p">,</span> <span class="s2">&quot;school&quot;</span><span class="p">,</span> <span class="s2">&quot;university&quot;</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-1025"><a href="#SemanticMemoryManager-1025"><span class="linenos">1025</span></a>        <span class="p">}</span>
</span><span id="SemanticMemoryManager-1026"><a href="#SemanticMemoryManager-1026"><span class="linenos">1026</span></a>
</span><span id="SemanticMemoryManager-1027"><a href="#SemanticMemoryManager-1027"><span class="linenos">1027</span></a>        <span class="c1"># Personal-related expansions</span>
</span><span id="SemanticMemoryManager-1028"><a href="#SemanticMemoryManager-1028"><span class="linenos">1028</span></a>        <span class="n">personal_synonyms</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SemanticMemoryManager-1029"><a href="#SemanticMemoryManager-1029"><span class="linenos">1029</span></a>            <span class="s2">&quot;hobby&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;interest&quot;</span><span class="p">,</span> <span class="s2">&quot;activity&quot;</span><span class="p">,</span> <span class="s2">&quot;pastime&quot;</span><span class="p">,</span> <span class="s2">&quot;recreation&quot;</span><span class="p">,</span> <span class="s2">&quot;leisure&quot;</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-1030"><a href="#SemanticMemoryManager-1030"><span class="linenos">1030</span></a>            <span class="s2">&quot;interest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;hobby&quot;</span><span class="p">,</span> <span class="s2">&quot;passion&quot;</span><span class="p">,</span> <span class="s2">&quot;activity&quot;</span><span class="p">,</span> <span class="s2">&quot;like&quot;</span><span class="p">,</span> <span class="s2">&quot;enjoy&quot;</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-1031"><a href="#SemanticMemoryManager-1031"><span class="linenos">1031</span></a>            <span class="s2">&quot;like&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;enjoy&quot;</span><span class="p">,</span> <span class="s2">&quot;prefer&quot;</span><span class="p">,</span> <span class="s2">&quot;love&quot;</span><span class="p">,</span> <span class="s2">&quot;interest&quot;</span><span class="p">,</span> <span class="s2">&quot;hobby&quot;</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-1032"><a href="#SemanticMemoryManager-1032"><span class="linenos">1032</span></a>            <span class="s2">&quot;preference&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;like&quot;</span><span class="p">,</span> <span class="s2">&quot;prefer&quot;</span><span class="p">,</span> <span class="s2">&quot;choice&quot;</span><span class="p">,</span> <span class="s2">&quot;favorite&quot;</span><span class="p">],</span>
</span><span id="SemanticMemoryManager-1033"><a href="#SemanticMemoryManager-1033"><span class="linenos">1033</span></a>        <span class="p">}</span>
</span><span id="SemanticMemoryManager-1034"><a href="#SemanticMemoryManager-1034"><span class="linenos">1034</span></a>
</span><span id="SemanticMemoryManager-1035"><a href="#SemanticMemoryManager-1035"><span class="linenos">1035</span></a>        <span class="c1"># Combine all synonym dictionaries</span>
</span><span id="SemanticMemoryManager-1036"><a href="#SemanticMemoryManager-1036"><span class="linenos">1036</span></a>        <span class="n">all_synonyms</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">work_synonyms</span><span class="p">,</span> <span class="o">**</span><span class="n">education_synonyms</span><span class="p">,</span> <span class="o">**</span><span class="n">personal_synonyms</span><span class="p">}</span>
</span><span id="SemanticMemoryManager-1037"><a href="#SemanticMemoryManager-1037"><span class="linenos">1037</span></a>
</span><span id="SemanticMemoryManager-1038"><a href="#SemanticMemoryManager-1038"><span class="linenos">1038</span></a>        <span class="c1"># Add synonyms for words in the query</span>
</span><span id="SemanticMemoryManager-1039"><a href="#SemanticMemoryManager-1039"><span class="linenos">1039</span></a>        <span class="n">query_words</span> <span class="o">=</span> <span class="n">query_lower</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-1040"><a href="#SemanticMemoryManager-1040"><span class="linenos">1040</span></a>        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">query_words</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1041"><a href="#SemanticMemoryManager-1041"><span class="linenos">1041</span></a>            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">all_synonyms</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1042"><a href="#SemanticMemoryManager-1042"><span class="linenos">1042</span></a>                <span class="k">for</span> <span class="n">synonym</span> <span class="ow">in</span> <span class="n">all_synonyms</span><span class="p">[</span><span class="n">word</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-1043"><a href="#SemanticMemoryManager-1043"><span class="linenos">1043</span></a>                    <span class="c1"># Create expanded queries by replacing the word with synonyms</span>
</span><span id="SemanticMemoryManager-1044"><a href="#SemanticMemoryManager-1044"><span class="linenos">1044</span></a>                    <span class="n">expanded_query</span> <span class="o">=</span> <span class="n">query_lower</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">synonym</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1045"><a href="#SemanticMemoryManager-1045"><span class="linenos">1045</span></a>                    <span class="k">if</span> <span class="n">expanded_query</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expanded</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1046"><a href="#SemanticMemoryManager-1046"><span class="linenos">1046</span></a>                        <span class="n">expanded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expanded_query</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1047"><a href="#SemanticMemoryManager-1047"><span class="linenos">1047</span></a>
</span><span id="SemanticMemoryManager-1048"><a href="#SemanticMemoryManager-1048"><span class="linenos">1048</span></a>                    <span class="c1"># Also add just the synonym</span>
</span><span id="SemanticMemoryManager-1049"><a href="#SemanticMemoryManager-1049"><span class="linenos">1049</span></a>                    <span class="k">if</span> <span class="n">synonym</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expanded</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1050"><a href="#SemanticMemoryManager-1050"><span class="linenos">1050</span></a>                        <span class="n">expanded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">synonym</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1051"><a href="#SemanticMemoryManager-1051"><span class="linenos">1051</span></a>
</span><span id="SemanticMemoryManager-1052"><a href="#SemanticMemoryManager-1052"><span class="linenos">1052</span></a>        <span class="k">return</span> <span class="n">expanded</span>
</span><span id="SemanticMemoryManager-1053"><a href="#SemanticMemoryManager-1053"><span class="linenos">1053</span></a>
</span><span id="SemanticMemoryManager-1054"><a href="#SemanticMemoryManager-1054"><span class="linenos">1054</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_keyword_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">memory_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1055"><a href="#SemanticMemoryManager-1055"><span class="linenos">1055</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1056"><a href="#SemanticMemoryManager-1056"><span class="linenos">1056</span></a><span class="sd">        Calculate keyword-based similarity score for enhanced matching.</span>
</span><span id="SemanticMemoryManager-1057"><a href="#SemanticMemoryManager-1057"><span class="linenos">1057</span></a>
</span><span id="SemanticMemoryManager-1058"><a href="#SemanticMemoryManager-1058"><span class="linenos">1058</span></a><span class="sd">        :param queries: List of query variations to test</span>
</span><span id="SemanticMemoryManager-1059"><a href="#SemanticMemoryManager-1059"><span class="linenos">1059</span></a><span class="sd">        :param memory_text: Memory text to search in</span>
</span><span id="SemanticMemoryManager-1060"><a href="#SemanticMemoryManager-1060"><span class="linenos">1060</span></a><span class="sd">        :return: Keyword similarity score (0.0 to 1.0)</span>
</span><span id="SemanticMemoryManager-1061"><a href="#SemanticMemoryManager-1061"><span class="linenos">1061</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1062"><a href="#SemanticMemoryManager-1062"><span class="linenos">1062</span></a>        <span class="n">memory_lower</span> <span class="o">=</span> <span class="n">memory_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-1063"><a href="#SemanticMemoryManager-1063"><span class="linenos">1063</span></a>        <span class="n">max_score</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SemanticMemoryManager-1064"><a href="#SemanticMemoryManager-1064"><span class="linenos">1064</span></a>
</span><span id="SemanticMemoryManager-1065"><a href="#SemanticMemoryManager-1065"><span class="linenos">1065</span></a>        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1066"><a href="#SemanticMemoryManager-1066"><span class="linenos">1066</span></a>            <span class="n">query_words</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-1067"><a href="#SemanticMemoryManager-1067"><span class="linenos">1067</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">query_words</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1068"><a href="#SemanticMemoryManager-1068"><span class="linenos">1068</span></a>                <span class="k">continue</span>
</span><span id="SemanticMemoryManager-1069"><a href="#SemanticMemoryManager-1069"><span class="linenos">1069</span></a>
</span><span id="SemanticMemoryManager-1070"><a href="#SemanticMemoryManager-1070"><span class="linenos">1070</span></a>            <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager-1071"><a href="#SemanticMemoryManager-1071"><span class="linenos">1071</span></a>            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">query_words</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1072"><a href="#SemanticMemoryManager-1072"><span class="linenos">1072</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager-1073"><a href="#SemanticMemoryManager-1073"><span class="linenos">1073</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">memory_lower</span>
</span><span id="SemanticMemoryManager-1074"><a href="#SemanticMemoryManager-1074"><span class="linenos">1074</span></a>                <span class="p">):</span>  <span class="c1"># Only count words longer than 2 chars</span>
</span><span id="SemanticMemoryManager-1075"><a href="#SemanticMemoryManager-1075"><span class="linenos">1075</span></a>                    <span class="n">matches</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager-1076"><a href="#SemanticMemoryManager-1076"><span class="linenos">1076</span></a>
</span><span id="SemanticMemoryManager-1077"><a href="#SemanticMemoryManager-1077"><span class="linenos">1077</span></a>            <span class="k">if</span> <span class="n">query_words</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1078"><a href="#SemanticMemoryManager-1078"><span class="linenos">1078</span></a>                <span class="n">score</span> <span class="o">=</span> <span class="n">matches</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_words</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1079"><a href="#SemanticMemoryManager-1079"><span class="linenos">1079</span></a>                <span class="n">max_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_score</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1080"><a href="#SemanticMemoryManager-1080"><span class="linenos">1080</span></a>
</span><span id="SemanticMemoryManager-1081"><a href="#SemanticMemoryManager-1081"><span class="linenos">1081</span></a>        <span class="k">return</span> <span class="n">max_score</span>
</span><span id="SemanticMemoryManager-1082"><a href="#SemanticMemoryManager-1082"><span class="linenos">1082</span></a>
</span><span id="SemanticMemoryManager-1083"><a href="#SemanticMemoryManager-1083"><span class="linenos">1083</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-1084"><a href="#SemanticMemoryManager-1084"><span class="linenos">1084</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1085"><a href="#SemanticMemoryManager-1085"><span class="linenos">1085</span></a><span class="sd">        Get all memories for a user.</span>
</span><span id="SemanticMemoryManager-1086"><a href="#SemanticMemoryManager-1086"><span class="linenos">1086</span></a>
</span><span id="SemanticMemoryManager-1087"><a href="#SemanticMemoryManager-1087"><span class="linenos">1087</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager-1088"><a href="#SemanticMemoryManager-1088"><span class="linenos">1088</span></a><span class="sd">        :param user_id: User ID to retrieve memories for</span>
</span><span id="SemanticMemoryManager-1089"><a href="#SemanticMemoryManager-1089"><span class="linenos">1089</span></a><span class="sd">        :return: List of UserMemory objects</span>
</span><span id="SemanticMemoryManager-1090"><a href="#SemanticMemoryManager-1090"><span class="linenos">1090</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1091"><a href="#SemanticMemoryManager-1091"><span class="linenos">1091</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager-1092"><a href="#SemanticMemoryManager-1092"><span class="linenos">1092</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1093"><a href="#SemanticMemoryManager-1093"><span class="linenos">1093</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-1094"><a href="#SemanticMemoryManager-1094"><span class="linenos">1094</span></a>            
</span><span id="SemanticMemoryManager-1095"><a href="#SemanticMemoryManager-1095"><span class="linenos">1095</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1096"><a href="#SemanticMemoryManager-1096"><span class="linenos">1096</span></a>            <span class="c1"># Get all memories for the user</span>
</span><span id="SemanticMemoryManager-1097"><a href="#SemanticMemoryManager-1097"><span class="linenos">1097</span></a>            <span class="n">memory_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1098"><a href="#SemanticMemoryManager-1098"><span class="linenos">1098</span></a>
</span><span id="SemanticMemoryManager-1099"><a href="#SemanticMemoryManager-1099"><span class="linenos">1099</span></a>            <span class="n">user_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-1100"><a href="#SemanticMemoryManager-1100"><span class="linenos">1100</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">memory_rows</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1101"><a href="#SemanticMemoryManager-1101"><span class="linenos">1101</span></a>                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1102"><a href="#SemanticMemoryManager-1102"><span class="linenos">1102</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1103"><a href="#SemanticMemoryManager-1103"><span class="linenos">1103</span></a>                        <span class="n">user_memory</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1104"><a href="#SemanticMemoryManager-1104"><span class="linenos">1104</span></a>                        <span class="n">user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1105"><a href="#SemanticMemoryManager-1105"><span class="linenos">1105</span></a>                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1106"><a href="#SemanticMemoryManager-1106"><span class="linenos">1106</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1107"><a href="#SemanticMemoryManager-1107"><span class="linenos">1107</span></a>                            <span class="s2">&quot;Failed to convert memory row to UserMemory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span>
</span><span id="SemanticMemoryManager-1108"><a href="#SemanticMemoryManager-1108"><span class="linenos">1108</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager-1109"><a href="#SemanticMemoryManager-1109"><span class="linenos">1109</span></a>
</span><span id="SemanticMemoryManager-1110"><a href="#SemanticMemoryManager-1110"><span class="linenos">1110</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retrieved </span><span class="si">%d</span><span class="s2"> memories for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_memories</span><span class="p">),</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1111"><a href="#SemanticMemoryManager-1111"><span class="linenos">1111</span></a>            <span class="k">return</span> <span class="n">user_memories</span>
</span><span id="SemanticMemoryManager-1112"><a href="#SemanticMemoryManager-1112"><span class="linenos">1112</span></a>
</span><span id="SemanticMemoryManager-1113"><a href="#SemanticMemoryManager-1113"><span class="linenos">1113</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1114"><a href="#SemanticMemoryManager-1114"><span class="linenos">1114</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error retrieving all memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1115"><a href="#SemanticMemoryManager-1115"><span class="linenos">1115</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-1116"><a href="#SemanticMemoryManager-1116"><span class="linenos">1116</span></a>
</span><span id="SemanticMemoryManager-1117"><a href="#SemanticMemoryManager-1117"><span class="linenos">1117</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-1118"><a href="#SemanticMemoryManager-1118"><span class="linenos">1118</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1119"><a href="#SemanticMemoryManager-1119"><span class="linenos">1119</span></a><span class="sd">        Get statistics about memories for a user.</span>
</span><span id="SemanticMemoryManager-1120"><a href="#SemanticMemoryManager-1120"><span class="linenos">1120</span></a>
</span><span id="SemanticMemoryManager-1121"><a href="#SemanticMemoryManager-1121"><span class="linenos">1121</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager-1122"><a href="#SemanticMemoryManager-1122"><span class="linenos">1122</span></a><span class="sd">        :param user_id: User ID to analyze</span>
</span><span id="SemanticMemoryManager-1123"><a href="#SemanticMemoryManager-1123"><span class="linenos">1123</span></a><span class="sd">        :return: Dictionary with memory statistics</span>
</span><span id="SemanticMemoryManager-1124"><a href="#SemanticMemoryManager-1124"><span class="linenos">1124</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1125"><a href="#SemanticMemoryManager-1125"><span class="linenos">1125</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager-1126"><a href="#SemanticMemoryManager-1126"><span class="linenos">1126</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1127"><a href="#SemanticMemoryManager-1127"><span class="linenos">1127</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-1128"><a href="#SemanticMemoryManager-1128"><span class="linenos">1128</span></a>            
</span><span id="SemanticMemoryManager-1129"><a href="#SemanticMemoryManager-1129"><span class="linenos">1129</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1130"><a href="#SemanticMemoryManager-1130"><span class="linenos">1130</span></a>            <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_recent_memories</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1131"><a href="#SemanticMemoryManager-1131"><span class="linenos">1131</span></a>
</span><span id="SemanticMemoryManager-1132"><a href="#SemanticMemoryManager-1132"><span class="linenos">1132</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1133"><a href="#SemanticMemoryManager-1133"><span class="linenos">1133</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total_memories&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="SemanticMemoryManager-1134"><a href="#SemanticMemoryManager-1134"><span class="linenos">1134</span></a>
</span><span id="SemanticMemoryManager-1135"><a href="#SemanticMemoryManager-1135"><span class="linenos">1135</span></a>            <span class="c1"># Topic distribution</span>
</span><span id="SemanticMemoryManager-1136"><a href="#SemanticMemoryManager-1136"><span class="linenos">1136</span></a>            <span class="n">topic_counts</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SemanticMemoryManager-1137"><a href="#SemanticMemoryManager-1137"><span class="linenos">1137</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1138"><a href="#SemanticMemoryManager-1138"><span class="linenos">1138</span></a>                <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1139"><a href="#SemanticMemoryManager-1139"><span class="linenos">1139</span></a>                    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1140"><a href="#SemanticMemoryManager-1140"><span class="linenos">1140</span></a>                        <span class="n">topic_counts</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="o">=</span> <span class="n">topic_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager-1141"><a href="#SemanticMemoryManager-1141"><span class="linenos">1141</span></a>
</span><span id="SemanticMemoryManager-1142"><a href="#SemanticMemoryManager-1142"><span class="linenos">1142</span></a>            <span class="c1"># Average memory length</span>
</span><span id="SemanticMemoryManager-1143"><a href="#SemanticMemoryManager-1143"><span class="linenos">1143</span></a>            <span class="n">avg_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1144"><a href="#SemanticMemoryManager-1144"><span class="linenos">1144</span></a>
</span><span id="SemanticMemoryManager-1145"><a href="#SemanticMemoryManager-1145"><span class="linenos">1145</span></a>            <span class="c1"># Recent activity (memories in last 24 hours)</span>
</span><span id="SemanticMemoryManager-1146"><a href="#SemanticMemoryManager-1146"><span class="linenos">1146</span></a>            <span class="n">recent_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager-1147"><a href="#SemanticMemoryManager-1147"><span class="linenos">1147</span></a>            <span class="k">if</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1148"><a href="#SemanticMemoryManager-1148"><span class="linenos">1148</span></a>                <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1149"><a href="#SemanticMemoryManager-1149"><span class="linenos">1149</span></a>                    <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span>
</span><span id="SemanticMemoryManager-1150"><a href="#SemanticMemoryManager-1150"><span class="linenos">1150</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager-1151"><a href="#SemanticMemoryManager-1151"><span class="linenos">1151</span></a>                <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1152"><a href="#SemanticMemoryManager-1152"><span class="linenos">1152</span></a>                    <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">last_updated</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">&gt;=</span> <span class="n">cutoff</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1153"><a href="#SemanticMemoryManager-1153"><span class="linenos">1153</span></a>                        <span class="n">recent_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager-1154"><a href="#SemanticMemoryManager-1154"><span class="linenos">1154</span></a>
</span><span id="SemanticMemoryManager-1155"><a href="#SemanticMemoryManager-1155"><span class="linenos">1155</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="SemanticMemoryManager-1156"><a href="#SemanticMemoryManager-1156"><span class="linenos">1156</span></a>                <span class="s2">&quot;total_memories&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">),</span>
</span><span id="SemanticMemoryManager-1157"><a href="#SemanticMemoryManager-1157"><span class="linenos">1157</span></a>                <span class="s2">&quot;topic_distribution&quot;</span><span class="p">:</span> <span class="n">topic_counts</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1158"><a href="#SemanticMemoryManager-1158"><span class="linenos">1158</span></a>                <span class="s2">&quot;average_memory_length&quot;</span><span class="p">:</span> <span class="n">avg_length</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1159"><a href="#SemanticMemoryManager-1159"><span class="linenos">1159</span></a>                <span class="s2">&quot;recent_memories_24h&quot;</span><span class="p">:</span> <span class="n">recent_count</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1160"><a href="#SemanticMemoryManager-1160"><span class="linenos">1160</span></a>                <span class="s2">&quot;most_common_topic&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager-1161"><a href="#SemanticMemoryManager-1161"><span class="linenos">1161</span></a>                    <span class="nb">max</span><span class="p">(</span><span class="n">topic_counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SemanticMemoryManager-1162"><a href="#SemanticMemoryManager-1162"><span class="linenos">1162</span></a>                    <span class="k">if</span> <span class="n">topic_counts</span>
</span><span id="SemanticMemoryManager-1163"><a href="#SemanticMemoryManager-1163"><span class="linenos">1163</span></a>                    <span class="k">else</span> <span class="kc">None</span>
</span><span id="SemanticMemoryManager-1164"><a href="#SemanticMemoryManager-1164"><span class="linenos">1164</span></a>                <span class="p">),</span>
</span><span id="SemanticMemoryManager-1165"><a href="#SemanticMemoryManager-1165"><span class="linenos">1165</span></a>            <span class="p">}</span>
</span><span id="SemanticMemoryManager-1166"><a href="#SemanticMemoryManager-1166"><span class="linenos">1166</span></a>
</span><span id="SemanticMemoryManager-1167"><a href="#SemanticMemoryManager-1167"><span class="linenos">1167</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1168"><a href="#SemanticMemoryManager-1168"><span class="linenos">1168</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error getting memory stats: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1169"><a href="#SemanticMemoryManager-1169"><span class="linenos">1169</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</span><span id="SemanticMemoryManager-1170"><a href="#SemanticMemoryManager-1170"><span class="linenos">1170</span></a>
</span><span id="SemanticMemoryManager-1171"><a href="#SemanticMemoryManager-1171"><span class="linenos">1171</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_input</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1172"><a href="#SemanticMemoryManager-1172"><span class="linenos">1172</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1173"><a href="#SemanticMemoryManager-1173"><span class="linenos">1173</span></a>        <span class="n">input_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1174"><a href="#SemanticMemoryManager-1174"><span class="linenos">1174</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1175"><a href="#SemanticMemoryManager-1175"><span class="linenos">1175</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1176"><a href="#SemanticMemoryManager-1176"><span class="linenos">1176</span></a>        <span class="n">extract_multiple</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1177"><a href="#SemanticMemoryManager-1177"><span class="linenos">1177</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-1178"><a href="#SemanticMemoryManager-1178"><span class="linenos">1178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1179"><a href="#SemanticMemoryManager-1179"><span class="linenos">1179</span></a><span class="sd">        Process input text and extract memories without using LLM.</span>
</span><span id="SemanticMemoryManager-1180"><a href="#SemanticMemoryManager-1180"><span class="linenos">1180</span></a>
</span><span id="SemanticMemoryManager-1181"><a href="#SemanticMemoryManager-1181"><span class="linenos">1181</span></a><span class="sd">        This method uses simple heuristics to determine if the input contains</span>
</span><span id="SemanticMemoryManager-1182"><a href="#SemanticMemoryManager-1182"><span class="linenos">1182</span></a><span class="sd">        memorable information and extracts it accordingly.</span>
</span><span id="SemanticMemoryManager-1183"><a href="#SemanticMemoryManager-1183"><span class="linenos">1183</span></a>
</span><span id="SemanticMemoryManager-1184"><a href="#SemanticMemoryManager-1184"><span class="linenos">1184</span></a><span class="sd">        :param input_text: Input text to process</span>
</span><span id="SemanticMemoryManager-1185"><a href="#SemanticMemoryManager-1185"><span class="linenos">1185</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager-1186"><a href="#SemanticMemoryManager-1186"><span class="linenos">1186</span></a><span class="sd">        :param user_id: User ID for the memories</span>
</span><span id="SemanticMemoryManager-1187"><a href="#SemanticMemoryManager-1187"><span class="linenos">1187</span></a><span class="sd">        :param extract_multiple: Whether to try extracting multiple memories from input</span>
</span><span id="SemanticMemoryManager-1188"><a href="#SemanticMemoryManager-1188"><span class="linenos">1188</span></a><span class="sd">        :return: Dictionary with processing results</span>
</span><span id="SemanticMemoryManager-1189"><a href="#SemanticMemoryManager-1189"><span class="linenos">1189</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1190"><a href="#SemanticMemoryManager-1190"><span class="linenos">1190</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SemanticMemoryManager-1191"><a href="#SemanticMemoryManager-1191"><span class="linenos">1191</span></a>            <span class="s2">&quot;memories_added&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="SemanticMemoryManager-1192"><a href="#SemanticMemoryManager-1192"><span class="linenos">1192</span></a>            <span class="s2">&quot;memories_rejected&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="SemanticMemoryManager-1193"><a href="#SemanticMemoryManager-1193"><span class="linenos">1193</span></a>            <span class="s2">&quot;total_processed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1194"><a href="#SemanticMemoryManager-1194"><span class="linenos">1194</span></a>            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1195"><a href="#SemanticMemoryManager-1195"><span class="linenos">1195</span></a>            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Processing completed&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1196"><a href="#SemanticMemoryManager-1196"><span class="linenos">1196</span></a>        <span class="p">}</span>
</span><span id="SemanticMemoryManager-1197"><a href="#SemanticMemoryManager-1197"><span class="linenos">1197</span></a>
</span><span id="SemanticMemoryManager-1198"><a href="#SemanticMemoryManager-1198"><span class="linenos">1198</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1199"><a href="#SemanticMemoryManager-1199"><span class="linenos">1199</span></a>            <span class="c1"># Simple heuristics to extract memorable statements</span>
</span><span id="SemanticMemoryManager-1200"><a href="#SemanticMemoryManager-1200"><span class="linenos">1200</span></a>            <span class="n">memorable_statements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_memorable_statements</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1201"><a href="#SemanticMemoryManager-1201"><span class="linenos">1201</span></a>
</span><span id="SemanticMemoryManager-1202"><a href="#SemanticMemoryManager-1202"><span class="linenos">1202</span></a>            <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">memorable_statements</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1203"><a href="#SemanticMemoryManager-1203"><span class="linenos">1203</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1204"><a href="#SemanticMemoryManager-1204"><span class="linenos">1204</span></a>                    <span class="n">memory_text</span><span class="o">=</span><span class="n">statement</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1205"><a href="#SemanticMemoryManager-1205"><span class="linenos">1205</span></a>                    <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1206"><a href="#SemanticMemoryManager-1206"><span class="linenos">1206</span></a>                    <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1207"><a href="#SemanticMemoryManager-1207"><span class="linenos">1207</span></a>                    <span class="n">input_text</span><span class="o">=</span><span class="n">input_text</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1208"><a href="#SemanticMemoryManager-1208"><span class="linenos">1208</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager-1209"><a href="#SemanticMemoryManager-1209"><span class="linenos">1209</span></a>
</span><span id="SemanticMemoryManager-1210"><a href="#SemanticMemoryManager-1210"><span class="linenos">1210</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;total_processed&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager-1211"><a href="#SemanticMemoryManager-1211"><span class="linenos">1211</span></a>
</span><span id="SemanticMemoryManager-1212"><a href="#SemanticMemoryManager-1212"><span class="linenos">1212</span></a>                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">is_success</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1213"><a href="#SemanticMemoryManager-1213"><span class="linenos">1213</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;memories_added&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1214"><a href="#SemanticMemoryManager-1214"><span class="linenos">1214</span></a>                        <span class="p">{</span>
</span><span id="SemanticMemoryManager-1215"><a href="#SemanticMemoryManager-1215"><span class="linenos">1215</span></a>                            <span class="s2">&quot;memory_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1216"><a href="#SemanticMemoryManager-1216"><span class="linenos">1216</span></a>                            <span class="s2">&quot;memory&quot;</span><span class="p">:</span> <span class="n">statement</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1217"><a href="#SemanticMemoryManager-1217"><span class="linenos">1217</span></a>                            <span class="s2">&quot;topics&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">topics</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1218"><a href="#SemanticMemoryManager-1218"><span class="linenos">1218</span></a>                        <span class="p">}</span>
</span><span id="SemanticMemoryManager-1219"><a href="#SemanticMemoryManager-1219"><span class="linenos">1219</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager-1220"><a href="#SemanticMemoryManager-1220"><span class="linenos">1220</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1221"><a href="#SemanticMemoryManager-1221"><span class="linenos">1221</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;memories_rejected&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1222"><a href="#SemanticMemoryManager-1222"><span class="linenos">1222</span></a>                        <span class="p">{</span><span class="s2">&quot;memory&quot;</span><span class="p">:</span> <span class="n">statement</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="p">}</span>
</span><span id="SemanticMemoryManager-1223"><a href="#SemanticMemoryManager-1223"><span class="linenos">1223</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager-1224"><a href="#SemanticMemoryManager-1224"><span class="linenos">1224</span></a>
</span><span id="SemanticMemoryManager-1225"><a href="#SemanticMemoryManager-1225"><span class="linenos">1225</span></a>            <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;memories_added&quot;</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-1226"><a href="#SemanticMemoryManager-1226"><span class="linenos">1226</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager-1227"><a href="#SemanticMemoryManager-1227"><span class="linenos">1227</span></a>
</span><span id="SemanticMemoryManager-1228"><a href="#SemanticMemoryManager-1228"><span class="linenos">1228</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1229"><a href="#SemanticMemoryManager-1229"><span class="linenos">1229</span></a>            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SemanticMemoryManager-1230"><a href="#SemanticMemoryManager-1230"><span class="linenos">1230</span></a>            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error processing input: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager-1231"><a href="#SemanticMemoryManager-1231"><span class="linenos">1231</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error processing input: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1232"><a href="#SemanticMemoryManager-1232"><span class="linenos">1232</span></a>
</span><span id="SemanticMemoryManager-1233"><a href="#SemanticMemoryManager-1233"><span class="linenos">1233</span></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="SemanticMemoryManager-1234"><a href="#SemanticMemoryManager-1234"><span class="linenos">1234</span></a>
</span><span id="SemanticMemoryManager-1235"><a href="#SemanticMemoryManager-1235"><span class="linenos">1235</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_or_update_memories</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1236"><a href="#SemanticMemoryManager-1236"><span class="linenos">1236</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1237"><a href="#SemanticMemoryManager-1237"><span class="linenos">1237</span></a>        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>  <span class="c1"># List[Message] from agno.models.message</span>
</span><span id="SemanticMemoryManager-1238"><a href="#SemanticMemoryManager-1238"><span class="linenos">1238</span></a>        <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="SemanticMemoryManager-1239"><a href="#SemanticMemoryManager-1239"><span class="linenos">1239</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1240"><a href="#SemanticMemoryManager-1240"><span class="linenos">1240</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1241"><a href="#SemanticMemoryManager-1241"><span class="linenos">1241</span></a>        <span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1242"><a href="#SemanticMemoryManager-1242"><span class="linenos">1242</span></a>        <span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1243"><a href="#SemanticMemoryManager-1243"><span class="linenos">1243</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1244"><a href="#SemanticMemoryManager-1244"><span class="linenos">1244</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1245"><a href="#SemanticMemoryManager-1245"><span class="linenos">1245</span></a><span class="sd">        Create or update memories based on messages - LLM-free implementation.</span>
</span><span id="SemanticMemoryManager-1246"><a href="#SemanticMemoryManager-1246"><span class="linenos">1246</span></a>
</span><span id="SemanticMemoryManager-1247"><a href="#SemanticMemoryManager-1247"><span class="linenos">1247</span></a><span class="sd">        This method provides the same interface as Agno&#39;s MemoryManager but uses</span>
</span><span id="SemanticMemoryManager-1248"><a href="#SemanticMemoryManager-1248"><span class="linenos">1248</span></a><span class="sd">        semantic analysis instead of LLM calls for better performance and reliability.</span>
</span><span id="SemanticMemoryManager-1249"><a href="#SemanticMemoryManager-1249"><span class="linenos">1249</span></a>
</span><span id="SemanticMemoryManager-1250"><a href="#SemanticMemoryManager-1250"><span class="linenos">1250</span></a><span class="sd">        :param messages: List of Message objects to process</span>
</span><span id="SemanticMemoryManager-1251"><a href="#SemanticMemoryManager-1251"><span class="linenos">1251</span></a><span class="sd">        :param existing_memories: List of existing memory dictionaries</span>
</span><span id="SemanticMemoryManager-1252"><a href="#SemanticMemoryManager-1252"><span class="linenos">1252</span></a><span class="sd">        :param user_id: User ID for the memories</span>
</span><span id="SemanticMemoryManager-1253"><a href="#SemanticMemoryManager-1253"><span class="linenos">1253</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager-1254"><a href="#SemanticMemoryManager-1254"><span class="linenos">1254</span></a><span class="sd">        :param delete_memories: Whether deletion is enabled (not used in our implementation)</span>
</span><span id="SemanticMemoryManager-1255"><a href="#SemanticMemoryManager-1255"><span class="linenos">1255</span></a><span class="sd">        :param clear_memories: Whether clearing is enabled (not used in our implementation)</span>
</span><span id="SemanticMemoryManager-1256"><a href="#SemanticMemoryManager-1256"><span class="linenos">1256</span></a><span class="sd">        :return: String describing the actions taken</span>
</span><span id="SemanticMemoryManager-1257"><a href="#SemanticMemoryManager-1257"><span class="linenos">1257</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1258"><a href="#SemanticMemoryManager-1258"><span class="linenos">1258</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SemanticMemoryManager.create_or_update_memories Start&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1259"><a href="#SemanticMemoryManager-1259"><span class="linenos">1259</span></a>
</span><span id="SemanticMemoryManager-1260"><a href="#SemanticMemoryManager-1260"><span class="linenos">1260</span></a>        <span class="c1"># Create a simple memory class for duplicate checking</span>
</span><span id="SemanticMemoryManager-1261"><a href="#SemanticMemoryManager-1261"><span class="linenos">1261</span></a>        <span class="k">class</span><span class="w"> </span><span class="nc">SimpleMemory</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1262"><a href="#SemanticMemoryManager-1262"><span class="linenos">1262</span></a>            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="SemanticMemoryManager-1263"><a href="#SemanticMemoryManager-1263"><span class="linenos">1263</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory_text</span>
</span><span id="SemanticMemoryManager-1264"><a href="#SemanticMemoryManager-1264"><span class="linenos">1264</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">memory_id</span> <span class="o">=</span> <span class="n">memory_id</span>
</span><span id="SemanticMemoryManager-1265"><a href="#SemanticMemoryManager-1265"><span class="linenos">1265</span></a>
</span><span id="SemanticMemoryManager-1266"><a href="#SemanticMemoryManager-1266"><span class="linenos">1266</span></a>        <span class="c1"># Convert existing memories to UserMemory objects for our processing</span>
</span><span id="SemanticMemoryManager-1267"><a href="#SemanticMemoryManager-1267"><span class="linenos">1267</span></a>        <span class="n">existing_user_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-1268"><a href="#SemanticMemoryManager-1268"><span class="linenos">1268</span></a>        <span class="k">for</span> <span class="n">mem_dict</span> <span class="ow">in</span> <span class="n">existing_memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1269"><a href="#SemanticMemoryManager-1269"><span class="linenos">1269</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1270"><a href="#SemanticMemoryManager-1270"><span class="linenos">1270</span></a>                <span class="c1"># Create a UserMemory-like object for our duplicate detection</span>
</span><span id="SemanticMemoryManager-1271"><a href="#SemanticMemoryManager-1271"><span class="linenos">1271</span></a>                <span class="n">memory_text</span> <span class="o">=</span> <span class="n">mem_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1272"><a href="#SemanticMemoryManager-1272"><span class="linenos">1272</span></a>                <span class="k">if</span> <span class="n">memory_text</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1273"><a href="#SemanticMemoryManager-1273"><span class="linenos">1273</span></a>                    <span class="n">existing_user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1274"><a href="#SemanticMemoryManager-1274"><span class="linenos">1274</span></a>                        <span class="n">SimpleMemory</span><span class="p">(</span><span class="n">memory_text</span><span class="p">,</span> <span class="n">mem_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="SemanticMemoryManager-1275"><a href="#SemanticMemoryManager-1275"><span class="linenos">1275</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager-1276"><a href="#SemanticMemoryManager-1276"><span class="linenos">1276</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1277"><a href="#SemanticMemoryManager-1277"><span class="linenos">1277</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process existing memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1278"><a href="#SemanticMemoryManager-1278"><span class="linenos">1278</span></a>
</span><span id="SemanticMemoryManager-1279"><a href="#SemanticMemoryManager-1279"><span class="linenos">1279</span></a>        <span class="c1"># Extract text content from messages</span>
</span><span id="SemanticMemoryManager-1280"><a href="#SemanticMemoryManager-1280"><span class="linenos">1280</span></a>        <span class="n">message_texts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-1281"><a href="#SemanticMemoryManager-1281"><span class="linenos">1281</span></a>        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1282"><a href="#SemanticMemoryManager-1282"><span class="linenos">1282</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1283"><a href="#SemanticMemoryManager-1283"><span class="linenos">1283</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1284"><a href="#SemanticMemoryManager-1284"><span class="linenos">1284</span></a>                    <span class="c1"># Only process user messages for memory extraction</span>
</span><span id="SemanticMemoryManager-1285"><a href="#SemanticMemoryManager-1285"><span class="linenos">1285</span></a>                    <span class="n">message_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
</span><span id="SemanticMemoryManager-1286"><a href="#SemanticMemoryManager-1286"><span class="linenos">1286</span></a>            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;get_content_string&quot;</span><span class="p">):</span>
</span><span id="SemanticMemoryManager-1287"><a href="#SemanticMemoryManager-1287"><span class="linenos">1287</span></a>                <span class="c1"># Use agno&#39;s method to get content</span>
</span><span id="SemanticMemoryManager-1288"><a href="#SemanticMemoryManager-1288"><span class="linenos">1288</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_content_string</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-1289"><a href="#SemanticMemoryManager-1289"><span class="linenos">1289</span></a>                <span class="k">if</span> <span class="n">content</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1290"><a href="#SemanticMemoryManager-1290"><span class="linenos">1290</span></a>                    <span class="n">message_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1291"><a href="#SemanticMemoryManager-1291"><span class="linenos">1291</span></a>
</span><span id="SemanticMemoryManager-1292"><a href="#SemanticMemoryManager-1292"><span class="linenos">1292</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">message_texts</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1293"><a href="#SemanticMemoryManager-1293"><span class="linenos">1293</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No user messages found to process&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1294"><a href="#SemanticMemoryManager-1294"><span class="linenos">1294</span></a>            <span class="k">return</span> <span class="s2">&quot;No user messages to process for memory creation&quot;</span>
</span><span id="SemanticMemoryManager-1295"><a href="#SemanticMemoryManager-1295"><span class="linenos">1295</span></a>
</span><span id="SemanticMemoryManager-1296"><a href="#SemanticMemoryManager-1296"><span class="linenos">1296</span></a>        <span class="c1"># Combine all message texts</span>
</span><span id="SemanticMemoryManager-1297"><a href="#SemanticMemoryManager-1297"><span class="linenos">1297</span></a>        <span class="n">combined_input</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message_texts</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1298"><a href="#SemanticMemoryManager-1298"><span class="linenos">1298</span></a>
</span><span id="SemanticMemoryManager-1299"><a href="#SemanticMemoryManager-1299"><span class="linenos">1299</span></a>        <span class="c1"># Extract memorable statements</span>
</span><span id="SemanticMemoryManager-1300"><a href="#SemanticMemoryManager-1300"><span class="linenos">1300</span></a>        <span class="n">memorable_statements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_memorable_statements</span><span class="p">(</span><span class="n">combined_input</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1301"><a href="#SemanticMemoryManager-1301"><span class="linenos">1301</span></a>
</span><span id="SemanticMemoryManager-1302"><a href="#SemanticMemoryManager-1302"><span class="linenos">1302</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">memorable_statements</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1303"><a href="#SemanticMemoryManager-1303"><span class="linenos">1303</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No memorable statements found in messages&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1304"><a href="#SemanticMemoryManager-1304"><span class="linenos">1304</span></a>            <span class="k">return</span> <span class="s2">&quot;No memorable information found in the messages&quot;</span>
</span><span id="SemanticMemoryManager-1305"><a href="#SemanticMemoryManager-1305"><span class="linenos">1305</span></a>
</span><span id="SemanticMemoryManager-1306"><a href="#SemanticMemoryManager-1306"><span class="linenos">1306</span></a>        <span class="c1"># Process each memorable statement</span>
</span><span id="SemanticMemoryManager-1307"><a href="#SemanticMemoryManager-1307"><span class="linenos">1307</span></a>        <span class="n">actions_taken</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-1308"><a href="#SemanticMemoryManager-1308"><span class="linenos">1308</span></a>        <span class="n">memories_added</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager-1309"><a href="#SemanticMemoryManager-1309"><span class="linenos">1309</span></a>        <span class="n">memories_rejected</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager-1310"><a href="#SemanticMemoryManager-1310"><span class="linenos">1310</span></a>
</span><span id="SemanticMemoryManager-1311"><a href="#SemanticMemoryManager-1311"><span class="linenos">1311</span></a>        <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">memorable_statements</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1312"><a href="#SemanticMemoryManager-1312"><span class="linenos">1312</span></a>            <span class="c1"># Check for duplicates against existing memories</span>
</span><span id="SemanticMemoryManager-1313"><a href="#SemanticMemoryManager-1313"><span class="linenos">1313</span></a>            <span class="n">should_reject</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_reject_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1314"><a href="#SemanticMemoryManager-1314"><span class="linenos">1314</span></a>                <span class="n">statement</span><span class="p">,</span> <span class="n">existing_user_memories</span>
</span><span id="SemanticMemoryManager-1315"><a href="#SemanticMemoryManager-1315"><span class="linenos">1315</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-1316"><a href="#SemanticMemoryManager-1316"><span class="linenos">1316</span></a>
</span><span id="SemanticMemoryManager-1317"><a href="#SemanticMemoryManager-1317"><span class="linenos">1317</span></a>            <span class="k">if</span> <span class="n">should_reject</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1318"><a href="#SemanticMemoryManager-1318"><span class="linenos">1318</span></a>                <span class="n">memories_rejected</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager-1319"><a href="#SemanticMemoryManager-1319"><span class="linenos">1319</span></a>                <span class="n">actions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rejected: &#39;</span><span class="si">{</span><span class="n">statement</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; - </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1320"><a href="#SemanticMemoryManager-1320"><span class="linenos">1320</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rejected memory: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1321"><a href="#SemanticMemoryManager-1321"><span class="linenos">1321</span></a>                <span class="k">continue</span>
</span><span id="SemanticMemoryManager-1322"><a href="#SemanticMemoryManager-1322"><span class="linenos">1322</span></a>
</span><span id="SemanticMemoryManager-1323"><a href="#SemanticMemoryManager-1323"><span class="linenos">1323</span></a>            <span class="c1"># Add the memory</span>
</span><span id="SemanticMemoryManager-1324"><a href="#SemanticMemoryManager-1324"><span class="linenos">1324</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1325"><a href="#SemanticMemoryManager-1325"><span class="linenos">1325</span></a>                <span class="n">memory_text</span><span class="o">=</span><span class="n">statement</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1326"><a href="#SemanticMemoryManager-1326"><span class="linenos">1326</span></a>                <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1327"><a href="#SemanticMemoryManager-1327"><span class="linenos">1327</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1328"><a href="#SemanticMemoryManager-1328"><span class="linenos">1328</span></a>                <span class="n">input_text</span><span class="o">=</span><span class="n">combined_input</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1329"><a href="#SemanticMemoryManager-1329"><span class="linenos">1329</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager-1330"><a href="#SemanticMemoryManager-1330"><span class="linenos">1330</span></a>
</span><span id="SemanticMemoryManager-1331"><a href="#SemanticMemoryManager-1331"><span class="linenos">1331</span></a>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">is_success</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1332"><a href="#SemanticMemoryManager-1332"><span class="linenos">1332</span></a>                <span class="n">memories_added</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager-1333"><a href="#SemanticMemoryManager-1333"><span class="linenos">1333</span></a>                <span class="n">actions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added: &#39;</span><span class="si">{</span><span class="n">statement</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1334"><a href="#SemanticMemoryManager-1334"><span class="linenos">1334</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added memory: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1335"><a href="#SemanticMemoryManager-1335"><span class="linenos">1335</span></a>
</span><span id="SemanticMemoryManager-1336"><a href="#SemanticMemoryManager-1336"><span class="linenos">1336</span></a>                <span class="c1"># Add to existing memories list for subsequent duplicate checking</span>
</span><span id="SemanticMemoryManager-1337"><a href="#SemanticMemoryManager-1337"><span class="linenos">1337</span></a>                <span class="n">existing_user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SimpleMemory</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">memory_id</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="SemanticMemoryManager-1338"><a href="#SemanticMemoryManager-1338"><span class="linenos">1338</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1339"><a href="#SemanticMemoryManager-1339"><span class="linenos">1339</span></a>                <span class="n">memories_rejected</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager-1340"><a href="#SemanticMemoryManager-1340"><span class="linenos">1340</span></a>                <span class="n">actions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1341"><a href="#SemanticMemoryManager-1341"><span class="linenos">1341</span></a>                    <span class="sa">f</span><span class="s2">&quot;Failed to add: &#39;</span><span class="si">{</span><span class="n">statement</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; - </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager-1342"><a href="#SemanticMemoryManager-1342"><span class="linenos">1342</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager-1343"><a href="#SemanticMemoryManager-1343"><span class="linenos">1343</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to add memory: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1344"><a href="#SemanticMemoryManager-1344"><span class="linenos">1344</span></a>
</span><span id="SemanticMemoryManager-1345"><a href="#SemanticMemoryManager-1345"><span class="linenos">1345</span></a>        <span class="c1"># Set memories_updated flag if any memories were added</span>
</span><span id="SemanticMemoryManager-1346"><a href="#SemanticMemoryManager-1346"><span class="linenos">1346</span></a>        <span class="k">if</span> <span class="n">memories_added</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1347"><a href="#SemanticMemoryManager-1347"><span class="linenos">1347</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager-1348"><a href="#SemanticMemoryManager-1348"><span class="linenos">1348</span></a>
</span><span id="SemanticMemoryManager-1349"><a href="#SemanticMemoryManager-1349"><span class="linenos">1349</span></a>        <span class="c1"># Create response summary</span>
</span><span id="SemanticMemoryManager-1350"><a href="#SemanticMemoryManager-1350"><span class="linenos">1350</span></a>        <span class="n">response_parts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SemanticMemoryManager-1351"><a href="#SemanticMemoryManager-1351"><span class="linenos">1351</span></a>            <span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memorable_statements</span><span class="p">)</span><span class="si">}</span><span class="s2"> memorable statements&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1352"><a href="#SemanticMemoryManager-1352"><span class="linenos">1352</span></a>            <span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">memories_added</span><span class="si">}</span><span class="s2"> new memories&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1353"><a href="#SemanticMemoryManager-1353"><span class="linenos">1353</span></a>            <span class="sa">f</span><span class="s2">&quot;Rejected </span><span class="si">{</span><span class="n">memories_rejected</span><span class="si">}</span><span class="s2"> duplicates/invalid memories&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1354"><a href="#SemanticMemoryManager-1354"><span class="linenos">1354</span></a>        <span class="p">]</span>
</span><span id="SemanticMemoryManager-1355"><a href="#SemanticMemoryManager-1355"><span class="linenos">1355</span></a>
</span><span id="SemanticMemoryManager-1356"><a href="#SemanticMemoryManager-1356"><span class="linenos">1356</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="ow">and</span> <span class="n">actions_taken</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1357"><a href="#SemanticMemoryManager-1357"><span class="linenos">1357</span></a>            <span class="n">response_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Actions taken:&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1358"><a href="#SemanticMemoryManager-1358"><span class="linenos">1358</span></a>            <span class="n">response_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">actions_taken</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>  <span class="c1"># Limit to first 5 actions</span>
</span><span id="SemanticMemoryManager-1359"><a href="#SemanticMemoryManager-1359"><span class="linenos">1359</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions_taken</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1360"><a href="#SemanticMemoryManager-1360"><span class="linenos">1360</span></a>                <span class="n">response_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">actions_taken</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more actions&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1361"><a href="#SemanticMemoryManager-1361"><span class="linenos">1361</span></a>
</span><span id="SemanticMemoryManager-1362"><a href="#SemanticMemoryManager-1362"><span class="linenos">1362</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;. &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">response_parts</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1363"><a href="#SemanticMemoryManager-1363"><span class="linenos">1363</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SemanticMemoryManager.create_or_update_memories End&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1364"><a href="#SemanticMemoryManager-1364"><span class="linenos">1364</span></a>
</span><span id="SemanticMemoryManager-1365"><a href="#SemanticMemoryManager-1365"><span class="linenos">1365</span></a>        <span class="k">return</span> <span class="n">response</span>
</span><span id="SemanticMemoryManager-1366"><a href="#SemanticMemoryManager-1366"><span class="linenos">1366</span></a>
</span><span id="SemanticMemoryManager-1367"><a href="#SemanticMemoryManager-1367"><span class="linenos">1367</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">acreate_or_update_memories</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1368"><a href="#SemanticMemoryManager-1368"><span class="linenos">1368</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1369"><a href="#SemanticMemoryManager-1369"><span class="linenos">1369</span></a>        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>  <span class="c1"># List[Message] from agno.models.message</span>
</span><span id="SemanticMemoryManager-1370"><a href="#SemanticMemoryManager-1370"><span class="linenos">1370</span></a>        <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="SemanticMemoryManager-1371"><a href="#SemanticMemoryManager-1371"><span class="linenos">1371</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1372"><a href="#SemanticMemoryManager-1372"><span class="linenos">1372</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1373"><a href="#SemanticMemoryManager-1373"><span class="linenos">1373</span></a>        <span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1374"><a href="#SemanticMemoryManager-1374"><span class="linenos">1374</span></a>        <span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1375"><a href="#SemanticMemoryManager-1375"><span class="linenos">1375</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1376"><a href="#SemanticMemoryManager-1376"><span class="linenos">1376</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1377"><a href="#SemanticMemoryManager-1377"><span class="linenos">1377</span></a><span class="sd">        Async version of create_or_update_memories.</span>
</span><span id="SemanticMemoryManager-1378"><a href="#SemanticMemoryManager-1378"><span class="linenos">1378</span></a>
</span><span id="SemanticMemoryManager-1379"><a href="#SemanticMemoryManager-1379"><span class="linenos">1379</span></a><span class="sd">        Since our implementation doesn&#39;t use async operations, this just calls</span>
</span><span id="SemanticMemoryManager-1380"><a href="#SemanticMemoryManager-1380"><span class="linenos">1380</span></a><span class="sd">        the sync version. This maintains compatibility with Agno&#39;s async interface.</span>
</span><span id="SemanticMemoryManager-1381"><a href="#SemanticMemoryManager-1381"><span class="linenos">1381</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1382"><a href="#SemanticMemoryManager-1382"><span class="linenos">1382</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_or_update_memories</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1383"><a href="#SemanticMemoryManager-1383"><span class="linenos">1383</span></a>            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1384"><a href="#SemanticMemoryManager-1384"><span class="linenos">1384</span></a>            <span class="n">existing_memories</span><span class="o">=</span><span class="n">existing_memories</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1385"><a href="#SemanticMemoryManager-1385"><span class="linenos">1385</span></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1386"><a href="#SemanticMemoryManager-1386"><span class="linenos">1386</span></a>            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1387"><a href="#SemanticMemoryManager-1387"><span class="linenos">1387</span></a>            <span class="n">delete_memories</span><span class="o">=</span><span class="n">delete_memories</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1388"><a href="#SemanticMemoryManager-1388"><span class="linenos">1388</span></a>            <span class="n">clear_memories</span><span class="o">=</span><span class="n">clear_memories</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1389"><a href="#SemanticMemoryManager-1389"><span class="linenos">1389</span></a>        <span class="p">)</span>
</span><span id="SemanticMemoryManager-1390"><a href="#SemanticMemoryManager-1390"><span class="linenos">1390</span></a>
</span><span id="SemanticMemoryManager-1391"><a href="#SemanticMemoryManager-1391"><span class="linenos">1391</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run_memory_task</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1392"><a href="#SemanticMemoryManager-1392"><span class="linenos">1392</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1393"><a href="#SemanticMemoryManager-1393"><span class="linenos">1393</span></a>        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1394"><a href="#SemanticMemoryManager-1394"><span class="linenos">1394</span></a>        <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="SemanticMemoryManager-1395"><a href="#SemanticMemoryManager-1395"><span class="linenos">1395</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1396"><a href="#SemanticMemoryManager-1396"><span class="linenos">1396</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1397"><a href="#SemanticMemoryManager-1397"><span class="linenos">1397</span></a>        <span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1398"><a href="#SemanticMemoryManager-1398"><span class="linenos">1398</span></a>        <span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1399"><a href="#SemanticMemoryManager-1399"><span class="linenos">1399</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1400"><a href="#SemanticMemoryManager-1400"><span class="linenos">1400</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1401"><a href="#SemanticMemoryManager-1401"><span class="linenos">1401</span></a><span class="sd">        Process a memory task without using LLM.</span>
</span><span id="SemanticMemoryManager-1402"><a href="#SemanticMemoryManager-1402"><span class="linenos">1402</span></a>
</span><span id="SemanticMemoryManager-1403"><a href="#SemanticMemoryManager-1403"><span class="linenos">1403</span></a><span class="sd">        This method provides the same interface as Agno&#39;s MemoryManager.run_memory_task</span>
</span><span id="SemanticMemoryManager-1404"><a href="#SemanticMemoryManager-1404"><span class="linenos">1404</span></a><span class="sd">        but uses semantic analysis instead of LLM calls for better performance and reliability.</span>
</span><span id="SemanticMemoryManager-1405"><a href="#SemanticMemoryManager-1405"><span class="linenos">1405</span></a>
</span><span id="SemanticMemoryManager-1406"><a href="#SemanticMemoryManager-1406"><span class="linenos">1406</span></a><span class="sd">        :param task: The task/input text to process for memory extraction</span>
</span><span id="SemanticMemoryManager-1407"><a href="#SemanticMemoryManager-1407"><span class="linenos">1407</span></a><span class="sd">        :param existing_memories: List of existing memory dictionaries</span>
</span><span id="SemanticMemoryManager-1408"><a href="#SemanticMemoryManager-1408"><span class="linenos">1408</span></a><span class="sd">        :param user_id: User ID for the memories</span>
</span><span id="SemanticMemoryManager-1409"><a href="#SemanticMemoryManager-1409"><span class="linenos">1409</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager-1410"><a href="#SemanticMemoryManager-1410"><span class="linenos">1410</span></a><span class="sd">        :param delete_memories: Whether deletion is enabled (not used in our implementation)</span>
</span><span id="SemanticMemoryManager-1411"><a href="#SemanticMemoryManager-1411"><span class="linenos">1411</span></a><span class="sd">        :param clear_memories: Whether clearing is enabled (not used in our implementation)</span>
</span><span id="SemanticMemoryManager-1412"><a href="#SemanticMemoryManager-1412"><span class="linenos">1412</span></a><span class="sd">        :return: String describing the actions taken</span>
</span><span id="SemanticMemoryManager-1413"><a href="#SemanticMemoryManager-1413"><span class="linenos">1413</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1414"><a href="#SemanticMemoryManager-1414"><span class="linenos">1414</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SemanticMemoryManager.run_memory_task Start&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1415"><a href="#SemanticMemoryManager-1415"><span class="linenos">1415</span></a>
</span><span id="SemanticMemoryManager-1416"><a href="#SemanticMemoryManager-1416"><span class="linenos">1416</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1417"><a href="#SemanticMemoryManager-1417"><span class="linenos">1417</span></a>            <span class="c1"># Extract memorable statements from the task</span>
</span><span id="SemanticMemoryManager-1418"><a href="#SemanticMemoryManager-1418"><span class="linenos">1418</span></a>            <span class="n">memorable_statements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_memorable_statements</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1419"><a href="#SemanticMemoryManager-1419"><span class="linenos">1419</span></a>
</span><span id="SemanticMemoryManager-1420"><a href="#SemanticMemoryManager-1420"><span class="linenos">1420</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memorable_statements</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1421"><a href="#SemanticMemoryManager-1421"><span class="linenos">1421</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No memorable statements found in task&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1422"><a href="#SemanticMemoryManager-1422"><span class="linenos">1422</span></a>                <span class="k">return</span> <span class="s2">&quot;No memorable information found in the task&quot;</span>
</span><span id="SemanticMemoryManager-1423"><a href="#SemanticMemoryManager-1423"><span class="linenos">1423</span></a>
</span><span id="SemanticMemoryManager-1424"><a href="#SemanticMemoryManager-1424"><span class="linenos">1424</span></a>            <span class="c1"># Convert existing memories to UserMemory-like objects for duplicate checking</span>
</span><span id="SemanticMemoryManager-1425"><a href="#SemanticMemoryManager-1425"><span class="linenos">1425</span></a>            <span class="k">class</span><span class="w"> </span><span class="nc">SimpleMemory</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1426"><a href="#SemanticMemoryManager-1426"><span class="linenos">1426</span></a>                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="SemanticMemoryManager-1427"><a href="#SemanticMemoryManager-1427"><span class="linenos">1427</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory_text</span>
</span><span id="SemanticMemoryManager-1428"><a href="#SemanticMemoryManager-1428"><span class="linenos">1428</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">memory_id</span> <span class="o">=</span> <span class="n">memory_id</span>
</span><span id="SemanticMemoryManager-1429"><a href="#SemanticMemoryManager-1429"><span class="linenos">1429</span></a>
</span><span id="SemanticMemoryManager-1430"><a href="#SemanticMemoryManager-1430"><span class="linenos">1430</span></a>            <span class="n">existing_user_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-1431"><a href="#SemanticMemoryManager-1431"><span class="linenos">1431</span></a>            <span class="k">for</span> <span class="n">mem_dict</span> <span class="ow">in</span> <span class="n">existing_memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1432"><a href="#SemanticMemoryManager-1432"><span class="linenos">1432</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1433"><a href="#SemanticMemoryManager-1433"><span class="linenos">1433</span></a>                    <span class="n">memory_text</span> <span class="o">=</span> <span class="n">mem_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1434"><a href="#SemanticMemoryManager-1434"><span class="linenos">1434</span></a>                    <span class="k">if</span> <span class="n">memory_text</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1435"><a href="#SemanticMemoryManager-1435"><span class="linenos">1435</span></a>                        <span class="n">existing_user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1436"><a href="#SemanticMemoryManager-1436"><span class="linenos">1436</span></a>                            <span class="n">SimpleMemory</span><span class="p">(</span><span class="n">memory_text</span><span class="p">,</span> <span class="n">mem_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="SemanticMemoryManager-1437"><a href="#SemanticMemoryManager-1437"><span class="linenos">1437</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager-1438"><a href="#SemanticMemoryManager-1438"><span class="linenos">1438</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1439"><a href="#SemanticMemoryManager-1439"><span class="linenos">1439</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process existing memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1440"><a href="#SemanticMemoryManager-1440"><span class="linenos">1440</span></a>
</span><span id="SemanticMemoryManager-1441"><a href="#SemanticMemoryManager-1441"><span class="linenos">1441</span></a>            <span class="c1"># Process each memorable statement</span>
</span><span id="SemanticMemoryManager-1442"><a href="#SemanticMemoryManager-1442"><span class="linenos">1442</span></a>            <span class="n">actions_taken</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-1443"><a href="#SemanticMemoryManager-1443"><span class="linenos">1443</span></a>            <span class="n">memories_added</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager-1444"><a href="#SemanticMemoryManager-1444"><span class="linenos">1444</span></a>            <span class="n">memories_rejected</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager-1445"><a href="#SemanticMemoryManager-1445"><span class="linenos">1445</span></a>
</span><span id="SemanticMemoryManager-1446"><a href="#SemanticMemoryManager-1446"><span class="linenos">1446</span></a>            <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">memorable_statements</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1447"><a href="#SemanticMemoryManager-1447"><span class="linenos">1447</span></a>                <span class="c1"># Check for duplicates against existing memories</span>
</span><span id="SemanticMemoryManager-1448"><a href="#SemanticMemoryManager-1448"><span class="linenos">1448</span></a>                <span class="n">should_reject</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_reject_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1449"><a href="#SemanticMemoryManager-1449"><span class="linenos">1449</span></a>                    <span class="n">statement</span><span class="p">,</span> <span class="n">existing_user_memories</span>
</span><span id="SemanticMemoryManager-1450"><a href="#SemanticMemoryManager-1450"><span class="linenos">1450</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager-1451"><a href="#SemanticMemoryManager-1451"><span class="linenos">1451</span></a>
</span><span id="SemanticMemoryManager-1452"><a href="#SemanticMemoryManager-1452"><span class="linenos">1452</span></a>                <span class="k">if</span> <span class="n">should_reject</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1453"><a href="#SemanticMemoryManager-1453"><span class="linenos">1453</span></a>                    <span class="n">memories_rejected</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager-1454"><a href="#SemanticMemoryManager-1454"><span class="linenos">1454</span></a>                    <span class="n">actions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rejected: &#39;</span><span class="si">{</span><span class="n">statement</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; - </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1455"><a href="#SemanticMemoryManager-1455"><span class="linenos">1455</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rejected memory: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1456"><a href="#SemanticMemoryManager-1456"><span class="linenos">1456</span></a>                    <span class="k">continue</span>
</span><span id="SemanticMemoryManager-1457"><a href="#SemanticMemoryManager-1457"><span class="linenos">1457</span></a>
</span><span id="SemanticMemoryManager-1458"><a href="#SemanticMemoryManager-1458"><span class="linenos">1458</span></a>                <span class="c1"># Add the memory</span>
</span><span id="SemanticMemoryManager-1459"><a href="#SemanticMemoryManager-1459"><span class="linenos">1459</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1460"><a href="#SemanticMemoryManager-1460"><span class="linenos">1460</span></a>                    <span class="n">memory_text</span><span class="o">=</span><span class="n">statement</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1461"><a href="#SemanticMemoryManager-1461"><span class="linenos">1461</span></a>                    <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1462"><a href="#SemanticMemoryManager-1462"><span class="linenos">1462</span></a>                    <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1463"><a href="#SemanticMemoryManager-1463"><span class="linenos">1463</span></a>                    <span class="n">input_text</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1464"><a href="#SemanticMemoryManager-1464"><span class="linenos">1464</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager-1465"><a href="#SemanticMemoryManager-1465"><span class="linenos">1465</span></a>
</span><span id="SemanticMemoryManager-1466"><a href="#SemanticMemoryManager-1466"><span class="linenos">1466</span></a>                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">is_success</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1467"><a href="#SemanticMemoryManager-1467"><span class="linenos">1467</span></a>                    <span class="n">memories_added</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager-1468"><a href="#SemanticMemoryManager-1468"><span class="linenos">1468</span></a>                    <span class="n">actions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added: &#39;</span><span class="si">{</span><span class="n">statement</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1469"><a href="#SemanticMemoryManager-1469"><span class="linenos">1469</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added memory: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1470"><a href="#SemanticMemoryManager-1470"><span class="linenos">1470</span></a>
</span><span id="SemanticMemoryManager-1471"><a href="#SemanticMemoryManager-1471"><span class="linenos">1471</span></a>                    <span class="c1"># Add to existing memories list for subsequent duplicate checking</span>
</span><span id="SemanticMemoryManager-1472"><a href="#SemanticMemoryManager-1472"><span class="linenos">1472</span></a>                    <span class="n">existing_user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1473"><a href="#SemanticMemoryManager-1473"><span class="linenos">1473</span></a>                        <span class="n">SimpleMemory</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">memory_id</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1474"><a href="#SemanticMemoryManager-1474"><span class="linenos">1474</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager-1475"><a href="#SemanticMemoryManager-1475"><span class="linenos">1475</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1476"><a href="#SemanticMemoryManager-1476"><span class="linenos">1476</span></a>                    <span class="n">memories_rejected</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager-1477"><a href="#SemanticMemoryManager-1477"><span class="linenos">1477</span></a>                    <span class="n">actions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1478"><a href="#SemanticMemoryManager-1478"><span class="linenos">1478</span></a>                        <span class="sa">f</span><span class="s2">&quot;Failed to add: &#39;</span><span class="si">{</span><span class="n">statement</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; - </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager-1479"><a href="#SemanticMemoryManager-1479"><span class="linenos">1479</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager-1480"><a href="#SemanticMemoryManager-1480"><span class="linenos">1480</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to add memory: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1481"><a href="#SemanticMemoryManager-1481"><span class="linenos">1481</span></a>
</span><span id="SemanticMemoryManager-1482"><a href="#SemanticMemoryManager-1482"><span class="linenos">1482</span></a>            <span class="c1"># Set memories_updated flag if any memories were added</span>
</span><span id="SemanticMemoryManager-1483"><a href="#SemanticMemoryManager-1483"><span class="linenos">1483</span></a>            <span class="k">if</span> <span class="n">memories_added</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1484"><a href="#SemanticMemoryManager-1484"><span class="linenos">1484</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager-1485"><a href="#SemanticMemoryManager-1485"><span class="linenos">1485</span></a>
</span><span id="SemanticMemoryManager-1486"><a href="#SemanticMemoryManager-1486"><span class="linenos">1486</span></a>            <span class="c1"># Create response summary</span>
</span><span id="SemanticMemoryManager-1487"><a href="#SemanticMemoryManager-1487"><span class="linenos">1487</span></a>            <span class="n">response_parts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SemanticMemoryManager-1488"><a href="#SemanticMemoryManager-1488"><span class="linenos">1488</span></a>                <span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memorable_statements</span><span class="p">)</span><span class="si">}</span><span class="s2"> memorable statements&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1489"><a href="#SemanticMemoryManager-1489"><span class="linenos">1489</span></a>                <span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">memories_added</span><span class="si">}</span><span class="s2"> new memories&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1490"><a href="#SemanticMemoryManager-1490"><span class="linenos">1490</span></a>                <span class="sa">f</span><span class="s2">&quot;Rejected </span><span class="si">{</span><span class="n">memories_rejected</span><span class="si">}</span><span class="s2"> duplicates/invalid memories&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1491"><a href="#SemanticMemoryManager-1491"><span class="linenos">1491</span></a>            <span class="p">]</span>
</span><span id="SemanticMemoryManager-1492"><a href="#SemanticMemoryManager-1492"><span class="linenos">1492</span></a>
</span><span id="SemanticMemoryManager-1493"><a href="#SemanticMemoryManager-1493"><span class="linenos">1493</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="ow">and</span> <span class="n">actions_taken</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1494"><a href="#SemanticMemoryManager-1494"><span class="linenos">1494</span></a>                <span class="n">response_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Actions taken:&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1495"><a href="#SemanticMemoryManager-1495"><span class="linenos">1495</span></a>                <span class="n">response_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">actions_taken</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>  <span class="c1"># Limit to first 5 actions</span>
</span><span id="SemanticMemoryManager-1496"><a href="#SemanticMemoryManager-1496"><span class="linenos">1496</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions_taken</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1497"><a href="#SemanticMemoryManager-1497"><span class="linenos">1497</span></a>                    <span class="n">response_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1498"><a href="#SemanticMemoryManager-1498"><span class="linenos">1498</span></a>                        <span class="sa">f</span><span class="s2">&quot;... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">actions_taken</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more actions&quot;</span>
</span><span id="SemanticMemoryManager-1499"><a href="#SemanticMemoryManager-1499"><span class="linenos">1499</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager-1500"><a href="#SemanticMemoryManager-1500"><span class="linenos">1500</span></a>
</span><span id="SemanticMemoryManager-1501"><a href="#SemanticMemoryManager-1501"><span class="linenos">1501</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;. &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">response_parts</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1502"><a href="#SemanticMemoryManager-1502"><span class="linenos">1502</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SemanticMemoryManager.run_memory_task End&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1503"><a href="#SemanticMemoryManager-1503"><span class="linenos">1503</span></a>
</span><span id="SemanticMemoryManager-1504"><a href="#SemanticMemoryManager-1504"><span class="linenos">1504</span></a>            <span class="k">return</span> <span class="n">response</span>
</span><span id="SemanticMemoryManager-1505"><a href="#SemanticMemoryManager-1505"><span class="linenos">1505</span></a>
</span><span id="SemanticMemoryManager-1506"><a href="#SemanticMemoryManager-1506"><span class="linenos">1506</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1507"><a href="#SemanticMemoryManager-1507"><span class="linenos">1507</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error in run_memory_task: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager-1508"><a href="#SemanticMemoryManager-1508"><span class="linenos">1508</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1509"><a href="#SemanticMemoryManager-1509"><span class="linenos">1509</span></a>            <span class="k">return</span> <span class="n">error_msg</span>
</span><span id="SemanticMemoryManager-1510"><a href="#SemanticMemoryManager-1510"><span class="linenos">1510</span></a>
</span><span id="SemanticMemoryManager-1511"><a href="#SemanticMemoryManager-1511"><span class="linenos">1511</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">arun_memory_task</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1512"><a href="#SemanticMemoryManager-1512"><span class="linenos">1512</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1513"><a href="#SemanticMemoryManager-1513"><span class="linenos">1513</span></a>        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1514"><a href="#SemanticMemoryManager-1514"><span class="linenos">1514</span></a>        <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="SemanticMemoryManager-1515"><a href="#SemanticMemoryManager-1515"><span class="linenos">1515</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1516"><a href="#SemanticMemoryManager-1516"><span class="linenos">1516</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1517"><a href="#SemanticMemoryManager-1517"><span class="linenos">1517</span></a>        <span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1518"><a href="#SemanticMemoryManager-1518"><span class="linenos">1518</span></a>        <span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1519"><a href="#SemanticMemoryManager-1519"><span class="linenos">1519</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1520"><a href="#SemanticMemoryManager-1520"><span class="linenos">1520</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1521"><a href="#SemanticMemoryManager-1521"><span class="linenos">1521</span></a><span class="sd">        Async version of run_memory_task.</span>
</span><span id="SemanticMemoryManager-1522"><a href="#SemanticMemoryManager-1522"><span class="linenos">1522</span></a>
</span><span id="SemanticMemoryManager-1523"><a href="#SemanticMemoryManager-1523"><span class="linenos">1523</span></a><span class="sd">        Since our implementation doesn&#39;t use async operations, this just calls</span>
</span><span id="SemanticMemoryManager-1524"><a href="#SemanticMemoryManager-1524"><span class="linenos">1524</span></a><span class="sd">        the sync version. This maintains compatibility with Agno&#39;s async interface.</span>
</span><span id="SemanticMemoryManager-1525"><a href="#SemanticMemoryManager-1525"><span class="linenos">1525</span></a>
</span><span id="SemanticMemoryManager-1526"><a href="#SemanticMemoryManager-1526"><span class="linenos">1526</span></a><span class="sd">        :param task: The task/input text to process for memory extraction</span>
</span><span id="SemanticMemoryManager-1527"><a href="#SemanticMemoryManager-1527"><span class="linenos">1527</span></a><span class="sd">        :param existing_memories: List of existing memory dictionaries</span>
</span><span id="SemanticMemoryManager-1528"><a href="#SemanticMemoryManager-1528"><span class="linenos">1528</span></a><span class="sd">        :param user_id: User ID for the memories</span>
</span><span id="SemanticMemoryManager-1529"><a href="#SemanticMemoryManager-1529"><span class="linenos">1529</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager-1530"><a href="#SemanticMemoryManager-1530"><span class="linenos">1530</span></a><span class="sd">        :param delete_memories: Whether deletion is enabled (not used in our implementation)</span>
</span><span id="SemanticMemoryManager-1531"><a href="#SemanticMemoryManager-1531"><span class="linenos">1531</span></a><span class="sd">        :param clear_memories: Whether clearing is enabled (not used in our implementation)</span>
</span><span id="SemanticMemoryManager-1532"><a href="#SemanticMemoryManager-1532"><span class="linenos">1532</span></a><span class="sd">        :return: String describing the actions taken</span>
</span><span id="SemanticMemoryManager-1533"><a href="#SemanticMemoryManager-1533"><span class="linenos">1533</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1534"><a href="#SemanticMemoryManager-1534"><span class="linenos">1534</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_memory_task</span><span class="p">(</span>
</span><span id="SemanticMemoryManager-1535"><a href="#SemanticMemoryManager-1535"><span class="linenos">1535</span></a>            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1536"><a href="#SemanticMemoryManager-1536"><span class="linenos">1536</span></a>            <span class="n">existing_memories</span><span class="o">=</span><span class="n">existing_memories</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1537"><a href="#SemanticMemoryManager-1537"><span class="linenos">1537</span></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1538"><a href="#SemanticMemoryManager-1538"><span class="linenos">1538</span></a>            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1539"><a href="#SemanticMemoryManager-1539"><span class="linenos">1539</span></a>            <span class="n">delete_memories</span><span class="o">=</span><span class="n">delete_memories</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1540"><a href="#SemanticMemoryManager-1540"><span class="linenos">1540</span></a>            <span class="n">clear_memories</span><span class="o">=</span><span class="n">clear_memories</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1541"><a href="#SemanticMemoryManager-1541"><span class="linenos">1541</span></a>        <span class="p">)</span>
</span><span id="SemanticMemoryManager-1542"><a href="#SemanticMemoryManager-1542"><span class="linenos">1542</span></a>
</span><span id="SemanticMemoryManager-1543"><a href="#SemanticMemoryManager-1543"><span class="linenos">1543</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_memorable_statements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager-1544"><a href="#SemanticMemoryManager-1544"><span class="linenos">1544</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1545"><a href="#SemanticMemoryManager-1545"><span class="linenos">1545</span></a><span class="sd">        Extract memorable statements from text using simple heuristics.</span>
</span><span id="SemanticMemoryManager-1546"><a href="#SemanticMemoryManager-1546"><span class="linenos">1546</span></a>
</span><span id="SemanticMemoryManager-1547"><a href="#SemanticMemoryManager-1547"><span class="linenos">1547</span></a><span class="sd">        :param text: Input text</span>
</span><span id="SemanticMemoryManager-1548"><a href="#SemanticMemoryManager-1548"><span class="linenos">1548</span></a><span class="sd">        :return: List of memorable statements</span>
</span><span id="SemanticMemoryManager-1549"><a href="#SemanticMemoryManager-1549"><span class="linenos">1549</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager-1550"><a href="#SemanticMemoryManager-1550"><span class="linenos">1550</span></a>        <span class="n">statements</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager-1551"><a href="#SemanticMemoryManager-1551"><span class="linenos">1551</span></a>
</span><span id="SemanticMemoryManager-1552"><a href="#SemanticMemoryManager-1552"><span class="linenos">1552</span></a>        <span class="c1"># Split by sentences</span>
</span><span id="SemanticMemoryManager-1553"><a href="#SemanticMemoryManager-1553"><span class="linenos">1553</span></a>        <span class="n">sentences</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[.!?]+&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1554"><a href="#SemanticMemoryManager-1554"><span class="linenos">1554</span></a>
</span><span id="SemanticMemoryManager-1555"><a href="#SemanticMemoryManager-1555"><span class="linenos">1555</span></a>        <span class="c1"># Patterns that indicate memorable information</span>
</span><span id="SemanticMemoryManager-1556"><a href="#SemanticMemoryManager-1556"><span class="linenos">1556</span></a>        <span class="n">memorable_patterns</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SemanticMemoryManager-1557"><a href="#SemanticMemoryManager-1557"><span class="linenos">1557</span></a>            <span class="sa">r</span><span class="s2">&quot;\bi am\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1558"><a href="#SemanticMemoryManager-1558"><span class="linenos">1558</span></a>            <span class="sa">r</span><span class="s2">&quot;\bmy name is\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1559"><a href="#SemanticMemoryManager-1559"><span class="linenos">1559</span></a>            <span class="sa">r</span><span class="s2">&quot;\bi work\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1560"><a href="#SemanticMemoryManager-1560"><span class="linenos">1560</span></a>            <span class="sa">r</span><span class="s2">&quot;\bi live\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1561"><a href="#SemanticMemoryManager-1561"><span class="linenos">1561</span></a>            <span class="sa">r</span><span class="s2">&quot;\bi like\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1562"><a href="#SemanticMemoryManager-1562"><span class="linenos">1562</span></a>            <span class="sa">r</span><span class="s2">&quot;\bi love\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1563"><a href="#SemanticMemoryManager-1563"><span class="linenos">1563</span></a>            <span class="sa">r</span><span class="s2">&quot;\bi hate\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1564"><a href="#SemanticMemoryManager-1564"><span class="linenos">1564</span></a>            <span class="sa">r</span><span class="s2">&quot;\bi prefer\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1565"><a href="#SemanticMemoryManager-1565"><span class="linenos">1565</span></a>            <span class="sa">r</span><span class="s2">&quot;\bi have\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1566"><a href="#SemanticMemoryManager-1566"><span class="linenos">1566</span></a>            <span class="sa">r</span><span class="s2">&quot;\bi study\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1567"><a href="#SemanticMemoryManager-1567"><span class="linenos">1567</span></a>            <span class="sa">r</span><span class="s2">&quot;\bi graduated\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1568"><a href="#SemanticMemoryManager-1568"><span class="linenos">1568</span></a>            <span class="sa">r</span><span class="s2">&quot;\bmy favorite\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1569"><a href="#SemanticMemoryManager-1569"><span class="linenos">1569</span></a>            <span class="sa">r</span><span class="s2">&quot;\bmy goal\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1570"><a href="#SemanticMemoryManager-1570"><span class="linenos">1570</span></a>            <span class="sa">r</span><span class="s2">&quot;\bi want to\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1571"><a href="#SemanticMemoryManager-1571"><span class="linenos">1571</span></a>            <span class="sa">r</span><span class="s2">&quot;\bi plan to\b&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager-1572"><a href="#SemanticMemoryManager-1572"><span class="linenos">1572</span></a>        <span class="p">]</span>
</span><span id="SemanticMemoryManager-1573"><a href="#SemanticMemoryManager-1573"><span class="linenos">1573</span></a>
</span><span id="SemanticMemoryManager-1574"><a href="#SemanticMemoryManager-1574"><span class="linenos">1574</span></a>        <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1575"><a href="#SemanticMemoryManager-1575"><span class="linenos">1575</span></a>            <span class="n">sentence</span> <span class="o">=</span> <span class="n">sentence</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SemanticMemoryManager-1576"><a href="#SemanticMemoryManager-1576"><span class="linenos">1576</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Skip very short sentences</span>
</span><span id="SemanticMemoryManager-1577"><a href="#SemanticMemoryManager-1577"><span class="linenos">1577</span></a>                <span class="k">continue</span>
</span><span id="SemanticMemoryManager-1578"><a href="#SemanticMemoryManager-1578"><span class="linenos">1578</span></a>
</span><span id="SemanticMemoryManager-1579"><a href="#SemanticMemoryManager-1579"><span class="linenos">1579</span></a>            <span class="c1"># Check if sentence contains memorable patterns</span>
</span><span id="SemanticMemoryManager-1580"><a href="#SemanticMemoryManager-1580"><span class="linenos">1580</span></a>            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">memorable_patterns</span><span class="p">:</span>
</span><span id="SemanticMemoryManager-1581"><a href="#SemanticMemoryManager-1581"><span class="linenos">1581</span></a>                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span><span id="SemanticMemoryManager-1582"><a href="#SemanticMemoryManager-1582"><span class="linenos">1582</span></a>                    <span class="n">statements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
</span><span id="SemanticMemoryManager-1583"><a href="#SemanticMemoryManager-1583"><span class="linenos">1583</span></a>                    <span class="k">break</span>
</span><span id="SemanticMemoryManager-1584"><a href="#SemanticMemoryManager-1584"><span class="linenos">1584</span></a>
</span><span id="SemanticMemoryManager-1585"><a href="#SemanticMemoryManager-1585"><span class="linenos">1585</span></a>        <span class="k">return</span> <span class="n">statements</span>
</span></pre></div>


            <div class="docstring"><p>Semantic Memory Manager that provides LLM-free memory management.</p>

<p>This manager combines the structure of Agno's MemoryManager with semantic search
and duplicate detection capabilities, without requiring LLM invocation.</p>
</div>


                            <div id="SemanticMemoryManager.__init__" class="classattr">
                                        <input id="SemanticMemoryManager.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SemanticMemoryManager</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">agno</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="#SemanticMemoryManagerConfig">SemanticMemoryManagerConfig</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>,</span><span class="param">	<span class="n">enable_semantic_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">enable_exact_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">enable_topic_classification</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="SemanticMemoryManager.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.__init__-323"><a href="#SemanticMemoryManager.__init__-323"><span class="linenos">323</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.__init__-324"><a href="#SemanticMemoryManager.__init__-324"><span class="linenos">324</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-325"><a href="#SemanticMemoryManager.__init__-325"><span class="linenos">325</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-326"><a href="#SemanticMemoryManager.__init__-326"><span class="linenos">326</span></a>        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SemanticMemoryManagerConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-327"><a href="#SemanticMemoryManager.__init__-327"><span class="linenos">327</span></a>        <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-328"><a href="#SemanticMemoryManager.__init__-328"><span class="linenos">328</span></a>        <span class="n">enable_semantic_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-329"><a href="#SemanticMemoryManager.__init__-329"><span class="linenos">329</span></a>        <span class="n">enable_exact_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-330"><a href="#SemanticMemoryManager.__init__-330"><span class="linenos">330</span></a>        <span class="n">enable_topic_classification</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-331"><a href="#SemanticMemoryManager.__init__-331"><span class="linenos">331</span></a>        <span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-332"><a href="#SemanticMemoryManager.__init__-332"><span class="linenos">332</span></a>    <span class="p">):</span>
</span><span id="SemanticMemoryManager.__init__-333"><a href="#SemanticMemoryManager.__init__-333"><span class="linenos">333</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Semantic Memory Manager.&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.__init__-334"><a href="#SemanticMemoryManager.__init__-334"><span class="linenos">334</span></a>        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.__init__-335"><a href="#SemanticMemoryManager.__init__-335"><span class="linenos">335</span></a>            <span class="n">config</span> <span class="o">=</span> <span class="n">SemanticMemoryManagerConfig</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.__init__-336"><a href="#SemanticMemoryManager.__init__-336"><span class="linenos">336</span></a>                <span class="n">similarity_threshold</span><span class="o">=</span><span class="n">similarity_threshold</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-337"><a href="#SemanticMemoryManager.__init__-337"><span class="linenos">337</span></a>                <span class="n">enable_semantic_dedup</span><span class="o">=</span><span class="n">enable_semantic_dedup</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-338"><a href="#SemanticMemoryManager.__init__-338"><span class="linenos">338</span></a>                <span class="n">enable_exact_dedup</span><span class="o">=</span><span class="n">enable_exact_dedup</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-339"><a href="#SemanticMemoryManager.__init__-339"><span class="linenos">339</span></a>                <span class="n">enable_topic_classification</span><span class="o">=</span><span class="n">enable_topic_classification</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-340"><a href="#SemanticMemoryManager.__init__-340"><span class="linenos">340</span></a>                <span class="n">debug_mode</span><span class="o">=</span><span class="n">debug_mode</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-341"><a href="#SemanticMemoryManager.__init__-341"><span class="linenos">341</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.__init__-342"><a href="#SemanticMemoryManager.__init__-342"><span class="linenos">342</span></a>
</span><span id="SemanticMemoryManager.__init__-343"><a href="#SemanticMemoryManager.__init__-343"><span class="linenos">343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>  <span class="c1"># Required by Agno Memory class</span>
</span><span id="SemanticMemoryManager.__init__-344"><a href="#SemanticMemoryManager.__init__-344"><span class="linenos">344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="SemanticMemoryManager.__init__-345"><a href="#SemanticMemoryManager.__init__-345"><span class="linenos">345</span></a>
</span><span id="SemanticMemoryManager.__init__-346"><a href="#SemanticMemoryManager.__init__-346"><span class="linenos">346</span></a>        <span class="c1"># Get the correct path to topics.yaml</span>
</span><span id="SemanticMemoryManager.__init__-347"><a href="#SemanticMemoryManager.__init__-347"><span class="linenos">347</span></a>        <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="SemanticMemoryManager.__init__-348"><a href="#SemanticMemoryManager.__init__-348"><span class="linenos">348</span></a>        <span class="n">topics_yaml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s2">&quot;topics.yaml&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.__init__-349"><a href="#SemanticMemoryManager.__init__-349"><span class="linenos">349</span></a>
</span><span id="SemanticMemoryManager.__init__-350"><a href="#SemanticMemoryManager.__init__-350"><span class="linenos">350</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">topic_classifier</span> <span class="o">=</span> <span class="n">TopicClassifier</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="n">topics_yaml_path</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.__init__-351"><a href="#SemanticMemoryManager.__init__-351"><span class="linenos">351</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_detector</span> <span class="o">=</span> <span class="n">SemanticDuplicateDetector</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.__init__-352"><a href="#SemanticMemoryManager.__init__-352"><span class="linenos">352</span></a>            <span class="n">similarity_threshold</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">similarity_threshold</span>
</span><span id="SemanticMemoryManager.__init__-353"><a href="#SemanticMemoryManager.__init__-353"><span class="linenos">353</span></a>        <span class="p">)</span>
</span><span id="SemanticMemoryManager.__init__-354"><a href="#SemanticMemoryManager.__init__-354"><span class="linenos">354</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SemanticMemoryManager.__init__-355"><a href="#SemanticMemoryManager.__init__-355"><span class="linenos">355</span></a>
</span><span id="SemanticMemoryManager.__init__-356"><a href="#SemanticMemoryManager.__init__-356"><span class="linenos">356</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.__init__-357"><a href="#SemanticMemoryManager.__init__-357"><span class="linenos">357</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.__init__-358"><a href="#SemanticMemoryManager.__init__-358"><span class="linenos">358</span></a>
</span><span id="SemanticMemoryManager.__init__-359"><a href="#SemanticMemoryManager.__init__-359"><span class="linenos">359</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.__init__-360"><a href="#SemanticMemoryManager.__init__-360"><span class="linenos">360</span></a>            <span class="s2">&quot;Initialized SemanticMemoryManager with similarity_threshold=</span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-361"><a href="#SemanticMemoryManager.__init__-361"><span class="linenos">361</span></a>            <span class="n">config</span><span class="o">.</span><span class="n">similarity_threshold</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.__init__-362"><a href="#SemanticMemoryManager.__init__-362"><span class="linenos">362</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the Semantic Memory Manager.</p>
</div>


                            </div>
                            <div id="SemanticMemoryManager.model" class="classattr">
                                <div class="attr variable">
            <span class="name">model</span><span class="annotation">: Optional[agno.models.base.Model]</span>        =
<span class="default_value">FieldInfo(annotation=NoneType, required=False, default=None)</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManager.model"></a>
    
    

                            </div>
                            <div id="SemanticMemoryManager.config" class="classattr">
                                <div class="attr variable">
            <span class="name">config</span><span class="annotation">: <a href="#SemanticMemoryManagerConfig">SemanticMemoryManagerConfig</a></span>        =
<span class="default_value">FieldInfo(annotation=NoneType, required=False, default_factory=SemanticMemoryManagerConfig)</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManager.config"></a>
    
    

                            </div>
                            <div id="SemanticMemoryManager.topic_classifier" class="classattr">
                                <div class="attr variable">
            <span class="name">topic_classifier</span><span class="annotation">: <a href="#TopicClassifier">TopicClassifier</a></span>        =
<span class="default_value">FieldInfo(annotation=NoneType, required=False, default_factory=TopicClassifier)</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManager.topic_classifier"></a>
    
    

                            </div>
                            <div id="SemanticMemoryManager.duplicate_detector" class="classattr">
                                <div class="attr variable">
            <span class="name">duplicate_detector</span><span class="annotation">: <a href="#SemanticDuplicateDetector">SemanticDuplicateDetector</a></span>        =
<span class="default_value">FieldInfo(annotation=NoneType, required=False, default=None)</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManager.duplicate_detector"></a>
    
    

                            </div>
                            <div id="SemanticMemoryManager.memories_updated" class="classattr">
                                <div class="attr variable">
            <span class="name">memories_updated</span><span class="annotation">: bool</span>        =
<span class="default_value">FieldInfo(annotation=NoneType, required=False, default=False)</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManager.memories_updated"></a>
    
    

                            </div>
                            <div id="SemanticMemoryManager.add_memory" class="classattr">
                                        <input id="SemanticMemoryManager.add_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_memory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">memory_text</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">topics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">input_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">personal_agent</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">semantic_memory_manager</span><span class="o">.</span><span class="n">MemoryStorageResult</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.add_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.add_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.add_memory-453"><a href="#SemanticMemoryManager.add_memory-453"><span class="linenos">453</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.add_memory-454"><a href="#SemanticMemoryManager.add_memory-454"><span class="linenos">454</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-455"><a href="#SemanticMemoryManager.add_memory-455"><span class="linenos">455</span></a>        <span class="n">memory_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-456"><a href="#SemanticMemoryManager.add_memory-456"><span class="linenos">456</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-457"><a href="#SemanticMemoryManager.add_memory-457"><span class="linenos">457</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-458"><a href="#SemanticMemoryManager.add_memory-458"><span class="linenos">458</span></a>        <span class="n">topics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-459"><a href="#SemanticMemoryManager.add_memory-459"><span class="linenos">459</span></a>        <span class="n">input_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-460"><a href="#SemanticMemoryManager.add_memory-460"><span class="linenos">460</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MemoryStorageResult</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.add_memory-461"><a href="#SemanticMemoryManager.add_memory-461"><span class="linenos">461</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.add_memory-462"><a href="#SemanticMemoryManager.add_memory-462"><span class="linenos">462</span></a><span class="sd">        Add a memory with duplicate detection and topic classification.</span>
</span><span id="SemanticMemoryManager.add_memory-463"><a href="#SemanticMemoryManager.add_memory-463"><span class="linenos">463</span></a>
</span><span id="SemanticMemoryManager.add_memory-464"><a href="#SemanticMemoryManager.add_memory-464"><span class="linenos">464</span></a><span class="sd">        :param memory_text: The memory text to add</span>
</span><span id="SemanticMemoryManager.add_memory-465"><a href="#SemanticMemoryManager.add_memory-465"><span class="linenos">465</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager.add_memory-466"><a href="#SemanticMemoryManager.add_memory-466"><span class="linenos">466</span></a><span class="sd">        :param user_id: User ID for the memory</span>
</span><span id="SemanticMemoryManager.add_memory-467"><a href="#SemanticMemoryManager.add_memory-467"><span class="linenos">467</span></a><span class="sd">        :param topics: Optional list of topics (will be auto-classified if not provided)</span>
</span><span id="SemanticMemoryManager.add_memory-468"><a href="#SemanticMemoryManager.add_memory-468"><span class="linenos">468</span></a><span class="sd">        :param input_text: Optional input text that generated this memory</span>
</span><span id="SemanticMemoryManager.add_memory-469"><a href="#SemanticMemoryManager.add_memory-469"><span class="linenos">469</span></a><span class="sd">        :return: MemoryStorageResult with detailed status information</span>
</span><span id="SemanticMemoryManager.add_memory-470"><a href="#SemanticMemoryManager.add_memory-470"><span class="linenos">470</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.add_memory-471"><a href="#SemanticMemoryManager.add_memory-471"><span class="linenos">471</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager.add_memory-472"><a href="#SemanticMemoryManager.add_memory-472"><span class="linenos">472</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.add_memory-473"><a href="#SemanticMemoryManager.add_memory-473"><span class="linenos">473</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.add_memory-474"><a href="#SemanticMemoryManager.add_memory-474"><span class="linenos">474</span></a>            
</span><span id="SemanticMemoryManager.add_memory-475"><a href="#SemanticMemoryManager.add_memory-475"><span class="linenos">475</span></a>        <span class="c1"># Validate input</span>
</span><span id="SemanticMemoryManager.add_memory-476"><a href="#SemanticMemoryManager.add_memory-476"><span class="linenos">476</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">memory_text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">memory_text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="SemanticMemoryManager.add_memory-477"><a href="#SemanticMemoryManager.add_memory-477"><span class="linenos">477</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.add_memory-478"><a href="#SemanticMemoryManager.add_memory-478"><span class="linenos">478</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">CONTENT_EMPTY</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-479"><a href="#SemanticMemoryManager.add_memory-479"><span class="linenos">479</span></a>                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Memory content cannot be empty&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-480"><a href="#SemanticMemoryManager.add_memory-480"><span class="linenos">480</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-481"><a href="#SemanticMemoryManager.add_memory-481"><span class="linenos">481</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SemanticMemoryManager.add_memory-482"><a href="#SemanticMemoryManager.add_memory-482"><span class="linenos">482</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-483"><a href="#SemanticMemoryManager.add_memory-483"><span class="linenos">483</span></a>
</span><span id="SemanticMemoryManager.add_memory-484"><a href="#SemanticMemoryManager.add_memory-484"><span class="linenos">484</span></a>        <span class="c1"># Get recent memories for duplicate checking</span>
</span><span id="SemanticMemoryManager.add_memory-485"><a href="#SemanticMemoryManager.add_memory-485"><span class="linenos">485</span></a>        <span class="n">existing_memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_recent_memories</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-486"><a href="#SemanticMemoryManager.add_memory-486"><span class="linenos">486</span></a>
</span><span id="SemanticMemoryManager.add_memory-487"><a href="#SemanticMemoryManager.add_memory-487"><span class="linenos">487</span></a>        <span class="c1"># Check memory length</span>
</span><span id="SemanticMemoryManager.add_memory-488"><a href="#SemanticMemoryManager.add_memory-488"><span class="linenos">488</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_memory_length</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.add_memory-489"><a href="#SemanticMemoryManager.add_memory-489"><span class="linenos">489</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.add_memory-490"><a href="#SemanticMemoryManager.add_memory-490"><span class="linenos">490</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">CONTENT_TOO_LONG</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-491"><a href="#SemanticMemoryManager.add_memory-491"><span class="linenos">491</span></a>                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Memory too long (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memory_text</span><span class="p">)</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_memory_length</span><span class="si">}</span><span class="s2"> chars)&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-492"><a href="#SemanticMemoryManager.add_memory-492"><span class="linenos">492</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-493"><a href="#SemanticMemoryManager.add_memory-493"><span class="linenos">493</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SemanticMemoryManager.add_memory-494"><a href="#SemanticMemoryManager.add_memory-494"><span class="linenos">494</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-495"><a href="#SemanticMemoryManager.add_memory-495"><span class="linenos">495</span></a>
</span><span id="SemanticMemoryManager.add_memory-496"><a href="#SemanticMemoryManager.add_memory-496"><span class="linenos">496</span></a>        <span class="c1"># Check for exact duplicates</span>
</span><span id="SemanticMemoryManager.add_memory-497"><a href="#SemanticMemoryManager.add_memory-497"><span class="linenos">497</span></a>        <span class="n">exact_duplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_exact_duplicate</span><span class="p">(</span><span class="n">memory_text</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-498"><a href="#SemanticMemoryManager.add_memory-498"><span class="linenos">498</span></a>        <span class="k">if</span> <span class="n">exact_duplicate</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.add_memory-499"><a href="#SemanticMemoryManager.add_memory-499"><span class="linenos">499</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.add_memory-500"><a href="#SemanticMemoryManager.add_memory-500"><span class="linenos">500</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">DUPLICATE_EXACT</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-501"><a href="#SemanticMemoryManager.add_memory-501"><span class="linenos">501</span></a>                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Exact duplicate of: &#39;</span><span class="si">{</span><span class="n">exact_duplicate</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-502"><a href="#SemanticMemoryManager.add_memory-502"><span class="linenos">502</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-503"><a href="#SemanticMemoryManager.add_memory-503"><span class="linenos">503</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-504"><a href="#SemanticMemoryManager.add_memory-504"><span class="linenos">504</span></a>                <span class="n">similarity_score</span><span class="o">=</span><span class="mf">1.0</span>
</span><span id="SemanticMemoryManager.add_memory-505"><a href="#SemanticMemoryManager.add_memory-505"><span class="linenos">505</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-506"><a href="#SemanticMemoryManager.add_memory-506"><span class="linenos">506</span></a>
</span><span id="SemanticMemoryManager.add_memory-507"><a href="#SemanticMemoryManager.add_memory-507"><span class="linenos">507</span></a>        <span class="c1"># Check for semantic duplicates</span>
</span><span id="SemanticMemoryManager.add_memory-508"><a href="#SemanticMemoryManager.add_memory-508"><span class="linenos">508</span></a>        <span class="n">semantic_duplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_semantic_duplicate</span><span class="p">(</span><span class="n">memory_text</span><span class="p">,</span> <span class="n">existing_memories</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-509"><a href="#SemanticMemoryManager.add_memory-509"><span class="linenos">509</span></a>        <span class="k">if</span> <span class="n">semantic_duplicate</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.add_memory-510"><a href="#SemanticMemoryManager.add_memory-510"><span class="linenos">510</span></a>            <span class="c1"># Get similarity score for the duplicate</span>
</span><span id="SemanticMemoryManager.add_memory-511"><a href="#SemanticMemoryManager.add_memory-511"><span class="linenos">511</span></a>            <span class="n">existing_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">mem</span><span class="o">.</span><span class="n">memory</span> <span class="k">for</span> <span class="n">mem</span> <span class="ow">in</span> <span class="n">existing_memories</span><span class="p">]</span>
</span><span id="SemanticMemoryManager.add_memory-512"><a href="#SemanticMemoryManager.add_memory-512"><span class="linenos">512</span></a>            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">similarity_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_detector</span><span class="o">.</span><span class="n">is_duplicate</span><span class="p">(</span><span class="n">memory_text</span><span class="p">,</span> <span class="n">existing_texts</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-513"><a href="#SemanticMemoryManager.add_memory-513"><span class="linenos">513</span></a>            
</span><span id="SemanticMemoryManager.add_memory-514"><a href="#SemanticMemoryManager.add_memory-514"><span class="linenos">514</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.add_memory-515"><a href="#SemanticMemoryManager.add_memory-515"><span class="linenos">515</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">DUPLICATE_SEMANTIC</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-516"><a href="#SemanticMemoryManager.add_memory-516"><span class="linenos">516</span></a>                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Semantic duplicate of: &#39;</span><span class="si">{</span><span class="n">semantic_duplicate</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-517"><a href="#SemanticMemoryManager.add_memory-517"><span class="linenos">517</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-518"><a href="#SemanticMemoryManager.add_memory-518"><span class="linenos">518</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-519"><a href="#SemanticMemoryManager.add_memory-519"><span class="linenos">519</span></a>                <span class="n">similarity_score</span><span class="o">=</span><span class="n">similarity_score</span>
</span><span id="SemanticMemoryManager.add_memory-520"><a href="#SemanticMemoryManager.add_memory-520"><span class="linenos">520</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-521"><a href="#SemanticMemoryManager.add_memory-521"><span class="linenos">521</span></a>
</span><span id="SemanticMemoryManager.add_memory-522"><a href="#SemanticMemoryManager.add_memory-522"><span class="linenos">522</span></a>        <span class="c1"># Auto-classify topics if not provided</span>
</span><span id="SemanticMemoryManager.add_memory-523"><a href="#SemanticMemoryManager.add_memory-523"><span class="linenos">523</span></a>        <span class="k">if</span> <span class="n">topics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_topic_classification</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.add_memory-524"><a href="#SemanticMemoryManager.add_memory-524"><span class="linenos">524</span></a>            <span class="n">topics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_classifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">memory_text</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-525"><a href="#SemanticMemoryManager.add_memory-525"><span class="linenos">525</span></a>
</span><span id="SemanticMemoryManager.add_memory-526"><a href="#SemanticMemoryManager.add_memory-526"><span class="linenos">526</span></a>        <span class="c1"># Create the memory</span>
</span><span id="SemanticMemoryManager.add_memory-527"><a href="#SemanticMemoryManager.add_memory-527"><span class="linenos">527</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.add_memory-528"><a href="#SemanticMemoryManager.add_memory-528"><span class="linenos">528</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid4</span>
</span><span id="SemanticMemoryManager.add_memory-529"><a href="#SemanticMemoryManager.add_memory-529"><span class="linenos">529</span></a>
</span><span id="SemanticMemoryManager.add_memory-530"><a href="#SemanticMemoryManager.add_memory-530"><span class="linenos">530</span></a>            <span class="n">memory_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="SemanticMemoryManager.add_memory-531"><a href="#SemanticMemoryManager.add_memory-531"><span class="linenos">531</span></a>            <span class="n">last_updated</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.add_memory-532"><a href="#SemanticMemoryManager.add_memory-532"><span class="linenos">532</span></a>
</span><span id="SemanticMemoryManager.add_memory-533"><a href="#SemanticMemoryManager.add_memory-533"><span class="linenos">533</span></a>            <span class="n">user_memory</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.add_memory-534"><a href="#SemanticMemoryManager.add_memory-534"><span class="linenos">534</span></a>                <span class="n">memory_id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-535"><a href="#SemanticMemoryManager.add_memory-535"><span class="linenos">535</span></a>                <span class="n">memory</span><span class="o">=</span><span class="n">memory_text</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-536"><a href="#SemanticMemoryManager.add_memory-536"><span class="linenos">536</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-537"><a href="#SemanticMemoryManager.add_memory-537"><span class="linenos">537</span></a>                <span class="n">last_updated</span><span class="o">=</span><span class="n">last_updated</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-538"><a href="#SemanticMemoryManager.add_memory-538"><span class="linenos">538</span></a>                <span class="nb">input</span><span class="o">=</span><span class="n">input_text</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-539"><a href="#SemanticMemoryManager.add_memory-539"><span class="linenos">539</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-540"><a href="#SemanticMemoryManager.add_memory-540"><span class="linenos">540</span></a>
</span><span id="SemanticMemoryManager.add_memory-541"><a href="#SemanticMemoryManager.add_memory-541"><span class="linenos">541</span></a>            <span class="n">memory_row</span> <span class="o">=</span> <span class="n">MemoryRow</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.add_memory-542"><a href="#SemanticMemoryManager.add_memory-542"><span class="linenos">542</span></a>                <span class="nb">id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-543"><a href="#SemanticMemoryManager.add_memory-543"><span class="linenos">543</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-544"><a href="#SemanticMemoryManager.add_memory-544"><span class="linenos">544</span></a>                <span class="n">memory</span><span class="o">=</span><span class="n">user_memory</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
</span><span id="SemanticMemoryManager.add_memory-545"><a href="#SemanticMemoryManager.add_memory-545"><span class="linenos">545</span></a>                <span class="n">last_updated</span><span class="o">=</span><span class="n">last_updated</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-546"><a href="#SemanticMemoryManager.add_memory-546"><span class="linenos">546</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-547"><a href="#SemanticMemoryManager.add_memory-547"><span class="linenos">547</span></a>
</span><span id="SemanticMemoryManager.add_memory-548"><a href="#SemanticMemoryManager.add_memory-548"><span class="linenos">548</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">upsert_memory</span><span class="p">(</span><span class="n">memory_row</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-549"><a href="#SemanticMemoryManager.add_memory-549"><span class="linenos">549</span></a>
</span><span id="SemanticMemoryManager.add_memory-550"><a href="#SemanticMemoryManager.add_memory-550"><span class="linenos">550</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager.add_memory-551"><a href="#SemanticMemoryManager.add_memory-551"><span class="linenos">551</span></a>
</span><span id="SemanticMemoryManager.add_memory-552"><a href="#SemanticMemoryManager.add_memory-552"><span class="linenos">552</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.add_memory-553"><a href="#SemanticMemoryManager.add_memory-553"><span class="linenos">553</span></a>                <span class="s2">&quot;Added memory for user </span><span class="si">%s</span><span class="s2">: &#39;</span><span class="si">%s</span><span class="s2">&#39; (topics: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-554"><a href="#SemanticMemoryManager.add_memory-554"><span class="linenos">554</span></a>                <span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-555"><a href="#SemanticMemoryManager.add_memory-555"><span class="linenos">555</span></a>                <span class="n">memory_text</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-556"><a href="#SemanticMemoryManager.add_memory-556"><span class="linenos">556</span></a>                <span class="n">topics</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-557"><a href="#SemanticMemoryManager.add_memory-557"><span class="linenos">557</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-558"><a href="#SemanticMemoryManager.add_memory-558"><span class="linenos">558</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.add_memory-559"><a href="#SemanticMemoryManager.add_memory-559"><span class="linenos">559</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ACCEPTED: &#39;</span><span class="si">{</span><span class="n">memory_text</span><span class="si">}</span><span class="s2">&#39; (topics: </span><span class="si">{</span><span class="n">topics</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-560"><a href="#SemanticMemoryManager.add_memory-560"><span class="linenos">560</span></a>
</span><span id="SemanticMemoryManager.add_memory-561"><a href="#SemanticMemoryManager.add_memory-561"><span class="linenos">561</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.add_memory-562"><a href="#SemanticMemoryManager.add_memory-562"><span class="linenos">562</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-563"><a href="#SemanticMemoryManager.add_memory-563"><span class="linenos">563</span></a>                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Memory added successfully&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-564"><a href="#SemanticMemoryManager.add_memory-564"><span class="linenos">564</span></a>                <span class="n">memory_id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-565"><a href="#SemanticMemoryManager.add_memory-565"><span class="linenos">565</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-566"><a href="#SemanticMemoryManager.add_memory-566"><span class="linenos">566</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-567"><a href="#SemanticMemoryManager.add_memory-567"><span class="linenos">567</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Will be updated by the caller for dual storage</span>
</span><span id="SemanticMemoryManager.add_memory-568"><a href="#SemanticMemoryManager.add_memory-568"><span class="linenos">568</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-569"><a href="#SemanticMemoryManager.add_memory-569"><span class="linenos">569</span></a>
</span><span id="SemanticMemoryManager.add_memory-570"><a href="#SemanticMemoryManager.add_memory-570"><span class="linenos">570</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.add_memory-571"><a href="#SemanticMemoryManager.add_memory-571"><span class="linenos">571</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error adding memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager.add_memory-572"><a href="#SemanticMemoryManager.add_memory-572"><span class="linenos">572</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.add_memory-573"><a href="#SemanticMemoryManager.add_memory-573"><span class="linenos">573</span></a>            <span class="k">return</span> <span class="n">MemoryStorageResult</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.add_memory-574"><a href="#SemanticMemoryManager.add_memory-574"><span class="linenos">574</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">MemoryStorageStatus</span><span class="o">.</span><span class="n">STORAGE_ERROR</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-575"><a href="#SemanticMemoryManager.add_memory-575"><span class="linenos">575</span></a>                <span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-576"><a href="#SemanticMemoryManager.add_memory-576"><span class="linenos">576</span></a>                <span class="n">local_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.add_memory-577"><a href="#SemanticMemoryManager.add_memory-577"><span class="linenos">577</span></a>                <span class="n">graph_success</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SemanticMemoryManager.add_memory-578"><a href="#SemanticMemoryManager.add_memory-578"><span class="linenos">578</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Add a memory with duplicate detection and topic classification.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>memory_text</strong>:  The memory text to add</li>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>user_id</strong>:  User ID for the memory</li>
<li><strong>topics</strong>:  Optional list of topics (will be auto-classified if not provided)</li>
<li><strong>input_text</strong>:  Optional input text that generated this memory</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>MemoryStorageResult with detailed status information</p>
</blockquote>
</div>


                            </div>
                            <div id="SemanticMemoryManager.update_memory" class="classattr">
                                        <input id="SemanticMemoryManager.update_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_memory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">memory_text</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">topics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">input_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.update_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.update_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.update_memory-580"><a href="#SemanticMemoryManager.update_memory-580"><span class="linenos">580</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.update_memory-581"><a href="#SemanticMemoryManager.update_memory-581"><span class="linenos">581</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-582"><a href="#SemanticMemoryManager.update_memory-582"><span class="linenos">582</span></a>        <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-583"><a href="#SemanticMemoryManager.update_memory-583"><span class="linenos">583</span></a>        <span class="n">memory_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-584"><a href="#SemanticMemoryManager.update_memory-584"><span class="linenos">584</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-585"><a href="#SemanticMemoryManager.update_memory-585"><span class="linenos">585</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-586"><a href="#SemanticMemoryManager.update_memory-586"><span class="linenos">586</span></a>        <span class="n">topics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-587"><a href="#SemanticMemoryManager.update_memory-587"><span class="linenos">587</span></a>        <span class="n">input_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-588"><a href="#SemanticMemoryManager.update_memory-588"><span class="linenos">588</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager.update_memory-589"><a href="#SemanticMemoryManager.update_memory-589"><span class="linenos">589</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.update_memory-590"><a href="#SemanticMemoryManager.update_memory-590"><span class="linenos">590</span></a><span class="sd">        Update an existing memory.</span>
</span><span id="SemanticMemoryManager.update_memory-591"><a href="#SemanticMemoryManager.update_memory-591"><span class="linenos">591</span></a>
</span><span id="SemanticMemoryManager.update_memory-592"><a href="#SemanticMemoryManager.update_memory-592"><span class="linenos">592</span></a><span class="sd">        :param memory_id: ID of the memory to update</span>
</span><span id="SemanticMemoryManager.update_memory-593"><a href="#SemanticMemoryManager.update_memory-593"><span class="linenos">593</span></a><span class="sd">        :param memory_text: New memory text</span>
</span><span id="SemanticMemoryManager.update_memory-594"><a href="#SemanticMemoryManager.update_memory-594"><span class="linenos">594</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager.update_memory-595"><a href="#SemanticMemoryManager.update_memory-595"><span class="linenos">595</span></a><span class="sd">        :param user_id: User ID for the memory</span>
</span><span id="SemanticMemoryManager.update_memory-596"><a href="#SemanticMemoryManager.update_memory-596"><span class="linenos">596</span></a><span class="sd">        :param topics: Optional list of topics (will be auto-classified if not provided)</span>
</span><span id="SemanticMemoryManager.update_memory-597"><a href="#SemanticMemoryManager.update_memory-597"><span class="linenos">597</span></a><span class="sd">        :param input_text: Optional input text that generated this memory</span>
</span><span id="SemanticMemoryManager.update_memory-598"><a href="#SemanticMemoryManager.update_memory-598"><span class="linenos">598</span></a><span class="sd">        :return: Tuple of (success, message)</span>
</span><span id="SemanticMemoryManager.update_memory-599"><a href="#SemanticMemoryManager.update_memory-599"><span class="linenos">599</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.update_memory-600"><a href="#SemanticMemoryManager.update_memory-600"><span class="linenos">600</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager.update_memory-601"><a href="#SemanticMemoryManager.update_memory-601"><span class="linenos">601</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.update_memory-602"><a href="#SemanticMemoryManager.update_memory-602"><span class="linenos">602</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.update_memory-603"><a href="#SemanticMemoryManager.update_memory-603"><span class="linenos">603</span></a>            
</span><span id="SemanticMemoryManager.update_memory-604"><a href="#SemanticMemoryManager.update_memory-604"><span class="linenos">604</span></a>        <span class="c1"># Auto-classify topics if not provided</span>
</span><span id="SemanticMemoryManager.update_memory-605"><a href="#SemanticMemoryManager.update_memory-605"><span class="linenos">605</span></a>        <span class="k">if</span> <span class="n">topics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_topic_classification</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.update_memory-606"><a href="#SemanticMemoryManager.update_memory-606"><span class="linenos">606</span></a>            <span class="n">topics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_classifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">memory_text</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.update_memory-607"><a href="#SemanticMemoryManager.update_memory-607"><span class="linenos">607</span></a>
</span><span id="SemanticMemoryManager.update_memory-608"><a href="#SemanticMemoryManager.update_memory-608"><span class="linenos">608</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.update_memory-609"><a href="#SemanticMemoryManager.update_memory-609"><span class="linenos">609</span></a>            <span class="n">last_updated</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.update_memory-610"><a href="#SemanticMemoryManager.update_memory-610"><span class="linenos">610</span></a>
</span><span id="SemanticMemoryManager.update_memory-611"><a href="#SemanticMemoryManager.update_memory-611"><span class="linenos">611</span></a>            <span class="n">user_memory</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.update_memory-612"><a href="#SemanticMemoryManager.update_memory-612"><span class="linenos">612</span></a>                <span class="n">memory_id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-613"><a href="#SemanticMemoryManager.update_memory-613"><span class="linenos">613</span></a>                <span class="n">memory</span><span class="o">=</span><span class="n">memory_text</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-614"><a href="#SemanticMemoryManager.update_memory-614"><span class="linenos">614</span></a>                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-615"><a href="#SemanticMemoryManager.update_memory-615"><span class="linenos">615</span></a>                <span class="n">last_updated</span><span class="o">=</span><span class="n">last_updated</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-616"><a href="#SemanticMemoryManager.update_memory-616"><span class="linenos">616</span></a>                <span class="nb">input</span><span class="o">=</span><span class="n">input_text</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-617"><a href="#SemanticMemoryManager.update_memory-617"><span class="linenos">617</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.update_memory-618"><a href="#SemanticMemoryManager.update_memory-618"><span class="linenos">618</span></a>
</span><span id="SemanticMemoryManager.update_memory-619"><a href="#SemanticMemoryManager.update_memory-619"><span class="linenos">619</span></a>            <span class="n">memory_row</span> <span class="o">=</span> <span class="n">MemoryRow</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.update_memory-620"><a href="#SemanticMemoryManager.update_memory-620"><span class="linenos">620</span></a>                <span class="nb">id</span><span class="o">=</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-621"><a href="#SemanticMemoryManager.update_memory-621"><span class="linenos">621</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-622"><a href="#SemanticMemoryManager.update_memory-622"><span class="linenos">622</span></a>                <span class="n">memory</span><span class="o">=</span><span class="n">user_memory</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
</span><span id="SemanticMemoryManager.update_memory-623"><a href="#SemanticMemoryManager.update_memory-623"><span class="linenos">623</span></a>                <span class="n">last_updated</span><span class="o">=</span><span class="n">last_updated</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.update_memory-624"><a href="#SemanticMemoryManager.update_memory-624"><span class="linenos">624</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.update_memory-625"><a href="#SemanticMemoryManager.update_memory-625"><span class="linenos">625</span></a>
</span><span id="SemanticMemoryManager.update_memory-626"><a href="#SemanticMemoryManager.update_memory-626"><span class="linenos">626</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">upsert_memory</span><span class="p">(</span><span class="n">memory_row</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.update_memory-627"><a href="#SemanticMemoryManager.update_memory-627"><span class="linenos">627</span></a>
</span><span id="SemanticMemoryManager.update_memory-628"><a href="#SemanticMemoryManager.update_memory-628"><span class="linenos">628</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager.update_memory-629"><a href="#SemanticMemoryManager.update_memory-629"><span class="linenos">629</span></a>
</span><span id="SemanticMemoryManager.update_memory-630"><a href="#SemanticMemoryManager.update_memory-630"><span class="linenos">630</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.update_memory-631"><a href="#SemanticMemoryManager.update_memory-631"><span class="linenos">631</span></a>                <span class="s2">&quot;Updated memory </span><span class="si">%s</span><span class="s2"> for user </span><span class="si">%s</span><span class="s2">: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">memory_text</span>
</span><span id="SemanticMemoryManager.update_memory-632"><a href="#SemanticMemoryManager.update_memory-632"><span class="linenos">632</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.update_memory-633"><a href="#SemanticMemoryManager.update_memory-633"><span class="linenos">633</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.update_memory-634"><a href="#SemanticMemoryManager.update_memory-634"><span class="linenos">634</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; UPDATED: &#39;</span><span class="si">{</span><span class="n">memory_text</span><span class="si">}</span><span class="s2">&#39; (topics: </span><span class="si">{</span><span class="n">topics</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.update_memory-635"><a href="#SemanticMemoryManager.update_memory-635"><span class="linenos">635</span></a>
</span><span id="SemanticMemoryManager.update_memory-636"><a href="#SemanticMemoryManager.update_memory-636"><span class="linenos">636</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Memory updated successfully&quot;</span>
</span><span id="SemanticMemoryManager.update_memory-637"><a href="#SemanticMemoryManager.update_memory-637"><span class="linenos">637</span></a>
</span><span id="SemanticMemoryManager.update_memory-638"><a href="#SemanticMemoryManager.update_memory-638"><span class="linenos">638</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.update_memory-639"><a href="#SemanticMemoryManager.update_memory-639"><span class="linenos">639</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error updating memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager.update_memory-640"><a href="#SemanticMemoryManager.update_memory-640"><span class="linenos">640</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.update_memory-641"><a href="#SemanticMemoryManager.update_memory-641"><span class="linenos">641</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span></pre></div>


            <div class="docstring"><p>Update an existing memory.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>memory_id</strong>:  ID of the memory to update</li>
<li><strong>memory_text</strong>:  New memory text</li>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>user_id</strong>:  User ID for the memory</li>
<li><strong>topics</strong>:  Optional list of topics (will be auto-classified if not provided)</li>
<li><strong>input_text</strong>:  Optional input text that generated this memory</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Tuple of (success, message)</p>
</blockquote>
</div>


                            </div>
                            <div id="SemanticMemoryManager.delete_memory" class="classattr">
                                        <input id="SemanticMemoryManager.delete_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_memory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.delete_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.delete_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.delete_memory-643"><a href="#SemanticMemoryManager.delete_memory-643"><span class="linenos">643</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.delete_memory-644"><a href="#SemanticMemoryManager.delete_memory-644"><span class="linenos">644</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SemanticMemoryManager.delete_memory-645"><a href="#SemanticMemoryManager.delete_memory-645"><span class="linenos">645</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager.delete_memory-646"><a href="#SemanticMemoryManager.delete_memory-646"><span class="linenos">646</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.delete_memory-647"><a href="#SemanticMemoryManager.delete_memory-647"><span class="linenos">647</span></a><span class="sd">        Delete a memory.</span>
</span><span id="SemanticMemoryManager.delete_memory-648"><a href="#SemanticMemoryManager.delete_memory-648"><span class="linenos">648</span></a>
</span><span id="SemanticMemoryManager.delete_memory-649"><a href="#SemanticMemoryManager.delete_memory-649"><span class="linenos">649</span></a><span class="sd">        :param memory_id: ID of the memory to delete</span>
</span><span id="SemanticMemoryManager.delete_memory-650"><a href="#SemanticMemoryManager.delete_memory-650"><span class="linenos">650</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager.delete_memory-651"><a href="#SemanticMemoryManager.delete_memory-651"><span class="linenos">651</span></a><span class="sd">        :param user_id: User ID for the memory</span>
</span><span id="SemanticMemoryManager.delete_memory-652"><a href="#SemanticMemoryManager.delete_memory-652"><span class="linenos">652</span></a><span class="sd">        :return: Tuple of (success, message)</span>
</span><span id="SemanticMemoryManager.delete_memory-653"><a href="#SemanticMemoryManager.delete_memory-653"><span class="linenos">653</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.delete_memory-654"><a href="#SemanticMemoryManager.delete_memory-654"><span class="linenos">654</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memory-655"><a href="#SemanticMemoryManager.delete_memory-655"><span class="linenos">655</span></a>            <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager.delete_memory-656"><a href="#SemanticMemoryManager.delete_memory-656"><span class="linenos">656</span></a>            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memory-657"><a href="#SemanticMemoryManager.delete_memory-657"><span class="linenos">657</span></a>                <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.delete_memory-658"><a href="#SemanticMemoryManager.delete_memory-658"><span class="linenos">658</span></a>                
</span><span id="SemanticMemoryManager.delete_memory-659"><a href="#SemanticMemoryManager.delete_memory-659"><span class="linenos">659</span></a>            <span class="c1"># First check if the memory exists</span>
</span><span id="SemanticMemoryManager.delete_memory-660"><a href="#SemanticMemoryManager.delete_memory-660"><span class="linenos">660</span></a>            <span class="n">memory_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memory-661"><a href="#SemanticMemoryManager.delete_memory-661"><span class="linenos">661</span></a>            <span class="n">memory_exists</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SemanticMemoryManager.delete_memory-662"><a href="#SemanticMemoryManager.delete_memory-662"><span class="linenos">662</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">memory_rows</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memory-663"><a href="#SemanticMemoryManager.delete_memory-663"><span class="linenos">663</span></a>                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">memory_id</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memory-664"><a href="#SemanticMemoryManager.delete_memory-664"><span class="linenos">664</span></a>                    <span class="n">memory_exists</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager.delete_memory-665"><a href="#SemanticMemoryManager.delete_memory-665"><span class="linenos">665</span></a>                    <span class="k">break</span>
</span><span id="SemanticMemoryManager.delete_memory-666"><a href="#SemanticMemoryManager.delete_memory-666"><span class="linenos">666</span></a>            
</span><span id="SemanticMemoryManager.delete_memory-667"><a href="#SemanticMemoryManager.delete_memory-667"><span class="linenos">667</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memory_exists</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memory-668"><a href="#SemanticMemoryManager.delete_memory-668"><span class="linenos">668</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Memory </span><span class="si">%s</span><span class="s2"> not found for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memory-669"><a href="#SemanticMemoryManager.delete_memory-669"><span class="linenos">669</span></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> not found&quot;</span>
</span><span id="SemanticMemoryManager.delete_memory-670"><a href="#SemanticMemoryManager.delete_memory-670"><span class="linenos">670</span></a>            
</span><span id="SemanticMemoryManager.delete_memory-671"><a href="#SemanticMemoryManager.delete_memory-671"><span class="linenos">671</span></a>            <span class="c1"># Delete the memory</span>
</span><span id="SemanticMemoryManager.delete_memory-672"><a href="#SemanticMemoryManager.delete_memory-672"><span class="linenos">672</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span><span class="n">memory_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memory-673"><a href="#SemanticMemoryManager.delete_memory-673"><span class="linenos">673</span></a>
</span><span id="SemanticMemoryManager.delete_memory-674"><a href="#SemanticMemoryManager.delete_memory-674"><span class="linenos">674</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager.delete_memory-675"><a href="#SemanticMemoryManager.delete_memory-675"><span class="linenos">675</span></a>
</span><span id="SemanticMemoryManager.delete_memory-676"><a href="#SemanticMemoryManager.delete_memory-676"><span class="linenos">676</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted memory </span><span class="si">%s</span><span class="s2"> for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memory-677"><a href="#SemanticMemoryManager.delete_memory-677"><span class="linenos">677</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memory-678"><a href="#SemanticMemoryManager.delete_memory-678"><span class="linenos">678</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DELETED: </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memory-679"><a href="#SemanticMemoryManager.delete_memory-679"><span class="linenos">679</span></a>
</span><span id="SemanticMemoryManager.delete_memory-680"><a href="#SemanticMemoryManager.delete_memory-680"><span class="linenos">680</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2"> deleted successfully&quot;</span>
</span><span id="SemanticMemoryManager.delete_memory-681"><a href="#SemanticMemoryManager.delete_memory-681"><span class="linenos">681</span></a>
</span><span id="SemanticMemoryManager.delete_memory-682"><a href="#SemanticMemoryManager.delete_memory-682"><span class="linenos">682</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memory-683"><a href="#SemanticMemoryManager.delete_memory-683"><span class="linenos">683</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error deleting memory </span><span class="si">{</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager.delete_memory-684"><a href="#SemanticMemoryManager.delete_memory-684"><span class="linenos">684</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memory-685"><a href="#SemanticMemoryManager.delete_memory-685"><span class="linenos">685</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span></pre></div>


            <div class="docstring"><p>Delete a memory.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>memory_id</strong>:  ID of the memory to delete</li>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>user_id</strong>:  User ID for the memory</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Tuple of (success, message)</p>
</blockquote>
</div>


                            </div>
                            <div id="SemanticMemoryManager.delete_memories_by_topic" class="classattr">
                                        <input id="SemanticMemoryManager.delete_memories_by_topic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_memories_by_topic</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.delete_memories_by_topic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.delete_memories_by_topic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.delete_memories_by_topic-687"><a href="#SemanticMemoryManager.delete_memories_by_topic-687"><span class="linenos">687</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_memories_by_topic</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-688"><a href="#SemanticMemoryManager.delete_memories_by_topic-688"><span class="linenos">688</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-689"><a href="#SemanticMemoryManager.delete_memories_by_topic-689"><span class="linenos">689</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-690"><a href="#SemanticMemoryManager.delete_memories_by_topic-690"><span class="linenos">690</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-691"><a href="#SemanticMemoryManager.delete_memories_by_topic-691"><span class="linenos">691</span></a><span class="sd">        Delete all memories associated with a specific topic or list of topics.</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-692"><a href="#SemanticMemoryManager.delete_memories_by_topic-692"><span class="linenos">692</span></a>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-693"><a href="#SemanticMemoryManager.delete_memories_by_topic-693"><span class="linenos">693</span></a><span class="sd">        :param topics: A list of topics to delete memories for.</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-694"><a href="#SemanticMemoryManager.delete_memories_by_topic-694"><span class="linenos">694</span></a><span class="sd">        :param db: Memory database instance.</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-695"><a href="#SemanticMemoryManager.delete_memories_by_topic-695"><span class="linenos">695</span></a><span class="sd">        :param user_id: User ID for the memories.</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-696"><a href="#SemanticMemoryManager.delete_memories_by_topic-696"><span class="linenos">696</span></a><span class="sd">        :return: Tuple of (success, message).</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-697"><a href="#SemanticMemoryManager.delete_memories_by_topic-697"><span class="linenos">697</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-698"><a href="#SemanticMemoryManager.delete_memories_by_topic-698"><span class="linenos">698</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-699"><a href="#SemanticMemoryManager.delete_memories_by_topic-699"><span class="linenos">699</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-700"><a href="#SemanticMemoryManager.delete_memories_by_topic-700"><span class="linenos">700</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-701"><a href="#SemanticMemoryManager.delete_memories_by_topic-701"><span class="linenos">701</span></a>            
</span><span id="SemanticMemoryManager.delete_memories_by_topic-702"><a href="#SemanticMemoryManager.delete_memories_by_topic-702"><span class="linenos">702</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-703"><a href="#SemanticMemoryManager.delete_memories_by_topic-703"><span class="linenos">703</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;No topics provided for deletion.&quot;</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-704"><a href="#SemanticMemoryManager.delete_memories_by_topic-704"><span class="linenos">704</span></a>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-705"><a href="#SemanticMemoryManager.delete_memories_by_topic-705"><span class="linenos">705</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-706"><a href="#SemanticMemoryManager.delete_memories_by_topic-706"><span class="linenos">706</span></a>            <span class="c1"># Get all memories for the specified topics</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-707"><a href="#SemanticMemoryManager.delete_memories_by_topic-707"><span class="linenos">707</span></a>            <span class="n">memories_to_delete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_memories_by_topic</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-708"><a href="#SemanticMemoryManager.delete_memories_by_topic-708"><span class="linenos">708</span></a>                <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">topics</span><span class="o">=</span><span class="n">topics</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-709"><a href="#SemanticMemoryManager.delete_memories_by_topic-709"><span class="linenos">709</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-710"><a href="#SemanticMemoryManager.delete_memories_by_topic-710"><span class="linenos">710</span></a>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-711"><a href="#SemanticMemoryManager.delete_memories_by_topic-711"><span class="linenos">711</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories_to_delete</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-712"><a href="#SemanticMemoryManager.delete_memories_by_topic-712"><span class="linenos">712</span></a>                <span class="k">return</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-713"><a href="#SemanticMemoryManager.delete_memories_by_topic-713"><span class="linenos">713</span></a>                    <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-714"><a href="#SemanticMemoryManager.delete_memories_by_topic-714"><span class="linenos">714</span></a>                    <span class="sa">f</span><span class="s2">&quot;No memories found for topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-715"><a href="#SemanticMemoryManager.delete_memories_by_topic-715"><span class="linenos">715</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-716"><a href="#SemanticMemoryManager.delete_memories_by_topic-716"><span class="linenos">716</span></a>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-717"><a href="#SemanticMemoryManager.delete_memories_by_topic-717"><span class="linenos">717</span></a>            <span class="n">deleted_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-718"><a href="#SemanticMemoryManager.delete_memories_by_topic-718"><span class="linenos">718</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories_to_delete</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-719"><a href="#SemanticMemoryManager.delete_memories_by_topic-719"><span class="linenos">719</span></a>                <span class="n">success</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-720"><a href="#SemanticMemoryManager.delete_memories_by_topic-720"><span class="linenos">720</span></a>                    <span class="n">memory_id</span><span class="o">=</span><span class="n">memory</span><span class="o">.</span><span class="n">memory_id</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-721"><a href="#SemanticMemoryManager.delete_memories_by_topic-721"><span class="linenos">721</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-722"><a href="#SemanticMemoryManager.delete_memories_by_topic-722"><span class="linenos">722</span></a>                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-723"><a href="#SemanticMemoryManager.delete_memories_by_topic-723"><span class="linenos">723</span></a>                    <span class="n">deleted_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-724"><a href="#SemanticMemoryManager.delete_memories_by_topic-724"><span class="linenos">724</span></a>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-725"><a href="#SemanticMemoryManager.delete_memories_by_topic-725"><span class="linenos">725</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-726"><a href="#SemanticMemoryManager.delete_memories_by_topic-726"><span class="linenos">726</span></a>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-727"><a href="#SemanticMemoryManager.delete_memories_by_topic-727"><span class="linenos">727</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-728"><a href="#SemanticMemoryManager.delete_memories_by_topic-728"><span class="linenos">728</span></a>                <span class="s2">&quot;Deleted </span><span class="si">%d</span><span class="s2"> memories for topics &#39;</span><span class="si">%s</span><span class="s2">&#39; for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-729"><a href="#SemanticMemoryManager.delete_memories_by_topic-729"><span class="linenos">729</span></a>                <span class="n">deleted_count</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-730"><a href="#SemanticMemoryManager.delete_memories_by_topic-730"><span class="linenos">730</span></a>                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topics</span><span class="p">),</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-731"><a href="#SemanticMemoryManager.delete_memories_by_topic-731"><span class="linenos">731</span></a>                <span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-732"><a href="#SemanticMemoryManager.delete_memories_by_topic-732"><span class="linenos">732</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-733"><a href="#SemanticMemoryManager.delete_memories_by_topic-733"><span class="linenos">733</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-734"><a href="#SemanticMemoryManager.delete_memories_by_topic-734"><span class="linenos">734</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-735"><a href="#SemanticMemoryManager.delete_memories_by_topic-735"><span class="linenos">735</span></a>                    <span class="sa">f</span><span class="s2">&quot; DELETED BY TOPIC: </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> memories for topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-736"><a href="#SemanticMemoryManager.delete_memories_by_topic-736"><span class="linenos">736</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-737"><a href="#SemanticMemoryManager.delete_memories_by_topic-737"><span class="linenos">737</span></a>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-738"><a href="#SemanticMemoryManager.delete_memories_by_topic-738"><span class="linenos">738</span></a>            <span class="k">return</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-739"><a href="#SemanticMemoryManager.delete_memories_by_topic-739"><span class="linenos">739</span></a>                <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-740"><a href="#SemanticMemoryManager.delete_memories_by_topic-740"><span class="linenos">740</span></a>                <span class="sa">f</span><span class="s2">&quot;Successfully deleted </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> memories for topics: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-741"><a href="#SemanticMemoryManager.delete_memories_by_topic-741"><span class="linenos">741</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-742"><a href="#SemanticMemoryManager.delete_memories_by_topic-742"><span class="linenos">742</span></a>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-743"><a href="#SemanticMemoryManager.delete_memories_by_topic-743"><span class="linenos">743</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-744"><a href="#SemanticMemoryManager.delete_memories_by_topic-744"><span class="linenos">744</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error deleting memories by topic: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-745"><a href="#SemanticMemoryManager.delete_memories_by_topic-745"><span class="linenos">745</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.delete_memories_by_topic-746"><a href="#SemanticMemoryManager.delete_memories_by_topic-746"><span class="linenos">746</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span></pre></div>


            <div class="docstring"><p>Delete all memories associated with a specific topic or list of topics.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>topics</strong>:  A list of topics to delete memories for.</li>
<li><strong>db</strong>:  Memory database instance.</li>
<li><strong>user_id</strong>:  User ID for the memories.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Tuple of (success, message).</p>
</blockquote>
</div>


                            </div>
                            <div id="SemanticMemoryManager.clear_memories" class="classattr">
                                        <input id="SemanticMemoryManager.clear_memories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear_memories</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.clear_memories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.clear_memories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.clear_memories-748"><a href="#SemanticMemoryManager.clear_memories-748"><span class="linenos">748</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager.clear_memories-749"><a href="#SemanticMemoryManager.clear_memories-749"><span class="linenos">749</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.clear_memories-750"><a href="#SemanticMemoryManager.clear_memories-750"><span class="linenos">750</span></a><span class="sd">        Clear all memories for a user.</span>
</span><span id="SemanticMemoryManager.clear_memories-751"><a href="#SemanticMemoryManager.clear_memories-751"><span class="linenos">751</span></a>
</span><span id="SemanticMemoryManager.clear_memories-752"><a href="#SemanticMemoryManager.clear_memories-752"><span class="linenos">752</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager.clear_memories-753"><a href="#SemanticMemoryManager.clear_memories-753"><span class="linenos">753</span></a><span class="sd">        :param user_id: User ID for the memories</span>
</span><span id="SemanticMemoryManager.clear_memories-754"><a href="#SemanticMemoryManager.clear_memories-754"><span class="linenos">754</span></a><span class="sd">        :return: Tuple of (success, message)</span>
</span><span id="SemanticMemoryManager.clear_memories-755"><a href="#SemanticMemoryManager.clear_memories-755"><span class="linenos">755</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.clear_memories-756"><a href="#SemanticMemoryManager.clear_memories-756"><span class="linenos">756</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager.clear_memories-757"><a href="#SemanticMemoryManager.clear_memories-757"><span class="linenos">757</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.clear_memories-758"><a href="#SemanticMemoryManager.clear_memories-758"><span class="linenos">758</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.clear_memories-759"><a href="#SemanticMemoryManager.clear_memories-759"><span class="linenos">759</span></a>            
</span><span id="SemanticMemoryManager.clear_memories-760"><a href="#SemanticMemoryManager.clear_memories-760"><span class="linenos">760</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.clear_memories-761"><a href="#SemanticMemoryManager.clear_memories-761"><span class="linenos">761</span></a>            <span class="c1"># Get all memories for the user first</span>
</span><span id="SemanticMemoryManager.clear_memories-762"><a href="#SemanticMemoryManager.clear_memories-762"><span class="linenos">762</span></a>            <span class="n">memory_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.clear_memories-763"><a href="#SemanticMemoryManager.clear_memories-763"><span class="linenos">763</span></a>
</span><span id="SemanticMemoryManager.clear_memories-764"><a href="#SemanticMemoryManager.clear_memories-764"><span class="linenos">764</span></a>            <span class="c1"># Delete each memory</span>
</span><span id="SemanticMemoryManager.clear_memories-765"><a href="#SemanticMemoryManager.clear_memories-765"><span class="linenos">765</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">memory_rows</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.clear_memories-766"><a href="#SemanticMemoryManager.clear_memories-766"><span class="linenos">766</span></a>                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.clear_memories-767"><a href="#SemanticMemoryManager.clear_memories-767"><span class="linenos">767</span></a>                    <span class="n">db</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.clear_memories-768"><a href="#SemanticMemoryManager.clear_memories-768"><span class="linenos">768</span></a>
</span><span id="SemanticMemoryManager.clear_memories-769"><a href="#SemanticMemoryManager.clear_memories-769"><span class="linenos">769</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager.clear_memories-770"><a href="#SemanticMemoryManager.clear_memories-770"><span class="linenos">770</span></a>
</span><span id="SemanticMemoryManager.clear_memories-771"><a href="#SemanticMemoryManager.clear_memories-771"><span class="linenos">771</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleared all memories for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.clear_memories-772"><a href="#SemanticMemoryManager.clear_memories-772"><span class="linenos">772</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.clear_memories-773"><a href="#SemanticMemoryManager.clear_memories-773"><span class="linenos">773</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; CLEARED: All memories for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.clear_memories-774"><a href="#SemanticMemoryManager.clear_memories-774"><span class="linenos">774</span></a>
</span><span id="SemanticMemoryManager.clear_memories-775"><a href="#SemanticMemoryManager.clear_memories-775"><span class="linenos">775</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Cleared </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memory_rows</span><span class="p">)</span><span class="si">}</span><span class="s2"> memories successfully&quot;</span>
</span><span id="SemanticMemoryManager.clear_memories-776"><a href="#SemanticMemoryManager.clear_memories-776"><span class="linenos">776</span></a>
</span><span id="SemanticMemoryManager.clear_memories-777"><a href="#SemanticMemoryManager.clear_memories-777"><span class="linenos">777</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.clear_memories-778"><a href="#SemanticMemoryManager.clear_memories-778"><span class="linenos">778</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error clearing memories: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager.clear_memories-779"><a href="#SemanticMemoryManager.clear_memories-779"><span class="linenos">779</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.clear_memories-780"><a href="#SemanticMemoryManager.clear_memories-780"><span class="linenos">780</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span></pre></div>


            <div class="docstring"><p>Clear all memories for a user.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>user_id</strong>:  User ID for the memories</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Tuple of (success, message)</p>
</blockquote>
</div>


                            </div>
                            <div id="SemanticMemoryManager.search_memories" class="classattr">
                                        <input id="SemanticMemoryManager.search_memories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">search_memories</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">query</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span>,</span><span class="param">	<span class="n">search_topics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">topic_boost</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">UserMemory</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.search_memories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.search_memories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.search_memories-782"><a href="#SemanticMemoryManager.search_memories-782"><span class="linenos">782</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">search_memories</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.search_memories-783"><a href="#SemanticMemoryManager.search_memories-783"><span class="linenos">783</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-784"><a href="#SemanticMemoryManager.search_memories-784"><span class="linenos">784</span></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-785"><a href="#SemanticMemoryManager.search_memories-785"><span class="linenos">785</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-786"><a href="#SemanticMemoryManager.search_memories-786"><span class="linenos">786</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-787"><a href="#SemanticMemoryManager.search_memories-787"><span class="linenos">787</span></a>        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-788"><a href="#SemanticMemoryManager.search_memories-788"><span class="linenos">788</span></a>        <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-789"><a href="#SemanticMemoryManager.search_memories-789"><span class="linenos">789</span></a>        <span class="n">search_topics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-790"><a href="#SemanticMemoryManager.search_memories-790"><span class="linenos">790</span></a>        <span class="n">topic_boost</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-791"><a href="#SemanticMemoryManager.search_memories-791"><span class="linenos">791</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
</span><span id="SemanticMemoryManager.search_memories-792"><a href="#SemanticMemoryManager.search_memories-792"><span class="linenos">792</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.search_memories-793"><a href="#SemanticMemoryManager.search_memories-793"><span class="linenos">793</span></a><span class="sd">        Search memories using semantic similarity and topic matching with enhanced query expansion.</span>
</span><span id="SemanticMemoryManager.search_memories-794"><a href="#SemanticMemoryManager.search_memories-794"><span class="linenos">794</span></a>
</span><span id="SemanticMemoryManager.search_memories-795"><a href="#SemanticMemoryManager.search_memories-795"><span class="linenos">795</span></a><span class="sd">        :param query: Search query</span>
</span><span id="SemanticMemoryManager.search_memories-796"><a href="#SemanticMemoryManager.search_memories-796"><span class="linenos">796</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager.search_memories-797"><a href="#SemanticMemoryManager.search_memories-797"><span class="linenos">797</span></a><span class="sd">        :param user_id: User ID to search within</span>
</span><span id="SemanticMemoryManager.search_memories-798"><a href="#SemanticMemoryManager.search_memories-798"><span class="linenos">798</span></a><span class="sd">        :param limit: Maximum number of results</span>
</span><span id="SemanticMemoryManager.search_memories-799"><a href="#SemanticMemoryManager.search_memories-799"><span class="linenos">799</span></a><span class="sd">        :param similarity_threshold: Minimum similarity threshold for content</span>
</span><span id="SemanticMemoryManager.search_memories-800"><a href="#SemanticMemoryManager.search_memories-800"><span class="linenos">800</span></a><span class="sd">        :param search_topics: Whether to include topic search (default: True)</span>
</span><span id="SemanticMemoryManager.search_memories-801"><a href="#SemanticMemoryManager.search_memories-801"><span class="linenos">801</span></a><span class="sd">        :param topic_boost: Score boost for topic matches (default: 0.5)</span>
</span><span id="SemanticMemoryManager.search_memories-802"><a href="#SemanticMemoryManager.search_memories-802"><span class="linenos">802</span></a><span class="sd">        :return: List of (UserMemory, combined_score) tuples</span>
</span><span id="SemanticMemoryManager.search_memories-803"><a href="#SemanticMemoryManager.search_memories-803"><span class="linenos">803</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.search_memories-804"><a href="#SemanticMemoryManager.search_memories-804"><span class="linenos">804</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="SemanticMemoryManager.search_memories-805"><a href="#SemanticMemoryManager.search_memories-805"><span class="linenos">805</span></a>        
</span><span id="SemanticMemoryManager.search_memories-806"><a href="#SemanticMemoryManager.search_memories-806"><span class="linenos">806</span></a>        <span class="c1"># LATENCY DEBUG: Start timing memory search</span>
</span><span id="SemanticMemoryManager.search_memories-807"><a href="#SemanticMemoryManager.search_memories-807"><span class="linenos">807</span></a>        <span class="n">search_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.search_memories-808"><a href="#SemanticMemoryManager.search_memories-808"><span class="linenos">808</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Starting search_memories for query: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">[:</span><span class="mi">50</span><span class="p">])</span>
</span><span id="SemanticMemoryManager.search_memories-809"><a href="#SemanticMemoryManager.search_memories-809"><span class="linenos">809</span></a>        
</span><span id="SemanticMemoryManager.search_memories-810"><a href="#SemanticMemoryManager.search_memories-810"><span class="linenos">810</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager.search_memories-811"><a href="#SemanticMemoryManager.search_memories-811"><span class="linenos">811</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-812"><a href="#SemanticMemoryManager.search_memories-812"><span class="linenos">812</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.search_memories-813"><a href="#SemanticMemoryManager.search_memories-813"><span class="linenos">813</span></a>            
</span><span id="SemanticMemoryManager.search_memories-814"><a href="#SemanticMemoryManager.search_memories-814"><span class="linenos">814</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-815"><a href="#SemanticMemoryManager.search_memories-815"><span class="linenos">815</span></a>            <span class="c1"># LATENCY DEBUG: Time query expansion</span>
</span><span id="SemanticMemoryManager.search_memories-816"><a href="#SemanticMemoryManager.search_memories-816"><span class="linenos">816</span></a>            <span class="n">expand_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.search_memories-817"><a href="#SemanticMemoryManager.search_memories-817"><span class="linenos">817</span></a>            <span class="n">expanded_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-818"><a href="#SemanticMemoryManager.search_memories-818"><span class="linenos">818</span></a>            <span class="n">expand_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">expand_start</span>
</span><span id="SemanticMemoryManager.search_memories-819"><a href="#SemanticMemoryManager.search_memories-819"><span class="linenos">819</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Query expansion took </span><span class="si">%.3f</span><span class="s2"> seconds (</span><span class="si">%d</span><span class="s2"> queries)&quot;</span><span class="p">,</span> <span class="n">expand_time</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">expanded_queries</span><span class="p">))</span>
</span><span id="SemanticMemoryManager.search_memories-820"><a href="#SemanticMemoryManager.search_memories-820"><span class="linenos">820</span></a>
</span><span id="SemanticMemoryManager.search_memories-821"><a href="#SemanticMemoryManager.search_memories-821"><span class="linenos">821</span></a>            <span class="c1"># LATENCY DEBUG: Time database read</span>
</span><span id="SemanticMemoryManager.search_memories-822"><a href="#SemanticMemoryManager.search_memories-822"><span class="linenos">822</span></a>            <span class="n">db_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.search_memories-823"><a href="#SemanticMemoryManager.search_memories-823"><span class="linenos">823</span></a>            <span class="n">memory_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-824"><a href="#SemanticMemoryManager.search_memories-824"><span class="linenos">824</span></a>            <span class="n">db_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">db_start</span>
</span><span id="SemanticMemoryManager.search_memories-825"><a href="#SemanticMemoryManager.search_memories-825"><span class="linenos">825</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Database read took </span><span class="si">%.3f</span><span class="s2"> seconds (</span><span class="si">%d</span><span class="s2"> rows)&quot;</span><span class="p">,</span> <span class="n">db_time</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory_rows</span><span class="p">))</span>
</span><span id="SemanticMemoryManager.search_memories-826"><a href="#SemanticMemoryManager.search_memories-826"><span class="linenos">826</span></a>
</span><span id="SemanticMemoryManager.search_memories-827"><a href="#SemanticMemoryManager.search_memories-827"><span class="linenos">827</span></a>            <span class="c1"># LATENCY DEBUG: Time memory conversion</span>
</span><span id="SemanticMemoryManager.search_memories-828"><a href="#SemanticMemoryManager.search_memories-828"><span class="linenos">828</span></a>            <span class="n">convert_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.search_memories-829"><a href="#SemanticMemoryManager.search_memories-829"><span class="linenos">829</span></a>            <span class="n">user_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager.search_memories-830"><a href="#SemanticMemoryManager.search_memories-830"><span class="linenos">830</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">memory_rows</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-831"><a href="#SemanticMemoryManager.search_memories-831"><span class="linenos">831</span></a>                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-832"><a href="#SemanticMemoryManager.search_memories-832"><span class="linenos">832</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-833"><a href="#SemanticMemoryManager.search_memories-833"><span class="linenos">833</span></a>                        <span class="n">user_memory</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-834"><a href="#SemanticMemoryManager.search_memories-834"><span class="linenos">834</span></a>                        <span class="n">user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-835"><a href="#SemanticMemoryManager.search_memories-835"><span class="linenos">835</span></a>                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-836"><a href="#SemanticMemoryManager.search_memories-836"><span class="linenos">836</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.search_memories-837"><a href="#SemanticMemoryManager.search_memories-837"><span class="linenos">837</span></a>                            <span class="s2">&quot;Failed to convert memory row to UserMemory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span>
</span><span id="SemanticMemoryManager.search_memories-838"><a href="#SemanticMemoryManager.search_memories-838"><span class="linenos">838</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-839"><a href="#SemanticMemoryManager.search_memories-839"><span class="linenos">839</span></a>            <span class="n">convert_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">convert_start</span>
</span><span id="SemanticMemoryManager.search_memories-840"><a href="#SemanticMemoryManager.search_memories-840"><span class="linenos">840</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Memory conversion took </span><span class="si">%.3f</span><span class="s2"> seconds (</span><span class="si">%d</span><span class="s2"> memories)&quot;</span><span class="p">,</span> <span class="n">convert_time</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_memories</span><span class="p">))</span>
</span><span id="SemanticMemoryManager.search_memories-841"><a href="#SemanticMemoryManager.search_memories-841"><span class="linenos">841</span></a>
</span><span id="SemanticMemoryManager.search_memories-842"><a href="#SemanticMemoryManager.search_memories-842"><span class="linenos">842</span></a>            <span class="c1"># LATENCY DEBUG: Time similarity calculations</span>
</span><span id="SemanticMemoryManager.search_memories-843"><a href="#SemanticMemoryManager.search_memories-843"><span class="linenos">843</span></a>            <span class="n">similarity_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.search_memories-844"><a href="#SemanticMemoryManager.search_memories-844"><span class="linenos">844</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager.search_memories-845"><a href="#SemanticMemoryManager.search_memories-845"><span class="linenos">845</span></a>            <span class="n">query_lower</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.search_memories-846"><a href="#SemanticMemoryManager.search_memories-846"><span class="linenos">846</span></a>
</span><span id="SemanticMemoryManager.search_memories-847"><a href="#SemanticMemoryManager.search_memories-847"><span class="linenos">847</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">user_memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-848"><a href="#SemanticMemoryManager.search_memories-848"><span class="linenos">848</span></a>                <span class="n">max_similarity</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SemanticMemoryManager.search_memories-849"><a href="#SemanticMemoryManager.search_memories-849"><span class="linenos">849</span></a>                <span class="n">best_query</span> <span class="o">=</span> <span class="n">query</span>
</span><span id="SemanticMemoryManager.search_memories-850"><a href="#SemanticMemoryManager.search_memories-850"><span class="linenos">850</span></a>
</span><span id="SemanticMemoryManager.search_memories-851"><a href="#SemanticMemoryManager.search_memories-851"><span class="linenos">851</span></a>                <span class="c1"># Test original query and all expanded queries</span>
</span><span id="SemanticMemoryManager.search_memories-852"><a href="#SemanticMemoryManager.search_memories-852"><span class="linenos">852</span></a>                <span class="k">for</span> <span class="n">test_query</span> <span class="ow">in</span> <span class="n">expanded_queries</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-853"><a href="#SemanticMemoryManager.search_memories-853"><span class="linenos">853</span></a>                    <span class="n">content_similarity</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager.search_memories-854"><a href="#SemanticMemoryManager.search_memories-854"><span class="linenos">854</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_detector</span><span class="o">.</span><span class="n">_calculate_semantic_similarity</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.search_memories-855"><a href="#SemanticMemoryManager.search_memories-855"><span class="linenos">855</span></a>                            <span class="n">test_query</span><span class="p">,</span> <span class="n">memory</span><span class="o">.</span><span class="n">memory</span>
</span><span id="SemanticMemoryManager.search_memories-856"><a href="#SemanticMemoryManager.search_memories-856"><span class="linenos">856</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-857"><a href="#SemanticMemoryManager.search_memories-857"><span class="linenos">857</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-858"><a href="#SemanticMemoryManager.search_memories-858"><span class="linenos">858</span></a>                    <span class="k">if</span> <span class="n">content_similarity</span> <span class="o">&gt;</span> <span class="n">max_similarity</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-859"><a href="#SemanticMemoryManager.search_memories-859"><span class="linenos">859</span></a>                        <span class="n">max_similarity</span> <span class="o">=</span> <span class="n">content_similarity</span>
</span><span id="SemanticMemoryManager.search_memories-860"><a href="#SemanticMemoryManager.search_memories-860"><span class="linenos">860</span></a>                        <span class="n">best_query</span> <span class="o">=</span> <span class="n">test_query</span>
</span><span id="SemanticMemoryManager.search_memories-861"><a href="#SemanticMemoryManager.search_memories-861"><span class="linenos">861</span></a>
</span><span id="SemanticMemoryManager.search_memories-862"><a href="#SemanticMemoryManager.search_memories-862"><span class="linenos">862</span></a>                <span class="c1"># Topic matching with enhanced search</span>
</span><span id="SemanticMemoryManager.search_memories-863"><a href="#SemanticMemoryManager.search_memories-863"><span class="linenos">863</span></a>                <span class="n">topic_score</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SemanticMemoryManager.search_memories-864"><a href="#SemanticMemoryManager.search_memories-864"><span class="linenos">864</span></a>                <span class="n">topic_matches</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager.search_memories-865"><a href="#SemanticMemoryManager.search_memories-865"><span class="linenos">865</span></a>
</span><span id="SemanticMemoryManager.search_memories-866"><a href="#SemanticMemoryManager.search_memories-866"><span class="linenos">866</span></a>                <span class="k">if</span> <span class="n">search_topics</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-867"><a href="#SemanticMemoryManager.search_memories-867"><span class="linenos">867</span></a>                    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-868"><a href="#SemanticMemoryManager.search_memories-868"><span class="linenos">868</span></a>                        <span class="c1"># Check original query and expanded queries against topics</span>
</span><span id="SemanticMemoryManager.search_memories-869"><a href="#SemanticMemoryManager.search_memories-869"><span class="linenos">869</span></a>                        <span class="k">for</span> <span class="n">test_query</span> <span class="ow">in</span> <span class="n">expanded_queries</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-870"><a href="#SemanticMemoryManager.search_memories-870"><span class="linenos">870</span></a>                            <span class="n">test_query_lower</span> <span class="o">=</span> <span class="n">test_query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.search_memories-871"><a href="#SemanticMemoryManager.search_memories-871"><span class="linenos">871</span></a>                            <span class="k">if</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager.search_memories-872"><a href="#SemanticMemoryManager.search_memories-872"><span class="linenos">872</span></a>                                <span class="n">test_query_lower</span> <span class="ow">in</span> <span class="n">topic</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.search_memories-873"><a href="#SemanticMemoryManager.search_memories-873"><span class="linenos">873</span></a>                                <span class="ow">or</span> <span class="n">topic</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">test_query_lower</span>
</span><span id="SemanticMemoryManager.search_memories-874"><a href="#SemanticMemoryManager.search_memories-874"><span class="linenos">874</span></a>                            <span class="p">):</span>
</span><span id="SemanticMemoryManager.search_memories-875"><a href="#SemanticMemoryManager.search_memories-875"><span class="linenos">875</span></a>                                <span class="k">if</span> <span class="n">test_query_lower</span> <span class="o">==</span> <span class="n">topic</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="SemanticMemoryManager.search_memories-876"><a href="#SemanticMemoryManager.search_memories-876"><span class="linenos">876</span></a>                                    <span class="n">topic_score</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Exact topic match</span>
</span><span id="SemanticMemoryManager.search_memories-877"><a href="#SemanticMemoryManager.search_memories-877"><span class="linenos">877</span></a>                                    <span class="n">topic_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-878"><a href="#SemanticMemoryManager.search_memories-878"><span class="linenos">878</span></a>                                    <span class="k">break</span>
</span><span id="SemanticMemoryManager.search_memories-879"><a href="#SemanticMemoryManager.search_memories-879"><span class="linenos">879</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-880"><a href="#SemanticMemoryManager.search_memories-880"><span class="linenos">880</span></a>                                    <span class="n">topic_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.search_memories-881"><a href="#SemanticMemoryManager.search_memories-881"><span class="linenos">881</span></a>                                        <span class="n">topic_score</span><span class="p">,</span> <span class="mf">0.8</span>
</span><span id="SemanticMemoryManager.search_memories-882"><a href="#SemanticMemoryManager.search_memories-882"><span class="linenos">882</span></a>                                    <span class="p">)</span>  <span class="c1"># Partial topic match</span>
</span><span id="SemanticMemoryManager.search_memories-883"><a href="#SemanticMemoryManager.search_memories-883"><span class="linenos">883</span></a>                                    <span class="n">topic_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-884"><a href="#SemanticMemoryManager.search_memories-884"><span class="linenos">884</span></a>
</span><span id="SemanticMemoryManager.search_memories-885"><a href="#SemanticMemoryManager.search_memories-885"><span class="linenos">885</span></a>                <span class="c1"># Enhanced keyword matching for work-related queries</span>
</span><span id="SemanticMemoryManager.search_memories-886"><a href="#SemanticMemoryManager.search_memories-886"><span class="linenos">886</span></a>                <span class="n">keyword_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_keyword_score</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.search_memories-887"><a href="#SemanticMemoryManager.search_memories-887"><span class="linenos">887</span></a>                    <span class="n">expanded_queries</span><span class="p">,</span> <span class="n">memory</span><span class="o">.</span><span class="n">memory</span>
</span><span id="SemanticMemoryManager.search_memories-888"><a href="#SemanticMemoryManager.search_memories-888"><span class="linenos">888</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-889"><a href="#SemanticMemoryManager.search_memories-889"><span class="linenos">889</span></a>
</span><span id="SemanticMemoryManager.search_memories-890"><a href="#SemanticMemoryManager.search_memories-890"><span class="linenos">890</span></a>                <span class="c1"># Combined scoring: use the best of content similarity, topic match, or keyword match</span>
</span><span id="SemanticMemoryManager.search_memories-891"><a href="#SemanticMemoryManager.search_memories-891"><span class="linenos">891</span></a>                <span class="n">final_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.search_memories-892"><a href="#SemanticMemoryManager.search_memories-892"><span class="linenos">892</span></a>                    <span class="n">max_similarity</span><span class="p">,</span> <span class="n">topic_score</span> <span class="o">*</span> <span class="n">topic_boost</span><span class="p">,</span> <span class="n">keyword_score</span>
</span><span id="SemanticMemoryManager.search_memories-893"><a href="#SemanticMemoryManager.search_memories-893"><span class="linenos">893</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-894"><a href="#SemanticMemoryManager.search_memories-894"><span class="linenos">894</span></a>
</span><span id="SemanticMemoryManager.search_memories-895"><a href="#SemanticMemoryManager.search_memories-895"><span class="linenos">895</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager.search_memories-896"><a href="#SemanticMemoryManager.search_memories-896"><span class="linenos">896</span></a>                    <span class="n">final_score</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span>
</span><span id="SemanticMemoryManager.search_memories-897"><a href="#SemanticMemoryManager.search_memories-897"><span class="linenos">897</span></a>                    <span class="ow">or</span> <span class="n">topic_score</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager.search_memories-898"><a href="#SemanticMemoryManager.search_memories-898"><span class="linenos">898</span></a>                    <span class="ow">or</span> <span class="n">keyword_score</span> <span class="o">&gt;</span> <span class="mf">0.4</span>
</span><span id="SemanticMemoryManager.search_memories-899"><a href="#SemanticMemoryManager.search_memories-899"><span class="linenos">899</span></a>                <span class="p">):</span>
</span><span id="SemanticMemoryManager.search_memories-900"><a href="#SemanticMemoryManager.search_memories-900"><span class="linenos">900</span></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">memory</span><span class="p">,</span> <span class="n">final_score</span><span class="p">))</span>
</span><span id="SemanticMemoryManager.search_memories-901"><a href="#SemanticMemoryManager.search_memories-901"><span class="linenos">901</span></a>
</span><span id="SemanticMemoryManager.search_memories-902"><a href="#SemanticMemoryManager.search_memories-902"><span class="linenos">902</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager.search_memories-903"><a href="#SemanticMemoryManager.search_memories-903"><span class="linenos">903</span></a>                        <span class="n">topic_matches</span> <span class="ow">or</span> <span class="n">keyword_score</span> <span class="o">&gt;</span> <span class="mf">0.4</span>
</span><span id="SemanticMemoryManager.search_memories-904"><a href="#SemanticMemoryManager.search_memories-904"><span class="linenos">904</span></a>                    <span class="p">):</span>
</span><span id="SemanticMemoryManager.search_memories-905"><a href="#SemanticMemoryManager.search_memories-905"><span class="linenos">905</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.search_memories-906"><a href="#SemanticMemoryManager.search_memories-906"><span class="linenos">906</span></a>                            <span class="s2">&quot;Enhanced match for query &#39;</span><span class="si">%s</span><span class="s2">&#39;: memory=&#39;</span><span class="si">%s</span><span class="s2">&#39;, topics=</span><span class="si">%s</span><span class="s2">, final_score=</span><span class="si">%.3f</span><span class="s2"> (content=</span><span class="si">%.3f</span><span class="s2">, topic=</span><span class="si">%.3f</span><span class="s2">, keyword=</span><span class="si">%.3f</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-907"><a href="#SemanticMemoryManager.search_memories-907"><span class="linenos">907</span></a>                            <span class="n">query</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-908"><a href="#SemanticMemoryManager.search_memories-908"><span class="linenos">908</span></a>                            <span class="n">memory</span><span class="o">.</span><span class="n">memory</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span>
</span><span id="SemanticMemoryManager.search_memories-909"><a href="#SemanticMemoryManager.search_memories-909"><span class="linenos">909</span></a>                            <span class="n">topic_matches</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-910"><a href="#SemanticMemoryManager.search_memories-910"><span class="linenos">910</span></a>                            <span class="n">final_score</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-911"><a href="#SemanticMemoryManager.search_memories-911"><span class="linenos">911</span></a>                            <span class="n">max_similarity</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-912"><a href="#SemanticMemoryManager.search_memories-912"><span class="linenos">912</span></a>                            <span class="n">topic_score</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-913"><a href="#SemanticMemoryManager.search_memories-913"><span class="linenos">913</span></a>                            <span class="n">keyword_score</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-914"><a href="#SemanticMemoryManager.search_memories-914"><span class="linenos">914</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-915"><a href="#SemanticMemoryManager.search_memories-915"><span class="linenos">915</span></a>
</span><span id="SemanticMemoryManager.search_memories-916"><a href="#SemanticMemoryManager.search_memories-916"><span class="linenos">916</span></a>            <span class="n">similarity_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">similarity_start</span>
</span><span id="SemanticMemoryManager.search_memories-917"><a href="#SemanticMemoryManager.search_memories-917"><span class="linenos">917</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Similarity calculations took </span><span class="si">%.3f</span><span class="s2"> seconds (</span><span class="si">%d</span><span class="s2"> memories processed)&quot;</span><span class="p">,</span> <span class="n">similarity_time</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_memories</span><span class="p">))</span>
</span><span id="SemanticMemoryManager.search_memories-918"><a href="#SemanticMemoryManager.search_memories-918"><span class="linenos">918</span></a>
</span><span id="SemanticMemoryManager.search_memories-919"><a href="#SemanticMemoryManager.search_memories-919"><span class="linenos">919</span></a>            <span class="c1"># LATENCY DEBUG: Time sorting</span>
</span><span id="SemanticMemoryManager.search_memories-920"><a href="#SemanticMemoryManager.search_memories-920"><span class="linenos">920</span></a>            <span class="n">sort_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.search_memories-921"><a href="#SemanticMemoryManager.search_memories-921"><span class="linenos">921</span></a>            <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-922"><a href="#SemanticMemoryManager.search_memories-922"><span class="linenos">922</span></a>            <span class="n">sort_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">sort_start</span>
</span><span id="SemanticMemoryManager.search_memories-923"><a href="#SemanticMemoryManager.search_memories-923"><span class="linenos">923</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Sorting took </span><span class="si">%.3f</span><span class="s2"> seconds&quot;</span><span class="p">,</span> <span class="n">sort_time</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-924"><a href="#SemanticMemoryManager.search_memories-924"><span class="linenos">924</span></a>
</span><span id="SemanticMemoryManager.search_memories-925"><a href="#SemanticMemoryManager.search_memories-925"><span class="linenos">925</span></a>            <span class="c1"># LATENCY DEBUG: Total timing</span>
</span><span id="SemanticMemoryManager.search_memories-926"><a href="#SemanticMemoryManager.search_memories-926"><span class="linenos">926</span></a>            <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">search_start_time</span>
</span><span id="SemanticMemoryManager.search_memories-927"><a href="#SemanticMemoryManager.search_memories-927"><span class="linenos">927</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; MEMORY LATENCY: Total search_memories time: </span><span class="si">%.3f</span><span class="s2"> seconds (expand: </span><span class="si">%.3f</span><span class="s2">, db: </span><span class="si">%.3f</span><span class="s2">, convert: </span><span class="si">%.3f</span><span class="s2">, similarity: </span><span class="si">%.3f</span><span class="s2">, sort: </span><span class="si">%.3f</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.search_memories-928"><a href="#SemanticMemoryManager.search_memories-928"><span class="linenos">928</span></a>                       <span class="n">total_time</span><span class="p">,</span> <span class="n">expand_time</span><span class="p">,</span> <span class="n">db_time</span><span class="p">,</span> <span class="n">convert_time</span><span class="p">,</span> <span class="n">similarity_time</span><span class="p">,</span> <span class="n">sort_time</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-929"><a href="#SemanticMemoryManager.search_memories-929"><span class="linenos">929</span></a>
</span><span id="SemanticMemoryManager.search_memories-930"><a href="#SemanticMemoryManager.search_memories-930"><span class="linenos">930</span></a>            <span class="k">return</span> <span class="n">results</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
</span><span id="SemanticMemoryManager.search_memories-931"><a href="#SemanticMemoryManager.search_memories-931"><span class="linenos">931</span></a>
</span><span id="SemanticMemoryManager.search_memories-932"><a href="#SemanticMemoryManager.search_memories-932"><span class="linenos">932</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.search_memories-933"><a href="#SemanticMemoryManager.search_memories-933"><span class="linenos">933</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error searching memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.search_memories-934"><a href="#SemanticMemoryManager.search_memories-934"><span class="linenos">934</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Search memories using semantic similarity and topic matching with enhanced query expansion.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>query</strong>:  Search query</li>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>user_id</strong>:  User ID to search within</li>
<li><strong>limit</strong>:  Maximum number of results</li>
<li><strong>similarity_threshold</strong>:  Minimum similarity threshold for content</li>
<li><strong>search_topics: Whether to include topic search (default</strong>:  True)</li>
<li><strong>topic_boost: Score boost for topic matches (default</strong>:  0.5)</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>List of (UserMemory, combined_score) tuples</p>
</blockquote>
</div>


                            </div>
                            <div id="SemanticMemoryManager.get_memories_by_topic" class="classattr">
                                        <input id="SemanticMemoryManager.get_memories_by_topic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_memories_by_topic</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">topics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">UserMemory</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.get_memories_by_topic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.get_memories_by_topic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.get_memories_by_topic-936"><a href="#SemanticMemoryManager.get_memories_by_topic-936"><span class="linenos">936</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_memories_by_topic</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-937"><a href="#SemanticMemoryManager.get_memories_by_topic-937"><span class="linenos">937</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-938"><a href="#SemanticMemoryManager.get_memories_by_topic-938"><span class="linenos">938</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-939"><a href="#SemanticMemoryManager.get_memories_by_topic-939"><span class="linenos">939</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-940"><a href="#SemanticMemoryManager.get_memories_by_topic-940"><span class="linenos">940</span></a>        <span class="n">topics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-941"><a href="#SemanticMemoryManager.get_memories_by_topic-941"><span class="linenos">941</span></a>        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-942"><a href="#SemanticMemoryManager.get_memories_by_topic-942"><span class="linenos">942</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-943"><a href="#SemanticMemoryManager.get_memories_by_topic-943"><span class="linenos">943</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-944"><a href="#SemanticMemoryManager.get_memories_by_topic-944"><span class="linenos">944</span></a><span class="sd">        Get memories filtered by a list of topics, without similarity search.</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-945"><a href="#SemanticMemoryManager.get_memories_by_topic-945"><span class="linenos">945</span></a>
</span><span id="SemanticMemoryManager.get_memories_by_topic-946"><a href="#SemanticMemoryManager.get_memories_by_topic-946"><span class="linenos">946</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-947"><a href="#SemanticMemoryManager.get_memories_by_topic-947"><span class="linenos">947</span></a><span class="sd">        :param user_id: User ID to search within</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-948"><a href="#SemanticMemoryManager.get_memories_by_topic-948"><span class="linenos">948</span></a><span class="sd">        :param topics: Optional list of topics to filter by. If None, returns all memories.</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-949"><a href="#SemanticMemoryManager.get_memories_by_topic-949"><span class="linenos">949</span></a><span class="sd">        :param limit: Maximum number of results to return</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-950"><a href="#SemanticMemoryManager.get_memories_by_topic-950"><span class="linenos">950</span></a><span class="sd">        :return: List of UserMemory objects matching the topics.</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-951"><a href="#SemanticMemoryManager.get_memories_by_topic-951"><span class="linenos">951</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-952"><a href="#SemanticMemoryManager.get_memories_by_topic-952"><span class="linenos">952</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-953"><a href="#SemanticMemoryManager.get_memories_by_topic-953"><span class="linenos">953</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-954"><a href="#SemanticMemoryManager.get_memories_by_topic-954"><span class="linenos">954</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-955"><a href="#SemanticMemoryManager.get_memories_by_topic-955"><span class="linenos">955</span></a>            
</span><span id="SemanticMemoryManager.get_memories_by_topic-956"><a href="#SemanticMemoryManager.get_memories_by_topic-956"><span class="linenos">956</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-957"><a href="#SemanticMemoryManager.get_memories_by_topic-957"><span class="linenos">957</span></a>            <span class="c1"># Get all memories for the user</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-958"><a href="#SemanticMemoryManager.get_memories_by_topic-958"><span class="linenos">958</span></a>            <span class="n">memory_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-959"><a href="#SemanticMemoryManager.get_memories_by_topic-959"><span class="linenos">959</span></a>
</span><span id="SemanticMemoryManager.get_memories_by_topic-960"><a href="#SemanticMemoryManager.get_memories_by_topic-960"><span class="linenos">960</span></a>            <span class="n">user_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-961"><a href="#SemanticMemoryManager.get_memories_by_topic-961"><span class="linenos">961</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">memory_rows</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-962"><a href="#SemanticMemoryManager.get_memories_by_topic-962"><span class="linenos">962</span></a>                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-963"><a href="#SemanticMemoryManager.get_memories_by_topic-963"><span class="linenos">963</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-964"><a href="#SemanticMemoryManager.get_memories_by_topic-964"><span class="linenos">964</span></a>                        <span class="n">user_memory</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-965"><a href="#SemanticMemoryManager.get_memories_by_topic-965"><span class="linenos">965</span></a>                        <span class="n">user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-966"><a href="#SemanticMemoryManager.get_memories_by_topic-966"><span class="linenos">966</span></a>                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-967"><a href="#SemanticMemoryManager.get_memories_by_topic-967"><span class="linenos">967</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-968"><a href="#SemanticMemoryManager.get_memories_by_topic-968"><span class="linenos">968</span></a>                            <span class="s2">&quot;Failed to convert memory row to UserMemory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-969"><a href="#SemanticMemoryManager.get_memories_by_topic-969"><span class="linenos">969</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-970"><a href="#SemanticMemoryManager.get_memories_by_topic-970"><span class="linenos">970</span></a>
</span><span id="SemanticMemoryManager.get_memories_by_topic-971"><a href="#SemanticMemoryManager.get_memories_by_topic-971"><span class="linenos">971</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">topics</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-972"><a href="#SemanticMemoryManager.get_memories_by_topic-972"><span class="linenos">972</span></a>                <span class="c1"># If no topics are specified, return all memories up to the limit</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-973"><a href="#SemanticMemoryManager.get_memories_by_topic-973"><span class="linenos">973</span></a>                <span class="k">return</span> <span class="n">user_memories</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-974"><a href="#SemanticMemoryManager.get_memories_by_topic-974"><span class="linenos">974</span></a>
</span><span id="SemanticMemoryManager.get_memories_by_topic-975"><a href="#SemanticMemoryManager.get_memories_by_topic-975"><span class="linenos">975</span></a>            <span class="c1"># Filter memories by the given topics</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-976"><a href="#SemanticMemoryManager.get_memories_by_topic-976"><span class="linenos">976</span></a>            <span class="n">filtered_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-977"><a href="#SemanticMemoryManager.get_memories_by_topic-977"><span class="linenos">977</span></a>            <span class="n">topic_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">}</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-978"><a href="#SemanticMemoryManager.get_memories_by_topic-978"><span class="linenos">978</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">user_memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-979"><a href="#SemanticMemoryManager.get_memories_by_topic-979"><span class="linenos">979</span></a>                <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-980"><a href="#SemanticMemoryManager.get_memories_by_topic-980"><span class="linenos">980</span></a>                    <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">topic_set</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-981"><a href="#SemanticMemoryManager.get_memories_by_topic-981"><span class="linenos">981</span></a>                <span class="p">):</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-982"><a href="#SemanticMemoryManager.get_memories_by_topic-982"><span class="linenos">982</span></a>                    <span class="n">filtered_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-983"><a href="#SemanticMemoryManager.get_memories_by_topic-983"><span class="linenos">983</span></a>
</span><span id="SemanticMemoryManager.get_memories_by_topic-984"><a href="#SemanticMemoryManager.get_memories_by_topic-984"><span class="linenos">984</span></a>            <span class="c1"># Sort by date (already sorted by read_memories) and limit</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-985"><a href="#SemanticMemoryManager.get_memories_by_topic-985"><span class="linenos">985</span></a>            <span class="k">return</span> <span class="n">filtered_memories</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-986"><a href="#SemanticMemoryManager.get_memories_by_topic-986"><span class="linenos">986</span></a>
</span><span id="SemanticMemoryManager.get_memories_by_topic-987"><a href="#SemanticMemoryManager.get_memories_by_topic-987"><span class="linenos">987</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-988"><a href="#SemanticMemoryManager.get_memories_by_topic-988"><span class="linenos">988</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error getting memories by topic: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_memories_by_topic-989"><a href="#SemanticMemoryManager.get_memories_by_topic-989"><span class="linenos">989</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Get memories filtered by a list of topics, without similarity search.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>user_id</strong>:  User ID to search within</li>
<li><strong>topics</strong>:  Optional list of topics to filter by. If None, returns all memories.</li>
<li><strong>limit</strong>:  Maximum number of results to return</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>List of UserMemory objects matching the topics.</p>
</blockquote>
</div>


                            </div>
                            <div id="SemanticMemoryManager.get_all_memories" class="classattr">
                                        <input id="SemanticMemoryManager.get_all_memories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_all_memories</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">UserMemory</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.get_all_memories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.get_all_memories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.get_all_memories-1083"><a href="#SemanticMemoryManager.get_all_memories-1083"><span class="linenos">1083</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">UserMemory</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager.get_all_memories-1084"><a href="#SemanticMemoryManager.get_all_memories-1084"><span class="linenos">1084</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.get_all_memories-1085"><a href="#SemanticMemoryManager.get_all_memories-1085"><span class="linenos">1085</span></a><span class="sd">        Get all memories for a user.</span>
</span><span id="SemanticMemoryManager.get_all_memories-1086"><a href="#SemanticMemoryManager.get_all_memories-1086"><span class="linenos">1086</span></a>
</span><span id="SemanticMemoryManager.get_all_memories-1087"><a href="#SemanticMemoryManager.get_all_memories-1087"><span class="linenos">1087</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager.get_all_memories-1088"><a href="#SemanticMemoryManager.get_all_memories-1088"><span class="linenos">1088</span></a><span class="sd">        :param user_id: User ID to retrieve memories for</span>
</span><span id="SemanticMemoryManager.get_all_memories-1089"><a href="#SemanticMemoryManager.get_all_memories-1089"><span class="linenos">1089</span></a><span class="sd">        :return: List of UserMemory objects</span>
</span><span id="SemanticMemoryManager.get_all_memories-1090"><a href="#SemanticMemoryManager.get_all_memories-1090"><span class="linenos">1090</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.get_all_memories-1091"><a href="#SemanticMemoryManager.get_all_memories-1091"><span class="linenos">1091</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager.get_all_memories-1092"><a href="#SemanticMemoryManager.get_all_memories-1092"><span class="linenos">1092</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_all_memories-1093"><a href="#SemanticMemoryManager.get_all_memories-1093"><span class="linenos">1093</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.get_all_memories-1094"><a href="#SemanticMemoryManager.get_all_memories-1094"><span class="linenos">1094</span></a>            
</span><span id="SemanticMemoryManager.get_all_memories-1095"><a href="#SemanticMemoryManager.get_all_memories-1095"><span class="linenos">1095</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_all_memories-1096"><a href="#SemanticMemoryManager.get_all_memories-1096"><span class="linenos">1096</span></a>            <span class="c1"># Get all memories for the user</span>
</span><span id="SemanticMemoryManager.get_all_memories-1097"><a href="#SemanticMemoryManager.get_all_memories-1097"><span class="linenos">1097</span></a>            <span class="n">memory_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_memories</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_all_memories-1098"><a href="#SemanticMemoryManager.get_all_memories-1098"><span class="linenos">1098</span></a>
</span><span id="SemanticMemoryManager.get_all_memories-1099"><a href="#SemanticMemoryManager.get_all_memories-1099"><span class="linenos">1099</span></a>            <span class="n">user_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager.get_all_memories-1100"><a href="#SemanticMemoryManager.get_all_memories-1100"><span class="linenos">1100</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">memory_rows</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_all_memories-1101"><a href="#SemanticMemoryManager.get_all_memories-1101"><span class="linenos">1101</span></a>                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_all_memories-1102"><a href="#SemanticMemoryManager.get_all_memories-1102"><span class="linenos">1102</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_all_memories-1103"><a href="#SemanticMemoryManager.get_all_memories-1103"><span class="linenos">1103</span></a>                        <span class="n">user_memory</span> <span class="o">=</span> <span class="n">UserMemory</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_all_memories-1104"><a href="#SemanticMemoryManager.get_all_memories-1104"><span class="linenos">1104</span></a>                        <span class="n">user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_memory</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_all_memories-1105"><a href="#SemanticMemoryManager.get_all_memories-1105"><span class="linenos">1105</span></a>                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_all_memories-1106"><a href="#SemanticMemoryManager.get_all_memories-1106"><span class="linenos">1106</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.get_all_memories-1107"><a href="#SemanticMemoryManager.get_all_memories-1107"><span class="linenos">1107</span></a>                            <span class="s2">&quot;Failed to convert memory row to UserMemory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span>
</span><span id="SemanticMemoryManager.get_all_memories-1108"><a href="#SemanticMemoryManager.get_all_memories-1108"><span class="linenos">1108</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager.get_all_memories-1109"><a href="#SemanticMemoryManager.get_all_memories-1109"><span class="linenos">1109</span></a>
</span><span id="SemanticMemoryManager.get_all_memories-1110"><a href="#SemanticMemoryManager.get_all_memories-1110"><span class="linenos">1110</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retrieved </span><span class="si">%d</span><span class="s2"> memories for user </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_memories</span><span class="p">),</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_all_memories-1111"><a href="#SemanticMemoryManager.get_all_memories-1111"><span class="linenos">1111</span></a>            <span class="k">return</span> <span class="n">user_memories</span>
</span><span id="SemanticMemoryManager.get_all_memories-1112"><a href="#SemanticMemoryManager.get_all_memories-1112"><span class="linenos">1112</span></a>
</span><span id="SemanticMemoryManager.get_all_memories-1113"><a href="#SemanticMemoryManager.get_all_memories-1113"><span class="linenos">1113</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_all_memories-1114"><a href="#SemanticMemoryManager.get_all_memories-1114"><span class="linenos">1114</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error retrieving all memories: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_all_memories-1115"><a href="#SemanticMemoryManager.get_all_memories-1115"><span class="linenos">1115</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Get all memories for a user.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>user_id</strong>:  User ID to retrieve memories for</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>List of UserMemory objects</p>
</blockquote>
</div>


                            </div>
                            <div id="SemanticMemoryManager.get_memory_stats" class="classattr">
                                        <input id="SemanticMemoryManager.get_memory_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_memory_stats</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.get_memory_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.get_memory_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.get_memory_stats-1117"><a href="#SemanticMemoryManager.get_memory_stats-1117"><span class="linenos">1117</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1118"><a href="#SemanticMemoryManager.get_memory_stats-1118"><span class="linenos">1118</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1119"><a href="#SemanticMemoryManager.get_memory_stats-1119"><span class="linenos">1119</span></a><span class="sd">        Get statistics about memories for a user.</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1120"><a href="#SemanticMemoryManager.get_memory_stats-1120"><span class="linenos">1120</span></a>
</span><span id="SemanticMemoryManager.get_memory_stats-1121"><a href="#SemanticMemoryManager.get_memory_stats-1121"><span class="linenos">1121</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1122"><a href="#SemanticMemoryManager.get_memory_stats-1122"><span class="linenos">1122</span></a><span class="sd">        :param user_id: User ID to analyze</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1123"><a href="#SemanticMemoryManager.get_memory_stats-1123"><span class="linenos">1123</span></a><span class="sd">        :return: Dictionary with memory statistics</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1124"><a href="#SemanticMemoryManager.get_memory_stats-1124"><span class="linenos">1124</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1125"><a href="#SemanticMemoryManager.get_memory_stats-1125"><span class="linenos">1125</span></a>        <span class="c1"># Get current user ID if not provided</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1126"><a href="#SemanticMemoryManager.get_memory_stats-1126"><span class="linenos">1126</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1127"><a href="#SemanticMemoryManager.get_memory_stats-1127"><span class="linenos">1127</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1128"><a href="#SemanticMemoryManager.get_memory_stats-1128"><span class="linenos">1128</span></a>            
</span><span id="SemanticMemoryManager.get_memory_stats-1129"><a href="#SemanticMemoryManager.get_memory_stats-1129"><span class="linenos">1129</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1130"><a href="#SemanticMemoryManager.get_memory_stats-1130"><span class="linenos">1130</span></a>            <span class="n">memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_recent_memories</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1131"><a href="#SemanticMemoryManager.get_memory_stats-1131"><span class="linenos">1131</span></a>
</span><span id="SemanticMemoryManager.get_memory_stats-1132"><a href="#SemanticMemoryManager.get_memory_stats-1132"><span class="linenos">1132</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1133"><a href="#SemanticMemoryManager.get_memory_stats-1133"><span class="linenos">1133</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total_memories&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1134"><a href="#SemanticMemoryManager.get_memory_stats-1134"><span class="linenos">1134</span></a>
</span><span id="SemanticMemoryManager.get_memory_stats-1135"><a href="#SemanticMemoryManager.get_memory_stats-1135"><span class="linenos">1135</span></a>            <span class="c1"># Topic distribution</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1136"><a href="#SemanticMemoryManager.get_memory_stats-1136"><span class="linenos">1136</span></a>            <span class="n">topic_counts</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1137"><a href="#SemanticMemoryManager.get_memory_stats-1137"><span class="linenos">1137</span></a>            <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1138"><a href="#SemanticMemoryManager.get_memory_stats-1138"><span class="linenos">1138</span></a>                <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1139"><a href="#SemanticMemoryManager.get_memory_stats-1139"><span class="linenos">1139</span></a>                    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">memory</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1140"><a href="#SemanticMemoryManager.get_memory_stats-1140"><span class="linenos">1140</span></a>                        <span class="n">topic_counts</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="o">=</span> <span class="n">topic_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1141"><a href="#SemanticMemoryManager.get_memory_stats-1141"><span class="linenos">1141</span></a>
</span><span id="SemanticMemoryManager.get_memory_stats-1142"><a href="#SemanticMemoryManager.get_memory_stats-1142"><span class="linenos">1142</span></a>            <span class="c1"># Average memory length</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1143"><a href="#SemanticMemoryManager.get_memory_stats-1143"><span class="linenos">1143</span></a>            <span class="n">avg_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1144"><a href="#SemanticMemoryManager.get_memory_stats-1144"><span class="linenos">1144</span></a>
</span><span id="SemanticMemoryManager.get_memory_stats-1145"><a href="#SemanticMemoryManager.get_memory_stats-1145"><span class="linenos">1145</span></a>            <span class="c1"># Recent activity (memories in last 24 hours)</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1146"><a href="#SemanticMemoryManager.get_memory_stats-1146"><span class="linenos">1146</span></a>            <span class="n">recent_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1147"><a href="#SemanticMemoryManager.get_memory_stats-1147"><span class="linenos">1147</span></a>            <span class="k">if</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1148"><a href="#SemanticMemoryManager.get_memory_stats-1148"><span class="linenos">1148</span></a>                <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1149"><a href="#SemanticMemoryManager.get_memory_stats-1149"><span class="linenos">1149</span></a>                    <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1150"><a href="#SemanticMemoryManager.get_memory_stats-1150"><span class="linenos">1150</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1151"><a href="#SemanticMemoryManager.get_memory_stats-1151"><span class="linenos">1151</span></a>                <span class="k">for</span> <span class="n">memory</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1152"><a href="#SemanticMemoryManager.get_memory_stats-1152"><span class="linenos">1152</span></a>                    <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">last_updated</span> <span class="ow">and</span> <span class="n">memory</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">&gt;=</span> <span class="n">cutoff</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1153"><a href="#SemanticMemoryManager.get_memory_stats-1153"><span class="linenos">1153</span></a>                        <span class="n">recent_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1154"><a href="#SemanticMemoryManager.get_memory_stats-1154"><span class="linenos">1154</span></a>
</span><span id="SemanticMemoryManager.get_memory_stats-1155"><a href="#SemanticMemoryManager.get_memory_stats-1155"><span class="linenos">1155</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1156"><a href="#SemanticMemoryManager.get_memory_stats-1156"><span class="linenos">1156</span></a>                <span class="s2">&quot;total_memories&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">),</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1157"><a href="#SemanticMemoryManager.get_memory_stats-1157"><span class="linenos">1157</span></a>                <span class="s2">&quot;topic_distribution&quot;</span><span class="p">:</span> <span class="n">topic_counts</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1158"><a href="#SemanticMemoryManager.get_memory_stats-1158"><span class="linenos">1158</span></a>                <span class="s2">&quot;average_memory_length&quot;</span><span class="p">:</span> <span class="n">avg_length</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1159"><a href="#SemanticMemoryManager.get_memory_stats-1159"><span class="linenos">1159</span></a>                <span class="s2">&quot;recent_memories_24h&quot;</span><span class="p">:</span> <span class="n">recent_count</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1160"><a href="#SemanticMemoryManager.get_memory_stats-1160"><span class="linenos">1160</span></a>                <span class="s2">&quot;most_common_topic&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1161"><a href="#SemanticMemoryManager.get_memory_stats-1161"><span class="linenos">1161</span></a>                    <span class="nb">max</span><span class="p">(</span><span class="n">topic_counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1162"><a href="#SemanticMemoryManager.get_memory_stats-1162"><span class="linenos">1162</span></a>                    <span class="k">if</span> <span class="n">topic_counts</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1163"><a href="#SemanticMemoryManager.get_memory_stats-1163"><span class="linenos">1163</span></a>                    <span class="k">else</span> <span class="kc">None</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1164"><a href="#SemanticMemoryManager.get_memory_stats-1164"><span class="linenos">1164</span></a>                <span class="p">),</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1165"><a href="#SemanticMemoryManager.get_memory_stats-1165"><span class="linenos">1165</span></a>            <span class="p">}</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1166"><a href="#SemanticMemoryManager.get_memory_stats-1166"><span class="linenos">1166</span></a>
</span><span id="SemanticMemoryManager.get_memory_stats-1167"><a href="#SemanticMemoryManager.get_memory_stats-1167"><span class="linenos">1167</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1168"><a href="#SemanticMemoryManager.get_memory_stats-1168"><span class="linenos">1168</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error getting memory stats: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.get_memory_stats-1169"><a href="#SemanticMemoryManager.get_memory_stats-1169"><span class="linenos">1169</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</span></pre></div>


            <div class="docstring"><p>Get statistics about memories for a user.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>user_id</strong>:  User ID to analyze</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Dictionary with memory statistics</p>
</blockquote>
</div>


                            </div>
                            <div id="SemanticMemoryManager.process_input" class="classattr">
                                        <input id="SemanticMemoryManager.process_input-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_input</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">input_text</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">extract_multiple</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.process_input-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.process_input"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.process_input-1171"><a href="#SemanticMemoryManager.process_input-1171"><span class="linenos">1171</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_input</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.process_input-1172"><a href="#SemanticMemoryManager.process_input-1172"><span class="linenos">1172</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1173"><a href="#SemanticMemoryManager.process_input-1173"><span class="linenos">1173</span></a>        <span class="n">input_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1174"><a href="#SemanticMemoryManager.process_input-1174"><span class="linenos">1174</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1175"><a href="#SemanticMemoryManager.process_input-1175"><span class="linenos">1175</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1176"><a href="#SemanticMemoryManager.process_input-1176"><span class="linenos">1176</span></a>        <span class="n">extract_multiple</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1177"><a href="#SemanticMemoryManager.process_input-1177"><span class="linenos">1177</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager.process_input-1178"><a href="#SemanticMemoryManager.process_input-1178"><span class="linenos">1178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.process_input-1179"><a href="#SemanticMemoryManager.process_input-1179"><span class="linenos">1179</span></a><span class="sd">        Process input text and extract memories without using LLM.</span>
</span><span id="SemanticMemoryManager.process_input-1180"><a href="#SemanticMemoryManager.process_input-1180"><span class="linenos">1180</span></a>
</span><span id="SemanticMemoryManager.process_input-1181"><a href="#SemanticMemoryManager.process_input-1181"><span class="linenos">1181</span></a><span class="sd">        This method uses simple heuristics to determine if the input contains</span>
</span><span id="SemanticMemoryManager.process_input-1182"><a href="#SemanticMemoryManager.process_input-1182"><span class="linenos">1182</span></a><span class="sd">        memorable information and extracts it accordingly.</span>
</span><span id="SemanticMemoryManager.process_input-1183"><a href="#SemanticMemoryManager.process_input-1183"><span class="linenos">1183</span></a>
</span><span id="SemanticMemoryManager.process_input-1184"><a href="#SemanticMemoryManager.process_input-1184"><span class="linenos">1184</span></a><span class="sd">        :param input_text: Input text to process</span>
</span><span id="SemanticMemoryManager.process_input-1185"><a href="#SemanticMemoryManager.process_input-1185"><span class="linenos">1185</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager.process_input-1186"><a href="#SemanticMemoryManager.process_input-1186"><span class="linenos">1186</span></a><span class="sd">        :param user_id: User ID for the memories</span>
</span><span id="SemanticMemoryManager.process_input-1187"><a href="#SemanticMemoryManager.process_input-1187"><span class="linenos">1187</span></a><span class="sd">        :param extract_multiple: Whether to try extracting multiple memories from input</span>
</span><span id="SemanticMemoryManager.process_input-1188"><a href="#SemanticMemoryManager.process_input-1188"><span class="linenos">1188</span></a><span class="sd">        :return: Dictionary with processing results</span>
</span><span id="SemanticMemoryManager.process_input-1189"><a href="#SemanticMemoryManager.process_input-1189"><span class="linenos">1189</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.process_input-1190"><a href="#SemanticMemoryManager.process_input-1190"><span class="linenos">1190</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SemanticMemoryManager.process_input-1191"><a href="#SemanticMemoryManager.process_input-1191"><span class="linenos">1191</span></a>            <span class="s2">&quot;memories_added&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="SemanticMemoryManager.process_input-1192"><a href="#SemanticMemoryManager.process_input-1192"><span class="linenos">1192</span></a>            <span class="s2">&quot;memories_rejected&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="SemanticMemoryManager.process_input-1193"><a href="#SemanticMemoryManager.process_input-1193"><span class="linenos">1193</span></a>            <span class="s2">&quot;total_processed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1194"><a href="#SemanticMemoryManager.process_input-1194"><span class="linenos">1194</span></a>            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1195"><a href="#SemanticMemoryManager.process_input-1195"><span class="linenos">1195</span></a>            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Processing completed&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1196"><a href="#SemanticMemoryManager.process_input-1196"><span class="linenos">1196</span></a>        <span class="p">}</span>
</span><span id="SemanticMemoryManager.process_input-1197"><a href="#SemanticMemoryManager.process_input-1197"><span class="linenos">1197</span></a>
</span><span id="SemanticMemoryManager.process_input-1198"><a href="#SemanticMemoryManager.process_input-1198"><span class="linenos">1198</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.process_input-1199"><a href="#SemanticMemoryManager.process_input-1199"><span class="linenos">1199</span></a>            <span class="c1"># Simple heuristics to extract memorable statements</span>
</span><span id="SemanticMemoryManager.process_input-1200"><a href="#SemanticMemoryManager.process_input-1200"><span class="linenos">1200</span></a>            <span class="n">memorable_statements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_memorable_statements</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.process_input-1201"><a href="#SemanticMemoryManager.process_input-1201"><span class="linenos">1201</span></a>
</span><span id="SemanticMemoryManager.process_input-1202"><a href="#SemanticMemoryManager.process_input-1202"><span class="linenos">1202</span></a>            <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">memorable_statements</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.process_input-1203"><a href="#SemanticMemoryManager.process_input-1203"><span class="linenos">1203</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.process_input-1204"><a href="#SemanticMemoryManager.process_input-1204"><span class="linenos">1204</span></a>                    <span class="n">memory_text</span><span class="o">=</span><span class="n">statement</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1205"><a href="#SemanticMemoryManager.process_input-1205"><span class="linenos">1205</span></a>                    <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1206"><a href="#SemanticMemoryManager.process_input-1206"><span class="linenos">1206</span></a>                    <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1207"><a href="#SemanticMemoryManager.process_input-1207"><span class="linenos">1207</span></a>                    <span class="n">input_text</span><span class="o">=</span><span class="n">input_text</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1208"><a href="#SemanticMemoryManager.process_input-1208"><span class="linenos">1208</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager.process_input-1209"><a href="#SemanticMemoryManager.process_input-1209"><span class="linenos">1209</span></a>
</span><span id="SemanticMemoryManager.process_input-1210"><a href="#SemanticMemoryManager.process_input-1210"><span class="linenos">1210</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;total_processed&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager.process_input-1211"><a href="#SemanticMemoryManager.process_input-1211"><span class="linenos">1211</span></a>
</span><span id="SemanticMemoryManager.process_input-1212"><a href="#SemanticMemoryManager.process_input-1212"><span class="linenos">1212</span></a>                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">is_success</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.process_input-1213"><a href="#SemanticMemoryManager.process_input-1213"><span class="linenos">1213</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;memories_added&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.process_input-1214"><a href="#SemanticMemoryManager.process_input-1214"><span class="linenos">1214</span></a>                        <span class="p">{</span>
</span><span id="SemanticMemoryManager.process_input-1215"><a href="#SemanticMemoryManager.process_input-1215"><span class="linenos">1215</span></a>                            <span class="s2">&quot;memory_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">memory_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1216"><a href="#SemanticMemoryManager.process_input-1216"><span class="linenos">1216</span></a>                            <span class="s2">&quot;memory&quot;</span><span class="p">:</span> <span class="n">statement</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1217"><a href="#SemanticMemoryManager.process_input-1217"><span class="linenos">1217</span></a>                            <span class="s2">&quot;topics&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">topics</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.process_input-1218"><a href="#SemanticMemoryManager.process_input-1218"><span class="linenos">1218</span></a>                        <span class="p">}</span>
</span><span id="SemanticMemoryManager.process_input-1219"><a href="#SemanticMemoryManager.process_input-1219"><span class="linenos">1219</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager.process_input-1220"><a href="#SemanticMemoryManager.process_input-1220"><span class="linenos">1220</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.process_input-1221"><a href="#SemanticMemoryManager.process_input-1221"><span class="linenos">1221</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;memories_rejected&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.process_input-1222"><a href="#SemanticMemoryManager.process_input-1222"><span class="linenos">1222</span></a>                        <span class="p">{</span><span class="s2">&quot;memory&quot;</span><span class="p">:</span> <span class="n">statement</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="p">}</span>
</span><span id="SemanticMemoryManager.process_input-1223"><a href="#SemanticMemoryManager.process_input-1223"><span class="linenos">1223</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager.process_input-1224"><a href="#SemanticMemoryManager.process_input-1224"><span class="linenos">1224</span></a>
</span><span id="SemanticMemoryManager.process_input-1225"><a href="#SemanticMemoryManager.process_input-1225"><span class="linenos">1225</span></a>            <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;memories_added&quot;</span><span class="p">]:</span>
</span><span id="SemanticMemoryManager.process_input-1226"><a href="#SemanticMemoryManager.process_input-1226"><span class="linenos">1226</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager.process_input-1227"><a href="#SemanticMemoryManager.process_input-1227"><span class="linenos">1227</span></a>
</span><span id="SemanticMemoryManager.process_input-1228"><a href="#SemanticMemoryManager.process_input-1228"><span class="linenos">1228</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.process_input-1229"><a href="#SemanticMemoryManager.process_input-1229"><span class="linenos">1229</span></a>            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SemanticMemoryManager.process_input-1230"><a href="#SemanticMemoryManager.process_input-1230"><span class="linenos">1230</span></a>            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error processing input: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager.process_input-1231"><a href="#SemanticMemoryManager.process_input-1231"><span class="linenos">1231</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error processing input: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.process_input-1232"><a href="#SemanticMemoryManager.process_input-1232"><span class="linenos">1232</span></a>
</span><span id="SemanticMemoryManager.process_input-1233"><a href="#SemanticMemoryManager.process_input-1233"><span class="linenos">1233</span></a>        <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Process input text and extract memories without using LLM.</p>

<p>This method uses simple heuristics to determine if the input contains
memorable information and extracts it accordingly.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>input_text</strong>:  Input text to process</li>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>user_id</strong>:  User ID for the memories</li>
<li><strong>extract_multiple</strong>:  Whether to try extracting multiple memories from input</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Dictionary with processing results</p>
</blockquote>
</div>


                            </div>
                            <div id="SemanticMemoryManager.create_or_update_memories" class="classattr">
                                        <input id="SemanticMemoryManager.create_or_update_memories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_or_update_memories</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">messages</span><span class="p">:</span> <span class="n">List</span>,</span><span class="param">	<span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.create_or_update_memories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.create_or_update_memories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.create_or_update_memories-1235"><a href="#SemanticMemoryManager.create_or_update_memories-1235"><span class="linenos">1235</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_or_update_memories</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1236"><a href="#SemanticMemoryManager.create_or_update_memories-1236"><span class="linenos">1236</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1237"><a href="#SemanticMemoryManager.create_or_update_memories-1237"><span class="linenos">1237</span></a>        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>  <span class="c1"># List[Message] from agno.models.message</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1238"><a href="#SemanticMemoryManager.create_or_update_memories-1238"><span class="linenos">1238</span></a>        <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1239"><a href="#SemanticMemoryManager.create_or_update_memories-1239"><span class="linenos">1239</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1240"><a href="#SemanticMemoryManager.create_or_update_memories-1240"><span class="linenos">1240</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1241"><a href="#SemanticMemoryManager.create_or_update_memories-1241"><span class="linenos">1241</span></a>        <span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1242"><a href="#SemanticMemoryManager.create_or_update_memories-1242"><span class="linenos">1242</span></a>        <span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1243"><a href="#SemanticMemoryManager.create_or_update_memories-1243"><span class="linenos">1243</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1244"><a href="#SemanticMemoryManager.create_or_update_memories-1244"><span class="linenos">1244</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1245"><a href="#SemanticMemoryManager.create_or_update_memories-1245"><span class="linenos">1245</span></a><span class="sd">        Create or update memories based on messages - LLM-free implementation.</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1246"><a href="#SemanticMemoryManager.create_or_update_memories-1246"><span class="linenos">1246</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1247"><a href="#SemanticMemoryManager.create_or_update_memories-1247"><span class="linenos">1247</span></a><span class="sd">        This method provides the same interface as Agno&#39;s MemoryManager but uses</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1248"><a href="#SemanticMemoryManager.create_or_update_memories-1248"><span class="linenos">1248</span></a><span class="sd">        semantic analysis instead of LLM calls for better performance and reliability.</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1249"><a href="#SemanticMemoryManager.create_or_update_memories-1249"><span class="linenos">1249</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1250"><a href="#SemanticMemoryManager.create_or_update_memories-1250"><span class="linenos">1250</span></a><span class="sd">        :param messages: List of Message objects to process</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1251"><a href="#SemanticMemoryManager.create_or_update_memories-1251"><span class="linenos">1251</span></a><span class="sd">        :param existing_memories: List of existing memory dictionaries</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1252"><a href="#SemanticMemoryManager.create_or_update_memories-1252"><span class="linenos">1252</span></a><span class="sd">        :param user_id: User ID for the memories</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1253"><a href="#SemanticMemoryManager.create_or_update_memories-1253"><span class="linenos">1253</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1254"><a href="#SemanticMemoryManager.create_or_update_memories-1254"><span class="linenos">1254</span></a><span class="sd">        :param delete_memories: Whether deletion is enabled (not used in our implementation)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1255"><a href="#SemanticMemoryManager.create_or_update_memories-1255"><span class="linenos">1255</span></a><span class="sd">        :param clear_memories: Whether clearing is enabled (not used in our implementation)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1256"><a href="#SemanticMemoryManager.create_or_update_memories-1256"><span class="linenos">1256</span></a><span class="sd">        :return: String describing the actions taken</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1257"><a href="#SemanticMemoryManager.create_or_update_memories-1257"><span class="linenos">1257</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1258"><a href="#SemanticMemoryManager.create_or_update_memories-1258"><span class="linenos">1258</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SemanticMemoryManager.create_or_update_memories Start&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1259"><a href="#SemanticMemoryManager.create_or_update_memories-1259"><span class="linenos">1259</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1260"><a href="#SemanticMemoryManager.create_or_update_memories-1260"><span class="linenos">1260</span></a>        <span class="c1"># Create a simple memory class for duplicate checking</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1261"><a href="#SemanticMemoryManager.create_or_update_memories-1261"><span class="linenos">1261</span></a>        <span class="k">class</span><span class="w"> </span><span class="nc">SimpleMemory</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1262"><a href="#SemanticMemoryManager.create_or_update_memories-1262"><span class="linenos">1262</span></a>            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1263"><a href="#SemanticMemoryManager.create_or_update_memories-1263"><span class="linenos">1263</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory_text</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1264"><a href="#SemanticMemoryManager.create_or_update_memories-1264"><span class="linenos">1264</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">memory_id</span> <span class="o">=</span> <span class="n">memory_id</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1265"><a href="#SemanticMemoryManager.create_or_update_memories-1265"><span class="linenos">1265</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1266"><a href="#SemanticMemoryManager.create_or_update_memories-1266"><span class="linenos">1266</span></a>        <span class="c1"># Convert existing memories to UserMemory objects for our processing</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1267"><a href="#SemanticMemoryManager.create_or_update_memories-1267"><span class="linenos">1267</span></a>        <span class="n">existing_user_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1268"><a href="#SemanticMemoryManager.create_or_update_memories-1268"><span class="linenos">1268</span></a>        <span class="k">for</span> <span class="n">mem_dict</span> <span class="ow">in</span> <span class="n">existing_memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1269"><a href="#SemanticMemoryManager.create_or_update_memories-1269"><span class="linenos">1269</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1270"><a href="#SemanticMemoryManager.create_or_update_memories-1270"><span class="linenos">1270</span></a>                <span class="c1"># Create a UserMemory-like object for our duplicate detection</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1271"><a href="#SemanticMemoryManager.create_or_update_memories-1271"><span class="linenos">1271</span></a>                <span class="n">memory_text</span> <span class="o">=</span> <span class="n">mem_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1272"><a href="#SemanticMemoryManager.create_or_update_memories-1272"><span class="linenos">1272</span></a>                <span class="k">if</span> <span class="n">memory_text</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1273"><a href="#SemanticMemoryManager.create_or_update_memories-1273"><span class="linenos">1273</span></a>                    <span class="n">existing_user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1274"><a href="#SemanticMemoryManager.create_or_update_memories-1274"><span class="linenos">1274</span></a>                        <span class="n">SimpleMemory</span><span class="p">(</span><span class="n">memory_text</span><span class="p">,</span> <span class="n">mem_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1275"><a href="#SemanticMemoryManager.create_or_update_memories-1275"><span class="linenos">1275</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1276"><a href="#SemanticMemoryManager.create_or_update_memories-1276"><span class="linenos">1276</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1277"><a href="#SemanticMemoryManager.create_or_update_memories-1277"><span class="linenos">1277</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process existing memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1278"><a href="#SemanticMemoryManager.create_or_update_memories-1278"><span class="linenos">1278</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1279"><a href="#SemanticMemoryManager.create_or_update_memories-1279"><span class="linenos">1279</span></a>        <span class="c1"># Extract text content from messages</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1280"><a href="#SemanticMemoryManager.create_or_update_memories-1280"><span class="linenos">1280</span></a>        <span class="n">message_texts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1281"><a href="#SemanticMemoryManager.create_or_update_memories-1281"><span class="linenos">1281</span></a>        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1282"><a href="#SemanticMemoryManager.create_or_update_memories-1282"><span class="linenos">1282</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1283"><a href="#SemanticMemoryManager.create_or_update_memories-1283"><span class="linenos">1283</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1284"><a href="#SemanticMemoryManager.create_or_update_memories-1284"><span class="linenos">1284</span></a>                    <span class="c1"># Only process user messages for memory extraction</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1285"><a href="#SemanticMemoryManager.create_or_update_memories-1285"><span class="linenos">1285</span></a>                    <span class="n">message_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1286"><a href="#SemanticMemoryManager.create_or_update_memories-1286"><span class="linenos">1286</span></a>            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;get_content_string&quot;</span><span class="p">):</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1287"><a href="#SemanticMemoryManager.create_or_update_memories-1287"><span class="linenos">1287</span></a>                <span class="c1"># Use agno&#39;s method to get content</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1288"><a href="#SemanticMemoryManager.create_or_update_memories-1288"><span class="linenos">1288</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_content_string</span><span class="p">()</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1289"><a href="#SemanticMemoryManager.create_or_update_memories-1289"><span class="linenos">1289</span></a>                <span class="k">if</span> <span class="n">content</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1290"><a href="#SemanticMemoryManager.create_or_update_memories-1290"><span class="linenos">1290</span></a>                    <span class="n">message_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1291"><a href="#SemanticMemoryManager.create_or_update_memories-1291"><span class="linenos">1291</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1292"><a href="#SemanticMemoryManager.create_or_update_memories-1292"><span class="linenos">1292</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">message_texts</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1293"><a href="#SemanticMemoryManager.create_or_update_memories-1293"><span class="linenos">1293</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No user messages found to process&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1294"><a href="#SemanticMemoryManager.create_or_update_memories-1294"><span class="linenos">1294</span></a>            <span class="k">return</span> <span class="s2">&quot;No user messages to process for memory creation&quot;</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1295"><a href="#SemanticMemoryManager.create_or_update_memories-1295"><span class="linenos">1295</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1296"><a href="#SemanticMemoryManager.create_or_update_memories-1296"><span class="linenos">1296</span></a>        <span class="c1"># Combine all message texts</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1297"><a href="#SemanticMemoryManager.create_or_update_memories-1297"><span class="linenos">1297</span></a>        <span class="n">combined_input</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message_texts</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1298"><a href="#SemanticMemoryManager.create_or_update_memories-1298"><span class="linenos">1298</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1299"><a href="#SemanticMemoryManager.create_or_update_memories-1299"><span class="linenos">1299</span></a>        <span class="c1"># Extract memorable statements</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1300"><a href="#SemanticMemoryManager.create_or_update_memories-1300"><span class="linenos">1300</span></a>        <span class="n">memorable_statements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_memorable_statements</span><span class="p">(</span><span class="n">combined_input</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1301"><a href="#SemanticMemoryManager.create_or_update_memories-1301"><span class="linenos">1301</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1302"><a href="#SemanticMemoryManager.create_or_update_memories-1302"><span class="linenos">1302</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">memorable_statements</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1303"><a href="#SemanticMemoryManager.create_or_update_memories-1303"><span class="linenos">1303</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No memorable statements found in messages&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1304"><a href="#SemanticMemoryManager.create_or_update_memories-1304"><span class="linenos">1304</span></a>            <span class="k">return</span> <span class="s2">&quot;No memorable information found in the messages&quot;</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1305"><a href="#SemanticMemoryManager.create_or_update_memories-1305"><span class="linenos">1305</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1306"><a href="#SemanticMemoryManager.create_or_update_memories-1306"><span class="linenos">1306</span></a>        <span class="c1"># Process each memorable statement</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1307"><a href="#SemanticMemoryManager.create_or_update_memories-1307"><span class="linenos">1307</span></a>        <span class="n">actions_taken</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1308"><a href="#SemanticMemoryManager.create_or_update_memories-1308"><span class="linenos">1308</span></a>        <span class="n">memories_added</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1309"><a href="#SemanticMemoryManager.create_or_update_memories-1309"><span class="linenos">1309</span></a>        <span class="n">memories_rejected</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1310"><a href="#SemanticMemoryManager.create_or_update_memories-1310"><span class="linenos">1310</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1311"><a href="#SemanticMemoryManager.create_or_update_memories-1311"><span class="linenos">1311</span></a>        <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">memorable_statements</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1312"><a href="#SemanticMemoryManager.create_or_update_memories-1312"><span class="linenos">1312</span></a>            <span class="c1"># Check for duplicates against existing memories</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1313"><a href="#SemanticMemoryManager.create_or_update_memories-1313"><span class="linenos">1313</span></a>            <span class="n">should_reject</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_reject_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1314"><a href="#SemanticMemoryManager.create_or_update_memories-1314"><span class="linenos">1314</span></a>                <span class="n">statement</span><span class="p">,</span> <span class="n">existing_user_memories</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1315"><a href="#SemanticMemoryManager.create_or_update_memories-1315"><span class="linenos">1315</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1316"><a href="#SemanticMemoryManager.create_or_update_memories-1316"><span class="linenos">1316</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1317"><a href="#SemanticMemoryManager.create_or_update_memories-1317"><span class="linenos">1317</span></a>            <span class="k">if</span> <span class="n">should_reject</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1318"><a href="#SemanticMemoryManager.create_or_update_memories-1318"><span class="linenos">1318</span></a>                <span class="n">memories_rejected</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1319"><a href="#SemanticMemoryManager.create_or_update_memories-1319"><span class="linenos">1319</span></a>                <span class="n">actions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rejected: &#39;</span><span class="si">{</span><span class="n">statement</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; - </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1320"><a href="#SemanticMemoryManager.create_or_update_memories-1320"><span class="linenos">1320</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rejected memory: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1321"><a href="#SemanticMemoryManager.create_or_update_memories-1321"><span class="linenos">1321</span></a>                <span class="k">continue</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1322"><a href="#SemanticMemoryManager.create_or_update_memories-1322"><span class="linenos">1322</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1323"><a href="#SemanticMemoryManager.create_or_update_memories-1323"><span class="linenos">1323</span></a>            <span class="c1"># Add the memory</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1324"><a href="#SemanticMemoryManager.create_or_update_memories-1324"><span class="linenos">1324</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1325"><a href="#SemanticMemoryManager.create_or_update_memories-1325"><span class="linenos">1325</span></a>                <span class="n">memory_text</span><span class="o">=</span><span class="n">statement</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1326"><a href="#SemanticMemoryManager.create_or_update_memories-1326"><span class="linenos">1326</span></a>                <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1327"><a href="#SemanticMemoryManager.create_or_update_memories-1327"><span class="linenos">1327</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1328"><a href="#SemanticMemoryManager.create_or_update_memories-1328"><span class="linenos">1328</span></a>                <span class="n">input_text</span><span class="o">=</span><span class="n">combined_input</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1329"><a href="#SemanticMemoryManager.create_or_update_memories-1329"><span class="linenos">1329</span></a>            <span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1330"><a href="#SemanticMemoryManager.create_or_update_memories-1330"><span class="linenos">1330</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1331"><a href="#SemanticMemoryManager.create_or_update_memories-1331"><span class="linenos">1331</span></a>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">is_success</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1332"><a href="#SemanticMemoryManager.create_or_update_memories-1332"><span class="linenos">1332</span></a>                <span class="n">memories_added</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1333"><a href="#SemanticMemoryManager.create_or_update_memories-1333"><span class="linenos">1333</span></a>                <span class="n">actions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added: &#39;</span><span class="si">{</span><span class="n">statement</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1334"><a href="#SemanticMemoryManager.create_or_update_memories-1334"><span class="linenos">1334</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added memory: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1335"><a href="#SemanticMemoryManager.create_or_update_memories-1335"><span class="linenos">1335</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1336"><a href="#SemanticMemoryManager.create_or_update_memories-1336"><span class="linenos">1336</span></a>                <span class="c1"># Add to existing memories list for subsequent duplicate checking</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1337"><a href="#SemanticMemoryManager.create_or_update_memories-1337"><span class="linenos">1337</span></a>                <span class="n">existing_user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SimpleMemory</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">memory_id</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1338"><a href="#SemanticMemoryManager.create_or_update_memories-1338"><span class="linenos">1338</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1339"><a href="#SemanticMemoryManager.create_or_update_memories-1339"><span class="linenos">1339</span></a>                <span class="n">memories_rejected</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1340"><a href="#SemanticMemoryManager.create_or_update_memories-1340"><span class="linenos">1340</span></a>                <span class="n">actions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1341"><a href="#SemanticMemoryManager.create_or_update_memories-1341"><span class="linenos">1341</span></a>                    <span class="sa">f</span><span class="s2">&quot;Failed to add: &#39;</span><span class="si">{</span><span class="n">statement</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; - </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1342"><a href="#SemanticMemoryManager.create_or_update_memories-1342"><span class="linenos">1342</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1343"><a href="#SemanticMemoryManager.create_or_update_memories-1343"><span class="linenos">1343</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to add memory: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1344"><a href="#SemanticMemoryManager.create_or_update_memories-1344"><span class="linenos">1344</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1345"><a href="#SemanticMemoryManager.create_or_update_memories-1345"><span class="linenos">1345</span></a>        <span class="c1"># Set memories_updated flag if any memories were added</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1346"><a href="#SemanticMemoryManager.create_or_update_memories-1346"><span class="linenos">1346</span></a>        <span class="k">if</span> <span class="n">memories_added</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1347"><a href="#SemanticMemoryManager.create_or_update_memories-1347"><span class="linenos">1347</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1348"><a href="#SemanticMemoryManager.create_or_update_memories-1348"><span class="linenos">1348</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1349"><a href="#SemanticMemoryManager.create_or_update_memories-1349"><span class="linenos">1349</span></a>        <span class="c1"># Create response summary</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1350"><a href="#SemanticMemoryManager.create_or_update_memories-1350"><span class="linenos">1350</span></a>        <span class="n">response_parts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1351"><a href="#SemanticMemoryManager.create_or_update_memories-1351"><span class="linenos">1351</span></a>            <span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memorable_statements</span><span class="p">)</span><span class="si">}</span><span class="s2"> memorable statements&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1352"><a href="#SemanticMemoryManager.create_or_update_memories-1352"><span class="linenos">1352</span></a>            <span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">memories_added</span><span class="si">}</span><span class="s2"> new memories&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1353"><a href="#SemanticMemoryManager.create_or_update_memories-1353"><span class="linenos">1353</span></a>            <span class="sa">f</span><span class="s2">&quot;Rejected </span><span class="si">{</span><span class="n">memories_rejected</span><span class="si">}</span><span class="s2"> duplicates/invalid memories&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1354"><a href="#SemanticMemoryManager.create_or_update_memories-1354"><span class="linenos">1354</span></a>        <span class="p">]</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1355"><a href="#SemanticMemoryManager.create_or_update_memories-1355"><span class="linenos">1355</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1356"><a href="#SemanticMemoryManager.create_or_update_memories-1356"><span class="linenos">1356</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="ow">and</span> <span class="n">actions_taken</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1357"><a href="#SemanticMemoryManager.create_or_update_memories-1357"><span class="linenos">1357</span></a>            <span class="n">response_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Actions taken:&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1358"><a href="#SemanticMemoryManager.create_or_update_memories-1358"><span class="linenos">1358</span></a>            <span class="n">response_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">actions_taken</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>  <span class="c1"># Limit to first 5 actions</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1359"><a href="#SemanticMemoryManager.create_or_update_memories-1359"><span class="linenos">1359</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions_taken</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1360"><a href="#SemanticMemoryManager.create_or_update_memories-1360"><span class="linenos">1360</span></a>                <span class="n">response_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">actions_taken</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more actions&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1361"><a href="#SemanticMemoryManager.create_or_update_memories-1361"><span class="linenos">1361</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1362"><a href="#SemanticMemoryManager.create_or_update_memories-1362"><span class="linenos">1362</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;. &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">response_parts</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1363"><a href="#SemanticMemoryManager.create_or_update_memories-1363"><span class="linenos">1363</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SemanticMemoryManager.create_or_update_memories End&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.create_or_update_memories-1364"><a href="#SemanticMemoryManager.create_or_update_memories-1364"><span class="linenos">1364</span></a>
</span><span id="SemanticMemoryManager.create_or_update_memories-1365"><a href="#SemanticMemoryManager.create_or_update_memories-1365"><span class="linenos">1365</span></a>        <span class="k">return</span> <span class="n">response</span>
</span></pre></div>


            <div class="docstring"><p>Create or update memories based on messages - LLM-free implementation.</p>

<p>This method provides the same interface as Agno's MemoryManager but uses
semantic analysis instead of LLM calls for better performance and reliability.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>messages</strong>:  List of Message objects to process</li>
<li><strong>existing_memories</strong>:  List of existing memory dictionaries</li>
<li><strong>user_id</strong>:  User ID for the memories</li>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>delete_memories</strong>:  Whether deletion is enabled (not used in our implementation)</li>
<li><strong>clear_memories</strong>:  Whether clearing is enabled (not used in our implementation)</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>String describing the actions taken</p>
</blockquote>
</div>


                            </div>
                            <div id="SemanticMemoryManager.acreate_or_update_memories" class="classattr">
                                        <input id="SemanticMemoryManager.acreate_or_update_memories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">acreate_or_update_memories</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">messages</span><span class="p">:</span> <span class="n">List</span>,</span><span class="param">	<span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.acreate_or_update_memories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.acreate_or_update_memories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.acreate_or_update_memories-1367"><a href="#SemanticMemoryManager.acreate_or_update_memories-1367"><span class="linenos">1367</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">acreate_or_update_memories</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1368"><a href="#SemanticMemoryManager.acreate_or_update_memories-1368"><span class="linenos">1368</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1369"><a href="#SemanticMemoryManager.acreate_or_update_memories-1369"><span class="linenos">1369</span></a>        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>  <span class="c1"># List[Message] from agno.models.message</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1370"><a href="#SemanticMemoryManager.acreate_or_update_memories-1370"><span class="linenos">1370</span></a>        <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1371"><a href="#SemanticMemoryManager.acreate_or_update_memories-1371"><span class="linenos">1371</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1372"><a href="#SemanticMemoryManager.acreate_or_update_memories-1372"><span class="linenos">1372</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1373"><a href="#SemanticMemoryManager.acreate_or_update_memories-1373"><span class="linenos">1373</span></a>        <span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1374"><a href="#SemanticMemoryManager.acreate_or_update_memories-1374"><span class="linenos">1374</span></a>        <span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1375"><a href="#SemanticMemoryManager.acreate_or_update_memories-1375"><span class="linenos">1375</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1376"><a href="#SemanticMemoryManager.acreate_or_update_memories-1376"><span class="linenos">1376</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1377"><a href="#SemanticMemoryManager.acreate_or_update_memories-1377"><span class="linenos">1377</span></a><span class="sd">        Async version of create_or_update_memories.</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1378"><a href="#SemanticMemoryManager.acreate_or_update_memories-1378"><span class="linenos">1378</span></a>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1379"><a href="#SemanticMemoryManager.acreate_or_update_memories-1379"><span class="linenos">1379</span></a><span class="sd">        Since our implementation doesn&#39;t use async operations, this just calls</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1380"><a href="#SemanticMemoryManager.acreate_or_update_memories-1380"><span class="linenos">1380</span></a><span class="sd">        the sync version. This maintains compatibility with Agno&#39;s async interface.</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1381"><a href="#SemanticMemoryManager.acreate_or_update_memories-1381"><span class="linenos">1381</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1382"><a href="#SemanticMemoryManager.acreate_or_update_memories-1382"><span class="linenos">1382</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_or_update_memories</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1383"><a href="#SemanticMemoryManager.acreate_or_update_memories-1383"><span class="linenos">1383</span></a>            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1384"><a href="#SemanticMemoryManager.acreate_or_update_memories-1384"><span class="linenos">1384</span></a>            <span class="n">existing_memories</span><span class="o">=</span><span class="n">existing_memories</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1385"><a href="#SemanticMemoryManager.acreate_or_update_memories-1385"><span class="linenos">1385</span></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1386"><a href="#SemanticMemoryManager.acreate_or_update_memories-1386"><span class="linenos">1386</span></a>            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1387"><a href="#SemanticMemoryManager.acreate_or_update_memories-1387"><span class="linenos">1387</span></a>            <span class="n">delete_memories</span><span class="o">=</span><span class="n">delete_memories</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1388"><a href="#SemanticMemoryManager.acreate_or_update_memories-1388"><span class="linenos">1388</span></a>            <span class="n">clear_memories</span><span class="o">=</span><span class="n">clear_memories</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.acreate_or_update_memories-1389"><a href="#SemanticMemoryManager.acreate_or_update_memories-1389"><span class="linenos">1389</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Async version of create_or_update_memories.</p>

<p>Since our implementation doesn't use async operations, this just calls
the sync version. This maintains compatibility with Agno's async interface.</p>
</div>


                            </div>
                            <div id="SemanticMemoryManager.run_memory_task" class="classattr">
                                        <input id="SemanticMemoryManager.run_memory_task-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_memory_task</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">task</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.run_memory_task-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.run_memory_task"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.run_memory_task-1391"><a href="#SemanticMemoryManager.run_memory_task-1391"><span class="linenos">1391</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run_memory_task</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.run_memory_task-1392"><a href="#SemanticMemoryManager.run_memory_task-1392"><span class="linenos">1392</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1393"><a href="#SemanticMemoryManager.run_memory_task-1393"><span class="linenos">1393</span></a>        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1394"><a href="#SemanticMemoryManager.run_memory_task-1394"><span class="linenos">1394</span></a>        <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="SemanticMemoryManager.run_memory_task-1395"><a href="#SemanticMemoryManager.run_memory_task-1395"><span class="linenos">1395</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1396"><a href="#SemanticMemoryManager.run_memory_task-1396"><span class="linenos">1396</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1397"><a href="#SemanticMemoryManager.run_memory_task-1397"><span class="linenos">1397</span></a>        <span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1398"><a href="#SemanticMemoryManager.run_memory_task-1398"><span class="linenos">1398</span></a>        <span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1399"><a href="#SemanticMemoryManager.run_memory_task-1399"><span class="linenos">1399</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1400"><a href="#SemanticMemoryManager.run_memory_task-1400"><span class="linenos">1400</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.run_memory_task-1401"><a href="#SemanticMemoryManager.run_memory_task-1401"><span class="linenos">1401</span></a><span class="sd">        Process a memory task without using LLM.</span>
</span><span id="SemanticMemoryManager.run_memory_task-1402"><a href="#SemanticMemoryManager.run_memory_task-1402"><span class="linenos">1402</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1403"><a href="#SemanticMemoryManager.run_memory_task-1403"><span class="linenos">1403</span></a><span class="sd">        This method provides the same interface as Agno&#39;s MemoryManager.run_memory_task</span>
</span><span id="SemanticMemoryManager.run_memory_task-1404"><a href="#SemanticMemoryManager.run_memory_task-1404"><span class="linenos">1404</span></a><span class="sd">        but uses semantic analysis instead of LLM calls for better performance and reliability.</span>
</span><span id="SemanticMemoryManager.run_memory_task-1405"><a href="#SemanticMemoryManager.run_memory_task-1405"><span class="linenos">1405</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1406"><a href="#SemanticMemoryManager.run_memory_task-1406"><span class="linenos">1406</span></a><span class="sd">        :param task: The task/input text to process for memory extraction</span>
</span><span id="SemanticMemoryManager.run_memory_task-1407"><a href="#SemanticMemoryManager.run_memory_task-1407"><span class="linenos">1407</span></a><span class="sd">        :param existing_memories: List of existing memory dictionaries</span>
</span><span id="SemanticMemoryManager.run_memory_task-1408"><a href="#SemanticMemoryManager.run_memory_task-1408"><span class="linenos">1408</span></a><span class="sd">        :param user_id: User ID for the memories</span>
</span><span id="SemanticMemoryManager.run_memory_task-1409"><a href="#SemanticMemoryManager.run_memory_task-1409"><span class="linenos">1409</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager.run_memory_task-1410"><a href="#SemanticMemoryManager.run_memory_task-1410"><span class="linenos">1410</span></a><span class="sd">        :param delete_memories: Whether deletion is enabled (not used in our implementation)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1411"><a href="#SemanticMemoryManager.run_memory_task-1411"><span class="linenos">1411</span></a><span class="sd">        :param clear_memories: Whether clearing is enabled (not used in our implementation)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1412"><a href="#SemanticMemoryManager.run_memory_task-1412"><span class="linenos">1412</span></a><span class="sd">        :return: String describing the actions taken</span>
</span><span id="SemanticMemoryManager.run_memory_task-1413"><a href="#SemanticMemoryManager.run_memory_task-1413"><span class="linenos">1413</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.run_memory_task-1414"><a href="#SemanticMemoryManager.run_memory_task-1414"><span class="linenos">1414</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SemanticMemoryManager.run_memory_task Start&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1415"><a href="#SemanticMemoryManager.run_memory_task-1415"><span class="linenos">1415</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1416"><a href="#SemanticMemoryManager.run_memory_task-1416"><span class="linenos">1416</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1417"><a href="#SemanticMemoryManager.run_memory_task-1417"><span class="linenos">1417</span></a>            <span class="c1"># Extract memorable statements from the task</span>
</span><span id="SemanticMemoryManager.run_memory_task-1418"><a href="#SemanticMemoryManager.run_memory_task-1418"><span class="linenos">1418</span></a>            <span class="n">memorable_statements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_memorable_statements</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1419"><a href="#SemanticMemoryManager.run_memory_task-1419"><span class="linenos">1419</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1420"><a href="#SemanticMemoryManager.run_memory_task-1420"><span class="linenos">1420</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">memorable_statements</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1421"><a href="#SemanticMemoryManager.run_memory_task-1421"><span class="linenos">1421</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No memorable statements found in task&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1422"><a href="#SemanticMemoryManager.run_memory_task-1422"><span class="linenos">1422</span></a>                <span class="k">return</span> <span class="s2">&quot;No memorable information found in the task&quot;</span>
</span><span id="SemanticMemoryManager.run_memory_task-1423"><a href="#SemanticMemoryManager.run_memory_task-1423"><span class="linenos">1423</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1424"><a href="#SemanticMemoryManager.run_memory_task-1424"><span class="linenos">1424</span></a>            <span class="c1"># Convert existing memories to UserMemory-like objects for duplicate checking</span>
</span><span id="SemanticMemoryManager.run_memory_task-1425"><a href="#SemanticMemoryManager.run_memory_task-1425"><span class="linenos">1425</span></a>            <span class="k">class</span><span class="w"> </span><span class="nc">SimpleMemory</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1426"><a href="#SemanticMemoryManager.run_memory_task-1426"><span class="linenos">1426</span></a>                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">memory_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="SemanticMemoryManager.run_memory_task-1427"><a href="#SemanticMemoryManager.run_memory_task-1427"><span class="linenos">1427</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory_text</span>
</span><span id="SemanticMemoryManager.run_memory_task-1428"><a href="#SemanticMemoryManager.run_memory_task-1428"><span class="linenos">1428</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">memory_id</span> <span class="o">=</span> <span class="n">memory_id</span>
</span><span id="SemanticMemoryManager.run_memory_task-1429"><a href="#SemanticMemoryManager.run_memory_task-1429"><span class="linenos">1429</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1430"><a href="#SemanticMemoryManager.run_memory_task-1430"><span class="linenos">1430</span></a>            <span class="n">existing_user_memories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager.run_memory_task-1431"><a href="#SemanticMemoryManager.run_memory_task-1431"><span class="linenos">1431</span></a>            <span class="k">for</span> <span class="n">mem_dict</span> <span class="ow">in</span> <span class="n">existing_memories</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1432"><a href="#SemanticMemoryManager.run_memory_task-1432"><span class="linenos">1432</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1433"><a href="#SemanticMemoryManager.run_memory_task-1433"><span class="linenos">1433</span></a>                    <span class="n">memory_text</span> <span class="o">=</span> <span class="n">mem_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1434"><a href="#SemanticMemoryManager.run_memory_task-1434"><span class="linenos">1434</span></a>                    <span class="k">if</span> <span class="n">memory_text</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1435"><a href="#SemanticMemoryManager.run_memory_task-1435"><span class="linenos">1435</span></a>                        <span class="n">existing_user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.run_memory_task-1436"><a href="#SemanticMemoryManager.run_memory_task-1436"><span class="linenos">1436</span></a>                            <span class="n">SimpleMemory</span><span class="p">(</span><span class="n">memory_text</span><span class="p">,</span> <span class="n">mem_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="SemanticMemoryManager.run_memory_task-1437"><a href="#SemanticMemoryManager.run_memory_task-1437"><span class="linenos">1437</span></a>                        <span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1438"><a href="#SemanticMemoryManager.run_memory_task-1438"><span class="linenos">1438</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1439"><a href="#SemanticMemoryManager.run_memory_task-1439"><span class="linenos">1439</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process existing memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1440"><a href="#SemanticMemoryManager.run_memory_task-1440"><span class="linenos">1440</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1441"><a href="#SemanticMemoryManager.run_memory_task-1441"><span class="linenos">1441</span></a>            <span class="c1"># Process each memorable statement</span>
</span><span id="SemanticMemoryManager.run_memory_task-1442"><a href="#SemanticMemoryManager.run_memory_task-1442"><span class="linenos">1442</span></a>            <span class="n">actions_taken</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SemanticMemoryManager.run_memory_task-1443"><a href="#SemanticMemoryManager.run_memory_task-1443"><span class="linenos">1443</span></a>            <span class="n">memories_added</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager.run_memory_task-1444"><a href="#SemanticMemoryManager.run_memory_task-1444"><span class="linenos">1444</span></a>            <span class="n">memories_rejected</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SemanticMemoryManager.run_memory_task-1445"><a href="#SemanticMemoryManager.run_memory_task-1445"><span class="linenos">1445</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1446"><a href="#SemanticMemoryManager.run_memory_task-1446"><span class="linenos">1446</span></a>            <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">memorable_statements</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1447"><a href="#SemanticMemoryManager.run_memory_task-1447"><span class="linenos">1447</span></a>                <span class="c1"># Check for duplicates against existing memories</span>
</span><span id="SemanticMemoryManager.run_memory_task-1448"><a href="#SemanticMemoryManager.run_memory_task-1448"><span class="linenos">1448</span></a>                <span class="n">should_reject</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_reject_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.run_memory_task-1449"><a href="#SemanticMemoryManager.run_memory_task-1449"><span class="linenos">1449</span></a>                    <span class="n">statement</span><span class="p">,</span> <span class="n">existing_user_memories</span>
</span><span id="SemanticMemoryManager.run_memory_task-1450"><a href="#SemanticMemoryManager.run_memory_task-1450"><span class="linenos">1450</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1451"><a href="#SemanticMemoryManager.run_memory_task-1451"><span class="linenos">1451</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1452"><a href="#SemanticMemoryManager.run_memory_task-1452"><span class="linenos">1452</span></a>                <span class="k">if</span> <span class="n">should_reject</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1453"><a href="#SemanticMemoryManager.run_memory_task-1453"><span class="linenos">1453</span></a>                    <span class="n">memories_rejected</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager.run_memory_task-1454"><a href="#SemanticMemoryManager.run_memory_task-1454"><span class="linenos">1454</span></a>                    <span class="n">actions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rejected: &#39;</span><span class="si">{</span><span class="n">statement</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; - </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1455"><a href="#SemanticMemoryManager.run_memory_task-1455"><span class="linenos">1455</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rejected memory: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1456"><a href="#SemanticMemoryManager.run_memory_task-1456"><span class="linenos">1456</span></a>                    <span class="k">continue</span>
</span><span id="SemanticMemoryManager.run_memory_task-1457"><a href="#SemanticMemoryManager.run_memory_task-1457"><span class="linenos">1457</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1458"><a href="#SemanticMemoryManager.run_memory_task-1458"><span class="linenos">1458</span></a>                <span class="c1"># Add the memory</span>
</span><span id="SemanticMemoryManager.run_memory_task-1459"><a href="#SemanticMemoryManager.run_memory_task-1459"><span class="linenos">1459</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_memory</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.run_memory_task-1460"><a href="#SemanticMemoryManager.run_memory_task-1460"><span class="linenos">1460</span></a>                    <span class="n">memory_text</span><span class="o">=</span><span class="n">statement</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1461"><a href="#SemanticMemoryManager.run_memory_task-1461"><span class="linenos">1461</span></a>                    <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1462"><a href="#SemanticMemoryManager.run_memory_task-1462"><span class="linenos">1462</span></a>                    <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1463"><a href="#SemanticMemoryManager.run_memory_task-1463"><span class="linenos">1463</span></a>                    <span class="n">input_text</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1464"><a href="#SemanticMemoryManager.run_memory_task-1464"><span class="linenos">1464</span></a>                <span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1465"><a href="#SemanticMemoryManager.run_memory_task-1465"><span class="linenos">1465</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1466"><a href="#SemanticMemoryManager.run_memory_task-1466"><span class="linenos">1466</span></a>                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">is_success</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1467"><a href="#SemanticMemoryManager.run_memory_task-1467"><span class="linenos">1467</span></a>                    <span class="n">memories_added</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager.run_memory_task-1468"><a href="#SemanticMemoryManager.run_memory_task-1468"><span class="linenos">1468</span></a>                    <span class="n">actions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added: &#39;</span><span class="si">{</span><span class="n">statement</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1469"><a href="#SemanticMemoryManager.run_memory_task-1469"><span class="linenos">1469</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added memory: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">memory_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1470"><a href="#SemanticMemoryManager.run_memory_task-1470"><span class="linenos">1470</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1471"><a href="#SemanticMemoryManager.run_memory_task-1471"><span class="linenos">1471</span></a>                    <span class="c1"># Add to existing memories list for subsequent duplicate checking</span>
</span><span id="SemanticMemoryManager.run_memory_task-1472"><a href="#SemanticMemoryManager.run_memory_task-1472"><span class="linenos">1472</span></a>                    <span class="n">existing_user_memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.run_memory_task-1473"><a href="#SemanticMemoryManager.run_memory_task-1473"><span class="linenos">1473</span></a>                        <span class="n">SimpleMemory</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">memory_id</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1474"><a href="#SemanticMemoryManager.run_memory_task-1474"><span class="linenos">1474</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1475"><a href="#SemanticMemoryManager.run_memory_task-1475"><span class="linenos">1475</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1476"><a href="#SemanticMemoryManager.run_memory_task-1476"><span class="linenos">1476</span></a>                    <span class="n">memories_rejected</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SemanticMemoryManager.run_memory_task-1477"><a href="#SemanticMemoryManager.run_memory_task-1477"><span class="linenos">1477</span></a>                    <span class="n">actions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.run_memory_task-1478"><a href="#SemanticMemoryManager.run_memory_task-1478"><span class="linenos">1478</span></a>                        <span class="sa">f</span><span class="s2">&quot;Failed to add: &#39;</span><span class="si">{</span><span class="n">statement</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; - </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager.run_memory_task-1479"><a href="#SemanticMemoryManager.run_memory_task-1479"><span class="linenos">1479</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1480"><a href="#SemanticMemoryManager.run_memory_task-1480"><span class="linenos">1480</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to add memory: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1481"><a href="#SemanticMemoryManager.run_memory_task-1481"><span class="linenos">1481</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1482"><a href="#SemanticMemoryManager.run_memory_task-1482"><span class="linenos">1482</span></a>            <span class="c1"># Set memories_updated flag if any memories were added</span>
</span><span id="SemanticMemoryManager.run_memory_task-1483"><a href="#SemanticMemoryManager.run_memory_task-1483"><span class="linenos">1483</span></a>            <span class="k">if</span> <span class="n">memories_added</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1484"><a href="#SemanticMemoryManager.run_memory_task-1484"><span class="linenos">1484</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">memories_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SemanticMemoryManager.run_memory_task-1485"><a href="#SemanticMemoryManager.run_memory_task-1485"><span class="linenos">1485</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1486"><a href="#SemanticMemoryManager.run_memory_task-1486"><span class="linenos">1486</span></a>            <span class="c1"># Create response summary</span>
</span><span id="SemanticMemoryManager.run_memory_task-1487"><a href="#SemanticMemoryManager.run_memory_task-1487"><span class="linenos">1487</span></a>            <span class="n">response_parts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SemanticMemoryManager.run_memory_task-1488"><a href="#SemanticMemoryManager.run_memory_task-1488"><span class="linenos">1488</span></a>                <span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">memorable_statements</span><span class="p">)</span><span class="si">}</span><span class="s2"> memorable statements&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1489"><a href="#SemanticMemoryManager.run_memory_task-1489"><span class="linenos">1489</span></a>                <span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">memories_added</span><span class="si">}</span><span class="s2"> new memories&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1490"><a href="#SemanticMemoryManager.run_memory_task-1490"><span class="linenos">1490</span></a>                <span class="sa">f</span><span class="s2">&quot;Rejected </span><span class="si">{</span><span class="n">memories_rejected</span><span class="si">}</span><span class="s2"> duplicates/invalid memories&quot;</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.run_memory_task-1491"><a href="#SemanticMemoryManager.run_memory_task-1491"><span class="linenos">1491</span></a>            <span class="p">]</span>
</span><span id="SemanticMemoryManager.run_memory_task-1492"><a href="#SemanticMemoryManager.run_memory_task-1492"><span class="linenos">1492</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1493"><a href="#SemanticMemoryManager.run_memory_task-1493"><span class="linenos">1493</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="ow">and</span> <span class="n">actions_taken</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1494"><a href="#SemanticMemoryManager.run_memory_task-1494"><span class="linenos">1494</span></a>                <span class="n">response_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Actions taken:&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1495"><a href="#SemanticMemoryManager.run_memory_task-1495"><span class="linenos">1495</span></a>                <span class="n">response_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">actions_taken</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>  <span class="c1"># Limit to first 5 actions</span>
</span><span id="SemanticMemoryManager.run_memory_task-1496"><a href="#SemanticMemoryManager.run_memory_task-1496"><span class="linenos">1496</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions_taken</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1497"><a href="#SemanticMemoryManager.run_memory_task-1497"><span class="linenos">1497</span></a>                    <span class="n">response_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.run_memory_task-1498"><a href="#SemanticMemoryManager.run_memory_task-1498"><span class="linenos">1498</span></a>                        <span class="sa">f</span><span class="s2">&quot;... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">actions_taken</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more actions&quot;</span>
</span><span id="SemanticMemoryManager.run_memory_task-1499"><a href="#SemanticMemoryManager.run_memory_task-1499"><span class="linenos">1499</span></a>                    <span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1500"><a href="#SemanticMemoryManager.run_memory_task-1500"><span class="linenos">1500</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1501"><a href="#SemanticMemoryManager.run_memory_task-1501"><span class="linenos">1501</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;. &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">response_parts</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1502"><a href="#SemanticMemoryManager.run_memory_task-1502"><span class="linenos">1502</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SemanticMemoryManager.run_memory_task End&quot;</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1503"><a href="#SemanticMemoryManager.run_memory_task-1503"><span class="linenos">1503</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1504"><a href="#SemanticMemoryManager.run_memory_task-1504"><span class="linenos">1504</span></a>            <span class="k">return</span> <span class="n">response</span>
</span><span id="SemanticMemoryManager.run_memory_task-1505"><a href="#SemanticMemoryManager.run_memory_task-1505"><span class="linenos">1505</span></a>
</span><span id="SemanticMemoryManager.run_memory_task-1506"><a href="#SemanticMemoryManager.run_memory_task-1506"><span class="linenos">1506</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.run_memory_task-1507"><a href="#SemanticMemoryManager.run_memory_task-1507"><span class="linenos">1507</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error in run_memory_task: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SemanticMemoryManager.run_memory_task-1508"><a href="#SemanticMemoryManager.run_memory_task-1508"><span class="linenos">1508</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="SemanticMemoryManager.run_memory_task-1509"><a href="#SemanticMemoryManager.run_memory_task-1509"><span class="linenos">1509</span></a>            <span class="k">return</span> <span class="n">error_msg</span>
</span></pre></div>


            <div class="docstring"><p>Process a memory task without using LLM.</p>

<p>This method provides the same interface as Agno's MemoryManager.run_memory_task
but uses semantic analysis instead of LLM calls for better performance and reliability.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>task</strong>:  The task/input text to process for memory extraction</li>
<li><strong>existing_memories</strong>:  List of existing memory dictionaries</li>
<li><strong>user_id</strong>:  User ID for the memories</li>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>delete_memories</strong>:  Whether deletion is enabled (not used in our implementation)</li>
<li><strong>clear_memories</strong>:  Whether clearing is enabled (not used in our implementation)</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>String describing the actions taken</p>
</blockquote>
</div>


                            </div>
                            <div id="SemanticMemoryManager.arun_memory_task" class="classattr">
                                        <input id="SemanticMemoryManager.arun_memory_task-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">arun_memory_task</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">task</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">db</span><span class="p">:</span> <span class="n">agno</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MemoryDb</span>,</span><span class="param">	<span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SemanticMemoryManager.arun_memory_task-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManager.arun_memory_task"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManager.arun_memory_task-1511"><a href="#SemanticMemoryManager.arun_memory_task-1511"><span class="linenos">1511</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">arun_memory_task</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1512"><a href="#SemanticMemoryManager.arun_memory_task-1512"><span class="linenos">1512</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1513"><a href="#SemanticMemoryManager.arun_memory_task-1513"><span class="linenos">1513</span></a>        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1514"><a href="#SemanticMemoryManager.arun_memory_task-1514"><span class="linenos">1514</span></a>        <span class="n">existing_memories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1515"><a href="#SemanticMemoryManager.arun_memory_task-1515"><span class="linenos">1515</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1516"><a href="#SemanticMemoryManager.arun_memory_task-1516"><span class="linenos">1516</span></a>        <span class="n">db</span><span class="p">:</span> <span class="n">MemoryDb</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1517"><a href="#SemanticMemoryManager.arun_memory_task-1517"><span class="linenos">1517</span></a>        <span class="n">delete_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1518"><a href="#SemanticMemoryManager.arun_memory_task-1518"><span class="linenos">1518</span></a>        <span class="n">clear_memories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1519"><a href="#SemanticMemoryManager.arun_memory_task-1519"><span class="linenos">1519</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1520"><a href="#SemanticMemoryManager.arun_memory_task-1520"><span class="linenos">1520</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1521"><a href="#SemanticMemoryManager.arun_memory_task-1521"><span class="linenos">1521</span></a><span class="sd">        Async version of run_memory_task.</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1522"><a href="#SemanticMemoryManager.arun_memory_task-1522"><span class="linenos">1522</span></a>
</span><span id="SemanticMemoryManager.arun_memory_task-1523"><a href="#SemanticMemoryManager.arun_memory_task-1523"><span class="linenos">1523</span></a><span class="sd">        Since our implementation doesn&#39;t use async operations, this just calls</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1524"><a href="#SemanticMemoryManager.arun_memory_task-1524"><span class="linenos">1524</span></a><span class="sd">        the sync version. This maintains compatibility with Agno&#39;s async interface.</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1525"><a href="#SemanticMemoryManager.arun_memory_task-1525"><span class="linenos">1525</span></a>
</span><span id="SemanticMemoryManager.arun_memory_task-1526"><a href="#SemanticMemoryManager.arun_memory_task-1526"><span class="linenos">1526</span></a><span class="sd">        :param task: The task/input text to process for memory extraction</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1527"><a href="#SemanticMemoryManager.arun_memory_task-1527"><span class="linenos">1527</span></a><span class="sd">        :param existing_memories: List of existing memory dictionaries</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1528"><a href="#SemanticMemoryManager.arun_memory_task-1528"><span class="linenos">1528</span></a><span class="sd">        :param user_id: User ID for the memories</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1529"><a href="#SemanticMemoryManager.arun_memory_task-1529"><span class="linenos">1529</span></a><span class="sd">        :param db: Memory database instance</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1530"><a href="#SemanticMemoryManager.arun_memory_task-1530"><span class="linenos">1530</span></a><span class="sd">        :param delete_memories: Whether deletion is enabled (not used in our implementation)</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1531"><a href="#SemanticMemoryManager.arun_memory_task-1531"><span class="linenos">1531</span></a><span class="sd">        :param clear_memories: Whether clearing is enabled (not used in our implementation)</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1532"><a href="#SemanticMemoryManager.arun_memory_task-1532"><span class="linenos">1532</span></a><span class="sd">        :return: String describing the actions taken</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1533"><a href="#SemanticMemoryManager.arun_memory_task-1533"><span class="linenos">1533</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1534"><a href="#SemanticMemoryManager.arun_memory_task-1534"><span class="linenos">1534</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_memory_task</span><span class="p">(</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1535"><a href="#SemanticMemoryManager.arun_memory_task-1535"><span class="linenos">1535</span></a>            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1536"><a href="#SemanticMemoryManager.arun_memory_task-1536"><span class="linenos">1536</span></a>            <span class="n">existing_memories</span><span class="o">=</span><span class="n">existing_memories</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1537"><a href="#SemanticMemoryManager.arun_memory_task-1537"><span class="linenos">1537</span></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1538"><a href="#SemanticMemoryManager.arun_memory_task-1538"><span class="linenos">1538</span></a>            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1539"><a href="#SemanticMemoryManager.arun_memory_task-1539"><span class="linenos">1539</span></a>            <span class="n">delete_memories</span><span class="o">=</span><span class="n">delete_memories</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1540"><a href="#SemanticMemoryManager.arun_memory_task-1540"><span class="linenos">1540</span></a>            <span class="n">clear_memories</span><span class="o">=</span><span class="n">clear_memories</span><span class="p">,</span>
</span><span id="SemanticMemoryManager.arun_memory_task-1541"><a href="#SemanticMemoryManager.arun_memory_task-1541"><span class="linenos">1541</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Async version of run_memory_task.</p>

<p>Since our implementation doesn't use async operations, this just calls
the sync version. This maintains compatibility with Agno's async interface.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>task</strong>:  The task/input text to process for memory extraction</li>
<li><strong>existing_memories</strong>:  List of existing memory dictionaries</li>
<li><strong>user_id</strong>:  User ID for the memories</li>
<li><strong>db</strong>:  Memory database instance</li>
<li><strong>delete_memories</strong>:  Whether deletion is enabled (not used in our implementation)</li>
<li><strong>clear_memories</strong>:  Whether clearing is enabled (not used in our implementation)</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>String describing the actions taken</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="SemanticMemoryManagerConfig">
                            <input id="SemanticMemoryManagerConfig-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SemanticMemoryManagerConfig</span><wbr>(<span class="base">pydantic.main.BaseModel</span>):

                <label class="view-source-button" for="SemanticMemoryManagerConfig-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticMemoryManagerConfig"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticMemoryManagerConfig-275"><a href="#SemanticMemoryManagerConfig-275"><span class="linenos">275</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SemanticMemoryManagerConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="SemanticMemoryManagerConfig-276"><a href="#SemanticMemoryManagerConfig-276"><span class="linenos">276</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for the Semantic Memory Manager.&quot;&quot;&quot;</span>
</span><span id="SemanticMemoryManagerConfig-277"><a href="#SemanticMemoryManagerConfig-277"><span class="linenos">277</span></a>
</span><span id="SemanticMemoryManagerConfig-278"><a href="#SemanticMemoryManagerConfig-278"><span class="linenos">278</span></a>    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="SemanticMemoryManagerConfig-279"><a href="#SemanticMemoryManagerConfig-279"><span class="linenos">279</span></a>        <span class="n">default</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Threshold for semantic similarity&quot;</span>
</span><span id="SemanticMemoryManagerConfig-280"><a href="#SemanticMemoryManagerConfig-280"><span class="linenos">280</span></a>    <span class="p">)</span>
</span><span id="SemanticMemoryManagerConfig-281"><a href="#SemanticMemoryManagerConfig-281"><span class="linenos">281</span></a>    <span class="n">enable_semantic_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="SemanticMemoryManagerConfig-282"><a href="#SemanticMemoryManagerConfig-282"><span class="linenos">282</span></a>        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable semantic duplicate detection&quot;</span>
</span><span id="SemanticMemoryManagerConfig-283"><a href="#SemanticMemoryManagerConfig-283"><span class="linenos">283</span></a>    <span class="p">)</span>
</span><span id="SemanticMemoryManagerConfig-284"><a href="#SemanticMemoryManagerConfig-284"><span class="linenos">284</span></a>    <span class="n">enable_exact_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="SemanticMemoryManagerConfig-285"><a href="#SemanticMemoryManagerConfig-285"><span class="linenos">285</span></a>        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable exact duplicate detection&quot;</span>
</span><span id="SemanticMemoryManagerConfig-286"><a href="#SemanticMemoryManagerConfig-286"><span class="linenos">286</span></a>    <span class="p">)</span>
</span><span id="SemanticMemoryManagerConfig-287"><a href="#SemanticMemoryManagerConfig-287"><span class="linenos">287</span></a>    <span class="n">enable_topic_classification</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="SemanticMemoryManagerConfig-288"><a href="#SemanticMemoryManagerConfig-288"><span class="linenos">288</span></a>        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable automatic topic classification&quot;</span>
</span><span id="SemanticMemoryManagerConfig-289"><a href="#SemanticMemoryManagerConfig-289"><span class="linenos">289</span></a>    <span class="p">)</span>
</span><span id="SemanticMemoryManagerConfig-290"><a href="#SemanticMemoryManagerConfig-290"><span class="linenos">290</span></a>    <span class="n">max_memory_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="SemanticMemoryManagerConfig-291"><a href="#SemanticMemoryManagerConfig-291"><span class="linenos">291</span></a>        <span class="n">default</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum length for a single memory&quot;</span>
</span><span id="SemanticMemoryManagerConfig-292"><a href="#SemanticMemoryManagerConfig-292"><span class="linenos">292</span></a>    <span class="p">)</span>
</span><span id="SemanticMemoryManagerConfig-293"><a href="#SemanticMemoryManagerConfig-293"><span class="linenos">293</span></a>    <span class="n">recent_memory_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="SemanticMemoryManagerConfig-294"><a href="#SemanticMemoryManagerConfig-294"><span class="linenos">294</span></a>        <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of recent memories to check for duplicates&quot;</span>
</span><span id="SemanticMemoryManagerConfig-295"><a href="#SemanticMemoryManagerConfig-295"><span class="linenos">295</span></a>    <span class="p">)</span>
</span><span id="SemanticMemoryManagerConfig-296"><a href="#SemanticMemoryManagerConfig-296"><span class="linenos">296</span></a>    <span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable debug logging&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Configuration for the Semantic Memory Manager.</p>
</div>


                            <div id="SemanticMemoryManagerConfig.similarity_threshold" class="classattr">
                                <div class="attr variable">
            <span class="name">similarity_threshold</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManagerConfig.similarity_threshold"></a>
    
    

                            </div>
                            <div id="SemanticMemoryManagerConfig.enable_semantic_dedup" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_semantic_dedup</span><span class="annotation">: bool</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManagerConfig.enable_semantic_dedup"></a>
    
    

                            </div>
                            <div id="SemanticMemoryManagerConfig.enable_exact_dedup" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_exact_dedup</span><span class="annotation">: bool</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManagerConfig.enable_exact_dedup"></a>
    
    

                            </div>
                            <div id="SemanticMemoryManagerConfig.enable_topic_classification" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_topic_classification</span><span class="annotation">: bool</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManagerConfig.enable_topic_classification"></a>
    
    

                            </div>
                            <div id="SemanticMemoryManagerConfig.max_memory_length" class="classattr">
                                <div class="attr variable">
            <span class="name">max_memory_length</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManagerConfig.max_memory_length"></a>
    
    

                            </div>
                            <div id="SemanticMemoryManagerConfig.recent_memory_limit" class="classattr">
                                <div class="attr variable">
            <span class="name">recent_memory_limit</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManagerConfig.recent_memory_limit"></a>
    
    

                            </div>
                            <div id="SemanticMemoryManagerConfig.debug_mode" class="classattr">
                                <div class="attr variable">
            <span class="name">debug_mode</span><span class="annotation">: bool</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManagerConfig.debug_mode"></a>
    
    

                            </div>
                            <div id="SemanticMemoryManagerConfig.model_config" class="classattr">
                                <div class="attr variable">
            <span class="name">model_config</span><span class="annotation">: ClassVar[pydantic.config.ConfigDict]</span>        =
<span class="default_value">{}</span>

        
    </div>
    <a class="headerlink" href="#SemanticMemoryManagerConfig.model_config"></a>
    
            <div class="docstring"><p>Configuration for the model, should be a dictionary conforming to [<code>ConfigDict</code>][pydantic.config.ConfigDict].</p>
</div>


                            </div>
                </section>
                <section id="SemanticDuplicateDetector">
                            <input id="SemanticDuplicateDetector-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SemanticDuplicateDetector</span>:

                <label class="view-source-button" for="SemanticDuplicateDetector-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticDuplicateDetector"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticDuplicateDetector-74"><a href="#SemanticDuplicateDetector-74"><span class="linenos"> 74</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SemanticDuplicateDetector</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector-75"><a href="#SemanticDuplicateDetector-75"><span class="linenos"> 75</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Semantic duplicate detection without LLM using advanced text similarity.&quot;&quot;&quot;</span>
</span><span id="SemanticDuplicateDetector-76"><a href="#SemanticDuplicateDetector-76"><span class="linenos"> 76</span></a>
</span><span id="SemanticDuplicateDetector-77"><a href="#SemanticDuplicateDetector-77"><span class="linenos"> 77</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">):</span>
</span><span id="SemanticDuplicateDetector-78"><a href="#SemanticDuplicateDetector-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span> <span class="o">=</span> <span class="n">similarity_threshold</span>
</span><span id="SemanticDuplicateDetector-79"><a href="#SemanticDuplicateDetector-79"><span class="linenos"> 79</span></a>
</span><span id="SemanticDuplicateDetector-80"><a href="#SemanticDuplicateDetector-80"><span class="linenos"> 80</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector-81"><a href="#SemanticDuplicateDetector-81"><span class="linenos"> 81</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize text for comparison.&quot;&quot;&quot;</span>
</span><span id="SemanticDuplicateDetector-82"><a href="#SemanticDuplicateDetector-82"><span class="linenos"> 82</span></a>        <span class="c1"># Convert to lowercase</span>
</span><span id="SemanticDuplicateDetector-83"><a href="#SemanticDuplicateDetector-83"><span class="linenos"> 83</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SemanticDuplicateDetector-84"><a href="#SemanticDuplicateDetector-84"><span class="linenos"> 84</span></a>
</span><span id="SemanticDuplicateDetector-85"><a href="#SemanticDuplicateDetector-85"><span class="linenos"> 85</span></a>        <span class="c1"># Remove extra whitespace</span>
</span><span id="SemanticDuplicateDetector-86"><a href="#SemanticDuplicateDetector-86"><span class="linenos"> 86</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-87"><a href="#SemanticDuplicateDetector-87"><span class="linenos"> 87</span></a>
</span><span id="SemanticDuplicateDetector-88"><a href="#SemanticDuplicateDetector-88"><span class="linenos"> 88</span></a>        <span class="c1"># Remove common punctuation</span>
</span><span id="SemanticDuplicateDetector-89"><a href="#SemanticDuplicateDetector-89"><span class="linenos"> 89</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[.,!?;:]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-90"><a href="#SemanticDuplicateDetector-90"><span class="linenos"> 90</span></a>
</span><span id="SemanticDuplicateDetector-91"><a href="#SemanticDuplicateDetector-91"><span class="linenos"> 91</span></a>        <span class="k">return</span> <span class="n">text</span>
</span><span id="SemanticDuplicateDetector-92"><a href="#SemanticDuplicateDetector-92"><span class="linenos"> 92</span></a>
</span><span id="SemanticDuplicateDetector-93"><a href="#SemanticDuplicateDetector-93"><span class="linenos"> 93</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_key_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="SemanticDuplicateDetector-94"><a href="#SemanticDuplicateDetector-94"><span class="linenos"> 94</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract key terms from text for semantic comparison.&quot;&quot;&quot;</span>
</span><span id="SemanticDuplicateDetector-95"><a href="#SemanticDuplicateDetector-95"><span class="linenos"> 95</span></a>        <span class="n">normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-96"><a href="#SemanticDuplicateDetector-96"><span class="linenos"> 96</span></a>
</span><span id="SemanticDuplicateDetector-97"><a href="#SemanticDuplicateDetector-97"><span class="linenos"> 97</span></a>        <span class="c1"># Split into words</span>
</span><span id="SemanticDuplicateDetector-98"><a href="#SemanticDuplicateDetector-98"><span class="linenos"> 98</span></a>        <span class="n">words</span> <span class="o">=</span> <span class="n">normalized</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span id="SemanticDuplicateDetector-99"><a href="#SemanticDuplicateDetector-99"><span class="linenos"> 99</span></a>
</span><span id="SemanticDuplicateDetector-100"><a href="#SemanticDuplicateDetector-100"><span class="linenos">100</span></a>        <span class="c1"># Remove common stop words</span>
</span><span id="SemanticDuplicateDetector-101"><a href="#SemanticDuplicateDetector-101"><span class="linenos">101</span></a>        <span class="n">stop_words</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SemanticDuplicateDetector-102"><a href="#SemanticDuplicateDetector-102"><span class="linenos">102</span></a>            <span class="s2">&quot;i&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-103"><a href="#SemanticDuplicateDetector-103"><span class="linenos">103</span></a>            <span class="s2">&quot;me&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-104"><a href="#SemanticDuplicateDetector-104"><span class="linenos">104</span></a>            <span class="s2">&quot;my&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-105"><a href="#SemanticDuplicateDetector-105"><span class="linenos">105</span></a>            <span class="s2">&quot;myself&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-106"><a href="#SemanticDuplicateDetector-106"><span class="linenos">106</span></a>            <span class="s2">&quot;we&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-107"><a href="#SemanticDuplicateDetector-107"><span class="linenos">107</span></a>            <span class="s2">&quot;our&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-108"><a href="#SemanticDuplicateDetector-108"><span class="linenos">108</span></a>            <span class="s2">&quot;ours&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-109"><a href="#SemanticDuplicateDetector-109"><span class="linenos">109</span></a>            <span class="s2">&quot;ourselves&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-110"><a href="#SemanticDuplicateDetector-110"><span class="linenos">110</span></a>            <span class="s2">&quot;you&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-111"><a href="#SemanticDuplicateDetector-111"><span class="linenos">111</span></a>            <span class="s2">&quot;your&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-112"><a href="#SemanticDuplicateDetector-112"><span class="linenos">112</span></a>            <span class="s2">&quot;yours&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-113"><a href="#SemanticDuplicateDetector-113"><span class="linenos">113</span></a>            <span class="s2">&quot;yourself&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-114"><a href="#SemanticDuplicateDetector-114"><span class="linenos">114</span></a>            <span class="s2">&quot;yourselves&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-115"><a href="#SemanticDuplicateDetector-115"><span class="linenos">115</span></a>            <span class="s2">&quot;he&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-116"><a href="#SemanticDuplicateDetector-116"><span class="linenos">116</span></a>            <span class="s2">&quot;him&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-117"><a href="#SemanticDuplicateDetector-117"><span class="linenos">117</span></a>            <span class="s2">&quot;his&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-118"><a href="#SemanticDuplicateDetector-118"><span class="linenos">118</span></a>            <span class="s2">&quot;himself&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-119"><a href="#SemanticDuplicateDetector-119"><span class="linenos">119</span></a>            <span class="s2">&quot;she&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-120"><a href="#SemanticDuplicateDetector-120"><span class="linenos">120</span></a>            <span class="s2">&quot;her&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-121"><a href="#SemanticDuplicateDetector-121"><span class="linenos">121</span></a>            <span class="s2">&quot;hers&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-122"><a href="#SemanticDuplicateDetector-122"><span class="linenos">122</span></a>            <span class="s2">&quot;herself&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-123"><a href="#SemanticDuplicateDetector-123"><span class="linenos">123</span></a>            <span class="s2">&quot;it&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-124"><a href="#SemanticDuplicateDetector-124"><span class="linenos">124</span></a>            <span class="s2">&quot;its&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-125"><a href="#SemanticDuplicateDetector-125"><span class="linenos">125</span></a>            <span class="s2">&quot;itself&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-126"><a href="#SemanticDuplicateDetector-126"><span class="linenos">126</span></a>            <span class="s2">&quot;they&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-127"><a href="#SemanticDuplicateDetector-127"><span class="linenos">127</span></a>            <span class="s2">&quot;them&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-128"><a href="#SemanticDuplicateDetector-128"><span class="linenos">128</span></a>            <span class="s2">&quot;their&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-129"><a href="#SemanticDuplicateDetector-129"><span class="linenos">129</span></a>            <span class="s2">&quot;theirs&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-130"><a href="#SemanticDuplicateDetector-130"><span class="linenos">130</span></a>            <span class="s2">&quot;themselves&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-131"><a href="#SemanticDuplicateDetector-131"><span class="linenos">131</span></a>            <span class="s2">&quot;what&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-132"><a href="#SemanticDuplicateDetector-132"><span class="linenos">132</span></a>            <span class="s2">&quot;which&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-133"><a href="#SemanticDuplicateDetector-133"><span class="linenos">133</span></a>            <span class="s2">&quot;who&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-134"><a href="#SemanticDuplicateDetector-134"><span class="linenos">134</span></a>            <span class="s2">&quot;whom&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-135"><a href="#SemanticDuplicateDetector-135"><span class="linenos">135</span></a>            <span class="s2">&quot;this&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-136"><a href="#SemanticDuplicateDetector-136"><span class="linenos">136</span></a>            <span class="s2">&quot;that&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-137"><a href="#SemanticDuplicateDetector-137"><span class="linenos">137</span></a>            <span class="s2">&quot;these&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-138"><a href="#SemanticDuplicateDetector-138"><span class="linenos">138</span></a>            <span class="s2">&quot;those&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-139"><a href="#SemanticDuplicateDetector-139"><span class="linenos">139</span></a>            <span class="s2">&quot;am&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-140"><a href="#SemanticDuplicateDetector-140"><span class="linenos">140</span></a>            <span class="s2">&quot;is&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-141"><a href="#SemanticDuplicateDetector-141"><span class="linenos">141</span></a>            <span class="s2">&quot;are&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-142"><a href="#SemanticDuplicateDetector-142"><span class="linenos">142</span></a>            <span class="s2">&quot;was&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-143"><a href="#SemanticDuplicateDetector-143"><span class="linenos">143</span></a>            <span class="s2">&quot;were&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-144"><a href="#SemanticDuplicateDetector-144"><span class="linenos">144</span></a>            <span class="s2">&quot;be&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-145"><a href="#SemanticDuplicateDetector-145"><span class="linenos">145</span></a>            <span class="s2">&quot;been&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-146"><a href="#SemanticDuplicateDetector-146"><span class="linenos">146</span></a>            <span class="s2">&quot;being&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-147"><a href="#SemanticDuplicateDetector-147"><span class="linenos">147</span></a>            <span class="s2">&quot;have&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-148"><a href="#SemanticDuplicateDetector-148"><span class="linenos">148</span></a>            <span class="s2">&quot;has&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-149"><a href="#SemanticDuplicateDetector-149"><span class="linenos">149</span></a>            <span class="s2">&quot;had&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-150"><a href="#SemanticDuplicateDetector-150"><span class="linenos">150</span></a>            <span class="s2">&quot;having&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-151"><a href="#SemanticDuplicateDetector-151"><span class="linenos">151</span></a>            <span class="s2">&quot;do&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-152"><a href="#SemanticDuplicateDetector-152"><span class="linenos">152</span></a>            <span class="s2">&quot;does&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-153"><a href="#SemanticDuplicateDetector-153"><span class="linenos">153</span></a>            <span class="s2">&quot;did&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-154"><a href="#SemanticDuplicateDetector-154"><span class="linenos">154</span></a>            <span class="s2">&quot;doing&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-155"><a href="#SemanticDuplicateDetector-155"><span class="linenos">155</span></a>            <span class="s2">&quot;a&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-156"><a href="#SemanticDuplicateDetector-156"><span class="linenos">156</span></a>            <span class="s2">&quot;an&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-157"><a href="#SemanticDuplicateDetector-157"><span class="linenos">157</span></a>            <span class="s2">&quot;the&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-158"><a href="#SemanticDuplicateDetector-158"><span class="linenos">158</span></a>            <span class="s2">&quot;and&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-159"><a href="#SemanticDuplicateDetector-159"><span class="linenos">159</span></a>            <span class="s2">&quot;but&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-160"><a href="#SemanticDuplicateDetector-160"><span class="linenos">160</span></a>            <span class="s2">&quot;if&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-161"><a href="#SemanticDuplicateDetector-161"><span class="linenos">161</span></a>            <span class="s2">&quot;or&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-162"><a href="#SemanticDuplicateDetector-162"><span class="linenos">162</span></a>            <span class="s2">&quot;because&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-163"><a href="#SemanticDuplicateDetector-163"><span class="linenos">163</span></a>            <span class="s2">&quot;as&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-164"><a href="#SemanticDuplicateDetector-164"><span class="linenos">164</span></a>            <span class="s2">&quot;until&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-165"><a href="#SemanticDuplicateDetector-165"><span class="linenos">165</span></a>            <span class="s2">&quot;while&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-166"><a href="#SemanticDuplicateDetector-166"><span class="linenos">166</span></a>            <span class="s2">&quot;of&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-167"><a href="#SemanticDuplicateDetector-167"><span class="linenos">167</span></a>            <span class="s2">&quot;at&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-168"><a href="#SemanticDuplicateDetector-168"><span class="linenos">168</span></a>            <span class="s2">&quot;by&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-169"><a href="#SemanticDuplicateDetector-169"><span class="linenos">169</span></a>            <span class="s2">&quot;for&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-170"><a href="#SemanticDuplicateDetector-170"><span class="linenos">170</span></a>            <span class="s2">&quot;with&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-171"><a href="#SemanticDuplicateDetector-171"><span class="linenos">171</span></a>            <span class="s2">&quot;through&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-172"><a href="#SemanticDuplicateDetector-172"><span class="linenos">172</span></a>            <span class="s2">&quot;during&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-173"><a href="#SemanticDuplicateDetector-173"><span class="linenos">173</span></a>            <span class="s2">&quot;before&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-174"><a href="#SemanticDuplicateDetector-174"><span class="linenos">174</span></a>            <span class="s2">&quot;after&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-175"><a href="#SemanticDuplicateDetector-175"><span class="linenos">175</span></a>            <span class="s2">&quot;above&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-176"><a href="#SemanticDuplicateDetector-176"><span class="linenos">176</span></a>            <span class="s2">&quot;below&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-177"><a href="#SemanticDuplicateDetector-177"><span class="linenos">177</span></a>            <span class="s2">&quot;up&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-178"><a href="#SemanticDuplicateDetector-178"><span class="linenos">178</span></a>            <span class="s2">&quot;down&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-179"><a href="#SemanticDuplicateDetector-179"><span class="linenos">179</span></a>            <span class="s2">&quot;in&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-180"><a href="#SemanticDuplicateDetector-180"><span class="linenos">180</span></a>            <span class="s2">&quot;out&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-181"><a href="#SemanticDuplicateDetector-181"><span class="linenos">181</span></a>            <span class="s2">&quot;on&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-182"><a href="#SemanticDuplicateDetector-182"><span class="linenos">182</span></a>            <span class="s2">&quot;off&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-183"><a href="#SemanticDuplicateDetector-183"><span class="linenos">183</span></a>            <span class="s2">&quot;over&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-184"><a href="#SemanticDuplicateDetector-184"><span class="linenos">184</span></a>            <span class="s2">&quot;under&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-185"><a href="#SemanticDuplicateDetector-185"><span class="linenos">185</span></a>            <span class="s2">&quot;again&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-186"><a href="#SemanticDuplicateDetector-186"><span class="linenos">186</span></a>            <span class="s2">&quot;further&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-187"><a href="#SemanticDuplicateDetector-187"><span class="linenos">187</span></a>            <span class="s2">&quot;then&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-188"><a href="#SemanticDuplicateDetector-188"><span class="linenos">188</span></a>            <span class="s2">&quot;once&quot;</span><span class="p">,</span>
</span><span id="SemanticDuplicateDetector-189"><a href="#SemanticDuplicateDetector-189"><span class="linenos">189</span></a>        <span class="p">}</span>
</span><span id="SemanticDuplicateDetector-190"><a href="#SemanticDuplicateDetector-190"><span class="linenos">190</span></a>
</span><span id="SemanticDuplicateDetector-191"><a href="#SemanticDuplicateDetector-191"><span class="linenos">191</span></a>        <span class="n">key_terms</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stop_words</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">}</span>
</span><span id="SemanticDuplicateDetector-192"><a href="#SemanticDuplicateDetector-192"><span class="linenos">192</span></a>        <span class="k">return</span> <span class="n">key_terms</span>
</span><span id="SemanticDuplicateDetector-193"><a href="#SemanticDuplicateDetector-193"><span class="linenos">193</span></a>
</span><span id="SemanticDuplicateDetector-194"><a href="#SemanticDuplicateDetector-194"><span class="linenos">194</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_semantic_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector-195"><a href="#SemanticDuplicateDetector-195"><span class="linenos">195</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate semantic similarity between two texts with improved exact word matching.&quot;&quot;&quot;</span>
</span><span id="SemanticDuplicateDetector-196"><a href="#SemanticDuplicateDetector-196"><span class="linenos">196</span></a>        <span class="c1"># Normalize texts</span>
</span><span id="SemanticDuplicateDetector-197"><a href="#SemanticDuplicateDetector-197"><span class="linenos">197</span></a>        <span class="n">norm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_text</span><span class="p">(</span><span class="n">text1</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-198"><a href="#SemanticDuplicateDetector-198"><span class="linenos">198</span></a>        <span class="n">norm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_text</span><span class="p">(</span><span class="n">text2</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-199"><a href="#SemanticDuplicateDetector-199"><span class="linenos">199</span></a>
</span><span id="SemanticDuplicateDetector-200"><a href="#SemanticDuplicateDetector-200"><span class="linenos">200</span></a>        <span class="c1"># Check for exact word matches (NEW: improved for search queries)</span>
</span><span id="SemanticDuplicateDetector-201"><a href="#SemanticDuplicateDetector-201"><span class="linenos">201</span></a>        <span class="n">words1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b\w+\b&quot;</span><span class="p">,</span> <span class="n">norm1</span><span class="p">))</span>
</span><span id="SemanticDuplicateDetector-202"><a href="#SemanticDuplicateDetector-202"><span class="linenos">202</span></a>        <span class="n">words2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b\w+\b&quot;</span><span class="p">,</span> <span class="n">norm2</span><span class="p">))</span>
</span><span id="SemanticDuplicateDetector-203"><a href="#SemanticDuplicateDetector-203"><span class="linenos">203</span></a>        <span class="n">exact_matches</span> <span class="o">=</span> <span class="n">words1</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">words2</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-204"><a href="#SemanticDuplicateDetector-204"><span class="linenos">204</span></a>
</span><span id="SemanticDuplicateDetector-205"><a href="#SemanticDuplicateDetector-205"><span class="linenos">205</span></a>        <span class="c1"># If we have exact word matches, boost the score significantly</span>
</span><span id="SemanticDuplicateDetector-206"><a href="#SemanticDuplicateDetector-206"><span class="linenos">206</span></a>        <span class="k">if</span> <span class="n">exact_matches</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">words1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># For short queries (1-3 words)</span>
</span><span id="SemanticDuplicateDetector-207"><a href="#SemanticDuplicateDetector-207"><span class="linenos">207</span></a>            <span class="n">match_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exact_matches</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">words1</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-208"><a href="#SemanticDuplicateDetector-208"><span class="linenos">208</span></a>            <span class="n">exact_word_score</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">+</span> <span class="p">(</span><span class="n">match_ratio</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)</span>  <span class="c1"># 0.6 to 1.0 range</span>
</span><span id="SemanticDuplicateDetector-209"><a href="#SemanticDuplicateDetector-209"><span class="linenos">209</span></a>
</span><span id="SemanticDuplicateDetector-210"><a href="#SemanticDuplicateDetector-210"><span class="linenos">210</span></a>            <span class="c1"># Also calculate traditional semantic similarity</span>
</span><span id="SemanticDuplicateDetector-211"><a href="#SemanticDuplicateDetector-211"><span class="linenos">211</span></a>            <span class="n">string_similarity</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm1</span><span class="p">,</span> <span class="n">norm2</span><span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
</span><span id="SemanticDuplicateDetector-212"><a href="#SemanticDuplicateDetector-212"><span class="linenos">212</span></a>            <span class="n">terms1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_key_terms</span><span class="p">(</span><span class="n">text1</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-213"><a href="#SemanticDuplicateDetector-213"><span class="linenos">213</span></a>            <span class="n">terms2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_key_terms</span><span class="p">(</span><span class="n">text2</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-214"><a href="#SemanticDuplicateDetector-214"><span class="linenos">214</span></a>
</span><span id="SemanticDuplicateDetector-215"><a href="#SemanticDuplicateDetector-215"><span class="linenos">215</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">terms1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">terms2</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector-216"><a href="#SemanticDuplicateDetector-216"><span class="linenos">216</span></a>                <span class="n">terms_similarity</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SemanticDuplicateDetector-217"><a href="#SemanticDuplicateDetector-217"><span class="linenos">217</span></a>            <span class="k">elif</span> <span class="ow">not</span> <span class="n">terms1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">terms2</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector-218"><a href="#SemanticDuplicateDetector-218"><span class="linenos">218</span></a>                <span class="n">terms_similarity</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SemanticDuplicateDetector-219"><a href="#SemanticDuplicateDetector-219"><span class="linenos">219</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector-220"><a href="#SemanticDuplicateDetector-220"><span class="linenos">220</span></a>                <span class="n">intersection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms1</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">terms2</span><span class="p">))</span>
</span><span id="SemanticDuplicateDetector-221"><a href="#SemanticDuplicateDetector-221"><span class="linenos">221</span></a>                <span class="n">union</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">terms2</span><span class="p">))</span>
</span><span id="SemanticDuplicateDetector-222"><a href="#SemanticDuplicateDetector-222"><span class="linenos">222</span></a>                <span class="n">terms_similarity</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span> <span class="k">if</span> <span class="n">union</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="SemanticDuplicateDetector-223"><a href="#SemanticDuplicateDetector-223"><span class="linenos">223</span></a>
</span><span id="SemanticDuplicateDetector-224"><a href="#SemanticDuplicateDetector-224"><span class="linenos">224</span></a>            <span class="n">traditional_score</span> <span class="o">=</span> <span class="p">(</span><span class="n">string_similarity</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">terms_similarity</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-225"><a href="#SemanticDuplicateDetector-225"><span class="linenos">225</span></a>
</span><span id="SemanticDuplicateDetector-226"><a href="#SemanticDuplicateDetector-226"><span class="linenos">226</span></a>            <span class="c1"># Return the higher of exact word score or traditional score</span>
</span><span id="SemanticDuplicateDetector-227"><a href="#SemanticDuplicateDetector-227"><span class="linenos">227</span></a>            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">exact_word_score</span><span class="p">,</span> <span class="n">traditional_score</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-228"><a href="#SemanticDuplicateDetector-228"><span class="linenos">228</span></a>
</span><span id="SemanticDuplicateDetector-229"><a href="#SemanticDuplicateDetector-229"><span class="linenos">229</span></a>        <span class="c1"># For longer queries or no exact matches, use traditional method</span>
</span><span id="SemanticDuplicateDetector-230"><a href="#SemanticDuplicateDetector-230"><span class="linenos">230</span></a>        <span class="n">string_similarity</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm1</span><span class="p">,</span> <span class="n">norm2</span><span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
</span><span id="SemanticDuplicateDetector-231"><a href="#SemanticDuplicateDetector-231"><span class="linenos">231</span></a>
</span><span id="SemanticDuplicateDetector-232"><a href="#SemanticDuplicateDetector-232"><span class="linenos">232</span></a>        <span class="c1"># Key terms similarity</span>
</span><span id="SemanticDuplicateDetector-233"><a href="#SemanticDuplicateDetector-233"><span class="linenos">233</span></a>        <span class="n">terms1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_key_terms</span><span class="p">(</span><span class="n">text1</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-234"><a href="#SemanticDuplicateDetector-234"><span class="linenos">234</span></a>        <span class="n">terms2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_key_terms</span><span class="p">(</span><span class="n">text2</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-235"><a href="#SemanticDuplicateDetector-235"><span class="linenos">235</span></a>
</span><span id="SemanticDuplicateDetector-236"><a href="#SemanticDuplicateDetector-236"><span class="linenos">236</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">terms1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">terms2</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector-237"><a href="#SemanticDuplicateDetector-237"><span class="linenos">237</span></a>            <span class="n">terms_similarity</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SemanticDuplicateDetector-238"><a href="#SemanticDuplicateDetector-238"><span class="linenos">238</span></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="n">terms1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">terms2</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector-239"><a href="#SemanticDuplicateDetector-239"><span class="linenos">239</span></a>            <span class="n">terms_similarity</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SemanticDuplicateDetector-240"><a href="#SemanticDuplicateDetector-240"><span class="linenos">240</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector-241"><a href="#SemanticDuplicateDetector-241"><span class="linenos">241</span></a>            <span class="n">intersection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms1</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">terms2</span><span class="p">))</span>
</span><span id="SemanticDuplicateDetector-242"><a href="#SemanticDuplicateDetector-242"><span class="linenos">242</span></a>            <span class="n">union</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">terms2</span><span class="p">))</span>
</span><span id="SemanticDuplicateDetector-243"><a href="#SemanticDuplicateDetector-243"><span class="linenos">243</span></a>            <span class="n">terms_similarity</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span> <span class="k">if</span> <span class="n">union</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="SemanticDuplicateDetector-244"><a href="#SemanticDuplicateDetector-244"><span class="linenos">244</span></a>
</span><span id="SemanticDuplicateDetector-245"><a href="#SemanticDuplicateDetector-245"><span class="linenos">245</span></a>        <span class="c1"># Weighted combination</span>
</span><span id="SemanticDuplicateDetector-246"><a href="#SemanticDuplicateDetector-246"><span class="linenos">246</span></a>        <span class="n">semantic_score</span> <span class="o">=</span> <span class="p">(</span><span class="n">string_similarity</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">terms_similarity</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-247"><a href="#SemanticDuplicateDetector-247"><span class="linenos">247</span></a>
</span><span id="SemanticDuplicateDetector-248"><a href="#SemanticDuplicateDetector-248"><span class="linenos">248</span></a>        <span class="k">return</span> <span class="n">semantic_score</span>
</span><span id="SemanticDuplicateDetector-249"><a href="#SemanticDuplicateDetector-249"><span class="linenos">249</span></a>
</span><span id="SemanticDuplicateDetector-250"><a href="#SemanticDuplicateDetector-250"><span class="linenos">250</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_duplicate</span><span class="p">(</span>
</span><span id="SemanticDuplicateDetector-251"><a href="#SemanticDuplicateDetector-251"><span class="linenos">251</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">new_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">existing_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="SemanticDuplicateDetector-252"><a href="#SemanticDuplicateDetector-252"><span class="linenos">252</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="SemanticDuplicateDetector-253"><a href="#SemanticDuplicateDetector-253"><span class="linenos">253</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticDuplicateDetector-254"><a href="#SemanticDuplicateDetector-254"><span class="linenos">254</span></a><span class="sd">        Check if new text is a duplicate of any existing texts.</span>
</span><span id="SemanticDuplicateDetector-255"><a href="#SemanticDuplicateDetector-255"><span class="linenos">255</span></a>
</span><span id="SemanticDuplicateDetector-256"><a href="#SemanticDuplicateDetector-256"><span class="linenos">256</span></a><span class="sd">        :param new_text: New text to check</span>
</span><span id="SemanticDuplicateDetector-257"><a href="#SemanticDuplicateDetector-257"><span class="linenos">257</span></a><span class="sd">        :param existing_texts: List of existing texts to compare against</span>
</span><span id="SemanticDuplicateDetector-258"><a href="#SemanticDuplicateDetector-258"><span class="linenos">258</span></a><span class="sd">        :return: Tuple of (is_duplicate, matching_text, similarity_score)</span>
</span><span id="SemanticDuplicateDetector-259"><a href="#SemanticDuplicateDetector-259"><span class="linenos">259</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticDuplicateDetector-260"><a href="#SemanticDuplicateDetector-260"><span class="linenos">260</span></a>        <span class="n">max_similarity</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SemanticDuplicateDetector-261"><a href="#SemanticDuplicateDetector-261"><span class="linenos">261</span></a>        <span class="n">best_match</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SemanticDuplicateDetector-262"><a href="#SemanticDuplicateDetector-262"><span class="linenos">262</span></a>
</span><span id="SemanticDuplicateDetector-263"><a href="#SemanticDuplicateDetector-263"><span class="linenos">263</span></a>        <span class="k">for</span> <span class="n">existing_text</span> <span class="ow">in</span> <span class="n">existing_texts</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector-264"><a href="#SemanticDuplicateDetector-264"><span class="linenos">264</span></a>            <span class="n">similarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_semantic_similarity</span><span class="p">(</span><span class="n">new_text</span><span class="p">,</span> <span class="n">existing_text</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector-265"><a href="#SemanticDuplicateDetector-265"><span class="linenos">265</span></a>
</span><span id="SemanticDuplicateDetector-266"><a href="#SemanticDuplicateDetector-266"><span class="linenos">266</span></a>            <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="n">max_similarity</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector-267"><a href="#SemanticDuplicateDetector-267"><span class="linenos">267</span></a>                <span class="n">max_similarity</span> <span class="o">=</span> <span class="n">similarity</span>
</span><span id="SemanticDuplicateDetector-268"><a href="#SemanticDuplicateDetector-268"><span class="linenos">268</span></a>                <span class="n">best_match</span> <span class="o">=</span> <span class="n">existing_text</span>
</span><span id="SemanticDuplicateDetector-269"><a href="#SemanticDuplicateDetector-269"><span class="linenos">269</span></a>
</span><span id="SemanticDuplicateDetector-270"><a href="#SemanticDuplicateDetector-270"><span class="linenos">270</span></a>        <span class="n">is_duplicate</span> <span class="o">=</span> <span class="n">max_similarity</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span>
</span><span id="SemanticDuplicateDetector-271"><a href="#SemanticDuplicateDetector-271"><span class="linenos">271</span></a>
</span><span id="SemanticDuplicateDetector-272"><a href="#SemanticDuplicateDetector-272"><span class="linenos">272</span></a>        <span class="k">return</span> <span class="n">is_duplicate</span><span class="p">,</span> <span class="n">best_match</span><span class="p">,</span> <span class="n">max_similarity</span>
</span></pre></div>


            <div class="docstring"><p>Semantic duplicate detection without LLM using advanced text similarity.</p>
</div>


                            <div id="SemanticDuplicateDetector.__init__" class="classattr">
                                        <input id="SemanticDuplicateDetector.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SemanticDuplicateDetector</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span></span>)</span>

                <label class="view-source-button" for="SemanticDuplicateDetector.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticDuplicateDetector.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticDuplicateDetector.__init__-77"><a href="#SemanticDuplicateDetector.__init__-77"><span class="linenos">77</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">):</span>
</span><span id="SemanticDuplicateDetector.__init__-78"><a href="#SemanticDuplicateDetector.__init__-78"><span class="linenos">78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span> <span class="o">=</span> <span class="n">similarity_threshold</span>
</span></pre></div>


    

                            </div>
                            <div id="SemanticDuplicateDetector.similarity_threshold" class="classattr">
                                <div class="attr variable">
            <span class="name">similarity_threshold</span>

        
    </div>
    <a class="headerlink" href="#SemanticDuplicateDetector.similarity_threshold"></a>
    
    

                            </div>
                            <div id="SemanticDuplicateDetector.is_duplicate" class="classattr">
                                        <input id="SemanticDuplicateDetector.is_duplicate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_duplicate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">new_text</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">existing_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SemanticDuplicateDetector.is_duplicate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SemanticDuplicateDetector.is_duplicate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SemanticDuplicateDetector.is_duplicate-250"><a href="#SemanticDuplicateDetector.is_duplicate-250"><span class="linenos">250</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_duplicate</span><span class="p">(</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-251"><a href="#SemanticDuplicateDetector.is_duplicate-251"><span class="linenos">251</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">new_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">existing_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-252"><a href="#SemanticDuplicateDetector.is_duplicate-252"><span class="linenos">252</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-253"><a href="#SemanticDuplicateDetector.is_duplicate-253"><span class="linenos">253</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-254"><a href="#SemanticDuplicateDetector.is_duplicate-254"><span class="linenos">254</span></a><span class="sd">        Check if new text is a duplicate of any existing texts.</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-255"><a href="#SemanticDuplicateDetector.is_duplicate-255"><span class="linenos">255</span></a>
</span><span id="SemanticDuplicateDetector.is_duplicate-256"><a href="#SemanticDuplicateDetector.is_duplicate-256"><span class="linenos">256</span></a><span class="sd">        :param new_text: New text to check</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-257"><a href="#SemanticDuplicateDetector.is_duplicate-257"><span class="linenos">257</span></a><span class="sd">        :param existing_texts: List of existing texts to compare against</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-258"><a href="#SemanticDuplicateDetector.is_duplicate-258"><span class="linenos">258</span></a><span class="sd">        :return: Tuple of (is_duplicate, matching_text, similarity_score)</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-259"><a href="#SemanticDuplicateDetector.is_duplicate-259"><span class="linenos">259</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-260"><a href="#SemanticDuplicateDetector.is_duplicate-260"><span class="linenos">260</span></a>        <span class="n">max_similarity</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-261"><a href="#SemanticDuplicateDetector.is_duplicate-261"><span class="linenos">261</span></a>        <span class="n">best_match</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-262"><a href="#SemanticDuplicateDetector.is_duplicate-262"><span class="linenos">262</span></a>
</span><span id="SemanticDuplicateDetector.is_duplicate-263"><a href="#SemanticDuplicateDetector.is_duplicate-263"><span class="linenos">263</span></a>        <span class="k">for</span> <span class="n">existing_text</span> <span class="ow">in</span> <span class="n">existing_texts</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-264"><a href="#SemanticDuplicateDetector.is_duplicate-264"><span class="linenos">264</span></a>            <span class="n">similarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_semantic_similarity</span><span class="p">(</span><span class="n">new_text</span><span class="p">,</span> <span class="n">existing_text</span><span class="p">)</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-265"><a href="#SemanticDuplicateDetector.is_duplicate-265"><span class="linenos">265</span></a>
</span><span id="SemanticDuplicateDetector.is_duplicate-266"><a href="#SemanticDuplicateDetector.is_duplicate-266"><span class="linenos">266</span></a>            <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="n">max_similarity</span><span class="p">:</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-267"><a href="#SemanticDuplicateDetector.is_duplicate-267"><span class="linenos">267</span></a>                <span class="n">max_similarity</span> <span class="o">=</span> <span class="n">similarity</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-268"><a href="#SemanticDuplicateDetector.is_duplicate-268"><span class="linenos">268</span></a>                <span class="n">best_match</span> <span class="o">=</span> <span class="n">existing_text</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-269"><a href="#SemanticDuplicateDetector.is_duplicate-269"><span class="linenos">269</span></a>
</span><span id="SemanticDuplicateDetector.is_duplicate-270"><a href="#SemanticDuplicateDetector.is_duplicate-270"><span class="linenos">270</span></a>        <span class="n">is_duplicate</span> <span class="o">=</span> <span class="n">max_similarity</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span>
</span><span id="SemanticDuplicateDetector.is_duplicate-271"><a href="#SemanticDuplicateDetector.is_duplicate-271"><span class="linenos">271</span></a>
</span><span id="SemanticDuplicateDetector.is_duplicate-272"><a href="#SemanticDuplicateDetector.is_duplicate-272"><span class="linenos">272</span></a>        <span class="k">return</span> <span class="n">is_duplicate</span><span class="p">,</span> <span class="n">best_match</span><span class="p">,</span> <span class="n">max_similarity</span>
</span></pre></div>


            <div class="docstring"><p>Check if new text is a duplicate of any existing texts.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>new_text</strong>:  New text to check</li>
<li><strong>existing_texts</strong>:  List of existing texts to compare against</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Tuple of (is_duplicate, matching_text, similarity_score)</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="create_semantic_memory_manager">
                            <input id="create_semantic_memory_manager-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_semantic_memory_manager</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">agno</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>,</span><span class="param">	<span class="n">enable_semantic_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">enable_exact_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">enable_topic_classification</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n"><a href="#SemanticMemoryManager">SemanticMemoryManager</a></span>:</span></span>

                <label class="view-source-button" for="create_semantic_memory_manager-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_semantic_memory_manager"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_semantic_memory_manager-1589"><a href="#create_semantic_memory_manager-1589"><span class="linenos">1589</span></a><span class="k">def</span><span class="w"> </span><span class="nf">create_semantic_memory_manager</span><span class="p">(</span>
</span><span id="create_semantic_memory_manager-1590"><a href="#create_semantic_memory_manager-1590"><span class="linenos">1590</span></a>    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="create_semantic_memory_manager-1591"><a href="#create_semantic_memory_manager-1591"><span class="linenos">1591</span></a>    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
</span><span id="create_semantic_memory_manager-1592"><a href="#create_semantic_memory_manager-1592"><span class="linenos">1592</span></a>    <span class="n">enable_semantic_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="create_semantic_memory_manager-1593"><a href="#create_semantic_memory_manager-1593"><span class="linenos">1593</span></a>    <span class="n">enable_exact_dedup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="create_semantic_memory_manager-1594"><a href="#create_semantic_memory_manager-1594"><span class="linenos">1594</span></a>    <span class="n">enable_topic_classification</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="create_semantic_memory_manager-1595"><a href="#create_semantic_memory_manager-1595"><span class="linenos">1595</span></a>    <span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="create_semantic_memory_manager-1596"><a href="#create_semantic_memory_manager-1596"><span class="linenos">1596</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SemanticMemoryManager</span><span class="p">:</span>
</span><span id="create_semantic_memory_manager-1597"><a href="#create_semantic_memory_manager-1597"><span class="linenos">1597</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="create_semantic_memory_manager-1598"><a href="#create_semantic_memory_manager-1598"><span class="linenos">1598</span></a><span class="sd">    Create a SemanticMemoryManager instance with sensible defaults.</span>
</span><span id="create_semantic_memory_manager-1599"><a href="#create_semantic_memory_manager-1599"><span class="linenos">1599</span></a>
</span><span id="create_semantic_memory_manager-1600"><a href="#create_semantic_memory_manager-1600"><span class="linenos">1600</span></a><span class="sd">    :param model: Optional model instance (required by Agno Memory class)</span>
</span><span id="create_semantic_memory_manager-1601"><a href="#create_semantic_memory_manager-1601"><span class="linenos">1601</span></a><span class="sd">    :param similarity_threshold: Threshold for semantic similarity</span>
</span><span id="create_semantic_memory_manager-1602"><a href="#create_semantic_memory_manager-1602"><span class="linenos">1602</span></a><span class="sd">    :param enable_semantic_dedup: Enable semantic duplicate detection</span>
</span><span id="create_semantic_memory_manager-1603"><a href="#create_semantic_memory_manager-1603"><span class="linenos">1603</span></a><span class="sd">    :param enable_exact_dedup: Enable exact duplicate detection</span>
</span><span id="create_semantic_memory_manager-1604"><a href="#create_semantic_memory_manager-1604"><span class="linenos">1604</span></a><span class="sd">    :param enable_topic_classification: Enable automatic topic classification</span>
</span><span id="create_semantic_memory_manager-1605"><a href="#create_semantic_memory_manager-1605"><span class="linenos">1605</span></a><span class="sd">    :param debug_mode: Enable debug output</span>
</span><span id="create_semantic_memory_manager-1606"><a href="#create_semantic_memory_manager-1606"><span class="linenos">1606</span></a><span class="sd">    :return: Configured SemanticMemoryManager instance</span>
</span><span id="create_semantic_memory_manager-1607"><a href="#create_semantic_memory_manager-1607"><span class="linenos">1607</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="create_semantic_memory_manager-1608"><a href="#create_semantic_memory_manager-1608"><span class="linenos">1608</span></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">SemanticMemoryManagerConfig</span><span class="p">(</span>
</span><span id="create_semantic_memory_manager-1609"><a href="#create_semantic_memory_manager-1609"><span class="linenos">1609</span></a>        <span class="n">similarity_threshold</span><span class="o">=</span><span class="n">similarity_threshold</span><span class="p">,</span>
</span><span id="create_semantic_memory_manager-1610"><a href="#create_semantic_memory_manager-1610"><span class="linenos">1610</span></a>        <span class="n">enable_semantic_dedup</span><span class="o">=</span><span class="n">enable_semantic_dedup</span><span class="p">,</span>
</span><span id="create_semantic_memory_manager-1611"><a href="#create_semantic_memory_manager-1611"><span class="linenos">1611</span></a>        <span class="n">enable_exact_dedup</span><span class="o">=</span><span class="n">enable_exact_dedup</span><span class="p">,</span>
</span><span id="create_semantic_memory_manager-1612"><a href="#create_semantic_memory_manager-1612"><span class="linenos">1612</span></a>        <span class="n">enable_topic_classification</span><span class="o">=</span><span class="n">enable_topic_classification</span><span class="p">,</span>
</span><span id="create_semantic_memory_manager-1613"><a href="#create_semantic_memory_manager-1613"><span class="linenos">1613</span></a>        <span class="n">debug_mode</span><span class="o">=</span><span class="n">debug_mode</span><span class="p">,</span>
</span><span id="create_semantic_memory_manager-1614"><a href="#create_semantic_memory_manager-1614"><span class="linenos">1614</span></a>    <span class="p">)</span>
</span><span id="create_semantic_memory_manager-1615"><a href="#create_semantic_memory_manager-1615"><span class="linenos">1615</span></a>
</span><span id="create_semantic_memory_manager-1616"><a href="#create_semantic_memory_manager-1616"><span class="linenos">1616</span></a>    <span class="k">return</span> <span class="n">SemanticMemoryManager</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a SemanticMemoryManager instance with sensible defaults.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>model</strong>:  Optional model instance (required by Agno Memory class)</li>
<li><strong>similarity_threshold</strong>:  Threshold for semantic similarity</li>
<li><strong>enable_semantic_dedup</strong>:  Enable semantic duplicate detection</li>
<li><strong>enable_exact_dedup</strong>:  Enable exact duplicate detection</li>
<li><strong>enable_topic_classification</strong>:  Enable automatic topic classification</li>
<li><strong>debug_mode</strong>:  Enable debug output</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Configured SemanticMemoryManager instance</p>
</blockquote>
</div>


                </section>
                <section id="KnowledgeCoordinator">
                            <input id="KnowledgeCoordinator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">KnowledgeCoordinator</span>:

                <label class="view-source-button" for="KnowledgeCoordinator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#KnowledgeCoordinator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="KnowledgeCoordinator-23"><a href="#KnowledgeCoordinator-23"><span class="linenos"> 23</span></a><span class="k">class</span><span class="w"> </span><span class="nc">KnowledgeCoordinator</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-24"><a href="#KnowledgeCoordinator-24"><span class="linenos"> 24</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-25"><a href="#KnowledgeCoordinator-25"><span class="linenos"> 25</span></a><span class="sd">    Coordinates queries between local semantic search and LightRAG graph systems.</span>
</span><span id="KnowledgeCoordinator-26"><a href="#KnowledgeCoordinator-26"><span class="linenos"> 26</span></a><span class="sd">    </span>
</span><span id="KnowledgeCoordinator-27"><a href="#KnowledgeCoordinator-27"><span class="linenos"> 27</span></a><span class="sd">    This class implements the Knowledge Coordinator shown in the architecture diagram,</span>
</span><span id="KnowledgeCoordinator-28"><a href="#KnowledgeCoordinator-28"><span class="linenos"> 28</span></a><span class="sd">    providing intelligent routing based on mode parameters and query analysis.</span>
</span><span id="KnowledgeCoordinator-29"><a href="#KnowledgeCoordinator-29"><span class="linenos"> 29</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-30"><a href="#KnowledgeCoordinator-30"><span class="linenos"> 30</span></a>
</span><span id="KnowledgeCoordinator-31"><a href="#KnowledgeCoordinator-31"><span class="linenos"> 31</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="KnowledgeCoordinator-32"><a href="#KnowledgeCoordinator-32"><span class="linenos"> 32</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-33"><a href="#KnowledgeCoordinator-33"><span class="linenos"> 33</span></a>        <span class="n">agno_knowledge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-34"><a href="#KnowledgeCoordinator-34"><span class="linenos"> 34</span></a>        <span class="n">lightrag_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">LIGHTRAG_URL</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-35"><a href="#KnowledgeCoordinator-35"><span class="linenos"> 35</span></a>        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="KnowledgeCoordinator-36"><a href="#KnowledgeCoordinator-36"><span class="linenos"> 36</span></a>    <span class="p">):</span>
</span><span id="KnowledgeCoordinator-37"><a href="#KnowledgeCoordinator-37"><span class="linenos"> 37</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-38"><a href="#KnowledgeCoordinator-38"><span class="linenos"> 38</span></a><span class="sd">        Initialize the Knowledge Coordinator.</span>
</span><span id="KnowledgeCoordinator-39"><a href="#KnowledgeCoordinator-39"><span class="linenos"> 39</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator-40"><a href="#KnowledgeCoordinator-40"><span class="linenos"> 40</span></a><span class="sd">        Args:</span>
</span><span id="KnowledgeCoordinator-41"><a href="#KnowledgeCoordinator-41"><span class="linenos"> 41</span></a><span class="sd">            agno_knowledge: Local semantic knowledge base (SQLite/LanceDB)</span>
</span><span id="KnowledgeCoordinator-42"><a href="#KnowledgeCoordinator-42"><span class="linenos"> 42</span></a><span class="sd">            lightrag_url: URL for LightRAG server</span>
</span><span id="KnowledgeCoordinator-43"><a href="#KnowledgeCoordinator-43"><span class="linenos"> 43</span></a><span class="sd">            debug: Enable debug logging</span>
</span><span id="KnowledgeCoordinator-44"><a href="#KnowledgeCoordinator-44"><span class="linenos"> 44</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-45"><a href="#KnowledgeCoordinator-45"><span class="linenos"> 45</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agno_knowledge</span> <span class="o">=</span> <span class="n">agno_knowledge</span>
</span><span id="KnowledgeCoordinator-46"><a href="#KnowledgeCoordinator-46"><span class="linenos"> 46</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_url</span> <span class="o">=</span> <span class="n">lightrag_url</span>
</span><span id="KnowledgeCoordinator-47"><a href="#KnowledgeCoordinator-47"><span class="linenos"> 47</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="KnowledgeCoordinator-48"><a href="#KnowledgeCoordinator-48"><span class="linenos"> 48</span></a>        
</span><span id="KnowledgeCoordinator-49"><a href="#KnowledgeCoordinator-49"><span class="linenos"> 49</span></a>        <span class="c1"># Query routing statistics</span>
</span><span id="KnowledgeCoordinator-50"><a href="#KnowledgeCoordinator-50"><span class="linenos"> 50</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="KnowledgeCoordinator-51"><a href="#KnowledgeCoordinator-51"><span class="linenos"> 51</span></a>            <span class="s2">&quot;local_semantic&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-52"><a href="#KnowledgeCoordinator-52"><span class="linenos"> 52</span></a>            <span class="s2">&quot;lightrag&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-53"><a href="#KnowledgeCoordinator-53"><span class="linenos"> 53</span></a>            <span class="s2">&quot;auto_detected_local&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-54"><a href="#KnowledgeCoordinator-54"><span class="linenos"> 54</span></a>            <span class="s2">&quot;auto_detected_lightrag&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-55"><a href="#KnowledgeCoordinator-55"><span class="linenos"> 55</span></a>            <span class="s2">&quot;fallback_used&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="KnowledgeCoordinator-56"><a href="#KnowledgeCoordinator-56"><span class="linenos"> 56</span></a>        <span class="p">}</span>
</span><span id="KnowledgeCoordinator-57"><a href="#KnowledgeCoordinator-57"><span class="linenos"> 57</span></a>        
</span><span id="KnowledgeCoordinator-58"><a href="#KnowledgeCoordinator-58"><span class="linenos"> 58</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Knowledge Coordinator initialized with LightRAG URL: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lightrag_url</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-59"><a href="#KnowledgeCoordinator-59"><span class="linenos"> 59</span></a>
</span><span id="KnowledgeCoordinator-60"><a href="#KnowledgeCoordinator-60"><span class="linenos"> 60</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_simple_fact_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-61"><a href="#KnowledgeCoordinator-61"><span class="linenos"> 61</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-62"><a href="#KnowledgeCoordinator-62"><span class="linenos"> 62</span></a><span class="sd">        Determine if a query is a simple fact lookup suitable for local semantic search.</span>
</span><span id="KnowledgeCoordinator-63"><a href="#KnowledgeCoordinator-63"><span class="linenos"> 63</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator-64"><a href="#KnowledgeCoordinator-64"><span class="linenos"> 64</span></a><span class="sd">        Args:</span>
</span><span id="KnowledgeCoordinator-65"><a href="#KnowledgeCoordinator-65"><span class="linenos"> 65</span></a><span class="sd">            query: The search query</span>
</span><span id="KnowledgeCoordinator-66"><a href="#KnowledgeCoordinator-66"><span class="linenos"> 66</span></a><span class="sd">            </span>
</span><span id="KnowledgeCoordinator-67"><a href="#KnowledgeCoordinator-67"><span class="linenos"> 67</span></a><span class="sd">        Returns:</span>
</span><span id="KnowledgeCoordinator-68"><a href="#KnowledgeCoordinator-68"><span class="linenos"> 68</span></a><span class="sd">            True if query appears to be a simple fact lookup</span>
</span><span id="KnowledgeCoordinator-69"><a href="#KnowledgeCoordinator-69"><span class="linenos"> 69</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-70"><a href="#KnowledgeCoordinator-70"><span class="linenos"> 70</span></a>        <span class="n">query_lower</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="KnowledgeCoordinator-71"><a href="#KnowledgeCoordinator-71"><span class="linenos"> 71</span></a>        
</span><span id="KnowledgeCoordinator-72"><a href="#KnowledgeCoordinator-72"><span class="linenos"> 72</span></a>        <span class="c1"># Simple fact indicators</span>
</span><span id="KnowledgeCoordinator-73"><a href="#KnowledgeCoordinator-73"><span class="linenos"> 73</span></a>        <span class="n">simple_patterns</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="KnowledgeCoordinator-74"><a href="#KnowledgeCoordinator-74"><span class="linenos"> 74</span></a>            <span class="sa">r</span><span class="s1">&#39;^what is\s+\w+&#39;</span><span class="p">,</span>  <span class="c1"># &quot;what is X&quot;</span>
</span><span id="KnowledgeCoordinator-75"><a href="#KnowledgeCoordinator-75"><span class="linenos"> 75</span></a>            <span class="sa">r</span><span class="s1">&#39;^who is\s+\w+&#39;</span><span class="p">,</span>   <span class="c1"># &quot;who is X&quot;</span>
</span><span id="KnowledgeCoordinator-76"><a href="#KnowledgeCoordinator-76"><span class="linenos"> 76</span></a>            <span class="sa">r</span><span class="s1">&#39;^when did\s+\w+&#39;</span><span class="p">,</span> <span class="c1"># &quot;when did X&quot;</span>
</span><span id="KnowledgeCoordinator-77"><a href="#KnowledgeCoordinator-77"><span class="linenos"> 77</span></a>            <span class="sa">r</span><span class="s1">&#39;^where is\s+\w+&#39;</span><span class="p">,</span> <span class="c1"># &quot;where is X&quot;</span>
</span><span id="KnowledgeCoordinator-78"><a href="#KnowledgeCoordinator-78"><span class="linenos"> 78</span></a>            <span class="sa">r</span><span class="s1">&#39;^how much\s+\w+&#39;</span><span class="p">,</span> <span class="c1"># &quot;how much X&quot;</span>
</span><span id="KnowledgeCoordinator-79"><a href="#KnowledgeCoordinator-79"><span class="linenos"> 79</span></a>            <span class="sa">r</span><span class="s1">&#39;^define\s+\w+&#39;</span><span class="p">,</span>   <span class="c1"># &quot;define X&quot;</span>
</span><span id="KnowledgeCoordinator-80"><a href="#KnowledgeCoordinator-80"><span class="linenos"> 80</span></a>            <span class="sa">r</span><span class="s1">&#39;^\w+\s+definition&#39;</span><span class="p">,</span> <span class="c1"># &quot;X definition&quot;</span>
</span><span id="KnowledgeCoordinator-81"><a href="#KnowledgeCoordinator-81"><span class="linenos"> 81</span></a>        <span class="p">]</span>
</span><span id="KnowledgeCoordinator-82"><a href="#KnowledgeCoordinator-82"><span class="linenos"> 82</span></a>        
</span><span id="KnowledgeCoordinator-83"><a href="#KnowledgeCoordinator-83"><span class="linenos"> 83</span></a>        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">simple_patterns</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-84"><a href="#KnowledgeCoordinator-84"><span class="linenos"> 84</span></a>            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">query_lower</span><span class="p">):</span>
</span><span id="KnowledgeCoordinator-85"><a href="#KnowledgeCoordinator-85"><span class="linenos"> 85</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="KnowledgeCoordinator-86"><a href="#KnowledgeCoordinator-86"><span class="linenos"> 86</span></a>                
</span><span id="KnowledgeCoordinator-87"><a href="#KnowledgeCoordinator-87"><span class="linenos"> 87</span></a>        <span class="c1"># Short queries are often simple facts</span>
</span><span id="KnowledgeCoordinator-88"><a href="#KnowledgeCoordinator-88"><span class="linenos"> 88</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-89"><a href="#KnowledgeCoordinator-89"><span class="linenos"> 89</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="KnowledgeCoordinator-90"><a href="#KnowledgeCoordinator-90"><span class="linenos"> 90</span></a>            
</span><span id="KnowledgeCoordinator-91"><a href="#KnowledgeCoordinator-91"><span class="linenos"> 91</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="KnowledgeCoordinator-92"><a href="#KnowledgeCoordinator-92"><span class="linenos"> 92</span></a>
</span><span id="KnowledgeCoordinator-93"><a href="#KnowledgeCoordinator-93"><span class="linenos"> 93</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_has_relationship_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-94"><a href="#KnowledgeCoordinator-94"><span class="linenos"> 94</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-95"><a href="#KnowledgeCoordinator-95"><span class="linenos"> 95</span></a><span class="sd">        Determine if a query involves relationships suitable for graph search.</span>
</span><span id="KnowledgeCoordinator-96"><a href="#KnowledgeCoordinator-96"><span class="linenos"> 96</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator-97"><a href="#KnowledgeCoordinator-97"><span class="linenos"> 97</span></a><span class="sd">        Args:</span>
</span><span id="KnowledgeCoordinator-98"><a href="#KnowledgeCoordinator-98"><span class="linenos"> 98</span></a><span class="sd">            query: The search query</span>
</span><span id="KnowledgeCoordinator-99"><a href="#KnowledgeCoordinator-99"><span class="linenos"> 99</span></a><span class="sd">            </span>
</span><span id="KnowledgeCoordinator-100"><a href="#KnowledgeCoordinator-100"><span class="linenos">100</span></a><span class="sd">        Returns:</span>
</span><span id="KnowledgeCoordinator-101"><a href="#KnowledgeCoordinator-101"><span class="linenos">101</span></a><span class="sd">            True if query appears to involve relationships or complex analysis</span>
</span><span id="KnowledgeCoordinator-102"><a href="#KnowledgeCoordinator-102"><span class="linenos">102</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-103"><a href="#KnowledgeCoordinator-103"><span class="linenos">103</span></a>        <span class="n">query_lower</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="KnowledgeCoordinator-104"><a href="#KnowledgeCoordinator-104"><span class="linenos">104</span></a>        
</span><span id="KnowledgeCoordinator-105"><a href="#KnowledgeCoordinator-105"><span class="linenos">105</span></a>        <span class="c1"># Relationship indicators</span>
</span><span id="KnowledgeCoordinator-106"><a href="#KnowledgeCoordinator-106"><span class="linenos">106</span></a>        <span class="n">relationship_keywords</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="KnowledgeCoordinator-107"><a href="#KnowledgeCoordinator-107"><span class="linenos">107</span></a>            <span class="s1">&#39;relationship&#39;</span><span class="p">,</span> <span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="s1">&#39;related&#39;</span><span class="p">,</span> <span class="s1">&#39;linked&#39;</span><span class="p">,</span> <span class="s1">&#39;associated&#39;</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-108"><a href="#KnowledgeCoordinator-108"><span class="linenos">108</span></a>            <span class="s1">&#39;compare&#39;</span><span class="p">,</span> <span class="s1">&#39;contrast&#39;</span><span class="p">,</span> <span class="s1">&#39;difference&#39;</span><span class="p">,</span> <span class="s1">&#39;similarity&#39;</span><span class="p">,</span> <span class="s1">&#39;versus&#39;</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-109"><a href="#KnowledgeCoordinator-109"><span class="linenos">109</span></a>            <span class="s1">&#39;how does&#39;</span><span class="p">,</span> <span class="s1">&#39;why does&#39;</span><span class="p">,</span> <span class="s1">&#39;what causes&#39;</span><span class="p">,</span> <span class="s1">&#39;impact of&#39;</span><span class="p">,</span> <span class="s1">&#39;effect of&#39;</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-110"><a href="#KnowledgeCoordinator-110"><span class="linenos">110</span></a>            <span class="s1">&#39;analyze&#39;</span><span class="p">,</span> <span class="s1">&#39;analysis&#39;</span><span class="p">,</span> <span class="s1">&#39;explain&#39;</span><span class="p">,</span> <span class="s1">&#39;reasoning&#39;</span><span class="p">,</span> <span class="s1">&#39;because&#39;</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-111"><a href="#KnowledgeCoordinator-111"><span class="linenos">111</span></a>            <span class="s1">&#39;correlation&#39;</span><span class="p">,</span> <span class="s1">&#39;influence&#39;</span><span class="p">,</span> <span class="s1">&#39;affect&#39;</span><span class="p">,</span> <span class="s1">&#39;consequence&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-112"><a href="#KnowledgeCoordinator-112"><span class="linenos">112</span></a>            <span class="s1">&#39;pattern&#39;</span><span class="p">,</span> <span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;network&#39;</span><span class="p">,</span> <span class="s1">&#39;graph&#39;</span><span class="p">,</span> <span class="s1">&#39;hierarchy&#39;</span>
</span><span id="KnowledgeCoordinator-113"><a href="#KnowledgeCoordinator-113"><span class="linenos">113</span></a>        <span class="p">]</span>
</span><span id="KnowledgeCoordinator-114"><a href="#KnowledgeCoordinator-114"><span class="linenos">114</span></a>        
</span><span id="KnowledgeCoordinator-115"><a href="#KnowledgeCoordinator-115"><span class="linenos">115</span></a>        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">relationship_keywords</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-116"><a href="#KnowledgeCoordinator-116"><span class="linenos">116</span></a>            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">query_lower</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-117"><a href="#KnowledgeCoordinator-117"><span class="linenos">117</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="KnowledgeCoordinator-118"><a href="#KnowledgeCoordinator-118"><span class="linenos">118</span></a>                
</span><span id="KnowledgeCoordinator-119"><a href="#KnowledgeCoordinator-119"><span class="linenos">119</span></a>        <span class="c1"># Complex question patterns</span>
</span><span id="KnowledgeCoordinator-120"><a href="#KnowledgeCoordinator-120"><span class="linenos">120</span></a>        <span class="n">complex_patterns</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="KnowledgeCoordinator-121"><a href="#KnowledgeCoordinator-121"><span class="linenos">121</span></a>            <span class="sa">r</span><span class="s1">&#39;how\s+\w+\s+\w+\s+\w+&#39;</span><span class="p">,</span>  <span class="c1"># &quot;how X Y Z&quot; (longer how questions)</span>
</span><span id="KnowledgeCoordinator-122"><a href="#KnowledgeCoordinator-122"><span class="linenos">122</span></a>            <span class="sa">r</span><span class="s1">&#39;why\s+\w+\s+\w+&#39;</span><span class="p">,</span>        <span class="c1"># &quot;why X Y&quot;</span>
</span><span id="KnowledgeCoordinator-123"><a href="#KnowledgeCoordinator-123"><span class="linenos">123</span></a>            <span class="sa">r</span><span class="s1">&#39;what\s+causes?\s+\w+&#39;</span><span class="p">,</span>   <span class="c1"># &quot;what causes X&quot;</span>
</span><span id="KnowledgeCoordinator-124"><a href="#KnowledgeCoordinator-124"><span class="linenos">124</span></a>            <span class="sa">r</span><span class="s1">&#39;explain\s+\w+&#39;</span><span class="p">,</span>          <span class="c1"># &quot;explain X&quot;</span>
</span><span id="KnowledgeCoordinator-125"><a href="#KnowledgeCoordinator-125"><span class="linenos">125</span></a>        <span class="p">]</span>
</span><span id="KnowledgeCoordinator-126"><a href="#KnowledgeCoordinator-126"><span class="linenos">126</span></a>        
</span><span id="KnowledgeCoordinator-127"><a href="#KnowledgeCoordinator-127"><span class="linenos">127</span></a>        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">complex_patterns</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-128"><a href="#KnowledgeCoordinator-128"><span class="linenos">128</span></a>            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">query_lower</span><span class="p">):</span>
</span><span id="KnowledgeCoordinator-129"><a href="#KnowledgeCoordinator-129"><span class="linenos">129</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="KnowledgeCoordinator-130"><a href="#KnowledgeCoordinator-130"><span class="linenos">130</span></a>                
</span><span id="KnowledgeCoordinator-131"><a href="#KnowledgeCoordinator-131"><span class="linenos">131</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="KnowledgeCoordinator-132"><a href="#KnowledgeCoordinator-132"><span class="linenos">132</span></a>
</span><span id="KnowledgeCoordinator-133"><a href="#KnowledgeCoordinator-133"><span class="linenos">133</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_routing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="KnowledgeCoordinator-134"><a href="#KnowledgeCoordinator-134"><span class="linenos">134</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-135"><a href="#KnowledgeCoordinator-135"><span class="linenos">135</span></a><span class="sd">        Determine which knowledge system to use based on mode and query analysis.</span>
</span><span id="KnowledgeCoordinator-136"><a href="#KnowledgeCoordinator-136"><span class="linenos">136</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator-137"><a href="#KnowledgeCoordinator-137"><span class="linenos">137</span></a><span class="sd">        Args:</span>
</span><span id="KnowledgeCoordinator-138"><a href="#KnowledgeCoordinator-138"><span class="linenos">138</span></a><span class="sd">            query: The search query</span>
</span><span id="KnowledgeCoordinator-139"><a href="#KnowledgeCoordinator-139"><span class="linenos">139</span></a><span class="sd">            mode: Routing mode specification</span>
</span><span id="KnowledgeCoordinator-140"><a href="#KnowledgeCoordinator-140"><span class="linenos">140</span></a><span class="sd">            </span>
</span><span id="KnowledgeCoordinator-141"><a href="#KnowledgeCoordinator-141"><span class="linenos">141</span></a><span class="sd">        Returns:</span>
</span><span id="KnowledgeCoordinator-142"><a href="#KnowledgeCoordinator-142"><span class="linenos">142</span></a><span class="sd">            Tuple of (routing_decision, reasoning)</span>
</span><span id="KnowledgeCoordinator-143"><a href="#KnowledgeCoordinator-143"><span class="linenos">143</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-144"><a href="#KnowledgeCoordinator-144"><span class="linenos">144</span></a>        <span class="n">mode_lower</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="KnowledgeCoordinator-145"><a href="#KnowledgeCoordinator-145"><span class="linenos">145</span></a>        
</span><span id="KnowledgeCoordinator-146"><a href="#KnowledgeCoordinator-146"><span class="linenos">146</span></a>        <span class="c1"># Explicit mode routing</span>
</span><span id="KnowledgeCoordinator-147"><a href="#KnowledgeCoordinator-147"><span class="linenos">147</span></a>        <span class="k">if</span> <span class="n">mode_lower</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-148"><a href="#KnowledgeCoordinator-148"><span class="linenos">148</span></a>            <span class="k">return</span> <span class="s2">&quot;local_semantic&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Explicit mode=local routing&quot;</span>
</span><span id="KnowledgeCoordinator-149"><a href="#KnowledgeCoordinator-149"><span class="linenos">149</span></a>            
</span><span id="KnowledgeCoordinator-150"><a href="#KnowledgeCoordinator-150"><span class="linenos">150</span></a>        <span class="k">if</span> <span class="n">mode_lower</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">,</span> <span class="s2">&quot;mix&quot;</span><span class="p">,</span> <span class="s2">&quot;naive&quot;</span><span class="p">,</span> <span class="s2">&quot;bypass&quot;</span><span class="p">]:</span>
</span><span id="KnowledgeCoordinator-151"><a href="#KnowledgeCoordinator-151"><span class="linenos">151</span></a>            <span class="k">return</span> <span class="s2">&quot;lightrag&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Explicit mode=</span><span class="si">{</span><span class="n">mode_lower</span><span class="si">}</span><span class="s2"> routing to LightRAG&quot;</span>
</span><span id="KnowledgeCoordinator-152"><a href="#KnowledgeCoordinator-152"><span class="linenos">152</span></a>            
</span><span id="KnowledgeCoordinator-153"><a href="#KnowledgeCoordinator-153"><span class="linenos">153</span></a>        <span class="c1"># Auto-detection for mode=&quot;auto&quot; or unspecified</span>
</span><span id="KnowledgeCoordinator-154"><a href="#KnowledgeCoordinator-154"><span class="linenos">154</span></a>        <span class="k">if</span> <span class="n">mode_lower</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
</span><span id="KnowledgeCoordinator-155"><a href="#KnowledgeCoordinator-155"><span class="linenos">155</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_simple_fact_query</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
</span><span id="KnowledgeCoordinator-156"><a href="#KnowledgeCoordinator-156"><span class="linenos">156</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="p">[</span><span class="s2">&quot;auto_detected_local&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="KnowledgeCoordinator-157"><a href="#KnowledgeCoordinator-157"><span class="linenos">157</span></a>                <span class="k">return</span> <span class="s2">&quot;local_semantic&quot;</span><span class="p">,</span> <span class="s2">&quot;Auto-detected: Simple fact query  Local semantic&quot;</span>
</span><span id="KnowledgeCoordinator-158"><a href="#KnowledgeCoordinator-158"><span class="linenos">158</span></a>                
</span><span id="KnowledgeCoordinator-159"><a href="#KnowledgeCoordinator-159"><span class="linenos">159</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_relationship_keywords</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
</span><span id="KnowledgeCoordinator-160"><a href="#KnowledgeCoordinator-160"><span class="linenos">160</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="p">[</span><span class="s2">&quot;auto_detected_lightrag&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="KnowledgeCoordinator-161"><a href="#KnowledgeCoordinator-161"><span class="linenos">161</span></a>                <span class="k">return</span> <span class="s2">&quot;lightrag&quot;</span><span class="p">,</span> <span class="s2">&quot;Auto-detected: Relationship query  LightRAG&quot;</span>
</span><span id="KnowledgeCoordinator-162"><a href="#KnowledgeCoordinator-162"><span class="linenos">162</span></a>                
</span><span id="KnowledgeCoordinator-163"><a href="#KnowledgeCoordinator-163"><span class="linenos">163</span></a>            <span class="c1"># Default to local for speed</span>
</span><span id="KnowledgeCoordinator-164"><a href="#KnowledgeCoordinator-164"><span class="linenos">164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="p">[</span><span class="s2">&quot;auto_detected_local&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="KnowledgeCoordinator-165"><a href="#KnowledgeCoordinator-165"><span class="linenos">165</span></a>            <span class="k">return</span> <span class="s2">&quot;local_semantic&quot;</span><span class="p">,</span> <span class="s2">&quot;Auto-detected: Default to local semantic for speed&quot;</span>
</span><span id="KnowledgeCoordinator-166"><a href="#KnowledgeCoordinator-166"><span class="linenos">166</span></a>            
</span><span id="KnowledgeCoordinator-167"><a href="#KnowledgeCoordinator-167"><span class="linenos">167</span></a>        <span class="c1"># Unknown mode - default to local</span>
</span><span id="KnowledgeCoordinator-168"><a href="#KnowledgeCoordinator-168"><span class="linenos">168</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown mode &#39;</span><span class="si">%s</span><span class="s2">&#39;, defaulting to local semantic&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-169"><a href="#KnowledgeCoordinator-169"><span class="linenos">169</span></a>        <span class="k">return</span> <span class="s2">&quot;local_semantic&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown mode &#39;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39;  Default to local semantic&quot;</span>
</span><span id="KnowledgeCoordinator-170"><a href="#KnowledgeCoordinator-170"><span class="linenos">170</span></a>
</span><span id="KnowledgeCoordinator-171"><a href="#KnowledgeCoordinator-171"><span class="linenos">171</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_query_local_semantic</span><span class="p">(</span>
</span><span id="KnowledgeCoordinator-172"><a href="#KnowledgeCoordinator-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="p">,</span> 
</span><span id="KnowledgeCoordinator-173"><a href="#KnowledgeCoordinator-173"><span class="linenos">173</span></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="KnowledgeCoordinator-174"><a href="#KnowledgeCoordinator-174"><span class="linenos">174</span></a>        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
</span><span id="KnowledgeCoordinator-175"><a href="#KnowledgeCoordinator-175"><span class="linenos">175</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-176"><a href="#KnowledgeCoordinator-176"><span class="linenos">176</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-177"><a href="#KnowledgeCoordinator-177"><span class="linenos">177</span></a><span class="sd">        Query the local semantic knowledge base (SQLite/LanceDB).</span>
</span><span id="KnowledgeCoordinator-178"><a href="#KnowledgeCoordinator-178"><span class="linenos">178</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator-179"><a href="#KnowledgeCoordinator-179"><span class="linenos">179</span></a><span class="sd">        Args:</span>
</span><span id="KnowledgeCoordinator-180"><a href="#KnowledgeCoordinator-180"><span class="linenos">180</span></a><span class="sd">            query: The search query</span>
</span><span id="KnowledgeCoordinator-181"><a href="#KnowledgeCoordinator-181"><span class="linenos">181</span></a><span class="sd">            limit: Maximum number of results</span>
</span><span id="KnowledgeCoordinator-182"><a href="#KnowledgeCoordinator-182"><span class="linenos">182</span></a><span class="sd">            </span>
</span><span id="KnowledgeCoordinator-183"><a href="#KnowledgeCoordinator-183"><span class="linenos">183</span></a><span class="sd">        Returns:</span>
</span><span id="KnowledgeCoordinator-184"><a href="#KnowledgeCoordinator-184"><span class="linenos">184</span></a><span class="sd">            Formatted search results</span>
</span><span id="KnowledgeCoordinator-185"><a href="#KnowledgeCoordinator-185"><span class="linenos">185</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-186"><a href="#KnowledgeCoordinator-186"><span class="linenos">186</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_knowledge</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-187"><a href="#KnowledgeCoordinator-187"><span class="linenos">187</span></a>            <span class="k">return</span> <span class="s2">&quot; Local semantic knowledge base is not available.&quot;</span>
</span><span id="KnowledgeCoordinator-188"><a href="#KnowledgeCoordinator-188"><span class="linenos">188</span></a>            
</span><span id="KnowledgeCoordinator-189"><a href="#KnowledgeCoordinator-189"><span class="linenos">189</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-190"><a href="#KnowledgeCoordinator-190"><span class="linenos">190</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_knowledge</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">num_documents</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-191"><a href="#KnowledgeCoordinator-191"><span class="linenos">191</span></a>            
</span><span id="KnowledgeCoordinator-192"><a href="#KnowledgeCoordinator-192"><span class="linenos">192</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-193"><a href="#KnowledgeCoordinator-193"><span class="linenos">193</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; No results found in local knowledge base for &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
</span><span id="KnowledgeCoordinator-194"><a href="#KnowledgeCoordinator-194"><span class="linenos">194</span></a>                
</span><span id="KnowledgeCoordinator-195"><a href="#KnowledgeCoordinator-195"><span class="linenos">195</span></a>            <span class="c1"># Format results</span>
</span><span id="KnowledgeCoordinator-196"><a href="#KnowledgeCoordinator-196"><span class="linenos">196</span></a>            <span class="n">formatted_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="KnowledgeCoordinator-197"><a href="#KnowledgeCoordinator-197"><span class="linenos">197</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="KnowledgeCoordinator-198"><a href="#KnowledgeCoordinator-198"><span class="linenos">198</span></a>                <span class="n">source_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(Source: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">source</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-199"><a href="#KnowledgeCoordinator-199"><span class="linenos">199</span></a>                <span class="n">formatted_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Result </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">** </span><span class="si">{</span><span class="n">source_info</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-200"><a href="#KnowledgeCoordinator-200"><span class="linenos">200</span></a>                
</span><span id="KnowledgeCoordinator-201"><a href="#KnowledgeCoordinator-201"><span class="linenos">201</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; **Local Knowledge Search Results** for &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator-202"><a href="#KnowledgeCoordinator-202"><span class="linenos">202</span></a>            <span class="n">response</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_results</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-203"><a href="#KnowledgeCoordinator-203"><span class="linenos">203</span></a>            
</span><span id="KnowledgeCoordinator-204"><a href="#KnowledgeCoordinator-204"><span class="linenos">204</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Local semantic search returned </span><span class="si">%d</span><span class="s2"> results for: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">query</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-205"><a href="#KnowledgeCoordinator-205"><span class="linenos">205</span></a>            <span class="k">return</span> <span class="n">response</span>
</span><span id="KnowledgeCoordinator-206"><a href="#KnowledgeCoordinator-206"><span class="linenos">206</span></a>            
</span><span id="KnowledgeCoordinator-207"><a href="#KnowledgeCoordinator-207"><span class="linenos">207</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-208"><a href="#KnowledgeCoordinator-208"><span class="linenos">208</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in local semantic search: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-209"><a href="#KnowledgeCoordinator-209"><span class="linenos">209</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error searching local knowledge base: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator-210"><a href="#KnowledgeCoordinator-210"><span class="linenos">210</span></a>
</span><span id="KnowledgeCoordinator-211"><a href="#KnowledgeCoordinator-211"><span class="linenos">211</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_query_lightrag</span><span class="p">(</span>
</span><span id="KnowledgeCoordinator-212"><a href="#KnowledgeCoordinator-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-213"><a href="#KnowledgeCoordinator-213"><span class="linenos">213</span></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-214"><a href="#KnowledgeCoordinator-214"><span class="linenos">214</span></a>        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-215"><a href="#KnowledgeCoordinator-215"><span class="linenos">215</span></a>        <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-216"><a href="#KnowledgeCoordinator-216"><span class="linenos">216</span></a>        <span class="n">response_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Multiple Paragraphs&quot;</span>
</span><span id="KnowledgeCoordinator-217"><a href="#KnowledgeCoordinator-217"><span class="linenos">217</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-218"><a href="#KnowledgeCoordinator-218"><span class="linenos">218</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-219"><a href="#KnowledgeCoordinator-219"><span class="linenos">219</span></a><span class="sd">        Query the LightRAG graph knowledge system.</span>
</span><span id="KnowledgeCoordinator-220"><a href="#KnowledgeCoordinator-220"><span class="linenos">220</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator-221"><a href="#KnowledgeCoordinator-221"><span class="linenos">221</span></a><span class="sd">        Args:</span>
</span><span id="KnowledgeCoordinator-222"><a href="#KnowledgeCoordinator-222"><span class="linenos">222</span></a><span class="sd">            query: The search query</span>
</span><span id="KnowledgeCoordinator-223"><a href="#KnowledgeCoordinator-223"><span class="linenos">223</span></a><span class="sd">            mode: LightRAG query mode</span>
</span><span id="KnowledgeCoordinator-224"><a href="#KnowledgeCoordinator-224"><span class="linenos">224</span></a><span class="sd">            top_k: Number of top results</span>
</span><span id="KnowledgeCoordinator-225"><a href="#KnowledgeCoordinator-225"><span class="linenos">225</span></a><span class="sd">            response_type: Response format</span>
</span><span id="KnowledgeCoordinator-226"><a href="#KnowledgeCoordinator-226"><span class="linenos">226</span></a><span class="sd">            </span>
</span><span id="KnowledgeCoordinator-227"><a href="#KnowledgeCoordinator-227"><span class="linenos">227</span></a><span class="sd">        Returns:</span>
</span><span id="KnowledgeCoordinator-228"><a href="#KnowledgeCoordinator-228"><span class="linenos">228</span></a><span class="sd">            LightRAG response content</span>
</span><span id="KnowledgeCoordinator-229"><a href="#KnowledgeCoordinator-229"><span class="linenos">229</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-230"><a href="#KnowledgeCoordinator-230"><span class="linenos">230</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-231"><a href="#KnowledgeCoordinator-231"><span class="linenos">231</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_url</span><span class="si">}</span><span class="s2">/query&quot;</span>
</span><span id="KnowledgeCoordinator-232"><a href="#KnowledgeCoordinator-232"><span class="linenos">232</span></a>            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="KnowledgeCoordinator-233"><a href="#KnowledgeCoordinator-233"><span class="linenos">233</span></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-234"><a href="#KnowledgeCoordinator-234"><span class="linenos">234</span></a>                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-235"><a href="#KnowledgeCoordinator-235"><span class="linenos">235</span></a>                <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="n">top_k</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-236"><a href="#KnowledgeCoordinator-236"><span class="linenos">236</span></a>                <span class="s2">&quot;response_type&quot;</span><span class="p">:</span> <span class="n">response_type</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-237"><a href="#KnowledgeCoordinator-237"><span class="linenos">237</span></a>            <span class="p">}</span>
</span><span id="KnowledgeCoordinator-238"><a href="#KnowledgeCoordinator-238"><span class="linenos">238</span></a>            
</span><span id="KnowledgeCoordinator-239"><a href="#KnowledgeCoordinator-239"><span class="linenos">239</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Querying LightRAG: </span><span class="si">%s</span><span class="s2"> with payload: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-240"><a href="#KnowledgeCoordinator-240"><span class="linenos">240</span></a>            
</span><span id="KnowledgeCoordinator-241"><a href="#KnowledgeCoordinator-241"><span class="linenos">241</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-242"><a href="#KnowledgeCoordinator-242"><span class="linenos">242</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-243"><a href="#KnowledgeCoordinator-243"><span class="linenos">243</span></a>                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-244"><a href="#KnowledgeCoordinator-244"><span class="linenos">244</span></a>                        <span class="n">error_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="KnowledgeCoordinator-245"><a href="#KnowledgeCoordinator-245"><span class="linenos">245</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;LightRAG server error </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">error_text</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-246"><a href="#KnowledgeCoordinator-246"><span class="linenos">246</span></a>                        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; LightRAG server error </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator-247"><a href="#KnowledgeCoordinator-247"><span class="linenos">247</span></a>                        
</span><span id="KnowledgeCoordinator-248"><a href="#KnowledgeCoordinator-248"><span class="linenos">248</span></a>                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="KnowledgeCoordinator-249"><a href="#KnowledgeCoordinator-249"><span class="linenos">249</span></a>                    
</span><span id="KnowledgeCoordinator-250"><a href="#KnowledgeCoordinator-250"><span class="linenos">250</span></a>                    <span class="c1"># Extract response content</span>
</span><span id="KnowledgeCoordinator-251"><a href="#KnowledgeCoordinator-251"><span class="linenos">251</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;response&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-252"><a href="#KnowledgeCoordinator-252"><span class="linenos">252</span></a>                        <span class="n">response_content</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span>
</span><span id="KnowledgeCoordinator-253"><a href="#KnowledgeCoordinator-253"><span class="linenos">253</span></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;content&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-254"><a href="#KnowledgeCoordinator-254"><span class="linenos">254</span></a>                        <span class="n">response_content</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
</span><span id="KnowledgeCoordinator-255"><a href="#KnowledgeCoordinator-255"><span class="linenos">255</span></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;answer&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-256"><a href="#KnowledgeCoordinator-256"><span class="linenos">256</span></a>                        <span class="n">response_content</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;answer&quot;</span><span class="p">]</span>
</span><span id="KnowledgeCoordinator-257"><a href="#KnowledgeCoordinator-257"><span class="linenos">257</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-258"><a href="#KnowledgeCoordinator-258"><span class="linenos">258</span></a>                        <span class="n">response_content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-259"><a href="#KnowledgeCoordinator-259"><span class="linenos">259</span></a>                        
</span><span id="KnowledgeCoordinator-260"><a href="#KnowledgeCoordinator-260"><span class="linenos">260</span></a>                    <span class="c1"># Add header to indicate source</span>
</span><span id="KnowledgeCoordinator-261"><a href="#KnowledgeCoordinator-261"><span class="linenos">261</span></a>                    <span class="n">formatted_response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; **LightRAG Knowledge Graph Results** (mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">) for &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">response_content</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator-262"><a href="#KnowledgeCoordinator-262"><span class="linenos">262</span></a>                    
</span><span id="KnowledgeCoordinator-263"><a href="#KnowledgeCoordinator-263"><span class="linenos">263</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LightRAG search completed for: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-264"><a href="#KnowledgeCoordinator-264"><span class="linenos">264</span></a>                    <span class="k">return</span> <span class="n">formatted_response</span>
</span><span id="KnowledgeCoordinator-265"><a href="#KnowledgeCoordinator-265"><span class="linenos">265</span></a>                    
</span><span id="KnowledgeCoordinator-266"><a href="#KnowledgeCoordinator-266"><span class="linenos">266</span></a>        <span class="k">except</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientConnectorError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-267"><a href="#KnowledgeCoordinator-267"><span class="linenos">267</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; Cannot connect to LightRAG server at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_url</span><span class="si">}</span><span class="s2">. Is the server running? Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator-268"><a href="#KnowledgeCoordinator-268"><span class="linenos">268</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-269"><a href="#KnowledgeCoordinator-269"><span class="linenos">269</span></a>            <span class="k">return</span> <span class="n">error_msg</span>
</span><span id="KnowledgeCoordinator-270"><a href="#KnowledgeCoordinator-270"><span class="linenos">270</span></a>        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-271"><a href="#KnowledgeCoordinator-271"><span class="linenos">271</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; Timeout connecting to LightRAG server at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lightrag_url</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator-272"><a href="#KnowledgeCoordinator-272"><span class="linenos">272</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-273"><a href="#KnowledgeCoordinator-273"><span class="linenos">273</span></a>            <span class="k">return</span> <span class="n">error_msg</span>
</span><span id="KnowledgeCoordinator-274"><a href="#KnowledgeCoordinator-274"><span class="linenos">274</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-275"><a href="#KnowledgeCoordinator-275"><span class="linenos">275</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; Error querying LightRAG: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator-276"><a href="#KnowledgeCoordinator-276"><span class="linenos">276</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-277"><a href="#KnowledgeCoordinator-277"><span class="linenos">277</span></a>            <span class="k">return</span> <span class="n">error_msg</span>
</span><span id="KnowledgeCoordinator-278"><a href="#KnowledgeCoordinator-278"><span class="linenos">278</span></a>
</span><span id="KnowledgeCoordinator-279"><a href="#KnowledgeCoordinator-279"><span class="linenos">279</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query_knowledge_base</span><span class="p">(</span>
</span><span id="KnowledgeCoordinator-280"><a href="#KnowledgeCoordinator-280"><span class="linenos">280</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-281"><a href="#KnowledgeCoordinator-281"><span class="linenos">281</span></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-282"><a href="#KnowledgeCoordinator-282"><span class="linenos">282</span></a>        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-283"><a href="#KnowledgeCoordinator-283"><span class="linenos">283</span></a>        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-284"><a href="#KnowledgeCoordinator-284"><span class="linenos">284</span></a>        <span class="n">response_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Multiple Paragraphs&quot;</span>
</span><span id="KnowledgeCoordinator-285"><a href="#KnowledgeCoordinator-285"><span class="linenos">285</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-286"><a href="#KnowledgeCoordinator-286"><span class="linenos">286</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-287"><a href="#KnowledgeCoordinator-287"><span class="linenos">287</span></a><span class="sd">        Unified knowledge base query with intelligent routing.</span>
</span><span id="KnowledgeCoordinator-288"><a href="#KnowledgeCoordinator-288"><span class="linenos">288</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator-289"><a href="#KnowledgeCoordinator-289"><span class="linenos">289</span></a><span class="sd">        This is the main entry point for all knowledge queries. It intelligently</span>
</span><span id="KnowledgeCoordinator-290"><a href="#KnowledgeCoordinator-290"><span class="linenos">290</span></a><span class="sd">        routes queries between local semantic search and LightRAG based on the</span>
</span><span id="KnowledgeCoordinator-291"><a href="#KnowledgeCoordinator-291"><span class="linenos">291</span></a><span class="sd">        mode parameter and query characteristics.</span>
</span><span id="KnowledgeCoordinator-292"><a href="#KnowledgeCoordinator-292"><span class="linenos">292</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator-293"><a href="#KnowledgeCoordinator-293"><span class="linenos">293</span></a><span class="sd">        Args:</span>
</span><span id="KnowledgeCoordinator-294"><a href="#KnowledgeCoordinator-294"><span class="linenos">294</span></a><span class="sd">            query: The search query</span>
</span><span id="KnowledgeCoordinator-295"><a href="#KnowledgeCoordinator-295"><span class="linenos">295</span></a><span class="sd">            mode: Routing mode:</span>
</span><span id="KnowledgeCoordinator-296"><a href="#KnowledgeCoordinator-296"><span class="linenos">296</span></a><span class="sd">                  - &quot;local&quot;: Force local semantic search</span>
</span><span id="KnowledgeCoordinator-297"><a href="#KnowledgeCoordinator-297"><span class="linenos">297</span></a><span class="sd">                  - &quot;global&quot;, &quot;hybrid&quot;, &quot;mix&quot;, &quot;naive&quot;, &quot;bypass&quot;: Use LightRAG</span>
</span><span id="KnowledgeCoordinator-298"><a href="#KnowledgeCoordinator-298"><span class="linenos">298</span></a><span class="sd">                  - &quot;auto&quot;: Intelligent auto-detection (default)</span>
</span><span id="KnowledgeCoordinator-299"><a href="#KnowledgeCoordinator-299"><span class="linenos">299</span></a><span class="sd">            limit: Maximum results for local search / top_k for LightRAG</span>
</span><span id="KnowledgeCoordinator-300"><a href="#KnowledgeCoordinator-300"><span class="linenos">300</span></a><span class="sd">            response_type: Format for LightRAG responses</span>
</span><span id="KnowledgeCoordinator-301"><a href="#KnowledgeCoordinator-301"><span class="linenos">301</span></a><span class="sd">            </span>
</span><span id="KnowledgeCoordinator-302"><a href="#KnowledgeCoordinator-302"><span class="linenos">302</span></a><span class="sd">        Returns:</span>
</span><span id="KnowledgeCoordinator-303"><a href="#KnowledgeCoordinator-303"><span class="linenos">303</span></a><span class="sd">            Formatted search results from the appropriate knowledge system</span>
</span><span id="KnowledgeCoordinator-304"><a href="#KnowledgeCoordinator-304"><span class="linenos">304</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-305"><a href="#KnowledgeCoordinator-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="KnowledgeCoordinator-306"><a href="#KnowledgeCoordinator-306"><span class="linenos">306</span></a>            <span class="k">return</span> <span class="s2">&quot; Error: Query cannot be empty. Please provide a search term.&quot;</span>
</span><span id="KnowledgeCoordinator-307"><a href="#KnowledgeCoordinator-307"><span class="linenos">307</span></a>            
</span><span id="KnowledgeCoordinator-308"><a href="#KnowledgeCoordinator-308"><span class="linenos">308</span></a>        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="KnowledgeCoordinator-309"><a href="#KnowledgeCoordinator-309"><span class="linenos">309</span></a>        
</span><span id="KnowledgeCoordinator-310"><a href="#KnowledgeCoordinator-310"><span class="linenos">310</span></a>        <span class="c1"># Determine routing</span>
</span><span id="KnowledgeCoordinator-311"><a href="#KnowledgeCoordinator-311"><span class="linenos">311</span></a>        <span class="n">routing_decision</span><span class="p">,</span> <span class="n">reasoning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_routing</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-312"><a href="#KnowledgeCoordinator-312"><span class="linenos">312</span></a>        
</span><span id="KnowledgeCoordinator-313"><a href="#KnowledgeCoordinator-313"><span class="linenos">313</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-314"><a href="#KnowledgeCoordinator-314"><span class="linenos">314</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Knowledge routing: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">routing_decision</span><span class="p">,</span> <span class="n">reasoning</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-315"><a href="#KnowledgeCoordinator-315"><span class="linenos">315</span></a>            
</span><span id="KnowledgeCoordinator-316"><a href="#KnowledgeCoordinator-316"><span class="linenos">316</span></a>        <span class="c1"># Update statistics</span>
</span><span id="KnowledgeCoordinator-317"><a href="#KnowledgeCoordinator-317"><span class="linenos">317</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="p">[</span><span class="n">routing_decision</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="KnowledgeCoordinator-318"><a href="#KnowledgeCoordinator-318"><span class="linenos">318</span></a>        
</span><span id="KnowledgeCoordinator-319"><a href="#KnowledgeCoordinator-319"><span class="linenos">319</span></a>        <span class="c1"># Route to appropriate system</span>
</span><span id="KnowledgeCoordinator-320"><a href="#KnowledgeCoordinator-320"><span class="linenos">320</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-321"><a href="#KnowledgeCoordinator-321"><span class="linenos">321</span></a>            <span class="k">if</span> <span class="n">routing_decision</span> <span class="o">==</span> <span class="s2">&quot;local_semantic&quot;</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-322"><a href="#KnowledgeCoordinator-322"><span class="linenos">322</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_local_semantic</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-323"><a href="#KnowledgeCoordinator-323"><span class="linenos">323</span></a>                
</span><span id="KnowledgeCoordinator-324"><a href="#KnowledgeCoordinator-324"><span class="linenos">324</span></a>                <span class="c1"># If local search fails and we have LightRAG available, try fallback</span>
</span><span id="KnowledgeCoordinator-325"><a href="#KnowledgeCoordinator-325"><span class="linenos">325</span></a>                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_url</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-326"><a href="#KnowledgeCoordinator-326"><span class="linenos">326</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Local search failed, attempting LightRAG fallback&quot;</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-327"><a href="#KnowledgeCoordinator-327"><span class="linenos">327</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="p">[</span><span class="s2">&quot;fallback_used&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="KnowledgeCoordinator-328"><a href="#KnowledgeCoordinator-328"><span class="linenos">328</span></a>                    <span class="n">fallback_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_lightrag</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">response_type</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-329"><a href="#KnowledgeCoordinator-329"><span class="linenos">329</span></a>                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">**Fallback to LightRAG:**</span><span class="se">\n</span><span class="si">{</span><span class="n">fallback_result</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator-330"><a href="#KnowledgeCoordinator-330"><span class="linenos">330</span></a>                    
</span><span id="KnowledgeCoordinator-331"><a href="#KnowledgeCoordinator-331"><span class="linenos">331</span></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="KnowledgeCoordinator-332"><a href="#KnowledgeCoordinator-332"><span class="linenos">332</span></a>                
</span><span id="KnowledgeCoordinator-333"><a href="#KnowledgeCoordinator-333"><span class="linenos">333</span></a>            <span class="k">elif</span> <span class="n">routing_decision</span> <span class="o">==</span> <span class="s2">&quot;lightrag&quot;</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-334"><a href="#KnowledgeCoordinator-334"><span class="linenos">334</span></a>                <span class="c1"># For LightRAG, use the original mode if it was explicitly specified</span>
</span><span id="KnowledgeCoordinator-335"><a href="#KnowledgeCoordinator-335"><span class="linenos">335</span></a>                <span class="n">lightrag_mode</span> <span class="o">=</span> <span class="n">mode</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">,</span> <span class="s2">&quot;mix&quot;</span><span class="p">,</span> <span class="s2">&quot;naive&quot;</span><span class="p">,</span> <span class="s2">&quot;bypass&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;hybrid&quot;</span>
</span><span id="KnowledgeCoordinator-336"><a href="#KnowledgeCoordinator-336"><span class="linenos">336</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_lightrag</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">lightrag_mode</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">response_type</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-337"><a href="#KnowledgeCoordinator-337"><span class="linenos">337</span></a>                
</span><span id="KnowledgeCoordinator-338"><a href="#KnowledgeCoordinator-338"><span class="linenos">338</span></a>                <span class="c1"># If LightRAG fails and we have local knowledge, try fallback</span>
</span><span id="KnowledgeCoordinator-339"><a href="#KnowledgeCoordinator-339"><span class="linenos">339</span></a>                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_knowledge</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-340"><a href="#KnowledgeCoordinator-340"><span class="linenos">340</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LightRAG failed, attempting local semantic fallback&quot;</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-341"><a href="#KnowledgeCoordinator-341"><span class="linenos">341</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="p">[</span><span class="s2">&quot;fallback_used&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="KnowledgeCoordinator-342"><a href="#KnowledgeCoordinator-342"><span class="linenos">342</span></a>                    <span class="n">fallback_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_local_semantic</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-343"><a href="#KnowledgeCoordinator-343"><span class="linenos">343</span></a>                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">**Fallback to Local Search:**</span><span class="se">\n</span><span class="si">{</span><span class="n">fallback_result</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator-344"><a href="#KnowledgeCoordinator-344"><span class="linenos">344</span></a>                    
</span><span id="KnowledgeCoordinator-345"><a href="#KnowledgeCoordinator-345"><span class="linenos">345</span></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="KnowledgeCoordinator-346"><a href="#KnowledgeCoordinator-346"><span class="linenos">346</span></a>                
</span><span id="KnowledgeCoordinator-347"><a href="#KnowledgeCoordinator-347"><span class="linenos">347</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-348"><a href="#KnowledgeCoordinator-348"><span class="linenos">348</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Unknown routing decision: </span><span class="si">{</span><span class="n">routing_decision</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator-349"><a href="#KnowledgeCoordinator-349"><span class="linenos">349</span></a>                
</span><span id="KnowledgeCoordinator-350"><a href="#KnowledgeCoordinator-350"><span class="linenos">350</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-351"><a href="#KnowledgeCoordinator-351"><span class="linenos">351</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in knowledge coordinator: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator-352"><a href="#KnowledgeCoordinator-352"><span class="linenos">352</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error processing knowledge query: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator-353"><a href="#KnowledgeCoordinator-353"><span class="linenos">353</span></a>
</span><span id="KnowledgeCoordinator-354"><a href="#KnowledgeCoordinator-354"><span class="linenos">354</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_routing_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
</span><span id="KnowledgeCoordinator-355"><a href="#KnowledgeCoordinator-355"><span class="linenos">355</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-356"><a href="#KnowledgeCoordinator-356"><span class="linenos">356</span></a><span class="sd">        Get statistics about query routing decisions.</span>
</span><span id="KnowledgeCoordinator-357"><a href="#KnowledgeCoordinator-357"><span class="linenos">357</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator-358"><a href="#KnowledgeCoordinator-358"><span class="linenos">358</span></a><span class="sd">        Returns:</span>
</span><span id="KnowledgeCoordinator-359"><a href="#KnowledgeCoordinator-359"><span class="linenos">359</span></a><span class="sd">            Dictionary with routing statistics</span>
</span><span id="KnowledgeCoordinator-360"><a href="#KnowledgeCoordinator-360"><span class="linenos">360</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-361"><a href="#KnowledgeCoordinator-361"><span class="linenos">361</span></a>        <span class="n">total_queries</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="KnowledgeCoordinator-362"><a href="#KnowledgeCoordinator-362"><span class="linenos">362</span></a>        
</span><span id="KnowledgeCoordinator-363"><a href="#KnowledgeCoordinator-363"><span class="linenos">363</span></a>        <span class="k">if</span> <span class="n">total_queries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-364"><a href="#KnowledgeCoordinator-364"><span class="linenos">364</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total_queries&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No queries processed yet&quot;</span><span class="p">}</span>
</span><span id="KnowledgeCoordinator-365"><a href="#KnowledgeCoordinator-365"><span class="linenos">365</span></a>            
</span><span id="KnowledgeCoordinator-366"><a href="#KnowledgeCoordinator-366"><span class="linenos">366</span></a>        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="KnowledgeCoordinator-367"><a href="#KnowledgeCoordinator-367"><span class="linenos">367</span></a>        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_queries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_queries</span>
</span><span id="KnowledgeCoordinator-368"><a href="#KnowledgeCoordinator-368"><span class="linenos">368</span></a>        
</span><span id="KnowledgeCoordinator-369"><a href="#KnowledgeCoordinator-369"><span class="linenos">369</span></a>        <span class="c1"># Add percentages</span>
</span><span id="KnowledgeCoordinator-370"><a href="#KnowledgeCoordinator-370"><span class="linenos">370</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="KnowledgeCoordinator-371"><a href="#KnowledgeCoordinator-371"><span class="linenos">371</span></a>            <span class="n">stats</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_percentage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">total_queries</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="KnowledgeCoordinator-372"><a href="#KnowledgeCoordinator-372"><span class="linenos">372</span></a>            
</span><span id="KnowledgeCoordinator-373"><a href="#KnowledgeCoordinator-373"><span class="linenos">373</span></a>        <span class="k">return</span> <span class="n">stats</span>
</span><span id="KnowledgeCoordinator-374"><a href="#KnowledgeCoordinator-374"><span class="linenos">374</span></a>
</span><span id="KnowledgeCoordinator-375"><a href="#KnowledgeCoordinator-375"><span class="linenos">375</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator-376"><a href="#KnowledgeCoordinator-376"><span class="linenos">376</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset routing statistics.&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator-377"><a href="#KnowledgeCoordinator-377"><span class="linenos">377</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="KnowledgeCoordinator-378"><a href="#KnowledgeCoordinator-378"><span class="linenos">378</span></a>            <span class="s2">&quot;local_semantic&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-379"><a href="#KnowledgeCoordinator-379"><span class="linenos">379</span></a>            <span class="s2">&quot;lightrag&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-380"><a href="#KnowledgeCoordinator-380"><span class="linenos">380</span></a>            <span class="s2">&quot;auto_detected_local&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-381"><a href="#KnowledgeCoordinator-381"><span class="linenos">381</span></a>            <span class="s2">&quot;auto_detected_lightrag&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator-382"><a href="#KnowledgeCoordinator-382"><span class="linenos">382</span></a>            <span class="s2">&quot;fallback_used&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="KnowledgeCoordinator-383"><a href="#KnowledgeCoordinator-383"><span class="linenos">383</span></a>        <span class="p">}</span>
</span><span id="KnowledgeCoordinator-384"><a href="#KnowledgeCoordinator-384"><span class="linenos">384</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Knowledge coordinator statistics reset&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Coordinates queries between local semantic search and LightRAG graph systems.</p>

<p>This class implements the Knowledge Coordinator shown in the architecture diagram,
providing intelligent routing based on mode parameters and query analysis.</p>
</div>


                            <div id="KnowledgeCoordinator.__init__" class="classattr">
                                        <input id="KnowledgeCoordinator.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">KnowledgeCoordinator</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">agno_knowledge</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">lightrag_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:9621&#39;</span>,</span><span class="param">	<span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="KnowledgeCoordinator.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#KnowledgeCoordinator.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="KnowledgeCoordinator.__init__-31"><a href="#KnowledgeCoordinator.__init__-31"><span class="linenos">31</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="KnowledgeCoordinator.__init__-32"><a href="#KnowledgeCoordinator.__init__-32"><span class="linenos">32</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.__init__-33"><a href="#KnowledgeCoordinator.__init__-33"><span class="linenos">33</span></a>        <span class="n">agno_knowledge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.__init__-34"><a href="#KnowledgeCoordinator.__init__-34"><span class="linenos">34</span></a>        <span class="n">lightrag_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">LIGHTRAG_URL</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.__init__-35"><a href="#KnowledgeCoordinator.__init__-35"><span class="linenos">35</span></a>        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="KnowledgeCoordinator.__init__-36"><a href="#KnowledgeCoordinator.__init__-36"><span class="linenos">36</span></a>    <span class="p">):</span>
</span><span id="KnowledgeCoordinator.__init__-37"><a href="#KnowledgeCoordinator.__init__-37"><span class="linenos">37</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator.__init__-38"><a href="#KnowledgeCoordinator.__init__-38"><span class="linenos">38</span></a><span class="sd">        Initialize the Knowledge Coordinator.</span>
</span><span id="KnowledgeCoordinator.__init__-39"><a href="#KnowledgeCoordinator.__init__-39"><span class="linenos">39</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator.__init__-40"><a href="#KnowledgeCoordinator.__init__-40"><span class="linenos">40</span></a><span class="sd">        Args:</span>
</span><span id="KnowledgeCoordinator.__init__-41"><a href="#KnowledgeCoordinator.__init__-41"><span class="linenos">41</span></a><span class="sd">            agno_knowledge: Local semantic knowledge base (SQLite/LanceDB)</span>
</span><span id="KnowledgeCoordinator.__init__-42"><a href="#KnowledgeCoordinator.__init__-42"><span class="linenos">42</span></a><span class="sd">            lightrag_url: URL for LightRAG server</span>
</span><span id="KnowledgeCoordinator.__init__-43"><a href="#KnowledgeCoordinator.__init__-43"><span class="linenos">43</span></a><span class="sd">            debug: Enable debug logging</span>
</span><span id="KnowledgeCoordinator.__init__-44"><a href="#KnowledgeCoordinator.__init__-44"><span class="linenos">44</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator.__init__-45"><a href="#KnowledgeCoordinator.__init__-45"><span class="linenos">45</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agno_knowledge</span> <span class="o">=</span> <span class="n">agno_knowledge</span>
</span><span id="KnowledgeCoordinator.__init__-46"><a href="#KnowledgeCoordinator.__init__-46"><span class="linenos">46</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_url</span> <span class="o">=</span> <span class="n">lightrag_url</span>
</span><span id="KnowledgeCoordinator.__init__-47"><a href="#KnowledgeCoordinator.__init__-47"><span class="linenos">47</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="KnowledgeCoordinator.__init__-48"><a href="#KnowledgeCoordinator.__init__-48"><span class="linenos">48</span></a>        
</span><span id="KnowledgeCoordinator.__init__-49"><a href="#KnowledgeCoordinator.__init__-49"><span class="linenos">49</span></a>        <span class="c1"># Query routing statistics</span>
</span><span id="KnowledgeCoordinator.__init__-50"><a href="#KnowledgeCoordinator.__init__-50"><span class="linenos">50</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="KnowledgeCoordinator.__init__-51"><a href="#KnowledgeCoordinator.__init__-51"><span class="linenos">51</span></a>            <span class="s2">&quot;local_semantic&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.__init__-52"><a href="#KnowledgeCoordinator.__init__-52"><span class="linenos">52</span></a>            <span class="s2">&quot;lightrag&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.__init__-53"><a href="#KnowledgeCoordinator.__init__-53"><span class="linenos">53</span></a>            <span class="s2">&quot;auto_detected_local&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.__init__-54"><a href="#KnowledgeCoordinator.__init__-54"><span class="linenos">54</span></a>            <span class="s2">&quot;auto_detected_lightrag&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.__init__-55"><a href="#KnowledgeCoordinator.__init__-55"><span class="linenos">55</span></a>            <span class="s2">&quot;fallback_used&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="KnowledgeCoordinator.__init__-56"><a href="#KnowledgeCoordinator.__init__-56"><span class="linenos">56</span></a>        <span class="p">}</span>
</span><span id="KnowledgeCoordinator.__init__-57"><a href="#KnowledgeCoordinator.__init__-57"><span class="linenos">57</span></a>        
</span><span id="KnowledgeCoordinator.__init__-58"><a href="#KnowledgeCoordinator.__init__-58"><span class="linenos">58</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Knowledge Coordinator initialized with LightRAG URL: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lightrag_url</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the Knowledge Coordinator.</p>

<p>Args:
    agno_knowledge: Local semantic knowledge base (SQLite/LanceDB)
    lightrag_url: URL for LightRAG server
    debug: Enable debug logging</p>
</div>


                            </div>
                            <div id="KnowledgeCoordinator.agno_knowledge" class="classattr">
                                <div class="attr variable">
            <span class="name">agno_knowledge</span>

        
    </div>
    <a class="headerlink" href="#KnowledgeCoordinator.agno_knowledge"></a>
    
    

                            </div>
                            <div id="KnowledgeCoordinator.lightrag_url" class="classattr">
                                <div class="attr variable">
            <span class="name">lightrag_url</span>

        
    </div>
    <a class="headerlink" href="#KnowledgeCoordinator.lightrag_url"></a>
    
    

                            </div>
                            <div id="KnowledgeCoordinator.debug" class="classattr">
                                <div class="attr variable">
            <span class="name">debug</span>

        
    </div>
    <a class="headerlink" href="#KnowledgeCoordinator.debug"></a>
    
    

                            </div>
                            <div id="KnowledgeCoordinator.routing_stats" class="classattr">
                                <div class="attr variable">
            <span class="name">routing_stats</span>

        
    </div>
    <a class="headerlink" href="#KnowledgeCoordinator.routing_stats"></a>
    
    

                            </div>
                            <div id="KnowledgeCoordinator.query_knowledge_base" class="classattr">
                                        <input id="KnowledgeCoordinator.query_knowledge_base-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">query_knowledge_base</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">query</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>,</span><span class="param">	<span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">response_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Multiple Paragraphs&#39;</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="KnowledgeCoordinator.query_knowledge_base-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#KnowledgeCoordinator.query_knowledge_base"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="KnowledgeCoordinator.query_knowledge_base-279"><a href="#KnowledgeCoordinator.query_knowledge_base-279"><span class="linenos">279</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query_knowledge_base</span><span class="p">(</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-280"><a href="#KnowledgeCoordinator.query_knowledge_base-280"><span class="linenos">280</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-281"><a href="#KnowledgeCoordinator.query_knowledge_base-281"><span class="linenos">281</span></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-282"><a href="#KnowledgeCoordinator.query_knowledge_base-282"><span class="linenos">282</span></a>        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-283"><a href="#KnowledgeCoordinator.query_knowledge_base-283"><span class="linenos">283</span></a>        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-284"><a href="#KnowledgeCoordinator.query_knowledge_base-284"><span class="linenos">284</span></a>        <span class="n">response_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Multiple Paragraphs&quot;</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-285"><a href="#KnowledgeCoordinator.query_knowledge_base-285"><span class="linenos">285</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-286"><a href="#KnowledgeCoordinator.query_knowledge_base-286"><span class="linenos">286</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-287"><a href="#KnowledgeCoordinator.query_knowledge_base-287"><span class="linenos">287</span></a><span class="sd">        Unified knowledge base query with intelligent routing.</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-288"><a href="#KnowledgeCoordinator.query_knowledge_base-288"><span class="linenos">288</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-289"><a href="#KnowledgeCoordinator.query_knowledge_base-289"><span class="linenos">289</span></a><span class="sd">        This is the main entry point for all knowledge queries. It intelligently</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-290"><a href="#KnowledgeCoordinator.query_knowledge_base-290"><span class="linenos">290</span></a><span class="sd">        routes queries between local semantic search and LightRAG based on the</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-291"><a href="#KnowledgeCoordinator.query_knowledge_base-291"><span class="linenos">291</span></a><span class="sd">        mode parameter and query characteristics.</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-292"><a href="#KnowledgeCoordinator.query_knowledge_base-292"><span class="linenos">292</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-293"><a href="#KnowledgeCoordinator.query_knowledge_base-293"><span class="linenos">293</span></a><span class="sd">        Args:</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-294"><a href="#KnowledgeCoordinator.query_knowledge_base-294"><span class="linenos">294</span></a><span class="sd">            query: The search query</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-295"><a href="#KnowledgeCoordinator.query_knowledge_base-295"><span class="linenos">295</span></a><span class="sd">            mode: Routing mode:</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-296"><a href="#KnowledgeCoordinator.query_knowledge_base-296"><span class="linenos">296</span></a><span class="sd">                  - &quot;local&quot;: Force local semantic search</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-297"><a href="#KnowledgeCoordinator.query_knowledge_base-297"><span class="linenos">297</span></a><span class="sd">                  - &quot;global&quot;, &quot;hybrid&quot;, &quot;mix&quot;, &quot;naive&quot;, &quot;bypass&quot;: Use LightRAG</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-298"><a href="#KnowledgeCoordinator.query_knowledge_base-298"><span class="linenos">298</span></a><span class="sd">                  - &quot;auto&quot;: Intelligent auto-detection (default)</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-299"><a href="#KnowledgeCoordinator.query_knowledge_base-299"><span class="linenos">299</span></a><span class="sd">            limit: Maximum results for local search / top_k for LightRAG</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-300"><a href="#KnowledgeCoordinator.query_knowledge_base-300"><span class="linenos">300</span></a><span class="sd">            response_type: Format for LightRAG responses</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-301"><a href="#KnowledgeCoordinator.query_knowledge_base-301"><span class="linenos">301</span></a><span class="sd">            </span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-302"><a href="#KnowledgeCoordinator.query_knowledge_base-302"><span class="linenos">302</span></a><span class="sd">        Returns:</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-303"><a href="#KnowledgeCoordinator.query_knowledge_base-303"><span class="linenos">303</span></a><span class="sd">            Formatted search results from the appropriate knowledge system</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-304"><a href="#KnowledgeCoordinator.query_knowledge_base-304"><span class="linenos">304</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-305"><a href="#KnowledgeCoordinator.query_knowledge_base-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-306"><a href="#KnowledgeCoordinator.query_knowledge_base-306"><span class="linenos">306</span></a>            <span class="k">return</span> <span class="s2">&quot; Error: Query cannot be empty. Please provide a search term.&quot;</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-307"><a href="#KnowledgeCoordinator.query_knowledge_base-307"><span class="linenos">307</span></a>            
</span><span id="KnowledgeCoordinator.query_knowledge_base-308"><a href="#KnowledgeCoordinator.query_knowledge_base-308"><span class="linenos">308</span></a>        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-309"><a href="#KnowledgeCoordinator.query_knowledge_base-309"><span class="linenos">309</span></a>        
</span><span id="KnowledgeCoordinator.query_knowledge_base-310"><a href="#KnowledgeCoordinator.query_knowledge_base-310"><span class="linenos">310</span></a>        <span class="c1"># Determine routing</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-311"><a href="#KnowledgeCoordinator.query_knowledge_base-311"><span class="linenos">311</span></a>        <span class="n">routing_decision</span><span class="p">,</span> <span class="n">reasoning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_routing</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-312"><a href="#KnowledgeCoordinator.query_knowledge_base-312"><span class="linenos">312</span></a>        
</span><span id="KnowledgeCoordinator.query_knowledge_base-313"><a href="#KnowledgeCoordinator.query_knowledge_base-313"><span class="linenos">313</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-314"><a href="#KnowledgeCoordinator.query_knowledge_base-314"><span class="linenos">314</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Knowledge routing: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">routing_decision</span><span class="p">,</span> <span class="n">reasoning</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-315"><a href="#KnowledgeCoordinator.query_knowledge_base-315"><span class="linenos">315</span></a>            
</span><span id="KnowledgeCoordinator.query_knowledge_base-316"><a href="#KnowledgeCoordinator.query_knowledge_base-316"><span class="linenos">316</span></a>        <span class="c1"># Update statistics</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-317"><a href="#KnowledgeCoordinator.query_knowledge_base-317"><span class="linenos">317</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="p">[</span><span class="n">routing_decision</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-318"><a href="#KnowledgeCoordinator.query_knowledge_base-318"><span class="linenos">318</span></a>        
</span><span id="KnowledgeCoordinator.query_knowledge_base-319"><a href="#KnowledgeCoordinator.query_knowledge_base-319"><span class="linenos">319</span></a>        <span class="c1"># Route to appropriate system</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-320"><a href="#KnowledgeCoordinator.query_knowledge_base-320"><span class="linenos">320</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-321"><a href="#KnowledgeCoordinator.query_knowledge_base-321"><span class="linenos">321</span></a>            <span class="k">if</span> <span class="n">routing_decision</span> <span class="o">==</span> <span class="s2">&quot;local_semantic&quot;</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-322"><a href="#KnowledgeCoordinator.query_knowledge_base-322"><span class="linenos">322</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_local_semantic</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-323"><a href="#KnowledgeCoordinator.query_knowledge_base-323"><span class="linenos">323</span></a>                
</span><span id="KnowledgeCoordinator.query_knowledge_base-324"><a href="#KnowledgeCoordinator.query_knowledge_base-324"><span class="linenos">324</span></a>                <span class="c1"># If local search fails and we have LightRAG available, try fallback</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-325"><a href="#KnowledgeCoordinator.query_knowledge_base-325"><span class="linenos">325</span></a>                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_url</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-326"><a href="#KnowledgeCoordinator.query_knowledge_base-326"><span class="linenos">326</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Local search failed, attempting LightRAG fallback&quot;</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-327"><a href="#KnowledgeCoordinator.query_knowledge_base-327"><span class="linenos">327</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="p">[</span><span class="s2">&quot;fallback_used&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-328"><a href="#KnowledgeCoordinator.query_knowledge_base-328"><span class="linenos">328</span></a>                    <span class="n">fallback_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_lightrag</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">response_type</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-329"><a href="#KnowledgeCoordinator.query_knowledge_base-329"><span class="linenos">329</span></a>                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">**Fallback to LightRAG:**</span><span class="se">\n</span><span class="si">{</span><span class="n">fallback_result</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-330"><a href="#KnowledgeCoordinator.query_knowledge_base-330"><span class="linenos">330</span></a>                    
</span><span id="KnowledgeCoordinator.query_knowledge_base-331"><a href="#KnowledgeCoordinator.query_knowledge_base-331"><span class="linenos">331</span></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-332"><a href="#KnowledgeCoordinator.query_knowledge_base-332"><span class="linenos">332</span></a>                
</span><span id="KnowledgeCoordinator.query_knowledge_base-333"><a href="#KnowledgeCoordinator.query_knowledge_base-333"><span class="linenos">333</span></a>            <span class="k">elif</span> <span class="n">routing_decision</span> <span class="o">==</span> <span class="s2">&quot;lightrag&quot;</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-334"><a href="#KnowledgeCoordinator.query_knowledge_base-334"><span class="linenos">334</span></a>                <span class="c1"># For LightRAG, use the original mode if it was explicitly specified</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-335"><a href="#KnowledgeCoordinator.query_knowledge_base-335"><span class="linenos">335</span></a>                <span class="n">lightrag_mode</span> <span class="o">=</span> <span class="n">mode</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">,</span> <span class="s2">&quot;mix&quot;</span><span class="p">,</span> <span class="s2">&quot;naive&quot;</span><span class="p">,</span> <span class="s2">&quot;bypass&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;hybrid&quot;</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-336"><a href="#KnowledgeCoordinator.query_knowledge_base-336"><span class="linenos">336</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_lightrag</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">lightrag_mode</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">response_type</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-337"><a href="#KnowledgeCoordinator.query_knowledge_base-337"><span class="linenos">337</span></a>                
</span><span id="KnowledgeCoordinator.query_knowledge_base-338"><a href="#KnowledgeCoordinator.query_knowledge_base-338"><span class="linenos">338</span></a>                <span class="c1"># If LightRAG fails and we have local knowledge, try fallback</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-339"><a href="#KnowledgeCoordinator.query_knowledge_base-339"><span class="linenos">339</span></a>                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agno_knowledge</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-340"><a href="#KnowledgeCoordinator.query_knowledge_base-340"><span class="linenos">340</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LightRAG failed, attempting local semantic fallback&quot;</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-341"><a href="#KnowledgeCoordinator.query_knowledge_base-341"><span class="linenos">341</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="p">[</span><span class="s2">&quot;fallback_used&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-342"><a href="#KnowledgeCoordinator.query_knowledge_base-342"><span class="linenos">342</span></a>                    <span class="n">fallback_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_local_semantic</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-343"><a href="#KnowledgeCoordinator.query_knowledge_base-343"><span class="linenos">343</span></a>                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">**Fallback to Local Search:**</span><span class="se">\n</span><span class="si">{</span><span class="n">fallback_result</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-344"><a href="#KnowledgeCoordinator.query_knowledge_base-344"><span class="linenos">344</span></a>                    
</span><span id="KnowledgeCoordinator.query_knowledge_base-345"><a href="#KnowledgeCoordinator.query_knowledge_base-345"><span class="linenos">345</span></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-346"><a href="#KnowledgeCoordinator.query_knowledge_base-346"><span class="linenos">346</span></a>                
</span><span id="KnowledgeCoordinator.query_knowledge_base-347"><a href="#KnowledgeCoordinator.query_knowledge_base-347"><span class="linenos">347</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-348"><a href="#KnowledgeCoordinator.query_knowledge_base-348"><span class="linenos">348</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Unknown routing decision: </span><span class="si">{</span><span class="n">routing_decision</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-349"><a href="#KnowledgeCoordinator.query_knowledge_base-349"><span class="linenos">349</span></a>                
</span><span id="KnowledgeCoordinator.query_knowledge_base-350"><a href="#KnowledgeCoordinator.query_knowledge_base-350"><span class="linenos">350</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-351"><a href="#KnowledgeCoordinator.query_knowledge_base-351"><span class="linenos">351</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in knowledge coordinator: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="KnowledgeCoordinator.query_knowledge_base-352"><a href="#KnowledgeCoordinator.query_knowledge_base-352"><span class="linenos">352</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; Error processing knowledge query: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Unified knowledge base query with intelligent routing.</p>

<p>This is the main entry point for all knowledge queries. It intelligently
routes queries between local semantic search and LightRAG based on the
mode parameter and query characteristics.</p>

<p>Args:
    query: The search query
    mode: Routing mode:
          - "local": Force local semantic search
          - "global", "hybrid", "mix", "naive", "bypass": Use LightRAG
          - "auto": Intelligent auto-detection (default)
    limit: Maximum results for local search / top_k for LightRAG
    response_type: Format for LightRAG responses</p>

<p>Returns:
    Formatted search results from the appropriate knowledge system</p>
</div>


                            </div>
                            <div id="KnowledgeCoordinator.get_routing_stats" class="classattr">
                                        <input id="KnowledgeCoordinator.get_routing_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_routing_stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="KnowledgeCoordinator.get_routing_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#KnowledgeCoordinator.get_routing_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="KnowledgeCoordinator.get_routing_stats-354"><a href="#KnowledgeCoordinator.get_routing_stats-354"><span class="linenos">354</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_routing_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-355"><a href="#KnowledgeCoordinator.get_routing_stats-355"><span class="linenos">355</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-356"><a href="#KnowledgeCoordinator.get_routing_stats-356"><span class="linenos">356</span></a><span class="sd">        Get statistics about query routing decisions.</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-357"><a href="#KnowledgeCoordinator.get_routing_stats-357"><span class="linenos">357</span></a><span class="sd">        </span>
</span><span id="KnowledgeCoordinator.get_routing_stats-358"><a href="#KnowledgeCoordinator.get_routing_stats-358"><span class="linenos">358</span></a><span class="sd">        Returns:</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-359"><a href="#KnowledgeCoordinator.get_routing_stats-359"><span class="linenos">359</span></a><span class="sd">            Dictionary with routing statistics</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-360"><a href="#KnowledgeCoordinator.get_routing_stats-360"><span class="linenos">360</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-361"><a href="#KnowledgeCoordinator.get_routing_stats-361"><span class="linenos">361</span></a>        <span class="n">total_queries</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-362"><a href="#KnowledgeCoordinator.get_routing_stats-362"><span class="linenos">362</span></a>        
</span><span id="KnowledgeCoordinator.get_routing_stats-363"><a href="#KnowledgeCoordinator.get_routing_stats-363"><span class="linenos">363</span></a>        <span class="k">if</span> <span class="n">total_queries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-364"><a href="#KnowledgeCoordinator.get_routing_stats-364"><span class="linenos">364</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total_queries&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No queries processed yet&quot;</span><span class="p">}</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-365"><a href="#KnowledgeCoordinator.get_routing_stats-365"><span class="linenos">365</span></a>            
</span><span id="KnowledgeCoordinator.get_routing_stats-366"><a href="#KnowledgeCoordinator.get_routing_stats-366"><span class="linenos">366</span></a>        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-367"><a href="#KnowledgeCoordinator.get_routing_stats-367"><span class="linenos">367</span></a>        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_queries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_queries</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-368"><a href="#KnowledgeCoordinator.get_routing_stats-368"><span class="linenos">368</span></a>        
</span><span id="KnowledgeCoordinator.get_routing_stats-369"><a href="#KnowledgeCoordinator.get_routing_stats-369"><span class="linenos">369</span></a>        <span class="c1"># Add percentages</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-370"><a href="#KnowledgeCoordinator.get_routing_stats-370"><span class="linenos">370</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-371"><a href="#KnowledgeCoordinator.get_routing_stats-371"><span class="linenos">371</span></a>            <span class="n">stats</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_percentage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">total_queries</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="KnowledgeCoordinator.get_routing_stats-372"><a href="#KnowledgeCoordinator.get_routing_stats-372"><span class="linenos">372</span></a>            
</span><span id="KnowledgeCoordinator.get_routing_stats-373"><a href="#KnowledgeCoordinator.get_routing_stats-373"><span class="linenos">373</span></a>        <span class="k">return</span> <span class="n">stats</span>
</span></pre></div>


            <div class="docstring"><p>Get statistics about query routing decisions.</p>

<p>Returns:
    Dictionary with routing statistics</p>
</div>


                            </div>
                            <div id="KnowledgeCoordinator.reset_stats" class="classattr">
                                        <input id="KnowledgeCoordinator.reset_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reset_stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="KnowledgeCoordinator.reset_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#KnowledgeCoordinator.reset_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="KnowledgeCoordinator.reset_stats-375"><a href="#KnowledgeCoordinator.reset_stats-375"><span class="linenos">375</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="KnowledgeCoordinator.reset_stats-376"><a href="#KnowledgeCoordinator.reset_stats-376"><span class="linenos">376</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset routing statistics.&quot;&quot;&quot;</span>
</span><span id="KnowledgeCoordinator.reset_stats-377"><a href="#KnowledgeCoordinator.reset_stats-377"><span class="linenos">377</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">routing_stats</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="KnowledgeCoordinator.reset_stats-378"><a href="#KnowledgeCoordinator.reset_stats-378"><span class="linenos">378</span></a>            <span class="s2">&quot;local_semantic&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.reset_stats-379"><a href="#KnowledgeCoordinator.reset_stats-379"><span class="linenos">379</span></a>            <span class="s2">&quot;lightrag&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.reset_stats-380"><a href="#KnowledgeCoordinator.reset_stats-380"><span class="linenos">380</span></a>            <span class="s2">&quot;auto_detected_local&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.reset_stats-381"><a href="#KnowledgeCoordinator.reset_stats-381"><span class="linenos">381</span></a>            <span class="s2">&quot;auto_detected_lightrag&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="KnowledgeCoordinator.reset_stats-382"><a href="#KnowledgeCoordinator.reset_stats-382"><span class="linenos">382</span></a>            <span class="s2">&quot;fallback_used&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="KnowledgeCoordinator.reset_stats-383"><a href="#KnowledgeCoordinator.reset_stats-383"><span class="linenos">383</span></a>        <span class="p">}</span>
</span><span id="KnowledgeCoordinator.reset_stats-384"><a href="#KnowledgeCoordinator.reset_stats-384"><span class="linenos">384</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Knowledge coordinator statistics reset&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reset routing statistics.</p>
</div>


                            </div>
                </section>
                <section id="create_knowledge_coordinator">
                            <input id="create_knowledge_coordinator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_knowledge_coordinator</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">agno_knowledge</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">lightrag_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:9621&#39;</span>,</span><span class="param">	<span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n"><a href="#KnowledgeCoordinator">KnowledgeCoordinator</a></span>:</span></span>

                <label class="view-source-button" for="create_knowledge_coordinator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_knowledge_coordinator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_knowledge_coordinator-388"><a href="#create_knowledge_coordinator-388"><span class="linenos">388</span></a><span class="k">def</span><span class="w"> </span><span class="nf">create_knowledge_coordinator</span><span class="p">(</span>
</span><span id="create_knowledge_coordinator-389"><a href="#create_knowledge_coordinator-389"><span class="linenos">389</span></a>    <span class="n">agno_knowledge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="create_knowledge_coordinator-390"><a href="#create_knowledge_coordinator-390"><span class="linenos">390</span></a>    <span class="n">lightrag_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">LIGHTRAG_URL</span><span class="p">,</span>
</span><span id="create_knowledge_coordinator-391"><a href="#create_knowledge_coordinator-391"><span class="linenos">391</span></a>    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="create_knowledge_coordinator-392"><a href="#create_knowledge_coordinator-392"><span class="linenos">392</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KnowledgeCoordinator</span><span class="p">:</span>
</span><span id="create_knowledge_coordinator-393"><a href="#create_knowledge_coordinator-393"><span class="linenos">393</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="create_knowledge_coordinator-394"><a href="#create_knowledge_coordinator-394"><span class="linenos">394</span></a><span class="sd">    Create a Knowledge Coordinator instance.</span>
</span><span id="create_knowledge_coordinator-395"><a href="#create_knowledge_coordinator-395"><span class="linenos">395</span></a><span class="sd">    </span>
</span><span id="create_knowledge_coordinator-396"><a href="#create_knowledge_coordinator-396"><span class="linenos">396</span></a><span class="sd">    Args:</span>
</span><span id="create_knowledge_coordinator-397"><a href="#create_knowledge_coordinator-397"><span class="linenos">397</span></a><span class="sd">        agno_knowledge: Local semantic knowledge base</span>
</span><span id="create_knowledge_coordinator-398"><a href="#create_knowledge_coordinator-398"><span class="linenos">398</span></a><span class="sd">        lightrag_url: URL for LightRAG server</span>
</span><span id="create_knowledge_coordinator-399"><a href="#create_knowledge_coordinator-399"><span class="linenos">399</span></a><span class="sd">        debug: Enable debug logging</span>
</span><span id="create_knowledge_coordinator-400"><a href="#create_knowledge_coordinator-400"><span class="linenos">400</span></a><span class="sd">        </span>
</span><span id="create_knowledge_coordinator-401"><a href="#create_knowledge_coordinator-401"><span class="linenos">401</span></a><span class="sd">    Returns:</span>
</span><span id="create_knowledge_coordinator-402"><a href="#create_knowledge_coordinator-402"><span class="linenos">402</span></a><span class="sd">        Configured KnowledgeCoordinator instance</span>
</span><span id="create_knowledge_coordinator-403"><a href="#create_knowledge_coordinator-403"><span class="linenos">403</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="create_knowledge_coordinator-404"><a href="#create_knowledge_coordinator-404"><span class="linenos">404</span></a>    <span class="k">return</span> <span class="n">KnowledgeCoordinator</span><span class="p">(</span>
</span><span id="create_knowledge_coordinator-405"><a href="#create_knowledge_coordinator-405"><span class="linenos">405</span></a>        <span class="n">agno_knowledge</span><span class="o">=</span><span class="n">agno_knowledge</span><span class="p">,</span>
</span><span id="create_knowledge_coordinator-406"><a href="#create_knowledge_coordinator-406"><span class="linenos">406</span></a>        <span class="n">lightrag_url</span><span class="o">=</span><span class="n">lightrag_url</span><span class="p">,</span>
</span><span id="create_knowledge_coordinator-407"><a href="#create_knowledge_coordinator-407"><span class="linenos">407</span></a>        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
</span><span id="create_knowledge_coordinator-408"><a href="#create_knowledge_coordinator-408"><span class="linenos">408</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a Knowledge Coordinator instance.</p>

<p>Args:
    agno_knowledge: Local semantic knowledge base
    lightrag_url: URL for LightRAG server
    debug: Enable debug logging</p>

<p>Returns:
    Configured KnowledgeCoordinator instance</p>
</div>


                </section>
                <section id="extract_entities">
                            <input id="extract_entities-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">extract_entities</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">text</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="extract_entities-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#extract_entities"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="extract_entities-59"><a href="#extract_entities-59"><span class="linenos">59</span></a><span class="k">def</span><span class="w"> </span><span class="nf">extract_entities</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span id="extract_entities-60"><a href="#extract_entities-60"><span class="linenos">60</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="extract_entities-61"><a href="#extract_entities-61"><span class="linenos">61</span></a><span class="sd">    Extracts meaningful named entities from text using spaCy with filtering.</span>
</span><span id="extract_entities-62"><a href="#extract_entities-62"><span class="linenos">62</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="extract_entities-63"><a href="#extract_entities-63"><span class="linenos">63</span></a>    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="extract_entities-64"><a href="#extract_entities-64"><span class="linenos">64</span></a>    <span class="n">entities</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="extract_entities-65"><a href="#extract_entities-65"><span class="linenos">65</span></a>    <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">ents</span><span class="p">:</span>
</span><span id="extract_entities-66"><a href="#extract_entities-66"><span class="linenos">66</span></a>        <span class="k">if</span> <span class="n">is_meaningful_entity</span><span class="p">(</span><span class="n">ent</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span><span class="p">):</span>
</span><span id="extract_entities-67"><a href="#extract_entities-67"><span class="linenos">67</span></a>            <span class="n">entities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">ent</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span><span class="p">})</span>
</span><span id="extract_entities-68"><a href="#extract_entities-68"><span class="linenos">68</span></a>    <span class="k">return</span> <span class="n">entities</span>
</span></pre></div>


            <div class="docstring"><p>Extracts meaningful named entities from text using spaCy with filtering.</p>
</div>


                </section>
                <section id="extract_relationships">
                            <input id="extract_relationships-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">extract_relationships</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">text</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="extract_relationships-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#extract_relationships"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="extract_relationships-103"><a href="#extract_relationships-103"><span class="linenos">103</span></a><span class="k">def</span><span class="w"> </span><span class="nf">extract_relationships</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span id="extract_relationships-104"><a href="#extract_relationships-104"><span class="linenos">104</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="extract_relationships-105"><a href="#extract_relationships-105"><span class="linenos">105</span></a><span class="sd">    Extracts meaningful subject-verb-object relationships from text using spaCy&#39;s dependency parser.</span>
</span><span id="extract_relationships-106"><a href="#extract_relationships-106"><span class="linenos">106</span></a><span class="sd">    This version includes improved coreference resolution, entity linking, and relationship filtering.</span>
</span><span id="extract_relationships-107"><a href="#extract_relationships-107"><span class="linenos">107</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="extract_relationships-108"><a href="#extract_relationships-108"><span class="linenos">108</span></a>    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="extract_relationships-109"><a href="#extract_relationships-109"><span class="linenos">109</span></a>    <span class="n">relationships</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="extract_relationships-110"><a href="#extract_relationships-110"><span class="linenos">110</span></a>    
</span><span id="extract_relationships-111"><a href="#extract_relationships-111"><span class="linenos">111</span></a>    <span class="c1"># Get meaningful entities to help with linking</span>
</span><span id="extract_relationships-112"><a href="#extract_relationships-112"><span class="linenos">112</span></a>    <span class="n">meaningful_entities</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="extract_relationships-113"><a href="#extract_relationships-113"><span class="linenos">113</span></a>    <span class="n">entity_texts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="extract_relationships-114"><a href="#extract_relationships-114"><span class="linenos">114</span></a>    <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">ents</span><span class="p">:</span>
</span><span id="extract_relationships-115"><a href="#extract_relationships-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="n">is_meaningful_entity</span><span class="p">(</span><span class="n">ent</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span><span class="p">):</span>
</span><span id="extract_relationships-116"><a href="#extract_relationships-116"><span class="linenos">116</span></a>            <span class="n">meaningful_entities</span><span class="p">[</span><span class="n">ent</span><span class="o">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span>
</span><span id="extract_relationships-117"><a href="#extract_relationships-117"><span class="linenos">117</span></a>            <span class="n">entity_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ent</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="extract_relationships-118"><a href="#extract_relationships-118"><span class="linenos">118</span></a>    
</span><span id="extract_relationships-119"><a href="#extract_relationships-119"><span class="linenos">119</span></a>    <span class="c1"># Simple coreference resolution</span>
</span><span id="extract_relationships-120"><a href="#extract_relationships-120"><span class="linenos">120</span></a>    <span class="n">last_person</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="extract_relationships-121"><a href="#extract_relationships-121"><span class="linenos">121</span></a>    <span class="k">for</span> <span class="n">ent_text</span><span class="p">,</span> <span class="n">ent_label</span> <span class="ow">in</span> <span class="n">meaningful_entities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="extract_relationships-122"><a href="#extract_relationships-122"><span class="linenos">122</span></a>        <span class="k">if</span> <span class="n">ent_label</span> <span class="o">==</span> <span class="s2">&quot;PERSON&quot;</span><span class="p">:</span>
</span><span id="extract_relationships-123"><a href="#extract_relationships-123"><span class="linenos">123</span></a>            <span class="n">last_person</span> <span class="o">=</span> <span class="n">ent_text</span>
</span><span id="extract_relationships-124"><a href="#extract_relationships-124"><span class="linenos">124</span></a>
</span><span id="extract_relationships-125"><a href="#extract_relationships-125"><span class="linenos">125</span></a>    <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">sents</span><span class="p">:</span>
</span><span id="extract_relationships-126"><a href="#extract_relationships-126"><span class="linenos">126</span></a>        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sent</span><span class="p">:</span>
</span><span id="extract_relationships-127"><a href="#extract_relationships-127"><span class="linenos">127</span></a>            <span class="c1"># Find verbs that are likely to form relationships</span>
</span><span id="extract_relationships-128"><a href="#extract_relationships-128"><span class="linenos">128</span></a>            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">pos_</span> <span class="o">==</span> <span class="s2">&quot;VERB&quot;</span><span class="p">:</span>
</span><span id="extract_relationships-129"><a href="#extract_relationships-129"><span class="linenos">129</span></a>                <span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span> <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">dep_</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nsubj&quot;</span><span class="p">,</span> <span class="s2">&quot;nsubjpass&quot;</span><span class="p">)]</span>
</span><span id="extract_relationships-130"><a href="#extract_relationships-130"><span class="linenos">130</span></a>                <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span> <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">dep_</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dobj&quot;</span><span class="p">,</span> <span class="s2">&quot;attr&quot;</span><span class="p">,</span> <span class="s2">&quot;pobj&quot;</span><span class="p">)]</span>
</span><span id="extract_relationships-131"><a href="#extract_relationships-131"><span class="linenos">131</span></a>                
</span><span id="extract_relationships-132"><a href="#extract_relationships-132"><span class="linenos">132</span></a>                <span class="c1"># Also look for prepositional objects for &quot;works at&quot;, &quot;lives in&quot; patterns</span>
</span><span id="extract_relationships-133"><a href="#extract_relationships-133"><span class="linenos">133</span></a>                <span class="n">prep_objects</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="extract_relationships-134"><a href="#extract_relationships-134"><span class="linenos">134</span></a>                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
</span><span id="extract_relationships-135"><a href="#extract_relationships-135"><span class="linenos">135</span></a>                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">dep_</span> <span class="o">==</span> <span class="s2">&quot;prep&quot;</span><span class="p">:</span>
</span><span id="extract_relationships-136"><a href="#extract_relationships-136"><span class="linenos">136</span></a>                        <span class="k">for</span> <span class="n">grandchild</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
</span><span id="extract_relationships-137"><a href="#extract_relationships-137"><span class="linenos">137</span></a>                            <span class="k">if</span> <span class="n">grandchild</span><span class="o">.</span><span class="n">dep_</span> <span class="o">==</span> <span class="s2">&quot;pobj&quot;</span><span class="p">:</span>
</span><span id="extract_relationships-138"><a href="#extract_relationships-138"><span class="linenos">138</span></a>                                <span class="n">prep_objects</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">grandchild</span><span class="p">))</span>
</span><span id="extract_relationships-139"><a href="#extract_relationships-139"><span class="linenos">139</span></a>                
</span><span id="extract_relationships-140"><a href="#extract_relationships-140"><span class="linenos">140</span></a>                <span class="k">if</span> <span class="n">subjects</span> <span class="ow">and</span> <span class="p">(</span><span class="n">objects</span> <span class="ow">or</span> <span class="n">prep_objects</span><span class="p">):</span>
</span><span id="extract_relationships-141"><a href="#extract_relationships-141"><span class="linenos">141</span></a>                    <span class="n">subject</span> <span class="o">=</span> <span class="n">subjects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="extract_relationships-142"><a href="#extract_relationships-142"><span class="linenos">142</span></a>                    
</span><span id="extract_relationships-143"><a href="#extract_relationships-143"><span class="linenos">143</span></a>                    <span class="n">subject_text</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">text</span>
</span><span id="extract_relationships-144"><a href="#extract_relationships-144"><span class="linenos">144</span></a>                    <span class="c1"># Resolve pronouns</span>
</span><span id="extract_relationships-145"><a href="#extract_relationships-145"><span class="linenos">145</span></a>                    <span class="k">if</span> <span class="n">subject</span><span class="o">.</span><span class="n">pos_</span> <span class="o">==</span> <span class="s2">&quot;PRON&quot;</span> <span class="ow">and</span> <span class="n">last_person</span><span class="p">:</span>
</span><span id="extract_relationships-146"><a href="#extract_relationships-146"><span class="linenos">146</span></a>                        <span class="n">subject_text</span> <span class="o">=</span> <span class="n">last_person</span>
</span><span id="extract_relationships-147"><a href="#extract_relationships-147"><span class="linenos">147</span></a>                    
</span><span id="extract_relationships-148"><a href="#extract_relationships-148"><span class="linenos">148</span></a>                    <span class="c1"># Use the full entity text if available</span>
</span><span id="extract_relationships-149"><a href="#extract_relationships-149"><span class="linenos">149</span></a>                    <span class="k">for</span> <span class="n">ent_text</span> <span class="ow">in</span> <span class="n">entity_texts</span><span class="p">:</span>
</span><span id="extract_relationships-150"><a href="#extract_relationships-150"><span class="linenos">150</span></a>                        <span class="k">if</span> <span class="n">subject</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ent_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ent_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">subject</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="extract_relationships-151"><a href="#extract_relationships-151"><span class="linenos">151</span></a>                            <span class="n">subject_text</span> <span class="o">=</span> <span class="n">ent_text</span>
</span><span id="extract_relationships-152"><a href="#extract_relationships-152"><span class="linenos">152</span></a>                            <span class="k">break</span>
</span><span id="extract_relationships-153"><a href="#extract_relationships-153"><span class="linenos">153</span></a>                    
</span><span id="extract_relationships-154"><a href="#extract_relationships-154"><span class="linenos">154</span></a>                    <span class="c1"># Handle direct objects</span>
</span><span id="extract_relationships-155"><a href="#extract_relationships-155"><span class="linenos">155</span></a>                    <span class="k">if</span> <span class="n">objects</span><span class="p">:</span>
</span><span id="extract_relationships-156"><a href="#extract_relationships-156"><span class="linenos">156</span></a>                        <span class="n">obj</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="extract_relationships-157"><a href="#extract_relationships-157"><span class="linenos">157</span></a>                        <span class="n">object_text</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">text</span>
</span><span id="extract_relationships-158"><a href="#extract_relationships-158"><span class="linenos">158</span></a>                        <span class="k">for</span> <span class="n">ent_text</span> <span class="ow">in</span> <span class="n">entity_texts</span><span class="p">:</span>
</span><span id="extract_relationships-159"><a href="#extract_relationships-159"><span class="linenos">159</span></a>                            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ent_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ent_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="extract_relationships-160"><a href="#extract_relationships-160"><span class="linenos">160</span></a>                                <span class="n">object_text</span> <span class="o">=</span> <span class="n">ent_text</span>
</span><span id="extract_relationships-161"><a href="#extract_relationships-161"><span class="linenos">161</span></a>                                <span class="k">break</span>
</span><span id="extract_relationships-162"><a href="#extract_relationships-162"><span class="linenos">162</span></a>                        
</span><span id="extract_relationships-163"><a href="#extract_relationships-163"><span class="linenos">163</span></a>                        <span class="n">relation_text</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">lemma_</span>
</span><span id="extract_relationships-164"><a href="#extract_relationships-164"><span class="linenos">164</span></a>                        
</span><span id="extract_relationships-165"><a href="#extract_relationships-165"><span class="linenos">165</span></a>                        <span class="c1"># Only add meaningful relationships</span>
</span><span id="extract_relationships-166"><a href="#extract_relationships-166"><span class="linenos">166</span></a>                        <span class="k">if</span> <span class="n">is_meaningful_relationship</span><span class="p">(</span><span class="n">subject_text</span><span class="p">,</span> <span class="n">relation_text</span><span class="p">,</span> <span class="n">object_text</span><span class="p">):</span>
</span><span id="extract_relationships-167"><a href="#extract_relationships-167"><span class="linenos">167</span></a>                            <span class="n">relationships</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">subject_text</span><span class="p">,</span> <span class="n">relation_text</span><span class="p">,</span> <span class="n">object_text</span><span class="p">))</span>
</span><span id="extract_relationships-168"><a href="#extract_relationships-168"><span class="linenos">168</span></a>                    
</span><span id="extract_relationships-169"><a href="#extract_relationships-169"><span class="linenos">169</span></a>                    <span class="c1"># Handle prepositional objects (e.g., &quot;works at Google&quot;, &quot;lives in Mountain View&quot;)</span>
</span><span id="extract_relationships-170"><a href="#extract_relationships-170"><span class="linenos">170</span></a>                    <span class="k">for</span> <span class="n">prep</span><span class="p">,</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="n">prep_objects</span><span class="p">:</span>
</span><span id="extract_relationships-171"><a href="#extract_relationships-171"><span class="linenos">171</span></a>                        <span class="n">object_text</span> <span class="o">=</span> <span class="n">pobj</span><span class="o">.</span><span class="n">text</span>
</span><span id="extract_relationships-172"><a href="#extract_relationships-172"><span class="linenos">172</span></a>                        <span class="k">for</span> <span class="n">ent_text</span> <span class="ow">in</span> <span class="n">entity_texts</span><span class="p">:</span>
</span><span id="extract_relationships-173"><a href="#extract_relationships-173"><span class="linenos">173</span></a>                            <span class="k">if</span> <span class="n">pobj</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ent_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ent_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">pobj</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="extract_relationships-174"><a href="#extract_relationships-174"><span class="linenos">174</span></a>                                <span class="n">object_text</span> <span class="o">=</span> <span class="n">ent_text</span>
</span><span id="extract_relationships-175"><a href="#extract_relationships-175"><span class="linenos">175</span></a>                                <span class="k">break</span>
</span><span id="extract_relationships-176"><a href="#extract_relationships-176"><span class="linenos">176</span></a>                        
</span><span id="extract_relationships-177"><a href="#extract_relationships-177"><span class="linenos">177</span></a>                        <span class="n">relation_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token</span><span class="o">.</span><span class="n">lemma_</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">prep</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="extract_relationships-178"><a href="#extract_relationships-178"><span class="linenos">178</span></a>                        
</span><span id="extract_relationships-179"><a href="#extract_relationships-179"><span class="linenos">179</span></a>                        <span class="c1"># Only add meaningful relationships</span>
</span><span id="extract_relationships-180"><a href="#extract_relationships-180"><span class="linenos">180</span></a>                        <span class="k">if</span> <span class="n">is_meaningful_relationship</span><span class="p">(</span><span class="n">subject_text</span><span class="p">,</span> <span class="n">relation_text</span><span class="p">,</span> <span class="n">object_text</span><span class="p">):</span>
</span><span id="extract_relationships-181"><a href="#extract_relationships-181"><span class="linenos">181</span></a>                            <span class="n">relationships</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">subject_text</span><span class="p">,</span> <span class="n">relation_text</span><span class="p">,</span> <span class="n">object_text</span><span class="p">))</span>
</span><span id="extract_relationships-182"><a href="#extract_relationships-182"><span class="linenos">182</span></a>                    
</span><span id="extract_relationships-183"><a href="#extract_relationships-183"><span class="linenos">183</span></a>                    <span class="c1"># Update last seen person for coreference</span>
</span><span id="extract_relationships-184"><a href="#extract_relationships-184"><span class="linenos">184</span></a>                    <span class="k">if</span> <span class="n">subject</span><span class="o">.</span><span class="n">text</span> <span class="ow">in</span> <span class="n">meaningful_entities</span> <span class="ow">and</span> <span class="n">meaningful_entities</span><span class="p">[</span><span class="n">subject</span><span class="o">.</span><span class="n">text</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PERSON&quot;</span><span class="p">:</span>
</span><span id="extract_relationships-185"><a href="#extract_relationships-185"><span class="linenos">185</span></a>                        <span class="n">last_person</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">text</span>
</span><span id="extract_relationships-186"><a href="#extract_relationships-186"><span class="linenos">186</span></a>
</span><span id="extract_relationships-187"><a href="#extract_relationships-187"><span class="linenos">187</span></a>    <span class="k">return</span> <span class="n">relationships</span>
</span></pre></div>


            <div class="docstring"><p>Extracts meaningful subject-verb-object relationships from text using spaCy's dependency parser.
This version includes improved coreference resolution, entity linking, and relationship filtering.</p>
</div>


                </section>
                <section id="StructuredResponse">
                            <input id="StructuredResponse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">StructuredResponse</span>:

                <label class="view-source-button" for="StructuredResponse-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StructuredResponse"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StructuredResponse-42"><a href="#StructuredResponse-42"><span class="linenos">42</span></a><span class="nd">@dataclass</span>
</span><span id="StructuredResponse-43"><a href="#StructuredResponse-43"><span class="linenos">43</span></a><span class="k">class</span><span class="w"> </span><span class="nc">StructuredResponse</span><span class="p">:</span>
</span><span id="StructuredResponse-44"><a href="#StructuredResponse-44"><span class="linenos">44</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Complete structured response from the agent.&quot;&quot;&quot;</span>
</span><span id="StructuredResponse-45"><a href="#StructuredResponse-45"><span class="linenos">45</span></a>    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="StructuredResponse-46"><a href="#StructuredResponse-46"><span class="linenos">46</span></a>    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="StructuredResponse-47"><a href="#StructuredResponse-47"><span class="linenos">47</span></a>    <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ResponseMetadata</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StructuredResponse-48"><a href="#StructuredResponse-48"><span class="linenos">48</span></a>    <span class="n">error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ResponseError</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StructuredResponse-49"><a href="#StructuredResponse-49"><span class="linenos">49</span></a>    
</span><span id="StructuredResponse-50"><a href="#StructuredResponse-50"><span class="linenos">50</span></a>    <span class="nd">@property</span>
</span><span id="StructuredResponse-51"><a href="#StructuredResponse-51"><span class="linenos">51</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">has_tool_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="StructuredResponse-52"><a href="#StructuredResponse-52"><span class="linenos">52</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if response contains tool calls.&quot;&quot;&quot;</span>
</span><span id="StructuredResponse-53"><a href="#StructuredResponse-53"><span class="linenos">53</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="StructuredResponse-54"><a href="#StructuredResponse-54"><span class="linenos">54</span></a>    
</span><span id="StructuredResponse-55"><a href="#StructuredResponse-55"><span class="linenos">55</span></a>    <span class="nd">@property</span>
</span><span id="StructuredResponse-56"><a href="#StructuredResponse-56"><span class="linenos">56</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tool_calls_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="StructuredResponse-57"><a href="#StructuredResponse-57"><span class="linenos">57</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get number of tool calls.&quot;&quot;&quot;</span>
</span><span id="StructuredResponse-58"><a href="#StructuredResponse-58"><span class="linenos">58</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Complete structured response from the agent.</p>
</div>


                            <div id="StructuredResponse.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">StructuredResponse</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">content</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="#ToolCall">ToolCall</a></span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="#ResponseMetadata">ResponseMetadata</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="#ResponseError">ResponseError</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#StructuredResponse.__init__"></a>
    
    

                            </div>
                            <div id="StructuredResponse.content" class="classattr">
                                <div class="attr variable">
            <span class="name">content</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#StructuredResponse.content"></a>
    
    

                            </div>
                            <div id="StructuredResponse.tool_calls" class="classattr">
                                <div class="attr variable">
            <span class="name">tool_calls</span><span class="annotation">: List[<a href="#ToolCall">ToolCall</a>]</span>

        
    </div>
    <a class="headerlink" href="#StructuredResponse.tool_calls"></a>
    
    

                            </div>
                            <div id="StructuredResponse.metadata" class="classattr">
                                <div class="attr variable">
            <span class="name">metadata</span><span class="annotation">: Optional[<a href="#ResponseMetadata">ResponseMetadata</a>]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#StructuredResponse.metadata"></a>
    
    

                            </div>
                            <div id="StructuredResponse.error" class="classattr">
                                <div class="attr variable">
            <span class="name">error</span><span class="annotation">: Optional[<a href="#ResponseError">ResponseError</a>]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#StructuredResponse.error"></a>
    
    

                            </div>
                            <div id="StructuredResponse.has_tool_calls" class="classattr">
                                        <input id="StructuredResponse.has_tool_calls-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">has_tool_calls</span><span class="annotation">: bool</span>

                <label class="view-source-button" for="StructuredResponse.has_tool_calls-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StructuredResponse.has_tool_calls"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StructuredResponse.has_tool_calls-50"><a href="#StructuredResponse.has_tool_calls-50"><span class="linenos">50</span></a>    <span class="nd">@property</span>
</span><span id="StructuredResponse.has_tool_calls-51"><a href="#StructuredResponse.has_tool_calls-51"><span class="linenos">51</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">has_tool_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="StructuredResponse.has_tool_calls-52"><a href="#StructuredResponse.has_tool_calls-52"><span class="linenos">52</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if response contains tool calls.&quot;&quot;&quot;</span>
</span><span id="StructuredResponse.has_tool_calls-53"><a href="#StructuredResponse.has_tool_calls-53"><span class="linenos">53</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></pre></div>


            <div class="docstring"><p>Check if response contains tool calls.</p>
</div>


                            </div>
                            <div id="StructuredResponse.tool_calls_count" class="classattr">
                                        <input id="StructuredResponse.tool_calls_count-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">tool_calls_count</span><span class="annotation">: int</span>

                <label class="view-source-button" for="StructuredResponse.tool_calls_count-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StructuredResponse.tool_calls_count"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StructuredResponse.tool_calls_count-55"><a href="#StructuredResponse.tool_calls_count-55"><span class="linenos">55</span></a>    <span class="nd">@property</span>
</span><span id="StructuredResponse.tool_calls_count-56"><a href="#StructuredResponse.tool_calls_count-56"><span class="linenos">56</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tool_calls_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="StructuredResponse.tool_calls_count-57"><a href="#StructuredResponse.tool_calls_count-57"><span class="linenos">57</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get number of tool calls.&quot;&quot;&quot;</span>
</span><span id="StructuredResponse.tool_calls_count-58"><a href="#StructuredResponse.tool_calls_count-58"><span class="linenos">58</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get number of tool calls.</p>
</div>


                            </div>
                </section>
                <section id="StructuredResponseParser">
                            <input id="StructuredResponseParser-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">StructuredResponseParser</span>:

                <label class="view-source-button" for="StructuredResponseParser-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StructuredResponseParser"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StructuredResponseParser-61"><a href="#StructuredResponseParser-61"><span class="linenos"> 61</span></a><span class="k">class</span><span class="w"> </span><span class="nc">StructuredResponseParser</span><span class="p">:</span>
</span><span id="StructuredResponseParser-62"><a href="#StructuredResponseParser-62"><span class="linenos"> 62</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parser for converting JSON responses to StructuredResponse objects.&quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser-63"><a href="#StructuredResponseParser-63"><span class="linenos"> 63</span></a>    
</span><span id="StructuredResponseParser-64"><a href="#StructuredResponseParser-64"><span class="linenos"> 64</span></a>    <span class="c1"># JSON Schema for structured responses</span>
</span><span id="StructuredResponseParser-65"><a href="#StructuredResponseParser-65"><span class="linenos"> 65</span></a>    <span class="n">RESPONSE_SCHEMA</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="StructuredResponseParser-66"><a href="#StructuredResponseParser-66"><span class="linenos"> 66</span></a>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser-67"><a href="#StructuredResponseParser-67"><span class="linenos"> 67</span></a>        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="StructuredResponseParser-68"><a href="#StructuredResponseParser-68"><span class="linenos"> 68</span></a>            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="StructuredResponseParser-69"><a href="#StructuredResponseParser-69"><span class="linenos"> 69</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser-70"><a href="#StructuredResponseParser-70"><span class="linenos"> 70</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Main response content for the user&quot;</span>
</span><span id="StructuredResponseParser-71"><a href="#StructuredResponseParser-71"><span class="linenos"> 71</span></a>            <span class="p">},</span>
</span><span id="StructuredResponseParser-72"><a href="#StructuredResponseParser-72"><span class="linenos"> 72</span></a>            <span class="s2">&quot;tool_calls&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="StructuredResponseParser-73"><a href="#StructuredResponseParser-73"><span class="linenos"> 73</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser-74"><a href="#StructuredResponseParser-74"><span class="linenos"> 74</span></a>                <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="StructuredResponseParser-75"><a href="#StructuredResponseParser-75"><span class="linenos"> 75</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser-76"><a href="#StructuredResponseParser-76"><span class="linenos"> 76</span></a>                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="StructuredResponseParser-77"><a href="#StructuredResponseParser-77"><span class="linenos"> 77</span></a>                        <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
</span><span id="StructuredResponseParser-78"><a href="#StructuredResponseParser-78"><span class="linenos"> 78</span></a>                        <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">},</span>
</span><span id="StructuredResponseParser-79"><a href="#StructuredResponseParser-79"><span class="linenos"> 79</span></a>                        <span class="s2">&quot;reasoning&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>
</span><span id="StructuredResponseParser-80"><a href="#StructuredResponseParser-80"><span class="linenos"> 80</span></a>                    <span class="p">},</span>
</span><span id="StructuredResponseParser-81"><a href="#StructuredResponseParser-81"><span class="linenos"> 81</span></a>                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;function_name&quot;</span><span class="p">,</span> <span class="s2">&quot;arguments&quot;</span><span class="p">]</span>
</span><span id="StructuredResponseParser-82"><a href="#StructuredResponseParser-82"><span class="linenos"> 82</span></a>                <span class="p">}</span>
</span><span id="StructuredResponseParser-83"><a href="#StructuredResponseParser-83"><span class="linenos"> 83</span></a>            <span class="p">},</span>
</span><span id="StructuredResponseParser-84"><a href="#StructuredResponseParser-84"><span class="linenos"> 84</span></a>            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="StructuredResponseParser-85"><a href="#StructuredResponseParser-85"><span class="linenos"> 85</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser-86"><a href="#StructuredResponseParser-86"><span class="linenos"> 86</span></a>                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="StructuredResponseParser-87"><a href="#StructuredResponseParser-87"><span class="linenos"> 87</span></a>                    <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;minimum&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span id="StructuredResponseParser-88"><a href="#StructuredResponseParser-88"><span class="linenos"> 88</span></a>                    <span class="s2">&quot;sources&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="StructuredResponseParser-89"><a href="#StructuredResponseParser-89"><span class="linenos"> 89</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser-90"><a href="#StructuredResponseParser-90"><span class="linenos"> 90</span></a>                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>
</span><span id="StructuredResponseParser-91"><a href="#StructuredResponseParser-91"><span class="linenos"> 91</span></a>                    <span class="p">},</span>
</span><span id="StructuredResponseParser-92"><a href="#StructuredResponseParser-92"><span class="linenos"> 92</span></a>                    <span class="s2">&quot;reasoning_steps&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="StructuredResponseParser-93"><a href="#StructuredResponseParser-93"><span class="linenos"> 93</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser-94"><a href="#StructuredResponseParser-94"><span class="linenos"> 94</span></a>                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>
</span><span id="StructuredResponseParser-95"><a href="#StructuredResponseParser-95"><span class="linenos"> 95</span></a>                    <span class="p">},</span>
</span><span id="StructuredResponseParser-96"><a href="#StructuredResponseParser-96"><span class="linenos"> 96</span></a>                    <span class="s2">&quot;response_type&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>
</span><span id="StructuredResponseParser-97"><a href="#StructuredResponseParser-97"><span class="linenos"> 97</span></a>                <span class="p">}</span>
</span><span id="StructuredResponseParser-98"><a href="#StructuredResponseParser-98"><span class="linenos"> 98</span></a>            <span class="p">},</span>
</span><span id="StructuredResponseParser-99"><a href="#StructuredResponseParser-99"><span class="linenos"> 99</span></a>            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="StructuredResponseParser-100"><a href="#StructuredResponseParser-100"><span class="linenos">100</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser-101"><a href="#StructuredResponseParser-101"><span class="linenos">101</span></a>                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="StructuredResponseParser-102"><a href="#StructuredResponseParser-102"><span class="linenos">102</span></a>                    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
</span><span id="StructuredResponseParser-103"><a href="#StructuredResponseParser-103"><span class="linenos">103</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
</span><span id="StructuredResponseParser-104"><a href="#StructuredResponseParser-104"><span class="linenos">104</span></a>                    <span class="s2">&quot;recoverable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">}</span>
</span><span id="StructuredResponseParser-105"><a href="#StructuredResponseParser-105"><span class="linenos">105</span></a>                <span class="p">}</span>
</span><span id="StructuredResponseParser-106"><a href="#StructuredResponseParser-106"><span class="linenos">106</span></a>            <span class="p">}</span>
</span><span id="StructuredResponseParser-107"><a href="#StructuredResponseParser-107"><span class="linenos">107</span></a>        <span class="p">},</span>
</span><span id="StructuredResponseParser-108"><a href="#StructuredResponseParser-108"><span class="linenos">108</span></a>        <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
</span><span id="StructuredResponseParser-109"><a href="#StructuredResponseParser-109"><span class="linenos">109</span></a>    <span class="p">}</span>
</span><span id="StructuredResponseParser-110"><a href="#StructuredResponseParser-110"><span class="linenos">110</span></a>    
</span><span id="StructuredResponseParser-111"><a href="#StructuredResponseParser-111"><span class="linenos">111</span></a>    <span class="nd">@classmethod</span>
</span><span id="StructuredResponseParser-112"><a href="#StructuredResponseParser-112"><span class="linenos">112</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">response_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StructuredResponse</span><span class="p">:</span>
</span><span id="StructuredResponseParser-113"><a href="#StructuredResponseParser-113"><span class="linenos">113</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser-114"><a href="#StructuredResponseParser-114"><span class="linenos">114</span></a><span class="sd">        Parse a response string into a StructuredResponse object.</span>
</span><span id="StructuredResponseParser-115"><a href="#StructuredResponseParser-115"><span class="linenos">115</span></a><span class="sd">        </span>
</span><span id="StructuredResponseParser-116"><a href="#StructuredResponseParser-116"><span class="linenos">116</span></a><span class="sd">        Args:</span>
</span><span id="StructuredResponseParser-117"><a href="#StructuredResponseParser-117"><span class="linenos">117</span></a><span class="sd">            response_text: Raw response text (JSON or plain text)</span>
</span><span id="StructuredResponseParser-118"><a href="#StructuredResponseParser-118"><span class="linenos">118</span></a><span class="sd">            </span>
</span><span id="StructuredResponseParser-119"><a href="#StructuredResponseParser-119"><span class="linenos">119</span></a><span class="sd">        Returns:</span>
</span><span id="StructuredResponseParser-120"><a href="#StructuredResponseParser-120"><span class="linenos">120</span></a><span class="sd">            StructuredResponse object</span>
</span><span id="StructuredResponseParser-121"><a href="#StructuredResponseParser-121"><span class="linenos">121</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser-122"><a href="#StructuredResponseParser-122"><span class="linenos">122</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="StructuredResponseParser-123"><a href="#StructuredResponseParser-123"><span class="linenos">123</span></a>            <span class="c1"># Log the raw response for debugging</span>
</span><span id="StructuredResponseParser-124"><a href="#StructuredResponseParser-124"><span class="linenos">124</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Parsing response text: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="StructuredResponseParser-125"><a href="#StructuredResponseParser-125"><span class="linenos">125</span></a>            
</span><span id="StructuredResponseParser-126"><a href="#StructuredResponseParser-126"><span class="linenos">126</span></a>            <span class="c1"># Try to parse as JSON first</span>
</span><span id="StructuredResponseParser-127"><a href="#StructuredResponseParser-127"><span class="linenos">127</span></a>            <span class="k">if</span> <span class="n">response_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
</span><span id="StructuredResponseParser-128"><a href="#StructuredResponseParser-128"><span class="linenos">128</span></a>                <span class="c1"># Check if JSON is complete</span>
</span><span id="StructuredResponseParser-129"><a href="#StructuredResponseParser-129"><span class="linenos">129</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">response_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">):</span>
</span><span id="StructuredResponseParser-130"><a href="#StructuredResponseParser-130"><span class="linenos">130</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Incomplete JSON detected, falling back to text parsing&quot;</span><span class="p">)</span>
</span><span id="StructuredResponseParser-131"><a href="#StructuredResponseParser-131"><span class="linenos">131</span></a>                    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse_text_response</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
</span><span id="StructuredResponseParser-132"><a href="#StructuredResponseParser-132"><span class="linenos">132</span></a>                
</span><span id="StructuredResponseParser-133"><a href="#StructuredResponseParser-133"><span class="linenos">133</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
</span><span id="StructuredResponseParser-134"><a href="#StructuredResponseParser-134"><span class="linenos">134</span></a>                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse_json_response</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="StructuredResponseParser-135"><a href="#StructuredResponseParser-135"><span class="linenos">135</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="StructuredResponseParser-136"><a href="#StructuredResponseParser-136"><span class="linenos">136</span></a>                <span class="c1"># Fallback to plain text response</span>
</span><span id="StructuredResponseParser-137"><a href="#StructuredResponseParser-137"><span class="linenos">137</span></a>                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse_text_response</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
</span><span id="StructuredResponseParser-138"><a href="#StructuredResponseParser-138"><span class="linenos">138</span></a>                
</span><span id="StructuredResponseParser-139"><a href="#StructuredResponseParser-139"><span class="linenos">139</span></a>        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StructuredResponseParser-140"><a href="#StructuredResponseParser-140"><span class="linenos">140</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to parse JSON response: </span><span class="si">%s</span><span class="s2">. Response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">response_text</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>
</span><span id="StructuredResponseParser-141"><a href="#StructuredResponseParser-141"><span class="linenos">141</span></a>            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse_text_response</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
</span><span id="StructuredResponseParser-142"><a href="#StructuredResponseParser-142"><span class="linenos">142</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StructuredResponseParser-143"><a href="#StructuredResponseParser-143"><span class="linenos">143</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error parsing response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="StructuredResponseParser-144"><a href="#StructuredResponseParser-144"><span class="linenos">144</span></a>            <span class="k">return</span> <span class="n">StructuredResponse</span><span class="p">(</span>
</span><span id="StructuredResponseParser-145"><a href="#StructuredResponseParser-145"><span class="linenos">145</span></a>                <span class="n">content</span><span class="o">=</span><span class="n">response_text</span><span class="p">,</span>
</span><span id="StructuredResponseParser-146"><a href="#StructuredResponseParser-146"><span class="linenos">146</span></a>                <span class="n">error</span><span class="o">=</span><span class="n">ResponseError</span><span class="p">(</span>
</span><span id="StructuredResponseParser-147"><a href="#StructuredResponseParser-147"><span class="linenos">147</span></a>                    <span class="n">code</span><span class="o">=</span><span class="s2">&quot;PARSE_ERROR&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser-148"><a href="#StructuredResponseParser-148"><span class="linenos">148</span></a>                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to parse response: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser-149"><a href="#StructuredResponseParser-149"><span class="linenos">149</span></a>                    <span class="n">recoverable</span><span class="o">=</span><span class="kc">True</span>
</span><span id="StructuredResponseParser-150"><a href="#StructuredResponseParser-150"><span class="linenos">150</span></a>                <span class="p">)</span>
</span><span id="StructuredResponseParser-151"><a href="#StructuredResponseParser-151"><span class="linenos">151</span></a>            <span class="p">)</span>
</span><span id="StructuredResponseParser-152"><a href="#StructuredResponseParser-152"><span class="linenos">152</span></a>    
</span><span id="StructuredResponseParser-153"><a href="#StructuredResponseParser-153"><span class="linenos">153</span></a>    <span class="nd">@classmethod</span>
</span><span id="StructuredResponseParser-154"><a href="#StructuredResponseParser-154"><span class="linenos">154</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_json_response</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">StructuredResponse</span><span class="p">:</span>
</span><span id="StructuredResponseParser-155"><a href="#StructuredResponseParser-155"><span class="linenos">155</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a JSON response into StructuredResponse.&quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser-156"><a href="#StructuredResponseParser-156"><span class="linenos">156</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="StructuredResponseParser-157"><a href="#StructuredResponseParser-157"><span class="linenos">157</span></a>            <span class="c1"># Extract content</span>
</span><span id="StructuredResponseParser-158"><a href="#StructuredResponseParser-158"><span class="linenos">158</span></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="StructuredResponseParser-159"><a href="#StructuredResponseParser-159"><span class="linenos">159</span></a>            
</span><span id="StructuredResponseParser-160"><a href="#StructuredResponseParser-160"><span class="linenos">160</span></a>            <span class="c1"># Parse tool calls</span>
</span><span id="StructuredResponseParser-161"><a href="#StructuredResponseParser-161"><span class="linenos">161</span></a>            <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="StructuredResponseParser-162"><a href="#StructuredResponseParser-162"><span class="linenos">162</span></a>            <span class="k">if</span> <span class="s2">&quot;tool_calls&quot;</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="StructuredResponseParser-163"><a href="#StructuredResponseParser-163"><span class="linenos">163</span></a>                <span class="k">for</span> <span class="n">tc_data</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">]:</span>
</span><span id="StructuredResponseParser-164"><a href="#StructuredResponseParser-164"><span class="linenos">164</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tc_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="StructuredResponseParser-165"><a href="#StructuredResponseParser-165"><span class="linenos">165</span></a>                        <span class="n">tool_call</span> <span class="o">=</span> <span class="n">ToolCall</span><span class="p">(</span>
</span><span id="StructuredResponseParser-166"><a href="#StructuredResponseParser-166"><span class="linenos">166</span></a>                            <span class="n">function_name</span><span class="o">=</span><span class="n">tc_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function_name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">),</span>
</span><span id="StructuredResponseParser-167"><a href="#StructuredResponseParser-167"><span class="linenos">167</span></a>                            <span class="n">arguments</span><span class="o">=</span><span class="n">tc_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="p">{}),</span>
</span><span id="StructuredResponseParser-168"><a href="#StructuredResponseParser-168"><span class="linenos">168</span></a>                            <span class="n">reasoning</span><span class="o">=</span><span class="n">tc_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reasoning&quot;</span><span class="p">)</span>
</span><span id="StructuredResponseParser-169"><a href="#StructuredResponseParser-169"><span class="linenos">169</span></a>                        <span class="p">)</span>
</span><span id="StructuredResponseParser-170"><a href="#StructuredResponseParser-170"><span class="linenos">170</span></a>                        <span class="n">tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_call</span><span class="p">)</span>
</span><span id="StructuredResponseParser-171"><a href="#StructuredResponseParser-171"><span class="linenos">171</span></a>            
</span><span id="StructuredResponseParser-172"><a href="#StructuredResponseParser-172"><span class="linenos">172</span></a>            <span class="c1"># Parse metadata</span>
</span><span id="StructuredResponseParser-173"><a href="#StructuredResponseParser-173"><span class="linenos">173</span></a>            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StructuredResponseParser-174"><a href="#StructuredResponseParser-174"><span class="linenos">174</span></a>            <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="StructuredResponseParser-175"><a href="#StructuredResponseParser-175"><span class="linenos">175</span></a>                <span class="n">meta_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>
</span><span id="StructuredResponseParser-176"><a href="#StructuredResponseParser-176"><span class="linenos">176</span></a>                <span class="n">metadata</span> <span class="o">=</span> <span class="n">ResponseMetadata</span><span class="p">(</span>
</span><span id="StructuredResponseParser-177"><a href="#StructuredResponseParser-177"><span class="linenos">177</span></a>                    <span class="n">confidence</span><span class="o">=</span><span class="n">meta_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">),</span>
</span><span id="StructuredResponseParser-178"><a href="#StructuredResponseParser-178"><span class="linenos">178</span></a>                    <span class="n">sources</span><span class="o">=</span><span class="n">meta_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="StructuredResponseParser-179"><a href="#StructuredResponseParser-179"><span class="linenos">179</span></a>                    <span class="n">reasoning_steps</span><span class="o">=</span><span class="n">meta_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reasoning_steps&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="StructuredResponseParser-180"><a href="#StructuredResponseParser-180"><span class="linenos">180</span></a>                    <span class="n">response_type</span><span class="o">=</span><span class="n">meta_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;response_type&quot;</span><span class="p">,</span> <span class="s2">&quot;structured&quot;</span><span class="p">)</span>
</span><span id="StructuredResponseParser-181"><a href="#StructuredResponseParser-181"><span class="linenos">181</span></a>                <span class="p">)</span>
</span><span id="StructuredResponseParser-182"><a href="#StructuredResponseParser-182"><span class="linenos">182</span></a>            
</span><span id="StructuredResponseParser-183"><a href="#StructuredResponseParser-183"><span class="linenos">183</span></a>            <span class="c1"># Parse error</span>
</span><span id="StructuredResponseParser-184"><a href="#StructuredResponseParser-184"><span class="linenos">184</span></a>            <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StructuredResponseParser-185"><a href="#StructuredResponseParser-185"><span class="linenos">185</span></a>            <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="StructuredResponseParser-186"><a href="#StructuredResponseParser-186"><span class="linenos">186</span></a>                <span class="n">error_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span>
</span><span id="StructuredResponseParser-187"><a href="#StructuredResponseParser-187"><span class="linenos">187</span></a>                <span class="n">error</span> <span class="o">=</span> <span class="n">ResponseError</span><span class="p">(</span>
</span><span id="StructuredResponseParser-188"><a href="#StructuredResponseParser-188"><span class="linenos">188</span></a>                    <span class="n">code</span><span class="o">=</span><span class="n">error_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="s2">&quot;UNKNOWN&quot;</span><span class="p">),</span>
</span><span id="StructuredResponseParser-189"><a href="#StructuredResponseParser-189"><span class="linenos">189</span></a>                    <span class="n">message</span><span class="o">=</span><span class="n">error_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">),</span>
</span><span id="StructuredResponseParser-190"><a href="#StructuredResponseParser-190"><span class="linenos">190</span></a>                    <span class="n">recoverable</span><span class="o">=</span><span class="n">error_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recoverable&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="StructuredResponseParser-191"><a href="#StructuredResponseParser-191"><span class="linenos">191</span></a>                <span class="p">)</span>
</span><span id="StructuredResponseParser-192"><a href="#StructuredResponseParser-192"><span class="linenos">192</span></a>            
</span><span id="StructuredResponseParser-193"><a href="#StructuredResponseParser-193"><span class="linenos">193</span></a>            <span class="k">return</span> <span class="n">StructuredResponse</span><span class="p">(</span>
</span><span id="StructuredResponseParser-194"><a href="#StructuredResponseParser-194"><span class="linenos">194</span></a>                <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
</span><span id="StructuredResponseParser-195"><a href="#StructuredResponseParser-195"><span class="linenos">195</span></a>                <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span><span class="p">,</span>
</span><span id="StructuredResponseParser-196"><a href="#StructuredResponseParser-196"><span class="linenos">196</span></a>                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
</span><span id="StructuredResponseParser-197"><a href="#StructuredResponseParser-197"><span class="linenos">197</span></a>                <span class="n">error</span><span class="o">=</span><span class="n">error</span>
</span><span id="StructuredResponseParser-198"><a href="#StructuredResponseParser-198"><span class="linenos">198</span></a>            <span class="p">)</span>
</span><span id="StructuredResponseParser-199"><a href="#StructuredResponseParser-199"><span class="linenos">199</span></a>            
</span><span id="StructuredResponseParser-200"><a href="#StructuredResponseParser-200"><span class="linenos">200</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StructuredResponseParser-201"><a href="#StructuredResponseParser-201"><span class="linenos">201</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error parsing JSON response data: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="StructuredResponseParser-202"><a href="#StructuredResponseParser-202"><span class="linenos">202</span></a>            <span class="k">return</span> <span class="n">StructuredResponse</span><span class="p">(</span>
</span><span id="StructuredResponseParser-203"><a href="#StructuredResponseParser-203"><span class="linenos">203</span></a>                <span class="n">content</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
</span><span id="StructuredResponseParser-204"><a href="#StructuredResponseParser-204"><span class="linenos">204</span></a>                <span class="n">error</span><span class="o">=</span><span class="n">ResponseError</span><span class="p">(</span>
</span><span id="StructuredResponseParser-205"><a href="#StructuredResponseParser-205"><span class="linenos">205</span></a>                    <span class="n">code</span><span class="o">=</span><span class="s2">&quot;JSON_PARSE_ERROR&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser-206"><a href="#StructuredResponseParser-206"><span class="linenos">206</span></a>                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to parse JSON data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser-207"><a href="#StructuredResponseParser-207"><span class="linenos">207</span></a>                    <span class="n">recoverable</span><span class="o">=</span><span class="kc">True</span>
</span><span id="StructuredResponseParser-208"><a href="#StructuredResponseParser-208"><span class="linenos">208</span></a>                <span class="p">)</span>
</span><span id="StructuredResponseParser-209"><a href="#StructuredResponseParser-209"><span class="linenos">209</span></a>            <span class="p">)</span>
</span><span id="StructuredResponseParser-210"><a href="#StructuredResponseParser-210"><span class="linenos">210</span></a>    
</span><span id="StructuredResponseParser-211"><a href="#StructuredResponseParser-211"><span class="linenos">211</span></a>    <span class="nd">@classmethod</span>
</span><span id="StructuredResponseParser-212"><a href="#StructuredResponseParser-212"><span class="linenos">212</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_text_response</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StructuredResponse</span><span class="p">:</span>
</span><span id="StructuredResponseParser-213"><a href="#StructuredResponseParser-213"><span class="linenos">213</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a plain text response into StructuredResponse.&quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser-214"><a href="#StructuredResponseParser-214"><span class="linenos">214</span></a>        <span class="k">return</span> <span class="n">StructuredResponse</span><span class="p">(</span>
</span><span id="StructuredResponseParser-215"><a href="#StructuredResponseParser-215"><span class="linenos">215</span></a>            <span class="n">content</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
</span><span id="StructuredResponseParser-216"><a href="#StructuredResponseParser-216"><span class="linenos">216</span></a>            <span class="n">metadata</span><span class="o">=</span><span class="n">ResponseMetadata</span><span class="p">(</span><span class="n">response_type</span><span class="o">=</span><span class="s2">&quot;fallback_text&quot;</span><span class="p">)</span>
</span><span id="StructuredResponseParser-217"><a href="#StructuredResponseParser-217"><span class="linenos">217</span></a>        <span class="p">)</span>
</span><span id="StructuredResponseParser-218"><a href="#StructuredResponseParser-218"><span class="linenos">218</span></a>    
</span><span id="StructuredResponseParser-219"><a href="#StructuredResponseParser-219"><span class="linenos">219</span></a>    <span class="nd">@classmethod</span>
</span><span id="StructuredResponseParser-220"><a href="#StructuredResponseParser-220"><span class="linenos">220</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_system_prompt</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="StructuredResponseParser-221"><a href="#StructuredResponseParser-221"><span class="linenos">221</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser-222"><a href="#StructuredResponseParser-222"><span class="linenos">222</span></a><span class="sd">        Create a system prompt that instructs the model to use structured JSON output.</span>
</span><span id="StructuredResponseParser-223"><a href="#StructuredResponseParser-223"><span class="linenos">223</span></a><span class="sd">        </span>
</span><span id="StructuredResponseParser-224"><a href="#StructuredResponseParser-224"><span class="linenos">224</span></a><span class="sd">        Returns:</span>
</span><span id="StructuredResponseParser-225"><a href="#StructuredResponseParser-225"><span class="linenos">225</span></a><span class="sd">            System prompt string</span>
</span><span id="StructuredResponseParser-226"><a href="#StructuredResponseParser-226"><span class="linenos">226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser-227"><a href="#StructuredResponseParser-227"><span class="linenos">227</span></a>        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser-228"><a href="#StructuredResponseParser-228"><span class="linenos">228</span></a><span class="s2">You must respond using the following JSON structure. Always return valid JSON that matches this exact schema:</span>
</span><span id="StructuredResponseParser-229"><a href="#StructuredResponseParser-229"><span class="linenos">229</span></a>
</span><span id="StructuredResponseParser-230"><a href="#StructuredResponseParser-230"><span class="linenos">230</span></a><span class="s2">{</span>
</span><span id="StructuredResponseParser-231"><a href="#StructuredResponseParser-231"><span class="linenos">231</span></a><span class="s2">  &quot;content&quot;: &quot;Your main response to the user goes here&quot;,</span>
</span><span id="StructuredResponseParser-232"><a href="#StructuredResponseParser-232"><span class="linenos">232</span></a><span class="s2">  &quot;tool_calls&quot;: [</span>
</span><span id="StructuredResponseParser-233"><a href="#StructuredResponseParser-233"><span class="linenos">233</span></a><span class="s2">    {</span>
</span><span id="StructuredResponseParser-234"><a href="#StructuredResponseParser-234"><span class="linenos">234</span></a><span class="s2">      &quot;function_name&quot;: &quot;name_of_function_to_call&quot;,</span>
</span><span id="StructuredResponseParser-235"><a href="#StructuredResponseParser-235"><span class="linenos">235</span></a><span class="s2">      &quot;arguments&quot;: {&quot;arg1&quot;: &quot;value1&quot;, &quot;arg2&quot;: &quot;value2&quot;},</span>
</span><span id="StructuredResponseParser-236"><a href="#StructuredResponseParser-236"><span class="linenos">236</span></a><span class="s2">      &quot;reasoning&quot;: &quot;Why you&#39;re calling this function (optional)&quot;</span>
</span><span id="StructuredResponseParser-237"><a href="#StructuredResponseParser-237"><span class="linenos">237</span></a><span class="s2">    }</span>
</span><span id="StructuredResponseParser-238"><a href="#StructuredResponseParser-238"><span class="linenos">238</span></a><span class="s2">  ],</span>
</span><span id="StructuredResponseParser-239"><a href="#StructuredResponseParser-239"><span class="linenos">239</span></a><span class="s2">  &quot;metadata&quot;: {</span>
</span><span id="StructuredResponseParser-240"><a href="#StructuredResponseParser-240"><span class="linenos">240</span></a><span class="s2">    &quot;confidence&quot;: 0.95,</span>
</span><span id="StructuredResponseParser-241"><a href="#StructuredResponseParser-241"><span class="linenos">241</span></a><span class="s2">    &quot;sources&quot;: [&quot;source1&quot;, &quot;source2&quot;],</span>
</span><span id="StructuredResponseParser-242"><a href="#StructuredResponseParser-242"><span class="linenos">242</span></a><span class="s2">    &quot;reasoning_steps&quot;: [&quot;step1&quot;, &quot;step2&quot;],</span>
</span><span id="StructuredResponseParser-243"><a href="#StructuredResponseParser-243"><span class="linenos">243</span></a><span class="s2">    &quot;response_type&quot;: &quot;structured&quot;</span>
</span><span id="StructuredResponseParser-244"><a href="#StructuredResponseParser-244"><span class="linenos">244</span></a><span class="s2">  }</span>
</span><span id="StructuredResponseParser-245"><a href="#StructuredResponseParser-245"><span class="linenos">245</span></a><span class="s2">}</span>
</span><span id="StructuredResponseParser-246"><a href="#StructuredResponseParser-246"><span class="linenos">246</span></a>
</span><span id="StructuredResponseParser-247"><a href="#StructuredResponseParser-247"><span class="linenos">247</span></a><span class="s2">CRITICAL RULES:</span>
</span><span id="StructuredResponseParser-248"><a href="#StructuredResponseParser-248"><span class="linenos">248</span></a><span class="s2">1. ALWAYS return valid JSON</span>
</span><span id="StructuredResponseParser-249"><a href="#StructuredResponseParser-249"><span class="linenos">249</span></a><span class="s2">2. The &quot;content&quot; field is required and contains your main response</span>
</span><span id="StructuredResponseParser-250"><a href="#StructuredResponseParser-250"><span class="linenos">250</span></a><span class="s2">3. Include &quot;tool_calls&quot; array if you need to use any tools</span>
</span><span id="StructuredResponseParser-251"><a href="#StructuredResponseParser-251"><span class="linenos">251</span></a><span class="s2">4. Add &quot;metadata&quot; with confidence (0.0-1.0) when possible</span>
</span><span id="StructuredResponseParser-252"><a href="#StructuredResponseParser-252"><span class="linenos">252</span></a><span class="s2">5. List sources in &quot;sources&quot; array when referencing information</span>
</span><span id="StructuredResponseParser-253"><a href="#StructuredResponseParser-253"><span class="linenos">253</span></a><span class="s2">6. If there&#39;s an error, include an &quot;error&quot; object with &quot;code&quot;, &quot;message&quot;, and &quot;recoverable&quot; fields</span>
</span><span id="StructuredResponseParser-254"><a href="#StructuredResponseParser-254"><span class="linenos">254</span></a><span class="s2">7. Do not include any text outside the JSON structure</span>
</span><span id="StructuredResponseParser-255"><a href="#StructuredResponseParser-255"><span class="linenos">255</span></a><span class="s2">&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Parser for converting JSON responses to StructuredResponse objects.</p>
</div>


                            <div id="StructuredResponseParser.RESPONSE_SCHEMA" class="classattr">
                                <div class="attr variable">
            <span class="name">RESPONSE_SCHEMA</span>        =
<input id="StructuredResponseParser.RESPONSE_SCHEMA-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="StructuredResponseParser.RESPONSE_SCHEMA-view-value"></label><span class="default_value">{&#39;type&#39;: &#39;object&#39;, &#39;properties&#39;: {&#39;content&#39;: {&#39;type&#39;: &#39;string&#39;, &#39;description&#39;: &#39;Main response content for the user&#39;}, &#39;tool_calls&#39;: {&#39;type&#39;: &#39;array&#39;, &#39;items&#39;: {&#39;type&#39;: &#39;object&#39;, &#39;properties&#39;: {&#39;function_name&#39;: {&#39;type&#39;: &#39;string&#39;}, &#39;arguments&#39;: {&#39;type&#39;: &#39;object&#39;}, &#39;reasoning&#39;: {&#39;type&#39;: &#39;string&#39;}}, &#39;required&#39;: [&#39;function_name&#39;, &#39;arguments&#39;]}}, &#39;metadata&#39;: {&#39;type&#39;: &#39;object&#39;, &#39;properties&#39;: {&#39;confidence&#39;: {&#39;type&#39;: &#39;number&#39;, &#39;minimum&#39;: 0, &#39;maximum&#39;: 1}, &#39;sources&#39;: {&#39;type&#39;: &#39;array&#39;, &#39;items&#39;: {&#39;type&#39;: &#39;string&#39;}}, &#39;reasoning_steps&#39;: {&#39;type&#39;: &#39;array&#39;, &#39;items&#39;: {&#39;type&#39;: &#39;string&#39;}}, &#39;response_type&#39;: {&#39;type&#39;: &#39;string&#39;}}}, &#39;error&#39;: {&#39;type&#39;: &#39;object&#39;, &#39;properties&#39;: {&#39;code&#39;: {&#39;type&#39;: &#39;string&#39;}, &#39;message&#39;: {&#39;type&#39;: &#39;string&#39;}, &#39;recoverable&#39;: {&#39;type&#39;: &#39;boolean&#39;}}}}, &#39;required&#39;: [&#39;content&#39;]}</span>

        
    </div>
    <a class="headerlink" href="#StructuredResponseParser.RESPONSE_SCHEMA"></a>
    
    

                            </div>
                            <div id="StructuredResponseParser.parse" class="classattr">
                                        <input id="StructuredResponseParser.parse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">parse</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">response_text</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n"><a href="#StructuredResponse">StructuredResponse</a></span>:</span></span>

                <label class="view-source-button" for="StructuredResponseParser.parse-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StructuredResponseParser.parse"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StructuredResponseParser.parse-111"><a href="#StructuredResponseParser.parse-111"><span class="linenos">111</span></a>    <span class="nd">@classmethod</span>
</span><span id="StructuredResponseParser.parse-112"><a href="#StructuredResponseParser.parse-112"><span class="linenos">112</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">response_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StructuredResponse</span><span class="p">:</span>
</span><span id="StructuredResponseParser.parse-113"><a href="#StructuredResponseParser.parse-113"><span class="linenos">113</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser.parse-114"><a href="#StructuredResponseParser.parse-114"><span class="linenos">114</span></a><span class="sd">        Parse a response string into a StructuredResponse object.</span>
</span><span id="StructuredResponseParser.parse-115"><a href="#StructuredResponseParser.parse-115"><span class="linenos">115</span></a><span class="sd">        </span>
</span><span id="StructuredResponseParser.parse-116"><a href="#StructuredResponseParser.parse-116"><span class="linenos">116</span></a><span class="sd">        Args:</span>
</span><span id="StructuredResponseParser.parse-117"><a href="#StructuredResponseParser.parse-117"><span class="linenos">117</span></a><span class="sd">            response_text: Raw response text (JSON or plain text)</span>
</span><span id="StructuredResponseParser.parse-118"><a href="#StructuredResponseParser.parse-118"><span class="linenos">118</span></a><span class="sd">            </span>
</span><span id="StructuredResponseParser.parse-119"><a href="#StructuredResponseParser.parse-119"><span class="linenos">119</span></a><span class="sd">        Returns:</span>
</span><span id="StructuredResponseParser.parse-120"><a href="#StructuredResponseParser.parse-120"><span class="linenos">120</span></a><span class="sd">            StructuredResponse object</span>
</span><span id="StructuredResponseParser.parse-121"><a href="#StructuredResponseParser.parse-121"><span class="linenos">121</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser.parse-122"><a href="#StructuredResponseParser.parse-122"><span class="linenos">122</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="StructuredResponseParser.parse-123"><a href="#StructuredResponseParser.parse-123"><span class="linenos">123</span></a>            <span class="c1"># Log the raw response for debugging</span>
</span><span id="StructuredResponseParser.parse-124"><a href="#StructuredResponseParser.parse-124"><span class="linenos">124</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Parsing response text: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="StructuredResponseParser.parse-125"><a href="#StructuredResponseParser.parse-125"><span class="linenos">125</span></a>            
</span><span id="StructuredResponseParser.parse-126"><a href="#StructuredResponseParser.parse-126"><span class="linenos">126</span></a>            <span class="c1"># Try to parse as JSON first</span>
</span><span id="StructuredResponseParser.parse-127"><a href="#StructuredResponseParser.parse-127"><span class="linenos">127</span></a>            <span class="k">if</span> <span class="n">response_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
</span><span id="StructuredResponseParser.parse-128"><a href="#StructuredResponseParser.parse-128"><span class="linenos">128</span></a>                <span class="c1"># Check if JSON is complete</span>
</span><span id="StructuredResponseParser.parse-129"><a href="#StructuredResponseParser.parse-129"><span class="linenos">129</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">response_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">):</span>
</span><span id="StructuredResponseParser.parse-130"><a href="#StructuredResponseParser.parse-130"><span class="linenos">130</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Incomplete JSON detected, falling back to text parsing&quot;</span><span class="p">)</span>
</span><span id="StructuredResponseParser.parse-131"><a href="#StructuredResponseParser.parse-131"><span class="linenos">131</span></a>                    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse_text_response</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
</span><span id="StructuredResponseParser.parse-132"><a href="#StructuredResponseParser.parse-132"><span class="linenos">132</span></a>                
</span><span id="StructuredResponseParser.parse-133"><a href="#StructuredResponseParser.parse-133"><span class="linenos">133</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
</span><span id="StructuredResponseParser.parse-134"><a href="#StructuredResponseParser.parse-134"><span class="linenos">134</span></a>                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse_json_response</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="StructuredResponseParser.parse-135"><a href="#StructuredResponseParser.parse-135"><span class="linenos">135</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="StructuredResponseParser.parse-136"><a href="#StructuredResponseParser.parse-136"><span class="linenos">136</span></a>                <span class="c1"># Fallback to plain text response</span>
</span><span id="StructuredResponseParser.parse-137"><a href="#StructuredResponseParser.parse-137"><span class="linenos">137</span></a>                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse_text_response</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
</span><span id="StructuredResponseParser.parse-138"><a href="#StructuredResponseParser.parse-138"><span class="linenos">138</span></a>                
</span><span id="StructuredResponseParser.parse-139"><a href="#StructuredResponseParser.parse-139"><span class="linenos">139</span></a>        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StructuredResponseParser.parse-140"><a href="#StructuredResponseParser.parse-140"><span class="linenos">140</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to parse JSON response: </span><span class="si">%s</span><span class="s2">. Response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">response_text</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>
</span><span id="StructuredResponseParser.parse-141"><a href="#StructuredResponseParser.parse-141"><span class="linenos">141</span></a>            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse_text_response</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
</span><span id="StructuredResponseParser.parse-142"><a href="#StructuredResponseParser.parse-142"><span class="linenos">142</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StructuredResponseParser.parse-143"><a href="#StructuredResponseParser.parse-143"><span class="linenos">143</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error parsing response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="StructuredResponseParser.parse-144"><a href="#StructuredResponseParser.parse-144"><span class="linenos">144</span></a>            <span class="k">return</span> <span class="n">StructuredResponse</span><span class="p">(</span>
</span><span id="StructuredResponseParser.parse-145"><a href="#StructuredResponseParser.parse-145"><span class="linenos">145</span></a>                <span class="n">content</span><span class="o">=</span><span class="n">response_text</span><span class="p">,</span>
</span><span id="StructuredResponseParser.parse-146"><a href="#StructuredResponseParser.parse-146"><span class="linenos">146</span></a>                <span class="n">error</span><span class="o">=</span><span class="n">ResponseError</span><span class="p">(</span>
</span><span id="StructuredResponseParser.parse-147"><a href="#StructuredResponseParser.parse-147"><span class="linenos">147</span></a>                    <span class="n">code</span><span class="o">=</span><span class="s2">&quot;PARSE_ERROR&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser.parse-148"><a href="#StructuredResponseParser.parse-148"><span class="linenos">148</span></a>                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to parse response: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="StructuredResponseParser.parse-149"><a href="#StructuredResponseParser.parse-149"><span class="linenos">149</span></a>                    <span class="n">recoverable</span><span class="o">=</span><span class="kc">True</span>
</span><span id="StructuredResponseParser.parse-150"><a href="#StructuredResponseParser.parse-150"><span class="linenos">150</span></a>                <span class="p">)</span>
</span><span id="StructuredResponseParser.parse-151"><a href="#StructuredResponseParser.parse-151"><span class="linenos">151</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Parse a response string into a StructuredResponse object.</p>

<p>Args:
    response_text: Raw response text (JSON or plain text)</p>

<p>Returns:
    StructuredResponse object</p>
</div>


                            </div>
                            <div id="StructuredResponseParser.create_system_prompt" class="classattr">
                                        <input id="StructuredResponseParser.create_system_prompt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">create_system_prompt</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="StructuredResponseParser.create_system_prompt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StructuredResponseParser.create_system_prompt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StructuredResponseParser.create_system_prompt-219"><a href="#StructuredResponseParser.create_system_prompt-219"><span class="linenos">219</span></a>    <span class="nd">@classmethod</span>
</span><span id="StructuredResponseParser.create_system_prompt-220"><a href="#StructuredResponseParser.create_system_prompt-220"><span class="linenos">220</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_system_prompt</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="StructuredResponseParser.create_system_prompt-221"><a href="#StructuredResponseParser.create_system_prompt-221"><span class="linenos">221</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser.create_system_prompt-222"><a href="#StructuredResponseParser.create_system_prompt-222"><span class="linenos">222</span></a><span class="sd">        Create a system prompt that instructs the model to use structured JSON output.</span>
</span><span id="StructuredResponseParser.create_system_prompt-223"><a href="#StructuredResponseParser.create_system_prompt-223"><span class="linenos">223</span></a><span class="sd">        </span>
</span><span id="StructuredResponseParser.create_system_prompt-224"><a href="#StructuredResponseParser.create_system_prompt-224"><span class="linenos">224</span></a><span class="sd">        Returns:</span>
</span><span id="StructuredResponseParser.create_system_prompt-225"><a href="#StructuredResponseParser.create_system_prompt-225"><span class="linenos">225</span></a><span class="sd">            System prompt string</span>
</span><span id="StructuredResponseParser.create_system_prompt-226"><a href="#StructuredResponseParser.create_system_prompt-226"><span class="linenos">226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser.create_system_prompt-227"><a href="#StructuredResponseParser.create_system_prompt-227"><span class="linenos">227</span></a>        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="StructuredResponseParser.create_system_prompt-228"><a href="#StructuredResponseParser.create_system_prompt-228"><span class="linenos">228</span></a><span class="s2">You must respond using the following JSON structure. Always return valid JSON that matches this exact schema:</span>
</span><span id="StructuredResponseParser.create_system_prompt-229"><a href="#StructuredResponseParser.create_system_prompt-229"><span class="linenos">229</span></a>
</span><span id="StructuredResponseParser.create_system_prompt-230"><a href="#StructuredResponseParser.create_system_prompt-230"><span class="linenos">230</span></a><span class="s2">{</span>
</span><span id="StructuredResponseParser.create_system_prompt-231"><a href="#StructuredResponseParser.create_system_prompt-231"><span class="linenos">231</span></a><span class="s2">  &quot;content&quot;: &quot;Your main response to the user goes here&quot;,</span>
</span><span id="StructuredResponseParser.create_system_prompt-232"><a href="#StructuredResponseParser.create_system_prompt-232"><span class="linenos">232</span></a><span class="s2">  &quot;tool_calls&quot;: [</span>
</span><span id="StructuredResponseParser.create_system_prompt-233"><a href="#StructuredResponseParser.create_system_prompt-233"><span class="linenos">233</span></a><span class="s2">    {</span>
</span><span id="StructuredResponseParser.create_system_prompt-234"><a href="#StructuredResponseParser.create_system_prompt-234"><span class="linenos">234</span></a><span class="s2">      &quot;function_name&quot;: &quot;name_of_function_to_call&quot;,</span>
</span><span id="StructuredResponseParser.create_system_prompt-235"><a href="#StructuredResponseParser.create_system_prompt-235"><span class="linenos">235</span></a><span class="s2">      &quot;arguments&quot;: {&quot;arg1&quot;: &quot;value1&quot;, &quot;arg2&quot;: &quot;value2&quot;},</span>
</span><span id="StructuredResponseParser.create_system_prompt-236"><a href="#StructuredResponseParser.create_system_prompt-236"><span class="linenos">236</span></a><span class="s2">      &quot;reasoning&quot;: &quot;Why you&#39;re calling this function (optional)&quot;</span>
</span><span id="StructuredResponseParser.create_system_prompt-237"><a href="#StructuredResponseParser.create_system_prompt-237"><span class="linenos">237</span></a><span class="s2">    }</span>
</span><span id="StructuredResponseParser.create_system_prompt-238"><a href="#StructuredResponseParser.create_system_prompt-238"><span class="linenos">238</span></a><span class="s2">  ],</span>
</span><span id="StructuredResponseParser.create_system_prompt-239"><a href="#StructuredResponseParser.create_system_prompt-239"><span class="linenos">239</span></a><span class="s2">  &quot;metadata&quot;: {</span>
</span><span id="StructuredResponseParser.create_system_prompt-240"><a href="#StructuredResponseParser.create_system_prompt-240"><span class="linenos">240</span></a><span class="s2">    &quot;confidence&quot;: 0.95,</span>
</span><span id="StructuredResponseParser.create_system_prompt-241"><a href="#StructuredResponseParser.create_system_prompt-241"><span class="linenos">241</span></a><span class="s2">    &quot;sources&quot;: [&quot;source1&quot;, &quot;source2&quot;],</span>
</span><span id="StructuredResponseParser.create_system_prompt-242"><a href="#StructuredResponseParser.create_system_prompt-242"><span class="linenos">242</span></a><span class="s2">    &quot;reasoning_steps&quot;: [&quot;step1&quot;, &quot;step2&quot;],</span>
</span><span id="StructuredResponseParser.create_system_prompt-243"><a href="#StructuredResponseParser.create_system_prompt-243"><span class="linenos">243</span></a><span class="s2">    &quot;response_type&quot;: &quot;structured&quot;</span>
</span><span id="StructuredResponseParser.create_system_prompt-244"><a href="#StructuredResponseParser.create_system_prompt-244"><span class="linenos">244</span></a><span class="s2">  }</span>
</span><span id="StructuredResponseParser.create_system_prompt-245"><a href="#StructuredResponseParser.create_system_prompt-245"><span class="linenos">245</span></a><span class="s2">}</span>
</span><span id="StructuredResponseParser.create_system_prompt-246"><a href="#StructuredResponseParser.create_system_prompt-246"><span class="linenos">246</span></a>
</span><span id="StructuredResponseParser.create_system_prompt-247"><a href="#StructuredResponseParser.create_system_prompt-247"><span class="linenos">247</span></a><span class="s2">CRITICAL RULES:</span>
</span><span id="StructuredResponseParser.create_system_prompt-248"><a href="#StructuredResponseParser.create_system_prompt-248"><span class="linenos">248</span></a><span class="s2">1. ALWAYS return valid JSON</span>
</span><span id="StructuredResponseParser.create_system_prompt-249"><a href="#StructuredResponseParser.create_system_prompt-249"><span class="linenos">249</span></a><span class="s2">2. The &quot;content&quot; field is required and contains your main response</span>
</span><span id="StructuredResponseParser.create_system_prompt-250"><a href="#StructuredResponseParser.create_system_prompt-250"><span class="linenos">250</span></a><span class="s2">3. Include &quot;tool_calls&quot; array if you need to use any tools</span>
</span><span id="StructuredResponseParser.create_system_prompt-251"><a href="#StructuredResponseParser.create_system_prompt-251"><span class="linenos">251</span></a><span class="s2">4. Add &quot;metadata&quot; with confidence (0.0-1.0) when possible</span>
</span><span id="StructuredResponseParser.create_system_prompt-252"><a href="#StructuredResponseParser.create_system_prompt-252"><span class="linenos">252</span></a><span class="s2">5. List sources in &quot;sources&quot; array when referencing information</span>
</span><span id="StructuredResponseParser.create_system_prompt-253"><a href="#StructuredResponseParser.create_system_prompt-253"><span class="linenos">253</span></a><span class="s2">6. If there&#39;s an error, include an &quot;error&quot; object with &quot;code&quot;, &quot;message&quot;, and &quot;recoverable&quot; fields</span>
</span><span id="StructuredResponseParser.create_system_prompt-254"><a href="#StructuredResponseParser.create_system_prompt-254"><span class="linenos">254</span></a><span class="s2">7. Do not include any text outside the JSON structure</span>
</span><span id="StructuredResponseParser.create_system_prompt-255"><a href="#StructuredResponseParser.create_system_prompt-255"><span class="linenos">255</span></a><span class="s2">&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Create a system prompt that instructs the model to use structured JSON output.</p>

<p>Returns:
    System prompt string</p>
</div>


                            </div>
                </section>
                <section id="ToolCall">
                            <input id="ToolCall-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">ToolCall</span>:

                <label class="view-source-button" for="ToolCall-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ToolCall"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ToolCall-17"><a href="#ToolCall-17"><span class="linenos">17</span></a><span class="nd">@dataclass</span>
</span><span id="ToolCall-18"><a href="#ToolCall-18"><span class="linenos">18</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ToolCall</span><span class="p">:</span>
</span><span id="ToolCall-19"><a href="#ToolCall-19"><span class="linenos">19</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a structured tool call.&quot;&quot;&quot;</span>
</span><span id="ToolCall-20"><a href="#ToolCall-20"><span class="linenos">20</span></a>    <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="ToolCall-21"><a href="#ToolCall-21"><span class="linenos">21</span></a>    <span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="ToolCall-22"><a href="#ToolCall-22"><span class="linenos">22</span></a>    <span class="n">reasoning</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Represents a structured tool call.</p>
</div>


                            <div id="ToolCall.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">ToolCall</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">arguments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">reasoning</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#ToolCall.__init__"></a>
    
    

                            </div>
                            <div id="ToolCall.function_name" class="classattr">
                                <div class="attr variable">
            <span class="name">function_name</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#ToolCall.function_name"></a>
    
    

                            </div>
                            <div id="ToolCall.arguments" class="classattr">
                                <div class="attr variable">
            <span class="name">arguments</span><span class="annotation">: Dict[str, Any]</span>

        
    </div>
    <a class="headerlink" href="#ToolCall.arguments"></a>
    
    

                            </div>
                            <div id="ToolCall.reasoning" class="classattr">
                                <div class="attr variable">
            <span class="name">reasoning</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ToolCall.reasoning"></a>
    
    

                            </div>
                </section>
                <section id="ResponseMetadata">
                            <input id="ResponseMetadata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">ResponseMetadata</span>:

                <label class="view-source-button" for="ResponseMetadata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ResponseMetadata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ResponseMetadata-25"><a href="#ResponseMetadata-25"><span class="linenos">25</span></a><span class="nd">@dataclass</span>
</span><span id="ResponseMetadata-26"><a href="#ResponseMetadata-26"><span class="linenos">26</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ResponseMetadata</span><span class="p">:</span>
</span><span id="ResponseMetadata-27"><a href="#ResponseMetadata-27"><span class="linenos">27</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Metadata associated with a structured response.&quot;&quot;&quot;</span>
</span><span id="ResponseMetadata-28"><a href="#ResponseMetadata-28"><span class="linenos">28</span></a>    <span class="n">confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ResponseMetadata-29"><a href="#ResponseMetadata-29"><span class="linenos">29</span></a>    <span class="n">sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="ResponseMetadata-30"><a href="#ResponseMetadata-30"><span class="linenos">30</span></a>    <span class="n">reasoning_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="ResponseMetadata-31"><a href="#ResponseMetadata-31"><span class="linenos">31</span></a>    <span class="n">response_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;structured&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Metadata associated with a structured response.</p>
</div>


                            <div id="ResponseMetadata.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">ResponseMetadata</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">reasoning_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">response_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;structured&#39;</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#ResponseMetadata.__init__"></a>
    
    

                            </div>
                            <div id="ResponseMetadata.confidence" class="classattr">
                                <div class="attr variable">
            <span class="name">confidence</span><span class="annotation">: Optional[float]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ResponseMetadata.confidence"></a>
    
    

                            </div>
                            <div id="ResponseMetadata.sources" class="classattr">
                                <div class="attr variable">
            <span class="name">sources</span><span class="annotation">: List[str]</span>

        
    </div>
    <a class="headerlink" href="#ResponseMetadata.sources"></a>
    
    

                            </div>
                            <div id="ResponseMetadata.reasoning_steps" class="classattr">
                                <div class="attr variable">
            <span class="name">reasoning_steps</span><span class="annotation">: List[str]</span>

        
    </div>
    <a class="headerlink" href="#ResponseMetadata.reasoning_steps"></a>
    
    

                            </div>
                            <div id="ResponseMetadata.response_type" class="classattr">
                                <div class="attr variable">
            <span class="name">response_type</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;structured&#39;</span>

        
    </div>
    <a class="headerlink" href="#ResponseMetadata.response_type"></a>
    
    

                            </div>
                </section>
                <section id="ResponseError">
                            <input id="ResponseError-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">ResponseError</span>:

                <label class="view-source-button" for="ResponseError-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ResponseError"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ResponseError-34"><a href="#ResponseError-34"><span class="linenos">34</span></a><span class="nd">@dataclass</span>
</span><span id="ResponseError-35"><a href="#ResponseError-35"><span class="linenos">35</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ResponseError</span><span class="p">:</span>
</span><span id="ResponseError-36"><a href="#ResponseError-36"><span class="linenos">36</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Error information in a structured response.&quot;&quot;&quot;</span>
</span><span id="ResponseError-37"><a href="#ResponseError-37"><span class="linenos">37</span></a>    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="ResponseError-38"><a href="#ResponseError-38"><span class="linenos">38</span></a>    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="ResponseError-39"><a href="#ResponseError-39"><span class="linenos">39</span></a>    <span class="n">recoverable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>Error information in a structured response.</p>
</div>


                            <div id="ResponseError.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">ResponseError</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">code</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">message</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">recoverable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#ResponseError.__init__"></a>
    
    

                            </div>
                            <div id="ResponseError.code" class="classattr">
                                <div class="attr variable">
            <span class="name">code</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#ResponseError.code"></a>
    
    

                            </div>
                            <div id="ResponseError.message" class="classattr">
                                <div class="attr variable">
            <span class="name">message</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#ResponseError.message"></a>
    
    

                            </div>
                            <div id="ResponseError.recoverable" class="classattr">
                                <div class="attr variable">
            <span class="name">recoverable</span><span class="annotation">: bool</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#ResponseError.recoverable"></a>
    
    

                            </div>
                </section>
                <section id="get_ollama_format_schema">
                            <input id="get_ollama_format_schema-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_ollama_format_schema</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="get_ollama_format_schema-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_ollama_format_schema"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_ollama_format_schema-258"><a href="#get_ollama_format_schema-258"><span class="linenos">258</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_ollama_format_schema</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="get_ollama_format_schema-259"><a href="#get_ollama_format_schema-259"><span class="linenos">259</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_ollama_format_schema-260"><a href="#get_ollama_format_schema-260"><span class="linenos">260</span></a><span class="sd">    Get the format schema for Ollama structured outputs.</span>
</span><span id="get_ollama_format_schema-261"><a href="#get_ollama_format_schema-261"><span class="linenos">261</span></a><span class="sd">    </span>
</span><span id="get_ollama_format_schema-262"><a href="#get_ollama_format_schema-262"><span class="linenos">262</span></a><span class="sd">    Returns:</span>
</span><span id="get_ollama_format_schema-263"><a href="#get_ollama_format_schema-263"><span class="linenos">263</span></a><span class="sd">        Dictionary containing the JSON schema for Ollama format parameter</span>
</span><span id="get_ollama_format_schema-264"><a href="#get_ollama_format_schema-264"><span class="linenos">264</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_ollama_format_schema-265"><a href="#get_ollama_format_schema-265"><span class="linenos">265</span></a>    <span class="k">return</span> <span class="n">StructuredResponseParser</span><span class="o">.</span><span class="n">RESPONSE_SCHEMA</span>
</span></pre></div>


            <div class="docstring"><p>Get the format schema for Ollama structured outputs.</p>

<p>Returns:
    Dictionary containing the JSON schema for Ollama format parameter</p>
</div>


                </section>
                <section id="create_structured_instructions">
                            <input id="create_structured_instructions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_structured_instructions</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">base_instructions</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="create_structured_instructions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_structured_instructions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_structured_instructions-268"><a href="#create_structured_instructions-268"><span class="linenos">268</span></a><span class="k">def</span><span class="w"> </span><span class="nf">create_structured_instructions</span><span class="p">(</span><span class="n">base_instructions</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="create_structured_instructions-269"><a href="#create_structured_instructions-269"><span class="linenos">269</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="create_structured_instructions-270"><a href="#create_structured_instructions-270"><span class="linenos">270</span></a><span class="sd">    Combine base agent instructions with structured output requirements.</span>
</span><span id="create_structured_instructions-271"><a href="#create_structured_instructions-271"><span class="linenos">271</span></a><span class="sd">    </span>
</span><span id="create_structured_instructions-272"><a href="#create_structured_instructions-272"><span class="linenos">272</span></a><span class="sd">    Args:</span>
</span><span id="create_structured_instructions-273"><a href="#create_structured_instructions-273"><span class="linenos">273</span></a><span class="sd">        base_instructions: Original agent instructions</span>
</span><span id="create_structured_instructions-274"><a href="#create_structured_instructions-274"><span class="linenos">274</span></a><span class="sd">        </span>
</span><span id="create_structured_instructions-275"><a href="#create_structured_instructions-275"><span class="linenos">275</span></a><span class="sd">    Returns:</span>
</span><span id="create_structured_instructions-276"><a href="#create_structured_instructions-276"><span class="linenos">276</span></a><span class="sd">        Enhanced instructions with JSON structure requirements</span>
</span><span id="create_structured_instructions-277"><a href="#create_structured_instructions-277"><span class="linenos">277</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="create_structured_instructions-278"><a href="#create_structured_instructions-278"><span class="linenos">278</span></a>    <span class="n">structured_prompt</span> <span class="o">=</span> <span class="n">StructuredResponseParser</span><span class="o">.</span><span class="n">create_system_prompt</span><span class="p">()</span>
</span><span id="create_structured_instructions-279"><a href="#create_structured_instructions-279"><span class="linenos">279</span></a>    
</span><span id="create_structured_instructions-280"><a href="#create_structured_instructions-280"><span class="linenos">280</span></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="create_structured_instructions-281"><a href="#create_structured_instructions-281"><span class="linenos">281</span></a><span class="si">{</span><span class="n">base_instructions</span><span class="si">}</span>
</span><span id="create_structured_instructions-282"><a href="#create_structured_instructions-282"><span class="linenos">282</span></a>
</span><span id="create_structured_instructions-283"><a href="#create_structured_instructions-283"><span class="linenos">283</span></a><span class="s2">## RESPONSE FORMAT REQUIREMENTS</span>
</span><span id="create_structured_instructions-284"><a href="#create_structured_instructions-284"><span class="linenos">284</span></a>
</span><span id="create_structured_instructions-285"><a href="#create_structured_instructions-285"><span class="linenos">285</span></a><span class="si">{</span><span class="n">structured_prompt</span><span class="si">}</span>
</span><span id="create_structured_instructions-286"><a href="#create_structured_instructions-286"><span class="linenos">286</span></a>
</span><span id="create_structured_instructions-287"><a href="#create_structured_instructions-287"><span class="linenos">287</span></a><span class="s2">Remember: Your response must be valid JSON following the exact schema above. The user will see the &quot;content&quot; field as your main response.</span>
</span><span id="create_structured_instructions-288"><a href="#create_structured_instructions-288"><span class="linenos">288</span></a><span class="s2">&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Combine base agent instructions with structured output requirements.</p>

<p>Args:
    base_instructions: Original agent instructions</p>

<p>Returns:
    Enhanced instructions with JSON structure requirements</p>
</div>


                </section>
                <section id="TopicClassifier">
                            <input id="TopicClassifier-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TopicClassifier</span>:

                <label class="view-source-button" for="TopicClassifier-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TopicClassifier"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TopicClassifier-43"><a href="#TopicClassifier-43"><span class="linenos"> 43</span></a><span class="k">class</span><span class="w"> </span><span class="nc">TopicClassifier</span><span class="p">:</span>
</span><span id="TopicClassifier-44"><a href="#TopicClassifier-44"><span class="linenos"> 44</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="TopicClassifier-45"><a href="#TopicClassifier-45"><span class="linenos"> 45</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="TopicClassifier-46"><a href="#TopicClassifier-46"><span class="linenos"> 46</span></a>        <span class="k">if</span> <span class="n">config_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TopicClassifier-47"><a href="#TopicClassifier-47"><span class="linenos"> 47</span></a>            <span class="c1"># Default to topics.yaml in the same directory as this file</span>
</span><span id="TopicClassifier-48"><a href="#TopicClassifier-48"><span class="linenos"> 48</span></a>            <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="TopicClassifier-49"><a href="#TopicClassifier-49"><span class="linenos"> 49</span></a>            <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s2">&quot;topics.yaml&quot;</span><span class="p">)</span>
</span><span id="TopicClassifier-50"><a href="#TopicClassifier-50"><span class="linenos"> 50</span></a>
</span><span id="TopicClassifier-51"><a href="#TopicClassifier-51"><span class="linenos"> 51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
</span><span id="TopicClassifier-52"><a href="#TopicClassifier-52"><span class="linenos"> 52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stopwords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
</span><span id="TopicClassifier-53"><a href="#TopicClassifier-53"><span class="linenos"> 53</span></a>            <span class="p">[</span>
</span><span id="TopicClassifier-54"><a href="#TopicClassifier-54"><span class="linenos"> 54</span></a>                <span class="s2">&quot;i&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-55"><a href="#TopicClassifier-55"><span class="linenos"> 55</span></a>                <span class="s2">&quot;me&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-56"><a href="#TopicClassifier-56"><span class="linenos"> 56</span></a>                <span class="s2">&quot;my&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-57"><a href="#TopicClassifier-57"><span class="linenos"> 57</span></a>                <span class="s2">&quot;myself&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-58"><a href="#TopicClassifier-58"><span class="linenos"> 58</span></a>                <span class="s2">&quot;we&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-59"><a href="#TopicClassifier-59"><span class="linenos"> 59</span></a>                <span class="s2">&quot;our&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-60"><a href="#TopicClassifier-60"><span class="linenos"> 60</span></a>                <span class="s2">&quot;ours&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-61"><a href="#TopicClassifier-61"><span class="linenos"> 61</span></a>                <span class="s2">&quot;ourselves&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-62"><a href="#TopicClassifier-62"><span class="linenos"> 62</span></a>                <span class="s2">&quot;you&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-63"><a href="#TopicClassifier-63"><span class="linenos"> 63</span></a>                <span class="s2">&quot;your&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-64"><a href="#TopicClassifier-64"><span class="linenos"> 64</span></a>                <span class="s2">&quot;yours&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-65"><a href="#TopicClassifier-65"><span class="linenos"> 65</span></a>                <span class="s2">&quot;yourself&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-66"><a href="#TopicClassifier-66"><span class="linenos"> 66</span></a>                <span class="s2">&quot;yourselves&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-67"><a href="#TopicClassifier-67"><span class="linenos"> 67</span></a>                <span class="s2">&quot;he&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-68"><a href="#TopicClassifier-68"><span class="linenos"> 68</span></a>                <span class="s2">&quot;him&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-69"><a href="#TopicClassifier-69"><span class="linenos"> 69</span></a>                <span class="s2">&quot;his&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-70"><a href="#TopicClassifier-70"><span class="linenos"> 70</span></a>                <span class="s2">&quot;himself&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-71"><a href="#TopicClassifier-71"><span class="linenos"> 71</span></a>                <span class="s2">&quot;she&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-72"><a href="#TopicClassifier-72"><span class="linenos"> 72</span></a>                <span class="s2">&quot;her&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-73"><a href="#TopicClassifier-73"><span class="linenos"> 73</span></a>                <span class="s2">&quot;hers&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-74"><a href="#TopicClassifier-74"><span class="linenos"> 74</span></a>                <span class="s2">&quot;herself&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-75"><a href="#TopicClassifier-75"><span class="linenos"> 75</span></a>                <span class="s2">&quot;it&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-76"><a href="#TopicClassifier-76"><span class="linenos"> 76</span></a>                <span class="s2">&quot;its&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-77"><a href="#TopicClassifier-77"><span class="linenos"> 77</span></a>                <span class="s2">&quot;itself&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-78"><a href="#TopicClassifier-78"><span class="linenos"> 78</span></a>                <span class="s2">&quot;they&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-79"><a href="#TopicClassifier-79"><span class="linenos"> 79</span></a>                <span class="s2">&quot;them&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-80"><a href="#TopicClassifier-80"><span class="linenos"> 80</span></a>                <span class="s2">&quot;their&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-81"><a href="#TopicClassifier-81"><span class="linenos"> 81</span></a>                <span class="s2">&quot;theirs&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-82"><a href="#TopicClassifier-82"><span class="linenos"> 82</span></a>                <span class="s2">&quot;themselves&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-83"><a href="#TopicClassifier-83"><span class="linenos"> 83</span></a>                <span class="s2">&quot;what&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-84"><a href="#TopicClassifier-84"><span class="linenos"> 84</span></a>                <span class="s2">&quot;which&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-85"><a href="#TopicClassifier-85"><span class="linenos"> 85</span></a>                <span class="s2">&quot;who&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-86"><a href="#TopicClassifier-86"><span class="linenos"> 86</span></a>                <span class="s2">&quot;whom&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-87"><a href="#TopicClassifier-87"><span class="linenos"> 87</span></a>                <span class="s2">&quot;this&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-88"><a href="#TopicClassifier-88"><span class="linenos"> 88</span></a>                <span class="s2">&quot;that&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-89"><a href="#TopicClassifier-89"><span class="linenos"> 89</span></a>                <span class="s2">&quot;these&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-90"><a href="#TopicClassifier-90"><span class="linenos"> 90</span></a>                <span class="s2">&quot;those&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-91"><a href="#TopicClassifier-91"><span class="linenos"> 91</span></a>                <span class="s2">&quot;am&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-92"><a href="#TopicClassifier-92"><span class="linenos"> 92</span></a>                <span class="s2">&quot;is&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-93"><a href="#TopicClassifier-93"><span class="linenos"> 93</span></a>                <span class="s2">&quot;are&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-94"><a href="#TopicClassifier-94"><span class="linenos"> 94</span></a>                <span class="s2">&quot;was&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-95"><a href="#TopicClassifier-95"><span class="linenos"> 95</span></a>                <span class="s2">&quot;were&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-96"><a href="#TopicClassifier-96"><span class="linenos"> 96</span></a>                <span class="s2">&quot;be&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-97"><a href="#TopicClassifier-97"><span class="linenos"> 97</span></a>                <span class="s2">&quot;been&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-98"><a href="#TopicClassifier-98"><span class="linenos"> 98</span></a>                <span class="s2">&quot;being&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-99"><a href="#TopicClassifier-99"><span class="linenos"> 99</span></a>                <span class="s2">&quot;have&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-100"><a href="#TopicClassifier-100"><span class="linenos">100</span></a>                <span class="s2">&quot;has&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-101"><a href="#TopicClassifier-101"><span class="linenos">101</span></a>                <span class="s2">&quot;had&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-102"><a href="#TopicClassifier-102"><span class="linenos">102</span></a>                <span class="s2">&quot;having&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-103"><a href="#TopicClassifier-103"><span class="linenos">103</span></a>                <span class="s2">&quot;do&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-104"><a href="#TopicClassifier-104"><span class="linenos">104</span></a>                <span class="s2">&quot;does&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-105"><a href="#TopicClassifier-105"><span class="linenos">105</span></a>                <span class="s2">&quot;did&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-106"><a href="#TopicClassifier-106"><span class="linenos">106</span></a>                <span class="s2">&quot;doing&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-107"><a href="#TopicClassifier-107"><span class="linenos">107</span></a>                <span class="s2">&quot;a&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-108"><a href="#TopicClassifier-108"><span class="linenos">108</span></a>                <span class="s2">&quot;an&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-109"><a href="#TopicClassifier-109"><span class="linenos">109</span></a>                <span class="s2">&quot;the&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-110"><a href="#TopicClassifier-110"><span class="linenos">110</span></a>                <span class="s2">&quot;and&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-111"><a href="#TopicClassifier-111"><span class="linenos">111</span></a>                <span class="s2">&quot;but&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-112"><a href="#TopicClassifier-112"><span class="linenos">112</span></a>                <span class="s2">&quot;if&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-113"><a href="#TopicClassifier-113"><span class="linenos">113</span></a>                <span class="s2">&quot;or&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-114"><a href="#TopicClassifier-114"><span class="linenos">114</span></a>                <span class="s2">&quot;because&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-115"><a href="#TopicClassifier-115"><span class="linenos">115</span></a>                <span class="s2">&quot;as&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-116"><a href="#TopicClassifier-116"><span class="linenos">116</span></a>                <span class="s2">&quot;until&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-117"><a href="#TopicClassifier-117"><span class="linenos">117</span></a>                <span class="s2">&quot;while&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-118"><a href="#TopicClassifier-118"><span class="linenos">118</span></a>                <span class="s2">&quot;of&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-119"><a href="#TopicClassifier-119"><span class="linenos">119</span></a>                <span class="s2">&quot;at&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-120"><a href="#TopicClassifier-120"><span class="linenos">120</span></a>                <span class="s2">&quot;by&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-121"><a href="#TopicClassifier-121"><span class="linenos">121</span></a>                <span class="s2">&quot;for&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-122"><a href="#TopicClassifier-122"><span class="linenos">122</span></a>                <span class="s2">&quot;with&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-123"><a href="#TopicClassifier-123"><span class="linenos">123</span></a>                <span class="s2">&quot;through&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-124"><a href="#TopicClassifier-124"><span class="linenos">124</span></a>                <span class="s2">&quot;during&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-125"><a href="#TopicClassifier-125"><span class="linenos">125</span></a>                <span class="s2">&quot;before&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-126"><a href="#TopicClassifier-126"><span class="linenos">126</span></a>                <span class="s2">&quot;after&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-127"><a href="#TopicClassifier-127"><span class="linenos">127</span></a>                <span class="s2">&quot;above&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-128"><a href="#TopicClassifier-128"><span class="linenos">128</span></a>                <span class="s2">&quot;below&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-129"><a href="#TopicClassifier-129"><span class="linenos">129</span></a>                <span class="s2">&quot;up&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-130"><a href="#TopicClassifier-130"><span class="linenos">130</span></a>                <span class="s2">&quot;down&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-131"><a href="#TopicClassifier-131"><span class="linenos">131</span></a>                <span class="s2">&quot;in&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-132"><a href="#TopicClassifier-132"><span class="linenos">132</span></a>                <span class="s2">&quot;out&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-133"><a href="#TopicClassifier-133"><span class="linenos">133</span></a>                <span class="s2">&quot;on&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-134"><a href="#TopicClassifier-134"><span class="linenos">134</span></a>                <span class="s2">&quot;off&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-135"><a href="#TopicClassifier-135"><span class="linenos">135</span></a>                <span class="s2">&quot;over&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-136"><a href="#TopicClassifier-136"><span class="linenos">136</span></a>                <span class="s2">&quot;under&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-137"><a href="#TopicClassifier-137"><span class="linenos">137</span></a>                <span class="s2">&quot;again&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-138"><a href="#TopicClassifier-138"><span class="linenos">138</span></a>                <span class="s2">&quot;further&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-139"><a href="#TopicClassifier-139"><span class="linenos">139</span></a>                <span class="s2">&quot;then&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-140"><a href="#TopicClassifier-140"><span class="linenos">140</span></a>                <span class="s2">&quot;once&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier-141"><a href="#TopicClassifier-141"><span class="linenos">141</span></a>            <span class="p">]</span>
</span><span id="TopicClassifier-142"><a href="#TopicClassifier-142"><span class="linenos">142</span></a>        <span class="p">)</span>
</span><span id="TopicClassifier-143"><a href="#TopicClassifier-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="TopicClassifier-144"><a href="#TopicClassifier-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keyword_weight</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="TopicClassifier-145"><a href="#TopicClassifier-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">phrase_weight</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="TopicClassifier-146"><a href="#TopicClassifier-146"><span class="linenos">146</span></a>
</span><span id="TopicClassifier-147"><a href="#TopicClassifier-147"><span class="linenos">147</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">):</span>
</span><span id="TopicClassifier-148"><a href="#TopicClassifier-148"><span class="linenos">148</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="TopicClassifier-149"><a href="#TopicClassifier-149"><span class="linenos">149</span></a>            <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="TopicClassifier-150"><a href="#TopicClassifier-150"><span class="linenos">150</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;categories&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="TopicClassifier-151"><a href="#TopicClassifier-151"><span class="linenos">151</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">phrases</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phrases&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="TopicClassifier-152"><a href="#TopicClassifier-152"><span class="linenos">152</span></a>
</span><span id="TopicClassifier-153"><a href="#TopicClassifier-153"><span class="linenos">153</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clean_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
</span><span id="TopicClassifier-154"><a href="#TopicClassifier-154"><span class="linenos">154</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="TopicClassifier-155"><a href="#TopicClassifier-155"><span class="linenos">155</span></a>        <span class="c1"># Expand common contractions</span>
</span><span id="TopicClassifier-156"><a href="#TopicClassifier-156"><span class="linenos">156</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;i&#39;m&quot;</span><span class="p">,</span> <span class="s2">&quot;i am&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-157"><a href="#TopicClassifier-157"><span class="linenos">157</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you&#39;re&quot;</span><span class="p">,</span> <span class="s2">&quot;you are&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-158"><a href="#TopicClassifier-158"><span class="linenos">158</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;he&#39;s&quot;</span><span class="p">,</span> <span class="s2">&quot;he is&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-159"><a href="#TopicClassifier-159"><span class="linenos">159</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;she&#39;s&quot;</span><span class="p">,</span> <span class="s2">&quot;she is&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-160"><a href="#TopicClassifier-160"><span class="linenos">160</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;it&#39;s&quot;</span><span class="p">,</span> <span class="s2">&quot;it is&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-161"><a href="#TopicClassifier-161"><span class="linenos">161</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;we&#39;re&quot;</span><span class="p">,</span> <span class="s2">&quot;we are&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-162"><a href="#TopicClassifier-162"><span class="linenos">162</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;they&#39;re&quot;</span><span class="p">,</span> <span class="s2">&quot;they are&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-163"><a href="#TopicClassifier-163"><span class="linenos">163</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;cannot&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-164"><a href="#TopicClassifier-164"><span class="linenos">164</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;won&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;will not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-165"><a href="#TopicClassifier-165"><span class="linenos">165</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;don&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;do not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-166"><a href="#TopicClassifier-166"><span class="linenos">166</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;doesn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;does not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-167"><a href="#TopicClassifier-167"><span class="linenos">167</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;didn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;did not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-168"><a href="#TopicClassifier-168"><span class="linenos">168</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;isn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;is not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-169"><a href="#TopicClassifier-169"><span class="linenos">169</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;aren&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;are not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-170"><a href="#TopicClassifier-170"><span class="linenos">170</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;wasn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;was not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-171"><a href="#TopicClassifier-171"><span class="linenos">171</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;weren&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;were not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-172"><a href="#TopicClassifier-172"><span class="linenos">172</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;haven&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;have not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-173"><a href="#TopicClassifier-173"><span class="linenos">173</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;hasn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;has not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-174"><a href="#TopicClassifier-174"><span class="linenos">174</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;hadn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;had not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-175"><a href="#TopicClassifier-175"><span class="linenos">175</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;wouldn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;would not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-176"><a href="#TopicClassifier-176"><span class="linenos">176</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;shouldn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;should not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-177"><a href="#TopicClassifier-177"><span class="linenos">177</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;couldn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;could not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-178"><a href="#TopicClassifier-178"><span class="linenos">178</span></a>
</span><span id="TopicClassifier-179"><a href="#TopicClassifier-179"><span class="linenos">179</span></a>        <span class="c1"># Preserve special characters relevant to programming languages (e.g., C++, C#)</span>
</span><span id="TopicClassifier-180"><a href="#TopicClassifier-180"><span class="linenos">180</span></a>        <span class="c1"># and remove other non-alphanumeric characters, but keep spaces.</span>
</span><span id="TopicClassifier-181"><a href="#TopicClassifier-181"><span class="linenos">181</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-z0-9#+\s]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-182"><a href="#TopicClassifier-182"><span class="linenos">182</span></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span id="TopicClassifier-183"><a href="#TopicClassifier-183"><span class="linenos">183</span></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopwords</span><span class="p">]</span>
</span><span id="TopicClassifier-184"><a href="#TopicClassifier-184"><span class="linenos">184</span></a>        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span id="TopicClassifier-185"><a href="#TopicClassifier-185"><span class="linenos">185</span></a>
</span><span id="TopicClassifier-186"><a href="#TopicClassifier-186"><span class="linenos">186</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">classify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">return_list</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="TopicClassifier-187"><a href="#TopicClassifier-187"><span class="linenos">187</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TopicClassifier-188"><a href="#TopicClassifier-188"><span class="linenos">188</span></a><span class="sd">        Classify the topic(s) of a given text.</span>
</span><span id="TopicClassifier-189"><a href="#TopicClassifier-189"><span class="linenos">189</span></a>
</span><span id="TopicClassifier-190"><a href="#TopicClassifier-190"><span class="linenos">190</span></a><span class="sd">        Args:</span>
</span><span id="TopicClassifier-191"><a href="#TopicClassifier-191"><span class="linenos">191</span></a><span class="sd">            text (str): Text to classify</span>
</span><span id="TopicClassifier-192"><a href="#TopicClassifier-192"><span class="linenos">192</span></a><span class="sd">            return_list (bool): If True, returns list of topic names only.</span>
</span><span id="TopicClassifier-193"><a href="#TopicClassifier-193"><span class="linenos">193</span></a><span class="sd">                               If False, returns dict with confidence scores.</span>
</span><span id="TopicClassifier-194"><a href="#TopicClassifier-194"><span class="linenos">194</span></a>
</span><span id="TopicClassifier-195"><a href="#TopicClassifier-195"><span class="linenos">195</span></a><span class="sd">        Returns:</span>
</span><span id="TopicClassifier-196"><a href="#TopicClassifier-196"><span class="linenos">196</span></a><span class="sd">            Union[List[str], Dict[str, float]]: Topic classification results</span>
</span><span id="TopicClassifier-197"><a href="#TopicClassifier-197"><span class="linenos">197</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TopicClassifier-198"><a href="#TopicClassifier-198"><span class="linenos">198</span></a>        <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier-199"><a href="#TopicClassifier-199"><span class="linenos">199</span></a>        <span class="n">cleaned_words</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span id="TopicClassifier-200"><a href="#TopicClassifier-200"><span class="linenos">200</span></a>        <span class="n">raw_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">category</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="p">}</span>
</span><span id="TopicClassifier-201"><a href="#TopicClassifier-201"><span class="linenos">201</span></a>
</span><span id="TopicClassifier-202"><a href="#TopicClassifier-202"><span class="linenos">202</span></a>        <span class="c1"># Check phrases first (higher weight)</span>
</span><span id="TopicClassifier-203"><a href="#TopicClassifier-203"><span class="linenos">203</span></a>        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">phrases</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="TopicClassifier-204"><a href="#TopicClassifier-204"><span class="linenos">204</span></a>            <span class="k">if</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">raw_scores</span><span class="p">:</span>  <span class="c1"># Make sure category exists in raw_scores</span>
</span><span id="TopicClassifier-205"><a href="#TopicClassifier-205"><span class="linenos">205</span></a>                <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="n">phrases</span><span class="p">:</span>
</span><span id="TopicClassifier-206"><a href="#TopicClassifier-206"><span class="linenos">206</span></a>                    <span class="k">if</span> <span class="n">phrase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">cleaned</span><span class="p">:</span>
</span><span id="TopicClassifier-207"><a href="#TopicClassifier-207"><span class="linenos">207</span></a>                        <span class="n">raw_scores</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase_weight</span>
</span><span id="TopicClassifier-208"><a href="#TopicClassifier-208"><span class="linenos">208</span></a>
</span><span id="TopicClassifier-209"><a href="#TopicClassifier-209"><span class="linenos">209</span></a>        <span class="c1"># Check individual keywords with whole word matching</span>
</span><span id="TopicClassifier-210"><a href="#TopicClassifier-210"><span class="linenos">210</span></a>        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">keywords</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="TopicClassifier-211"><a href="#TopicClassifier-211"><span class="linenos">211</span></a>            <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
</span><span id="TopicClassifier-212"><a href="#TopicClassifier-212"><span class="linenos">212</span></a>                <span class="n">keyword_lower</span> <span class="o">=</span> <span class="n">keyword</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="TopicClassifier-213"><a href="#TopicClassifier-213"><span class="linenos">213</span></a>                <span class="c1"># Use whole word matching to avoid partial matches like &quot;ai&quot; in &quot;hiking&quot;</span>
</span><span id="TopicClassifier-214"><a href="#TopicClassifier-214"><span class="linenos">214</span></a>                <span class="k">if</span> <span class="n">keyword_lower</span> <span class="ow">in</span> <span class="n">cleaned_words</span><span class="p">:</span>
</span><span id="TopicClassifier-215"><a href="#TopicClassifier-215"><span class="linenos">215</span></a>                    <span class="n">raw_scores</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyword_weight</span>
</span><span id="TopicClassifier-216"><a href="#TopicClassifier-216"><span class="linenos">216</span></a>                <span class="c1"># Also check for exact phrase matches for multi-word keywords</span>
</span><span id="TopicClassifier-217"><a href="#TopicClassifier-217"><span class="linenos">217</span></a>                <span class="k">elif</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">keyword_lower</span> <span class="ow">and</span> <span class="n">keyword_lower</span> <span class="ow">in</span> <span class="n">cleaned</span><span class="p">:</span>
</span><span id="TopicClassifier-218"><a href="#TopicClassifier-218"><span class="linenos">218</span></a>                    <span class="n">raw_scores</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyword_weight</span>
</span><span id="TopicClassifier-219"><a href="#TopicClassifier-219"><span class="linenos">219</span></a>
</span><span id="TopicClassifier-220"><a href="#TopicClassifier-220"><span class="linenos">220</span></a>        <span class="n">total_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">raw_scores</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="TopicClassifier-221"><a href="#TopicClassifier-221"><span class="linenos">221</span></a>        <span class="k">if</span> <span class="n">total_score</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TopicClassifier-222"><a href="#TopicClassifier-222"><span class="linenos">222</span></a>            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;unknown&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">return_list</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;unknown&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
</span><span id="TopicClassifier-223"><a href="#TopicClassifier-223"><span class="linenos">223</span></a>
</span><span id="TopicClassifier-224"><a href="#TopicClassifier-224"><span class="linenos">224</span></a>        <span class="n">normalized_scores</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TopicClassifier-225"><a href="#TopicClassifier-225"><span class="linenos">225</span></a>            <span class="n">cat</span><span class="p">:</span> <span class="n">score</span> <span class="o">/</span> <span class="n">total_score</span> <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">raw_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="TopicClassifier-226"><a href="#TopicClassifier-226"><span class="linenos">226</span></a>        <span class="p">}</span>
</span><span id="TopicClassifier-227"><a href="#TopicClassifier-227"><span class="linenos">227</span></a>        <span class="n">high_confidence</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TopicClassifier-228"><a href="#TopicClassifier-228"><span class="linenos">228</span></a>            <span class="n">cat</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="TopicClassifier-229"><a href="#TopicClassifier-229"><span class="linenos">229</span></a>            <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">normalized_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="TopicClassifier-230"><a href="#TopicClassifier-230"><span class="linenos">230</span></a>            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span>
</span><span id="TopicClassifier-231"><a href="#TopicClassifier-231"><span class="linenos">231</span></a>        <span class="p">}</span>
</span><span id="TopicClassifier-232"><a href="#TopicClassifier-232"><span class="linenos">232</span></a>
</span><span id="TopicClassifier-233"><a href="#TopicClassifier-233"><span class="linenos">233</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">high_confidence</span><span class="p">:</span>
</span><span id="TopicClassifier-234"><a href="#TopicClassifier-234"><span class="linenos">234</span></a>            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;unknown&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">return_list</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;unknown&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
</span><span id="TopicClassifier-235"><a href="#TopicClassifier-235"><span class="linenos">235</span></a>
</span><span id="TopicClassifier-236"><a href="#TopicClassifier-236"><span class="linenos">236</span></a>        <span class="k">if</span> <span class="n">return_list</span><span class="p">:</span>
</span><span id="TopicClassifier-237"><a href="#TopicClassifier-237"><span class="linenos">237</span></a>            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">high_confidence</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="TopicClassifier-238"><a href="#TopicClassifier-238"><span class="linenos">238</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TopicClassifier-239"><a href="#TopicClassifier-239"><span class="linenos">239</span></a>            <span class="k">return</span> <span class="n">high_confidence</span>
</span></pre></div>


    

                            <div id="TopicClassifier.__init__" class="classattr">
                                        <input id="TopicClassifier.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TopicClassifier</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">config_path</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="TopicClassifier.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TopicClassifier.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TopicClassifier.__init__-44"><a href="#TopicClassifier.__init__-44"><span class="linenos"> 44</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="TopicClassifier.__init__-45"><a href="#TopicClassifier.__init__-45"><span class="linenos"> 45</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="TopicClassifier.__init__-46"><a href="#TopicClassifier.__init__-46"><span class="linenos"> 46</span></a>        <span class="k">if</span> <span class="n">config_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TopicClassifier.__init__-47"><a href="#TopicClassifier.__init__-47"><span class="linenos"> 47</span></a>            <span class="c1"># Default to topics.yaml in the same directory as this file</span>
</span><span id="TopicClassifier.__init__-48"><a href="#TopicClassifier.__init__-48"><span class="linenos"> 48</span></a>            <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="TopicClassifier.__init__-49"><a href="#TopicClassifier.__init__-49"><span class="linenos"> 49</span></a>            <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s2">&quot;topics.yaml&quot;</span><span class="p">)</span>
</span><span id="TopicClassifier.__init__-50"><a href="#TopicClassifier.__init__-50"><span class="linenos"> 50</span></a>
</span><span id="TopicClassifier.__init__-51"><a href="#TopicClassifier.__init__-51"><span class="linenos"> 51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
</span><span id="TopicClassifier.__init__-52"><a href="#TopicClassifier.__init__-52"><span class="linenos"> 52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stopwords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
</span><span id="TopicClassifier.__init__-53"><a href="#TopicClassifier.__init__-53"><span class="linenos"> 53</span></a>            <span class="p">[</span>
</span><span id="TopicClassifier.__init__-54"><a href="#TopicClassifier.__init__-54"><span class="linenos"> 54</span></a>                <span class="s2">&quot;i&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-55"><a href="#TopicClassifier.__init__-55"><span class="linenos"> 55</span></a>                <span class="s2">&quot;me&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-56"><a href="#TopicClassifier.__init__-56"><span class="linenos"> 56</span></a>                <span class="s2">&quot;my&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-57"><a href="#TopicClassifier.__init__-57"><span class="linenos"> 57</span></a>                <span class="s2">&quot;myself&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-58"><a href="#TopicClassifier.__init__-58"><span class="linenos"> 58</span></a>                <span class="s2">&quot;we&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-59"><a href="#TopicClassifier.__init__-59"><span class="linenos"> 59</span></a>                <span class="s2">&quot;our&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-60"><a href="#TopicClassifier.__init__-60"><span class="linenos"> 60</span></a>                <span class="s2">&quot;ours&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-61"><a href="#TopicClassifier.__init__-61"><span class="linenos"> 61</span></a>                <span class="s2">&quot;ourselves&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-62"><a href="#TopicClassifier.__init__-62"><span class="linenos"> 62</span></a>                <span class="s2">&quot;you&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-63"><a href="#TopicClassifier.__init__-63"><span class="linenos"> 63</span></a>                <span class="s2">&quot;your&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-64"><a href="#TopicClassifier.__init__-64"><span class="linenos"> 64</span></a>                <span class="s2">&quot;yours&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-65"><a href="#TopicClassifier.__init__-65"><span class="linenos"> 65</span></a>                <span class="s2">&quot;yourself&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-66"><a href="#TopicClassifier.__init__-66"><span class="linenos"> 66</span></a>                <span class="s2">&quot;yourselves&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-67"><a href="#TopicClassifier.__init__-67"><span class="linenos"> 67</span></a>                <span class="s2">&quot;he&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-68"><a href="#TopicClassifier.__init__-68"><span class="linenos"> 68</span></a>                <span class="s2">&quot;him&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-69"><a href="#TopicClassifier.__init__-69"><span class="linenos"> 69</span></a>                <span class="s2">&quot;his&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-70"><a href="#TopicClassifier.__init__-70"><span class="linenos"> 70</span></a>                <span class="s2">&quot;himself&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-71"><a href="#TopicClassifier.__init__-71"><span class="linenos"> 71</span></a>                <span class="s2">&quot;she&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-72"><a href="#TopicClassifier.__init__-72"><span class="linenos"> 72</span></a>                <span class="s2">&quot;her&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-73"><a href="#TopicClassifier.__init__-73"><span class="linenos"> 73</span></a>                <span class="s2">&quot;hers&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-74"><a href="#TopicClassifier.__init__-74"><span class="linenos"> 74</span></a>                <span class="s2">&quot;herself&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-75"><a href="#TopicClassifier.__init__-75"><span class="linenos"> 75</span></a>                <span class="s2">&quot;it&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-76"><a href="#TopicClassifier.__init__-76"><span class="linenos"> 76</span></a>                <span class="s2">&quot;its&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-77"><a href="#TopicClassifier.__init__-77"><span class="linenos"> 77</span></a>                <span class="s2">&quot;itself&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-78"><a href="#TopicClassifier.__init__-78"><span class="linenos"> 78</span></a>                <span class="s2">&quot;they&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-79"><a href="#TopicClassifier.__init__-79"><span class="linenos"> 79</span></a>                <span class="s2">&quot;them&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-80"><a href="#TopicClassifier.__init__-80"><span class="linenos"> 80</span></a>                <span class="s2">&quot;their&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-81"><a href="#TopicClassifier.__init__-81"><span class="linenos"> 81</span></a>                <span class="s2">&quot;theirs&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-82"><a href="#TopicClassifier.__init__-82"><span class="linenos"> 82</span></a>                <span class="s2">&quot;themselves&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-83"><a href="#TopicClassifier.__init__-83"><span class="linenos"> 83</span></a>                <span class="s2">&quot;what&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-84"><a href="#TopicClassifier.__init__-84"><span class="linenos"> 84</span></a>                <span class="s2">&quot;which&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-85"><a href="#TopicClassifier.__init__-85"><span class="linenos"> 85</span></a>                <span class="s2">&quot;who&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-86"><a href="#TopicClassifier.__init__-86"><span class="linenos"> 86</span></a>                <span class="s2">&quot;whom&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-87"><a href="#TopicClassifier.__init__-87"><span class="linenos"> 87</span></a>                <span class="s2">&quot;this&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-88"><a href="#TopicClassifier.__init__-88"><span class="linenos"> 88</span></a>                <span class="s2">&quot;that&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-89"><a href="#TopicClassifier.__init__-89"><span class="linenos"> 89</span></a>                <span class="s2">&quot;these&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-90"><a href="#TopicClassifier.__init__-90"><span class="linenos"> 90</span></a>                <span class="s2">&quot;those&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-91"><a href="#TopicClassifier.__init__-91"><span class="linenos"> 91</span></a>                <span class="s2">&quot;am&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-92"><a href="#TopicClassifier.__init__-92"><span class="linenos"> 92</span></a>                <span class="s2">&quot;is&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-93"><a href="#TopicClassifier.__init__-93"><span class="linenos"> 93</span></a>                <span class="s2">&quot;are&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-94"><a href="#TopicClassifier.__init__-94"><span class="linenos"> 94</span></a>                <span class="s2">&quot;was&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-95"><a href="#TopicClassifier.__init__-95"><span class="linenos"> 95</span></a>                <span class="s2">&quot;were&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-96"><a href="#TopicClassifier.__init__-96"><span class="linenos"> 96</span></a>                <span class="s2">&quot;be&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-97"><a href="#TopicClassifier.__init__-97"><span class="linenos"> 97</span></a>                <span class="s2">&quot;been&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-98"><a href="#TopicClassifier.__init__-98"><span class="linenos"> 98</span></a>                <span class="s2">&quot;being&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-99"><a href="#TopicClassifier.__init__-99"><span class="linenos"> 99</span></a>                <span class="s2">&quot;have&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-100"><a href="#TopicClassifier.__init__-100"><span class="linenos">100</span></a>                <span class="s2">&quot;has&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-101"><a href="#TopicClassifier.__init__-101"><span class="linenos">101</span></a>                <span class="s2">&quot;had&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-102"><a href="#TopicClassifier.__init__-102"><span class="linenos">102</span></a>                <span class="s2">&quot;having&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-103"><a href="#TopicClassifier.__init__-103"><span class="linenos">103</span></a>                <span class="s2">&quot;do&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-104"><a href="#TopicClassifier.__init__-104"><span class="linenos">104</span></a>                <span class="s2">&quot;does&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-105"><a href="#TopicClassifier.__init__-105"><span class="linenos">105</span></a>                <span class="s2">&quot;did&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-106"><a href="#TopicClassifier.__init__-106"><span class="linenos">106</span></a>                <span class="s2">&quot;doing&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-107"><a href="#TopicClassifier.__init__-107"><span class="linenos">107</span></a>                <span class="s2">&quot;a&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-108"><a href="#TopicClassifier.__init__-108"><span class="linenos">108</span></a>                <span class="s2">&quot;an&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-109"><a href="#TopicClassifier.__init__-109"><span class="linenos">109</span></a>                <span class="s2">&quot;the&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-110"><a href="#TopicClassifier.__init__-110"><span class="linenos">110</span></a>                <span class="s2">&quot;and&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-111"><a href="#TopicClassifier.__init__-111"><span class="linenos">111</span></a>                <span class="s2">&quot;but&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-112"><a href="#TopicClassifier.__init__-112"><span class="linenos">112</span></a>                <span class="s2">&quot;if&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-113"><a href="#TopicClassifier.__init__-113"><span class="linenos">113</span></a>                <span class="s2">&quot;or&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-114"><a href="#TopicClassifier.__init__-114"><span class="linenos">114</span></a>                <span class="s2">&quot;because&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-115"><a href="#TopicClassifier.__init__-115"><span class="linenos">115</span></a>                <span class="s2">&quot;as&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-116"><a href="#TopicClassifier.__init__-116"><span class="linenos">116</span></a>                <span class="s2">&quot;until&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-117"><a href="#TopicClassifier.__init__-117"><span class="linenos">117</span></a>                <span class="s2">&quot;while&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-118"><a href="#TopicClassifier.__init__-118"><span class="linenos">118</span></a>                <span class="s2">&quot;of&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-119"><a href="#TopicClassifier.__init__-119"><span class="linenos">119</span></a>                <span class="s2">&quot;at&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-120"><a href="#TopicClassifier.__init__-120"><span class="linenos">120</span></a>                <span class="s2">&quot;by&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-121"><a href="#TopicClassifier.__init__-121"><span class="linenos">121</span></a>                <span class="s2">&quot;for&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-122"><a href="#TopicClassifier.__init__-122"><span class="linenos">122</span></a>                <span class="s2">&quot;with&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-123"><a href="#TopicClassifier.__init__-123"><span class="linenos">123</span></a>                <span class="s2">&quot;through&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-124"><a href="#TopicClassifier.__init__-124"><span class="linenos">124</span></a>                <span class="s2">&quot;during&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-125"><a href="#TopicClassifier.__init__-125"><span class="linenos">125</span></a>                <span class="s2">&quot;before&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-126"><a href="#TopicClassifier.__init__-126"><span class="linenos">126</span></a>                <span class="s2">&quot;after&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-127"><a href="#TopicClassifier.__init__-127"><span class="linenos">127</span></a>                <span class="s2">&quot;above&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-128"><a href="#TopicClassifier.__init__-128"><span class="linenos">128</span></a>                <span class="s2">&quot;below&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-129"><a href="#TopicClassifier.__init__-129"><span class="linenos">129</span></a>                <span class="s2">&quot;up&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-130"><a href="#TopicClassifier.__init__-130"><span class="linenos">130</span></a>                <span class="s2">&quot;down&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-131"><a href="#TopicClassifier.__init__-131"><span class="linenos">131</span></a>                <span class="s2">&quot;in&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-132"><a href="#TopicClassifier.__init__-132"><span class="linenos">132</span></a>                <span class="s2">&quot;out&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-133"><a href="#TopicClassifier.__init__-133"><span class="linenos">133</span></a>                <span class="s2">&quot;on&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-134"><a href="#TopicClassifier.__init__-134"><span class="linenos">134</span></a>                <span class="s2">&quot;off&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-135"><a href="#TopicClassifier.__init__-135"><span class="linenos">135</span></a>                <span class="s2">&quot;over&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-136"><a href="#TopicClassifier.__init__-136"><span class="linenos">136</span></a>                <span class="s2">&quot;under&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-137"><a href="#TopicClassifier.__init__-137"><span class="linenos">137</span></a>                <span class="s2">&quot;again&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-138"><a href="#TopicClassifier.__init__-138"><span class="linenos">138</span></a>                <span class="s2">&quot;further&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-139"><a href="#TopicClassifier.__init__-139"><span class="linenos">139</span></a>                <span class="s2">&quot;then&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-140"><a href="#TopicClassifier.__init__-140"><span class="linenos">140</span></a>                <span class="s2">&quot;once&quot;</span><span class="p">,</span>
</span><span id="TopicClassifier.__init__-141"><a href="#TopicClassifier.__init__-141"><span class="linenos">141</span></a>            <span class="p">]</span>
</span><span id="TopicClassifier.__init__-142"><a href="#TopicClassifier.__init__-142"><span class="linenos">142</span></a>        <span class="p">)</span>
</span><span id="TopicClassifier.__init__-143"><a href="#TopicClassifier.__init__-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="TopicClassifier.__init__-144"><a href="#TopicClassifier.__init__-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keyword_weight</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="TopicClassifier.__init__-145"><a href="#TopicClassifier.__init__-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">phrase_weight</span> <span class="o">=</span> <span class="mi">3</span>
</span></pre></div>


    

                            </div>
                            <div id="TopicClassifier.stopwords" class="classattr">
                                <div class="attr variable">
            <span class="name">stopwords</span>

        
    </div>
    <a class="headerlink" href="#TopicClassifier.stopwords"></a>
    
    

                            </div>
                            <div id="TopicClassifier.confidence_threshold" class="classattr">
                                <div class="attr variable">
            <span class="name">confidence_threshold</span>

        
    </div>
    <a class="headerlink" href="#TopicClassifier.confidence_threshold"></a>
    
    

                            </div>
                            <div id="TopicClassifier.keyword_weight" class="classattr">
                                <div class="attr variable">
            <span class="name">keyword_weight</span>

        
    </div>
    <a class="headerlink" href="#TopicClassifier.keyword_weight"></a>
    
    

                            </div>
                            <div id="TopicClassifier.phrase_weight" class="classattr">
                                <div class="attr variable">
            <span class="name">phrase_weight</span>

        
    </div>
    <a class="headerlink" href="#TopicClassifier.phrase_weight"></a>
    
    

                            </div>
                            <div id="TopicClassifier.load_config" class="classattr">
                                        <input id="TopicClassifier.load_config-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_config</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">config_path</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TopicClassifier.load_config-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TopicClassifier.load_config"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TopicClassifier.load_config-147"><a href="#TopicClassifier.load_config-147"><span class="linenos">147</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">):</span>
</span><span id="TopicClassifier.load_config-148"><a href="#TopicClassifier.load_config-148"><span class="linenos">148</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="TopicClassifier.load_config-149"><a href="#TopicClassifier.load_config-149"><span class="linenos">149</span></a>            <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="TopicClassifier.load_config-150"><a href="#TopicClassifier.load_config-150"><span class="linenos">150</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;categories&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="TopicClassifier.load_config-151"><a href="#TopicClassifier.load_config-151"><span class="linenos">151</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">phrases</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phrases&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span></pre></div>


    

                            </div>
                            <div id="TopicClassifier.clean_text" class="classattr">
                                        <input id="TopicClassifier.clean_text-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clean_text</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">text</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TopicClassifier.clean_text-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TopicClassifier.clean_text"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TopicClassifier.clean_text-153"><a href="#TopicClassifier.clean_text-153"><span class="linenos">153</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clean_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
</span><span id="TopicClassifier.clean_text-154"><a href="#TopicClassifier.clean_text-154"><span class="linenos">154</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="TopicClassifier.clean_text-155"><a href="#TopicClassifier.clean_text-155"><span class="linenos">155</span></a>        <span class="c1"># Expand common contractions</span>
</span><span id="TopicClassifier.clean_text-156"><a href="#TopicClassifier.clean_text-156"><span class="linenos">156</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;i&#39;m&quot;</span><span class="p">,</span> <span class="s2">&quot;i am&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-157"><a href="#TopicClassifier.clean_text-157"><span class="linenos">157</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you&#39;re&quot;</span><span class="p">,</span> <span class="s2">&quot;you are&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-158"><a href="#TopicClassifier.clean_text-158"><span class="linenos">158</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;he&#39;s&quot;</span><span class="p">,</span> <span class="s2">&quot;he is&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-159"><a href="#TopicClassifier.clean_text-159"><span class="linenos">159</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;she&#39;s&quot;</span><span class="p">,</span> <span class="s2">&quot;she is&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-160"><a href="#TopicClassifier.clean_text-160"><span class="linenos">160</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;it&#39;s&quot;</span><span class="p">,</span> <span class="s2">&quot;it is&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-161"><a href="#TopicClassifier.clean_text-161"><span class="linenos">161</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;we&#39;re&quot;</span><span class="p">,</span> <span class="s2">&quot;we are&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-162"><a href="#TopicClassifier.clean_text-162"><span class="linenos">162</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;they&#39;re&quot;</span><span class="p">,</span> <span class="s2">&quot;they are&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-163"><a href="#TopicClassifier.clean_text-163"><span class="linenos">163</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;cannot&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-164"><a href="#TopicClassifier.clean_text-164"><span class="linenos">164</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;won&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;will not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-165"><a href="#TopicClassifier.clean_text-165"><span class="linenos">165</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;don&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;do not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-166"><a href="#TopicClassifier.clean_text-166"><span class="linenos">166</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;doesn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;does not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-167"><a href="#TopicClassifier.clean_text-167"><span class="linenos">167</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;didn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;did not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-168"><a href="#TopicClassifier.clean_text-168"><span class="linenos">168</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;isn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;is not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-169"><a href="#TopicClassifier.clean_text-169"><span class="linenos">169</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;aren&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;are not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-170"><a href="#TopicClassifier.clean_text-170"><span class="linenos">170</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;wasn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;was not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-171"><a href="#TopicClassifier.clean_text-171"><span class="linenos">171</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;weren&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;were not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-172"><a href="#TopicClassifier.clean_text-172"><span class="linenos">172</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;haven&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;have not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-173"><a href="#TopicClassifier.clean_text-173"><span class="linenos">173</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;hasn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;has not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-174"><a href="#TopicClassifier.clean_text-174"><span class="linenos">174</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;hadn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;had not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-175"><a href="#TopicClassifier.clean_text-175"><span class="linenos">175</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;wouldn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;would not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-176"><a href="#TopicClassifier.clean_text-176"><span class="linenos">176</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;shouldn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;should not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-177"><a href="#TopicClassifier.clean_text-177"><span class="linenos">177</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;couldn&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;could not&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-178"><a href="#TopicClassifier.clean_text-178"><span class="linenos">178</span></a>
</span><span id="TopicClassifier.clean_text-179"><a href="#TopicClassifier.clean_text-179"><span class="linenos">179</span></a>        <span class="c1"># Preserve special characters relevant to programming languages (e.g., C++, C#)</span>
</span><span id="TopicClassifier.clean_text-180"><a href="#TopicClassifier.clean_text-180"><span class="linenos">180</span></a>        <span class="c1"># and remove other non-alphanumeric characters, but keep spaces.</span>
</span><span id="TopicClassifier.clean_text-181"><a href="#TopicClassifier.clean_text-181"><span class="linenos">181</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-z0-9#+\s]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.clean_text-182"><a href="#TopicClassifier.clean_text-182"><span class="linenos">182</span></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span id="TopicClassifier.clean_text-183"><a href="#TopicClassifier.clean_text-183"><span class="linenos">183</span></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopwords</span><span class="p">]</span>
</span><span id="TopicClassifier.clean_text-184"><a href="#TopicClassifier.clean_text-184"><span class="linenos">184</span></a>        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="TopicClassifier.classify" class="classattr">
                                        <input id="TopicClassifier.classify-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">classify</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">text</span>, </span><span class="param"><span class="n">return_list</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TopicClassifier.classify-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TopicClassifier.classify"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TopicClassifier.classify-186"><a href="#TopicClassifier.classify-186"><span class="linenos">186</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">classify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">return_list</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="TopicClassifier.classify-187"><a href="#TopicClassifier.classify-187"><span class="linenos">187</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TopicClassifier.classify-188"><a href="#TopicClassifier.classify-188"><span class="linenos">188</span></a><span class="sd">        Classify the topic(s) of a given text.</span>
</span><span id="TopicClassifier.classify-189"><a href="#TopicClassifier.classify-189"><span class="linenos">189</span></a>
</span><span id="TopicClassifier.classify-190"><a href="#TopicClassifier.classify-190"><span class="linenos">190</span></a><span class="sd">        Args:</span>
</span><span id="TopicClassifier.classify-191"><a href="#TopicClassifier.classify-191"><span class="linenos">191</span></a><span class="sd">            text (str): Text to classify</span>
</span><span id="TopicClassifier.classify-192"><a href="#TopicClassifier.classify-192"><span class="linenos">192</span></a><span class="sd">            return_list (bool): If True, returns list of topic names only.</span>
</span><span id="TopicClassifier.classify-193"><a href="#TopicClassifier.classify-193"><span class="linenos">193</span></a><span class="sd">                               If False, returns dict with confidence scores.</span>
</span><span id="TopicClassifier.classify-194"><a href="#TopicClassifier.classify-194"><span class="linenos">194</span></a>
</span><span id="TopicClassifier.classify-195"><a href="#TopicClassifier.classify-195"><span class="linenos">195</span></a><span class="sd">        Returns:</span>
</span><span id="TopicClassifier.classify-196"><a href="#TopicClassifier.classify-196"><span class="linenos">196</span></a><span class="sd">            Union[List[str], Dict[str, float]]: Topic classification results</span>
</span><span id="TopicClassifier.classify-197"><a href="#TopicClassifier.classify-197"><span class="linenos">197</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TopicClassifier.classify-198"><a href="#TopicClassifier.classify-198"><span class="linenos">198</span></a>        <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="TopicClassifier.classify-199"><a href="#TopicClassifier.classify-199"><span class="linenos">199</span></a>        <span class="n">cleaned_words</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span id="TopicClassifier.classify-200"><a href="#TopicClassifier.classify-200"><span class="linenos">200</span></a>        <span class="n">raw_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">category</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="p">}</span>
</span><span id="TopicClassifier.classify-201"><a href="#TopicClassifier.classify-201"><span class="linenos">201</span></a>
</span><span id="TopicClassifier.classify-202"><a href="#TopicClassifier.classify-202"><span class="linenos">202</span></a>        <span class="c1"># Check phrases first (higher weight)</span>
</span><span id="TopicClassifier.classify-203"><a href="#TopicClassifier.classify-203"><span class="linenos">203</span></a>        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">phrases</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="TopicClassifier.classify-204"><a href="#TopicClassifier.classify-204"><span class="linenos">204</span></a>            <span class="k">if</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">raw_scores</span><span class="p">:</span>  <span class="c1"># Make sure category exists in raw_scores</span>
</span><span id="TopicClassifier.classify-205"><a href="#TopicClassifier.classify-205"><span class="linenos">205</span></a>                <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="n">phrases</span><span class="p">:</span>
</span><span id="TopicClassifier.classify-206"><a href="#TopicClassifier.classify-206"><span class="linenos">206</span></a>                    <span class="k">if</span> <span class="n">phrase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">cleaned</span><span class="p">:</span>
</span><span id="TopicClassifier.classify-207"><a href="#TopicClassifier.classify-207"><span class="linenos">207</span></a>                        <span class="n">raw_scores</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase_weight</span>
</span><span id="TopicClassifier.classify-208"><a href="#TopicClassifier.classify-208"><span class="linenos">208</span></a>
</span><span id="TopicClassifier.classify-209"><a href="#TopicClassifier.classify-209"><span class="linenos">209</span></a>        <span class="c1"># Check individual keywords with whole word matching</span>
</span><span id="TopicClassifier.classify-210"><a href="#TopicClassifier.classify-210"><span class="linenos">210</span></a>        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">keywords</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="TopicClassifier.classify-211"><a href="#TopicClassifier.classify-211"><span class="linenos">211</span></a>            <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
</span><span id="TopicClassifier.classify-212"><a href="#TopicClassifier.classify-212"><span class="linenos">212</span></a>                <span class="n">keyword_lower</span> <span class="o">=</span> <span class="n">keyword</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="TopicClassifier.classify-213"><a href="#TopicClassifier.classify-213"><span class="linenos">213</span></a>                <span class="c1"># Use whole word matching to avoid partial matches like &quot;ai&quot; in &quot;hiking&quot;</span>
</span><span id="TopicClassifier.classify-214"><a href="#TopicClassifier.classify-214"><span class="linenos">214</span></a>                <span class="k">if</span> <span class="n">keyword_lower</span> <span class="ow">in</span> <span class="n">cleaned_words</span><span class="p">:</span>
</span><span id="TopicClassifier.classify-215"><a href="#TopicClassifier.classify-215"><span class="linenos">215</span></a>                    <span class="n">raw_scores</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyword_weight</span>
</span><span id="TopicClassifier.classify-216"><a href="#TopicClassifier.classify-216"><span class="linenos">216</span></a>                <span class="c1"># Also check for exact phrase matches for multi-word keywords</span>
</span><span id="TopicClassifier.classify-217"><a href="#TopicClassifier.classify-217"><span class="linenos">217</span></a>                <span class="k">elif</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">keyword_lower</span> <span class="ow">and</span> <span class="n">keyword_lower</span> <span class="ow">in</span> <span class="n">cleaned</span><span class="p">:</span>
</span><span id="TopicClassifier.classify-218"><a href="#TopicClassifier.classify-218"><span class="linenos">218</span></a>                    <span class="n">raw_scores</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyword_weight</span>
</span><span id="TopicClassifier.classify-219"><a href="#TopicClassifier.classify-219"><span class="linenos">219</span></a>
</span><span id="TopicClassifier.classify-220"><a href="#TopicClassifier.classify-220"><span class="linenos">220</span></a>        <span class="n">total_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">raw_scores</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="TopicClassifier.classify-221"><a href="#TopicClassifier.classify-221"><span class="linenos">221</span></a>        <span class="k">if</span> <span class="n">total_score</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TopicClassifier.classify-222"><a href="#TopicClassifier.classify-222"><span class="linenos">222</span></a>            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;unknown&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">return_list</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;unknown&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
</span><span id="TopicClassifier.classify-223"><a href="#TopicClassifier.classify-223"><span class="linenos">223</span></a>
</span><span id="TopicClassifier.classify-224"><a href="#TopicClassifier.classify-224"><span class="linenos">224</span></a>        <span class="n">normalized_scores</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TopicClassifier.classify-225"><a href="#TopicClassifier.classify-225"><span class="linenos">225</span></a>            <span class="n">cat</span><span class="p">:</span> <span class="n">score</span> <span class="o">/</span> <span class="n">total_score</span> <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">raw_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="TopicClassifier.classify-226"><a href="#TopicClassifier.classify-226"><span class="linenos">226</span></a>        <span class="p">}</span>
</span><span id="TopicClassifier.classify-227"><a href="#TopicClassifier.classify-227"><span class="linenos">227</span></a>        <span class="n">high_confidence</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TopicClassifier.classify-228"><a href="#TopicClassifier.classify-228"><span class="linenos">228</span></a>            <span class="n">cat</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="TopicClassifier.classify-229"><a href="#TopicClassifier.classify-229"><span class="linenos">229</span></a>            <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">normalized_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="TopicClassifier.classify-230"><a href="#TopicClassifier.classify-230"><span class="linenos">230</span></a>            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span>
</span><span id="TopicClassifier.classify-231"><a href="#TopicClassifier.classify-231"><span class="linenos">231</span></a>        <span class="p">}</span>
</span><span id="TopicClassifier.classify-232"><a href="#TopicClassifier.classify-232"><span class="linenos">232</span></a>
</span><span id="TopicClassifier.classify-233"><a href="#TopicClassifier.classify-233"><span class="linenos">233</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">high_confidence</span><span class="p">:</span>
</span><span id="TopicClassifier.classify-234"><a href="#TopicClassifier.classify-234"><span class="linenos">234</span></a>            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;unknown&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">return_list</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;unknown&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
</span><span id="TopicClassifier.classify-235"><a href="#TopicClassifier.classify-235"><span class="linenos">235</span></a>
</span><span id="TopicClassifier.classify-236"><a href="#TopicClassifier.classify-236"><span class="linenos">236</span></a>        <span class="k">if</span> <span class="n">return_list</span><span class="p">:</span>
</span><span id="TopicClassifier.classify-237"><a href="#TopicClassifier.classify-237"><span class="linenos">237</span></a>            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">high_confidence</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="TopicClassifier.classify-238"><a href="#TopicClassifier.classify-238"><span class="linenos">238</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TopicClassifier.classify-239"><a href="#TopicClassifier.classify-239"><span class="linenos">239</span></a>            <span class="k">return</span> <span class="n">high_confidence</span>
</span></pre></div>


            <div class="docstring"><p>Classify the topic(s) of a given text.</p>

<p>Args:
    text (str): Text to classify
    return_list (bool): If True, returns list of topic names only.
                       If False, returns dict with confidence scores.</p>

<p>Returns:
    Union[List[str], Dict[str, float]]: Topic classification results</p>
</div>


                            </div>
                </section>
                <section id="RuleSet">
                            <input id="RuleSet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">RuleSet</span>:

                <label class="view-source-button" for="RuleSet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RuleSet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RuleSet-32"><a href="#RuleSet-32"><span class="linenos">32</span></a><span class="nd">@dataclass</span>
</span><span id="RuleSet-33"><a href="#RuleSet-33"><span class="linenos">33</span></a><span class="k">class</span><span class="w"> </span><span class="nc">RuleSet</span><span class="p">:</span>
</span><span id="RuleSet-34"><a href="#RuleSet-34"><span class="linenos">34</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Basic ruleset&quot;&quot;&quot;</span>
</span><span id="RuleSet-35"><a href="#RuleSet-35"><span class="linenos">35</span></a>
</span><span id="RuleSet-36"><a href="#RuleSet-36"><span class="linenos">36</span></a>    <span class="n">keywords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="RuleSet-37"><a href="#RuleSet-37"><span class="linenos">37</span></a>    <span class="n">patterns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Basic ruleset</p>
</div>


                            <div id="RuleSet.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">RuleSet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">keywords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>, </span><span class="param"><span class="n">patterns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#RuleSet.__init__"></a>
    
    

                            </div>
                            <div id="RuleSet.keywords" class="classattr">
                                <div class="attr variable">
            <span class="name">keywords</span><span class="annotation">: List[str]</span>

        
    </div>
    <a class="headerlink" href="#RuleSet.keywords"></a>
    
    

                            </div>
                            <div id="RuleSet.patterns" class="classattr">
                                <div class="attr variable">
            <span class="name">patterns</span><span class="annotation">: List[Pattern]</span>

        
    </div>
    <a class="headerlink" href="#RuleSet.patterns"></a>
    
    

                            </div>
                </section>
                <section id="UserManager">
                            <input id="UserManager-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">UserManager</span>:

                <label class="view-source-button" for="UserManager-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserManager"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserManager-18"><a href="#UserManager-18"><span class="linenos"> 18</span></a><span class="k">class</span><span class="w"> </span><span class="nc">UserManager</span><span class="p">:</span>
</span><span id="UserManager-19"><a href="#UserManager-19"><span class="linenos"> 19</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Complete user management with LightRAG integration.&quot;&quot;&quot;</span>
</span><span id="UserManager-20"><a href="#UserManager-20"><span class="linenos"> 20</span></a>    
</span><span id="UserManager-21"><a href="#UserManager-21"><span class="linenos"> 21</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">storage_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">project_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="UserManager-22"><a href="#UserManager-22"><span class="linenos"> 22</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-23"><a href="#UserManager-23"><span class="linenos"> 23</span></a><span class="sd">        Initialize the user manager.</span>
</span><span id="UserManager-24"><a href="#UserManager-24"><span class="linenos"> 24</span></a><span class="sd">        </span>
</span><span id="UserManager-25"><a href="#UserManager-25"><span class="linenos"> 25</span></a><span class="sd">        Args:</span>
</span><span id="UserManager-26"><a href="#UserManager-26"><span class="linenos"> 26</span></a><span class="sd">            data_dir: Data directory path (defaults to config DATA_DIR)</span>
</span><span id="UserManager-27"><a href="#UserManager-27"><span class="linenos"> 27</span></a><span class="sd">            storage_backend: Storage backend (defaults to config STORAGE_BACKEND)</span>
</span><span id="UserManager-28"><a href="#UserManager-28"><span class="linenos"> 28</span></a><span class="sd">            project_root: Project root directory (deprecated, LightRAGManager now uses PERSAG_HOME)</span>
</span><span id="UserManager-29"><a href="#UserManager-29"><span class="linenos"> 29</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-30"><a href="#UserManager-30"><span class="linenos"> 30</span></a>        <span class="c1"># Store the configuration for use in methods</span>
</span><span id="UserManager-31"><a href="#UserManager-31"><span class="linenos"> 31</span></a>        <span class="k">if</span> <span class="n">data_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">storage_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="UserManager-32"><a href="#UserManager-32"><span class="linenos"> 32</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">STORAGE_BACKEND</span>
</span><span id="UserManager-33"><a href="#UserManager-33"><span class="linenos"> 33</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="ow">or</span> <span class="n">DATA_DIR</span>
</span><span id="UserManager-34"><a href="#UserManager-34"><span class="linenos"> 34</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">storage_backend</span> <span class="o">=</span> <span class="n">storage_backend</span> <span class="ow">or</span> <span class="n">STORAGE_BACKEND</span>
</span><span id="UserManager-35"><a href="#UserManager-35"><span class="linenos"> 35</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager-36"><a href="#UserManager-36"><span class="linenos"> 36</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
</span><span id="UserManager-37"><a href="#UserManager-37"><span class="linenos"> 37</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">storage_backend</span> <span class="o">=</span> <span class="n">storage_backend</span>
</span><span id="UserManager-38"><a href="#UserManager-38"><span class="linenos"> 38</span></a>            
</span><span id="UserManager-39"><a href="#UserManager-39"><span class="linenos"> 39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">UserRegistry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_backend</span><span class="p">)</span>
</span><span id="UserManager-40"><a href="#UserManager-40"><span class="linenos"> 40</span></a>        <span class="c1"># LightRAGManager now uses PERSAG_HOME internally, project_root parameter is deprecated</span>
</span><span id="UserManager-41"><a href="#UserManager-41"><span class="linenos"> 41</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_manager</span> <span class="o">=</span> <span class="n">LightRAGManager</span><span class="p">(</span><span class="n">project_root</span><span class="p">)</span>
</span><span id="UserManager-42"><a href="#UserManager-42"><span class="linenos"> 42</span></a>    
</span><span id="UserManager-43"><a href="#UserManager-43"><span class="linenos"> 43</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_users</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="UserManager-44"><a href="#UserManager-44"><span class="linenos"> 44</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-45"><a href="#UserManager-45"><span class="linenos"> 45</span></a><span class="sd">        Get all users from the registry.</span>
</span><span id="UserManager-46"><a href="#UserManager-46"><span class="linenos"> 46</span></a><span class="sd">        </span>
</span><span id="UserManager-47"><a href="#UserManager-47"><span class="linenos"> 47</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager-48"><a href="#UserManager-48"><span class="linenos"> 48</span></a><span class="sd">            List of user dictionaries with current user marked</span>
</span><span id="UserManager-49"><a href="#UserManager-49"><span class="linenos"> 49</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-50"><a href="#UserManager-50"><span class="linenos"> 50</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_all_users</span><span class="p">()</span>
</span><span id="UserManager-51"><a href="#UserManager-51"><span class="linenos"> 51</span></a>        
</span><span id="UserManager-52"><a href="#UserManager-52"><span class="linenos"> 52</span></a>        <span class="c1"># Mark current user</span>
</span><span id="UserManager-53"><a href="#UserManager-53"><span class="linenos"> 53</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_user_id</span>
</span><span id="UserManager-54"><a href="#UserManager-54"><span class="linenos"> 54</span></a>        <span class="n">current_user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="UserManager-55"><a href="#UserManager-55"><span class="linenos"> 55</span></a>        
</span><span id="UserManager-56"><a href="#UserManager-56"><span class="linenos"> 56</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
</span><span id="UserManager-57"><a href="#UserManager-57"><span class="linenos"> 57</span></a>            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;is_current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_user_id</span><span class="p">)</span>
</span><span id="UserManager-58"><a href="#UserManager-58"><span class="linenos"> 58</span></a>        
</span><span id="UserManager-59"><a href="#UserManager-59"><span class="linenos"> 59</span></a>        <span class="k">return</span> <span class="n">users</span>
</span><span id="UserManager-60"><a href="#UserManager-60"><span class="linenos"> 60</span></a>    
</span><span id="UserManager-61"><a href="#UserManager-61"><span class="linenos"> 61</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="UserManager-62"><a href="#UserManager-62"><span class="linenos"> 62</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-63"><a href="#UserManager-63"><span class="linenos"> 63</span></a><span class="sd">        Get a specific user from the registry.</span>
</span><span id="UserManager-64"><a href="#UserManager-64"><span class="linenos"> 64</span></a><span class="sd">        </span>
</span><span id="UserManager-65"><a href="#UserManager-65"><span class="linenos"> 65</span></a><span class="sd">        Args:</span>
</span><span id="UserManager-66"><a href="#UserManager-66"><span class="linenos"> 66</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserManager-67"><a href="#UserManager-67"><span class="linenos"> 67</span></a><span class="sd">            </span>
</span><span id="UserManager-68"><a href="#UserManager-68"><span class="linenos"> 68</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager-69"><a href="#UserManager-69"><span class="linenos"> 69</span></a><span class="sd">            User dictionary or None if not found</span>
</span><span id="UserManager-70"><a href="#UserManager-70"><span class="linenos"> 70</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-71"><a href="#UserManager-71"><span class="linenos"> 71</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="UserManager-72"><a href="#UserManager-72"><span class="linenos"> 72</span></a>    
</span><span id="UserManager-73"><a href="#UserManager-73"><span class="linenos"> 73</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">user_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Standard&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager-74"><a href="#UserManager-74"><span class="linenos"> 74</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-75"><a href="#UserManager-75"><span class="linenos"> 75</span></a><span class="sd">        Create a new user in the system.</span>
</span><span id="UserManager-76"><a href="#UserManager-76"><span class="linenos"> 76</span></a><span class="sd">        </span>
</span><span id="UserManager-77"><a href="#UserManager-77"><span class="linenos"> 77</span></a><span class="sd">        Args:</span>
</span><span id="UserManager-78"><a href="#UserManager-78"><span class="linenos"> 78</span></a><span class="sd">            user_id: Unique user identifier</span>
</span><span id="UserManager-79"><a href="#UserManager-79"><span class="linenos"> 79</span></a><span class="sd">            user_name: Display name for the user (defaults to user_id)</span>
</span><span id="UserManager-80"><a href="#UserManager-80"><span class="linenos"> 80</span></a><span class="sd">            user_type: User type (Standard, Admin, Guest)</span>
</span><span id="UserManager-81"><a href="#UserManager-81"><span class="linenos"> 81</span></a><span class="sd">            </span>
</span><span id="UserManager-82"><a href="#UserManager-82"><span class="linenos"> 82</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager-83"><a href="#UserManager-83"><span class="linenos"> 83</span></a><span class="sd">            Dictionary containing result information</span>
</span><span id="UserManager-84"><a href="#UserManager-84"><span class="linenos"> 84</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-85"><a href="#UserManager-85"><span class="linenos"> 85</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-86"><a href="#UserManager-86"><span class="linenos"> 86</span></a>            <span class="c1"># Validate input</span>
</span><span id="UserManager-87"><a href="#UserManager-87"><span class="linenos"> 87</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserManager-88"><a href="#UserManager-88"><span class="linenos"> 88</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User ID is required&quot;</span><span class="p">}</span>
</span><span id="UserManager-89"><a href="#UserManager-89"><span class="linenos"> 89</span></a>            
</span><span id="UserManager-90"><a href="#UserManager-90"><span class="linenos"> 90</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_name</span><span class="p">:</span>
</span><span id="UserManager-91"><a href="#UserManager-91"><span class="linenos"> 91</span></a>                <span class="n">user_name</span> <span class="o">=</span> <span class="n">user_id</span>
</span><span id="UserManager-92"><a href="#UserManager-92"><span class="linenos"> 92</span></a>            
</span><span id="UserManager-93"><a href="#UserManager-93"><span class="linenos"> 93</span></a>            <span class="c1"># Add user to registry</span>
</span><span id="UserManager-94"><a href="#UserManager-94"><span class="linenos"> 94</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">user_type</span><span class="p">):</span>
</span><span id="UserManager-95"><a href="#UserManager-95"><span class="linenos"> 95</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-96"><a href="#UserManager-96"><span class="linenos"> 96</span></a>                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="UserManager-97"><a href="#UserManager-97"><span class="linenos"> 97</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; created successfully&quot;</span><span class="p">,</span>
</span><span id="UserManager-98"><a href="#UserManager-98"><span class="linenos"> 98</span></a>                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span>
</span><span id="UserManager-99"><a href="#UserManager-99"><span class="linenos"> 99</span></a>                <span class="p">}</span>
</span><span id="UserManager-100"><a href="#UserManager-100"><span class="linenos">100</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager-101"><a href="#UserManager-101"><span class="linenos">101</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-102"><a href="#UserManager-102"><span class="linenos">102</span></a>                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager-103"><a href="#UserManager-103"><span class="linenos">103</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; already exists&quot;</span>
</span><span id="UserManager-104"><a href="#UserManager-104"><span class="linenos">104</span></a>                <span class="p">}</span>
</span><span id="UserManager-105"><a href="#UserManager-105"><span class="linenos">105</span></a>        
</span><span id="UserManager-106"><a href="#UserManager-106"><span class="linenos">106</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager-107"><a href="#UserManager-107"><span class="linenos">107</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-108"><a href="#UserManager-108"><span class="linenos">108</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager-109"><a href="#UserManager-109"><span class="linenos">109</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error creating user: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager-110"><a href="#UserManager-110"><span class="linenos">110</span></a>            <span class="p">}</span>
</span><span id="UserManager-111"><a href="#UserManager-111"><span class="linenos">111</span></a>    
</span><span id="UserManager-112"><a href="#UserManager-112"><span class="linenos">112</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">switch_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">restart_lightrag</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">update_global_config</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager-113"><a href="#UserManager-113"><span class="linenos">113</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-114"><a href="#UserManager-114"><span class="linenos">114</span></a><span class="sd">        Switch to a different user with complete system integration.</span>
</span><span id="UserManager-115"><a href="#UserManager-115"><span class="linenos">115</span></a><span class="sd">        </span>
</span><span id="UserManager-116"><a href="#UserManager-116"><span class="linenos">116</span></a><span class="sd">        Args:</span>
</span><span id="UserManager-117"><a href="#UserManager-117"><span class="linenos">117</span></a><span class="sd">            user_id: User ID to switch to</span>
</span><span id="UserManager-118"><a href="#UserManager-118"><span class="linenos">118</span></a><span class="sd">            restart_lightrag: Whether to restart LightRAG services</span>
</span><span id="UserManager-119"><a href="#UserManager-119"><span class="linenos">119</span></a><span class="sd">            update_global_config: Whether to update global USER_ID configuration</span>
</span><span id="UserManager-120"><a href="#UserManager-120"><span class="linenos">120</span></a><span class="sd">            </span>
</span><span id="UserManager-121"><a href="#UserManager-121"><span class="linenos">121</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager-122"><a href="#UserManager-122"><span class="linenos">122</span></a><span class="sd">            Dictionary containing result information</span>
</span><span id="UserManager-123"><a href="#UserManager-123"><span class="linenos">123</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-124"><a href="#UserManager-124"><span class="linenos">124</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-125"><a href="#UserManager-125"><span class="linenos">125</span></a>            <span class="c1"># Validate input</span>
</span><span id="UserManager-126"><a href="#UserManager-126"><span class="linenos">126</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserManager-127"><a href="#UserManager-127"><span class="linenos">127</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User ID is required&quot;</span><span class="p">}</span>
</span><span id="UserManager-128"><a href="#UserManager-128"><span class="linenos">128</span></a>            
</span><span id="UserManager-129"><a href="#UserManager-129"><span class="linenos">129</span></a>            <span class="c1"># Check if user exists in registry</span>
</span><span id="UserManager-130"><a href="#UserManager-130"><span class="linenos">130</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
</span><span id="UserManager-131"><a href="#UserManager-131"><span class="linenos">131</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; does not exist&quot;</span><span class="p">}</span>
</span><span id="UserManager-132"><a href="#UserManager-132"><span class="linenos">132</span></a>            
</span><span id="UserManager-133"><a href="#UserManager-133"><span class="linenos">133</span></a>            <span class="c1"># Get current user using dynamic function</span>
</span><span id="UserManager-134"><a href="#UserManager-134"><span class="linenos">134</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_user_id</span>
</span><span id="UserManager-135"><a href="#UserManager-135"><span class="linenos">135</span></a>            <span class="n">current_user</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="UserManager-136"><a href="#UserManager-136"><span class="linenos">136</span></a>            
</span><span id="UserManager-137"><a href="#UserManager-137"><span class="linenos">137</span></a>            <span class="c1"># Don&#39;t switch if already the current user</span>
</span><span id="UserManager-138"><a href="#UserManager-138"><span class="linenos">138</span></a>            <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="p">:</span>
</span><span id="UserManager-139"><a href="#UserManager-139"><span class="linenos">139</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Already logged in as &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">}</span>
</span><span id="UserManager-140"><a href="#UserManager-140"><span class="linenos">140</span></a>            
</span><span id="UserManager-141"><a href="#UserManager-141"><span class="linenos">141</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="UserManager-142"><a href="#UserManager-142"><span class="linenos">142</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="UserManager-143"><a href="#UserManager-143"><span class="linenos">143</span></a>                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
</span><span id="UserManager-144"><a href="#UserManager-144"><span class="linenos">144</span></a>                <span class="s2">&quot;previous_user&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">,</span>
</span><span id="UserManager-145"><a href="#UserManager-145"><span class="linenos">145</span></a>                <span class="s2">&quot;actions_performed&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="UserManager-146"><a href="#UserManager-146"><span class="linenos">146</span></a>                <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="UserManager-147"><a href="#UserManager-147"><span class="linenos">147</span></a>                <span class="s2">&quot;lightrag_status&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="UserManager-148"><a href="#UserManager-148"><span class="linenos">148</span></a>                <span class="s2">&quot;config_refresh&quot;</span><span class="p">:</span> <span class="p">{}</span>
</span><span id="UserManager-149"><a href="#UserManager-149"><span class="linenos">149</span></a>            <span class="p">}</span>
</span><span id="UserManager-150"><a href="#UserManager-150"><span class="linenos">150</span></a>            
</span><span id="UserManager-151"><a href="#UserManager-151"><span class="linenos">151</span></a>            <span class="c1"># Update global environment variable and persistent user file</span>
</span><span id="UserManager-152"><a href="#UserManager-152"><span class="linenos">152</span></a>            <span class="k">if</span> <span class="n">update_global_config</span><span class="p">:</span>
</span><span id="UserManager-153"><a href="#UserManager-153"><span class="linenos">153</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;USER_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_id</span>
</span><span id="UserManager-154"><a href="#UserManager-154"><span class="linenos">154</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Updated global USER_ID environment variable&quot;</span><span class="p">)</span>
</span><span id="UserManager-155"><a href="#UserManager-155"><span class="linenos">155</span></a>
</span><span id="UserManager-156"><a href="#UserManager-156"><span class="linenos">156</span></a>                <span class="c1"># Write to ~/.persag/env.userid to persist the change</span>
</span><span id="UserManager-157"><a href="#UserManager-157"><span class="linenos">157</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-158"><a href="#UserManager-158"><span class="linenos">158</span></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">..core.persag_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_persag_manager</span>
</span><span id="UserManager-159"><a href="#UserManager-159"><span class="linenos">159</span></a>                    <span class="n">persag_manager</span> <span class="o">=</span> <span class="n">get_persag_manager</span><span class="p">()</span>
</span><span id="UserManager-160"><a href="#UserManager-160"><span class="linenos">160</span></a>                    <span class="n">success</span> <span class="o">=</span> <span class="n">persag_manager</span><span class="o">.</span><span class="n">set_userid</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="UserManager-161"><a href="#UserManager-161"><span class="linenos">161</span></a>                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="UserManager-162"><a href="#UserManager-162"><span class="linenos">162</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Persisted current user to ~/.persag/env.userid&quot;</span><span class="p">)</span>
</span><span id="UserManager-163"><a href="#UserManager-163"><span class="linenos">163</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager-164"><a href="#UserManager-164"><span class="linenos">164</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Could not write to ~/.persag/env.userid&quot;</span><span class="p">)</span>
</span><span id="UserManager-165"><a href="#UserManager-165"><span class="linenos">165</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager-166"><a href="#UserManager-166"><span class="linenos">166</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not write to ~/.persag/env.userid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager-167"><a href="#UserManager-167"><span class="linenos">167</span></a>
</span><span id="UserManager-168"><a href="#UserManager-168"><span class="linenos">168</span></a>                <span class="c1"># Refresh user-dependent configuration settings</span>
</span><span id="UserManager-169"><a href="#UserManager-169"><span class="linenos">169</span></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">refresh_user_dependent_settings</span>
</span><span id="UserManager-170"><a href="#UserManager-170"><span class="linenos">170</span></a>                <span class="n">refreshed_settings</span> <span class="o">=</span> <span class="n">refresh_user_dependent_settings</span><span class="p">()</span>
</span><span id="UserManager-171"><a href="#UserManager-171"><span class="linenos">171</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;config_refresh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refreshed_settings</span>
</span><span id="UserManager-172"><a href="#UserManager-172"><span class="linenos">172</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Refreshed user-dependent configuration settings&quot;</span><span class="p">)</span>
</span><span id="UserManager-173"><a href="#UserManager-173"><span class="linenos">173</span></a>            
</span><span id="UserManager-174"><a href="#UserManager-174"><span class="linenos">174</span></a>            <span class="c1"># Restart LightRAG services with new user ID</span>
</span><span id="UserManager-175"><a href="#UserManager-175"><span class="linenos">175</span></a>            <span class="k">if</span> <span class="n">restart_lightrag</span><span class="p">:</span>
</span><span id="UserManager-176"><a href="#UserManager-176"><span class="linenos">176</span></a>                <span class="n">lightrag_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_manager</span><span class="o">.</span><span class="n">restart_lightrag_services</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="UserManager-177"><a href="#UserManager-177"><span class="linenos">177</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;lightrag_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lightrag_result</span>
</span><span id="UserManager-178"><a href="#UserManager-178"><span class="linenos">178</span></a>                
</span><span id="UserManager-179"><a href="#UserManager-179"><span class="linenos">179</span></a>                <span class="k">if</span> <span class="n">lightrag_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
</span><span id="UserManager-180"><a href="#UserManager-180"><span class="linenos">180</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Restarted LightRAG services&quot;</span><span class="p">)</span>
</span><span id="UserManager-181"><a href="#UserManager-181"><span class="linenos">181</span></a>                    <span class="k">if</span> <span class="n">lightrag_result</span><span class="p">[</span><span class="s2">&quot;services_restarted&quot;</span><span class="p">]:</span>
</span><span id="UserManager-182"><a href="#UserManager-182"><span class="linenos">182</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Services restarted: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lightrag_result</span><span class="p">[</span><span class="s1">&#39;services_restarted&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager-183"><a href="#UserManager-183"><span class="linenos">183</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager-184"><a href="#UserManager-184"><span class="linenos">184</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;LightRAG restart had issues&quot;</span><span class="p">)</span>
</span><span id="UserManager-185"><a href="#UserManager-185"><span class="linenos">185</span></a>                    <span class="k">if</span> <span class="n">lightrag_result</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]:</span>
</span><span id="UserManager-186"><a href="#UserManager-186"><span class="linenos">186</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lightrag_result</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">])</span>
</span><span id="UserManager-187"><a href="#UserManager-187"><span class="linenos">187</span></a>            
</span><span id="UserManager-188"><a href="#UserManager-188"><span class="linenos">188</span></a>            <span class="c1"># Update user&#39;s last_seen timestamp</span>
</span><span id="UserManager-189"><a href="#UserManager-189"><span class="linenos">189</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">update_last_seen</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="UserManager-190"><a href="#UserManager-190"><span class="linenos">190</span></a>            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Updated user last_seen timestamp&quot;</span><span class="p">)</span>
</span><span id="UserManager-191"><a href="#UserManager-191"><span class="linenos">191</span></a>            
</span><span id="UserManager-192"><a href="#UserManager-192"><span class="linenos">192</span></a>            <span class="k">return</span> <span class="n">results</span>
</span><span id="UserManager-193"><a href="#UserManager-193"><span class="linenos">193</span></a>        
</span><span id="UserManager-194"><a href="#UserManager-194"><span class="linenos">194</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager-195"><a href="#UserManager-195"><span class="linenos">195</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-196"><a href="#UserManager-196"><span class="linenos">196</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager-197"><a href="#UserManager-197"><span class="linenos">197</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error switching user: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager-198"><a href="#UserManager-198"><span class="linenos">198</span></a>            <span class="p">}</span>
</span><span id="UserManager-199"><a href="#UserManager-199"><span class="linenos">199</span></a>    
</span><span id="UserManager-200"><a href="#UserManager-200"><span class="linenos">200</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">delete_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">backup_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager-201"><a href="#UserManager-201"><span class="linenos">201</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-202"><a href="#UserManager-202"><span class="linenos">202</span></a><span class="sd">        Delete a user from the system with comprehensive data cleanup.</span>
</span><span id="UserManager-203"><a href="#UserManager-203"><span class="linenos">203</span></a><span class="sd">        </span>
</span><span id="UserManager-204"><a href="#UserManager-204"><span class="linenos">204</span></a><span class="sd">        Args:</span>
</span><span id="UserManager-205"><a href="#UserManager-205"><span class="linenos">205</span></a><span class="sd">            user_id: User ID to delete</span>
</span><span id="UserManager-206"><a href="#UserManager-206"><span class="linenos">206</span></a><span class="sd">            delete_data: Whether to delete persistent data directory (default: True)</span>
</span><span id="UserManager-207"><a href="#UserManager-207"><span class="linenos">207</span></a><span class="sd">            backup_data: Whether to backup data before deletion (default: False)</span>
</span><span id="UserManager-208"><a href="#UserManager-208"><span class="linenos">208</span></a><span class="sd">            dry_run: Preview mode - show what would be deleted without deleting (default: False)</span>
</span><span id="UserManager-209"><a href="#UserManager-209"><span class="linenos">209</span></a><span class="sd">            </span>
</span><span id="UserManager-210"><a href="#UserManager-210"><span class="linenos">210</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager-211"><a href="#UserManager-211"><span class="linenos">211</span></a><span class="sd">            Dictionary containing detailed result information</span>
</span><span id="UserManager-212"><a href="#UserManager-212"><span class="linenos">212</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-213"><a href="#UserManager-213"><span class="linenos">213</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-214"><a href="#UserManager-214"><span class="linenos">214</span></a>            <span class="c1"># Validate input</span>
</span><span id="UserManager-215"><a href="#UserManager-215"><span class="linenos">215</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserManager-216"><a href="#UserManager-216"><span class="linenos">216</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User ID is required&quot;</span><span class="p">}</span>
</span><span id="UserManager-217"><a href="#UserManager-217"><span class="linenos">217</span></a>            
</span><span id="UserManager-218"><a href="#UserManager-218"><span class="linenos">218</span></a>            <span class="c1"># Check if user exists</span>
</span><span id="UserManager-219"><a href="#UserManager-219"><span class="linenos">219</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
</span><span id="UserManager-220"><a href="#UserManager-220"><span class="linenos">220</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; does not exist&quot;</span><span class="p">}</span>
</span><span id="UserManager-221"><a href="#UserManager-221"><span class="linenos">221</span></a>            
</span><span id="UserManager-222"><a href="#UserManager-222"><span class="linenos">222</span></a>            <span class="c1"># Get current user</span>
</span><span id="UserManager-223"><a href="#UserManager-223"><span class="linenos">223</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_user_id</span>
</span><span id="UserManager-224"><a href="#UserManager-224"><span class="linenos">224</span></a>            <span class="n">current_user</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="UserManager-225"><a href="#UserManager-225"><span class="linenos">225</span></a>            
</span><span id="UserManager-226"><a href="#UserManager-226"><span class="linenos">226</span></a>            <span class="c1"># Don&#39;t delete the current user</span>
</span><span id="UserManager-227"><a href="#UserManager-227"><span class="linenos">227</span></a>            <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="p">:</span>
</span><span id="UserManager-228"><a href="#UserManager-228"><span class="linenos">228</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Cannot delete the current user&quot;</span><span class="p">}</span>
</span><span id="UserManager-229"><a href="#UserManager-229"><span class="linenos">229</span></a>            
</span><span id="UserManager-230"><a href="#UserManager-230"><span class="linenos">230</span></a>            <span class="c1"># Initialize result structure</span>
</span><span id="UserManager-231"><a href="#UserManager-231"><span class="linenos">231</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="UserManager-232"><a href="#UserManager-232"><span class="linenos">232</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="UserManager-233"><a href="#UserManager-233"><span class="linenos">233</span></a>                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
</span><span id="UserManager-234"><a href="#UserManager-234"><span class="linenos">234</span></a>                <span class="s2">&quot;dry_run&quot;</span><span class="p">:</span> <span class="n">dry_run</span><span class="p">,</span>
</span><span id="UserManager-235"><a href="#UserManager-235"><span class="linenos">235</span></a>                <span class="s2">&quot;actions_performed&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="UserManager-236"><a href="#UserManager-236"><span class="linenos">236</span></a>                <span class="s2">&quot;data_deleted&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="UserManager-237"><a href="#UserManager-237"><span class="linenos">237</span></a>                    <span class="s2">&quot;registry&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager-238"><a href="#UserManager-238"><span class="linenos">238</span></a>                    <span class="s2">&quot;data_directory&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager-239"><a href="#UserManager-239"><span class="linenos">239</span></a>                    <span class="s2">&quot;directories_removed&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="UserManager-240"><a href="#UserManager-240"><span class="linenos">240</span></a>                    <span class="s2">&quot;files_removed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="UserManager-241"><a href="#UserManager-241"><span class="linenos">241</span></a>                    <span class="s2">&quot;total_size_mb&quot;</span><span class="p">:</span> <span class="mf">0.0</span>
</span><span id="UserManager-242"><a href="#UserManager-242"><span class="linenos">242</span></a>                <span class="p">},</span>
</span><span id="UserManager-243"><a href="#UserManager-243"><span class="linenos">243</span></a>                <span class="s2">&quot;backup_info&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="UserManager-244"><a href="#UserManager-244"><span class="linenos">244</span></a>                <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="UserManager-245"><a href="#UserManager-245"><span class="linenos">245</span></a>                <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="UserManager-246"><a href="#UserManager-246"><span class="linenos">246</span></a>            <span class="p">}</span>
</span><span id="UserManager-247"><a href="#UserManager-247"><span class="linenos">247</span></a>            
</span><span id="UserManager-248"><a href="#UserManager-248"><span class="linenos">248</span></a>            <span class="c1"># Get user data directory path</span>
</span><span id="UserManager-249"><a href="#UserManager-249"><span class="linenos">249</span></a>            <span class="n">user_data_dir</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="UserManager-250"><a href="#UserManager-250"><span class="linenos">250</span></a>            <span class="k">if</span> <span class="n">delete_data</span><span class="p">:</span>
</span><span id="UserManager-251"><a href="#UserManager-251"><span class="linenos">251</span></a>                <span class="n">user_data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_backend</span> <span class="o">/</span> <span class="n">user_id</span>
</span><span id="UserManager-252"><a href="#UserManager-252"><span class="linenos">252</span></a>                
</span><span id="UserManager-253"><a href="#UserManager-253"><span class="linenos">253</span></a>                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
</span><span id="UserManager-254"><a href="#UserManager-254"><span class="linenos">254</span></a>                    <span class="c1"># In dry-run mode, analyze what would be deleted</span>
</span><span id="UserManager-255"><a href="#UserManager-255"><span class="linenos">255</span></a>                    <span class="k">if</span> <span class="n">user_data_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="UserManager-256"><a href="#UserManager-256"><span class="linenos">256</span></a>                        <span class="n">size_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_directory_size</span><span class="p">(</span><span class="n">user_data_dir</span><span class="p">)</span>
</span><span id="UserManager-257"><a href="#UserManager-257"><span class="linenos">257</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;directories_removed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">user_data_dir</span><span class="p">)]</span>
</span><span id="UserManager-258"><a href="#UserManager-258"><span class="linenos">258</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;files_removed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;file_count&quot;</span><span class="p">]</span>
</span><span id="UserManager-259"><a href="#UserManager-259"><span class="linenos">259</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;total_size_mb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;size_mb&quot;</span><span class="p">]</span>
</span><span id="UserManager-260"><a href="#UserManager-260"><span class="linenos">260</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DRY RUN] Would delete user data directory: </span><span class="si">{</span><span class="n">user_data_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager-261"><a href="#UserManager-261"><span class="linenos">261</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DRY RUN] Would remove </span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;file_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> files (</span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;size_mb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
</span><span id="UserManager-262"><a href="#UserManager-262"><span class="linenos">262</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager-263"><a href="#UserManager-263"><span class="linenos">263</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DRY RUN] User data directory does not exist: </span><span class="si">{</span><span class="n">user_data_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager-264"><a href="#UserManager-264"><span class="linenos">264</span></a>                    
</span><span id="UserManager-265"><a href="#UserManager-265"><span class="linenos">265</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DRY RUN] Would remove user &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; from registry&quot;</span><span class="p">)</span>
</span><span id="UserManager-266"><a href="#UserManager-266"><span class="linenos">266</span></a>                    <span class="k">return</span> <span class="n">results</span>
</span><span id="UserManager-267"><a href="#UserManager-267"><span class="linenos">267</span></a>            
</span><span id="UserManager-268"><a href="#UserManager-268"><span class="linenos">268</span></a>            <span class="c1"># Backup data if requested</span>
</span><span id="UserManager-269"><a href="#UserManager-269"><span class="linenos">269</span></a>            <span class="k">if</span> <span class="n">backup_data</span> <span class="ow">and</span> <span class="n">user_data_dir</span> <span class="ow">and</span> <span class="n">user_data_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="UserManager-270"><a href="#UserManager-270"><span class="linenos">270</span></a>                <span class="n">backup_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_user_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_data_dir</span><span class="p">)</span>
</span><span id="UserManager-271"><a href="#UserManager-271"><span class="linenos">271</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;backup_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_result</span>
</span><span id="UserManager-272"><a href="#UserManager-272"><span class="linenos">272</span></a>                <span class="k">if</span> <span class="n">backup_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
</span><span id="UserManager-273"><a href="#UserManager-273"><span class="linenos">273</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backed up user data to: </span><span class="si">{</span><span class="n">backup_result</span><span class="p">[</span><span class="s1">&#39;backup_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager-274"><a href="#UserManager-274"><span class="linenos">274</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager-275"><a href="#UserManager-275"><span class="linenos">275</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backup failed: </span><span class="si">{</span><span class="n">backup_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager-276"><a href="#UserManager-276"><span class="linenos">276</span></a>            
</span><span id="UserManager-277"><a href="#UserManager-277"><span class="linenos">277</span></a>            <span class="c1"># Delete user data directory</span>
</span><span id="UserManager-278"><a href="#UserManager-278"><span class="linenos">278</span></a>            <span class="k">if</span> <span class="n">delete_data</span> <span class="ow">and</span> <span class="n">user_data_dir</span><span class="p">:</span>
</span><span id="UserManager-279"><a href="#UserManager-279"><span class="linenos">279</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-280"><a href="#UserManager-280"><span class="linenos">280</span></a>                    <span class="k">if</span> <span class="n">user_data_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="UserManager-281"><a href="#UserManager-281"><span class="linenos">281</span></a>                        <span class="c1"># Calculate size before deletion for reporting</span>
</span><span id="UserManager-282"><a href="#UserManager-282"><span class="linenos">282</span></a>                        <span class="n">size_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_directory_size</span><span class="p">(</span><span class="n">user_data_dir</span><span class="p">)</span>
</span><span id="UserManager-283"><a href="#UserManager-283"><span class="linenos">283</span></a>                        
</span><span id="UserManager-284"><a href="#UserManager-284"><span class="linenos">284</span></a>                        <span class="c1"># Remove the directory and all contents</span>
</span><span id="UserManager-285"><a href="#UserManager-285"><span class="linenos">285</span></a>                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">user_data_dir</span><span class="p">)</span>
</span><span id="UserManager-286"><a href="#UserManager-286"><span class="linenos">286</span></a>                        
</span><span id="UserManager-287"><a href="#UserManager-287"><span class="linenos">287</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;data_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="UserManager-288"><a href="#UserManager-288"><span class="linenos">288</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;directories_removed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">user_data_dir</span><span class="p">)]</span>
</span><span id="UserManager-289"><a href="#UserManager-289"><span class="linenos">289</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;files_removed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;file_count&quot;</span><span class="p">]</span>
</span><span id="UserManager-290"><a href="#UserManager-290"><span class="linenos">290</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;total_size_mb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;size_mb&quot;</span><span class="p">]</span>
</span><span id="UserManager-291"><a href="#UserManager-291"><span class="linenos">291</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted user data directory: </span><span class="si">{</span><span class="n">user_data_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager-292"><a href="#UserManager-292"><span class="linenos">292</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;file_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> files (</span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;size_mb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
</span><span id="UserManager-293"><a href="#UserManager-293"><span class="linenos">293</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager-294"><a href="#UserManager-294"><span class="linenos">294</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User data directory does not exist: </span><span class="si">{</span><span class="n">user_data_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager-295"><a href="#UserManager-295"><span class="linenos">295</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No user data directory to delete&quot;</span><span class="p">)</span>
</span><span id="UserManager-296"><a href="#UserManager-296"><span class="linenos">296</span></a>                        
</span><span id="UserManager-297"><a href="#UserManager-297"><span class="linenos">297</span></a>                <span class="k">except</span> <span class="ne">PermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager-298"><a href="#UserManager-298"><span class="linenos">298</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Permission denied deleting data directory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager-299"><a href="#UserManager-299"><span class="linenos">299</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="UserManager-300"><a href="#UserManager-300"><span class="linenos">300</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager-301"><a href="#UserManager-301"><span class="linenos">301</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting data directory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager-302"><a href="#UserManager-302"><span class="linenos">302</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="UserManager-303"><a href="#UserManager-303"><span class="linenos">303</span></a>            
</span><span id="UserManager-304"><a href="#UserManager-304"><span class="linenos">304</span></a>            <span class="c1"># Remove user from registry (always attempt this, even if data deletion failed)</span>
</span><span id="UserManager-305"><a href="#UserManager-305"><span class="linenos">305</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-306"><a href="#UserManager-306"><span class="linenos">306</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">remove_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
</span><span id="UserManager-307"><a href="#UserManager-307"><span class="linenos">307</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;registry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="UserManager-308"><a href="#UserManager-308"><span class="linenos">308</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed user &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; from registry&quot;</span><span class="p">)</span>
</span><span id="UserManager-309"><a href="#UserManager-309"><span class="linenos">309</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager-310"><a href="#UserManager-310"><span class="linenos">310</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove user &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; from registry&quot;</span><span class="p">)</span>
</span><span id="UserManager-311"><a href="#UserManager-311"><span class="linenos">311</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="UserManager-312"><a href="#UserManager-312"><span class="linenos">312</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager-313"><a href="#UserManager-313"><span class="linenos">313</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error removing user from registry: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager-314"><a href="#UserManager-314"><span class="linenos">314</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="UserManager-315"><a href="#UserManager-315"><span class="linenos">315</span></a>            
</span><span id="UserManager-316"><a href="#UserManager-316"><span class="linenos">316</span></a>            <span class="c1"># Set final message</span>
</span><span id="UserManager-317"><a href="#UserManager-317"><span class="linenos">317</span></a>            <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
</span><span id="UserManager-318"><a href="#UserManager-318"><span class="linenos">318</span></a>                <span class="k">if</span> <span class="n">delete_data</span><span class="p">:</span>
</span><span id="UserManager-319"><a href="#UserManager-319"><span class="linenos">319</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; and all associated data deleted successfully&quot;</span>
</span><span id="UserManager-320"><a href="#UserManager-320"><span class="linenos">320</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager-321"><a href="#UserManager-321"><span class="linenos">321</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; deleted from registry successfully&quot;</span>
</span><span id="UserManager-322"><a href="#UserManager-322"><span class="linenos">322</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager-323"><a href="#UserManager-323"><span class="linenos">323</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; deletion completed with errors&quot;</span>
</span><span id="UserManager-324"><a href="#UserManager-324"><span class="linenos">324</span></a>            
</span><span id="UserManager-325"><a href="#UserManager-325"><span class="linenos">325</span></a>            <span class="k">return</span> <span class="n">results</span>
</span><span id="UserManager-326"><a href="#UserManager-326"><span class="linenos">326</span></a>        
</span><span id="UserManager-327"><a href="#UserManager-327"><span class="linenos">327</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager-328"><a href="#UserManager-328"><span class="linenos">328</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-329"><a href="#UserManager-329"><span class="linenos">329</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager-330"><a href="#UserManager-330"><span class="linenos">330</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error deleting user: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager-331"><a href="#UserManager-331"><span class="linenos">331</span></a>            <span class="p">}</span>
</span><span id="UserManager-332"><a href="#UserManager-332"><span class="linenos">332</span></a>    
</span><span id="UserManager-333"><a href="#UserManager-333"><span class="linenos">333</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_directory_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager-334"><a href="#UserManager-334"><span class="linenos">334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-335"><a href="#UserManager-335"><span class="linenos">335</span></a><span class="sd">        Calculate the total size and file count of a directory.</span>
</span><span id="UserManager-336"><a href="#UserManager-336"><span class="linenos">336</span></a><span class="sd">        </span>
</span><span id="UserManager-337"><a href="#UserManager-337"><span class="linenos">337</span></a><span class="sd">        Args:</span>
</span><span id="UserManager-338"><a href="#UserManager-338"><span class="linenos">338</span></a><span class="sd">            directory: Path to the directory</span>
</span><span id="UserManager-339"><a href="#UserManager-339"><span class="linenos">339</span></a><span class="sd">            </span>
</span><span id="UserManager-340"><a href="#UserManager-340"><span class="linenos">340</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager-341"><a href="#UserManager-341"><span class="linenos">341</span></a><span class="sd">            Dictionary with size information</span>
</span><span id="UserManager-342"><a href="#UserManager-342"><span class="linenos">342</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-343"><a href="#UserManager-343"><span class="linenos">343</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-344"><a href="#UserManager-344"><span class="linenos">344</span></a>            <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="UserManager-345"><a href="#UserManager-345"><span class="linenos">345</span></a>            <span class="n">file_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="UserManager-346"><a href="#UserManager-346"><span class="linenos">346</span></a>            
</span><span id="UserManager-347"><a href="#UserManager-347"><span class="linenos">347</span></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">directory</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
</span><span id="UserManager-348"><a href="#UserManager-348"><span class="linenos">348</span></a>                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
</span><span id="UserManager-349"><a href="#UserManager-349"><span class="linenos">349</span></a>                    <span class="n">file_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="UserManager-350"><a href="#UserManager-350"><span class="linenos">350</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-351"><a href="#UserManager-351"><span class="linenos">351</span></a>                        <span class="n">total_size</span> <span class="o">+=</span> <span class="n">path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
</span><span id="UserManager-352"><a href="#UserManager-352"><span class="linenos">352</span></a>                    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
</span><span id="UserManager-353"><a href="#UserManager-353"><span class="linenos">353</span></a>                        <span class="c1"># Skip files we can&#39;t access</span>
</span><span id="UserManager-354"><a href="#UserManager-354"><span class="linenos">354</span></a>                        <span class="k">pass</span>
</span><span id="UserManager-355"><a href="#UserManager-355"><span class="linenos">355</span></a>            
</span><span id="UserManager-356"><a href="#UserManager-356"><span class="linenos">356</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-357"><a href="#UserManager-357"><span class="linenos">357</span></a>                <span class="s2">&quot;size_bytes&quot;</span><span class="p">:</span> <span class="n">total_size</span><span class="p">,</span>
</span><span id="UserManager-358"><a href="#UserManager-358"><span class="linenos">358</span></a>                <span class="s2">&quot;size_mb&quot;</span><span class="p">:</span> <span class="n">total_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span>
</span><span id="UserManager-359"><a href="#UserManager-359"><span class="linenos">359</span></a>                <span class="s2">&quot;file_count&quot;</span><span class="p">:</span> <span class="n">file_count</span>
</span><span id="UserManager-360"><a href="#UserManager-360"><span class="linenos">360</span></a>            <span class="p">}</span>
</span><span id="UserManager-361"><a href="#UserManager-361"><span class="linenos">361</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="UserManager-362"><a href="#UserManager-362"><span class="linenos">362</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-363"><a href="#UserManager-363"><span class="linenos">363</span></a>                <span class="s2">&quot;size_bytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="UserManager-364"><a href="#UserManager-364"><span class="linenos">364</span></a>                <span class="s2">&quot;size_mb&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="UserManager-365"><a href="#UserManager-365"><span class="linenos">365</span></a>                <span class="s2">&quot;file_count&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="UserManager-366"><a href="#UserManager-366"><span class="linenos">366</span></a>            <span class="p">}</span>
</span><span id="UserManager-367"><a href="#UserManager-367"><span class="linenos">367</span></a>    
</span><span id="UserManager-368"><a href="#UserManager-368"><span class="linenos">368</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_backup_user_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_data_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager-369"><a href="#UserManager-369"><span class="linenos">369</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-370"><a href="#UserManager-370"><span class="linenos">370</span></a><span class="sd">        Create a backup of user data before deletion.</span>
</span><span id="UserManager-371"><a href="#UserManager-371"><span class="linenos">371</span></a><span class="sd">        </span>
</span><span id="UserManager-372"><a href="#UserManager-372"><span class="linenos">372</span></a><span class="sd">        Args:</span>
</span><span id="UserManager-373"><a href="#UserManager-373"><span class="linenos">373</span></a><span class="sd">            user_id: User ID being backed up</span>
</span><span id="UserManager-374"><a href="#UserManager-374"><span class="linenos">374</span></a><span class="sd">            user_data_dir: Path to user&#39;s data directory</span>
</span><span id="UserManager-375"><a href="#UserManager-375"><span class="linenos">375</span></a><span class="sd">            </span>
</span><span id="UserManager-376"><a href="#UserManager-376"><span class="linenos">376</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager-377"><a href="#UserManager-377"><span class="linenos">377</span></a><span class="sd">            Dictionary with backup result information</span>
</span><span id="UserManager-378"><a href="#UserManager-378"><span class="linenos">378</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-379"><a href="#UserManager-379"><span class="linenos">379</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-380"><a href="#UserManager-380"><span class="linenos">380</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="UserManager-381"><a href="#UserManager-381"><span class="linenos">381</span></a>            
</span><span id="UserManager-382"><a href="#UserManager-382"><span class="linenos">382</span></a>            <span class="c1"># Create backup directory</span>
</span><span id="UserManager-383"><a href="#UserManager-383"><span class="linenos">383</span></a>            <span class="n">backup_base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./backups/users&quot;</span><span class="p">)</span>
</span><span id="UserManager-384"><a href="#UserManager-384"><span class="linenos">384</span></a>            <span class="n">backup_base</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="UserManager-385"><a href="#UserManager-385"><span class="linenos">385</span></a>            
</span><span id="UserManager-386"><a href="#UserManager-386"><span class="linenos">386</span></a>            <span class="c1"># Generate backup filename with timestamp</span>
</span><span id="UserManager-387"><a href="#UserManager-387"><span class="linenos">387</span></a>            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
</span><span id="UserManager-388"><a href="#UserManager-388"><span class="linenos">388</span></a>            <span class="n">backup_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager-389"><a href="#UserManager-389"><span class="linenos">389</span></a>            <span class="n">backup_path</span> <span class="o">=</span> <span class="n">backup_base</span> <span class="o">/</span> <span class="n">backup_name</span>
</span><span id="UserManager-390"><a href="#UserManager-390"><span class="linenos">390</span></a>            
</span><span id="UserManager-391"><a href="#UserManager-391"><span class="linenos">391</span></a>            <span class="c1"># Copy the entire user directory</span>
</span><span id="UserManager-392"><a href="#UserManager-392"><span class="linenos">392</span></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">user_data_dir</span><span class="p">,</span> <span class="n">backup_path</span><span class="p">)</span>
</span><span id="UserManager-393"><a href="#UserManager-393"><span class="linenos">393</span></a>            
</span><span id="UserManager-394"><a href="#UserManager-394"><span class="linenos">394</span></a>            <span class="c1"># Calculate backup size</span>
</span><span id="UserManager-395"><a href="#UserManager-395"><span class="linenos">395</span></a>            <span class="n">size_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_directory_size</span><span class="p">(</span><span class="n">backup_path</span><span class="p">)</span>
</span><span id="UserManager-396"><a href="#UserManager-396"><span class="linenos">396</span></a>            
</span><span id="UserManager-397"><a href="#UserManager-397"><span class="linenos">397</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-398"><a href="#UserManager-398"><span class="linenos">398</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="UserManager-399"><a href="#UserManager-399"><span class="linenos">399</span></a>                <span class="s2">&quot;backup_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">backup_path</span><span class="p">),</span>
</span><span id="UserManager-400"><a href="#UserManager-400"><span class="linenos">400</span></a>                <span class="s2">&quot;backup_size_mb&quot;</span><span class="p">:</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;size_mb&quot;</span><span class="p">],</span>
</span><span id="UserManager-401"><a href="#UserManager-401"><span class="linenos">401</span></a>                <span class="s2">&quot;files_backed_up&quot;</span><span class="p">:</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;file_count&quot;</span><span class="p">],</span>
</span><span id="UserManager-402"><a href="#UserManager-402"><span class="linenos">402</span></a>                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span>
</span><span id="UserManager-403"><a href="#UserManager-403"><span class="linenos">403</span></a>            <span class="p">}</span>
</span><span id="UserManager-404"><a href="#UserManager-404"><span class="linenos">404</span></a>            
</span><span id="UserManager-405"><a href="#UserManager-405"><span class="linenos">405</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager-406"><a href="#UserManager-406"><span class="linenos">406</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-407"><a href="#UserManager-407"><span class="linenos">407</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager-408"><a href="#UserManager-408"><span class="linenos">408</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Backup failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager-409"><a href="#UserManager-409"><span class="linenos">409</span></a>            <span class="p">}</span>
</span><span id="UserManager-410"><a href="#UserManager-410"><span class="linenos">410</span></a>    
</span><span id="UserManager-411"><a href="#UserManager-411"><span class="linenos">411</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">restart_lightrag_for_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager-412"><a href="#UserManager-412"><span class="linenos">412</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-413"><a href="#UserManager-413"><span class="linenos">413</span></a><span class="sd">        Restart LightRAG services for the current user.</span>
</span><span id="UserManager-414"><a href="#UserManager-414"><span class="linenos">414</span></a><span class="sd">        </span>
</span><span id="UserManager-415"><a href="#UserManager-415"><span class="linenos">415</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager-416"><a href="#UserManager-416"><span class="linenos">416</span></a><span class="sd">            Dictionary containing result information</span>
</span><span id="UserManager-417"><a href="#UserManager-417"><span class="linenos">417</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-418"><a href="#UserManager-418"><span class="linenos">418</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-419"><a href="#UserManager-419"><span class="linenos">419</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_user_id</span>
</span><span id="UserManager-420"><a href="#UserManager-420"><span class="linenos">420</span></a>            <span class="n">current_user</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="UserManager-421"><a href="#UserManager-421"><span class="linenos">421</span></a>            
</span><span id="UserManager-422"><a href="#UserManager-422"><span class="linenos">422</span></a>            <span class="c1"># Ensure current user is registered</span>
</span><span id="UserManager-423"><a href="#UserManager-423"><span class="linenos">423</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">ensure_current_user_registered</span><span class="p">()</span>
</span><span id="UserManager-424"><a href="#UserManager-424"><span class="linenos">424</span></a>            
</span><span id="UserManager-425"><a href="#UserManager-425"><span class="linenos">425</span></a>            <span class="c1"># Restart LightRAG services</span>
</span><span id="UserManager-426"><a href="#UserManager-426"><span class="linenos">426</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_manager</span><span class="o">.</span><span class="n">restart_lightrag_services</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
</span><span id="UserManager-427"><a href="#UserManager-427"><span class="linenos">427</span></a>            
</span><span id="UserManager-428"><a href="#UserManager-428"><span class="linenos">428</span></a>            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
</span><span id="UserManager-429"><a href="#UserManager-429"><span class="linenos">429</span></a>                <span class="c1"># Update user&#39;s last_seen timestamp</span>
</span><span id="UserManager-430"><a href="#UserManager-430"><span class="linenos">430</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">update_last_seen</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
</span><span id="UserManager-431"><a href="#UserManager-431"><span class="linenos">431</span></a>            
</span><span id="UserManager-432"><a href="#UserManager-432"><span class="linenos">432</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="UserManager-433"><a href="#UserManager-433"><span class="linenos">433</span></a>        
</span><span id="UserManager-434"><a href="#UserManager-434"><span class="linenos">434</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager-435"><a href="#UserManager-435"><span class="linenos">435</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-436"><a href="#UserManager-436"><span class="linenos">436</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager-437"><a href="#UserManager-437"><span class="linenos">437</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error restarting LightRAG: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager-438"><a href="#UserManager-438"><span class="linenos">438</span></a>            <span class="p">}</span>
</span><span id="UserManager-439"><a href="#UserManager-439"><span class="linenos">439</span></a>    
</span><span id="UserManager-440"><a href="#UserManager-440"><span class="linenos">440</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_lightrag_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager-441"><a href="#UserManager-441"><span class="linenos">441</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-442"><a href="#UserManager-442"><span class="linenos">442</span></a><span class="sd">        Get current LightRAG service status.</span>
</span><span id="UserManager-443"><a href="#UserManager-443"><span class="linenos">443</span></a><span class="sd">        </span>
</span><span id="UserManager-444"><a href="#UserManager-444"><span class="linenos">444</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager-445"><a href="#UserManager-445"><span class="linenos">445</span></a><span class="sd">            Dictionary with service status information</span>
</span><span id="UserManager-446"><a href="#UserManager-446"><span class="linenos">446</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-447"><a href="#UserManager-447"><span class="linenos">447</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-448"><a href="#UserManager-448"><span class="linenos">448</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_manager</span><span class="o">.</span><span class="n">get_service_status</span><span class="p">()</span>
</span><span id="UserManager-449"><a href="#UserManager-449"><span class="linenos">449</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager-450"><a href="#UserManager-450"><span class="linenos">450</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-451"><a href="#UserManager-451"><span class="linenos">451</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error getting LightRAG status: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager-452"><a href="#UserManager-452"><span class="linenos">452</span></a>            <span class="p">}</span>
</span><span id="UserManager-453"><a href="#UserManager-453"><span class="linenos">453</span></a>    
</span><span id="UserManager-454"><a href="#UserManager-454"><span class="linenos">454</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_current_user_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserManager-455"><a href="#UserManager-455"><span class="linenos">455</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-456"><a href="#UserManager-456"><span class="linenos">456</span></a><span class="sd">        Ensure the current USER_ID is registered in the registry.</span>
</span><span id="UserManager-457"><a href="#UserManager-457"><span class="linenos">457</span></a><span class="sd">        </span>
</span><span id="UserManager-458"><a href="#UserManager-458"><span class="linenos">458</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager-459"><a href="#UserManager-459"><span class="linenos">459</span></a><span class="sd">            True if user was already registered or successfully added</span>
</span><span id="UserManager-460"><a href="#UserManager-460"><span class="linenos">460</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-461"><a href="#UserManager-461"><span class="linenos">461</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">ensure_current_user_registered</span><span class="p">()</span>
</span><span id="UserManager-462"><a href="#UserManager-462"><span class="linenos">462</span></a>    
</span><span id="UserManager-463"><a href="#UserManager-463"><span class="linenos">463</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager-464"><a href="#UserManager-464"><span class="linenos">464</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-465"><a href="#UserManager-465"><span class="linenos">465</span></a><span class="sd">        Update user information.</span>
</span><span id="UserManager-466"><a href="#UserManager-466"><span class="linenos">466</span></a><span class="sd">        </span>
</span><span id="UserManager-467"><a href="#UserManager-467"><span class="linenos">467</span></a><span class="sd">        Args:</span>
</span><span id="UserManager-468"><a href="#UserManager-468"><span class="linenos">468</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserManager-469"><a href="#UserManager-469"><span class="linenos">469</span></a><span class="sd">            **kwargs: Fields to update (user_name, user_type, etc.)</span>
</span><span id="UserManager-470"><a href="#UserManager-470"><span class="linenos">470</span></a><span class="sd">            </span>
</span><span id="UserManager-471"><a href="#UserManager-471"><span class="linenos">471</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager-472"><a href="#UserManager-472"><span class="linenos">472</span></a><span class="sd">            Dictionary containing result information</span>
</span><span id="UserManager-473"><a href="#UserManager-473"><span class="linenos">473</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-474"><a href="#UserManager-474"><span class="linenos">474</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-475"><a href="#UserManager-475"><span class="linenos">475</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="UserManager-476"><a href="#UserManager-476"><span class="linenos">476</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-477"><a href="#UserManager-477"><span class="linenos">477</span></a>                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="UserManager-478"><a href="#UserManager-478"><span class="linenos">478</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; updated successfully&quot;</span>
</span><span id="UserManager-479"><a href="#UserManager-479"><span class="linenos">479</span></a>                <span class="p">}</span>
</span><span id="UserManager-480"><a href="#UserManager-480"><span class="linenos">480</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager-481"><a href="#UserManager-481"><span class="linenos">481</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-482"><a href="#UserManager-482"><span class="linenos">482</span></a>                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager-483"><a href="#UserManager-483"><span class="linenos">483</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span>
</span><span id="UserManager-484"><a href="#UserManager-484"><span class="linenos">484</span></a>                <span class="p">}</span>
</span><span id="UserManager-485"><a href="#UserManager-485"><span class="linenos">485</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager-486"><a href="#UserManager-486"><span class="linenos">486</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager-487"><a href="#UserManager-487"><span class="linenos">487</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager-488"><a href="#UserManager-488"><span class="linenos">488</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error updating user: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager-489"><a href="#UserManager-489"><span class="linenos">489</span></a>            <span class="p">}</span>
</span><span id="UserManager-490"><a href="#UserManager-490"><span class="linenos">490</span></a>    
</span><span id="UserManager-491"><a href="#UserManager-491"><span class="linenos">491</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager-492"><a href="#UserManager-492"><span class="linenos">492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager-493"><a href="#UserManager-493"><span class="linenos">493</span></a><span class="sd">        Get detailed information for a specific user.</span>
</span><span id="UserManager-494"><a href="#UserManager-494"><span class="linenos">494</span></a><span class="sd">        </span>
</span><span id="UserManager-495"><a href="#UserManager-495"><span class="linenos">495</span></a><span class="sd">        Args:</span>
</span><span id="UserManager-496"><a href="#UserManager-496"><span class="linenos">496</span></a><span class="sd">            user_id: User ID to get details for</span>
</span><span id="UserManager-497"><a href="#UserManager-497"><span class="linenos">497</span></a><span class="sd">            </span>
</span><span id="UserManager-498"><a href="#UserManager-498"><span class="linenos">498</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager-499"><a href="#UserManager-499"><span class="linenos">499</span></a><span class="sd">            Dictionary containing user details</span>
</span><span id="UserManager-500"><a href="#UserManager-500"><span class="linenos">500</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager-501"><a href="#UserManager-501"><span class="linenos">501</span></a>        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="UserManager-502"><a href="#UserManager-502"><span class="linenos">502</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="UserManager-503"><a href="#UserManager-503"><span class="linenos">503</span></a>            <span class="k">return</span> <span class="p">{}</span>
</span><span id="UserManager-504"><a href="#UserManager-504"><span class="linenos">504</span></a>        
</span><span id="UserManager-505"><a href="#UserManager-505"><span class="linenos">505</span></a>        <span class="c1"># Add additional details</span>
</span><span id="UserManager-506"><a href="#UserManager-506"><span class="linenos">506</span></a>        <span class="n">user_details</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="UserManager-507"><a href="#UserManager-507"><span class="linenos">507</span></a>        
</span><span id="UserManager-508"><a href="#UserManager-508"><span class="linenos">508</span></a>        <span class="c1"># Add current user status</span>
</span><span id="UserManager-509"><a href="#UserManager-509"><span class="linenos">509</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_user_id</span>
</span><span id="UserManager-510"><a href="#UserManager-510"><span class="linenos">510</span></a>        <span class="n">user_details</span><span class="p">[</span><span class="s2">&quot;is_current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">get_current_user_id</span><span class="p">())</span>
</span><span id="UserManager-511"><a href="#UserManager-511"><span class="linenos">511</span></a>        
</span><span id="UserManager-512"><a href="#UserManager-512"><span class="linenos">512</span></a>        <span class="c1"># Add LightRAG status if this is the current user</span>
</span><span id="UserManager-513"><a href="#UserManager-513"><span class="linenos">513</span></a>        <span class="k">if</span> <span class="n">user_details</span><span class="p">[</span><span class="s2">&quot;is_current&quot;</span><span class="p">]:</span>
</span><span id="UserManager-514"><a href="#UserManager-514"><span class="linenos">514</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager-515"><a href="#UserManager-515"><span class="linenos">515</span></a>                <span class="n">lightrag_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lightrag_status</span><span class="p">()</span>
</span><span id="UserManager-516"><a href="#UserManager-516"><span class="linenos">516</span></a>                <span class="n">user_details</span><span class="p">[</span><span class="s2">&quot;lightrag_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lightrag_status</span>
</span><span id="UserManager-517"><a href="#UserManager-517"><span class="linenos">517</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="UserManager-518"><a href="#UserManager-518"><span class="linenos">518</span></a>                <span class="n">user_details</span><span class="p">[</span><span class="s2">&quot;lightrag_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Could not get LightRAG status&quot;</span><span class="p">}</span>
</span><span id="UserManager-519"><a href="#UserManager-519"><span class="linenos">519</span></a>        
</span><span id="UserManager-520"><a href="#UserManager-520"><span class="linenos">520</span></a>        <span class="k">return</span> <span class="n">user_details</span>
</span></pre></div>


            <div class="docstring"><p>Complete user management with LightRAG integration.</p>
</div>


                            <div id="UserManager.__init__" class="classattr">
                                        <input id="UserManager.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">UserManager</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">storage_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">project_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="UserManager.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserManager.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserManager.__init__-21"><a href="#UserManager.__init__-21"><span class="linenos">21</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">storage_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">project_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="UserManager.__init__-22"><a href="#UserManager.__init__-22"><span class="linenos">22</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager.__init__-23"><a href="#UserManager.__init__-23"><span class="linenos">23</span></a><span class="sd">        Initialize the user manager.</span>
</span><span id="UserManager.__init__-24"><a href="#UserManager.__init__-24"><span class="linenos">24</span></a><span class="sd">        </span>
</span><span id="UserManager.__init__-25"><a href="#UserManager.__init__-25"><span class="linenos">25</span></a><span class="sd">        Args:</span>
</span><span id="UserManager.__init__-26"><a href="#UserManager.__init__-26"><span class="linenos">26</span></a><span class="sd">            data_dir: Data directory path (defaults to config DATA_DIR)</span>
</span><span id="UserManager.__init__-27"><a href="#UserManager.__init__-27"><span class="linenos">27</span></a><span class="sd">            storage_backend: Storage backend (defaults to config STORAGE_BACKEND)</span>
</span><span id="UserManager.__init__-28"><a href="#UserManager.__init__-28"><span class="linenos">28</span></a><span class="sd">            project_root: Project root directory (deprecated, LightRAGManager now uses PERSAG_HOME)</span>
</span><span id="UserManager.__init__-29"><a href="#UserManager.__init__-29"><span class="linenos">29</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager.__init__-30"><a href="#UserManager.__init__-30"><span class="linenos">30</span></a>        <span class="c1"># Store the configuration for use in methods</span>
</span><span id="UserManager.__init__-31"><a href="#UserManager.__init__-31"><span class="linenos">31</span></a>        <span class="k">if</span> <span class="n">data_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">storage_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="UserManager.__init__-32"><a href="#UserManager.__init__-32"><span class="linenos">32</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">STORAGE_BACKEND</span>
</span><span id="UserManager.__init__-33"><a href="#UserManager.__init__-33"><span class="linenos">33</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="ow">or</span> <span class="n">DATA_DIR</span>
</span><span id="UserManager.__init__-34"><a href="#UserManager.__init__-34"><span class="linenos">34</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">storage_backend</span> <span class="o">=</span> <span class="n">storage_backend</span> <span class="ow">or</span> <span class="n">STORAGE_BACKEND</span>
</span><span id="UserManager.__init__-35"><a href="#UserManager.__init__-35"><span class="linenos">35</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager.__init__-36"><a href="#UserManager.__init__-36"><span class="linenos">36</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
</span><span id="UserManager.__init__-37"><a href="#UserManager.__init__-37"><span class="linenos">37</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">storage_backend</span> <span class="o">=</span> <span class="n">storage_backend</span>
</span><span id="UserManager.__init__-38"><a href="#UserManager.__init__-38"><span class="linenos">38</span></a>            
</span><span id="UserManager.__init__-39"><a href="#UserManager.__init__-39"><span class="linenos">39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">UserRegistry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_backend</span><span class="p">)</span>
</span><span id="UserManager.__init__-40"><a href="#UserManager.__init__-40"><span class="linenos">40</span></a>        <span class="c1"># LightRAGManager now uses PERSAG_HOME internally, project_root parameter is deprecated</span>
</span><span id="UserManager.__init__-41"><a href="#UserManager.__init__-41"><span class="linenos">41</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_manager</span> <span class="o">=</span> <span class="n">LightRAGManager</span><span class="p">(</span><span class="n">project_root</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the user manager.</p>

<p>Args:
    data_dir: Data directory path (defaults to config DATA_DIR)
    storage_backend: Storage backend (defaults to config STORAGE_BACKEND)
    project_root: Project root directory (deprecated, LightRAGManager now uses PERSAG_HOME)</p>
</div>


                            </div>
                            <div id="UserManager.registry" class="classattr">
                                <div class="attr variable">
            <span class="name">registry</span>

        
    </div>
    <a class="headerlink" href="#UserManager.registry"></a>
    
    

                            </div>
                            <div id="UserManager.lightrag_manager" class="classattr">
                                <div class="attr variable">
            <span class="name">lightrag_manager</span>

        
    </div>
    <a class="headerlink" href="#UserManager.lightrag_manager"></a>
    
    

                            </div>
                            <div id="UserManager.get_all_users" class="classattr">
                                        <input id="UserManager.get_all_users-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_all_users</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="UserManager.get_all_users-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserManager.get_all_users"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserManager.get_all_users-43"><a href="#UserManager.get_all_users-43"><span class="linenos">43</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_users</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="UserManager.get_all_users-44"><a href="#UserManager.get_all_users-44"><span class="linenos">44</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager.get_all_users-45"><a href="#UserManager.get_all_users-45"><span class="linenos">45</span></a><span class="sd">        Get all users from the registry.</span>
</span><span id="UserManager.get_all_users-46"><a href="#UserManager.get_all_users-46"><span class="linenos">46</span></a><span class="sd">        </span>
</span><span id="UserManager.get_all_users-47"><a href="#UserManager.get_all_users-47"><span class="linenos">47</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager.get_all_users-48"><a href="#UserManager.get_all_users-48"><span class="linenos">48</span></a><span class="sd">            List of user dictionaries with current user marked</span>
</span><span id="UserManager.get_all_users-49"><a href="#UserManager.get_all_users-49"><span class="linenos">49</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager.get_all_users-50"><a href="#UserManager.get_all_users-50"><span class="linenos">50</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_all_users</span><span class="p">()</span>
</span><span id="UserManager.get_all_users-51"><a href="#UserManager.get_all_users-51"><span class="linenos">51</span></a>        
</span><span id="UserManager.get_all_users-52"><a href="#UserManager.get_all_users-52"><span class="linenos">52</span></a>        <span class="c1"># Mark current user</span>
</span><span id="UserManager.get_all_users-53"><a href="#UserManager.get_all_users-53"><span class="linenos">53</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_user_id</span>
</span><span id="UserManager.get_all_users-54"><a href="#UserManager.get_all_users-54"><span class="linenos">54</span></a>        <span class="n">current_user_id</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="UserManager.get_all_users-55"><a href="#UserManager.get_all_users-55"><span class="linenos">55</span></a>        
</span><span id="UserManager.get_all_users-56"><a href="#UserManager.get_all_users-56"><span class="linenos">56</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
</span><span id="UserManager.get_all_users-57"><a href="#UserManager.get_all_users-57"><span class="linenos">57</span></a>            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;is_current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_user_id</span><span class="p">)</span>
</span><span id="UserManager.get_all_users-58"><a href="#UserManager.get_all_users-58"><span class="linenos">58</span></a>        
</span><span id="UserManager.get_all_users-59"><a href="#UserManager.get_all_users-59"><span class="linenos">59</span></a>        <span class="k">return</span> <span class="n">users</span>
</span></pre></div>


            <div class="docstring"><p>Get all users from the registry.</p>

<p>Returns:
    List of user dictionaries with current user marked</p>
</div>


                            </div>
                            <div id="UserManager.get_user" class="classattr">
                                        <input id="UserManager.get_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_user</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="UserManager.get_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserManager.get_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserManager.get_user-61"><a href="#UserManager.get_user-61"><span class="linenos">61</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="UserManager.get_user-62"><a href="#UserManager.get_user-62"><span class="linenos">62</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager.get_user-63"><a href="#UserManager.get_user-63"><span class="linenos">63</span></a><span class="sd">        Get a specific user from the registry.</span>
</span><span id="UserManager.get_user-64"><a href="#UserManager.get_user-64"><span class="linenos">64</span></a><span class="sd">        </span>
</span><span id="UserManager.get_user-65"><a href="#UserManager.get_user-65"><span class="linenos">65</span></a><span class="sd">        Args:</span>
</span><span id="UserManager.get_user-66"><a href="#UserManager.get_user-66"><span class="linenos">66</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserManager.get_user-67"><a href="#UserManager.get_user-67"><span class="linenos">67</span></a><span class="sd">            </span>
</span><span id="UserManager.get_user-68"><a href="#UserManager.get_user-68"><span class="linenos">68</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager.get_user-69"><a href="#UserManager.get_user-69"><span class="linenos">69</span></a><span class="sd">            User dictionary or None if not found</span>
</span><span id="UserManager.get_user-70"><a href="#UserManager.get_user-70"><span class="linenos">70</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager.get_user-71"><a href="#UserManager.get_user-71"><span class="linenos">71</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get a specific user from the registry.</p>

<p>Args:
    user_id: User identifier</p>

<p>Returns:
    User dictionary or None if not found</p>
</div>


                            </div>
                            <div id="UserManager.create_user" class="classattr">
                                        <input id="UserManager.create_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_user</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">user_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Standard&#39;</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="UserManager.create_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserManager.create_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserManager.create_user-73"><a href="#UserManager.create_user-73"><span class="linenos"> 73</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">user_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Standard&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager.create_user-74"><a href="#UserManager.create_user-74"><span class="linenos"> 74</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager.create_user-75"><a href="#UserManager.create_user-75"><span class="linenos"> 75</span></a><span class="sd">        Create a new user in the system.</span>
</span><span id="UserManager.create_user-76"><a href="#UserManager.create_user-76"><span class="linenos"> 76</span></a><span class="sd">        </span>
</span><span id="UserManager.create_user-77"><a href="#UserManager.create_user-77"><span class="linenos"> 77</span></a><span class="sd">        Args:</span>
</span><span id="UserManager.create_user-78"><a href="#UserManager.create_user-78"><span class="linenos"> 78</span></a><span class="sd">            user_id: Unique user identifier</span>
</span><span id="UserManager.create_user-79"><a href="#UserManager.create_user-79"><span class="linenos"> 79</span></a><span class="sd">            user_name: Display name for the user (defaults to user_id)</span>
</span><span id="UserManager.create_user-80"><a href="#UserManager.create_user-80"><span class="linenos"> 80</span></a><span class="sd">            user_type: User type (Standard, Admin, Guest)</span>
</span><span id="UserManager.create_user-81"><a href="#UserManager.create_user-81"><span class="linenos"> 81</span></a><span class="sd">            </span>
</span><span id="UserManager.create_user-82"><a href="#UserManager.create_user-82"><span class="linenos"> 82</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager.create_user-83"><a href="#UserManager.create_user-83"><span class="linenos"> 83</span></a><span class="sd">            Dictionary containing result information</span>
</span><span id="UserManager.create_user-84"><a href="#UserManager.create_user-84"><span class="linenos"> 84</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager.create_user-85"><a href="#UserManager.create_user-85"><span class="linenos"> 85</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager.create_user-86"><a href="#UserManager.create_user-86"><span class="linenos"> 86</span></a>            <span class="c1"># Validate input</span>
</span><span id="UserManager.create_user-87"><a href="#UserManager.create_user-87"><span class="linenos"> 87</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserManager.create_user-88"><a href="#UserManager.create_user-88"><span class="linenos"> 88</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User ID is required&quot;</span><span class="p">}</span>
</span><span id="UserManager.create_user-89"><a href="#UserManager.create_user-89"><span class="linenos"> 89</span></a>            
</span><span id="UserManager.create_user-90"><a href="#UserManager.create_user-90"><span class="linenos"> 90</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_name</span><span class="p">:</span>
</span><span id="UserManager.create_user-91"><a href="#UserManager.create_user-91"><span class="linenos"> 91</span></a>                <span class="n">user_name</span> <span class="o">=</span> <span class="n">user_id</span>
</span><span id="UserManager.create_user-92"><a href="#UserManager.create_user-92"><span class="linenos"> 92</span></a>            
</span><span id="UserManager.create_user-93"><a href="#UserManager.create_user-93"><span class="linenos"> 93</span></a>            <span class="c1"># Add user to registry</span>
</span><span id="UserManager.create_user-94"><a href="#UserManager.create_user-94"><span class="linenos"> 94</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">user_type</span><span class="p">):</span>
</span><span id="UserManager.create_user-95"><a href="#UserManager.create_user-95"><span class="linenos"> 95</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager.create_user-96"><a href="#UserManager.create_user-96"><span class="linenos"> 96</span></a>                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="UserManager.create_user-97"><a href="#UserManager.create_user-97"><span class="linenos"> 97</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; created successfully&quot;</span><span class="p">,</span>
</span><span id="UserManager.create_user-98"><a href="#UserManager.create_user-98"><span class="linenos"> 98</span></a>                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span>
</span><span id="UserManager.create_user-99"><a href="#UserManager.create_user-99"><span class="linenos"> 99</span></a>                <span class="p">}</span>
</span><span id="UserManager.create_user-100"><a href="#UserManager.create_user-100"><span class="linenos">100</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager.create_user-101"><a href="#UserManager.create_user-101"><span class="linenos">101</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager.create_user-102"><a href="#UserManager.create_user-102"><span class="linenos">102</span></a>                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager.create_user-103"><a href="#UserManager.create_user-103"><span class="linenos">103</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; already exists&quot;</span>
</span><span id="UserManager.create_user-104"><a href="#UserManager.create_user-104"><span class="linenos">104</span></a>                <span class="p">}</span>
</span><span id="UserManager.create_user-105"><a href="#UserManager.create_user-105"><span class="linenos">105</span></a>        
</span><span id="UserManager.create_user-106"><a href="#UserManager.create_user-106"><span class="linenos">106</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager.create_user-107"><a href="#UserManager.create_user-107"><span class="linenos">107</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager.create_user-108"><a href="#UserManager.create_user-108"><span class="linenos">108</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager.create_user-109"><a href="#UserManager.create_user-109"><span class="linenos">109</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error creating user: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager.create_user-110"><a href="#UserManager.create_user-110"><span class="linenos">110</span></a>            <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Create a new user in the system.</p>

<p>Args:
    user_id: Unique user identifier
    user_name: Display name for the user (defaults to user_id)
    user_type: User type (Standard, Admin, Guest)</p>

<p>Returns:
    Dictionary containing result information</p>
</div>


                            </div>
                            <div id="UserManager.switch_user" class="classattr">
                                        <input id="UserManager.switch_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">switch_user</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">restart_lightrag</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">update_global_config</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="UserManager.switch_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserManager.switch_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserManager.switch_user-112"><a href="#UserManager.switch_user-112"><span class="linenos">112</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">switch_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">restart_lightrag</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">update_global_config</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager.switch_user-113"><a href="#UserManager.switch_user-113"><span class="linenos">113</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager.switch_user-114"><a href="#UserManager.switch_user-114"><span class="linenos">114</span></a><span class="sd">        Switch to a different user with complete system integration.</span>
</span><span id="UserManager.switch_user-115"><a href="#UserManager.switch_user-115"><span class="linenos">115</span></a><span class="sd">        </span>
</span><span id="UserManager.switch_user-116"><a href="#UserManager.switch_user-116"><span class="linenos">116</span></a><span class="sd">        Args:</span>
</span><span id="UserManager.switch_user-117"><a href="#UserManager.switch_user-117"><span class="linenos">117</span></a><span class="sd">            user_id: User ID to switch to</span>
</span><span id="UserManager.switch_user-118"><a href="#UserManager.switch_user-118"><span class="linenos">118</span></a><span class="sd">            restart_lightrag: Whether to restart LightRAG services</span>
</span><span id="UserManager.switch_user-119"><a href="#UserManager.switch_user-119"><span class="linenos">119</span></a><span class="sd">            update_global_config: Whether to update global USER_ID configuration</span>
</span><span id="UserManager.switch_user-120"><a href="#UserManager.switch_user-120"><span class="linenos">120</span></a><span class="sd">            </span>
</span><span id="UserManager.switch_user-121"><a href="#UserManager.switch_user-121"><span class="linenos">121</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager.switch_user-122"><a href="#UserManager.switch_user-122"><span class="linenos">122</span></a><span class="sd">            Dictionary containing result information</span>
</span><span id="UserManager.switch_user-123"><a href="#UserManager.switch_user-123"><span class="linenos">123</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager.switch_user-124"><a href="#UserManager.switch_user-124"><span class="linenos">124</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager.switch_user-125"><a href="#UserManager.switch_user-125"><span class="linenos">125</span></a>            <span class="c1"># Validate input</span>
</span><span id="UserManager.switch_user-126"><a href="#UserManager.switch_user-126"><span class="linenos">126</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserManager.switch_user-127"><a href="#UserManager.switch_user-127"><span class="linenos">127</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User ID is required&quot;</span><span class="p">}</span>
</span><span id="UserManager.switch_user-128"><a href="#UserManager.switch_user-128"><span class="linenos">128</span></a>            
</span><span id="UserManager.switch_user-129"><a href="#UserManager.switch_user-129"><span class="linenos">129</span></a>            <span class="c1"># Check if user exists in registry</span>
</span><span id="UserManager.switch_user-130"><a href="#UserManager.switch_user-130"><span class="linenos">130</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
</span><span id="UserManager.switch_user-131"><a href="#UserManager.switch_user-131"><span class="linenos">131</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; does not exist&quot;</span><span class="p">}</span>
</span><span id="UserManager.switch_user-132"><a href="#UserManager.switch_user-132"><span class="linenos">132</span></a>            
</span><span id="UserManager.switch_user-133"><a href="#UserManager.switch_user-133"><span class="linenos">133</span></a>            <span class="c1"># Get current user using dynamic function</span>
</span><span id="UserManager.switch_user-134"><a href="#UserManager.switch_user-134"><span class="linenos">134</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_user_id</span>
</span><span id="UserManager.switch_user-135"><a href="#UserManager.switch_user-135"><span class="linenos">135</span></a>            <span class="n">current_user</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="UserManager.switch_user-136"><a href="#UserManager.switch_user-136"><span class="linenos">136</span></a>            
</span><span id="UserManager.switch_user-137"><a href="#UserManager.switch_user-137"><span class="linenos">137</span></a>            <span class="c1"># Don&#39;t switch if already the current user</span>
</span><span id="UserManager.switch_user-138"><a href="#UserManager.switch_user-138"><span class="linenos">138</span></a>            <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="p">:</span>
</span><span id="UserManager.switch_user-139"><a href="#UserManager.switch_user-139"><span class="linenos">139</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Already logged in as &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">}</span>
</span><span id="UserManager.switch_user-140"><a href="#UserManager.switch_user-140"><span class="linenos">140</span></a>            
</span><span id="UserManager.switch_user-141"><a href="#UserManager.switch_user-141"><span class="linenos">141</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="UserManager.switch_user-142"><a href="#UserManager.switch_user-142"><span class="linenos">142</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="UserManager.switch_user-143"><a href="#UserManager.switch_user-143"><span class="linenos">143</span></a>                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
</span><span id="UserManager.switch_user-144"><a href="#UserManager.switch_user-144"><span class="linenos">144</span></a>                <span class="s2">&quot;previous_user&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">,</span>
</span><span id="UserManager.switch_user-145"><a href="#UserManager.switch_user-145"><span class="linenos">145</span></a>                <span class="s2">&quot;actions_performed&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="UserManager.switch_user-146"><a href="#UserManager.switch_user-146"><span class="linenos">146</span></a>                <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="UserManager.switch_user-147"><a href="#UserManager.switch_user-147"><span class="linenos">147</span></a>                <span class="s2">&quot;lightrag_status&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="UserManager.switch_user-148"><a href="#UserManager.switch_user-148"><span class="linenos">148</span></a>                <span class="s2">&quot;config_refresh&quot;</span><span class="p">:</span> <span class="p">{}</span>
</span><span id="UserManager.switch_user-149"><a href="#UserManager.switch_user-149"><span class="linenos">149</span></a>            <span class="p">}</span>
</span><span id="UserManager.switch_user-150"><a href="#UserManager.switch_user-150"><span class="linenos">150</span></a>            
</span><span id="UserManager.switch_user-151"><a href="#UserManager.switch_user-151"><span class="linenos">151</span></a>            <span class="c1"># Update global environment variable and persistent user file</span>
</span><span id="UserManager.switch_user-152"><a href="#UserManager.switch_user-152"><span class="linenos">152</span></a>            <span class="k">if</span> <span class="n">update_global_config</span><span class="p">:</span>
</span><span id="UserManager.switch_user-153"><a href="#UserManager.switch_user-153"><span class="linenos">153</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;USER_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_id</span>
</span><span id="UserManager.switch_user-154"><a href="#UserManager.switch_user-154"><span class="linenos">154</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Updated global USER_ID environment variable&quot;</span><span class="p">)</span>
</span><span id="UserManager.switch_user-155"><a href="#UserManager.switch_user-155"><span class="linenos">155</span></a>
</span><span id="UserManager.switch_user-156"><a href="#UserManager.switch_user-156"><span class="linenos">156</span></a>                <span class="c1"># Write to ~/.persag/env.userid to persist the change</span>
</span><span id="UserManager.switch_user-157"><a href="#UserManager.switch_user-157"><span class="linenos">157</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager.switch_user-158"><a href="#UserManager.switch_user-158"><span class="linenos">158</span></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">..core.persag_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_persag_manager</span>
</span><span id="UserManager.switch_user-159"><a href="#UserManager.switch_user-159"><span class="linenos">159</span></a>                    <span class="n">persag_manager</span> <span class="o">=</span> <span class="n">get_persag_manager</span><span class="p">()</span>
</span><span id="UserManager.switch_user-160"><a href="#UserManager.switch_user-160"><span class="linenos">160</span></a>                    <span class="n">success</span> <span class="o">=</span> <span class="n">persag_manager</span><span class="o">.</span><span class="n">set_userid</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="UserManager.switch_user-161"><a href="#UserManager.switch_user-161"><span class="linenos">161</span></a>                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="UserManager.switch_user-162"><a href="#UserManager.switch_user-162"><span class="linenos">162</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Persisted current user to ~/.persag/env.userid&quot;</span><span class="p">)</span>
</span><span id="UserManager.switch_user-163"><a href="#UserManager.switch_user-163"><span class="linenos">163</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager.switch_user-164"><a href="#UserManager.switch_user-164"><span class="linenos">164</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Could not write to ~/.persag/env.userid&quot;</span><span class="p">)</span>
</span><span id="UserManager.switch_user-165"><a href="#UserManager.switch_user-165"><span class="linenos">165</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager.switch_user-166"><a href="#UserManager.switch_user-166"><span class="linenos">166</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not write to ~/.persag/env.userid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager.switch_user-167"><a href="#UserManager.switch_user-167"><span class="linenos">167</span></a>
</span><span id="UserManager.switch_user-168"><a href="#UserManager.switch_user-168"><span class="linenos">168</span></a>                <span class="c1"># Refresh user-dependent configuration settings</span>
</span><span id="UserManager.switch_user-169"><a href="#UserManager.switch_user-169"><span class="linenos">169</span></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">refresh_user_dependent_settings</span>
</span><span id="UserManager.switch_user-170"><a href="#UserManager.switch_user-170"><span class="linenos">170</span></a>                <span class="n">refreshed_settings</span> <span class="o">=</span> <span class="n">refresh_user_dependent_settings</span><span class="p">()</span>
</span><span id="UserManager.switch_user-171"><a href="#UserManager.switch_user-171"><span class="linenos">171</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;config_refresh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refreshed_settings</span>
</span><span id="UserManager.switch_user-172"><a href="#UserManager.switch_user-172"><span class="linenos">172</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Refreshed user-dependent configuration settings&quot;</span><span class="p">)</span>
</span><span id="UserManager.switch_user-173"><a href="#UserManager.switch_user-173"><span class="linenos">173</span></a>            
</span><span id="UserManager.switch_user-174"><a href="#UserManager.switch_user-174"><span class="linenos">174</span></a>            <span class="c1"># Restart LightRAG services with new user ID</span>
</span><span id="UserManager.switch_user-175"><a href="#UserManager.switch_user-175"><span class="linenos">175</span></a>            <span class="k">if</span> <span class="n">restart_lightrag</span><span class="p">:</span>
</span><span id="UserManager.switch_user-176"><a href="#UserManager.switch_user-176"><span class="linenos">176</span></a>                <span class="n">lightrag_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_manager</span><span class="o">.</span><span class="n">restart_lightrag_services</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="UserManager.switch_user-177"><a href="#UserManager.switch_user-177"><span class="linenos">177</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;lightrag_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lightrag_result</span>
</span><span id="UserManager.switch_user-178"><a href="#UserManager.switch_user-178"><span class="linenos">178</span></a>                
</span><span id="UserManager.switch_user-179"><a href="#UserManager.switch_user-179"><span class="linenos">179</span></a>                <span class="k">if</span> <span class="n">lightrag_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
</span><span id="UserManager.switch_user-180"><a href="#UserManager.switch_user-180"><span class="linenos">180</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Restarted LightRAG services&quot;</span><span class="p">)</span>
</span><span id="UserManager.switch_user-181"><a href="#UserManager.switch_user-181"><span class="linenos">181</span></a>                    <span class="k">if</span> <span class="n">lightrag_result</span><span class="p">[</span><span class="s2">&quot;services_restarted&quot;</span><span class="p">]:</span>
</span><span id="UserManager.switch_user-182"><a href="#UserManager.switch_user-182"><span class="linenos">182</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Services restarted: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lightrag_result</span><span class="p">[</span><span class="s1">&#39;services_restarted&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager.switch_user-183"><a href="#UserManager.switch_user-183"><span class="linenos">183</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager.switch_user-184"><a href="#UserManager.switch_user-184"><span class="linenos">184</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;LightRAG restart had issues&quot;</span><span class="p">)</span>
</span><span id="UserManager.switch_user-185"><a href="#UserManager.switch_user-185"><span class="linenos">185</span></a>                    <span class="k">if</span> <span class="n">lightrag_result</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]:</span>
</span><span id="UserManager.switch_user-186"><a href="#UserManager.switch_user-186"><span class="linenos">186</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lightrag_result</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">])</span>
</span><span id="UserManager.switch_user-187"><a href="#UserManager.switch_user-187"><span class="linenos">187</span></a>            
</span><span id="UserManager.switch_user-188"><a href="#UserManager.switch_user-188"><span class="linenos">188</span></a>            <span class="c1"># Update user&#39;s last_seen timestamp</span>
</span><span id="UserManager.switch_user-189"><a href="#UserManager.switch_user-189"><span class="linenos">189</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">update_last_seen</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="UserManager.switch_user-190"><a href="#UserManager.switch_user-190"><span class="linenos">190</span></a>            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Updated user last_seen timestamp&quot;</span><span class="p">)</span>
</span><span id="UserManager.switch_user-191"><a href="#UserManager.switch_user-191"><span class="linenos">191</span></a>            
</span><span id="UserManager.switch_user-192"><a href="#UserManager.switch_user-192"><span class="linenos">192</span></a>            <span class="k">return</span> <span class="n">results</span>
</span><span id="UserManager.switch_user-193"><a href="#UserManager.switch_user-193"><span class="linenos">193</span></a>        
</span><span id="UserManager.switch_user-194"><a href="#UserManager.switch_user-194"><span class="linenos">194</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager.switch_user-195"><a href="#UserManager.switch_user-195"><span class="linenos">195</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager.switch_user-196"><a href="#UserManager.switch_user-196"><span class="linenos">196</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager.switch_user-197"><a href="#UserManager.switch_user-197"><span class="linenos">197</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error switching user: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager.switch_user-198"><a href="#UserManager.switch_user-198"><span class="linenos">198</span></a>            <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Switch to a different user with complete system integration.</p>

<p>Args:
    user_id: User ID to switch to
    restart_lightrag: Whether to restart LightRAG services
    update_global_config: Whether to update global USER_ID configuration</p>

<p>Returns:
    Dictionary containing result information</p>
</div>


                            </div>
                            <div id="UserManager.delete_user" class="classattr">
                                        <input id="UserManager.delete_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_user</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">delete_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">backup_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="UserManager.delete_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserManager.delete_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserManager.delete_user-200"><a href="#UserManager.delete_user-200"><span class="linenos">200</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">delete_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">backup_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager.delete_user-201"><a href="#UserManager.delete_user-201"><span class="linenos">201</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager.delete_user-202"><a href="#UserManager.delete_user-202"><span class="linenos">202</span></a><span class="sd">        Delete a user from the system with comprehensive data cleanup.</span>
</span><span id="UserManager.delete_user-203"><a href="#UserManager.delete_user-203"><span class="linenos">203</span></a><span class="sd">        </span>
</span><span id="UserManager.delete_user-204"><a href="#UserManager.delete_user-204"><span class="linenos">204</span></a><span class="sd">        Args:</span>
</span><span id="UserManager.delete_user-205"><a href="#UserManager.delete_user-205"><span class="linenos">205</span></a><span class="sd">            user_id: User ID to delete</span>
</span><span id="UserManager.delete_user-206"><a href="#UserManager.delete_user-206"><span class="linenos">206</span></a><span class="sd">            delete_data: Whether to delete persistent data directory (default: True)</span>
</span><span id="UserManager.delete_user-207"><a href="#UserManager.delete_user-207"><span class="linenos">207</span></a><span class="sd">            backup_data: Whether to backup data before deletion (default: False)</span>
</span><span id="UserManager.delete_user-208"><a href="#UserManager.delete_user-208"><span class="linenos">208</span></a><span class="sd">            dry_run: Preview mode - show what would be deleted without deleting (default: False)</span>
</span><span id="UserManager.delete_user-209"><a href="#UserManager.delete_user-209"><span class="linenos">209</span></a><span class="sd">            </span>
</span><span id="UserManager.delete_user-210"><a href="#UserManager.delete_user-210"><span class="linenos">210</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager.delete_user-211"><a href="#UserManager.delete_user-211"><span class="linenos">211</span></a><span class="sd">            Dictionary containing detailed result information</span>
</span><span id="UserManager.delete_user-212"><a href="#UserManager.delete_user-212"><span class="linenos">212</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager.delete_user-213"><a href="#UserManager.delete_user-213"><span class="linenos">213</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager.delete_user-214"><a href="#UserManager.delete_user-214"><span class="linenos">214</span></a>            <span class="c1"># Validate input</span>
</span><span id="UserManager.delete_user-215"><a href="#UserManager.delete_user-215"><span class="linenos">215</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserManager.delete_user-216"><a href="#UserManager.delete_user-216"><span class="linenos">216</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User ID is required&quot;</span><span class="p">}</span>
</span><span id="UserManager.delete_user-217"><a href="#UserManager.delete_user-217"><span class="linenos">217</span></a>            
</span><span id="UserManager.delete_user-218"><a href="#UserManager.delete_user-218"><span class="linenos">218</span></a>            <span class="c1"># Check if user exists</span>
</span><span id="UserManager.delete_user-219"><a href="#UserManager.delete_user-219"><span class="linenos">219</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
</span><span id="UserManager.delete_user-220"><a href="#UserManager.delete_user-220"><span class="linenos">220</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; does not exist&quot;</span><span class="p">}</span>
</span><span id="UserManager.delete_user-221"><a href="#UserManager.delete_user-221"><span class="linenos">221</span></a>            
</span><span id="UserManager.delete_user-222"><a href="#UserManager.delete_user-222"><span class="linenos">222</span></a>            <span class="c1"># Get current user</span>
</span><span id="UserManager.delete_user-223"><a href="#UserManager.delete_user-223"><span class="linenos">223</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_user_id</span>
</span><span id="UserManager.delete_user-224"><a href="#UserManager.delete_user-224"><span class="linenos">224</span></a>            <span class="n">current_user</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="UserManager.delete_user-225"><a href="#UserManager.delete_user-225"><span class="linenos">225</span></a>            
</span><span id="UserManager.delete_user-226"><a href="#UserManager.delete_user-226"><span class="linenos">226</span></a>            <span class="c1"># Don&#39;t delete the current user</span>
</span><span id="UserManager.delete_user-227"><a href="#UserManager.delete_user-227"><span class="linenos">227</span></a>            <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="p">:</span>
</span><span id="UserManager.delete_user-228"><a href="#UserManager.delete_user-228"><span class="linenos">228</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Cannot delete the current user&quot;</span><span class="p">}</span>
</span><span id="UserManager.delete_user-229"><a href="#UserManager.delete_user-229"><span class="linenos">229</span></a>            
</span><span id="UserManager.delete_user-230"><a href="#UserManager.delete_user-230"><span class="linenos">230</span></a>            <span class="c1"># Initialize result structure</span>
</span><span id="UserManager.delete_user-231"><a href="#UserManager.delete_user-231"><span class="linenos">231</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="UserManager.delete_user-232"><a href="#UserManager.delete_user-232"><span class="linenos">232</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="UserManager.delete_user-233"><a href="#UserManager.delete_user-233"><span class="linenos">233</span></a>                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
</span><span id="UserManager.delete_user-234"><a href="#UserManager.delete_user-234"><span class="linenos">234</span></a>                <span class="s2">&quot;dry_run&quot;</span><span class="p">:</span> <span class="n">dry_run</span><span class="p">,</span>
</span><span id="UserManager.delete_user-235"><a href="#UserManager.delete_user-235"><span class="linenos">235</span></a>                <span class="s2">&quot;actions_performed&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="UserManager.delete_user-236"><a href="#UserManager.delete_user-236"><span class="linenos">236</span></a>                <span class="s2">&quot;data_deleted&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="UserManager.delete_user-237"><a href="#UserManager.delete_user-237"><span class="linenos">237</span></a>                    <span class="s2">&quot;registry&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager.delete_user-238"><a href="#UserManager.delete_user-238"><span class="linenos">238</span></a>                    <span class="s2">&quot;data_directory&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager.delete_user-239"><a href="#UserManager.delete_user-239"><span class="linenos">239</span></a>                    <span class="s2">&quot;directories_removed&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="UserManager.delete_user-240"><a href="#UserManager.delete_user-240"><span class="linenos">240</span></a>                    <span class="s2">&quot;files_removed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="UserManager.delete_user-241"><a href="#UserManager.delete_user-241"><span class="linenos">241</span></a>                    <span class="s2">&quot;total_size_mb&quot;</span><span class="p">:</span> <span class="mf">0.0</span>
</span><span id="UserManager.delete_user-242"><a href="#UserManager.delete_user-242"><span class="linenos">242</span></a>                <span class="p">},</span>
</span><span id="UserManager.delete_user-243"><a href="#UserManager.delete_user-243"><span class="linenos">243</span></a>                <span class="s2">&quot;backup_info&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="UserManager.delete_user-244"><a href="#UserManager.delete_user-244"><span class="linenos">244</span></a>                <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="UserManager.delete_user-245"><a href="#UserManager.delete_user-245"><span class="linenos">245</span></a>                <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="UserManager.delete_user-246"><a href="#UserManager.delete_user-246"><span class="linenos">246</span></a>            <span class="p">}</span>
</span><span id="UserManager.delete_user-247"><a href="#UserManager.delete_user-247"><span class="linenos">247</span></a>            
</span><span id="UserManager.delete_user-248"><a href="#UserManager.delete_user-248"><span class="linenos">248</span></a>            <span class="c1"># Get user data directory path</span>
</span><span id="UserManager.delete_user-249"><a href="#UserManager.delete_user-249"><span class="linenos">249</span></a>            <span class="n">user_data_dir</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="UserManager.delete_user-250"><a href="#UserManager.delete_user-250"><span class="linenos">250</span></a>            <span class="k">if</span> <span class="n">delete_data</span><span class="p">:</span>
</span><span id="UserManager.delete_user-251"><a href="#UserManager.delete_user-251"><span class="linenos">251</span></a>                <span class="n">user_data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_backend</span> <span class="o">/</span> <span class="n">user_id</span>
</span><span id="UserManager.delete_user-252"><a href="#UserManager.delete_user-252"><span class="linenos">252</span></a>                
</span><span id="UserManager.delete_user-253"><a href="#UserManager.delete_user-253"><span class="linenos">253</span></a>                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
</span><span id="UserManager.delete_user-254"><a href="#UserManager.delete_user-254"><span class="linenos">254</span></a>                    <span class="c1"># In dry-run mode, analyze what would be deleted</span>
</span><span id="UserManager.delete_user-255"><a href="#UserManager.delete_user-255"><span class="linenos">255</span></a>                    <span class="k">if</span> <span class="n">user_data_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="UserManager.delete_user-256"><a href="#UserManager.delete_user-256"><span class="linenos">256</span></a>                        <span class="n">size_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_directory_size</span><span class="p">(</span><span class="n">user_data_dir</span><span class="p">)</span>
</span><span id="UserManager.delete_user-257"><a href="#UserManager.delete_user-257"><span class="linenos">257</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;directories_removed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">user_data_dir</span><span class="p">)]</span>
</span><span id="UserManager.delete_user-258"><a href="#UserManager.delete_user-258"><span class="linenos">258</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;files_removed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;file_count&quot;</span><span class="p">]</span>
</span><span id="UserManager.delete_user-259"><a href="#UserManager.delete_user-259"><span class="linenos">259</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;total_size_mb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;size_mb&quot;</span><span class="p">]</span>
</span><span id="UserManager.delete_user-260"><a href="#UserManager.delete_user-260"><span class="linenos">260</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DRY RUN] Would delete user data directory: </span><span class="si">{</span><span class="n">user_data_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-261"><a href="#UserManager.delete_user-261"><span class="linenos">261</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DRY RUN] Would remove </span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;file_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> files (</span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;size_mb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-262"><a href="#UserManager.delete_user-262"><span class="linenos">262</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager.delete_user-263"><a href="#UserManager.delete_user-263"><span class="linenos">263</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DRY RUN] User data directory does not exist: </span><span class="si">{</span><span class="n">user_data_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-264"><a href="#UserManager.delete_user-264"><span class="linenos">264</span></a>                    
</span><span id="UserManager.delete_user-265"><a href="#UserManager.delete_user-265"><span class="linenos">265</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DRY RUN] Would remove user &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; from registry&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-266"><a href="#UserManager.delete_user-266"><span class="linenos">266</span></a>                    <span class="k">return</span> <span class="n">results</span>
</span><span id="UserManager.delete_user-267"><a href="#UserManager.delete_user-267"><span class="linenos">267</span></a>            
</span><span id="UserManager.delete_user-268"><a href="#UserManager.delete_user-268"><span class="linenos">268</span></a>            <span class="c1"># Backup data if requested</span>
</span><span id="UserManager.delete_user-269"><a href="#UserManager.delete_user-269"><span class="linenos">269</span></a>            <span class="k">if</span> <span class="n">backup_data</span> <span class="ow">and</span> <span class="n">user_data_dir</span> <span class="ow">and</span> <span class="n">user_data_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="UserManager.delete_user-270"><a href="#UserManager.delete_user-270"><span class="linenos">270</span></a>                <span class="n">backup_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_user_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_data_dir</span><span class="p">)</span>
</span><span id="UserManager.delete_user-271"><a href="#UserManager.delete_user-271"><span class="linenos">271</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;backup_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_result</span>
</span><span id="UserManager.delete_user-272"><a href="#UserManager.delete_user-272"><span class="linenos">272</span></a>                <span class="k">if</span> <span class="n">backup_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
</span><span id="UserManager.delete_user-273"><a href="#UserManager.delete_user-273"><span class="linenos">273</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backed up user data to: </span><span class="si">{</span><span class="n">backup_result</span><span class="p">[</span><span class="s1">&#39;backup_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-274"><a href="#UserManager.delete_user-274"><span class="linenos">274</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager.delete_user-275"><a href="#UserManager.delete_user-275"><span class="linenos">275</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backup failed: </span><span class="si">{</span><span class="n">backup_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-276"><a href="#UserManager.delete_user-276"><span class="linenos">276</span></a>            
</span><span id="UserManager.delete_user-277"><a href="#UserManager.delete_user-277"><span class="linenos">277</span></a>            <span class="c1"># Delete user data directory</span>
</span><span id="UserManager.delete_user-278"><a href="#UserManager.delete_user-278"><span class="linenos">278</span></a>            <span class="k">if</span> <span class="n">delete_data</span> <span class="ow">and</span> <span class="n">user_data_dir</span><span class="p">:</span>
</span><span id="UserManager.delete_user-279"><a href="#UserManager.delete_user-279"><span class="linenos">279</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager.delete_user-280"><a href="#UserManager.delete_user-280"><span class="linenos">280</span></a>                    <span class="k">if</span> <span class="n">user_data_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="UserManager.delete_user-281"><a href="#UserManager.delete_user-281"><span class="linenos">281</span></a>                        <span class="c1"># Calculate size before deletion for reporting</span>
</span><span id="UserManager.delete_user-282"><a href="#UserManager.delete_user-282"><span class="linenos">282</span></a>                        <span class="n">size_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_directory_size</span><span class="p">(</span><span class="n">user_data_dir</span><span class="p">)</span>
</span><span id="UserManager.delete_user-283"><a href="#UserManager.delete_user-283"><span class="linenos">283</span></a>                        
</span><span id="UserManager.delete_user-284"><a href="#UserManager.delete_user-284"><span class="linenos">284</span></a>                        <span class="c1"># Remove the directory and all contents</span>
</span><span id="UserManager.delete_user-285"><a href="#UserManager.delete_user-285"><span class="linenos">285</span></a>                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">user_data_dir</span><span class="p">)</span>
</span><span id="UserManager.delete_user-286"><a href="#UserManager.delete_user-286"><span class="linenos">286</span></a>                        
</span><span id="UserManager.delete_user-287"><a href="#UserManager.delete_user-287"><span class="linenos">287</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;data_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="UserManager.delete_user-288"><a href="#UserManager.delete_user-288"><span class="linenos">288</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;directories_removed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">user_data_dir</span><span class="p">)]</span>
</span><span id="UserManager.delete_user-289"><a href="#UserManager.delete_user-289"><span class="linenos">289</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;files_removed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;file_count&quot;</span><span class="p">]</span>
</span><span id="UserManager.delete_user-290"><a href="#UserManager.delete_user-290"><span class="linenos">290</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;total_size_mb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;size_mb&quot;</span><span class="p">]</span>
</span><span id="UserManager.delete_user-291"><a href="#UserManager.delete_user-291"><span class="linenos">291</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted user data directory: </span><span class="si">{</span><span class="n">user_data_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-292"><a href="#UserManager.delete_user-292"><span class="linenos">292</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;file_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> files (</span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;size_mb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-293"><a href="#UserManager.delete_user-293"><span class="linenos">293</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager.delete_user-294"><a href="#UserManager.delete_user-294"><span class="linenos">294</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User data directory does not exist: </span><span class="si">{</span><span class="n">user_data_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-295"><a href="#UserManager.delete_user-295"><span class="linenos">295</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No user data directory to delete&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-296"><a href="#UserManager.delete_user-296"><span class="linenos">296</span></a>                        
</span><span id="UserManager.delete_user-297"><a href="#UserManager.delete_user-297"><span class="linenos">297</span></a>                <span class="k">except</span> <span class="ne">PermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager.delete_user-298"><a href="#UserManager.delete_user-298"><span class="linenos">298</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Permission denied deleting data directory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-299"><a href="#UserManager.delete_user-299"><span class="linenos">299</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="UserManager.delete_user-300"><a href="#UserManager.delete_user-300"><span class="linenos">300</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager.delete_user-301"><a href="#UserManager.delete_user-301"><span class="linenos">301</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting data directory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-302"><a href="#UserManager.delete_user-302"><span class="linenos">302</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="UserManager.delete_user-303"><a href="#UserManager.delete_user-303"><span class="linenos">303</span></a>            
</span><span id="UserManager.delete_user-304"><a href="#UserManager.delete_user-304"><span class="linenos">304</span></a>            <span class="c1"># Remove user from registry (always attempt this, even if data deletion failed)</span>
</span><span id="UserManager.delete_user-305"><a href="#UserManager.delete_user-305"><span class="linenos">305</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager.delete_user-306"><a href="#UserManager.delete_user-306"><span class="linenos">306</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">remove_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
</span><span id="UserManager.delete_user-307"><a href="#UserManager.delete_user-307"><span class="linenos">307</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;data_deleted&quot;</span><span class="p">][</span><span class="s2">&quot;registry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="UserManager.delete_user-308"><a href="#UserManager.delete_user-308"><span class="linenos">308</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;actions_performed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed user &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; from registry&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-309"><a href="#UserManager.delete_user-309"><span class="linenos">309</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager.delete_user-310"><a href="#UserManager.delete_user-310"><span class="linenos">310</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove user &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; from registry&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-311"><a href="#UserManager.delete_user-311"><span class="linenos">311</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="UserManager.delete_user-312"><a href="#UserManager.delete_user-312"><span class="linenos">312</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager.delete_user-313"><a href="#UserManager.delete_user-313"><span class="linenos">313</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error removing user from registry: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="UserManager.delete_user-314"><a href="#UserManager.delete_user-314"><span class="linenos">314</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="UserManager.delete_user-315"><a href="#UserManager.delete_user-315"><span class="linenos">315</span></a>            
</span><span id="UserManager.delete_user-316"><a href="#UserManager.delete_user-316"><span class="linenos">316</span></a>            <span class="c1"># Set final message</span>
</span><span id="UserManager.delete_user-317"><a href="#UserManager.delete_user-317"><span class="linenos">317</span></a>            <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
</span><span id="UserManager.delete_user-318"><a href="#UserManager.delete_user-318"><span class="linenos">318</span></a>                <span class="k">if</span> <span class="n">delete_data</span><span class="p">:</span>
</span><span id="UserManager.delete_user-319"><a href="#UserManager.delete_user-319"><span class="linenos">319</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; and all associated data deleted successfully&quot;</span>
</span><span id="UserManager.delete_user-320"><a href="#UserManager.delete_user-320"><span class="linenos">320</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager.delete_user-321"><a href="#UserManager.delete_user-321"><span class="linenos">321</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; deleted from registry successfully&quot;</span>
</span><span id="UserManager.delete_user-322"><a href="#UserManager.delete_user-322"><span class="linenos">322</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager.delete_user-323"><a href="#UserManager.delete_user-323"><span class="linenos">323</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; deletion completed with errors&quot;</span>
</span><span id="UserManager.delete_user-324"><a href="#UserManager.delete_user-324"><span class="linenos">324</span></a>            
</span><span id="UserManager.delete_user-325"><a href="#UserManager.delete_user-325"><span class="linenos">325</span></a>            <span class="k">return</span> <span class="n">results</span>
</span><span id="UserManager.delete_user-326"><a href="#UserManager.delete_user-326"><span class="linenos">326</span></a>        
</span><span id="UserManager.delete_user-327"><a href="#UserManager.delete_user-327"><span class="linenos">327</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager.delete_user-328"><a href="#UserManager.delete_user-328"><span class="linenos">328</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager.delete_user-329"><a href="#UserManager.delete_user-329"><span class="linenos">329</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager.delete_user-330"><a href="#UserManager.delete_user-330"><span class="linenos">330</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error deleting user: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager.delete_user-331"><a href="#UserManager.delete_user-331"><span class="linenos">331</span></a>            <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Delete a user from the system with comprehensive data cleanup.</p>

<p>Args:
    user_id: User ID to delete
    delete_data: Whether to delete persistent data directory (default: True)
    backup_data: Whether to backup data before deletion (default: False)
    dry_run: Preview mode - show what would be deleted without deleting (default: False)</p>

<p>Returns:
    Dictionary containing detailed result information</p>
</div>


                            </div>
                            <div id="UserManager.restart_lightrag_for_current_user" class="classattr">
                                        <input id="UserManager.restart_lightrag_for_current_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">restart_lightrag_for_current_user</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="UserManager.restart_lightrag_for_current_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserManager.restart_lightrag_for_current_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserManager.restart_lightrag_for_current_user-411"><a href="#UserManager.restart_lightrag_for_current_user-411"><span class="linenos">411</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">restart_lightrag_for_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager.restart_lightrag_for_current_user-412"><a href="#UserManager.restart_lightrag_for_current_user-412"><span class="linenos">412</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager.restart_lightrag_for_current_user-413"><a href="#UserManager.restart_lightrag_for_current_user-413"><span class="linenos">413</span></a><span class="sd">        Restart LightRAG services for the current user.</span>
</span><span id="UserManager.restart_lightrag_for_current_user-414"><a href="#UserManager.restart_lightrag_for_current_user-414"><span class="linenos">414</span></a><span class="sd">        </span>
</span><span id="UserManager.restart_lightrag_for_current_user-415"><a href="#UserManager.restart_lightrag_for_current_user-415"><span class="linenos">415</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager.restart_lightrag_for_current_user-416"><a href="#UserManager.restart_lightrag_for_current_user-416"><span class="linenos">416</span></a><span class="sd">            Dictionary containing result information</span>
</span><span id="UserManager.restart_lightrag_for_current_user-417"><a href="#UserManager.restart_lightrag_for_current_user-417"><span class="linenos">417</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager.restart_lightrag_for_current_user-418"><a href="#UserManager.restart_lightrag_for_current_user-418"><span class="linenos">418</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager.restart_lightrag_for_current_user-419"><a href="#UserManager.restart_lightrag_for_current_user-419"><span class="linenos">419</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_user_id</span>
</span><span id="UserManager.restart_lightrag_for_current_user-420"><a href="#UserManager.restart_lightrag_for_current_user-420"><span class="linenos">420</span></a>            <span class="n">current_user</span> <span class="o">=</span> <span class="n">get_current_user_id</span><span class="p">()</span>
</span><span id="UserManager.restart_lightrag_for_current_user-421"><a href="#UserManager.restart_lightrag_for_current_user-421"><span class="linenos">421</span></a>            
</span><span id="UserManager.restart_lightrag_for_current_user-422"><a href="#UserManager.restart_lightrag_for_current_user-422"><span class="linenos">422</span></a>            <span class="c1"># Ensure current user is registered</span>
</span><span id="UserManager.restart_lightrag_for_current_user-423"><a href="#UserManager.restart_lightrag_for_current_user-423"><span class="linenos">423</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">ensure_current_user_registered</span><span class="p">()</span>
</span><span id="UserManager.restart_lightrag_for_current_user-424"><a href="#UserManager.restart_lightrag_for_current_user-424"><span class="linenos">424</span></a>            
</span><span id="UserManager.restart_lightrag_for_current_user-425"><a href="#UserManager.restart_lightrag_for_current_user-425"><span class="linenos">425</span></a>            <span class="c1"># Restart LightRAG services</span>
</span><span id="UserManager.restart_lightrag_for_current_user-426"><a href="#UserManager.restart_lightrag_for_current_user-426"><span class="linenos">426</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_manager</span><span class="o">.</span><span class="n">restart_lightrag_services</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
</span><span id="UserManager.restart_lightrag_for_current_user-427"><a href="#UserManager.restart_lightrag_for_current_user-427"><span class="linenos">427</span></a>            
</span><span id="UserManager.restart_lightrag_for_current_user-428"><a href="#UserManager.restart_lightrag_for_current_user-428"><span class="linenos">428</span></a>            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
</span><span id="UserManager.restart_lightrag_for_current_user-429"><a href="#UserManager.restart_lightrag_for_current_user-429"><span class="linenos">429</span></a>                <span class="c1"># Update user&#39;s last_seen timestamp</span>
</span><span id="UserManager.restart_lightrag_for_current_user-430"><a href="#UserManager.restart_lightrag_for_current_user-430"><span class="linenos">430</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">update_last_seen</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
</span><span id="UserManager.restart_lightrag_for_current_user-431"><a href="#UserManager.restart_lightrag_for_current_user-431"><span class="linenos">431</span></a>            
</span><span id="UserManager.restart_lightrag_for_current_user-432"><a href="#UserManager.restart_lightrag_for_current_user-432"><span class="linenos">432</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="UserManager.restart_lightrag_for_current_user-433"><a href="#UserManager.restart_lightrag_for_current_user-433"><span class="linenos">433</span></a>        
</span><span id="UserManager.restart_lightrag_for_current_user-434"><a href="#UserManager.restart_lightrag_for_current_user-434"><span class="linenos">434</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager.restart_lightrag_for_current_user-435"><a href="#UserManager.restart_lightrag_for_current_user-435"><span class="linenos">435</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager.restart_lightrag_for_current_user-436"><a href="#UserManager.restart_lightrag_for_current_user-436"><span class="linenos">436</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager.restart_lightrag_for_current_user-437"><a href="#UserManager.restart_lightrag_for_current_user-437"><span class="linenos">437</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error restarting LightRAG: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager.restart_lightrag_for_current_user-438"><a href="#UserManager.restart_lightrag_for_current_user-438"><span class="linenos">438</span></a>            <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Restart LightRAG services for the current user.</p>

<p>Returns:
    Dictionary containing result information</p>
</div>


                            </div>
                            <div id="UserManager.get_lightrag_status" class="classattr">
                                        <input id="UserManager.get_lightrag_status-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_lightrag_status</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="UserManager.get_lightrag_status-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserManager.get_lightrag_status"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserManager.get_lightrag_status-440"><a href="#UserManager.get_lightrag_status-440"><span class="linenos">440</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_lightrag_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager.get_lightrag_status-441"><a href="#UserManager.get_lightrag_status-441"><span class="linenos">441</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager.get_lightrag_status-442"><a href="#UserManager.get_lightrag_status-442"><span class="linenos">442</span></a><span class="sd">        Get current LightRAG service status.</span>
</span><span id="UserManager.get_lightrag_status-443"><a href="#UserManager.get_lightrag_status-443"><span class="linenos">443</span></a><span class="sd">        </span>
</span><span id="UserManager.get_lightrag_status-444"><a href="#UserManager.get_lightrag_status-444"><span class="linenos">444</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager.get_lightrag_status-445"><a href="#UserManager.get_lightrag_status-445"><span class="linenos">445</span></a><span class="sd">            Dictionary with service status information</span>
</span><span id="UserManager.get_lightrag_status-446"><a href="#UserManager.get_lightrag_status-446"><span class="linenos">446</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager.get_lightrag_status-447"><a href="#UserManager.get_lightrag_status-447"><span class="linenos">447</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager.get_lightrag_status-448"><a href="#UserManager.get_lightrag_status-448"><span class="linenos">448</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_manager</span><span class="o">.</span><span class="n">get_service_status</span><span class="p">()</span>
</span><span id="UserManager.get_lightrag_status-449"><a href="#UserManager.get_lightrag_status-449"><span class="linenos">449</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager.get_lightrag_status-450"><a href="#UserManager.get_lightrag_status-450"><span class="linenos">450</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager.get_lightrag_status-451"><a href="#UserManager.get_lightrag_status-451"><span class="linenos">451</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error getting LightRAG status: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager.get_lightrag_status-452"><a href="#UserManager.get_lightrag_status-452"><span class="linenos">452</span></a>            <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Get current LightRAG service status.</p>

<p>Returns:
    Dictionary with service status information</p>
</div>


                            </div>
                            <div id="UserManager.ensure_current_user_registered" class="classattr">
                                        <input id="UserManager.ensure_current_user_registered-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ensure_current_user_registered</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="UserManager.ensure_current_user_registered-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserManager.ensure_current_user_registered"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserManager.ensure_current_user_registered-454"><a href="#UserManager.ensure_current_user_registered-454"><span class="linenos">454</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_current_user_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserManager.ensure_current_user_registered-455"><a href="#UserManager.ensure_current_user_registered-455"><span class="linenos">455</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager.ensure_current_user_registered-456"><a href="#UserManager.ensure_current_user_registered-456"><span class="linenos">456</span></a><span class="sd">        Ensure the current USER_ID is registered in the registry.</span>
</span><span id="UserManager.ensure_current_user_registered-457"><a href="#UserManager.ensure_current_user_registered-457"><span class="linenos">457</span></a><span class="sd">        </span>
</span><span id="UserManager.ensure_current_user_registered-458"><a href="#UserManager.ensure_current_user_registered-458"><span class="linenos">458</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager.ensure_current_user_registered-459"><a href="#UserManager.ensure_current_user_registered-459"><span class="linenos">459</span></a><span class="sd">            True if user was already registered or successfully added</span>
</span><span id="UserManager.ensure_current_user_registered-460"><a href="#UserManager.ensure_current_user_registered-460"><span class="linenos">460</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager.ensure_current_user_registered-461"><a href="#UserManager.ensure_current_user_registered-461"><span class="linenos">461</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">ensure_current_user_registered</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Ensure the current USER_ID is registered in the registry.</p>

<p>Returns:
    True if user was already registered or successfully added</p>
</div>


                            </div>
                            <div id="UserManager.update_user" class="classattr">
                                        <input id="UserManager.update_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_user</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="UserManager.update_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserManager.update_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserManager.update_user-463"><a href="#UserManager.update_user-463"><span class="linenos">463</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager.update_user-464"><a href="#UserManager.update_user-464"><span class="linenos">464</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager.update_user-465"><a href="#UserManager.update_user-465"><span class="linenos">465</span></a><span class="sd">        Update user information.</span>
</span><span id="UserManager.update_user-466"><a href="#UserManager.update_user-466"><span class="linenos">466</span></a><span class="sd">        </span>
</span><span id="UserManager.update_user-467"><a href="#UserManager.update_user-467"><span class="linenos">467</span></a><span class="sd">        Args:</span>
</span><span id="UserManager.update_user-468"><a href="#UserManager.update_user-468"><span class="linenos">468</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserManager.update_user-469"><a href="#UserManager.update_user-469"><span class="linenos">469</span></a><span class="sd">            **kwargs: Fields to update (user_name, user_type, etc.)</span>
</span><span id="UserManager.update_user-470"><a href="#UserManager.update_user-470"><span class="linenos">470</span></a><span class="sd">            </span>
</span><span id="UserManager.update_user-471"><a href="#UserManager.update_user-471"><span class="linenos">471</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager.update_user-472"><a href="#UserManager.update_user-472"><span class="linenos">472</span></a><span class="sd">            Dictionary containing result information</span>
</span><span id="UserManager.update_user-473"><a href="#UserManager.update_user-473"><span class="linenos">473</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager.update_user-474"><a href="#UserManager.update_user-474"><span class="linenos">474</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager.update_user-475"><a href="#UserManager.update_user-475"><span class="linenos">475</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="UserManager.update_user-476"><a href="#UserManager.update_user-476"><span class="linenos">476</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager.update_user-477"><a href="#UserManager.update_user-477"><span class="linenos">477</span></a>                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="UserManager.update_user-478"><a href="#UserManager.update_user-478"><span class="linenos">478</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; updated successfully&quot;</span>
</span><span id="UserManager.update_user-479"><a href="#UserManager.update_user-479"><span class="linenos">479</span></a>                <span class="p">}</span>
</span><span id="UserManager.update_user-480"><a href="#UserManager.update_user-480"><span class="linenos">480</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="UserManager.update_user-481"><a href="#UserManager.update_user-481"><span class="linenos">481</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager.update_user-482"><a href="#UserManager.update_user-482"><span class="linenos">482</span></a>                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager.update_user-483"><a href="#UserManager.update_user-483"><span class="linenos">483</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span>
</span><span id="UserManager.update_user-484"><a href="#UserManager.update_user-484"><span class="linenos">484</span></a>                <span class="p">}</span>
</span><span id="UserManager.update_user-485"><a href="#UserManager.update_user-485"><span class="linenos">485</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="UserManager.update_user-486"><a href="#UserManager.update_user-486"><span class="linenos">486</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="UserManager.update_user-487"><a href="#UserManager.update_user-487"><span class="linenos">487</span></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="UserManager.update_user-488"><a href="#UserManager.update_user-488"><span class="linenos">488</span></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error updating user: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="UserManager.update_user-489"><a href="#UserManager.update_user-489"><span class="linenos">489</span></a>            <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Update user information.</p>

<p>Args:
    user_id: User identifier
    **kwargs: Fields to update (user_name, user_type, etc.)</p>

<p>Returns:
    Dictionary containing result information</p>
</div>


                            </div>
                            <div id="UserManager.get_user_details" class="classattr">
                                        <input id="UserManager.get_user_details-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_user_details</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="UserManager.get_user_details-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserManager.get_user_details"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserManager.get_user_details-491"><a href="#UserManager.get_user_details-491"><span class="linenos">491</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserManager.get_user_details-492"><a href="#UserManager.get_user_details-492"><span class="linenos">492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserManager.get_user_details-493"><a href="#UserManager.get_user_details-493"><span class="linenos">493</span></a><span class="sd">        Get detailed information for a specific user.</span>
</span><span id="UserManager.get_user_details-494"><a href="#UserManager.get_user_details-494"><span class="linenos">494</span></a><span class="sd">        </span>
</span><span id="UserManager.get_user_details-495"><a href="#UserManager.get_user_details-495"><span class="linenos">495</span></a><span class="sd">        Args:</span>
</span><span id="UserManager.get_user_details-496"><a href="#UserManager.get_user_details-496"><span class="linenos">496</span></a><span class="sd">            user_id: User ID to get details for</span>
</span><span id="UserManager.get_user_details-497"><a href="#UserManager.get_user_details-497"><span class="linenos">497</span></a><span class="sd">            </span>
</span><span id="UserManager.get_user_details-498"><a href="#UserManager.get_user_details-498"><span class="linenos">498</span></a><span class="sd">        Returns:</span>
</span><span id="UserManager.get_user_details-499"><a href="#UserManager.get_user_details-499"><span class="linenos">499</span></a><span class="sd">            Dictionary containing user details</span>
</span><span id="UserManager.get_user_details-500"><a href="#UserManager.get_user_details-500"><span class="linenos">500</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserManager.get_user_details-501"><a href="#UserManager.get_user_details-501"><span class="linenos">501</span></a>        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="UserManager.get_user_details-502"><a href="#UserManager.get_user_details-502"><span class="linenos">502</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="UserManager.get_user_details-503"><a href="#UserManager.get_user_details-503"><span class="linenos">503</span></a>            <span class="k">return</span> <span class="p">{}</span>
</span><span id="UserManager.get_user_details-504"><a href="#UserManager.get_user_details-504"><span class="linenos">504</span></a>        
</span><span id="UserManager.get_user_details-505"><a href="#UserManager.get_user_details-505"><span class="linenos">505</span></a>        <span class="c1"># Add additional details</span>
</span><span id="UserManager.get_user_details-506"><a href="#UserManager.get_user_details-506"><span class="linenos">506</span></a>        <span class="n">user_details</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="UserManager.get_user_details-507"><a href="#UserManager.get_user_details-507"><span class="linenos">507</span></a>        
</span><span id="UserManager.get_user_details-508"><a href="#UserManager.get_user_details-508"><span class="linenos">508</span></a>        <span class="c1"># Add current user status</span>
</span><span id="UserManager.get_user_details-509"><a href="#UserManager.get_user_details-509"><span class="linenos">509</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_user_id</span>
</span><span id="UserManager.get_user_details-510"><a href="#UserManager.get_user_details-510"><span class="linenos">510</span></a>        <span class="n">user_details</span><span class="p">[</span><span class="s2">&quot;is_current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">get_current_user_id</span><span class="p">())</span>
</span><span id="UserManager.get_user_details-511"><a href="#UserManager.get_user_details-511"><span class="linenos">511</span></a>        
</span><span id="UserManager.get_user_details-512"><a href="#UserManager.get_user_details-512"><span class="linenos">512</span></a>        <span class="c1"># Add LightRAG status if this is the current user</span>
</span><span id="UserManager.get_user_details-513"><a href="#UserManager.get_user_details-513"><span class="linenos">513</span></a>        <span class="k">if</span> <span class="n">user_details</span><span class="p">[</span><span class="s2">&quot;is_current&quot;</span><span class="p">]:</span>
</span><span id="UserManager.get_user_details-514"><a href="#UserManager.get_user_details-514"><span class="linenos">514</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="UserManager.get_user_details-515"><a href="#UserManager.get_user_details-515"><span class="linenos">515</span></a>                <span class="n">lightrag_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lightrag_status</span><span class="p">()</span>
</span><span id="UserManager.get_user_details-516"><a href="#UserManager.get_user_details-516"><span class="linenos">516</span></a>                <span class="n">user_details</span><span class="p">[</span><span class="s2">&quot;lightrag_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lightrag_status</span>
</span><span id="UserManager.get_user_details-517"><a href="#UserManager.get_user_details-517"><span class="linenos">517</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="UserManager.get_user_details-518"><a href="#UserManager.get_user_details-518"><span class="linenos">518</span></a>                <span class="n">user_details</span><span class="p">[</span><span class="s2">&quot;lightrag_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Could not get LightRAG status&quot;</span><span class="p">}</span>
</span><span id="UserManager.get_user_details-519"><a href="#UserManager.get_user_details-519"><span class="linenos">519</span></a>        
</span><span id="UserManager.get_user_details-520"><a href="#UserManager.get_user_details-520"><span class="linenos">520</span></a>        <span class="k">return</span> <span class="n">user_details</span>
</span></pre></div>


            <div class="docstring"><p>Get detailed information for a specific user.</p>

<p>Args:
    user_id: User ID to get details for</p>

<p>Returns:
    Dictionary containing user details</p>
</div>


                            </div>
                </section>
                <section id="UserRegistry">
                            <input id="UserRegistry-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">UserRegistry</span>:

                <label class="view-source-button" for="UserRegistry-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserRegistry"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserRegistry-18"><a href="#UserRegistry-18"><span class="linenos"> 18</span></a><span class="k">class</span><span class="w"> </span><span class="nc">UserRegistry</span><span class="p">:</span>
</span><span id="UserRegistry-19"><a href="#UserRegistry-19"><span class="linenos"> 19</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple user registry for tracking Personal Agent users.&quot;&quot;&quot;</span>
</span><span id="UserRegistry-20"><a href="#UserRegistry-20"><span class="linenos"> 20</span></a>
</span><span id="UserRegistry-21"><a href="#UserRegistry-21"><span class="linenos"> 21</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">storage_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="UserRegistry-22"><a href="#UserRegistry-22"><span class="linenos"> 22</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry-23"><a href="#UserRegistry-23"><span class="linenos"> 23</span></a><span class="sd">        Initialize the user registry.</span>
</span><span id="UserRegistry-24"><a href="#UserRegistry-24"><span class="linenos"> 24</span></a>
</span><span id="UserRegistry-25"><a href="#UserRegistry-25"><span class="linenos"> 25</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry-26"><a href="#UserRegistry-26"><span class="linenos"> 26</span></a><span class="sd">            data_dir: Data directory path (defaults to config DATA_DIR)</span>
</span><span id="UserRegistry-27"><a href="#UserRegistry-27"><span class="linenos"> 27</span></a><span class="sd">            storage_backend: Storage backend (defaults to config STORAGE_BACKEND)</span>
</span><span id="UserRegistry-28"><a href="#UserRegistry-28"><span class="linenos"> 28</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry-29"><a href="#UserRegistry-29"><span class="linenos"> 29</span></a>        <span class="k">if</span> <span class="n">data_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">storage_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="UserRegistry-30"><a href="#UserRegistry-30"><span class="linenos"> 30</span></a>            <span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="ow">or</span> <span class="n">PERSAG_HOME</span>
</span><span id="UserRegistry-31"><a href="#UserRegistry-31"><span class="linenos"> 31</span></a>            <span class="n">storage_backend</span> <span class="o">=</span> <span class="n">storage_backend</span> <span class="ow">or</span> <span class="n">STORAGE_BACKEND</span>
</span><span id="UserRegistry-32"><a href="#UserRegistry-32"><span class="linenos"> 32</span></a>
</span><span id="UserRegistry-33"><a href="#UserRegistry-33"><span class="linenos"> 33</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">registry_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;users_registry.json&quot;</span>
</span><span id="UserRegistry-34"><a href="#UserRegistry-34"><span class="linenos"> 34</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">registry_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="UserRegistry-35"><a href="#UserRegistry-35"><span class="linenos"> 35</span></a>
</span><span id="UserRegistry-36"><a href="#UserRegistry-36"><span class="linenos"> 36</span></a>        <span class="c1"># Initialize registry file if it doesn&#39;t exist</span>
</span><span id="UserRegistry-37"><a href="#UserRegistry-37"><span class="linenos"> 37</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="UserRegistry-38"><a href="#UserRegistry-38"><span class="linenos"> 38</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_create_empty_registry</span><span class="p">()</span>
</span><span id="UserRegistry-39"><a href="#UserRegistry-39"><span class="linenos"> 39</span></a>
</span><span id="UserRegistry-40"><a href="#UserRegistry-40"><span class="linenos"> 40</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_empty_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="UserRegistry-41"><a href="#UserRegistry-41"><span class="linenos"> 41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an empty registry file.&quot;&quot;&quot;</span>
</span><span id="UserRegistry-42"><a href="#UserRegistry-42"><span class="linenos"> 42</span></a>        <span class="n">empty_registry</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="UserRegistry-43"><a href="#UserRegistry-43"><span class="linenos"> 43</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="UserRegistry-44"><a href="#UserRegistry-44"><span class="linenos"> 44</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">empty_registry</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="UserRegistry-45"><a href="#UserRegistry-45"><span class="linenos"> 45</span></a>
</span><span id="UserRegistry-46"><a href="#UserRegistry-46"><span class="linenos"> 46</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="UserRegistry-47"><a href="#UserRegistry-47"><span class="linenos"> 47</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the registry from file.&quot;&quot;&quot;</span>
</span><span id="UserRegistry-48"><a href="#UserRegistry-48"><span class="linenos"> 48</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="UserRegistry-49"><a href="#UserRegistry-49"><span class="linenos"> 49</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="UserRegistry-50"><a href="#UserRegistry-50"><span class="linenos"> 50</span></a>                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="UserRegistry-51"><a href="#UserRegistry-51"><span class="linenos"> 51</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">):</span>
</span><span id="UserRegistry-52"><a href="#UserRegistry-52"><span class="linenos"> 52</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_create_empty_registry</span><span class="p">()</span>
</span><span id="UserRegistry-53"><a href="#UserRegistry-53"><span class="linenos"> 53</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="UserRegistry-54"><a href="#UserRegistry-54"><span class="linenos"> 54</span></a>
</span><span id="UserRegistry-55"><a href="#UserRegistry-55"><span class="linenos"> 55</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_save_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
</span><span id="UserRegistry-56"><a href="#UserRegistry-56"><span class="linenos"> 56</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the registry to file.&quot;&quot;&quot;</span>
</span><span id="UserRegistry-57"><a href="#UserRegistry-57"><span class="linenos"> 57</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="UserRegistry-58"><a href="#UserRegistry-58"><span class="linenos"> 58</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="UserRegistry-59"><a href="#UserRegistry-59"><span class="linenos"> 59</span></a>
</span><span id="UserRegistry-60"><a href="#UserRegistry-60"><span class="linenos"> 60</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span>
</span><span id="UserRegistry-61"><a href="#UserRegistry-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">user_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Standard&quot;</span>
</span><span id="UserRegistry-62"><a href="#UserRegistry-62"><span class="linenos"> 62</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserRegistry-63"><a href="#UserRegistry-63"><span class="linenos"> 63</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry-64"><a href="#UserRegistry-64"><span class="linenos"> 64</span></a><span class="sd">        Add a new user to the registry.</span>
</span><span id="UserRegistry-65"><a href="#UserRegistry-65"><span class="linenos"> 65</span></a>
</span><span id="UserRegistry-66"><a href="#UserRegistry-66"><span class="linenos"> 66</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry-67"><a href="#UserRegistry-67"><span class="linenos"> 67</span></a><span class="sd">            user_id: Unique user identifier</span>
</span><span id="UserRegistry-68"><a href="#UserRegistry-68"><span class="linenos"> 68</span></a><span class="sd">            user_name: Display name for the user (defaults to user_id)</span>
</span><span id="UserRegistry-69"><a href="#UserRegistry-69"><span class="linenos"> 69</span></a><span class="sd">            user_type: User type (Standard, Admin, Guest)</span>
</span><span id="UserRegistry-70"><a href="#UserRegistry-70"><span class="linenos"> 70</span></a>
</span><span id="UserRegistry-71"><a href="#UserRegistry-71"><span class="linenos"> 71</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry-72"><a href="#UserRegistry-72"><span class="linenos"> 72</span></a><span class="sd">            True if user was added, False if user already exists</span>
</span><span id="UserRegistry-73"><a href="#UserRegistry-73"><span class="linenos"> 73</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry-74"><a href="#UserRegistry-74"><span class="linenos"> 74</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserRegistry-75"><a href="#UserRegistry-75"><span class="linenos"> 75</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;user_id cannot be empty&quot;</span><span class="p">)</span>
</span><span id="UserRegistry-76"><a href="#UserRegistry-76"><span class="linenos"> 76</span></a>
</span><span id="UserRegistry-77"><a href="#UserRegistry-77"><span class="linenos"> 77</span></a>        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_registry</span><span class="p">()</span>
</span><span id="UserRegistry-78"><a href="#UserRegistry-78"><span class="linenos"> 78</span></a>
</span><span id="UserRegistry-79"><a href="#UserRegistry-79"><span class="linenos"> 79</span></a>        <span class="c1"># Check if user already exists</span>
</span><span id="UserRegistry-80"><a href="#UserRegistry-80"><span class="linenos"> 80</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
</span><span id="UserRegistry-81"><a href="#UserRegistry-81"><span class="linenos"> 81</span></a>            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserRegistry-82"><a href="#UserRegistry-82"><span class="linenos"> 82</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="UserRegistry-83"><a href="#UserRegistry-83"><span class="linenos"> 83</span></a>
</span><span id="UserRegistry-84"><a href="#UserRegistry-84"><span class="linenos"> 84</span></a>        <span class="c1"># Add new user</span>
</span><span id="UserRegistry-85"><a href="#UserRegistry-85"><span class="linenos"> 85</span></a>        <span class="n">new_user</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="UserRegistry-86"><a href="#UserRegistry-86"><span class="linenos"> 86</span></a>            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
</span><span id="UserRegistry-87"><a href="#UserRegistry-87"><span class="linenos"> 87</span></a>            <span class="s2">&quot;user_name&quot;</span><span class="p">:</span> <span class="n">user_name</span> <span class="ow">or</span> <span class="n">user_id</span><span class="p">,</span>
</span><span id="UserRegistry-88"><a href="#UserRegistry-88"><span class="linenos"> 88</span></a>            <span class="s2">&quot;user_type&quot;</span><span class="p">:</span> <span class="n">user_type</span><span class="p">,</span>
</span><span id="UserRegistry-89"><a href="#UserRegistry-89"><span class="linenos"> 89</span></a>            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="UserRegistry-90"><a href="#UserRegistry-90"><span class="linenos"> 90</span></a>            <span class="s2">&quot;last_seen&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="UserRegistry-91"><a href="#UserRegistry-91"><span class="linenos"> 91</span></a>        <span class="p">}</span>
</span><span id="UserRegistry-92"><a href="#UserRegistry-92"><span class="linenos"> 92</span></a>
</span><span id="UserRegistry-93"><a href="#UserRegistry-93"><span class="linenos"> 93</span></a>        <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span><span id="UserRegistry-94"><a href="#UserRegistry-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_registry</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
</span><span id="UserRegistry-95"><a href="#UserRegistry-95"><span class="linenos"> 95</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="UserRegistry-96"><a href="#UserRegistry-96"><span class="linenos"> 96</span></a>
</span><span id="UserRegistry-97"><a href="#UserRegistry-97"><span class="linenos"> 97</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_users</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="UserRegistry-98"><a href="#UserRegistry-98"><span class="linenos"> 98</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry-99"><a href="#UserRegistry-99"><span class="linenos"> 99</span></a><span class="sd">        Get all users from the registry.</span>
</span><span id="UserRegistry-100"><a href="#UserRegistry-100"><span class="linenos">100</span></a>
</span><span id="UserRegistry-101"><a href="#UserRegistry-101"><span class="linenos">101</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry-102"><a href="#UserRegistry-102"><span class="linenos">102</span></a><span class="sd">            List of user dictionaries</span>
</span><span id="UserRegistry-103"><a href="#UserRegistry-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry-104"><a href="#UserRegistry-104"><span class="linenos">104</span></a>        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_registry</span><span class="p">()</span>
</span><span id="UserRegistry-105"><a href="#UserRegistry-105"><span class="linenos">105</span></a>        <span class="k">return</span> <span class="n">registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="UserRegistry-106"><a href="#UserRegistry-106"><span class="linenos">106</span></a>
</span><span id="UserRegistry-107"><a href="#UserRegistry-107"><span class="linenos">107</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="UserRegistry-108"><a href="#UserRegistry-108"><span class="linenos">108</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry-109"><a href="#UserRegistry-109"><span class="linenos">109</span></a><span class="sd">        Get a specific user from the registry.</span>
</span><span id="UserRegistry-110"><a href="#UserRegistry-110"><span class="linenos">110</span></a>
</span><span id="UserRegistry-111"><a href="#UserRegistry-111"><span class="linenos">111</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry-112"><a href="#UserRegistry-112"><span class="linenos">112</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserRegistry-113"><a href="#UserRegistry-113"><span class="linenos">113</span></a>
</span><span id="UserRegistry-114"><a href="#UserRegistry-114"><span class="linenos">114</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry-115"><a href="#UserRegistry-115"><span class="linenos">115</span></a><span class="sd">            User dictionary or None if not found</span>
</span><span id="UserRegistry-116"><a href="#UserRegistry-116"><span class="linenos">116</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry-117"><a href="#UserRegistry-117"><span class="linenos">117</span></a>        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_registry</span><span class="p">()</span>
</span><span id="UserRegistry-118"><a href="#UserRegistry-118"><span class="linenos">118</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
</span><span id="UserRegistry-119"><a href="#UserRegistry-119"><span class="linenos">119</span></a>            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserRegistry-120"><a href="#UserRegistry-120"><span class="linenos">120</span></a>                <span class="k">return</span> <span class="n">user</span>
</span><span id="UserRegistry-121"><a href="#UserRegistry-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="UserRegistry-122"><a href="#UserRegistry-122"><span class="linenos">122</span></a>
</span><span id="UserRegistry-123"><a href="#UserRegistry-123"><span class="linenos">123</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserRegistry-124"><a href="#UserRegistry-124"><span class="linenos">124</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry-125"><a href="#UserRegistry-125"><span class="linenos">125</span></a><span class="sd">        Remove a user from the registry.</span>
</span><span id="UserRegistry-126"><a href="#UserRegistry-126"><span class="linenos">126</span></a>
</span><span id="UserRegistry-127"><a href="#UserRegistry-127"><span class="linenos">127</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry-128"><a href="#UserRegistry-128"><span class="linenos">128</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserRegistry-129"><a href="#UserRegistry-129"><span class="linenos">129</span></a>
</span><span id="UserRegistry-130"><a href="#UserRegistry-130"><span class="linenos">130</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry-131"><a href="#UserRegistry-131"><span class="linenos">131</span></a><span class="sd">            True if user was removed, False if user not found</span>
</span><span id="UserRegistry-132"><a href="#UserRegistry-132"><span class="linenos">132</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry-133"><a href="#UserRegistry-133"><span class="linenos">133</span></a>        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_registry</span><span class="p">()</span>
</span><span id="UserRegistry-134"><a href="#UserRegistry-134"><span class="linenos">134</span></a>        <span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">])</span>
</span><span id="UserRegistry-135"><a href="#UserRegistry-135"><span class="linenos">135</span></a>
</span><span id="UserRegistry-136"><a href="#UserRegistry-136"><span class="linenos">136</span></a>        <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="UserRegistry-137"><a href="#UserRegistry-137"><span class="linenos">137</span></a>            <span class="n">user</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">user_id</span>
</span><span id="UserRegistry-138"><a href="#UserRegistry-138"><span class="linenos">138</span></a>        <span class="p">]</span>
</span><span id="UserRegistry-139"><a href="#UserRegistry-139"><span class="linenos">139</span></a>
</span><span id="UserRegistry-140"><a href="#UserRegistry-140"><span class="linenos">140</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">original_count</span><span class="p">:</span>
</span><span id="UserRegistry-141"><a href="#UserRegistry-141"><span class="linenos">141</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_save_registry</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
</span><span id="UserRegistry-142"><a href="#UserRegistry-142"><span class="linenos">142</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="UserRegistry-143"><a href="#UserRegistry-143"><span class="linenos">143</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="UserRegistry-144"><a href="#UserRegistry-144"><span class="linenos">144</span></a>
</span><span id="UserRegistry-145"><a href="#UserRegistry-145"><span class="linenos">145</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_last_seen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserRegistry-146"><a href="#UserRegistry-146"><span class="linenos">146</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry-147"><a href="#UserRegistry-147"><span class="linenos">147</span></a><span class="sd">        Update the last_seen timestamp for a user.</span>
</span><span id="UserRegistry-148"><a href="#UserRegistry-148"><span class="linenos">148</span></a>
</span><span id="UserRegistry-149"><a href="#UserRegistry-149"><span class="linenos">149</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry-150"><a href="#UserRegistry-150"><span class="linenos">150</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserRegistry-151"><a href="#UserRegistry-151"><span class="linenos">151</span></a>
</span><span id="UserRegistry-152"><a href="#UserRegistry-152"><span class="linenos">152</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry-153"><a href="#UserRegistry-153"><span class="linenos">153</span></a><span class="sd">            True if user was updated, False if user not found</span>
</span><span id="UserRegistry-154"><a href="#UserRegistry-154"><span class="linenos">154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry-155"><a href="#UserRegistry-155"><span class="linenos">155</span></a>        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_registry</span><span class="p">()</span>
</span><span id="UserRegistry-156"><a href="#UserRegistry-156"><span class="linenos">156</span></a>
</span><span id="UserRegistry-157"><a href="#UserRegistry-157"><span class="linenos">157</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
</span><span id="UserRegistry-158"><a href="#UserRegistry-158"><span class="linenos">158</span></a>            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserRegistry-159"><a href="#UserRegistry-159"><span class="linenos">159</span></a>                <span class="n">user</span><span class="p">[</span><span class="s2">&quot;last_seen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="UserRegistry-160"><a href="#UserRegistry-160"><span class="linenos">160</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_save_registry</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
</span><span id="UserRegistry-161"><a href="#UserRegistry-161"><span class="linenos">161</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="UserRegistry-162"><a href="#UserRegistry-162"><span class="linenos">162</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="UserRegistry-163"><a href="#UserRegistry-163"><span class="linenos">163</span></a>
</span><span id="UserRegistry-164"><a href="#UserRegistry-164"><span class="linenos">164</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserRegistry-165"><a href="#UserRegistry-165"><span class="linenos">165</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry-166"><a href="#UserRegistry-166"><span class="linenos">166</span></a><span class="sd">        Update user information.</span>
</span><span id="UserRegistry-167"><a href="#UserRegistry-167"><span class="linenos">167</span></a>
</span><span id="UserRegistry-168"><a href="#UserRegistry-168"><span class="linenos">168</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry-169"><a href="#UserRegistry-169"><span class="linenos">169</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserRegistry-170"><a href="#UserRegistry-170"><span class="linenos">170</span></a><span class="sd">            **kwargs: Fields to update (user_name, user_type, etc.)</span>
</span><span id="UserRegistry-171"><a href="#UserRegistry-171"><span class="linenos">171</span></a>
</span><span id="UserRegistry-172"><a href="#UserRegistry-172"><span class="linenos">172</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry-173"><a href="#UserRegistry-173"><span class="linenos">173</span></a><span class="sd">            True if user was updated, False if user not found</span>
</span><span id="UserRegistry-174"><a href="#UserRegistry-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry-175"><a href="#UserRegistry-175"><span class="linenos">175</span></a>        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_registry</span><span class="p">()</span>
</span><span id="UserRegistry-176"><a href="#UserRegistry-176"><span class="linenos">176</span></a>
</span><span id="UserRegistry-177"><a href="#UserRegistry-177"><span class="linenos">177</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
</span><span id="UserRegistry-178"><a href="#UserRegistry-178"><span class="linenos">178</span></a>            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserRegistry-179"><a href="#UserRegistry-179"><span class="linenos">179</span></a>                <span class="c1"># Update allowed fields</span>
</span><span id="UserRegistry-180"><a href="#UserRegistry-180"><span class="linenos">180</span></a>                <span class="n">allowed_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user_name&quot;</span><span class="p">,</span> <span class="s2">&quot;user_type&quot;</span><span class="p">}</span>
</span><span id="UserRegistry-181"><a href="#UserRegistry-181"><span class="linenos">181</span></a>                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="UserRegistry-182"><a href="#UserRegistry-182"><span class="linenos">182</span></a>                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">allowed_fields</span><span class="p">:</span>
</span><span id="UserRegistry-183"><a href="#UserRegistry-183"><span class="linenos">183</span></a>                        <span class="n">user</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="UserRegistry-184"><a href="#UserRegistry-184"><span class="linenos">184</span></a>
</span><span id="UserRegistry-185"><a href="#UserRegistry-185"><span class="linenos">185</span></a>                <span class="n">user</span><span class="p">[</span><span class="s2">&quot;last_seen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="UserRegistry-186"><a href="#UserRegistry-186"><span class="linenos">186</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_save_registry</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
</span><span id="UserRegistry-187"><a href="#UserRegistry-187"><span class="linenos">187</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="UserRegistry-188"><a href="#UserRegistry-188"><span class="linenos">188</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="UserRegistry-189"><a href="#UserRegistry-189"><span class="linenos">189</span></a>
</span><span id="UserRegistry-190"><a href="#UserRegistry-190"><span class="linenos">190</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">user_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserRegistry-191"><a href="#UserRegistry-191"><span class="linenos">191</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry-192"><a href="#UserRegistry-192"><span class="linenos">192</span></a><span class="sd">        Check if a user exists in the registry.</span>
</span><span id="UserRegistry-193"><a href="#UserRegistry-193"><span class="linenos">193</span></a>
</span><span id="UserRegistry-194"><a href="#UserRegistry-194"><span class="linenos">194</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry-195"><a href="#UserRegistry-195"><span class="linenos">195</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserRegistry-196"><a href="#UserRegistry-196"><span class="linenos">196</span></a>
</span><span id="UserRegistry-197"><a href="#UserRegistry-197"><span class="linenos">197</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry-198"><a href="#UserRegistry-198"><span class="linenos">198</span></a><span class="sd">            True if user exists, False otherwise</span>
</span><span id="UserRegistry-199"><a href="#UserRegistry-199"><span class="linenos">199</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry-200"><a href="#UserRegistry-200"><span class="linenos">200</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="UserRegistry-201"><a href="#UserRegistry-201"><span class="linenos">201</span></a>
</span><span id="UserRegistry-202"><a href="#UserRegistry-202"><span class="linenos">202</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="UserRegistry-203"><a href="#UserRegistry-203"><span class="linenos">203</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry-204"><a href="#UserRegistry-204"><span class="linenos">204</span></a><span class="sd">        Get the current user from the single source of truth (user_id_mgr).</span>
</span><span id="UserRegistry-205"><a href="#UserRegistry-205"><span class="linenos">205</span></a>
</span><span id="UserRegistry-206"><a href="#UserRegistry-206"><span class="linenos">206</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry-207"><a href="#UserRegistry-207"><span class="linenos">207</span></a><span class="sd">            Current user dictionary or None if not found</span>
</span><span id="UserRegistry-208"><a href="#UserRegistry-208"><span class="linenos">208</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry-209"><a href="#UserRegistry-209"><span class="linenos">209</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">get_current_user_id</span><span class="p">())</span>
</span><span id="UserRegistry-210"><a href="#UserRegistry-210"><span class="linenos">210</span></a>
</span><span id="UserRegistry-211"><a href="#UserRegistry-211"><span class="linenos">211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_current_user_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserRegistry-212"><a href="#UserRegistry-212"><span class="linenos">212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry-213"><a href="#UserRegistry-213"><span class="linenos">213</span></a><span class="sd">        Ensure the current USER_ID is registered in the registry.</span>
</span><span id="UserRegistry-214"><a href="#UserRegistry-214"><span class="linenos">214</span></a><span class="sd">        Auto-registers if not found.</span>
</span><span id="UserRegistry-215"><a href="#UserRegistry-215"><span class="linenos">215</span></a>
</span><span id="UserRegistry-216"><a href="#UserRegistry-216"><span class="linenos">216</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry-217"><a href="#UserRegistry-217"><span class="linenos">217</span></a><span class="sd">            True if user was already registered or successfully added</span>
</span><span id="UserRegistry-218"><a href="#UserRegistry-218"><span class="linenos">218</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry-219"><a href="#UserRegistry-219"><span class="linenos">219</span></a>        <span class="n">current_user_id</span> <span class="o">=</span> <span class="n">get_userid</span><span class="p">()</span>
</span><span id="UserRegistry-220"><a href="#UserRegistry-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">current_user_id</span><span class="p">):</span>
</span><span id="UserRegistry-221"><a href="#UserRegistry-221"><span class="linenos">221</span></a>            <span class="c1"># Update last_seen for existing user</span>
</span><span id="UserRegistry-222"><a href="#UserRegistry-222"><span class="linenos">222</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_last_seen</span><span class="p">(</span><span class="n">current_user_id</span><span class="p">)</span>
</span><span id="UserRegistry-223"><a href="#UserRegistry-223"><span class="linenos">223</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="UserRegistry-224"><a href="#UserRegistry-224"><span class="linenos">224</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="UserRegistry-225"><a href="#UserRegistry-225"><span class="linenos">225</span></a>            <span class="c1"># Auto-register current user</span>
</span><span id="UserRegistry-226"><a href="#UserRegistry-226"><span class="linenos">226</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">current_user_id</span><span class="p">,</span> <span class="n">current_user_id</span><span class="p">,</span> <span class="s2">&quot;Admin&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Simple user registry for tracking Personal Agent users.</p>
</div>


                            <div id="UserRegistry.__init__" class="classattr">
                                        <input id="UserRegistry.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">UserRegistry</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">storage_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="UserRegistry.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserRegistry.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserRegistry.__init__-21"><a href="#UserRegistry.__init__-21"><span class="linenos">21</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">storage_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="UserRegistry.__init__-22"><a href="#UserRegistry.__init__-22"><span class="linenos">22</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry.__init__-23"><a href="#UserRegistry.__init__-23"><span class="linenos">23</span></a><span class="sd">        Initialize the user registry.</span>
</span><span id="UserRegistry.__init__-24"><a href="#UserRegistry.__init__-24"><span class="linenos">24</span></a>
</span><span id="UserRegistry.__init__-25"><a href="#UserRegistry.__init__-25"><span class="linenos">25</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry.__init__-26"><a href="#UserRegistry.__init__-26"><span class="linenos">26</span></a><span class="sd">            data_dir: Data directory path (defaults to config DATA_DIR)</span>
</span><span id="UserRegistry.__init__-27"><a href="#UserRegistry.__init__-27"><span class="linenos">27</span></a><span class="sd">            storage_backend: Storage backend (defaults to config STORAGE_BACKEND)</span>
</span><span id="UserRegistry.__init__-28"><a href="#UserRegistry.__init__-28"><span class="linenos">28</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry.__init__-29"><a href="#UserRegistry.__init__-29"><span class="linenos">29</span></a>        <span class="k">if</span> <span class="n">data_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">storage_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="UserRegistry.__init__-30"><a href="#UserRegistry.__init__-30"><span class="linenos">30</span></a>            <span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="ow">or</span> <span class="n">PERSAG_HOME</span>
</span><span id="UserRegistry.__init__-31"><a href="#UserRegistry.__init__-31"><span class="linenos">31</span></a>            <span class="n">storage_backend</span> <span class="o">=</span> <span class="n">storage_backend</span> <span class="ow">or</span> <span class="n">STORAGE_BACKEND</span>
</span><span id="UserRegistry.__init__-32"><a href="#UserRegistry.__init__-32"><span class="linenos">32</span></a>
</span><span id="UserRegistry.__init__-33"><a href="#UserRegistry.__init__-33"><span class="linenos">33</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">registry_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;users_registry.json&quot;</span>
</span><span id="UserRegistry.__init__-34"><a href="#UserRegistry.__init__-34"><span class="linenos">34</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">registry_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="UserRegistry.__init__-35"><a href="#UserRegistry.__init__-35"><span class="linenos">35</span></a>
</span><span id="UserRegistry.__init__-36"><a href="#UserRegistry.__init__-36"><span class="linenos">36</span></a>        <span class="c1"># Initialize registry file if it doesn&#39;t exist</span>
</span><span id="UserRegistry.__init__-37"><a href="#UserRegistry.__init__-37"><span class="linenos">37</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="UserRegistry.__init__-38"><a href="#UserRegistry.__init__-38"><span class="linenos">38</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_create_empty_registry</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the user registry.</p>

<p>Args:
    data_dir: Data directory path (defaults to config DATA_DIR)
    storage_backend: Storage backend (defaults to config STORAGE_BACKEND)</p>
</div>


                            </div>
                            <div id="UserRegistry.registry_file" class="classattr">
                                <div class="attr variable">
            <span class="name">registry_file</span>

        
    </div>
    <a class="headerlink" href="#UserRegistry.registry_file"></a>
    
    

                            </div>
                            <div id="UserRegistry.add_user" class="classattr">
                                        <input id="UserRegistry.add_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_user</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">user_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Standard&#39;</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="UserRegistry.add_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserRegistry.add_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserRegistry.add_user-60"><a href="#UserRegistry.add_user-60"><span class="linenos">60</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span>
</span><span id="UserRegistry.add_user-61"><a href="#UserRegistry.add_user-61"><span class="linenos">61</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">user_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Standard&quot;</span>
</span><span id="UserRegistry.add_user-62"><a href="#UserRegistry.add_user-62"><span class="linenos">62</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserRegistry.add_user-63"><a href="#UserRegistry.add_user-63"><span class="linenos">63</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry.add_user-64"><a href="#UserRegistry.add_user-64"><span class="linenos">64</span></a><span class="sd">        Add a new user to the registry.</span>
</span><span id="UserRegistry.add_user-65"><a href="#UserRegistry.add_user-65"><span class="linenos">65</span></a>
</span><span id="UserRegistry.add_user-66"><a href="#UserRegistry.add_user-66"><span class="linenos">66</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry.add_user-67"><a href="#UserRegistry.add_user-67"><span class="linenos">67</span></a><span class="sd">            user_id: Unique user identifier</span>
</span><span id="UserRegistry.add_user-68"><a href="#UserRegistry.add_user-68"><span class="linenos">68</span></a><span class="sd">            user_name: Display name for the user (defaults to user_id)</span>
</span><span id="UserRegistry.add_user-69"><a href="#UserRegistry.add_user-69"><span class="linenos">69</span></a><span class="sd">            user_type: User type (Standard, Admin, Guest)</span>
</span><span id="UserRegistry.add_user-70"><a href="#UserRegistry.add_user-70"><span class="linenos">70</span></a>
</span><span id="UserRegistry.add_user-71"><a href="#UserRegistry.add_user-71"><span class="linenos">71</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry.add_user-72"><a href="#UserRegistry.add_user-72"><span class="linenos">72</span></a><span class="sd">            True if user was added, False if user already exists</span>
</span><span id="UserRegistry.add_user-73"><a href="#UserRegistry.add_user-73"><span class="linenos">73</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry.add_user-74"><a href="#UserRegistry.add_user-74"><span class="linenos">74</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserRegistry.add_user-75"><a href="#UserRegistry.add_user-75"><span class="linenos">75</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;user_id cannot be empty&quot;</span><span class="p">)</span>
</span><span id="UserRegistry.add_user-76"><a href="#UserRegistry.add_user-76"><span class="linenos">76</span></a>
</span><span id="UserRegistry.add_user-77"><a href="#UserRegistry.add_user-77"><span class="linenos">77</span></a>        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_registry</span><span class="p">()</span>
</span><span id="UserRegistry.add_user-78"><a href="#UserRegistry.add_user-78"><span class="linenos">78</span></a>
</span><span id="UserRegistry.add_user-79"><a href="#UserRegistry.add_user-79"><span class="linenos">79</span></a>        <span class="c1"># Check if user already exists</span>
</span><span id="UserRegistry.add_user-80"><a href="#UserRegistry.add_user-80"><span class="linenos">80</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
</span><span id="UserRegistry.add_user-81"><a href="#UserRegistry.add_user-81"><span class="linenos">81</span></a>            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserRegistry.add_user-82"><a href="#UserRegistry.add_user-82"><span class="linenos">82</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="UserRegistry.add_user-83"><a href="#UserRegistry.add_user-83"><span class="linenos">83</span></a>
</span><span id="UserRegistry.add_user-84"><a href="#UserRegistry.add_user-84"><span class="linenos">84</span></a>        <span class="c1"># Add new user</span>
</span><span id="UserRegistry.add_user-85"><a href="#UserRegistry.add_user-85"><span class="linenos">85</span></a>        <span class="n">new_user</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="UserRegistry.add_user-86"><a href="#UserRegistry.add_user-86"><span class="linenos">86</span></a>            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
</span><span id="UserRegistry.add_user-87"><a href="#UserRegistry.add_user-87"><span class="linenos">87</span></a>            <span class="s2">&quot;user_name&quot;</span><span class="p">:</span> <span class="n">user_name</span> <span class="ow">or</span> <span class="n">user_id</span><span class="p">,</span>
</span><span id="UserRegistry.add_user-88"><a href="#UserRegistry.add_user-88"><span class="linenos">88</span></a>            <span class="s2">&quot;user_type&quot;</span><span class="p">:</span> <span class="n">user_type</span><span class="p">,</span>
</span><span id="UserRegistry.add_user-89"><a href="#UserRegistry.add_user-89"><span class="linenos">89</span></a>            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="UserRegistry.add_user-90"><a href="#UserRegistry.add_user-90"><span class="linenos">90</span></a>            <span class="s2">&quot;last_seen&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="UserRegistry.add_user-91"><a href="#UserRegistry.add_user-91"><span class="linenos">91</span></a>        <span class="p">}</span>
</span><span id="UserRegistry.add_user-92"><a href="#UserRegistry.add_user-92"><span class="linenos">92</span></a>
</span><span id="UserRegistry.add_user-93"><a href="#UserRegistry.add_user-93"><span class="linenos">93</span></a>        <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span><span id="UserRegistry.add_user-94"><a href="#UserRegistry.add_user-94"><span class="linenos">94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_registry</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
</span><span id="UserRegistry.add_user-95"><a href="#UserRegistry.add_user-95"><span class="linenos">95</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>Add a new user to the registry.</p>

<p>Args:
    user_id: Unique user identifier
    user_name: Display name for the user (defaults to user_id)
    user_type: User type (Standard, Admin, Guest)</p>

<p>Returns:
    True if user was added, False if user already exists</p>
</div>


                            </div>
                            <div id="UserRegistry.get_all_users" class="classattr">
                                        <input id="UserRegistry.get_all_users-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_all_users</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="UserRegistry.get_all_users-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserRegistry.get_all_users"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserRegistry.get_all_users-97"><a href="#UserRegistry.get_all_users-97"><span class="linenos"> 97</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_users</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="UserRegistry.get_all_users-98"><a href="#UserRegistry.get_all_users-98"><span class="linenos"> 98</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry.get_all_users-99"><a href="#UserRegistry.get_all_users-99"><span class="linenos"> 99</span></a><span class="sd">        Get all users from the registry.</span>
</span><span id="UserRegistry.get_all_users-100"><a href="#UserRegistry.get_all_users-100"><span class="linenos">100</span></a>
</span><span id="UserRegistry.get_all_users-101"><a href="#UserRegistry.get_all_users-101"><span class="linenos">101</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry.get_all_users-102"><a href="#UserRegistry.get_all_users-102"><span class="linenos">102</span></a><span class="sd">            List of user dictionaries</span>
</span><span id="UserRegistry.get_all_users-103"><a href="#UserRegistry.get_all_users-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry.get_all_users-104"><a href="#UserRegistry.get_all_users-104"><span class="linenos">104</span></a>        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_registry</span><span class="p">()</span>
</span><span id="UserRegistry.get_all_users-105"><a href="#UserRegistry.get_all_users-105"><span class="linenos">105</span></a>        <span class="k">return</span> <span class="n">registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span></pre></div>


            <div class="docstring"><p>Get all users from the registry.</p>

<p>Returns:
    List of user dictionaries</p>
</div>


                            </div>
                            <div id="UserRegistry.get_user" class="classattr">
                                        <input id="UserRegistry.get_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_user</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="UserRegistry.get_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserRegistry.get_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserRegistry.get_user-107"><a href="#UserRegistry.get_user-107"><span class="linenos">107</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="UserRegistry.get_user-108"><a href="#UserRegistry.get_user-108"><span class="linenos">108</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry.get_user-109"><a href="#UserRegistry.get_user-109"><span class="linenos">109</span></a><span class="sd">        Get a specific user from the registry.</span>
</span><span id="UserRegistry.get_user-110"><a href="#UserRegistry.get_user-110"><span class="linenos">110</span></a>
</span><span id="UserRegistry.get_user-111"><a href="#UserRegistry.get_user-111"><span class="linenos">111</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry.get_user-112"><a href="#UserRegistry.get_user-112"><span class="linenos">112</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserRegistry.get_user-113"><a href="#UserRegistry.get_user-113"><span class="linenos">113</span></a>
</span><span id="UserRegistry.get_user-114"><a href="#UserRegistry.get_user-114"><span class="linenos">114</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry.get_user-115"><a href="#UserRegistry.get_user-115"><span class="linenos">115</span></a><span class="sd">            User dictionary or None if not found</span>
</span><span id="UserRegistry.get_user-116"><a href="#UserRegistry.get_user-116"><span class="linenos">116</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry.get_user-117"><a href="#UserRegistry.get_user-117"><span class="linenos">117</span></a>        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_registry</span><span class="p">()</span>
</span><span id="UserRegistry.get_user-118"><a href="#UserRegistry.get_user-118"><span class="linenos">118</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
</span><span id="UserRegistry.get_user-119"><a href="#UserRegistry.get_user-119"><span class="linenos">119</span></a>            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserRegistry.get_user-120"><a href="#UserRegistry.get_user-120"><span class="linenos">120</span></a>                <span class="k">return</span> <span class="n">user</span>
</span><span id="UserRegistry.get_user-121"><a href="#UserRegistry.get_user-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Get a specific user from the registry.</p>

<p>Args:
    user_id: User identifier</p>

<p>Returns:
    User dictionary or None if not found</p>
</div>


                            </div>
                            <div id="UserRegistry.remove_user" class="classattr">
                                        <input id="UserRegistry.remove_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">remove_user</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="UserRegistry.remove_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserRegistry.remove_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserRegistry.remove_user-123"><a href="#UserRegistry.remove_user-123"><span class="linenos">123</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserRegistry.remove_user-124"><a href="#UserRegistry.remove_user-124"><span class="linenos">124</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry.remove_user-125"><a href="#UserRegistry.remove_user-125"><span class="linenos">125</span></a><span class="sd">        Remove a user from the registry.</span>
</span><span id="UserRegistry.remove_user-126"><a href="#UserRegistry.remove_user-126"><span class="linenos">126</span></a>
</span><span id="UserRegistry.remove_user-127"><a href="#UserRegistry.remove_user-127"><span class="linenos">127</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry.remove_user-128"><a href="#UserRegistry.remove_user-128"><span class="linenos">128</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserRegistry.remove_user-129"><a href="#UserRegistry.remove_user-129"><span class="linenos">129</span></a>
</span><span id="UserRegistry.remove_user-130"><a href="#UserRegistry.remove_user-130"><span class="linenos">130</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry.remove_user-131"><a href="#UserRegistry.remove_user-131"><span class="linenos">131</span></a><span class="sd">            True if user was removed, False if user not found</span>
</span><span id="UserRegistry.remove_user-132"><a href="#UserRegistry.remove_user-132"><span class="linenos">132</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry.remove_user-133"><a href="#UserRegistry.remove_user-133"><span class="linenos">133</span></a>        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_registry</span><span class="p">()</span>
</span><span id="UserRegistry.remove_user-134"><a href="#UserRegistry.remove_user-134"><span class="linenos">134</span></a>        <span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">])</span>
</span><span id="UserRegistry.remove_user-135"><a href="#UserRegistry.remove_user-135"><span class="linenos">135</span></a>
</span><span id="UserRegistry.remove_user-136"><a href="#UserRegistry.remove_user-136"><span class="linenos">136</span></a>        <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="UserRegistry.remove_user-137"><a href="#UserRegistry.remove_user-137"><span class="linenos">137</span></a>            <span class="n">user</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">user_id</span>
</span><span id="UserRegistry.remove_user-138"><a href="#UserRegistry.remove_user-138"><span class="linenos">138</span></a>        <span class="p">]</span>
</span><span id="UserRegistry.remove_user-139"><a href="#UserRegistry.remove_user-139"><span class="linenos">139</span></a>
</span><span id="UserRegistry.remove_user-140"><a href="#UserRegistry.remove_user-140"><span class="linenos">140</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">original_count</span><span class="p">:</span>
</span><span id="UserRegistry.remove_user-141"><a href="#UserRegistry.remove_user-141"><span class="linenos">141</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_save_registry</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
</span><span id="UserRegistry.remove_user-142"><a href="#UserRegistry.remove_user-142"><span class="linenos">142</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="UserRegistry.remove_user-143"><a href="#UserRegistry.remove_user-143"><span class="linenos">143</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Remove a user from the registry.</p>

<p>Args:
    user_id: User identifier</p>

<p>Returns:
    True if user was removed, False if user not found</p>
</div>


                            </div>
                            <div id="UserRegistry.update_last_seen" class="classattr">
                                        <input id="UserRegistry.update_last_seen-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_last_seen</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="UserRegistry.update_last_seen-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserRegistry.update_last_seen"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserRegistry.update_last_seen-145"><a href="#UserRegistry.update_last_seen-145"><span class="linenos">145</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_last_seen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserRegistry.update_last_seen-146"><a href="#UserRegistry.update_last_seen-146"><span class="linenos">146</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry.update_last_seen-147"><a href="#UserRegistry.update_last_seen-147"><span class="linenos">147</span></a><span class="sd">        Update the last_seen timestamp for a user.</span>
</span><span id="UserRegistry.update_last_seen-148"><a href="#UserRegistry.update_last_seen-148"><span class="linenos">148</span></a>
</span><span id="UserRegistry.update_last_seen-149"><a href="#UserRegistry.update_last_seen-149"><span class="linenos">149</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry.update_last_seen-150"><a href="#UserRegistry.update_last_seen-150"><span class="linenos">150</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserRegistry.update_last_seen-151"><a href="#UserRegistry.update_last_seen-151"><span class="linenos">151</span></a>
</span><span id="UserRegistry.update_last_seen-152"><a href="#UserRegistry.update_last_seen-152"><span class="linenos">152</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry.update_last_seen-153"><a href="#UserRegistry.update_last_seen-153"><span class="linenos">153</span></a><span class="sd">            True if user was updated, False if user not found</span>
</span><span id="UserRegistry.update_last_seen-154"><a href="#UserRegistry.update_last_seen-154"><span class="linenos">154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry.update_last_seen-155"><a href="#UserRegistry.update_last_seen-155"><span class="linenos">155</span></a>        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_registry</span><span class="p">()</span>
</span><span id="UserRegistry.update_last_seen-156"><a href="#UserRegistry.update_last_seen-156"><span class="linenos">156</span></a>
</span><span id="UserRegistry.update_last_seen-157"><a href="#UserRegistry.update_last_seen-157"><span class="linenos">157</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
</span><span id="UserRegistry.update_last_seen-158"><a href="#UserRegistry.update_last_seen-158"><span class="linenos">158</span></a>            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserRegistry.update_last_seen-159"><a href="#UserRegistry.update_last_seen-159"><span class="linenos">159</span></a>                <span class="n">user</span><span class="p">[</span><span class="s2">&quot;last_seen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="UserRegistry.update_last_seen-160"><a href="#UserRegistry.update_last_seen-160"><span class="linenos">160</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_save_registry</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
</span><span id="UserRegistry.update_last_seen-161"><a href="#UserRegistry.update_last_seen-161"><span class="linenos">161</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="UserRegistry.update_last_seen-162"><a href="#UserRegistry.update_last_seen-162"><span class="linenos">162</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Update the last_seen timestamp for a user.</p>

<p>Args:
    user_id: User identifier</p>

<p>Returns:
    True if user was updated, False if user not found</p>
</div>


                            </div>
                            <div id="UserRegistry.update_user" class="classattr">
                                        <input id="UserRegistry.update_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_user</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="UserRegistry.update_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserRegistry.update_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserRegistry.update_user-164"><a href="#UserRegistry.update_user-164"><span class="linenos">164</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserRegistry.update_user-165"><a href="#UserRegistry.update_user-165"><span class="linenos">165</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry.update_user-166"><a href="#UserRegistry.update_user-166"><span class="linenos">166</span></a><span class="sd">        Update user information.</span>
</span><span id="UserRegistry.update_user-167"><a href="#UserRegistry.update_user-167"><span class="linenos">167</span></a>
</span><span id="UserRegistry.update_user-168"><a href="#UserRegistry.update_user-168"><span class="linenos">168</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry.update_user-169"><a href="#UserRegistry.update_user-169"><span class="linenos">169</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserRegistry.update_user-170"><a href="#UserRegistry.update_user-170"><span class="linenos">170</span></a><span class="sd">            **kwargs: Fields to update (user_name, user_type, etc.)</span>
</span><span id="UserRegistry.update_user-171"><a href="#UserRegistry.update_user-171"><span class="linenos">171</span></a>
</span><span id="UserRegistry.update_user-172"><a href="#UserRegistry.update_user-172"><span class="linenos">172</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry.update_user-173"><a href="#UserRegistry.update_user-173"><span class="linenos">173</span></a><span class="sd">            True if user was updated, False if user not found</span>
</span><span id="UserRegistry.update_user-174"><a href="#UserRegistry.update_user-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry.update_user-175"><a href="#UserRegistry.update_user-175"><span class="linenos">175</span></a>        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_registry</span><span class="p">()</span>
</span><span id="UserRegistry.update_user-176"><a href="#UserRegistry.update_user-176"><span class="linenos">176</span></a>
</span><span id="UserRegistry.update_user-177"><a href="#UserRegistry.update_user-177"><span class="linenos">177</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
</span><span id="UserRegistry.update_user-178"><a href="#UserRegistry.update_user-178"><span class="linenos">178</span></a>            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="UserRegistry.update_user-179"><a href="#UserRegistry.update_user-179"><span class="linenos">179</span></a>                <span class="c1"># Update allowed fields</span>
</span><span id="UserRegistry.update_user-180"><a href="#UserRegistry.update_user-180"><span class="linenos">180</span></a>                <span class="n">allowed_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user_name&quot;</span><span class="p">,</span> <span class="s2">&quot;user_type&quot;</span><span class="p">}</span>
</span><span id="UserRegistry.update_user-181"><a href="#UserRegistry.update_user-181"><span class="linenos">181</span></a>                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="UserRegistry.update_user-182"><a href="#UserRegistry.update_user-182"><span class="linenos">182</span></a>                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">allowed_fields</span><span class="p">:</span>
</span><span id="UserRegistry.update_user-183"><a href="#UserRegistry.update_user-183"><span class="linenos">183</span></a>                        <span class="n">user</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="UserRegistry.update_user-184"><a href="#UserRegistry.update_user-184"><span class="linenos">184</span></a>
</span><span id="UserRegistry.update_user-185"><a href="#UserRegistry.update_user-185"><span class="linenos">185</span></a>                <span class="n">user</span><span class="p">[</span><span class="s2">&quot;last_seen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="UserRegistry.update_user-186"><a href="#UserRegistry.update_user-186"><span class="linenos">186</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_save_registry</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
</span><span id="UserRegistry.update_user-187"><a href="#UserRegistry.update_user-187"><span class="linenos">187</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="UserRegistry.update_user-188"><a href="#UserRegistry.update_user-188"><span class="linenos">188</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Update user information.</p>

<p>Args:
    user_id: User identifier
    **kwargs: Fields to update (user_name, user_type, etc.)</p>

<p>Returns:
    True if user was updated, False if user not found</p>
</div>


                            </div>
                            <div id="UserRegistry.user_exists" class="classattr">
                                        <input id="UserRegistry.user_exists-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">user_exists</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="UserRegistry.user_exists-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserRegistry.user_exists"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserRegistry.user_exists-190"><a href="#UserRegistry.user_exists-190"><span class="linenos">190</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">user_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserRegistry.user_exists-191"><a href="#UserRegistry.user_exists-191"><span class="linenos">191</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry.user_exists-192"><a href="#UserRegistry.user_exists-192"><span class="linenos">192</span></a><span class="sd">        Check if a user exists in the registry.</span>
</span><span id="UserRegistry.user_exists-193"><a href="#UserRegistry.user_exists-193"><span class="linenos">193</span></a>
</span><span id="UserRegistry.user_exists-194"><a href="#UserRegistry.user_exists-194"><span class="linenos">194</span></a><span class="sd">        Args:</span>
</span><span id="UserRegistry.user_exists-195"><a href="#UserRegistry.user_exists-195"><span class="linenos">195</span></a><span class="sd">            user_id: User identifier</span>
</span><span id="UserRegistry.user_exists-196"><a href="#UserRegistry.user_exists-196"><span class="linenos">196</span></a>
</span><span id="UserRegistry.user_exists-197"><a href="#UserRegistry.user_exists-197"><span class="linenos">197</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry.user_exists-198"><a href="#UserRegistry.user_exists-198"><span class="linenos">198</span></a><span class="sd">            True if user exists, False otherwise</span>
</span><span id="UserRegistry.user_exists-199"><a href="#UserRegistry.user_exists-199"><span class="linenos">199</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry.user_exists-200"><a href="#UserRegistry.user_exists-200"><span class="linenos">200</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Check if a user exists in the registry.</p>

<p>Args:
    user_id: User identifier</p>

<p>Returns:
    True if user exists, False otherwise</p>
</div>


                            </div>
                            <div id="UserRegistry.get_current_user" class="classattr">
                                        <input id="UserRegistry.get_current_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_current_user</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="UserRegistry.get_current_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserRegistry.get_current_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserRegistry.get_current_user-202"><a href="#UserRegistry.get_current_user-202"><span class="linenos">202</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="UserRegistry.get_current_user-203"><a href="#UserRegistry.get_current_user-203"><span class="linenos">203</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry.get_current_user-204"><a href="#UserRegistry.get_current_user-204"><span class="linenos">204</span></a><span class="sd">        Get the current user from the single source of truth (user_id_mgr).</span>
</span><span id="UserRegistry.get_current_user-205"><a href="#UserRegistry.get_current_user-205"><span class="linenos">205</span></a>
</span><span id="UserRegistry.get_current_user-206"><a href="#UserRegistry.get_current_user-206"><span class="linenos">206</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry.get_current_user-207"><a href="#UserRegistry.get_current_user-207"><span class="linenos">207</span></a><span class="sd">            Current user dictionary or None if not found</span>
</span><span id="UserRegistry.get_current_user-208"><a href="#UserRegistry.get_current_user-208"><span class="linenos">208</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry.get_current_user-209"><a href="#UserRegistry.get_current_user-209"><span class="linenos">209</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">get_current_user_id</span><span class="p">())</span>
</span></pre></div>


            <div class="docstring"><p>Get the current user from the single source of truth (user_id_mgr).</p>

<p>Returns:
    Current user dictionary or None if not found</p>
</div>


                            </div>
                            <div id="UserRegistry.ensure_current_user_registered" class="classattr">
                                        <input id="UserRegistry.ensure_current_user_registered-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ensure_current_user_registered</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="UserRegistry.ensure_current_user_registered-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UserRegistry.ensure_current_user_registered"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UserRegistry.ensure_current_user_registered-211"><a href="#UserRegistry.ensure_current_user_registered-211"><span class="linenos">211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_current_user_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="UserRegistry.ensure_current_user_registered-212"><a href="#UserRegistry.ensure_current_user_registered-212"><span class="linenos">212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="UserRegistry.ensure_current_user_registered-213"><a href="#UserRegistry.ensure_current_user_registered-213"><span class="linenos">213</span></a><span class="sd">        Ensure the current USER_ID is registered in the registry.</span>
</span><span id="UserRegistry.ensure_current_user_registered-214"><a href="#UserRegistry.ensure_current_user_registered-214"><span class="linenos">214</span></a><span class="sd">        Auto-registers if not found.</span>
</span><span id="UserRegistry.ensure_current_user_registered-215"><a href="#UserRegistry.ensure_current_user_registered-215"><span class="linenos">215</span></a>
</span><span id="UserRegistry.ensure_current_user_registered-216"><a href="#UserRegistry.ensure_current_user_registered-216"><span class="linenos">216</span></a><span class="sd">        Returns:</span>
</span><span id="UserRegistry.ensure_current_user_registered-217"><a href="#UserRegistry.ensure_current_user_registered-217"><span class="linenos">217</span></a><span class="sd">            True if user was already registered or successfully added</span>
</span><span id="UserRegistry.ensure_current_user_registered-218"><a href="#UserRegistry.ensure_current_user_registered-218"><span class="linenos">218</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="UserRegistry.ensure_current_user_registered-219"><a href="#UserRegistry.ensure_current_user_registered-219"><span class="linenos">219</span></a>        <span class="n">current_user_id</span> <span class="o">=</span> <span class="n">get_userid</span><span class="p">()</span>
</span><span id="UserRegistry.ensure_current_user_registered-220"><a href="#UserRegistry.ensure_current_user_registered-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">current_user_id</span><span class="p">):</span>
</span><span id="UserRegistry.ensure_current_user_registered-221"><a href="#UserRegistry.ensure_current_user_registered-221"><span class="linenos">221</span></a>            <span class="c1"># Update last_seen for existing user</span>
</span><span id="UserRegistry.ensure_current_user_registered-222"><a href="#UserRegistry.ensure_current_user_registered-222"><span class="linenos">222</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_last_seen</span><span class="p">(</span><span class="n">current_user_id</span><span class="p">)</span>
</span><span id="UserRegistry.ensure_current_user_registered-223"><a href="#UserRegistry.ensure_current_user_registered-223"><span class="linenos">223</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="UserRegistry.ensure_current_user_registered-224"><a href="#UserRegistry.ensure_current_user_registered-224"><span class="linenos">224</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="UserRegistry.ensure_current_user_registered-225"><a href="#UserRegistry.ensure_current_user_registered-225"><span class="linenos">225</span></a>            <span class="c1"># Auto-register current user</span>
</span><span id="UserRegistry.ensure_current_user_registered-226"><a href="#UserRegistry.ensure_current_user_registered-226"><span class="linenos">226</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">current_user_id</span><span class="p">,</span> <span class="n">current_user_id</span><span class="p">,</span> <span class="s2">&quot;Admin&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Ensure the current USER_ID is registered in the registry.
Auto-registers if not found.</p>

<p>Returns:
    True if user was already registered or successfully added</p>
</div>


                            </div>
                </section>
                <section id="LightRAGManager">
                            <input id="LightRAGManager-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LightRAGManager</span>:

                <label class="view-source-button" for="LightRAGManager-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightRAGManager"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightRAGManager-16"><a href="#LightRAGManager-16"><span class="linenos"> 16</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LightRAGManager</span><span class="p">:</span>
</span><span id="LightRAGManager-17"><a href="#LightRAGManager-17"><span class="linenos"> 17</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages LightRAG Docker services with Python implementation of restart-lightrag.sh.&quot;&quot;&quot;</span>
</span><span id="LightRAGManager-18"><a href="#LightRAGManager-18"><span class="linenos"> 18</span></a>
</span><span id="LightRAGManager-19"><a href="#LightRAGManager-19"><span class="linenos"> 19</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="LightRAGManager-20"><a href="#LightRAGManager-20"><span class="linenos"> 20</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightRAGManager-21"><a href="#LightRAGManager-21"><span class="linenos"> 21</span></a><span class="sd">        Initialize the LightRAG manager.</span>
</span><span id="LightRAGManager-22"><a href="#LightRAGManager-22"><span class="linenos"> 22</span></a>
</span><span id="LightRAGManager-23"><a href="#LightRAGManager-23"><span class="linenos"> 23</span></a><span class="sd">        Args:</span>
</span><span id="LightRAGManager-24"><a href="#LightRAGManager-24"><span class="linenos"> 24</span></a><span class="sd">            project_root: Project root directory (deprecated, now uses PERSAG_HOME)</span>
</span><span id="LightRAGManager-25"><a href="#LightRAGManager-25"><span class="linenos"> 25</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightRAGManager-26"><a href="#LightRAGManager-26"><span class="linenos"> 26</span></a>        <span class="c1"># Import settings to get the correct PERSAG_HOME-based paths</span>
</span><span id="LightRAGManager-27"><a href="#LightRAGManager-27"><span class="linenos"> 27</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="LightRAGManager-28"><a href="#LightRAGManager-28"><span class="linenos"> 28</span></a>            <span class="n">LIGHTRAG_MEMORY_DIR</span><span class="p">,</span>
</span><span id="LightRAGManager-29"><a href="#LightRAGManager-29"><span class="linenos"> 29</span></a>            <span class="n">LIGHTRAG_SERVER_DIR</span><span class="p">,</span>
</span><span id="LightRAGManager-30"><a href="#LightRAGManager-30"><span class="linenos"> 30</span></a>        <span class="p">)</span>
</span><span id="LightRAGManager-31"><a href="#LightRAGManager-31"><span class="linenos"> 31</span></a>
</span><span id="LightRAGManager-32"><a href="#LightRAGManager-32"><span class="linenos"> 32</span></a>        <span class="c1"># Use the centralized configuration paths from PERSAG_HOME</span>
</span><span id="LightRAGManager-33"><a href="#LightRAGManager-33"><span class="linenos"> 33</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_server_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">LIGHTRAG_SERVER_DIR</span><span class="p">)</span>
</span><span id="LightRAGManager-34"><a href="#LightRAGManager-34"><span class="linenos"> 34</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">LIGHTRAG_MEMORY_DIR</span><span class="p">)</span>
</span><span id="LightRAGManager-35"><a href="#LightRAGManager-35"><span class="linenos"> 35</span></a>
</span><span id="LightRAGManager-36"><a href="#LightRAGManager-36"><span class="linenos"> 36</span></a>        <span class="c1"># Keep project_root for backward compatibility, but it&#39;s no longer used for docker paths</span>
</span><span id="LightRAGManager-37"><a href="#LightRAGManager-37"><span class="linenos"> 37</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_root</span><span class="p">)</span> <span class="k">if</span> <span class="n">project_root</span> <span class="k">else</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
</span><span id="LightRAGManager-38"><a href="#LightRAGManager-38"><span class="linenos"> 38</span></a>
</span><span id="LightRAGManager-39"><a href="#LightRAGManager-39"><span class="linenos"> 39</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_docker_compose_user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="LightRAGManager-40"><a href="#LightRAGManager-40"><span class="linenos"> 40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightRAGManager-41"><a href="#LightRAGManager-41"><span class="linenos"> 41</span></a><span class="sd">        Update USER_ID in docker-compose .env files and docker-compose.yml files.</span>
</span><span id="LightRAGManager-42"><a href="#LightRAGManager-42"><span class="linenos"> 42</span></a>
</span><span id="LightRAGManager-43"><a href="#LightRAGManager-43"><span class="linenos"> 43</span></a><span class="sd">        Args:</span>
</span><span id="LightRAGManager-44"><a href="#LightRAGManager-44"><span class="linenos"> 44</span></a><span class="sd">            user_id: User ID to set in environment files</span>
</span><span id="LightRAGManager-45"><a href="#LightRAGManager-45"><span class="linenos"> 45</span></a>
</span><span id="LightRAGManager-46"><a href="#LightRAGManager-46"><span class="linenos"> 46</span></a><span class="sd">        Returns:</span>
</span><span id="LightRAGManager-47"><a href="#LightRAGManager-47"><span class="linenos"> 47</span></a><span class="sd">            Dictionary with operation results</span>
</span><span id="LightRAGManager-48"><a href="#LightRAGManager-48"><span class="linenos"> 48</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightRAGManager-49"><a href="#LightRAGManager-49"><span class="linenos"> 49</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;updated_files&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="LightRAGManager-50"><a href="#LightRAGManager-50"><span class="linenos"> 50</span></a>
</span><span id="LightRAGManager-51"><a href="#LightRAGManager-51"><span class="linenos"> 51</span></a>        <span class="c1"># List of directories to update</span>
</span><span id="LightRAGManager-52"><a href="#LightRAGManager-52"><span class="linenos"> 52</span></a>        <span class="n">directories</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LightRAGManager-53"><a href="#LightRAGManager-53"><span class="linenos"> 53</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_server_dir</span><span class="p">),</span>
</span><span id="LightRAGManager-54"><a href="#LightRAGManager-54"><span class="linenos"> 54</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_dir</span><span class="p">),</span>
</span><span id="LightRAGManager-55"><a href="#LightRAGManager-55"><span class="linenos"> 55</span></a>        <span class="p">]</span>
</span><span id="LightRAGManager-56"><a href="#LightRAGManager-56"><span class="linenos"> 56</span></a>
</span><span id="LightRAGManager-57"><a href="#LightRAGManager-57"><span class="linenos"> 57</span></a>        <span class="k">for</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">dir_path</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
</span><span id="LightRAGManager-58"><a href="#LightRAGManager-58"><span class="linenos"> 58</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager-59"><a href="#LightRAGManager-59"><span class="linenos"> 59</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager-60"><a href="#LightRAGManager-60"><span class="linenos"> 60</span></a>                    <span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2"> not found at </span><span class="si">{</span><span class="n">dir_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager-61"><a href="#LightRAGManager-61"><span class="linenos"> 61</span></a>                <span class="p">)</span>
</span><span id="LightRAGManager-62"><a href="#LightRAGManager-62"><span class="linenos"> 62</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager-63"><a href="#LightRAGManager-63"><span class="linenos"> 63</span></a>
</span><span id="LightRAGManager-64"><a href="#LightRAGManager-64"><span class="linenos"> 64</span></a>            <span class="c1"># Update .env file</span>
</span><span id="LightRAGManager-65"><a href="#LightRAGManager-65"><span class="linenos"> 65</span></a>            <span class="n">env_file</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">/</span> <span class="s2">&quot;.env&quot;</span>
</span><span id="LightRAGManager-66"><a href="#LightRAGManager-66"><span class="linenos"> 66</span></a>
</span><span id="LightRAGManager-67"><a href="#LightRAGManager-67"><span class="linenos"> 67</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-68"><a href="#LightRAGManager-68"><span class="linenos"> 68</span></a>                <span class="c1"># Read existing .env file or create new one</span>
</span><span id="LightRAGManager-69"><a href="#LightRAGManager-69"><span class="linenos"> 69</span></a>                <span class="n">env_lines</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightRAGManager-70"><a href="#LightRAGManager-70"><span class="linenos"> 70</span></a>                <span class="n">user_id_found</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-71"><a href="#LightRAGManager-71"><span class="linenos"> 71</span></a>
</span><span id="LightRAGManager-72"><a href="#LightRAGManager-72"><span class="linenos"> 72</span></a>                <span class="k">if</span> <span class="n">env_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager-73"><a href="#LightRAGManager-73"><span class="linenos"> 73</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager-74"><a href="#LightRAGManager-74"><span class="linenos"> 74</span></a>                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager-75"><a href="#LightRAGManager-75"><span class="linenos"> 75</span></a>                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;USER_ID=&quot;</span><span class="p">):</span>
</span><span id="LightRAGManager-76"><a href="#LightRAGManager-76"><span class="linenos"> 76</span></a>                                <span class="n">env_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USER_ID=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-77"><a href="#LightRAGManager-77"><span class="linenos"> 77</span></a>                                <span class="n">user_id_found</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LightRAGManager-78"><a href="#LightRAGManager-78"><span class="linenos"> 78</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager-79"><a href="#LightRAGManager-79"><span class="linenos"> 79</span></a>                                <span class="n">env_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="LightRAGManager-80"><a href="#LightRAGManager-80"><span class="linenos"> 80</span></a>
</span><span id="LightRAGManager-81"><a href="#LightRAGManager-81"><span class="linenos"> 81</span></a>                <span class="c1"># Add USER_ID if not found</span>
</span><span id="LightRAGManager-82"><a href="#LightRAGManager-82"><span class="linenos"> 82</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id_found</span><span class="p">:</span>
</span><span id="LightRAGManager-83"><a href="#LightRAGManager-83"><span class="linenos"> 83</span></a>                    <span class="n">env_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USER_ID=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-84"><a href="#LightRAGManager-84"><span class="linenos"> 84</span></a>
</span><span id="LightRAGManager-85"><a href="#LightRAGManager-85"><span class="linenos"> 85</span></a>                <span class="c1"># Write updated .env file</span>
</span><span id="LightRAGManager-86"><a href="#LightRAGManager-86"><span class="linenos"> 86</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager-87"><a href="#LightRAGManager-87"><span class="linenos"> 87</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">env_lines</span><span class="p">)</span>
</span><span id="LightRAGManager-88"><a href="#LightRAGManager-88"><span class="linenos"> 88</span></a>
</span><span id="LightRAGManager-89"><a href="#LightRAGManager-89"><span class="linenos"> 89</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;updated_files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">env_file</span><span class="p">))</span>
</span><span id="LightRAGManager-90"><a href="#LightRAGManager-90"><span class="linenos"> 90</span></a>
</span><span id="LightRAGManager-91"><a href="#LightRAGManager-91"><span class="linenos"> 91</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager-92"><a href="#LightRAGManager-92"><span class="linenos"> 92</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating </span><span class="si">{</span><span class="n">env_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-93"><a href="#LightRAGManager-93"><span class="linenos"> 93</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-94"><a href="#LightRAGManager-94"><span class="linenos"> 94</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager-95"><a href="#LightRAGManager-95"><span class="linenos"> 95</span></a>
</span><span id="LightRAGManager-96"><a href="#LightRAGManager-96"><span class="linenos"> 96</span></a>            <span class="c1"># Update docker-compose.yml to ensure USER_ID is passed as environment variable</span>
</span><span id="LightRAGManager-97"><a href="#LightRAGManager-97"><span class="linenos"> 97</span></a>            <span class="n">docker_compose_file</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">/</span> <span class="s2">&quot;docker-compose.yml&quot;</span>
</span><span id="LightRAGManager-98"><a href="#LightRAGManager-98"><span class="linenos"> 98</span></a>
</span><span id="LightRAGManager-99"><a href="#LightRAGManager-99"><span class="linenos"> 99</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-100"><a href="#LightRAGManager-100"><span class="linenos">100</span></a>                <span class="k">if</span> <span class="n">docker_compose_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager-101"><a href="#LightRAGManager-101"><span class="linenos">101</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">docker_compose_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager-102"><a href="#LightRAGManager-102"><span class="linenos">102</span></a>                        <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="LightRAGManager-103"><a href="#LightRAGManager-103"><span class="linenos">103</span></a>
</span><span id="LightRAGManager-104"><a href="#LightRAGManager-104"><span class="linenos">104</span></a>                    <span class="c1"># Parse and update USER_ID in docker-compose.yml properly</span>
</span><span id="LightRAGManager-105"><a href="#LightRAGManager-105"><span class="linenos">105</span></a>                    <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-106"><a href="#LightRAGManager-106"><span class="linenos">106</span></a>                    <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightRAGManager-107"><a href="#LightRAGManager-107"><span class="linenos">107</span></a>                    <span class="n">in_environment_section</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-108"><a href="#LightRAGManager-108"><span class="linenos">108</span></a>                    <span class="n">user_id_updated</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-109"><a href="#LightRAGManager-109"><span class="linenos">109</span></a>
</span><span id="LightRAGManager-110"><a href="#LightRAGManager-110"><span class="linenos">110</span></a>                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="LightRAGManager-111"><a href="#LightRAGManager-111"><span class="linenos">111</span></a>                        <span class="k">if</span> <span class="s2">&quot;environment:&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
</span><span id="LightRAGManager-112"><a href="#LightRAGManager-112"><span class="linenos">112</span></a>                            <span class="n">in_environment_section</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LightRAGManager-113"><a href="#LightRAGManager-113"><span class="linenos">113</span></a>                            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="LightRAGManager-114"><a href="#LightRAGManager-114"><span class="linenos">114</span></a>                        <span class="k">elif</span> <span class="n">in_environment_section</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
</span><span id="LightRAGManager-115"><a href="#LightRAGManager-115"><span class="linenos">115</span></a>                            <span class="s2">&quot;- USER_ID=&quot;</span>
</span><span id="LightRAGManager-116"><a href="#LightRAGManager-116"><span class="linenos">116</span></a>                        <span class="p">):</span>
</span><span id="LightRAGManager-117"><a href="#LightRAGManager-117"><span class="linenos">117</span></a>                            <span class="c1"># Replace existing USER_ID line</span>
</span><span id="LightRAGManager-118"><a href="#LightRAGManager-118"><span class="linenos">118</span></a>                            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      - USER_ID=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-119"><a href="#LightRAGManager-119"><span class="linenos">119</span></a>                            <span class="n">user_id_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LightRAGManager-120"><a href="#LightRAGManager-120"><span class="linenos">120</span></a>                        <span class="k">elif</span> <span class="n">in_environment_section</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;      - &quot;</span><span class="p">):</span>
</span><span id="LightRAGManager-121"><a href="#LightRAGManager-121"><span class="linenos">121</span></a>                            <span class="c1"># Other environment variables</span>
</span><span id="LightRAGManager-122"><a href="#LightRAGManager-122"><span class="linenos">122</span></a>                            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="LightRAGManager-123"><a href="#LightRAGManager-123"><span class="linenos">123</span></a>                        <span class="k">elif</span> <span class="p">(</span>
</span><span id="LightRAGManager-124"><a href="#LightRAGManager-124"><span class="linenos">124</span></a>                            <span class="n">in_environment_section</span>
</span><span id="LightRAGManager-125"><a href="#LightRAGManager-125"><span class="linenos">125</span></a>                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;      &quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-126"><a href="#LightRAGManager-126"><span class="linenos">126</span></a>                            <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="LightRAGManager-127"><a href="#LightRAGManager-127"><span class="linenos">127</span></a>                        <span class="p">):</span>
</span><span id="LightRAGManager-128"><a href="#LightRAGManager-128"><span class="linenos">128</span></a>                            <span class="c1"># End of environment section</span>
</span><span id="LightRAGManager-129"><a href="#LightRAGManager-129"><span class="linenos">129</span></a>                            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id_updated</span><span class="p">:</span>
</span><span id="LightRAGManager-130"><a href="#LightRAGManager-130"><span class="linenos">130</span></a>                                <span class="c1"># Add USER_ID if it wasn&#39;t found</span>
</span><span id="LightRAGManager-131"><a href="#LightRAGManager-131"><span class="linenos">131</span></a>                                <span class="n">new_lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;      - USER_ID=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-132"><a href="#LightRAGManager-132"><span class="linenos">132</span></a>                            <span class="n">in_environment_section</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-133"><a href="#LightRAGManager-133"><span class="linenos">133</span></a>                            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="LightRAGManager-134"><a href="#LightRAGManager-134"><span class="linenos">134</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager-135"><a href="#LightRAGManager-135"><span class="linenos">135</span></a>                            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="LightRAGManager-136"><a href="#LightRAGManager-136"><span class="linenos">136</span></a>
</span><span id="LightRAGManager-137"><a href="#LightRAGManager-137"><span class="linenos">137</span></a>                    <span class="c1"># If we&#39;re still in environment section at end of file and USER_ID wasn&#39;t updated</span>
</span><span id="LightRAGManager-138"><a href="#LightRAGManager-138"><span class="linenos">138</span></a>                    <span class="k">if</span> <span class="n">in_environment_section</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">user_id_updated</span><span class="p">:</span>
</span><span id="LightRAGManager-139"><a href="#LightRAGManager-139"><span class="linenos">139</span></a>                        <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      - USER_ID=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-140"><a href="#LightRAGManager-140"><span class="linenos">140</span></a>
</span><span id="LightRAGManager-141"><a href="#LightRAGManager-141"><span class="linenos">141</span></a>                    <span class="c1"># Write updated docker-compose.yml</span>
</span><span id="LightRAGManager-142"><a href="#LightRAGManager-142"><span class="linenos">142</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">docker_compose_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager-143"><a href="#LightRAGManager-143"><span class="linenos">143</span></a>                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_lines</span><span class="p">))</span>
</span><span id="LightRAGManager-144"><a href="#LightRAGManager-144"><span class="linenos">144</span></a>
</span><span id="LightRAGManager-145"><a href="#LightRAGManager-145"><span class="linenos">145</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;updated_files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">docker_compose_file</span><span class="p">))</span>
</span><span id="LightRAGManager-146"><a href="#LightRAGManager-146"><span class="linenos">146</span></a>
</span><span id="LightRAGManager-147"><a href="#LightRAGManager-147"><span class="linenos">147</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager-148"><a href="#LightRAGManager-148"><span class="linenos">148</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager-149"><a href="#LightRAGManager-149"><span class="linenos">149</span></a>                    <span class="sa">f</span><span class="s2">&quot;Error updating </span><span class="si">{</span><span class="n">docker_compose_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager-150"><a href="#LightRAGManager-150"><span class="linenos">150</span></a>                <span class="p">)</span>
</span><span id="LightRAGManager-151"><a href="#LightRAGManager-151"><span class="linenos">151</span></a>                <span class="c1"># Don&#39;t fail the whole operation for docker-compose.yml issues</span>
</span><span id="LightRAGManager-152"><a href="#LightRAGManager-152"><span class="linenos">152</span></a>
</span><span id="LightRAGManager-153"><a href="#LightRAGManager-153"><span class="linenos">153</span></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="LightRAGManager-154"><a href="#LightRAGManager-154"><span class="linenos">154</span></a>
</span><span id="LightRAGManager-155"><a href="#LightRAGManager-155"><span class="linenos">155</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">restart_lightrag_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="LightRAGManager-156"><a href="#LightRAGManager-156"><span class="linenos">156</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightRAGManager-157"><a href="#LightRAGManager-157"><span class="linenos">157</span></a><span class="sd">        Restart LightRAG services with smart restart logic to handle port conflicts.</span>
</span><span id="LightRAGManager-158"><a href="#LightRAGManager-158"><span class="linenos">158</span></a><span class="sd">        Implements the same logic as smart-restart-lightrag.sh.</span>
</span><span id="LightRAGManager-159"><a href="#LightRAGManager-159"><span class="linenos">159</span></a>
</span><span id="LightRAGManager-160"><a href="#LightRAGManager-160"><span class="linenos">160</span></a><span class="sd">        Args:</span>
</span><span id="LightRAGManager-161"><a href="#LightRAGManager-161"><span class="linenos">161</span></a><span class="sd">            user_id: User ID to set (optional, uses current USER_ID if not provided)</span>
</span><span id="LightRAGManager-162"><a href="#LightRAGManager-162"><span class="linenos">162</span></a>
</span><span id="LightRAGManager-163"><a href="#LightRAGManager-163"><span class="linenos">163</span></a><span class="sd">        Returns:</span>
</span><span id="LightRAGManager-164"><a href="#LightRAGManager-164"><span class="linenos">164</span></a><span class="sd">            Dictionary with operation results</span>
</span><span id="LightRAGManager-165"><a href="#LightRAGManager-165"><span class="linenos">165</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightRAGManager-166"><a href="#LightRAGManager-166"><span class="linenos">166</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightRAGManager-167"><a href="#LightRAGManager-167"><span class="linenos">167</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_userid</span>
</span><span id="LightRAGManager-168"><a href="#LightRAGManager-168"><span class="linenos">168</span></a>
</span><span id="LightRAGManager-169"><a href="#LightRAGManager-169"><span class="linenos">169</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_userid</span><span class="p">()</span>
</span><span id="LightRAGManager-170"><a href="#LightRAGManager-170"><span class="linenos">170</span></a>
</span><span id="LightRAGManager-171"><a href="#LightRAGManager-171"><span class="linenos">171</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightRAGManager-172"><a href="#LightRAGManager-172"><span class="linenos">172</span></a>            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-173"><a href="#LightRAGManager-173"><span class="linenos">173</span></a>            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
</span><span id="LightRAGManager-174"><a href="#LightRAGManager-174"><span class="linenos">174</span></a>            <span class="s2">&quot;services_restarted&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="LightRAGManager-175"><a href="#LightRAGManager-175"><span class="linenos">175</span></a>            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="LightRAGManager-176"><a href="#LightRAGManager-176"><span class="linenos">176</span></a>            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="LightRAGManager-177"><a href="#LightRAGManager-177"><span class="linenos">177</span></a>        <span class="p">}</span>
</span><span id="LightRAGManager-178"><a href="#LightRAGManager-178"><span class="linenos">178</span></a>
</span><span id="LightRAGManager-179"><a href="#LightRAGManager-179"><span class="linenos">179</span></a>        <span class="c1"># Update USER_ID in docker-compose files</span>
</span><span id="LightRAGManager-180"><a href="#LightRAGManager-180"><span class="linenos">180</span></a>        <span class="n">update_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_docker_compose_user_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="LightRAGManager-181"><a href="#LightRAGManager-181"><span class="linenos">181</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">update_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
</span><span id="LightRAGManager-182"><a href="#LightRAGManager-182"><span class="linenos">182</span></a>            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">update_result</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">])</span>
</span><span id="LightRAGManager-183"><a href="#LightRAGManager-183"><span class="linenos">183</span></a>            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-184"><a href="#LightRAGManager-184"><span class="linenos">184</span></a>            <span class="k">return</span> <span class="n">results</span>
</span><span id="LightRAGManager-185"><a href="#LightRAGManager-185"><span class="linenos">185</span></a>
</span><span id="LightRAGManager-186"><a href="#LightRAGManager-186"><span class="linenos">186</span></a>        <span class="c1"># Smart restart services with port conflict handling</span>
</span><span id="LightRAGManager-187"><a href="#LightRAGManager-187"><span class="linenos">187</span></a>        <span class="n">services</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LightRAGManager-188"><a href="#LightRAGManager-188"><span class="linenos">188</span></a>            <span class="p">(</span>
</span><span id="LightRAGManager-189"><a href="#LightRAGManager-189"><span class="linenos">189</span></a>                <span class="s2">&quot;lightrag_server&quot;</span><span class="p">,</span>
</span><span id="LightRAGManager-190"><a href="#LightRAGManager-190"><span class="linenos">190</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_server_dir</span><span class="p">,</span>
</span><span id="LightRAGManager-191"><a href="#LightRAGManager-191"><span class="linenos">191</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LIGHTRAG_SERVER_PORT&quot;</span><span class="p">,</span> <span class="mi">9621</span><span class="p">),</span>
</span><span id="LightRAGManager-192"><a href="#LightRAGManager-192"><span class="linenos">192</span></a>            <span class="p">),</span>
</span><span id="LightRAGManager-193"><a href="#LightRAGManager-193"><span class="linenos">193</span></a>            <span class="p">(</span>
</span><span id="LightRAGManager-194"><a href="#LightRAGManager-194"><span class="linenos">194</span></a>                <span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">,</span>
</span><span id="LightRAGManager-195"><a href="#LightRAGManager-195"><span class="linenos">195</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_dir</span><span class="p">,</span>
</span><span id="LightRAGManager-196"><a href="#LightRAGManager-196"><span class="linenos">196</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LIGHTRAG_MEMORY_PORT&quot;</span><span class="p">,</span> <span class="mi">9622</span><span class="p">),</span>
</span><span id="LightRAGManager-197"><a href="#LightRAGManager-197"><span class="linenos">197</span></a>            <span class="p">),</span>
</span><span id="LightRAGManager-198"><a href="#LightRAGManager-198"><span class="linenos">198</span></a>        <span class="p">]</span>
</span><span id="LightRAGManager-199"><a href="#LightRAGManager-199"><span class="linenos">199</span></a>
</span><span id="LightRAGManager-200"><a href="#LightRAGManager-200"><span class="linenos">200</span></a>        <span class="c1"># Step 1: Smart stop all services</span>
</span><span id="LightRAGManager-201"><a href="#LightRAGManager-201"><span class="linenos">201</span></a>        <span class="k">for</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
</span><span id="LightRAGManager-202"><a href="#LightRAGManager-202"><span class="linenos">202</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager-203"><a href="#LightRAGManager-203"><span class="linenos">203</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-204"><a href="#LightRAGManager-204"><span class="linenos">204</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager-205"><a href="#LightRAGManager-205"><span class="linenos">205</span></a>
</span><span id="LightRAGManager-206"><a href="#LightRAGManager-206"><span class="linenos">206</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-207"><a href="#LightRAGManager-207"><span class="linenos">207</span></a>                <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="LightRAGManager-208"><a href="#LightRAGManager-208"><span class="linenos">208</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
</span><span id="LightRAGManager-209"><a href="#LightRAGManager-209"><span class="linenos">209</span></a>
</span><span id="LightRAGManager-210"><a href="#LightRAGManager-210"><span class="linenos">210</span></a>                <span class="c1"># Graceful shutdown</span>
</span><span id="LightRAGManager-211"><a href="#LightRAGManager-211"><span class="linenos">211</span></a>                <span class="n">stop_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager-212"><a href="#LightRAGManager-212"><span class="linenos">212</span></a>                    <span class="p">[</span><span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span> <span class="s2">&quot;down&quot;</span><span class="p">],</span>
</span><span id="LightRAGManager-213"><a href="#LightRAGManager-213"><span class="linenos">213</span></a>                    <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-214"><a href="#LightRAGManager-214"><span class="linenos">214</span></a>                    <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-215"><a href="#LightRAGManager-215"><span class="linenos">215</span></a>                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
</span><span id="LightRAGManager-216"><a href="#LightRAGManager-216"><span class="linenos">216</span></a>                <span class="p">)</span>
</span><span id="LightRAGManager-217"><a href="#LightRAGManager-217"><span class="linenos">217</span></a>
</span><span id="LightRAGManager-218"><a href="#LightRAGManager-218"><span class="linenos">218</span></a>                <span class="k">if</span> <span class="n">stop_result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightRAGManager-219"><a href="#LightRAGManager-219"><span class="linenos">219</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager-220"><a href="#LightRAGManager-220"><span class="linenos">220</span></a>                        <span class="sa">f</span><span class="s2">&quot;Failed to stop </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stop_result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager-221"><a href="#LightRAGManager-221"><span class="linenos">221</span></a>                    <span class="p">)</span>
</span><span id="LightRAGManager-222"><a href="#LightRAGManager-222"><span class="linenos">222</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-223"><a href="#LightRAGManager-223"><span class="linenos">223</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager-224"><a href="#LightRAGManager-224"><span class="linenos">224</span></a>                    <span class="c1"># Wait for port to be released</span>
</span><span id="LightRAGManager-225"><a href="#LightRAGManager-225"><span class="linenos">225</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_port_release</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="LightRAGManager-226"><a href="#LightRAGManager-226"><span class="linenos">226</span></a>
</span><span id="LightRAGManager-227"><a href="#LightRAGManager-227"><span class="linenos">227</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager-228"><a href="#LightRAGManager-228"><span class="linenos">228</span></a>
</span><span id="LightRAGManager-229"><a href="#LightRAGManager-229"><span class="linenos">229</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager-230"><a href="#LightRAGManager-230"><span class="linenos">230</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error stopping </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-231"><a href="#LightRAGManager-231"><span class="linenos">231</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-232"><a href="#LightRAGManager-232"><span class="linenos">232</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="LightRAGManager-233"><a href="#LightRAGManager-233"><span class="linenos">233</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-234"><a href="#LightRAGManager-234"><span class="linenos">234</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager-235"><a href="#LightRAGManager-235"><span class="linenos">235</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="LightRAGManager-236"><a href="#LightRAGManager-236"><span class="linenos">236</span></a>                    <span class="k">pass</span>
</span><span id="LightRAGManager-237"><a href="#LightRAGManager-237"><span class="linenos">237</span></a>
</span><span id="LightRAGManager-238"><a href="#LightRAGManager-238"><span class="linenos">238</span></a>        <span class="c1"># Step 2: Wait for complete cleanup</span>
</span><span id="LightRAGManager-239"><a href="#LightRAGManager-239"><span class="linenos">239</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="LightRAGManager-240"><a href="#LightRAGManager-240"><span class="linenos">240</span></a>
</span><span id="LightRAGManager-241"><a href="#LightRAGManager-241"><span class="linenos">241</span></a>        <span class="c1"># Step 3: Clean up Docker networks</span>
</span><span id="LightRAGManager-242"><a href="#LightRAGManager-242"><span class="linenos">242</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-243"><a href="#LightRAGManager-243"><span class="linenos">243</span></a>            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager-244"><a href="#LightRAGManager-244"><span class="linenos">244</span></a>                <span class="p">[</span><span class="s2">&quot;docker&quot;</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="s2">&quot;prune&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">],</span>
</span><span id="LightRAGManager-245"><a href="#LightRAGManager-245"><span class="linenos">245</span></a>                <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-246"><a href="#LightRAGManager-246"><span class="linenos">246</span></a>                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-247"><a href="#LightRAGManager-247"><span class="linenos">247</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
</span><span id="LightRAGManager-248"><a href="#LightRAGManager-248"><span class="linenos">248</span></a>            <span class="p">)</span>
</span><span id="LightRAGManager-249"><a href="#LightRAGManager-249"><span class="linenos">249</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LightRAGManager-250"><a href="#LightRAGManager-250"><span class="linenos">250</span></a>            <span class="c1"># Network cleanup is optional</span>
</span><span id="LightRAGManager-251"><a href="#LightRAGManager-251"><span class="linenos">251</span></a>            <span class="k">pass</span>
</span><span id="LightRAGManager-252"><a href="#LightRAGManager-252"><span class="linenos">252</span></a>
</span><span id="LightRAGManager-253"><a href="#LightRAGManager-253"><span class="linenos">253</span></a>        <span class="c1"># Step 4: Smart start all services</span>
</span><span id="LightRAGManager-254"><a href="#LightRAGManager-254"><span class="linenos">254</span></a>        <span class="k">for</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
</span><span id="LightRAGManager-255"><a href="#LightRAGManager-255"><span class="linenos">255</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager-256"><a href="#LightRAGManager-256"><span class="linenos">256</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager-257"><a href="#LightRAGManager-257"><span class="linenos">257</span></a>
</span><span id="LightRAGManager-258"><a href="#LightRAGManager-258"><span class="linenos">258</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-259"><a href="#LightRAGManager-259"><span class="linenos">259</span></a>                <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="LightRAGManager-260"><a href="#LightRAGManager-260"><span class="linenos">260</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
</span><span id="LightRAGManager-261"><a href="#LightRAGManager-261"><span class="linenos">261</span></a>
</span><span id="LightRAGManager-262"><a href="#LightRAGManager-262"><span class="linenos">262</span></a>                <span class="c1"># Verify port is available before starting</span>
</span><span id="LightRAGManager-263"><a href="#LightRAGManager-263"><span class="linenos">263</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_port_available</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
</span><span id="LightRAGManager-264"><a href="#LightRAGManager-264"><span class="linenos">264</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager-265"><a href="#LightRAGManager-265"><span class="linenos">265</span></a>                        <span class="sa">f</span><span class="s2">&quot;Port </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2"> is still in use for </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager-266"><a href="#LightRAGManager-266"><span class="linenos">266</span></a>                    <span class="p">)</span>
</span><span id="LightRAGManager-267"><a href="#LightRAGManager-267"><span class="linenos">267</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-268"><a href="#LightRAGManager-268"><span class="linenos">268</span></a>                    <span class="k">continue</span>
</span><span id="LightRAGManager-269"><a href="#LightRAGManager-269"><span class="linenos">269</span></a>
</span><span id="LightRAGManager-270"><a href="#LightRAGManager-270"><span class="linenos">270</span></a>                <span class="c1"># Start service with retries</span>
</span><span id="LightRAGManager-271"><a href="#LightRAGManager-271"><span class="linenos">271</span></a>                <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="LightRAGManager-272"><a href="#LightRAGManager-272"><span class="linenos">272</span></a>                    <span class="n">start_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager-273"><a href="#LightRAGManager-273"><span class="linenos">273</span></a>                        <span class="p">[</span><span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span> <span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">],</span>
</span><span id="LightRAGManager-274"><a href="#LightRAGManager-274"><span class="linenos">274</span></a>                        <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-275"><a href="#LightRAGManager-275"><span class="linenos">275</span></a>                        <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-276"><a href="#LightRAGManager-276"><span class="linenos">276</span></a>                        <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
</span><span id="LightRAGManager-277"><a href="#LightRAGManager-277"><span class="linenos">277</span></a>                    <span class="p">)</span>
</span><span id="LightRAGManager-278"><a href="#LightRAGManager-278"><span class="linenos">278</span></a>
</span><span id="LightRAGManager-279"><a href="#LightRAGManager-279"><span class="linenos">279</span></a>                    <span class="k">if</span> <span class="n">start_result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightRAGManager-280"><a href="#LightRAGManager-280"><span class="linenos">280</span></a>                        <span class="c1"># Wait for service to initialize</span>
</span><span id="LightRAGManager-281"><a href="#LightRAGManager-281"><span class="linenos">281</span></a>                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="LightRAGManager-282"><a href="#LightRAGManager-282"><span class="linenos">282</span></a>
</span><span id="LightRAGManager-283"><a href="#LightRAGManager-283"><span class="linenos">283</span></a>                        <span class="c1"># Verify container is running</span>
</span><span id="LightRAGManager-284"><a href="#LightRAGManager-284"><span class="linenos">284</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_container_running</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
</span><span id="LightRAGManager-285"><a href="#LightRAGManager-285"><span class="linenos">285</span></a>                            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;services_restarted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
</span><span id="LightRAGManager-286"><a href="#LightRAGManager-286"><span class="linenos">286</span></a>                            <span class="k">break</span>
</span><span id="LightRAGManager-287"><a href="#LightRAGManager-287"><span class="linenos">287</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager-288"><a href="#LightRAGManager-288"><span class="linenos">288</span></a>                            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Not the last attempt</span>
</span><span id="LightRAGManager-289"><a href="#LightRAGManager-289"><span class="linenos">289</span></a>                                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="LightRAGManager-290"><a href="#LightRAGManager-290"><span class="linenos">290</span></a>                                <span class="k">continue</span>
</span><span id="LightRAGManager-291"><a href="#LightRAGManager-291"><span class="linenos">291</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager-292"><a href="#LightRAGManager-292"><span class="linenos">292</span></a>                                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager-293"><a href="#LightRAGManager-293"><span class="linenos">293</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Container for </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2"> failed to start properly&quot;</span>
</span><span id="LightRAGManager-294"><a href="#LightRAGManager-294"><span class="linenos">294</span></a>                                <span class="p">)</span>
</span><span id="LightRAGManager-295"><a href="#LightRAGManager-295"><span class="linenos">295</span></a>                                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-296"><a href="#LightRAGManager-296"><span class="linenos">296</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager-297"><a href="#LightRAGManager-297"><span class="linenos">297</span></a>                        <span class="k">if</span> <span class="s2">&quot;port is already allocated&quot;</span> <span class="ow">in</span> <span class="n">start_result</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="LightRAGManager-298"><a href="#LightRAGManager-298"><span class="linenos">298</span></a>                            <span class="c1"># Port conflict - wait and retry</span>
</span><span id="LightRAGManager-299"><a href="#LightRAGManager-299"><span class="linenos">299</span></a>                            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="LightRAGManager-300"><a href="#LightRAGManager-300"><span class="linenos">300</span></a>                                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="LightRAGManager-301"><a href="#LightRAGManager-301"><span class="linenos">301</span></a>                                <span class="k">continue</span>
</span><span id="LightRAGManager-302"><a href="#LightRAGManager-302"><span class="linenos">302</span></a>
</span><span id="LightRAGManager-303"><a href="#LightRAGManager-303"><span class="linenos">303</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager-304"><a href="#LightRAGManager-304"><span class="linenos">304</span></a>                            <span class="sa">f</span><span class="s2">&quot;Failed to start </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">start_result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager-305"><a href="#LightRAGManager-305"><span class="linenos">305</span></a>                        <span class="p">)</span>
</span><span id="LightRAGManager-306"><a href="#LightRAGManager-306"><span class="linenos">306</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-307"><a href="#LightRAGManager-307"><span class="linenos">307</span></a>                        <span class="k">break</span>
</span><span id="LightRAGManager-308"><a href="#LightRAGManager-308"><span class="linenos">308</span></a>
</span><span id="LightRAGManager-309"><a href="#LightRAGManager-309"><span class="linenos">309</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager-310"><a href="#LightRAGManager-310"><span class="linenos">310</span></a>
</span><span id="LightRAGManager-311"><a href="#LightRAGManager-311"><span class="linenos">311</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager-312"><a href="#LightRAGManager-312"><span class="linenos">312</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error starting </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-313"><a href="#LightRAGManager-313"><span class="linenos">313</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-314"><a href="#LightRAGManager-314"><span class="linenos">314</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="LightRAGManager-315"><a href="#LightRAGManager-315"><span class="linenos">315</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-316"><a href="#LightRAGManager-316"><span class="linenos">316</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager-317"><a href="#LightRAGManager-317"><span class="linenos">317</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="LightRAGManager-318"><a href="#LightRAGManager-318"><span class="linenos">318</span></a>                    <span class="k">pass</span>
</span><span id="LightRAGManager-319"><a href="#LightRAGManager-319"><span class="linenos">319</span></a>
</span><span id="LightRAGManager-320"><a href="#LightRAGManager-320"><span class="linenos">320</span></a>        <span class="c1"># Get final service status</span>
</span><span id="LightRAGManager-321"><a href="#LightRAGManager-321"><span class="linenos">321</span></a>        <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;services_restarted&quot;</span><span class="p">]:</span>
</span><span id="LightRAGManager-322"><a href="#LightRAGManager-322"><span class="linenos">322</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="LightRAGManager-323"><a href="#LightRAGManager-323"><span class="linenos">323</span></a>            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_service_status</span><span class="p">()</span>
</span><span id="LightRAGManager-324"><a href="#LightRAGManager-324"><span class="linenos">324</span></a>
</span><span id="LightRAGManager-325"><a href="#LightRAGManager-325"><span class="linenos">325</span></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="LightRAGManager-326"><a href="#LightRAGManager-326"><span class="linenos">326</span></a>
</span><span id="LightRAGManager-327"><a href="#LightRAGManager-327"><span class="linenos">327</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_port_available</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="LightRAGManager-328"><a href="#LightRAGManager-328"><span class="linenos">328</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a port is available.&quot;&quot;&quot;</span>
</span><span id="LightRAGManager-329"><a href="#LightRAGManager-329"><span class="linenos">329</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
</span><span id="LightRAGManager-330"><a href="#LightRAGManager-330"><span class="linenos">330</span></a>
</span><span id="LightRAGManager-331"><a href="#LightRAGManager-331"><span class="linenos">331</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-332"><a href="#LightRAGManager-332"><span class="linenos">332</span></a>            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
</span><span id="LightRAGManager-333"><a href="#LightRAGManager-333"><span class="linenos">333</span></a>                <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightRAGManager-334"><a href="#LightRAGManager-334"><span class="linenos">334</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span id="LightRAGManager-335"><a href="#LightRAGManager-335"><span class="linenos">335</span></a>                <span class="k">return</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span>  <span class="c1"># Port is available if connection fails</span>
</span><span id="LightRAGManager-336"><a href="#LightRAGManager-336"><span class="linenos">336</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LightRAGManager-337"><a href="#LightRAGManager-337"><span class="linenos">337</span></a>            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Assume available if we can&#39;t check</span>
</span><span id="LightRAGManager-338"><a href="#LightRAGManager-338"><span class="linenos">338</span></a>
</span><span id="LightRAGManager-339"><a href="#LightRAGManager-339"><span class="linenos">339</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for_port_release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="LightRAGManager-340"><a href="#LightRAGManager-340"><span class="linenos">340</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for a port to be released.&quot;&quot;&quot;</span>
</span><span id="LightRAGManager-341"><a href="#LightRAGManager-341"><span class="linenos">341</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
</span><span id="LightRAGManager-342"><a href="#LightRAGManager-342"><span class="linenos">342</span></a>
</span><span id="LightRAGManager-343"><a href="#LightRAGManager-343"><span class="linenos">343</span></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightRAGManager-344"><a href="#LightRAGManager-344"><span class="linenos">344</span></a>
</span><span id="LightRAGManager-345"><a href="#LightRAGManager-345"><span class="linenos">345</span></a>        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
</span><span id="LightRAGManager-346"><a href="#LightRAGManager-346"><span class="linenos">346</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-347"><a href="#LightRAGManager-347"><span class="linenos">347</span></a>                <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
</span><span id="LightRAGManager-348"><a href="#LightRAGManager-348"><span class="linenos">348</span></a>                    <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightRAGManager-349"><a href="#LightRAGManager-349"><span class="linenos">349</span></a>                    <span class="n">result</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span id="LightRAGManager-350"><a href="#LightRAGManager-350"><span class="linenos">350</span></a>                    <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Port is available</span>
</span><span id="LightRAGManager-351"><a href="#LightRAGManager-351"><span class="linenos">351</span></a>                        <span class="k">return</span> <span class="kc">True</span>
</span><span id="LightRAGManager-352"><a href="#LightRAGManager-352"><span class="linenos">352</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LightRAGManager-353"><a href="#LightRAGManager-353"><span class="linenos">353</span></a>                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Assume available if we can&#39;t check</span>
</span><span id="LightRAGManager-354"><a href="#LightRAGManager-354"><span class="linenos">354</span></a>
</span><span id="LightRAGManager-355"><a href="#LightRAGManager-355"><span class="linenos">355</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightRAGManager-356"><a href="#LightRAGManager-356"><span class="linenos">356</span></a>
</span><span id="LightRAGManager-357"><a href="#LightRAGManager-357"><span class="linenos">357</span></a>        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Timeout reached</span>
</span><span id="LightRAGManager-358"><a href="#LightRAGManager-358"><span class="linenos">358</span></a>
</span><span id="LightRAGManager-359"><a href="#LightRAGManager-359"><span class="linenos">359</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_container_running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="LightRAGManager-360"><a href="#LightRAGManager-360"><span class="linenos">360</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a container is running.&quot;&quot;&quot;</span>
</span><span id="LightRAGManager-361"><a href="#LightRAGManager-361"><span class="linenos">361</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-362"><a href="#LightRAGManager-362"><span class="linenos">362</span></a>            <span class="c1"># Map service names to container names</span>
</span><span id="LightRAGManager-363"><a href="#LightRAGManager-363"><span class="linenos">363</span></a>            <span class="n">container_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightRAGManager-364"><a href="#LightRAGManager-364"><span class="linenos">364</span></a>                <span class="s2">&quot;lightrag_server&quot;</span><span class="p">:</span> <span class="s2">&quot;lightrag_pagent&quot;</span><span class="p">,</span>
</span><span id="LightRAGManager-365"><a href="#LightRAGManager-365"><span class="linenos">365</span></a>                <span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">:</span> <span class="s2">&quot;lightrag_memory&quot;</span><span class="p">,</span>
</span><span id="LightRAGManager-366"><a href="#LightRAGManager-366"><span class="linenos">366</span></a>            <span class="p">}</span>
</span><span id="LightRAGManager-367"><a href="#LightRAGManager-367"><span class="linenos">367</span></a>
</span><span id="LightRAGManager-368"><a href="#LightRAGManager-368"><span class="linenos">368</span></a>            <span class="n">container_name</span> <span class="o">=</span> <span class="n">container_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="n">service_name</span><span class="p">)</span>
</span><span id="LightRAGManager-369"><a href="#LightRAGManager-369"><span class="linenos">369</span></a>
</span><span id="LightRAGManager-370"><a href="#LightRAGManager-370"><span class="linenos">370</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager-371"><a href="#LightRAGManager-371"><span class="linenos">371</span></a>                <span class="p">[</span>
</span><span id="LightRAGManager-372"><a href="#LightRAGManager-372"><span class="linenos">372</span></a>                    <span class="s2">&quot;docker&quot;</span><span class="p">,</span>
</span><span id="LightRAGManager-373"><a href="#LightRAGManager-373"><span class="linenos">373</span></a>                    <span class="s2">&quot;ps&quot;</span><span class="p">,</span>
</span><span id="LightRAGManager-374"><a href="#LightRAGManager-374"><span class="linenos">374</span></a>                    <span class="s2">&quot;--filter&quot;</span><span class="p">,</span>
</span><span id="LightRAGManager-375"><a href="#LightRAGManager-375"><span class="linenos">375</span></a>                    <span class="sa">f</span><span class="s2">&quot;name=</span><span class="si">{</span><span class="n">container_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="LightRAGManager-376"><a href="#LightRAGManager-376"><span class="linenos">376</span></a>                    <span class="s2">&quot;--format&quot;</span><span class="p">,</span>
</span><span id="LightRAGManager-377"><a href="#LightRAGManager-377"><span class="linenos">377</span></a>                    <span class="s2">&quot;{{.Names}}&quot;</span><span class="p">,</span>
</span><span id="LightRAGManager-378"><a href="#LightRAGManager-378"><span class="linenos">378</span></a>                <span class="p">],</span>
</span><span id="LightRAGManager-379"><a href="#LightRAGManager-379"><span class="linenos">379</span></a>                <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-380"><a href="#LightRAGManager-380"><span class="linenos">380</span></a>                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-381"><a href="#LightRAGManager-381"><span class="linenos">381</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="LightRAGManager-382"><a href="#LightRAGManager-382"><span class="linenos">382</span></a>            <span class="p">)</span>
</span><span id="LightRAGManager-383"><a href="#LightRAGManager-383"><span class="linenos">383</span></a>
</span><span id="LightRAGManager-384"><a href="#LightRAGManager-384"><span class="linenos">384</span></a>            <span class="k">return</span> <span class="n">container_name</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
</span><span id="LightRAGManager-385"><a href="#LightRAGManager-385"><span class="linenos">385</span></a>
</span><span id="LightRAGManager-386"><a href="#LightRAGManager-386"><span class="linenos">386</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LightRAGManager-387"><a href="#LightRAGManager-387"><span class="linenos">387</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="LightRAGManager-388"><a href="#LightRAGManager-388"><span class="linenos">388</span></a>
</span><span id="LightRAGManager-389"><a href="#LightRAGManager-389"><span class="linenos">389</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_service_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="LightRAGManager-390"><a href="#LightRAGManager-390"><span class="linenos">390</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightRAGManager-391"><a href="#LightRAGManager-391"><span class="linenos">391</span></a><span class="sd">        Get current docker-compose service status.</span>
</span><span id="LightRAGManager-392"><a href="#LightRAGManager-392"><span class="linenos">392</span></a><span class="sd">        Equivalent to: docker-compose ps</span>
</span><span id="LightRAGManager-393"><a href="#LightRAGManager-393"><span class="linenos">393</span></a>
</span><span id="LightRAGManager-394"><a href="#LightRAGManager-394"><span class="linenos">394</span></a><span class="sd">        Returns:</span>
</span><span id="LightRAGManager-395"><a href="#LightRAGManager-395"><span class="linenos">395</span></a><span class="sd">            Dictionary with service status information</span>
</span><span id="LightRAGManager-396"><a href="#LightRAGManager-396"><span class="linenos">396</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightRAGManager-397"><a href="#LightRAGManager-397"><span class="linenos">397</span></a>        <span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightRAGManager-398"><a href="#LightRAGManager-398"><span class="linenos">398</span></a>            <span class="s2">&quot;lightrag_server&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="LightRAGManager-399"><a href="#LightRAGManager-399"><span class="linenos">399</span></a>            <span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="LightRAGManager-400"><a href="#LightRAGManager-400"><span class="linenos">400</span></a>            <span class="s2">&quot;ollama_config&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="LightRAGManager-401"><a href="#LightRAGManager-401"><span class="linenos">401</span></a>        <span class="p">}</span>
</span><span id="LightRAGManager-402"><a href="#LightRAGManager-402"><span class="linenos">402</span></a>
</span><span id="LightRAGManager-403"><a href="#LightRAGManager-403"><span class="linenos">403</span></a>        <span class="c1"># Check status for both directories</span>
</span><span id="LightRAGManager-404"><a href="#LightRAGManager-404"><span class="linenos">404</span></a>        <span class="n">directories</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LightRAGManager-405"><a href="#LightRAGManager-405"><span class="linenos">405</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_server_dir</span><span class="p">),</span>
</span><span id="LightRAGManager-406"><a href="#LightRAGManager-406"><span class="linenos">406</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_dir</span><span class="p">),</span>
</span><span id="LightRAGManager-407"><a href="#LightRAGManager-407"><span class="linenos">407</span></a>        <span class="p">]</span>
</span><span id="LightRAGManager-408"><a href="#LightRAGManager-408"><span class="linenos">408</span></a>
</span><span id="LightRAGManager-409"><a href="#LightRAGManager-409"><span class="linenos">409</span></a>        <span class="k">for</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">dir_path</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
</span><span id="LightRAGManager-410"><a href="#LightRAGManager-410"><span class="linenos">410</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager-411"><a href="#LightRAGManager-411"><span class="linenos">411</span></a>                <span class="n">status</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Directory not found&quot;</span><span class="p">}</span>
</span><span id="LightRAGManager-412"><a href="#LightRAGManager-412"><span class="linenos">412</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager-413"><a href="#LightRAGManager-413"><span class="linenos">413</span></a>
</span><span id="LightRAGManager-414"><a href="#LightRAGManager-414"><span class="linenos">414</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-415"><a href="#LightRAGManager-415"><span class="linenos">415</span></a>                <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="LightRAGManager-416"><a href="#LightRAGManager-416"><span class="linenos">416</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
</span><span id="LightRAGManager-417"><a href="#LightRAGManager-417"><span class="linenos">417</span></a>
</span><span id="LightRAGManager-418"><a href="#LightRAGManager-418"><span class="linenos">418</span></a>                <span class="c1"># Get docker-compose status</span>
</span><span id="LightRAGManager-419"><a href="#LightRAGManager-419"><span class="linenos">419</span></a>                <span class="n">ps_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager-420"><a href="#LightRAGManager-420"><span class="linenos">420</span></a>                    <span class="p">[</span><span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">,</span> <span class="s2">&quot;--format&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">],</span>
</span><span id="LightRAGManager-421"><a href="#LightRAGManager-421"><span class="linenos">421</span></a>                    <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-422"><a href="#LightRAGManager-422"><span class="linenos">422</span></a>                    <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-423"><a href="#LightRAGManager-423"><span class="linenos">423</span></a>                    <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
</span><span id="LightRAGManager-424"><a href="#LightRAGManager-424"><span class="linenos">424</span></a>                <span class="p">)</span>
</span><span id="LightRAGManager-425"><a href="#LightRAGManager-425"><span class="linenos">425</span></a>
</span><span id="LightRAGManager-426"><a href="#LightRAGManager-426"><span class="linenos">426</span></a>                <span class="k">if</span> <span class="n">ps_result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightRAGManager-427"><a href="#LightRAGManager-427"><span class="linenos">427</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-428"><a href="#LightRAGManager-428"><span class="linenos">428</span></a>                        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="LightRAGManager-429"><a href="#LightRAGManager-429"><span class="linenos">429</span></a>
</span><span id="LightRAGManager-430"><a href="#LightRAGManager-430"><span class="linenos">430</span></a>                        <span class="n">services</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightRAGManager-431"><a href="#LightRAGManager-431"><span class="linenos">431</span></a>                            <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ps_result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</span><span id="LightRAGManager-432"><a href="#LightRAGManager-432"><span class="linenos">432</span></a>                            <span class="k">if</span> <span class="n">ps_result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="LightRAGManager-433"><a href="#LightRAGManager-433"><span class="linenos">433</span></a>                            <span class="k">else</span> <span class="p">[]</span>
</span><span id="LightRAGManager-434"><a href="#LightRAGManager-434"><span class="linenos">434</span></a>                        <span class="p">)</span>
</span><span id="LightRAGManager-435"><a href="#LightRAGManager-435"><span class="linenos">435</span></a>                        <span class="n">status</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightRAGManager-436"><a href="#LightRAGManager-436"><span class="linenos">436</span></a>                            <span class="s2">&quot;services&quot;</span><span class="p">:</span> <span class="n">services</span><span class="p">,</span>
</span><span id="LightRAGManager-437"><a href="#LightRAGManager-437"><span class="linenos">437</span></a>                            <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="LightRAGManager-438"><a href="#LightRAGManager-438"><span class="linenos">438</span></a>                                <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">services</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;State&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">]</span>
</span><span id="LightRAGManager-439"><a href="#LightRAGManager-439"><span class="linenos">439</span></a>                            <span class="p">),</span>
</span><span id="LightRAGManager-440"><a href="#LightRAGManager-440"><span class="linenos">440</span></a>                        <span class="p">}</span>
</span><span id="LightRAGManager-441"><a href="#LightRAGManager-441"><span class="linenos">441</span></a>                    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
</span><span id="LightRAGManager-442"><a href="#LightRAGManager-442"><span class="linenos">442</span></a>                        <span class="c1"># Fallback to simple text parsing</span>
</span><span id="LightRAGManager-443"><a href="#LightRAGManager-443"><span class="linenos">443</span></a>                        <span class="n">status</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightRAGManager-444"><a href="#LightRAGManager-444"><span class="linenos">444</span></a>                            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">ps_result</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
</span><span id="LightRAGManager-445"><a href="#LightRAGManager-445"><span class="linenos">445</span></a>                            <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="s2">&quot;running&quot;</span> <span class="ow">in</span> <span class="n">ps_result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
</span><span id="LightRAGManager-446"><a href="#LightRAGManager-446"><span class="linenos">446</span></a>                        <span class="p">}</span>
</span><span id="LightRAGManager-447"><a href="#LightRAGManager-447"><span class="linenos">447</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager-448"><a href="#LightRAGManager-448"><span class="linenos">448</span></a>                    <span class="n">status</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">ps_result</span><span class="o">.</span><span class="n">stderr</span><span class="p">}</span>
</span><span id="LightRAGManager-449"><a href="#LightRAGManager-449"><span class="linenos">449</span></a>
</span><span id="LightRAGManager-450"><a href="#LightRAGManager-450"><span class="linenos">450</span></a>                <span class="c1"># Get Ollama configuration for lightrag_server</span>
</span><span id="LightRAGManager-451"><a href="#LightRAGManager-451"><span class="linenos">451</span></a>                <span class="k">if</span> <span class="n">dir_name</span> <span class="o">==</span> <span class="s2">&quot;lightrag_server&quot;</span><span class="p">:</span>
</span><span id="LightRAGManager-452"><a href="#LightRAGManager-452"><span class="linenos">452</span></a>                    <span class="n">env_file</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">/</span> <span class="s2">&quot;.env&quot;</span>
</span><span id="LightRAGManager-453"><a href="#LightRAGManager-453"><span class="linenos">453</span></a>                    <span class="k">if</span> <span class="n">env_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager-454"><a href="#LightRAGManager-454"><span class="linenos">454</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-455"><a href="#LightRAGManager-455"><span class="linenos">455</span></a>                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager-456"><a href="#LightRAGManager-456"><span class="linenos">456</span></a>                                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager-457"><a href="#LightRAGManager-457"><span class="linenos">457</span></a>                                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;OLLAMA_URL=&quot;</span><span class="p">):</span>
</span><span id="LightRAGManager-458"><a href="#LightRAGManager-458"><span class="linenos">458</span></a>                                        <span class="n">ollama_url</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="LightRAGManager-459"><a href="#LightRAGManager-459"><span class="linenos">459</span></a>                                        <span class="n">status</span><span class="p">[</span><span class="s2">&quot;ollama_config&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ollama_url</span>
</span><span id="LightRAGManager-460"><a href="#LightRAGManager-460"><span class="linenos">460</span></a>
</span><span id="LightRAGManager-461"><a href="#LightRAGManager-461"><span class="linenos">461</span></a>                                        <span class="c1"># Determine mode</span>
</span><span id="LightRAGManager-462"><a href="#LightRAGManager-462"><span class="linenos">462</span></a>                                        <span class="k">if</span> <span class="s2">&quot;host.docker.internal&quot;</span> <span class="ow">in</span> <span class="n">ollama_url</span><span class="p">:</span>
</span><span id="LightRAGManager-463"><a href="#LightRAGManager-463"><span class="linenos">463</span></a>                                            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;ollama_config&quot;</span><span class="p">][</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;LOCAL&quot;</span>
</span><span id="LightRAGManager-464"><a href="#LightRAGManager-464"><span class="linenos">464</span></a>                                        <span class="k">elif</span> <span class="s2">&quot;100.100.248.61&quot;</span> <span class="ow">in</span> <span class="n">ollama_url</span><span class="p">:</span>
</span><span id="LightRAGManager-465"><a href="#LightRAGManager-465"><span class="linenos">465</span></a>                                            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;ollama_config&quot;</span><span class="p">][</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;REMOTE&quot;</span>
</span><span id="LightRAGManager-466"><a href="#LightRAGManager-466"><span class="linenos">466</span></a>                                        <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager-467"><a href="#LightRAGManager-467"><span class="linenos">467</span></a>                                            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;ollama_config&quot;</span><span class="p">][</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CUSTOM&quot;</span>
</span><span id="LightRAGManager-468"><a href="#LightRAGManager-468"><span class="linenos">468</span></a>                                        <span class="k">break</span>
</span><span id="LightRAGManager-469"><a href="#LightRAGManager-469"><span class="linenos">469</span></a>                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager-470"><a href="#LightRAGManager-470"><span class="linenos">470</span></a>                            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;ollama_config&quot;</span><span class="p">][</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="LightRAGManager-471"><a href="#LightRAGManager-471"><span class="linenos">471</span></a>
</span><span id="LightRAGManager-472"><a href="#LightRAGManager-472"><span class="linenos">472</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager-473"><a href="#LightRAGManager-473"><span class="linenos">473</span></a>
</span><span id="LightRAGManager-474"><a href="#LightRAGManager-474"><span class="linenos">474</span></a>            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
</span><span id="LightRAGManager-475"><a href="#LightRAGManager-475"><span class="linenos">475</span></a>                <span class="n">status</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Timeout getting status&quot;</span><span class="p">}</span>
</span><span id="LightRAGManager-476"><a href="#LightRAGManager-476"><span class="linenos">476</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager-477"><a href="#LightRAGManager-477"><span class="linenos">477</span></a>                <span class="n">status</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</span><span id="LightRAGManager-478"><a href="#LightRAGManager-478"><span class="linenos">478</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="LightRAGManager-479"><a href="#LightRAGManager-479"><span class="linenos">479</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-480"><a href="#LightRAGManager-480"><span class="linenos">480</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager-481"><a href="#LightRAGManager-481"><span class="linenos">481</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="LightRAGManager-482"><a href="#LightRAGManager-482"><span class="linenos">482</span></a>                    <span class="k">pass</span>
</span><span id="LightRAGManager-483"><a href="#LightRAGManager-483"><span class="linenos">483</span></a>
</span><span id="LightRAGManager-484"><a href="#LightRAGManager-484"><span class="linenos">484</span></a>        <span class="k">return</span> <span class="n">status</span>
</span><span id="LightRAGManager-485"><a href="#LightRAGManager-485"><span class="linenos">485</span></a>
</span><span id="LightRAGManager-486"><a href="#LightRAGManager-486"><span class="linenos">486</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop_services</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="LightRAGManager-487"><a href="#LightRAGManager-487"><span class="linenos">487</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightRAGManager-488"><a href="#LightRAGManager-488"><span class="linenos">488</span></a><span class="sd">        Stop all LightRAG services.</span>
</span><span id="LightRAGManager-489"><a href="#LightRAGManager-489"><span class="linenos">489</span></a>
</span><span id="LightRAGManager-490"><a href="#LightRAGManager-490"><span class="linenos">490</span></a><span class="sd">        Returns:</span>
</span><span id="LightRAGManager-491"><a href="#LightRAGManager-491"><span class="linenos">491</span></a><span class="sd">            Dictionary with operation results</span>
</span><span id="LightRAGManager-492"><a href="#LightRAGManager-492"><span class="linenos">492</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightRAGManager-493"><a href="#LightRAGManager-493"><span class="linenos">493</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;services_stopped&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="LightRAGManager-494"><a href="#LightRAGManager-494"><span class="linenos">494</span></a>
</span><span id="LightRAGManager-495"><a href="#LightRAGManager-495"><span class="linenos">495</span></a>        <span class="n">directories</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LightRAGManager-496"><a href="#LightRAGManager-496"><span class="linenos">496</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_server_dir</span><span class="p">),</span>
</span><span id="LightRAGManager-497"><a href="#LightRAGManager-497"><span class="linenos">497</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_dir</span><span class="p">),</span>
</span><span id="LightRAGManager-498"><a href="#LightRAGManager-498"><span class="linenos">498</span></a>        <span class="p">]</span>
</span><span id="LightRAGManager-499"><a href="#LightRAGManager-499"><span class="linenos">499</span></a>
</span><span id="LightRAGManager-500"><a href="#LightRAGManager-500"><span class="linenos">500</span></a>        <span class="k">for</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">dir_path</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
</span><span id="LightRAGManager-501"><a href="#LightRAGManager-501"><span class="linenos">501</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager-502"><a href="#LightRAGManager-502"><span class="linenos">502</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager-503"><a href="#LightRAGManager-503"><span class="linenos">503</span></a>
</span><span id="LightRAGManager-504"><a href="#LightRAGManager-504"><span class="linenos">504</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-505"><a href="#LightRAGManager-505"><span class="linenos">505</span></a>                <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="LightRAGManager-506"><a href="#LightRAGManager-506"><span class="linenos">506</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
</span><span id="LightRAGManager-507"><a href="#LightRAGManager-507"><span class="linenos">507</span></a>
</span><span id="LightRAGManager-508"><a href="#LightRAGManager-508"><span class="linenos">508</span></a>                <span class="n">stop_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager-509"><a href="#LightRAGManager-509"><span class="linenos">509</span></a>                    <span class="p">[</span><span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span> <span class="s2">&quot;down&quot;</span><span class="p">],</span>
</span><span id="LightRAGManager-510"><a href="#LightRAGManager-510"><span class="linenos">510</span></a>                    <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-511"><a href="#LightRAGManager-511"><span class="linenos">511</span></a>                    <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-512"><a href="#LightRAGManager-512"><span class="linenos">512</span></a>                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
</span><span id="LightRAGManager-513"><a href="#LightRAGManager-513"><span class="linenos">513</span></a>                <span class="p">)</span>
</span><span id="LightRAGManager-514"><a href="#LightRAGManager-514"><span class="linenos">514</span></a>
</span><span id="LightRAGManager-515"><a href="#LightRAGManager-515"><span class="linenos">515</span></a>                <span class="k">if</span> <span class="n">stop_result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightRAGManager-516"><a href="#LightRAGManager-516"><span class="linenos">516</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;services_stopped&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
</span><span id="LightRAGManager-517"><a href="#LightRAGManager-517"><span class="linenos">517</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager-518"><a href="#LightRAGManager-518"><span class="linenos">518</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager-519"><a href="#LightRAGManager-519"><span class="linenos">519</span></a>                        <span class="sa">f</span><span class="s2">&quot;Failed to stop </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stop_result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager-520"><a href="#LightRAGManager-520"><span class="linenos">520</span></a>                    <span class="p">)</span>
</span><span id="LightRAGManager-521"><a href="#LightRAGManager-521"><span class="linenos">521</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-522"><a href="#LightRAGManager-522"><span class="linenos">522</span></a>
</span><span id="LightRAGManager-523"><a href="#LightRAGManager-523"><span class="linenos">523</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager-524"><a href="#LightRAGManager-524"><span class="linenos">524</span></a>
</span><span id="LightRAGManager-525"><a href="#LightRAGManager-525"><span class="linenos">525</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager-526"><a href="#LightRAGManager-526"><span class="linenos">526</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error stopping </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-527"><a href="#LightRAGManager-527"><span class="linenos">527</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-528"><a href="#LightRAGManager-528"><span class="linenos">528</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="LightRAGManager-529"><a href="#LightRAGManager-529"><span class="linenos">529</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-530"><a href="#LightRAGManager-530"><span class="linenos">530</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager-531"><a href="#LightRAGManager-531"><span class="linenos">531</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="LightRAGManager-532"><a href="#LightRAGManager-532"><span class="linenos">532</span></a>                    <span class="k">pass</span>
</span><span id="LightRAGManager-533"><a href="#LightRAGManager-533"><span class="linenos">533</span></a>
</span><span id="LightRAGManager-534"><a href="#LightRAGManager-534"><span class="linenos">534</span></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="LightRAGManager-535"><a href="#LightRAGManager-535"><span class="linenos">535</span></a>
</span><span id="LightRAGManager-536"><a href="#LightRAGManager-536"><span class="linenos">536</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="LightRAGManager-537"><a href="#LightRAGManager-537"><span class="linenos">537</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightRAGManager-538"><a href="#LightRAGManager-538"><span class="linenos">538</span></a><span class="sd">        Start all LightRAG services.</span>
</span><span id="LightRAGManager-539"><a href="#LightRAGManager-539"><span class="linenos">539</span></a>
</span><span id="LightRAGManager-540"><a href="#LightRAGManager-540"><span class="linenos">540</span></a><span class="sd">        Args:</span>
</span><span id="LightRAGManager-541"><a href="#LightRAGManager-541"><span class="linenos">541</span></a><span class="sd">            user_id: User ID to set before starting (optional)</span>
</span><span id="LightRAGManager-542"><a href="#LightRAGManager-542"><span class="linenos">542</span></a>
</span><span id="LightRAGManager-543"><a href="#LightRAGManager-543"><span class="linenos">543</span></a><span class="sd">        Returns:</span>
</span><span id="LightRAGManager-544"><a href="#LightRAGManager-544"><span class="linenos">544</span></a><span class="sd">            Dictionary with operation results</span>
</span><span id="LightRAGManager-545"><a href="#LightRAGManager-545"><span class="linenos">545</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightRAGManager-546"><a href="#LightRAGManager-546"><span class="linenos">546</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;services_started&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="LightRAGManager-547"><a href="#LightRAGManager-547"><span class="linenos">547</span></a>
</span><span id="LightRAGManager-548"><a href="#LightRAGManager-548"><span class="linenos">548</span></a>        <span class="c1"># Update USER_ID if provided</span>
</span><span id="LightRAGManager-549"><a href="#LightRAGManager-549"><span class="linenos">549</span></a>        <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="LightRAGManager-550"><a href="#LightRAGManager-550"><span class="linenos">550</span></a>            <span class="n">update_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_docker_compose_user_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="LightRAGManager-551"><a href="#LightRAGManager-551"><span class="linenos">551</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">update_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
</span><span id="LightRAGManager-552"><a href="#LightRAGManager-552"><span class="linenos">552</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">update_result</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">])</span>
</span><span id="LightRAGManager-553"><a href="#LightRAGManager-553"><span class="linenos">553</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-554"><a href="#LightRAGManager-554"><span class="linenos">554</span></a>                <span class="k">return</span> <span class="n">results</span>
</span><span id="LightRAGManager-555"><a href="#LightRAGManager-555"><span class="linenos">555</span></a>
</span><span id="LightRAGManager-556"><a href="#LightRAGManager-556"><span class="linenos">556</span></a>        <span class="n">directories</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LightRAGManager-557"><a href="#LightRAGManager-557"><span class="linenos">557</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_server_dir</span><span class="p">),</span>
</span><span id="LightRAGManager-558"><a href="#LightRAGManager-558"><span class="linenos">558</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_dir</span><span class="p">),</span>
</span><span id="LightRAGManager-559"><a href="#LightRAGManager-559"><span class="linenos">559</span></a>        <span class="p">]</span>
</span><span id="LightRAGManager-560"><a href="#LightRAGManager-560"><span class="linenos">560</span></a>
</span><span id="LightRAGManager-561"><a href="#LightRAGManager-561"><span class="linenos">561</span></a>        <span class="k">for</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">dir_path</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
</span><span id="LightRAGManager-562"><a href="#LightRAGManager-562"><span class="linenos">562</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager-563"><a href="#LightRAGManager-563"><span class="linenos">563</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager-564"><a href="#LightRAGManager-564"><span class="linenos">564</span></a>
</span><span id="LightRAGManager-565"><a href="#LightRAGManager-565"><span class="linenos">565</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-566"><a href="#LightRAGManager-566"><span class="linenos">566</span></a>                <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="LightRAGManager-567"><a href="#LightRAGManager-567"><span class="linenos">567</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
</span><span id="LightRAGManager-568"><a href="#LightRAGManager-568"><span class="linenos">568</span></a>
</span><span id="LightRAGManager-569"><a href="#LightRAGManager-569"><span class="linenos">569</span></a>                <span class="n">start_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager-570"><a href="#LightRAGManager-570"><span class="linenos">570</span></a>                    <span class="p">[</span><span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span> <span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">],</span>
</span><span id="LightRAGManager-571"><a href="#LightRAGManager-571"><span class="linenos">571</span></a>                    <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-572"><a href="#LightRAGManager-572"><span class="linenos">572</span></a>                    <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager-573"><a href="#LightRAGManager-573"><span class="linenos">573</span></a>                    <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
</span><span id="LightRAGManager-574"><a href="#LightRAGManager-574"><span class="linenos">574</span></a>                <span class="p">)</span>
</span><span id="LightRAGManager-575"><a href="#LightRAGManager-575"><span class="linenos">575</span></a>
</span><span id="LightRAGManager-576"><a href="#LightRAGManager-576"><span class="linenos">576</span></a>                <span class="k">if</span> <span class="n">start_result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightRAGManager-577"><a href="#LightRAGManager-577"><span class="linenos">577</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;services_started&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
</span><span id="LightRAGManager-578"><a href="#LightRAGManager-578"><span class="linenos">578</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager-579"><a href="#LightRAGManager-579"><span class="linenos">579</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager-580"><a href="#LightRAGManager-580"><span class="linenos">580</span></a>                        <span class="sa">f</span><span class="s2">&quot;Failed to start </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">start_result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager-581"><a href="#LightRAGManager-581"><span class="linenos">581</span></a>                    <span class="p">)</span>
</span><span id="LightRAGManager-582"><a href="#LightRAGManager-582"><span class="linenos">582</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-583"><a href="#LightRAGManager-583"><span class="linenos">583</span></a>
</span><span id="LightRAGManager-584"><a href="#LightRAGManager-584"><span class="linenos">584</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager-585"><a href="#LightRAGManager-585"><span class="linenos">585</span></a>
</span><span id="LightRAGManager-586"><a href="#LightRAGManager-586"><span class="linenos">586</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager-587"><a href="#LightRAGManager-587"><span class="linenos">587</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error starting </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager-588"><a href="#LightRAGManager-588"><span class="linenos">588</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager-589"><a href="#LightRAGManager-589"><span class="linenos">589</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="LightRAGManager-590"><a href="#LightRAGManager-590"><span class="linenos">590</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager-591"><a href="#LightRAGManager-591"><span class="linenos">591</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager-592"><a href="#LightRAGManager-592"><span class="linenos">592</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="LightRAGManager-593"><a href="#LightRAGManager-593"><span class="linenos">593</span></a>                    <span class="k">pass</span>
</span><span id="LightRAGManager-594"><a href="#LightRAGManager-594"><span class="linenos">594</span></a>
</span><span id="LightRAGManager-595"><a href="#LightRAGManager-595"><span class="linenos">595</span></a>        <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Manages LightRAG Docker services with Python implementation of restart-lightrag.sh.</p>
</div>


                            <div id="LightRAGManager.__init__" class="classattr">
                                        <input id="LightRAGManager.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LightRAGManager</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">project_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="LightRAGManager.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightRAGManager.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightRAGManager.__init__-19"><a href="#LightRAGManager.__init__-19"><span class="linenos">19</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="LightRAGManager.__init__-20"><a href="#LightRAGManager.__init__-20"><span class="linenos">20</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightRAGManager.__init__-21"><a href="#LightRAGManager.__init__-21"><span class="linenos">21</span></a><span class="sd">        Initialize the LightRAG manager.</span>
</span><span id="LightRAGManager.__init__-22"><a href="#LightRAGManager.__init__-22"><span class="linenos">22</span></a>
</span><span id="LightRAGManager.__init__-23"><a href="#LightRAGManager.__init__-23"><span class="linenos">23</span></a><span class="sd">        Args:</span>
</span><span id="LightRAGManager.__init__-24"><a href="#LightRAGManager.__init__-24"><span class="linenos">24</span></a><span class="sd">            project_root: Project root directory (deprecated, now uses PERSAG_HOME)</span>
</span><span id="LightRAGManager.__init__-25"><a href="#LightRAGManager.__init__-25"><span class="linenos">25</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightRAGManager.__init__-26"><a href="#LightRAGManager.__init__-26"><span class="linenos">26</span></a>        <span class="c1"># Import settings to get the correct PERSAG_HOME-based paths</span>
</span><span id="LightRAGManager.__init__-27"><a href="#LightRAGManager.__init__-27"><span class="linenos">27</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="LightRAGManager.__init__-28"><a href="#LightRAGManager.__init__-28"><span class="linenos">28</span></a>            <span class="n">LIGHTRAG_MEMORY_DIR</span><span class="p">,</span>
</span><span id="LightRAGManager.__init__-29"><a href="#LightRAGManager.__init__-29"><span class="linenos">29</span></a>            <span class="n">LIGHTRAG_SERVER_DIR</span><span class="p">,</span>
</span><span id="LightRAGManager.__init__-30"><a href="#LightRAGManager.__init__-30"><span class="linenos">30</span></a>        <span class="p">)</span>
</span><span id="LightRAGManager.__init__-31"><a href="#LightRAGManager.__init__-31"><span class="linenos">31</span></a>
</span><span id="LightRAGManager.__init__-32"><a href="#LightRAGManager.__init__-32"><span class="linenos">32</span></a>        <span class="c1"># Use the centralized configuration paths from PERSAG_HOME</span>
</span><span id="LightRAGManager.__init__-33"><a href="#LightRAGManager.__init__-33"><span class="linenos">33</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_server_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">LIGHTRAG_SERVER_DIR</span><span class="p">)</span>
</span><span id="LightRAGManager.__init__-34"><a href="#LightRAGManager.__init__-34"><span class="linenos">34</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">LIGHTRAG_MEMORY_DIR</span><span class="p">)</span>
</span><span id="LightRAGManager.__init__-35"><a href="#LightRAGManager.__init__-35"><span class="linenos">35</span></a>
</span><span id="LightRAGManager.__init__-36"><a href="#LightRAGManager.__init__-36"><span class="linenos">36</span></a>        <span class="c1"># Keep project_root for backward compatibility, but it&#39;s no longer used for docker paths</span>
</span><span id="LightRAGManager.__init__-37"><a href="#LightRAGManager.__init__-37"><span class="linenos">37</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_root</span><span class="p">)</span> <span class="k">if</span> <span class="n">project_root</span> <span class="k">else</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the LightRAG manager.</p>

<p>Args:
    project_root: Project root directory (deprecated, now uses PERSAG_HOME)</p>
</div>


                            </div>
                            <div id="LightRAGManager.lightrag_server_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">lightrag_server_dir</span>

        
    </div>
    <a class="headerlink" href="#LightRAGManager.lightrag_server_dir"></a>
    
    

                            </div>
                            <div id="LightRAGManager.lightrag_memory_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">lightrag_memory_dir</span>

        
    </div>
    <a class="headerlink" href="#LightRAGManager.lightrag_memory_dir"></a>
    
    

                            </div>
                            <div id="LightRAGManager.project_root" class="classattr">
                                <div class="attr variable">
            <span class="name">project_root</span>

        
    </div>
    <a class="headerlink" href="#LightRAGManager.project_root"></a>
    
    

                            </div>
                            <div id="LightRAGManager.update_docker_compose_user_id" class="classattr">
                                        <input id="LightRAGManager.update_docker_compose_user_id-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_docker_compose_user_id</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LightRAGManager.update_docker_compose_user_id-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightRAGManager.update_docker_compose_user_id"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightRAGManager.update_docker_compose_user_id-39"><a href="#LightRAGManager.update_docker_compose_user_id-39"><span class="linenos"> 39</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_docker_compose_user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-40"><a href="#LightRAGManager.update_docker_compose_user_id-40"><span class="linenos"> 40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-41"><a href="#LightRAGManager.update_docker_compose_user_id-41"><span class="linenos"> 41</span></a><span class="sd">        Update USER_ID in docker-compose .env files and docker-compose.yml files.</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-42"><a href="#LightRAGManager.update_docker_compose_user_id-42"><span class="linenos"> 42</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-43"><a href="#LightRAGManager.update_docker_compose_user_id-43"><span class="linenos"> 43</span></a><span class="sd">        Args:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-44"><a href="#LightRAGManager.update_docker_compose_user_id-44"><span class="linenos"> 44</span></a><span class="sd">            user_id: User ID to set in environment files</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-45"><a href="#LightRAGManager.update_docker_compose_user_id-45"><span class="linenos"> 45</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-46"><a href="#LightRAGManager.update_docker_compose_user_id-46"><span class="linenos"> 46</span></a><span class="sd">        Returns:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-47"><a href="#LightRAGManager.update_docker_compose_user_id-47"><span class="linenos"> 47</span></a><span class="sd">            Dictionary with operation results</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-48"><a href="#LightRAGManager.update_docker_compose_user_id-48"><span class="linenos"> 48</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-49"><a href="#LightRAGManager.update_docker_compose_user_id-49"><span class="linenos"> 49</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;updated_files&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-50"><a href="#LightRAGManager.update_docker_compose_user_id-50"><span class="linenos"> 50</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-51"><a href="#LightRAGManager.update_docker_compose_user_id-51"><span class="linenos"> 51</span></a>        <span class="c1"># List of directories to update</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-52"><a href="#LightRAGManager.update_docker_compose_user_id-52"><span class="linenos"> 52</span></a>        <span class="n">directories</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-53"><a href="#LightRAGManager.update_docker_compose_user_id-53"><span class="linenos"> 53</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_server_dir</span><span class="p">),</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-54"><a href="#LightRAGManager.update_docker_compose_user_id-54"><span class="linenos"> 54</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_dir</span><span class="p">),</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-55"><a href="#LightRAGManager.update_docker_compose_user_id-55"><span class="linenos"> 55</span></a>        <span class="p">]</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-56"><a href="#LightRAGManager.update_docker_compose_user_id-56"><span class="linenos"> 56</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-57"><a href="#LightRAGManager.update_docker_compose_user_id-57"><span class="linenos"> 57</span></a>        <span class="k">for</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">dir_path</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-58"><a href="#LightRAGManager.update_docker_compose_user_id-58"><span class="linenos"> 58</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-59"><a href="#LightRAGManager.update_docker_compose_user_id-59"><span class="linenos"> 59</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-60"><a href="#LightRAGManager.update_docker_compose_user_id-60"><span class="linenos"> 60</span></a>                    <span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2"> not found at </span><span class="si">{</span><span class="n">dir_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-61"><a href="#LightRAGManager.update_docker_compose_user_id-61"><span class="linenos"> 61</span></a>                <span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-62"><a href="#LightRAGManager.update_docker_compose_user_id-62"><span class="linenos"> 62</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-63"><a href="#LightRAGManager.update_docker_compose_user_id-63"><span class="linenos"> 63</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-64"><a href="#LightRAGManager.update_docker_compose_user_id-64"><span class="linenos"> 64</span></a>            <span class="c1"># Update .env file</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-65"><a href="#LightRAGManager.update_docker_compose_user_id-65"><span class="linenos"> 65</span></a>            <span class="n">env_file</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">/</span> <span class="s2">&quot;.env&quot;</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-66"><a href="#LightRAGManager.update_docker_compose_user_id-66"><span class="linenos"> 66</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-67"><a href="#LightRAGManager.update_docker_compose_user_id-67"><span class="linenos"> 67</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-68"><a href="#LightRAGManager.update_docker_compose_user_id-68"><span class="linenos"> 68</span></a>                <span class="c1"># Read existing .env file or create new one</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-69"><a href="#LightRAGManager.update_docker_compose_user_id-69"><span class="linenos"> 69</span></a>                <span class="n">env_lines</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-70"><a href="#LightRAGManager.update_docker_compose_user_id-70"><span class="linenos"> 70</span></a>                <span class="n">user_id_found</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-71"><a href="#LightRAGManager.update_docker_compose_user_id-71"><span class="linenos"> 71</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-72"><a href="#LightRAGManager.update_docker_compose_user_id-72"><span class="linenos"> 72</span></a>                <span class="k">if</span> <span class="n">env_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-73"><a href="#LightRAGManager.update_docker_compose_user_id-73"><span class="linenos"> 73</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-74"><a href="#LightRAGManager.update_docker_compose_user_id-74"><span class="linenos"> 74</span></a>                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-75"><a href="#LightRAGManager.update_docker_compose_user_id-75"><span class="linenos"> 75</span></a>                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;USER_ID=&quot;</span><span class="p">):</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-76"><a href="#LightRAGManager.update_docker_compose_user_id-76"><span class="linenos"> 76</span></a>                                <span class="n">env_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USER_ID=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-77"><a href="#LightRAGManager.update_docker_compose_user_id-77"><span class="linenos"> 77</span></a>                                <span class="n">user_id_found</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-78"><a href="#LightRAGManager.update_docker_compose_user_id-78"><span class="linenos"> 78</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-79"><a href="#LightRAGManager.update_docker_compose_user_id-79"><span class="linenos"> 79</span></a>                                <span class="n">env_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-80"><a href="#LightRAGManager.update_docker_compose_user_id-80"><span class="linenos"> 80</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-81"><a href="#LightRAGManager.update_docker_compose_user_id-81"><span class="linenos"> 81</span></a>                <span class="c1"># Add USER_ID if not found</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-82"><a href="#LightRAGManager.update_docker_compose_user_id-82"><span class="linenos"> 82</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id_found</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-83"><a href="#LightRAGManager.update_docker_compose_user_id-83"><span class="linenos"> 83</span></a>                    <span class="n">env_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USER_ID=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-84"><a href="#LightRAGManager.update_docker_compose_user_id-84"><span class="linenos"> 84</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-85"><a href="#LightRAGManager.update_docker_compose_user_id-85"><span class="linenos"> 85</span></a>                <span class="c1"># Write updated .env file</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-86"><a href="#LightRAGManager.update_docker_compose_user_id-86"><span class="linenos"> 86</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-87"><a href="#LightRAGManager.update_docker_compose_user_id-87"><span class="linenos"> 87</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">env_lines</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-88"><a href="#LightRAGManager.update_docker_compose_user_id-88"><span class="linenos"> 88</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-89"><a href="#LightRAGManager.update_docker_compose_user_id-89"><span class="linenos"> 89</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;updated_files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">env_file</span><span class="p">))</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-90"><a href="#LightRAGManager.update_docker_compose_user_id-90"><span class="linenos"> 90</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-91"><a href="#LightRAGManager.update_docker_compose_user_id-91"><span class="linenos"> 91</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-92"><a href="#LightRAGManager.update_docker_compose_user_id-92"><span class="linenos"> 92</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating </span><span class="si">{</span><span class="n">env_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-93"><a href="#LightRAGManager.update_docker_compose_user_id-93"><span class="linenos"> 93</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-94"><a href="#LightRAGManager.update_docker_compose_user_id-94"><span class="linenos"> 94</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-95"><a href="#LightRAGManager.update_docker_compose_user_id-95"><span class="linenos"> 95</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-96"><a href="#LightRAGManager.update_docker_compose_user_id-96"><span class="linenos"> 96</span></a>            <span class="c1"># Update docker-compose.yml to ensure USER_ID is passed as environment variable</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-97"><a href="#LightRAGManager.update_docker_compose_user_id-97"><span class="linenos"> 97</span></a>            <span class="n">docker_compose_file</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">/</span> <span class="s2">&quot;docker-compose.yml&quot;</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-98"><a href="#LightRAGManager.update_docker_compose_user_id-98"><span class="linenos"> 98</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-99"><a href="#LightRAGManager.update_docker_compose_user_id-99"><span class="linenos"> 99</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-100"><a href="#LightRAGManager.update_docker_compose_user_id-100"><span class="linenos">100</span></a>                <span class="k">if</span> <span class="n">docker_compose_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-101"><a href="#LightRAGManager.update_docker_compose_user_id-101"><span class="linenos">101</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">docker_compose_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-102"><a href="#LightRAGManager.update_docker_compose_user_id-102"><span class="linenos">102</span></a>                        <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-103"><a href="#LightRAGManager.update_docker_compose_user_id-103"><span class="linenos">103</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-104"><a href="#LightRAGManager.update_docker_compose_user_id-104"><span class="linenos">104</span></a>                    <span class="c1"># Parse and update USER_ID in docker-compose.yml properly</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-105"><a href="#LightRAGManager.update_docker_compose_user_id-105"><span class="linenos">105</span></a>                    <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-106"><a href="#LightRAGManager.update_docker_compose_user_id-106"><span class="linenos">106</span></a>                    <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-107"><a href="#LightRAGManager.update_docker_compose_user_id-107"><span class="linenos">107</span></a>                    <span class="n">in_environment_section</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-108"><a href="#LightRAGManager.update_docker_compose_user_id-108"><span class="linenos">108</span></a>                    <span class="n">user_id_updated</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-109"><a href="#LightRAGManager.update_docker_compose_user_id-109"><span class="linenos">109</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-110"><a href="#LightRAGManager.update_docker_compose_user_id-110"><span class="linenos">110</span></a>                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-111"><a href="#LightRAGManager.update_docker_compose_user_id-111"><span class="linenos">111</span></a>                        <span class="k">if</span> <span class="s2">&quot;environment:&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-112"><a href="#LightRAGManager.update_docker_compose_user_id-112"><span class="linenos">112</span></a>                            <span class="n">in_environment_section</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-113"><a href="#LightRAGManager.update_docker_compose_user_id-113"><span class="linenos">113</span></a>                            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-114"><a href="#LightRAGManager.update_docker_compose_user_id-114"><span class="linenos">114</span></a>                        <span class="k">elif</span> <span class="n">in_environment_section</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-115"><a href="#LightRAGManager.update_docker_compose_user_id-115"><span class="linenos">115</span></a>                            <span class="s2">&quot;- USER_ID=&quot;</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-116"><a href="#LightRAGManager.update_docker_compose_user_id-116"><span class="linenos">116</span></a>                        <span class="p">):</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-117"><a href="#LightRAGManager.update_docker_compose_user_id-117"><span class="linenos">117</span></a>                            <span class="c1"># Replace existing USER_ID line</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-118"><a href="#LightRAGManager.update_docker_compose_user_id-118"><span class="linenos">118</span></a>                            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      - USER_ID=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-119"><a href="#LightRAGManager.update_docker_compose_user_id-119"><span class="linenos">119</span></a>                            <span class="n">user_id_updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-120"><a href="#LightRAGManager.update_docker_compose_user_id-120"><span class="linenos">120</span></a>                        <span class="k">elif</span> <span class="n">in_environment_section</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;      - &quot;</span><span class="p">):</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-121"><a href="#LightRAGManager.update_docker_compose_user_id-121"><span class="linenos">121</span></a>                            <span class="c1"># Other environment variables</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-122"><a href="#LightRAGManager.update_docker_compose_user_id-122"><span class="linenos">122</span></a>                            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-123"><a href="#LightRAGManager.update_docker_compose_user_id-123"><span class="linenos">123</span></a>                        <span class="k">elif</span> <span class="p">(</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-124"><a href="#LightRAGManager.update_docker_compose_user_id-124"><span class="linenos">124</span></a>                            <span class="n">in_environment_section</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-125"><a href="#LightRAGManager.update_docker_compose_user_id-125"><span class="linenos">125</span></a>                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;      &quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-126"><a href="#LightRAGManager.update_docker_compose_user_id-126"><span class="linenos">126</span></a>                            <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-127"><a href="#LightRAGManager.update_docker_compose_user_id-127"><span class="linenos">127</span></a>                        <span class="p">):</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-128"><a href="#LightRAGManager.update_docker_compose_user_id-128"><span class="linenos">128</span></a>                            <span class="c1"># End of environment section</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-129"><a href="#LightRAGManager.update_docker_compose_user_id-129"><span class="linenos">129</span></a>                            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id_updated</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-130"><a href="#LightRAGManager.update_docker_compose_user_id-130"><span class="linenos">130</span></a>                                <span class="c1"># Add USER_ID if it wasn&#39;t found</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-131"><a href="#LightRAGManager.update_docker_compose_user_id-131"><span class="linenos">131</span></a>                                <span class="n">new_lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;      - USER_ID=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-132"><a href="#LightRAGManager.update_docker_compose_user_id-132"><span class="linenos">132</span></a>                            <span class="n">in_environment_section</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-133"><a href="#LightRAGManager.update_docker_compose_user_id-133"><span class="linenos">133</span></a>                            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-134"><a href="#LightRAGManager.update_docker_compose_user_id-134"><span class="linenos">134</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-135"><a href="#LightRAGManager.update_docker_compose_user_id-135"><span class="linenos">135</span></a>                            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-136"><a href="#LightRAGManager.update_docker_compose_user_id-136"><span class="linenos">136</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-137"><a href="#LightRAGManager.update_docker_compose_user_id-137"><span class="linenos">137</span></a>                    <span class="c1"># If we&#39;re still in environment section at end of file and USER_ID wasn&#39;t updated</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-138"><a href="#LightRAGManager.update_docker_compose_user_id-138"><span class="linenos">138</span></a>                    <span class="k">if</span> <span class="n">in_environment_section</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">user_id_updated</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-139"><a href="#LightRAGManager.update_docker_compose_user_id-139"><span class="linenos">139</span></a>                        <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      - USER_ID=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-140"><a href="#LightRAGManager.update_docker_compose_user_id-140"><span class="linenos">140</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-141"><a href="#LightRAGManager.update_docker_compose_user_id-141"><span class="linenos">141</span></a>                    <span class="c1"># Write updated docker-compose.yml</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-142"><a href="#LightRAGManager.update_docker_compose_user_id-142"><span class="linenos">142</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">docker_compose_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-143"><a href="#LightRAGManager.update_docker_compose_user_id-143"><span class="linenos">143</span></a>                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_lines</span><span class="p">))</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-144"><a href="#LightRAGManager.update_docker_compose_user_id-144"><span class="linenos">144</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-145"><a href="#LightRAGManager.update_docker_compose_user_id-145"><span class="linenos">145</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;updated_files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">docker_compose_file</span><span class="p">))</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-146"><a href="#LightRAGManager.update_docker_compose_user_id-146"><span class="linenos">146</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-147"><a href="#LightRAGManager.update_docker_compose_user_id-147"><span class="linenos">147</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-148"><a href="#LightRAGManager.update_docker_compose_user_id-148"><span class="linenos">148</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-149"><a href="#LightRAGManager.update_docker_compose_user_id-149"><span class="linenos">149</span></a>                    <span class="sa">f</span><span class="s2">&quot;Error updating </span><span class="si">{</span><span class="n">docker_compose_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-150"><a href="#LightRAGManager.update_docker_compose_user_id-150"><span class="linenos">150</span></a>                <span class="p">)</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-151"><a href="#LightRAGManager.update_docker_compose_user_id-151"><span class="linenos">151</span></a>                <span class="c1"># Don&#39;t fail the whole operation for docker-compose.yml issues</span>
</span><span id="LightRAGManager.update_docker_compose_user_id-152"><a href="#LightRAGManager.update_docker_compose_user_id-152"><span class="linenos">152</span></a>
</span><span id="LightRAGManager.update_docker_compose_user_id-153"><a href="#LightRAGManager.update_docker_compose_user_id-153"><span class="linenos">153</span></a>        <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Update USER_ID in docker-compose .env files and docker-compose.yml files.</p>

<p>Args:
    user_id: User ID to set in environment files</p>

<p>Returns:
    Dictionary with operation results</p>
</div>


                            </div>
                            <div id="LightRAGManager.restart_lightrag_services" class="classattr">
                                        <input id="LightRAGManager.restart_lightrag_services-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">restart_lightrag_services</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LightRAGManager.restart_lightrag_services-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightRAGManager.restart_lightrag_services"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightRAGManager.restart_lightrag_services-155"><a href="#LightRAGManager.restart_lightrag_services-155"><span class="linenos">155</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">restart_lightrag_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="LightRAGManager.restart_lightrag_services-156"><a href="#LightRAGManager.restart_lightrag_services-156"><span class="linenos">156</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightRAGManager.restart_lightrag_services-157"><a href="#LightRAGManager.restart_lightrag_services-157"><span class="linenos">157</span></a><span class="sd">        Restart LightRAG services with smart restart logic to handle port conflicts.</span>
</span><span id="LightRAGManager.restart_lightrag_services-158"><a href="#LightRAGManager.restart_lightrag_services-158"><span class="linenos">158</span></a><span class="sd">        Implements the same logic as smart-restart-lightrag.sh.</span>
</span><span id="LightRAGManager.restart_lightrag_services-159"><a href="#LightRAGManager.restart_lightrag_services-159"><span class="linenos">159</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-160"><a href="#LightRAGManager.restart_lightrag_services-160"><span class="linenos">160</span></a><span class="sd">        Args:</span>
</span><span id="LightRAGManager.restart_lightrag_services-161"><a href="#LightRAGManager.restart_lightrag_services-161"><span class="linenos">161</span></a><span class="sd">            user_id: User ID to set (optional, uses current USER_ID if not provided)</span>
</span><span id="LightRAGManager.restart_lightrag_services-162"><a href="#LightRAGManager.restart_lightrag_services-162"><span class="linenos">162</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-163"><a href="#LightRAGManager.restart_lightrag_services-163"><span class="linenos">163</span></a><span class="sd">        Returns:</span>
</span><span id="LightRAGManager.restart_lightrag_services-164"><a href="#LightRAGManager.restart_lightrag_services-164"><span class="linenos">164</span></a><span class="sd">            Dictionary with operation results</span>
</span><span id="LightRAGManager.restart_lightrag_services-165"><a href="#LightRAGManager.restart_lightrag_services-165"><span class="linenos">165</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightRAGManager.restart_lightrag_services-166"><a href="#LightRAGManager.restart_lightrag_services-166"><span class="linenos">166</span></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-167"><a href="#LightRAGManager.restart_lightrag_services-167"><span class="linenos">167</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">personal_agent.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_userid</span>
</span><span id="LightRAGManager.restart_lightrag_services-168"><a href="#LightRAGManager.restart_lightrag_services-168"><span class="linenos">168</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-169"><a href="#LightRAGManager.restart_lightrag_services-169"><span class="linenos">169</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_userid</span><span class="p">()</span>
</span><span id="LightRAGManager.restart_lightrag_services-170"><a href="#LightRAGManager.restart_lightrag_services-170"><span class="linenos">170</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-171"><a href="#LightRAGManager.restart_lightrag_services-171"><span class="linenos">171</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightRAGManager.restart_lightrag_services-172"><a href="#LightRAGManager.restart_lightrag_services-172"><span class="linenos">172</span></a>            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-173"><a href="#LightRAGManager.restart_lightrag_services-173"><span class="linenos">173</span></a>            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-174"><a href="#LightRAGManager.restart_lightrag_services-174"><span class="linenos">174</span></a>            <span class="s2">&quot;services_restarted&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="LightRAGManager.restart_lightrag_services-175"><a href="#LightRAGManager.restart_lightrag_services-175"><span class="linenos">175</span></a>            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="LightRAGManager.restart_lightrag_services-176"><a href="#LightRAGManager.restart_lightrag_services-176"><span class="linenos">176</span></a>            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="LightRAGManager.restart_lightrag_services-177"><a href="#LightRAGManager.restart_lightrag_services-177"><span class="linenos">177</span></a>        <span class="p">}</span>
</span><span id="LightRAGManager.restart_lightrag_services-178"><a href="#LightRAGManager.restart_lightrag_services-178"><span class="linenos">178</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-179"><a href="#LightRAGManager.restart_lightrag_services-179"><span class="linenos">179</span></a>        <span class="c1"># Update USER_ID in docker-compose files</span>
</span><span id="LightRAGManager.restart_lightrag_services-180"><a href="#LightRAGManager.restart_lightrag_services-180"><span class="linenos">180</span></a>        <span class="n">update_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_docker_compose_user_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-181"><a href="#LightRAGManager.restart_lightrag_services-181"><span class="linenos">181</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">update_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
</span><span id="LightRAGManager.restart_lightrag_services-182"><a href="#LightRAGManager.restart_lightrag_services-182"><span class="linenos">182</span></a>            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">update_result</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">])</span>
</span><span id="LightRAGManager.restart_lightrag_services-183"><a href="#LightRAGManager.restart_lightrag_services-183"><span class="linenos">183</span></a>            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.restart_lightrag_services-184"><a href="#LightRAGManager.restart_lightrag_services-184"><span class="linenos">184</span></a>            <span class="k">return</span> <span class="n">results</span>
</span><span id="LightRAGManager.restart_lightrag_services-185"><a href="#LightRAGManager.restart_lightrag_services-185"><span class="linenos">185</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-186"><a href="#LightRAGManager.restart_lightrag_services-186"><span class="linenos">186</span></a>        <span class="c1"># Smart restart services with port conflict handling</span>
</span><span id="LightRAGManager.restart_lightrag_services-187"><a href="#LightRAGManager.restart_lightrag_services-187"><span class="linenos">187</span></a>        <span class="n">services</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LightRAGManager.restart_lightrag_services-188"><a href="#LightRAGManager.restart_lightrag_services-188"><span class="linenos">188</span></a>            <span class="p">(</span>
</span><span id="LightRAGManager.restart_lightrag_services-189"><a href="#LightRAGManager.restart_lightrag_services-189"><span class="linenos">189</span></a>                <span class="s2">&quot;lightrag_server&quot;</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-190"><a href="#LightRAGManager.restart_lightrag_services-190"><span class="linenos">190</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_server_dir</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-191"><a href="#LightRAGManager.restart_lightrag_services-191"><span class="linenos">191</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LIGHTRAG_SERVER_PORT&quot;</span><span class="p">,</span> <span class="mi">9621</span><span class="p">),</span>
</span><span id="LightRAGManager.restart_lightrag_services-192"><a href="#LightRAGManager.restart_lightrag_services-192"><span class="linenos">192</span></a>            <span class="p">),</span>
</span><span id="LightRAGManager.restart_lightrag_services-193"><a href="#LightRAGManager.restart_lightrag_services-193"><span class="linenos">193</span></a>            <span class="p">(</span>
</span><span id="LightRAGManager.restart_lightrag_services-194"><a href="#LightRAGManager.restart_lightrag_services-194"><span class="linenos">194</span></a>                <span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-195"><a href="#LightRAGManager.restart_lightrag_services-195"><span class="linenos">195</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_dir</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-196"><a href="#LightRAGManager.restart_lightrag_services-196"><span class="linenos">196</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LIGHTRAG_MEMORY_PORT&quot;</span><span class="p">,</span> <span class="mi">9622</span><span class="p">),</span>
</span><span id="LightRAGManager.restart_lightrag_services-197"><a href="#LightRAGManager.restart_lightrag_services-197"><span class="linenos">197</span></a>            <span class="p">),</span>
</span><span id="LightRAGManager.restart_lightrag_services-198"><a href="#LightRAGManager.restart_lightrag_services-198"><span class="linenos">198</span></a>        <span class="p">]</span>
</span><span id="LightRAGManager.restart_lightrag_services-199"><a href="#LightRAGManager.restart_lightrag_services-199"><span class="linenos">199</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-200"><a href="#LightRAGManager.restart_lightrag_services-200"><span class="linenos">200</span></a>        <span class="c1"># Step 1: Smart stop all services</span>
</span><span id="LightRAGManager.restart_lightrag_services-201"><a href="#LightRAGManager.restart_lightrag_services-201"><span class="linenos">201</span></a>        <span class="k">for</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-202"><a href="#LightRAGManager.restart_lightrag_services-202"><span class="linenos">202</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager.restart_lightrag_services-203"><a href="#LightRAGManager.restart_lightrag_services-203"><span class="linenos">203</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-204"><a href="#LightRAGManager.restart_lightrag_services-204"><span class="linenos">204</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager.restart_lightrag_services-205"><a href="#LightRAGManager.restart_lightrag_services-205"><span class="linenos">205</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-206"><a href="#LightRAGManager.restart_lightrag_services-206"><span class="linenos">206</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-207"><a href="#LightRAGManager.restart_lightrag_services-207"><span class="linenos">207</span></a>                <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="LightRAGManager.restart_lightrag_services-208"><a href="#LightRAGManager.restart_lightrag_services-208"><span class="linenos">208</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-209"><a href="#LightRAGManager.restart_lightrag_services-209"><span class="linenos">209</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-210"><a href="#LightRAGManager.restart_lightrag_services-210"><span class="linenos">210</span></a>                <span class="c1"># Graceful shutdown</span>
</span><span id="LightRAGManager.restart_lightrag_services-211"><a href="#LightRAGManager.restart_lightrag_services-211"><span class="linenos">211</span></a>                <span class="n">stop_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager.restart_lightrag_services-212"><a href="#LightRAGManager.restart_lightrag_services-212"><span class="linenos">212</span></a>                    <span class="p">[</span><span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span> <span class="s2">&quot;down&quot;</span><span class="p">],</span>
</span><span id="LightRAGManager.restart_lightrag_services-213"><a href="#LightRAGManager.restart_lightrag_services-213"><span class="linenos">213</span></a>                    <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-214"><a href="#LightRAGManager.restart_lightrag_services-214"><span class="linenos">214</span></a>                    <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-215"><a href="#LightRAGManager.restart_lightrag_services-215"><span class="linenos">215</span></a>                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-216"><a href="#LightRAGManager.restart_lightrag_services-216"><span class="linenos">216</span></a>                <span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-217"><a href="#LightRAGManager.restart_lightrag_services-217"><span class="linenos">217</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-218"><a href="#LightRAGManager.restart_lightrag_services-218"><span class="linenos">218</span></a>                <span class="k">if</span> <span class="n">stop_result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-219"><a href="#LightRAGManager.restart_lightrag_services-219"><span class="linenos">219</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager.restart_lightrag_services-220"><a href="#LightRAGManager.restart_lightrag_services-220"><span class="linenos">220</span></a>                        <span class="sa">f</span><span class="s2">&quot;Failed to stop </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stop_result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager.restart_lightrag_services-221"><a href="#LightRAGManager.restart_lightrag_services-221"><span class="linenos">221</span></a>                    <span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-222"><a href="#LightRAGManager.restart_lightrag_services-222"><span class="linenos">222</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.restart_lightrag_services-223"><a href="#LightRAGManager.restart_lightrag_services-223"><span class="linenos">223</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-224"><a href="#LightRAGManager.restart_lightrag_services-224"><span class="linenos">224</span></a>                    <span class="c1"># Wait for port to be released</span>
</span><span id="LightRAGManager.restart_lightrag_services-225"><a href="#LightRAGManager.restart_lightrag_services-225"><span class="linenos">225</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_port_release</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-226"><a href="#LightRAGManager.restart_lightrag_services-226"><span class="linenos">226</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-227"><a href="#LightRAGManager.restart_lightrag_services-227"><span class="linenos">227</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-228"><a href="#LightRAGManager.restart_lightrag_services-228"><span class="linenos">228</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-229"><a href="#LightRAGManager.restart_lightrag_services-229"><span class="linenos">229</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-230"><a href="#LightRAGManager.restart_lightrag_services-230"><span class="linenos">230</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error stopping </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-231"><a href="#LightRAGManager.restart_lightrag_services-231"><span class="linenos">231</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.restart_lightrag_services-232"><a href="#LightRAGManager.restart_lightrag_services-232"><span class="linenos">232</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-233"><a href="#LightRAGManager.restart_lightrag_services-233"><span class="linenos">233</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-234"><a href="#LightRAGManager.restart_lightrag_services-234"><span class="linenos">234</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-235"><a href="#LightRAGManager.restart_lightrag_services-235"><span class="linenos">235</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-236"><a href="#LightRAGManager.restart_lightrag_services-236"><span class="linenos">236</span></a>                    <span class="k">pass</span>
</span><span id="LightRAGManager.restart_lightrag_services-237"><a href="#LightRAGManager.restart_lightrag_services-237"><span class="linenos">237</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-238"><a href="#LightRAGManager.restart_lightrag_services-238"><span class="linenos">238</span></a>        <span class="c1"># Step 2: Wait for complete cleanup</span>
</span><span id="LightRAGManager.restart_lightrag_services-239"><a href="#LightRAGManager.restart_lightrag_services-239"><span class="linenos">239</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-240"><a href="#LightRAGManager.restart_lightrag_services-240"><span class="linenos">240</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-241"><a href="#LightRAGManager.restart_lightrag_services-241"><span class="linenos">241</span></a>        <span class="c1"># Step 3: Clean up Docker networks</span>
</span><span id="LightRAGManager.restart_lightrag_services-242"><a href="#LightRAGManager.restart_lightrag_services-242"><span class="linenos">242</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-243"><a href="#LightRAGManager.restart_lightrag_services-243"><span class="linenos">243</span></a>            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager.restart_lightrag_services-244"><a href="#LightRAGManager.restart_lightrag_services-244"><span class="linenos">244</span></a>                <span class="p">[</span><span class="s2">&quot;docker&quot;</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="s2">&quot;prune&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">],</span>
</span><span id="LightRAGManager.restart_lightrag_services-245"><a href="#LightRAGManager.restart_lightrag_services-245"><span class="linenos">245</span></a>                <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-246"><a href="#LightRAGManager.restart_lightrag_services-246"><span class="linenos">246</span></a>                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-247"><a href="#LightRAGManager.restart_lightrag_services-247"><span class="linenos">247</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-248"><a href="#LightRAGManager.restart_lightrag_services-248"><span class="linenos">248</span></a>            <span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-249"><a href="#LightRAGManager.restart_lightrag_services-249"><span class="linenos">249</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-250"><a href="#LightRAGManager.restart_lightrag_services-250"><span class="linenos">250</span></a>            <span class="c1"># Network cleanup is optional</span>
</span><span id="LightRAGManager.restart_lightrag_services-251"><a href="#LightRAGManager.restart_lightrag_services-251"><span class="linenos">251</span></a>            <span class="k">pass</span>
</span><span id="LightRAGManager.restart_lightrag_services-252"><a href="#LightRAGManager.restart_lightrag_services-252"><span class="linenos">252</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-253"><a href="#LightRAGManager.restart_lightrag_services-253"><span class="linenos">253</span></a>        <span class="c1"># Step 4: Smart start all services</span>
</span><span id="LightRAGManager.restart_lightrag_services-254"><a href="#LightRAGManager.restart_lightrag_services-254"><span class="linenos">254</span></a>        <span class="k">for</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-255"><a href="#LightRAGManager.restart_lightrag_services-255"><span class="linenos">255</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager.restart_lightrag_services-256"><a href="#LightRAGManager.restart_lightrag_services-256"><span class="linenos">256</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager.restart_lightrag_services-257"><a href="#LightRAGManager.restart_lightrag_services-257"><span class="linenos">257</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-258"><a href="#LightRAGManager.restart_lightrag_services-258"><span class="linenos">258</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-259"><a href="#LightRAGManager.restart_lightrag_services-259"><span class="linenos">259</span></a>                <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="LightRAGManager.restart_lightrag_services-260"><a href="#LightRAGManager.restart_lightrag_services-260"><span class="linenos">260</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-261"><a href="#LightRAGManager.restart_lightrag_services-261"><span class="linenos">261</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-262"><a href="#LightRAGManager.restart_lightrag_services-262"><span class="linenos">262</span></a>                <span class="c1"># Verify port is available before starting</span>
</span><span id="LightRAGManager.restart_lightrag_services-263"><a href="#LightRAGManager.restart_lightrag_services-263"><span class="linenos">263</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_port_available</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
</span><span id="LightRAGManager.restart_lightrag_services-264"><a href="#LightRAGManager.restart_lightrag_services-264"><span class="linenos">264</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager.restart_lightrag_services-265"><a href="#LightRAGManager.restart_lightrag_services-265"><span class="linenos">265</span></a>                        <span class="sa">f</span><span class="s2">&quot;Port </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2"> is still in use for </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager.restart_lightrag_services-266"><a href="#LightRAGManager.restart_lightrag_services-266"><span class="linenos">266</span></a>                    <span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-267"><a href="#LightRAGManager.restart_lightrag_services-267"><span class="linenos">267</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.restart_lightrag_services-268"><a href="#LightRAGManager.restart_lightrag_services-268"><span class="linenos">268</span></a>                    <span class="k">continue</span>
</span><span id="LightRAGManager.restart_lightrag_services-269"><a href="#LightRAGManager.restart_lightrag_services-269"><span class="linenos">269</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-270"><a href="#LightRAGManager.restart_lightrag_services-270"><span class="linenos">270</span></a>                <span class="c1"># Start service with retries</span>
</span><span id="LightRAGManager.restart_lightrag_services-271"><a href="#LightRAGManager.restart_lightrag_services-271"><span class="linenos">271</span></a>                <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="LightRAGManager.restart_lightrag_services-272"><a href="#LightRAGManager.restart_lightrag_services-272"><span class="linenos">272</span></a>                    <span class="n">start_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager.restart_lightrag_services-273"><a href="#LightRAGManager.restart_lightrag_services-273"><span class="linenos">273</span></a>                        <span class="p">[</span><span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span> <span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">],</span>
</span><span id="LightRAGManager.restart_lightrag_services-274"><a href="#LightRAGManager.restart_lightrag_services-274"><span class="linenos">274</span></a>                        <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-275"><a href="#LightRAGManager.restart_lightrag_services-275"><span class="linenos">275</span></a>                        <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-276"><a href="#LightRAGManager.restart_lightrag_services-276"><span class="linenos">276</span></a>                        <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
</span><span id="LightRAGManager.restart_lightrag_services-277"><a href="#LightRAGManager.restart_lightrag_services-277"><span class="linenos">277</span></a>                    <span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-278"><a href="#LightRAGManager.restart_lightrag_services-278"><span class="linenos">278</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-279"><a href="#LightRAGManager.restart_lightrag_services-279"><span class="linenos">279</span></a>                    <span class="k">if</span> <span class="n">start_result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-280"><a href="#LightRAGManager.restart_lightrag_services-280"><span class="linenos">280</span></a>                        <span class="c1"># Wait for service to initialize</span>
</span><span id="LightRAGManager.restart_lightrag_services-281"><a href="#LightRAGManager.restart_lightrag_services-281"><span class="linenos">281</span></a>                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-282"><a href="#LightRAGManager.restart_lightrag_services-282"><span class="linenos">282</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-283"><a href="#LightRAGManager.restart_lightrag_services-283"><span class="linenos">283</span></a>                        <span class="c1"># Verify container is running</span>
</span><span id="LightRAGManager.restart_lightrag_services-284"><a href="#LightRAGManager.restart_lightrag_services-284"><span class="linenos">284</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_container_running</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
</span><span id="LightRAGManager.restart_lightrag_services-285"><a href="#LightRAGManager.restart_lightrag_services-285"><span class="linenos">285</span></a>                            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;services_restarted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-286"><a href="#LightRAGManager.restart_lightrag_services-286"><span class="linenos">286</span></a>                            <span class="k">break</span>
</span><span id="LightRAGManager.restart_lightrag_services-287"><a href="#LightRAGManager.restart_lightrag_services-287"><span class="linenos">287</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-288"><a href="#LightRAGManager.restart_lightrag_services-288"><span class="linenos">288</span></a>                            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Not the last attempt</span>
</span><span id="LightRAGManager.restart_lightrag_services-289"><a href="#LightRAGManager.restart_lightrag_services-289"><span class="linenos">289</span></a>                                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-290"><a href="#LightRAGManager.restart_lightrag_services-290"><span class="linenos">290</span></a>                                <span class="k">continue</span>
</span><span id="LightRAGManager.restart_lightrag_services-291"><a href="#LightRAGManager.restart_lightrag_services-291"><span class="linenos">291</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-292"><a href="#LightRAGManager.restart_lightrag_services-292"><span class="linenos">292</span></a>                                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager.restart_lightrag_services-293"><a href="#LightRAGManager.restart_lightrag_services-293"><span class="linenos">293</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Container for </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2"> failed to start properly&quot;</span>
</span><span id="LightRAGManager.restart_lightrag_services-294"><a href="#LightRAGManager.restart_lightrag_services-294"><span class="linenos">294</span></a>                                <span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-295"><a href="#LightRAGManager.restart_lightrag_services-295"><span class="linenos">295</span></a>                                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.restart_lightrag_services-296"><a href="#LightRAGManager.restart_lightrag_services-296"><span class="linenos">296</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-297"><a href="#LightRAGManager.restart_lightrag_services-297"><span class="linenos">297</span></a>                        <span class="k">if</span> <span class="s2">&quot;port is already allocated&quot;</span> <span class="ow">in</span> <span class="n">start_result</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="LightRAGManager.restart_lightrag_services-298"><a href="#LightRAGManager.restart_lightrag_services-298"><span class="linenos">298</span></a>                            <span class="c1"># Port conflict - wait and retry</span>
</span><span id="LightRAGManager.restart_lightrag_services-299"><a href="#LightRAGManager.restart_lightrag_services-299"><span class="linenos">299</span></a>                            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-300"><a href="#LightRAGManager.restart_lightrag_services-300"><span class="linenos">300</span></a>                                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-301"><a href="#LightRAGManager.restart_lightrag_services-301"><span class="linenos">301</span></a>                                <span class="k">continue</span>
</span><span id="LightRAGManager.restart_lightrag_services-302"><a href="#LightRAGManager.restart_lightrag_services-302"><span class="linenos">302</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-303"><a href="#LightRAGManager.restart_lightrag_services-303"><span class="linenos">303</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager.restart_lightrag_services-304"><a href="#LightRAGManager.restart_lightrag_services-304"><span class="linenos">304</span></a>                            <span class="sa">f</span><span class="s2">&quot;Failed to start </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">start_result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager.restart_lightrag_services-305"><a href="#LightRAGManager.restart_lightrag_services-305"><span class="linenos">305</span></a>                        <span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-306"><a href="#LightRAGManager.restart_lightrag_services-306"><span class="linenos">306</span></a>                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.restart_lightrag_services-307"><a href="#LightRAGManager.restart_lightrag_services-307"><span class="linenos">307</span></a>                        <span class="k">break</span>
</span><span id="LightRAGManager.restart_lightrag_services-308"><a href="#LightRAGManager.restart_lightrag_services-308"><span class="linenos">308</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-309"><a href="#LightRAGManager.restart_lightrag_services-309"><span class="linenos">309</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-310"><a href="#LightRAGManager.restart_lightrag_services-310"><span class="linenos">310</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-311"><a href="#LightRAGManager.restart_lightrag_services-311"><span class="linenos">311</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-312"><a href="#LightRAGManager.restart_lightrag_services-312"><span class="linenos">312</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error starting </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-313"><a href="#LightRAGManager.restart_lightrag_services-313"><span class="linenos">313</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.restart_lightrag_services-314"><a href="#LightRAGManager.restart_lightrag_services-314"><span class="linenos">314</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-315"><a href="#LightRAGManager.restart_lightrag_services-315"><span class="linenos">315</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-316"><a href="#LightRAGManager.restart_lightrag_services-316"><span class="linenos">316</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-317"><a href="#LightRAGManager.restart_lightrag_services-317"><span class="linenos">317</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="LightRAGManager.restart_lightrag_services-318"><a href="#LightRAGManager.restart_lightrag_services-318"><span class="linenos">318</span></a>                    <span class="k">pass</span>
</span><span id="LightRAGManager.restart_lightrag_services-319"><a href="#LightRAGManager.restart_lightrag_services-319"><span class="linenos">319</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-320"><a href="#LightRAGManager.restart_lightrag_services-320"><span class="linenos">320</span></a>        <span class="c1"># Get final service status</span>
</span><span id="LightRAGManager.restart_lightrag_services-321"><a href="#LightRAGManager.restart_lightrag_services-321"><span class="linenos">321</span></a>        <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;services_restarted&quot;</span><span class="p">]:</span>
</span><span id="LightRAGManager.restart_lightrag_services-322"><a href="#LightRAGManager.restart_lightrag_services-322"><span class="linenos">322</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="LightRAGManager.restart_lightrag_services-323"><a href="#LightRAGManager.restart_lightrag_services-323"><span class="linenos">323</span></a>            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_service_status</span><span class="p">()</span>
</span><span id="LightRAGManager.restart_lightrag_services-324"><a href="#LightRAGManager.restart_lightrag_services-324"><span class="linenos">324</span></a>
</span><span id="LightRAGManager.restart_lightrag_services-325"><a href="#LightRAGManager.restart_lightrag_services-325"><span class="linenos">325</span></a>        <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Restart LightRAG services with smart restart logic to handle port conflicts.
Implements the same logic as smart-restart-lightrag.sh.</p>

<p>Args:
    user_id: User ID to set (optional, uses current USER_ID if not provided)</p>

<p>Returns:
    Dictionary with operation results</p>
</div>


                            </div>
                            <div id="LightRAGManager.get_service_status" class="classattr">
                                        <input id="LightRAGManager.get_service_status-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_service_status</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LightRAGManager.get_service_status-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightRAGManager.get_service_status"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightRAGManager.get_service_status-389"><a href="#LightRAGManager.get_service_status-389"><span class="linenos">389</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_service_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="LightRAGManager.get_service_status-390"><a href="#LightRAGManager.get_service_status-390"><span class="linenos">390</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightRAGManager.get_service_status-391"><a href="#LightRAGManager.get_service_status-391"><span class="linenos">391</span></a><span class="sd">        Get current docker-compose service status.</span>
</span><span id="LightRAGManager.get_service_status-392"><a href="#LightRAGManager.get_service_status-392"><span class="linenos">392</span></a><span class="sd">        Equivalent to: docker-compose ps</span>
</span><span id="LightRAGManager.get_service_status-393"><a href="#LightRAGManager.get_service_status-393"><span class="linenos">393</span></a>
</span><span id="LightRAGManager.get_service_status-394"><a href="#LightRAGManager.get_service_status-394"><span class="linenos">394</span></a><span class="sd">        Returns:</span>
</span><span id="LightRAGManager.get_service_status-395"><a href="#LightRAGManager.get_service_status-395"><span class="linenos">395</span></a><span class="sd">            Dictionary with service status information</span>
</span><span id="LightRAGManager.get_service_status-396"><a href="#LightRAGManager.get_service_status-396"><span class="linenos">396</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightRAGManager.get_service_status-397"><a href="#LightRAGManager.get_service_status-397"><span class="linenos">397</span></a>        <span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightRAGManager.get_service_status-398"><a href="#LightRAGManager.get_service_status-398"><span class="linenos">398</span></a>            <span class="s2">&quot;lightrag_server&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="LightRAGManager.get_service_status-399"><a href="#LightRAGManager.get_service_status-399"><span class="linenos">399</span></a>            <span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="LightRAGManager.get_service_status-400"><a href="#LightRAGManager.get_service_status-400"><span class="linenos">400</span></a>            <span class="s2">&quot;ollama_config&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="LightRAGManager.get_service_status-401"><a href="#LightRAGManager.get_service_status-401"><span class="linenos">401</span></a>        <span class="p">}</span>
</span><span id="LightRAGManager.get_service_status-402"><a href="#LightRAGManager.get_service_status-402"><span class="linenos">402</span></a>
</span><span id="LightRAGManager.get_service_status-403"><a href="#LightRAGManager.get_service_status-403"><span class="linenos">403</span></a>        <span class="c1"># Check status for both directories</span>
</span><span id="LightRAGManager.get_service_status-404"><a href="#LightRAGManager.get_service_status-404"><span class="linenos">404</span></a>        <span class="n">directories</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LightRAGManager.get_service_status-405"><a href="#LightRAGManager.get_service_status-405"><span class="linenos">405</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_server_dir</span><span class="p">),</span>
</span><span id="LightRAGManager.get_service_status-406"><a href="#LightRAGManager.get_service_status-406"><span class="linenos">406</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_dir</span><span class="p">),</span>
</span><span id="LightRAGManager.get_service_status-407"><a href="#LightRAGManager.get_service_status-407"><span class="linenos">407</span></a>        <span class="p">]</span>
</span><span id="LightRAGManager.get_service_status-408"><a href="#LightRAGManager.get_service_status-408"><span class="linenos">408</span></a>
</span><span id="LightRAGManager.get_service_status-409"><a href="#LightRAGManager.get_service_status-409"><span class="linenos">409</span></a>        <span class="k">for</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">dir_path</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-410"><a href="#LightRAGManager.get_service_status-410"><span class="linenos">410</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager.get_service_status-411"><a href="#LightRAGManager.get_service_status-411"><span class="linenos">411</span></a>                <span class="n">status</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Directory not found&quot;</span><span class="p">}</span>
</span><span id="LightRAGManager.get_service_status-412"><a href="#LightRAGManager.get_service_status-412"><span class="linenos">412</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager.get_service_status-413"><a href="#LightRAGManager.get_service_status-413"><span class="linenos">413</span></a>
</span><span id="LightRAGManager.get_service_status-414"><a href="#LightRAGManager.get_service_status-414"><span class="linenos">414</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-415"><a href="#LightRAGManager.get_service_status-415"><span class="linenos">415</span></a>                <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="LightRAGManager.get_service_status-416"><a href="#LightRAGManager.get_service_status-416"><span class="linenos">416</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
</span><span id="LightRAGManager.get_service_status-417"><a href="#LightRAGManager.get_service_status-417"><span class="linenos">417</span></a>
</span><span id="LightRAGManager.get_service_status-418"><a href="#LightRAGManager.get_service_status-418"><span class="linenos">418</span></a>                <span class="c1"># Get docker-compose status</span>
</span><span id="LightRAGManager.get_service_status-419"><a href="#LightRAGManager.get_service_status-419"><span class="linenos">419</span></a>                <span class="n">ps_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager.get_service_status-420"><a href="#LightRAGManager.get_service_status-420"><span class="linenos">420</span></a>                    <span class="p">[</span><span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">,</span> <span class="s2">&quot;--format&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">],</span>
</span><span id="LightRAGManager.get_service_status-421"><a href="#LightRAGManager.get_service_status-421"><span class="linenos">421</span></a>                    <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.get_service_status-422"><a href="#LightRAGManager.get_service_status-422"><span class="linenos">422</span></a>                    <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.get_service_status-423"><a href="#LightRAGManager.get_service_status-423"><span class="linenos">423</span></a>                    <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
</span><span id="LightRAGManager.get_service_status-424"><a href="#LightRAGManager.get_service_status-424"><span class="linenos">424</span></a>                <span class="p">)</span>
</span><span id="LightRAGManager.get_service_status-425"><a href="#LightRAGManager.get_service_status-425"><span class="linenos">425</span></a>
</span><span id="LightRAGManager.get_service_status-426"><a href="#LightRAGManager.get_service_status-426"><span class="linenos">426</span></a>                <span class="k">if</span> <span class="n">ps_result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-427"><a href="#LightRAGManager.get_service_status-427"><span class="linenos">427</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-428"><a href="#LightRAGManager.get_service_status-428"><span class="linenos">428</span></a>                        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="LightRAGManager.get_service_status-429"><a href="#LightRAGManager.get_service_status-429"><span class="linenos">429</span></a>
</span><span id="LightRAGManager.get_service_status-430"><a href="#LightRAGManager.get_service_status-430"><span class="linenos">430</span></a>                        <span class="n">services</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightRAGManager.get_service_status-431"><a href="#LightRAGManager.get_service_status-431"><span class="linenos">431</span></a>                            <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ps_result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</span><span id="LightRAGManager.get_service_status-432"><a href="#LightRAGManager.get_service_status-432"><span class="linenos">432</span></a>                            <span class="k">if</span> <span class="n">ps_result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="LightRAGManager.get_service_status-433"><a href="#LightRAGManager.get_service_status-433"><span class="linenos">433</span></a>                            <span class="k">else</span> <span class="p">[]</span>
</span><span id="LightRAGManager.get_service_status-434"><a href="#LightRAGManager.get_service_status-434"><span class="linenos">434</span></a>                        <span class="p">)</span>
</span><span id="LightRAGManager.get_service_status-435"><a href="#LightRAGManager.get_service_status-435"><span class="linenos">435</span></a>                        <span class="n">status</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightRAGManager.get_service_status-436"><a href="#LightRAGManager.get_service_status-436"><span class="linenos">436</span></a>                            <span class="s2">&quot;services&quot;</span><span class="p">:</span> <span class="n">services</span><span class="p">,</span>
</span><span id="LightRAGManager.get_service_status-437"><a href="#LightRAGManager.get_service_status-437"><span class="linenos">437</span></a>                            <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="LightRAGManager.get_service_status-438"><a href="#LightRAGManager.get_service_status-438"><span class="linenos">438</span></a>                                <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">services</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;State&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">]</span>
</span><span id="LightRAGManager.get_service_status-439"><a href="#LightRAGManager.get_service_status-439"><span class="linenos">439</span></a>                            <span class="p">),</span>
</span><span id="LightRAGManager.get_service_status-440"><a href="#LightRAGManager.get_service_status-440"><span class="linenos">440</span></a>                        <span class="p">}</span>
</span><span id="LightRAGManager.get_service_status-441"><a href="#LightRAGManager.get_service_status-441"><span class="linenos">441</span></a>                    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-442"><a href="#LightRAGManager.get_service_status-442"><span class="linenos">442</span></a>                        <span class="c1"># Fallback to simple text parsing</span>
</span><span id="LightRAGManager.get_service_status-443"><a href="#LightRAGManager.get_service_status-443"><span class="linenos">443</span></a>                        <span class="n">status</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightRAGManager.get_service_status-444"><a href="#LightRAGManager.get_service_status-444"><span class="linenos">444</span></a>                            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">ps_result</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
</span><span id="LightRAGManager.get_service_status-445"><a href="#LightRAGManager.get_service_status-445"><span class="linenos">445</span></a>                            <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="s2">&quot;running&quot;</span> <span class="ow">in</span> <span class="n">ps_result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
</span><span id="LightRAGManager.get_service_status-446"><a href="#LightRAGManager.get_service_status-446"><span class="linenos">446</span></a>                        <span class="p">}</span>
</span><span id="LightRAGManager.get_service_status-447"><a href="#LightRAGManager.get_service_status-447"><span class="linenos">447</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-448"><a href="#LightRAGManager.get_service_status-448"><span class="linenos">448</span></a>                    <span class="n">status</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">ps_result</span><span class="o">.</span><span class="n">stderr</span><span class="p">}</span>
</span><span id="LightRAGManager.get_service_status-449"><a href="#LightRAGManager.get_service_status-449"><span class="linenos">449</span></a>
</span><span id="LightRAGManager.get_service_status-450"><a href="#LightRAGManager.get_service_status-450"><span class="linenos">450</span></a>                <span class="c1"># Get Ollama configuration for lightrag_server</span>
</span><span id="LightRAGManager.get_service_status-451"><a href="#LightRAGManager.get_service_status-451"><span class="linenos">451</span></a>                <span class="k">if</span> <span class="n">dir_name</span> <span class="o">==</span> <span class="s2">&quot;lightrag_server&quot;</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-452"><a href="#LightRAGManager.get_service_status-452"><span class="linenos">452</span></a>                    <span class="n">env_file</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">/</span> <span class="s2">&quot;.env&quot;</span>
</span><span id="LightRAGManager.get_service_status-453"><a href="#LightRAGManager.get_service_status-453"><span class="linenos">453</span></a>                    <span class="k">if</span> <span class="n">env_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager.get_service_status-454"><a href="#LightRAGManager.get_service_status-454"><span class="linenos">454</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-455"><a href="#LightRAGManager.get_service_status-455"><span class="linenos">455</span></a>                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-456"><a href="#LightRAGManager.get_service_status-456"><span class="linenos">456</span></a>                                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-457"><a href="#LightRAGManager.get_service_status-457"><span class="linenos">457</span></a>                                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;OLLAMA_URL=&quot;</span><span class="p">):</span>
</span><span id="LightRAGManager.get_service_status-458"><a href="#LightRAGManager.get_service_status-458"><span class="linenos">458</span></a>                                        <span class="n">ollama_url</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="LightRAGManager.get_service_status-459"><a href="#LightRAGManager.get_service_status-459"><span class="linenos">459</span></a>                                        <span class="n">status</span><span class="p">[</span><span class="s2">&quot;ollama_config&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ollama_url</span>
</span><span id="LightRAGManager.get_service_status-460"><a href="#LightRAGManager.get_service_status-460"><span class="linenos">460</span></a>
</span><span id="LightRAGManager.get_service_status-461"><a href="#LightRAGManager.get_service_status-461"><span class="linenos">461</span></a>                                        <span class="c1"># Determine mode</span>
</span><span id="LightRAGManager.get_service_status-462"><a href="#LightRAGManager.get_service_status-462"><span class="linenos">462</span></a>                                        <span class="k">if</span> <span class="s2">&quot;host.docker.internal&quot;</span> <span class="ow">in</span> <span class="n">ollama_url</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-463"><a href="#LightRAGManager.get_service_status-463"><span class="linenos">463</span></a>                                            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;ollama_config&quot;</span><span class="p">][</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;LOCAL&quot;</span>
</span><span id="LightRAGManager.get_service_status-464"><a href="#LightRAGManager.get_service_status-464"><span class="linenos">464</span></a>                                        <span class="k">elif</span> <span class="s2">&quot;100.100.248.61&quot;</span> <span class="ow">in</span> <span class="n">ollama_url</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-465"><a href="#LightRAGManager.get_service_status-465"><span class="linenos">465</span></a>                                            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;ollama_config&quot;</span><span class="p">][</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;REMOTE&quot;</span>
</span><span id="LightRAGManager.get_service_status-466"><a href="#LightRAGManager.get_service_status-466"><span class="linenos">466</span></a>                                        <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-467"><a href="#LightRAGManager.get_service_status-467"><span class="linenos">467</span></a>                                            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;ollama_config&quot;</span><span class="p">][</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CUSTOM&quot;</span>
</span><span id="LightRAGManager.get_service_status-468"><a href="#LightRAGManager.get_service_status-468"><span class="linenos">468</span></a>                                        <span class="k">break</span>
</span><span id="LightRAGManager.get_service_status-469"><a href="#LightRAGManager.get_service_status-469"><span class="linenos">469</span></a>                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-470"><a href="#LightRAGManager.get_service_status-470"><span class="linenos">470</span></a>                            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;ollama_config&quot;</span><span class="p">][</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="LightRAGManager.get_service_status-471"><a href="#LightRAGManager.get_service_status-471"><span class="linenos">471</span></a>
</span><span id="LightRAGManager.get_service_status-472"><a href="#LightRAGManager.get_service_status-472"><span class="linenos">472</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager.get_service_status-473"><a href="#LightRAGManager.get_service_status-473"><span class="linenos">473</span></a>
</span><span id="LightRAGManager.get_service_status-474"><a href="#LightRAGManager.get_service_status-474"><span class="linenos">474</span></a>            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-475"><a href="#LightRAGManager.get_service_status-475"><span class="linenos">475</span></a>                <span class="n">status</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Timeout getting status&quot;</span><span class="p">}</span>
</span><span id="LightRAGManager.get_service_status-476"><a href="#LightRAGManager.get_service_status-476"><span class="linenos">476</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-477"><a href="#LightRAGManager.get_service_status-477"><span class="linenos">477</span></a>                <span class="n">status</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</span><span id="LightRAGManager.get_service_status-478"><a href="#LightRAGManager.get_service_status-478"><span class="linenos">478</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-479"><a href="#LightRAGManager.get_service_status-479"><span class="linenos">479</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-480"><a href="#LightRAGManager.get_service_status-480"><span class="linenos">480</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager.get_service_status-481"><a href="#LightRAGManager.get_service_status-481"><span class="linenos">481</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="LightRAGManager.get_service_status-482"><a href="#LightRAGManager.get_service_status-482"><span class="linenos">482</span></a>                    <span class="k">pass</span>
</span><span id="LightRAGManager.get_service_status-483"><a href="#LightRAGManager.get_service_status-483"><span class="linenos">483</span></a>
</span><span id="LightRAGManager.get_service_status-484"><a href="#LightRAGManager.get_service_status-484"><span class="linenos">484</span></a>        <span class="k">return</span> <span class="n">status</span>
</span></pre></div>


            <div class="docstring"><p>Get current docker-compose service status.
Equivalent to: docker-compose ps</p>

<p>Returns:
    Dictionary with service status information</p>
</div>


                            </div>
                            <div id="LightRAGManager.stop_services" class="classattr">
                                        <input id="LightRAGManager.stop_services-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stop_services</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LightRAGManager.stop_services-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightRAGManager.stop_services"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightRAGManager.stop_services-486"><a href="#LightRAGManager.stop_services-486"><span class="linenos">486</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop_services</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="LightRAGManager.stop_services-487"><a href="#LightRAGManager.stop_services-487"><span class="linenos">487</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightRAGManager.stop_services-488"><a href="#LightRAGManager.stop_services-488"><span class="linenos">488</span></a><span class="sd">        Stop all LightRAG services.</span>
</span><span id="LightRAGManager.stop_services-489"><a href="#LightRAGManager.stop_services-489"><span class="linenos">489</span></a>
</span><span id="LightRAGManager.stop_services-490"><a href="#LightRAGManager.stop_services-490"><span class="linenos">490</span></a><span class="sd">        Returns:</span>
</span><span id="LightRAGManager.stop_services-491"><a href="#LightRAGManager.stop_services-491"><span class="linenos">491</span></a><span class="sd">            Dictionary with operation results</span>
</span><span id="LightRAGManager.stop_services-492"><a href="#LightRAGManager.stop_services-492"><span class="linenos">492</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightRAGManager.stop_services-493"><a href="#LightRAGManager.stop_services-493"><span class="linenos">493</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;services_stopped&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="LightRAGManager.stop_services-494"><a href="#LightRAGManager.stop_services-494"><span class="linenos">494</span></a>
</span><span id="LightRAGManager.stop_services-495"><a href="#LightRAGManager.stop_services-495"><span class="linenos">495</span></a>        <span class="n">directories</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LightRAGManager.stop_services-496"><a href="#LightRAGManager.stop_services-496"><span class="linenos">496</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_server_dir</span><span class="p">),</span>
</span><span id="LightRAGManager.stop_services-497"><a href="#LightRAGManager.stop_services-497"><span class="linenos">497</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_dir</span><span class="p">),</span>
</span><span id="LightRAGManager.stop_services-498"><a href="#LightRAGManager.stop_services-498"><span class="linenos">498</span></a>        <span class="p">]</span>
</span><span id="LightRAGManager.stop_services-499"><a href="#LightRAGManager.stop_services-499"><span class="linenos">499</span></a>
</span><span id="LightRAGManager.stop_services-500"><a href="#LightRAGManager.stop_services-500"><span class="linenos">500</span></a>        <span class="k">for</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">dir_path</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
</span><span id="LightRAGManager.stop_services-501"><a href="#LightRAGManager.stop_services-501"><span class="linenos">501</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager.stop_services-502"><a href="#LightRAGManager.stop_services-502"><span class="linenos">502</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager.stop_services-503"><a href="#LightRAGManager.stop_services-503"><span class="linenos">503</span></a>
</span><span id="LightRAGManager.stop_services-504"><a href="#LightRAGManager.stop_services-504"><span class="linenos">504</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.stop_services-505"><a href="#LightRAGManager.stop_services-505"><span class="linenos">505</span></a>                <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="LightRAGManager.stop_services-506"><a href="#LightRAGManager.stop_services-506"><span class="linenos">506</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
</span><span id="LightRAGManager.stop_services-507"><a href="#LightRAGManager.stop_services-507"><span class="linenos">507</span></a>
</span><span id="LightRAGManager.stop_services-508"><a href="#LightRAGManager.stop_services-508"><span class="linenos">508</span></a>                <span class="n">stop_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager.stop_services-509"><a href="#LightRAGManager.stop_services-509"><span class="linenos">509</span></a>                    <span class="p">[</span><span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span> <span class="s2">&quot;down&quot;</span><span class="p">],</span>
</span><span id="LightRAGManager.stop_services-510"><a href="#LightRAGManager.stop_services-510"><span class="linenos">510</span></a>                    <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.stop_services-511"><a href="#LightRAGManager.stop_services-511"><span class="linenos">511</span></a>                    <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.stop_services-512"><a href="#LightRAGManager.stop_services-512"><span class="linenos">512</span></a>                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
</span><span id="LightRAGManager.stop_services-513"><a href="#LightRAGManager.stop_services-513"><span class="linenos">513</span></a>                <span class="p">)</span>
</span><span id="LightRAGManager.stop_services-514"><a href="#LightRAGManager.stop_services-514"><span class="linenos">514</span></a>
</span><span id="LightRAGManager.stop_services-515"><a href="#LightRAGManager.stop_services-515"><span class="linenos">515</span></a>                <span class="k">if</span> <span class="n">stop_result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightRAGManager.stop_services-516"><a href="#LightRAGManager.stop_services-516"><span class="linenos">516</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;services_stopped&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
</span><span id="LightRAGManager.stop_services-517"><a href="#LightRAGManager.stop_services-517"><span class="linenos">517</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager.stop_services-518"><a href="#LightRAGManager.stop_services-518"><span class="linenos">518</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager.stop_services-519"><a href="#LightRAGManager.stop_services-519"><span class="linenos">519</span></a>                        <span class="sa">f</span><span class="s2">&quot;Failed to stop </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stop_result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager.stop_services-520"><a href="#LightRAGManager.stop_services-520"><span class="linenos">520</span></a>                    <span class="p">)</span>
</span><span id="LightRAGManager.stop_services-521"><a href="#LightRAGManager.stop_services-521"><span class="linenos">521</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.stop_services-522"><a href="#LightRAGManager.stop_services-522"><span class="linenos">522</span></a>
</span><span id="LightRAGManager.stop_services-523"><a href="#LightRAGManager.stop_services-523"><span class="linenos">523</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager.stop_services-524"><a href="#LightRAGManager.stop_services-524"><span class="linenos">524</span></a>
</span><span id="LightRAGManager.stop_services-525"><a href="#LightRAGManager.stop_services-525"><span class="linenos">525</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager.stop_services-526"><a href="#LightRAGManager.stop_services-526"><span class="linenos">526</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error stopping </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.stop_services-527"><a href="#LightRAGManager.stop_services-527"><span class="linenos">527</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.stop_services-528"><a href="#LightRAGManager.stop_services-528"><span class="linenos">528</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="LightRAGManager.stop_services-529"><a href="#LightRAGManager.stop_services-529"><span class="linenos">529</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.stop_services-530"><a href="#LightRAGManager.stop_services-530"><span class="linenos">530</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager.stop_services-531"><a href="#LightRAGManager.stop_services-531"><span class="linenos">531</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="LightRAGManager.stop_services-532"><a href="#LightRAGManager.stop_services-532"><span class="linenos">532</span></a>                    <span class="k">pass</span>
</span><span id="LightRAGManager.stop_services-533"><a href="#LightRAGManager.stop_services-533"><span class="linenos">533</span></a>
</span><span id="LightRAGManager.stop_services-534"><a href="#LightRAGManager.stop_services-534"><span class="linenos">534</span></a>        <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Stop all LightRAG services.</p>

<p>Returns:
    Dictionary with operation results</p>
</div>


                            </div>
                            <div id="LightRAGManager.start_services" class="classattr">
                                        <input id="LightRAGManager.start_services-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">start_services</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LightRAGManager.start_services-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightRAGManager.start_services"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightRAGManager.start_services-536"><a href="#LightRAGManager.start_services-536"><span class="linenos">536</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="LightRAGManager.start_services-537"><a href="#LightRAGManager.start_services-537"><span class="linenos">537</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightRAGManager.start_services-538"><a href="#LightRAGManager.start_services-538"><span class="linenos">538</span></a><span class="sd">        Start all LightRAG services.</span>
</span><span id="LightRAGManager.start_services-539"><a href="#LightRAGManager.start_services-539"><span class="linenos">539</span></a>
</span><span id="LightRAGManager.start_services-540"><a href="#LightRAGManager.start_services-540"><span class="linenos">540</span></a><span class="sd">        Args:</span>
</span><span id="LightRAGManager.start_services-541"><a href="#LightRAGManager.start_services-541"><span class="linenos">541</span></a><span class="sd">            user_id: User ID to set before starting (optional)</span>
</span><span id="LightRAGManager.start_services-542"><a href="#LightRAGManager.start_services-542"><span class="linenos">542</span></a>
</span><span id="LightRAGManager.start_services-543"><a href="#LightRAGManager.start_services-543"><span class="linenos">543</span></a><span class="sd">        Returns:</span>
</span><span id="LightRAGManager.start_services-544"><a href="#LightRAGManager.start_services-544"><span class="linenos">544</span></a><span class="sd">            Dictionary with operation results</span>
</span><span id="LightRAGManager.start_services-545"><a href="#LightRAGManager.start_services-545"><span class="linenos">545</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightRAGManager.start_services-546"><a href="#LightRAGManager.start_services-546"><span class="linenos">546</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;services_started&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="LightRAGManager.start_services-547"><a href="#LightRAGManager.start_services-547"><span class="linenos">547</span></a>
</span><span id="LightRAGManager.start_services-548"><a href="#LightRAGManager.start_services-548"><span class="linenos">548</span></a>        <span class="c1"># Update USER_ID if provided</span>
</span><span id="LightRAGManager.start_services-549"><a href="#LightRAGManager.start_services-549"><span class="linenos">549</span></a>        <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="LightRAGManager.start_services-550"><a href="#LightRAGManager.start_services-550"><span class="linenos">550</span></a>            <span class="n">update_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_docker_compose_user_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="LightRAGManager.start_services-551"><a href="#LightRAGManager.start_services-551"><span class="linenos">551</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">update_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
</span><span id="LightRAGManager.start_services-552"><a href="#LightRAGManager.start_services-552"><span class="linenos">552</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">update_result</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">])</span>
</span><span id="LightRAGManager.start_services-553"><a href="#LightRAGManager.start_services-553"><span class="linenos">553</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.start_services-554"><a href="#LightRAGManager.start_services-554"><span class="linenos">554</span></a>                <span class="k">return</span> <span class="n">results</span>
</span><span id="LightRAGManager.start_services-555"><a href="#LightRAGManager.start_services-555"><span class="linenos">555</span></a>
</span><span id="LightRAGManager.start_services-556"><a href="#LightRAGManager.start_services-556"><span class="linenos">556</span></a>        <span class="n">directories</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LightRAGManager.start_services-557"><a href="#LightRAGManager.start_services-557"><span class="linenos">557</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_server_dir</span><span class="p">),</span>
</span><span id="LightRAGManager.start_services-558"><a href="#LightRAGManager.start_services-558"><span class="linenos">558</span></a>            <span class="p">(</span><span class="s2">&quot;lightrag_memory_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lightrag_memory_dir</span><span class="p">),</span>
</span><span id="LightRAGManager.start_services-559"><a href="#LightRAGManager.start_services-559"><span class="linenos">559</span></a>        <span class="p">]</span>
</span><span id="LightRAGManager.start_services-560"><a href="#LightRAGManager.start_services-560"><span class="linenos">560</span></a>
</span><span id="LightRAGManager.start_services-561"><a href="#LightRAGManager.start_services-561"><span class="linenos">561</span></a>        <span class="k">for</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">dir_path</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
</span><span id="LightRAGManager.start_services-562"><a href="#LightRAGManager.start_services-562"><span class="linenos">562</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="LightRAGManager.start_services-563"><a href="#LightRAGManager.start_services-563"><span class="linenos">563</span></a>                <span class="k">continue</span>
</span><span id="LightRAGManager.start_services-564"><a href="#LightRAGManager.start_services-564"><span class="linenos">564</span></a>
</span><span id="LightRAGManager.start_services-565"><a href="#LightRAGManager.start_services-565"><span class="linenos">565</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.start_services-566"><a href="#LightRAGManager.start_services-566"><span class="linenos">566</span></a>                <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="LightRAGManager.start_services-567"><a href="#LightRAGManager.start_services-567"><span class="linenos">567</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
</span><span id="LightRAGManager.start_services-568"><a href="#LightRAGManager.start_services-568"><span class="linenos">568</span></a>
</span><span id="LightRAGManager.start_services-569"><a href="#LightRAGManager.start_services-569"><span class="linenos">569</span></a>                <span class="n">start_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LightRAGManager.start_services-570"><a href="#LightRAGManager.start_services-570"><span class="linenos">570</span></a>                    <span class="p">[</span><span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span> <span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">],</span>
</span><span id="LightRAGManager.start_services-571"><a href="#LightRAGManager.start_services-571"><span class="linenos">571</span></a>                    <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.start_services-572"><a href="#LightRAGManager.start_services-572"><span class="linenos">572</span></a>                    <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightRAGManager.start_services-573"><a href="#LightRAGManager.start_services-573"><span class="linenos">573</span></a>                    <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
</span><span id="LightRAGManager.start_services-574"><a href="#LightRAGManager.start_services-574"><span class="linenos">574</span></a>                <span class="p">)</span>
</span><span id="LightRAGManager.start_services-575"><a href="#LightRAGManager.start_services-575"><span class="linenos">575</span></a>
</span><span id="LightRAGManager.start_services-576"><a href="#LightRAGManager.start_services-576"><span class="linenos">576</span></a>                <span class="k">if</span> <span class="n">start_result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightRAGManager.start_services-577"><a href="#LightRAGManager.start_services-577"><span class="linenos">577</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;services_started&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
</span><span id="LightRAGManager.start_services-578"><a href="#LightRAGManager.start_services-578"><span class="linenos">578</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LightRAGManager.start_services-579"><a href="#LightRAGManager.start_services-579"><span class="linenos">579</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LightRAGManager.start_services-580"><a href="#LightRAGManager.start_services-580"><span class="linenos">580</span></a>                        <span class="sa">f</span><span class="s2">&quot;Failed to start </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">start_result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightRAGManager.start_services-581"><a href="#LightRAGManager.start_services-581"><span class="linenos">581</span></a>                    <span class="p">)</span>
</span><span id="LightRAGManager.start_services-582"><a href="#LightRAGManager.start_services-582"><span class="linenos">582</span></a>                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.start_services-583"><a href="#LightRAGManager.start_services-583"><span class="linenos">583</span></a>
</span><span id="LightRAGManager.start_services-584"><a href="#LightRAGManager.start_services-584"><span class="linenos">584</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager.start_services-585"><a href="#LightRAGManager.start_services-585"><span class="linenos">585</span></a>
</span><span id="LightRAGManager.start_services-586"><a href="#LightRAGManager.start_services-586"><span class="linenos">586</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="LightRAGManager.start_services-587"><a href="#LightRAGManager.start_services-587"><span class="linenos">587</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error starting </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightRAGManager.start_services-588"><a href="#LightRAGManager.start_services-588"><span class="linenos">588</span></a>                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightRAGManager.start_services-589"><a href="#LightRAGManager.start_services-589"><span class="linenos">589</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="LightRAGManager.start_services-590"><a href="#LightRAGManager.start_services-590"><span class="linenos">590</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="LightRAGManager.start_services-591"><a href="#LightRAGManager.start_services-591"><span class="linenos">591</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
</span><span id="LightRAGManager.start_services-592"><a href="#LightRAGManager.start_services-592"><span class="linenos">592</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="LightRAGManager.start_services-593"><a href="#LightRAGManager.start_services-593"><span class="linenos">593</span></a>                    <span class="k">pass</span>
</span><span id="LightRAGManager.start_services-594"><a href="#LightRAGManager.start_services-594"><span class="linenos">594</span></a>
</span><span id="LightRAGManager.start_services-595"><a href="#LightRAGManager.start_services-595"><span class="linenos">595</span></a>        <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Start all LightRAG services.</p>

<p>Args:
    user_id: User ID to set before starting (optional)</p>

<p>Returns:
    Dictionary with operation results</p>
</div>


                            </div>
                </section>
                <section id="DockerIntegrationManager">
                            <input id="DockerIntegrationManager-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DockerIntegrationManager</span>:

                <label class="view-source-button" for="DockerIntegrationManager-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DockerIntegrationManager"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DockerIntegrationManager-40"><a href="#DockerIntegrationManager-40"><span class="linenos"> 40</span></a><span class="k">class</span><span class="w"> </span><span class="nc">DockerIntegrationManager</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-41"><a href="#DockerIntegrationManager-41"><span class="linenos"> 41</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages Docker integration for the personal agent system.&quot;&quot;&quot;</span>
</span><span id="DockerIntegrationManager-42"><a href="#DockerIntegrationManager-42"><span class="linenos"> 42</span></a>    
</span><span id="DockerIntegrationManager-43"><a href="#DockerIntegrationManager-43"><span class="linenos"> 43</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="DockerIntegrationManager-44"><a href="#DockerIntegrationManager-44"><span class="linenos"> 44</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Docker integration manager.</span>
</span><span id="DockerIntegrationManager-45"><a href="#DockerIntegrationManager-45"><span class="linenos"> 45</span></a><span class="sd">        </span>
</span><span id="DockerIntegrationManager-46"><a href="#DockerIntegrationManager-46"><span class="linenos"> 46</span></a><span class="sd">        Args:</span>
</span><span id="DockerIntegrationManager-47"><a href="#DockerIntegrationManager-47"><span class="linenos"> 47</span></a><span class="sd">            user_id: User ID to ensure consistency for (defaults to system USER_ID)</span>
</span><span id="DockerIntegrationManager-48"><a href="#DockerIntegrationManager-48"><span class="linenos"> 48</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DockerIntegrationManager-49"><a href="#DockerIntegrationManager-49"><span class="linenos"> 49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span> <span class="ow">or</span> <span class="n">get_userid</span><span class="p">()</span>
</span><span id="DockerIntegrationManager-50"><a href="#DockerIntegrationManager-50"><span class="linenos"> 50</span></a>        
</span><span id="DockerIntegrationManager-51"><a href="#DockerIntegrationManager-51"><span class="linenos"> 51</span></a>        <span class="c1"># Fix: Use the same robust project root detection as DockerUserSync</span>
</span><span id="DockerIntegrationManager-52"><a href="#DockerIntegrationManager-52"><span class="linenos"> 52</span></a>        <span class="n">current_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span><span id="DockerIntegrationManager-53"><a href="#DockerIntegrationManager-53"><span class="linenos"> 53</span></a>        <span class="n">project_root</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DockerIntegrationManager-54"><a href="#DockerIntegrationManager-54"><span class="linenos"> 54</span></a>        
</span><span id="DockerIntegrationManager-55"><a href="#DockerIntegrationManager-55"><span class="linenos"> 55</span></a>        <span class="c1"># Walk up the directory tree looking for project markers</span>
</span><span id="DockerIntegrationManager-56"><a href="#DockerIntegrationManager-56"><span class="linenos"> 56</span></a>        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">current_path</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-57"><a href="#DockerIntegrationManager-57"><span class="linenos"> 57</span></a>            <span class="c1"># Look for common project root indicators</span>
</span><span id="DockerIntegrationManager-58"><a href="#DockerIntegrationManager-58"><span class="linenos"> 58</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">parent</span> <span class="o">/</span> <span class="n">marker</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="DockerIntegrationManager-59"><a href="#DockerIntegrationManager-59"><span class="linenos"> 59</span></a>                <span class="s1">&#39;pyproject.toml&#39;</span><span class="p">,</span> <span class="s1">&#39;setup.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.git&#39;</span><span class="p">,</span>
</span><span id="DockerIntegrationManager-60"><a href="#DockerIntegrationManager-60"><span class="linenos"> 60</span></a>                <span class="s1">&#39;lightrag_server&#39;</span><span class="p">,</span> <span class="s1">&#39;lightrag_memory_server&#39;</span>
</span><span id="DockerIntegrationManager-61"><a href="#DockerIntegrationManager-61"><span class="linenos"> 61</span></a>            <span class="p">]):</span>
</span><span id="DockerIntegrationManager-62"><a href="#DockerIntegrationManager-62"><span class="linenos"> 62</span></a>                <span class="n">project_root</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="DockerIntegrationManager-63"><a href="#DockerIntegrationManager-63"><span class="linenos"> 63</span></a>                <span class="k">break</span>
</span><span id="DockerIntegrationManager-64"><a href="#DockerIntegrationManager-64"><span class="linenos"> 64</span></a>        
</span><span id="DockerIntegrationManager-65"><a href="#DockerIntegrationManager-65"><span class="linenos"> 65</span></a>        <span class="k">if</span> <span class="n">project_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-66"><a href="#DockerIntegrationManager-66"><span class="linenos"> 66</span></a>            <span class="c1"># Fallback to the old method if no markers found</span>
</span><span id="DockerIntegrationManager-67"><a href="#DockerIntegrationManager-67"><span class="linenos"> 67</span></a>            <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span><span id="DockerIntegrationManager-68"><a href="#DockerIntegrationManager-68"><span class="linenos"> 68</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DockerIntegrationManager: Using fallback path detection&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-69"><a href="#DockerIntegrationManager-69"><span class="linenos"> 69</span></a>        
</span><span id="DockerIntegrationManager-70"><a href="#DockerIntegrationManager-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">project_root</span>
</span><span id="DockerIntegrationManager-71"><a href="#DockerIntegrationManager-71"><span class="linenos"> 71</span></a>        
</span><span id="DockerIntegrationManager-72"><a href="#DockerIntegrationManager-72"><span class="linenos"> 72</span></a>        <span class="c1"># Initialize Docker sync manager if available</span>
</span><span id="DockerIntegrationManager-73"><a href="#DockerIntegrationManager-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DockerIntegrationManager-74"><a href="#DockerIntegrationManager-74"><span class="linenos"> 74</span></a>        <span class="k">if</span> <span class="n">DockerUserSync</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-75"><a href="#DockerIntegrationManager-75"><span class="linenos"> 75</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-76"><a href="#DockerIntegrationManager-76"><span class="linenos"> 76</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span> <span class="o">=</span> <span class="n">DockerUserSync</span><span class="p">(</span><span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-77"><a href="#DockerIntegrationManager-77"><span class="linenos"> 77</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Docker sync manager initialized successfully&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-78"><a href="#DockerIntegrationManager-78"><span class="linenos"> 78</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-79"><a href="#DockerIntegrationManager-79"><span class="linenos"> 79</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize Docker sync manager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-80"><a href="#DockerIntegrationManager-80"><span class="linenos"> 80</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-81"><a href="#DockerIntegrationManager-81"><span class="linenos"> 81</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DockerUserSync not available - Docker integration disabled&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-82"><a href="#DockerIntegrationManager-82"><span class="linenos"> 82</span></a>
</span><span id="DockerIntegrationManager-83"><a href="#DockerIntegrationManager-83"><span class="linenos"> 83</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_docker_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="DockerIntegrationManager-84"><a href="#DockerIntegrationManager-84"><span class="linenos"> 84</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if Docker configurations are consistent with system USER_ID.</span>
</span><span id="DockerIntegrationManager-85"><a href="#DockerIntegrationManager-85"><span class="linenos"> 85</span></a><span class="sd">        </span>
</span><span id="DockerIntegrationManager-86"><a href="#DockerIntegrationManager-86"><span class="linenos"> 86</span></a><span class="sd">        Returns:</span>
</span><span id="DockerIntegrationManager-87"><a href="#DockerIntegrationManager-87"><span class="linenos"> 87</span></a><span class="sd">            Tuple of (is_consistent, message)</span>
</span><span id="DockerIntegrationManager-88"><a href="#DockerIntegrationManager-88"><span class="linenos"> 88</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DockerIntegrationManager-89"><a href="#DockerIntegrationManager-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-90"><a href="#DockerIntegrationManager-90"><span class="linenos"> 90</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Docker sync not available - skipping consistency check&quot;</span>
</span><span id="DockerIntegrationManager-91"><a href="#DockerIntegrationManager-91"><span class="linenos"> 91</span></a>        
</span><span id="DockerIntegrationManager-92"><a href="#DockerIntegrationManager-92"><span class="linenos"> 92</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-93"><a href="#DockerIntegrationManager-93"><span class="linenos"> 93</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="o">.</span><span class="n">check_user_id_consistency</span><span class="p">()</span>
</span><span id="DockerIntegrationManager-94"><a href="#DockerIntegrationManager-94"><span class="linenos"> 94</span></a>            <span class="n">all_consistent</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;consistent&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="DockerIntegrationManager-95"><a href="#DockerIntegrationManager-95"><span class="linenos"> 95</span></a>            
</span><span id="DockerIntegrationManager-96"><a href="#DockerIntegrationManager-96"><span class="linenos"> 96</span></a>            <span class="k">if</span> <span class="n">all_consistent</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-97"><a href="#DockerIntegrationManager-97"><span class="linenos"> 97</span></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;All Docker configurations consistent with USER_ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-98"><a href="#DockerIntegrationManager-98"><span class="linenos"> 98</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-99"><a href="#DockerIntegrationManager-99"><span class="linenos"> 99</span></a>                <span class="n">inconsistent_servers</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="DockerIntegrationManager-100"><a href="#DockerIntegrationManager-100"><span class="linenos">100</span></a>                    <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
</span><span id="DockerIntegrationManager-101"><a href="#DockerIntegrationManager-101"><span class="linenos">101</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;consistent&#39;</span><span class="p">]</span>
</span><span id="DockerIntegrationManager-102"><a href="#DockerIntegrationManager-102"><span class="linenos">102</span></a>                <span class="p">]</span>
</span><span id="DockerIntegrationManager-103"><a href="#DockerIntegrationManager-103"><span class="linenos">103</span></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Inconsistent Docker servers: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inconsistent_servers</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-104"><a href="#DockerIntegrationManager-104"><span class="linenos">104</span></a>                
</span><span id="DockerIntegrationManager-105"><a href="#DockerIntegrationManager-105"><span class="linenos">105</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-106"><a href="#DockerIntegrationManager-106"><span class="linenos">106</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking Docker consistency: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-107"><a href="#DockerIntegrationManager-107"><span class="linenos">107</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error checking Docker consistency: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-108"><a href="#DockerIntegrationManager-108"><span class="linenos">108</span></a>
</span><span id="DockerIntegrationManager-109"><a href="#DockerIntegrationManager-109"><span class="linenos">109</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_docker_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_restart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="DockerIntegrationManager-110"><a href="#DockerIntegrationManager-110"><span class="linenos">110</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure Docker configurations are consistent with system USER_ID.</span>
</span><span id="DockerIntegrationManager-111"><a href="#DockerIntegrationManager-111"><span class="linenos">111</span></a><span class="sd">        </span>
</span><span id="DockerIntegrationManager-112"><a href="#DockerIntegrationManager-112"><span class="linenos">112</span></a><span class="sd">        Args:</span>
</span><span id="DockerIntegrationManager-113"><a href="#DockerIntegrationManager-113"><span class="linenos">113</span></a><span class="sd">            force_restart: If True, restart containers even if not running</span>
</span><span id="DockerIntegrationManager-114"><a href="#DockerIntegrationManager-114"><span class="linenos">114</span></a><span class="sd">            </span>
</span><span id="DockerIntegrationManager-115"><a href="#DockerIntegrationManager-115"><span class="linenos">115</span></a><span class="sd">        Returns:</span>
</span><span id="DockerIntegrationManager-116"><a href="#DockerIntegrationManager-116"><span class="linenos">116</span></a><span class="sd">            Tuple of (success, message)</span>
</span><span id="DockerIntegrationManager-117"><a href="#DockerIntegrationManager-117"><span class="linenos">117</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DockerIntegrationManager-118"><a href="#DockerIntegrationManager-118"><span class="linenos">118</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-119"><a href="#DockerIntegrationManager-119"><span class="linenos">119</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Docker sync not available - skipping consistency enforcement&quot;</span>
</span><span id="DockerIntegrationManager-120"><a href="#DockerIntegrationManager-120"><span class="linenos">120</span></a>        
</span><span id="DockerIntegrationManager-121"><a href="#DockerIntegrationManager-121"><span class="linenos">121</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-122"><a href="#DockerIntegrationManager-122"><span class="linenos">122</span></a>            <span class="c1"># First check if sync is needed</span>
</span><span id="DockerIntegrationManager-123"><a href="#DockerIntegrationManager-123"><span class="linenos">123</span></a>            <span class="n">is_consistent</span><span class="p">,</span> <span class="n">check_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_docker_consistency</span><span class="p">()</span>
</span><span id="DockerIntegrationManager-124"><a href="#DockerIntegrationManager-124"><span class="linenos">124</span></a>            
</span><span id="DockerIntegrationManager-125"><a href="#DockerIntegrationManager-125"><span class="linenos">125</span></a>            <span class="k">if</span> <span class="n">is_consistent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_restart</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-126"><a href="#DockerIntegrationManager-126"><span class="linenos">126</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Docker configurations already consistent&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-127"><a href="#DockerIntegrationManager-127"><span class="linenos">127</span></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">check_message</span>
</span><span id="DockerIntegrationManager-128"><a href="#DockerIntegrationManager-128"><span class="linenos">128</span></a>            <span class="k">elif</span> <span class="n">is_consistent</span> <span class="ow">and</span> <span class="n">force_restart</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-129"><a href="#DockerIntegrationManager-129"><span class="linenos">129</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Docker configurations consistent, but force restart requested&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-130"><a href="#DockerIntegrationManager-130"><span class="linenos">130</span></a>                <span class="c1"># Perform synchronization with force restart even if consistent</span>
</span><span id="DockerIntegrationManager-131"><a href="#DockerIntegrationManager-131"><span class="linenos">131</span></a>                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="o">.</span><span class="n">sync_user_ids</span><span class="p">(</span><span class="n">force_restart</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-132"><a href="#DockerIntegrationManager-132"><span class="linenos">132</span></a>                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-133"><a href="#DockerIntegrationManager-133"><span class="linenos">133</span></a>                    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Successfully force restarted Docker containers with USER_ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-134"><a href="#DockerIntegrationManager-134"><span class="linenos">134</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-135"><a href="#DockerIntegrationManager-135"><span class="linenos">135</span></a>                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">message</span>
</span><span id="DockerIntegrationManager-136"><a href="#DockerIntegrationManager-136"><span class="linenos">136</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-137"><a href="#DockerIntegrationManager-137"><span class="linenos">137</span></a>                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Failed to force restart Docker containers&quot;</span>
</span><span id="DockerIntegrationManager-138"><a href="#DockerIntegrationManager-138"><span class="linenos">138</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-139"><a href="#DockerIntegrationManager-139"><span class="linenos">139</span></a>                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">message</span>
</span><span id="DockerIntegrationManager-140"><a href="#DockerIntegrationManager-140"><span class="linenos">140</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-141"><a href="#DockerIntegrationManager-141"><span class="linenos">141</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Docker inconsistency detected: </span><span class="si">{</span><span class="n">check_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-142"><a href="#DockerIntegrationManager-142"><span class="linenos">142</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to synchronize Docker configurations...&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-143"><a href="#DockerIntegrationManager-143"><span class="linenos">143</span></a>                
</span><span id="DockerIntegrationManager-144"><a href="#DockerIntegrationManager-144"><span class="linenos">144</span></a>                <span class="c1"># Perform synchronization</span>
</span><span id="DockerIntegrationManager-145"><a href="#DockerIntegrationManager-145"><span class="linenos">145</span></a>                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="o">.</span><span class="n">sync_user_ids</span><span class="p">(</span><span class="n">force_restart</span><span class="o">=</span><span class="n">force_restart</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-146"><a href="#DockerIntegrationManager-146"><span class="linenos">146</span></a>                
</span><span id="DockerIntegrationManager-147"><a href="#DockerIntegrationManager-147"><span class="linenos">147</span></a>                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-148"><a href="#DockerIntegrationManager-148"><span class="linenos">148</span></a>                    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Successfully synchronized Docker configurations with USER_ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-149"><a href="#DockerIntegrationManager-149"><span class="linenos">149</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-150"><a href="#DockerIntegrationManager-150"><span class="linenos">150</span></a>                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">message</span>
</span><span id="DockerIntegrationManager-151"><a href="#DockerIntegrationManager-151"><span class="linenos">151</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-152"><a href="#DockerIntegrationManager-152"><span class="linenos">152</span></a>                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Failed to synchronize Docker configurations&quot;</span>
</span><span id="DockerIntegrationManager-153"><a href="#DockerIntegrationManager-153"><span class="linenos">153</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-154"><a href="#DockerIntegrationManager-154"><span class="linenos">154</span></a>                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">message</span>
</span><span id="DockerIntegrationManager-155"><a href="#DockerIntegrationManager-155"><span class="linenos">155</span></a>                
</span><span id="DockerIntegrationManager-156"><a href="#DockerIntegrationManager-156"><span class="linenos">156</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-157"><a href="#DockerIntegrationManager-157"><span class="linenos">157</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error ensuring Docker consistency: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-158"><a href="#DockerIntegrationManager-158"><span class="linenos">158</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-159"><a href="#DockerIntegrationManager-159"><span class="linenos">159</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span><span id="DockerIntegrationManager-160"><a href="#DockerIntegrationManager-160"><span class="linenos">160</span></a>
</span><span id="DockerIntegrationManager-161"><a href="#DockerIntegrationManager-161"><span class="linenos">161</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_system_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="DockerIntegrationManager-162"><a href="#DockerIntegrationManager-162"><span class="linenos">162</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform comprehensive validation of system consistency.</span>
</span><span id="DockerIntegrationManager-163"><a href="#DockerIntegrationManager-163"><span class="linenos">163</span></a><span class="sd">        </span>
</span><span id="DockerIntegrationManager-164"><a href="#DockerIntegrationManager-164"><span class="linenos">164</span></a><span class="sd">        Returns:</span>
</span><span id="DockerIntegrationManager-165"><a href="#DockerIntegrationManager-165"><span class="linenos">165</span></a><span class="sd">            Tuple of (is_consistent, message)</span>
</span><span id="DockerIntegrationManager-166"><a href="#DockerIntegrationManager-166"><span class="linenos">166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DockerIntegrationManager-167"><a href="#DockerIntegrationManager-167"><span class="linenos">167</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-168"><a href="#DockerIntegrationManager-168"><span class="linenos">168</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Docker sync not available - skipping validation&quot;</span>
</span><span id="DockerIntegrationManager-169"><a href="#DockerIntegrationManager-169"><span class="linenos">169</span></a>        
</span><span id="DockerIntegrationManager-170"><a href="#DockerIntegrationManager-170"><span class="linenos">170</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-171"><a href="#DockerIntegrationManager-171"><span class="linenos">171</span></a>            <span class="n">is_consistent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="o">.</span><span class="n">validate_system_consistency</span><span class="p">()</span>
</span><span id="DockerIntegrationManager-172"><a href="#DockerIntegrationManager-172"><span class="linenos">172</span></a>            
</span><span id="DockerIntegrationManager-173"><a href="#DockerIntegrationManager-173"><span class="linenos">173</span></a>            <span class="k">if</span> <span class="n">is_consistent</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-174"><a href="#DockerIntegrationManager-174"><span class="linenos">174</span></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;System is fully consistent with USER_ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-175"><a href="#DockerIntegrationManager-175"><span class="linenos">175</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-176"><a href="#DockerIntegrationManager-176"><span class="linenos">176</span></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;System inconsistencies detected - check logs for details&quot;</span>
</span><span id="DockerIntegrationManager-177"><a href="#DockerIntegrationManager-177"><span class="linenos">177</span></a>                
</span><span id="DockerIntegrationManager-178"><a href="#DockerIntegrationManager-178"><span class="linenos">178</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-179"><a href="#DockerIntegrationManager-179"><span class="linenos">179</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error validating system consistency: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-180"><a href="#DockerIntegrationManager-180"><span class="linenos">180</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-181"><a href="#DockerIntegrationManager-181"><span class="linenos">181</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span><span id="DockerIntegrationManager-182"><a href="#DockerIntegrationManager-182"><span class="linenos">182</span></a>
</span><span id="DockerIntegrationManager-183"><a href="#DockerIntegrationManager-183"><span class="linenos">183</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pre_initialization_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto_fix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">force_restart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="DockerIntegrationManager-184"><a href="#DockerIntegrationManager-184"><span class="linenos">184</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform pre-initialization consistency check and optional auto-fix.</span>
</span><span id="DockerIntegrationManager-185"><a href="#DockerIntegrationManager-185"><span class="linenos">185</span></a><span class="sd">        </span>
</span><span id="DockerIntegrationManager-186"><a href="#DockerIntegrationManager-186"><span class="linenos">186</span></a><span class="sd">        This method should be called before initializing the personal agent system</span>
</span><span id="DockerIntegrationManager-187"><a href="#DockerIntegrationManager-187"><span class="linenos">187</span></a><span class="sd">        to ensure Docker configurations are consistent.</span>
</span><span id="DockerIntegrationManager-188"><a href="#DockerIntegrationManager-188"><span class="linenos">188</span></a><span class="sd">        </span>
</span><span id="DockerIntegrationManager-189"><a href="#DockerIntegrationManager-189"><span class="linenos">189</span></a><span class="sd">        Args:</span>
</span><span id="DockerIntegrationManager-190"><a href="#DockerIntegrationManager-190"><span class="linenos">190</span></a><span class="sd">            auto_fix: If True, automatically fix inconsistencies</span>
</span><span id="DockerIntegrationManager-191"><a href="#DockerIntegrationManager-191"><span class="linenos">191</span></a><span class="sd">            force_restart: If True, restart containers even if not running</span>
</span><span id="DockerIntegrationManager-192"><a href="#DockerIntegrationManager-192"><span class="linenos">192</span></a><span class="sd">            </span>
</span><span id="DockerIntegrationManager-193"><a href="#DockerIntegrationManager-193"><span class="linenos">193</span></a><span class="sd">        Returns:</span>
</span><span id="DockerIntegrationManager-194"><a href="#DockerIntegrationManager-194"><span class="linenos">194</span></a><span class="sd">            Tuple of (ready_to_proceed, message)</span>
</span><span id="DockerIntegrationManager-195"><a href="#DockerIntegrationManager-195"><span class="linenos">195</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DockerIntegrationManager-196"><a href="#DockerIntegrationManager-196"><span class="linenos">196</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performing pre-initialization Docker consistency check for USER_ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-197"><a href="#DockerIntegrationManager-197"><span class="linenos">197</span></a>        
</span><span id="DockerIntegrationManager-198"><a href="#DockerIntegrationManager-198"><span class="linenos">198</span></a>        <span class="c1"># Check current consistency</span>
</span><span id="DockerIntegrationManager-199"><a href="#DockerIntegrationManager-199"><span class="linenos">199</span></a>        <span class="n">is_consistent</span><span class="p">,</span> <span class="n">check_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_docker_consistency</span><span class="p">()</span>
</span><span id="DockerIntegrationManager-200"><a href="#DockerIntegrationManager-200"><span class="linenos">200</span></a>        
</span><span id="DockerIntegrationManager-201"><a href="#DockerIntegrationManager-201"><span class="linenos">201</span></a>        <span class="k">if</span> <span class="n">is_consistent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_restart</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-202"><a href="#DockerIntegrationManager-202"><span class="linenos">202</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pre-initialization check passed - Docker configurations consistent&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-203"><a href="#DockerIntegrationManager-203"><span class="linenos">203</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">check_message</span>
</span><span id="DockerIntegrationManager-204"><a href="#DockerIntegrationManager-204"><span class="linenos">204</span></a>        <span class="k">elif</span> <span class="n">is_consistent</span> <span class="ow">and</span> <span class="n">force_restart</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-205"><a href="#DockerIntegrationManager-205"><span class="linenos">205</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Docker configurations consistent, but force restart requested&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-206"><a href="#DockerIntegrationManager-206"><span class="linenos">206</span></a>            <span class="c1"># Even if consistent, we need to restart if force_restart is True</span>
</span><span id="DockerIntegrationManager-207"><a href="#DockerIntegrationManager-207"><span class="linenos">207</span></a>            <span class="k">if</span> <span class="n">auto_fix</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-208"><a href="#DockerIntegrationManager-208"><span class="linenos">208</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing force restart of Docker containers...&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-209"><a href="#DockerIntegrationManager-209"><span class="linenos">209</span></a>                <span class="n">fix_success</span><span class="p">,</span> <span class="n">fix_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_docker_consistency</span><span class="p">(</span><span class="n">force_restart</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-210"><a href="#DockerIntegrationManager-210"><span class="linenos">210</span></a>                <span class="k">if</span> <span class="n">fix_success</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-211"><a href="#DockerIntegrationManager-211"><span class="linenos">211</span></a>                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Force restart completed: </span><span class="si">{</span><span class="n">fix_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-212"><a href="#DockerIntegrationManager-212"><span class="linenos">212</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-213"><a href="#DockerIntegrationManager-213"><span class="linenos">213</span></a>                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Force restart failed: </span><span class="si">{</span><span class="n">fix_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-214"><a href="#DockerIntegrationManager-214"><span class="linenos">214</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-215"><a href="#DockerIntegrationManager-215"><span class="linenos">215</span></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Consistent but force restart requested (auto-fix disabled): </span><span class="si">{</span><span class="n">check_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-216"><a href="#DockerIntegrationManager-216"><span class="linenos">216</span></a>        
</span><span id="DockerIntegrationManager-217"><a href="#DockerIntegrationManager-217"><span class="linenos">217</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pre-initialization check failed: </span><span class="si">{</span><span class="n">check_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-218"><a href="#DockerIntegrationManager-218"><span class="linenos">218</span></a>        
</span><span id="DockerIntegrationManager-219"><a href="#DockerIntegrationManager-219"><span class="linenos">219</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_fix</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-220"><a href="#DockerIntegrationManager-220"><span class="linenos">220</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Docker inconsistency detected (auto-fix disabled): </span><span class="si">{</span><span class="n">check_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-221"><a href="#DockerIntegrationManager-221"><span class="linenos">221</span></a>        
</span><span id="DockerIntegrationManager-222"><a href="#DockerIntegrationManager-222"><span class="linenos">222</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to auto-fix Docker inconsistencies...&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-223"><a href="#DockerIntegrationManager-223"><span class="linenos">223</span></a>        
</span><span id="DockerIntegrationManager-224"><a href="#DockerIntegrationManager-224"><span class="linenos">224</span></a>        <span class="c1"># Attempt to fix inconsistencies</span>
</span><span id="DockerIntegrationManager-225"><a href="#DockerIntegrationManager-225"><span class="linenos">225</span></a>        <span class="n">fix_success</span><span class="p">,</span> <span class="n">fix_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_docker_consistency</span><span class="p">(</span><span class="n">force_restart</span><span class="o">=</span><span class="n">force_restart</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-226"><a href="#DockerIntegrationManager-226"><span class="linenos">226</span></a>        
</span><span id="DockerIntegrationManager-227"><a href="#DockerIntegrationManager-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="n">fix_success</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-228"><a href="#DockerIntegrationManager-228"><span class="linenos">228</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Auto-fix successful - system ready for initialization&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-229"><a href="#DockerIntegrationManager-229"><span class="linenos">229</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Auto-fixed Docker inconsistencies: </span><span class="si">{</span><span class="n">fix_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager-230"><a href="#DockerIntegrationManager-230"><span class="linenos">230</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager-231"><a href="#DockerIntegrationManager-231"><span class="linenos">231</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Auto-fix failed - manual intervention required&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager-232"><a href="#DockerIntegrationManager-232"><span class="linenos">232</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Failed to auto-fix Docker inconsistencies: </span><span class="si">{</span><span class="n">fix_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Manages Docker integration for the personal agent system.</p>
</div>


                            <div id="DockerIntegrationManager.__init__" class="classattr">
                                        <input id="DockerIntegrationManager.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DockerIntegrationManager</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="DockerIntegrationManager.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DockerIntegrationManager.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DockerIntegrationManager.__init__-43"><a href="#DockerIntegrationManager.__init__-43"><span class="linenos">43</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="DockerIntegrationManager.__init__-44"><a href="#DockerIntegrationManager.__init__-44"><span class="linenos">44</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Docker integration manager.</span>
</span><span id="DockerIntegrationManager.__init__-45"><a href="#DockerIntegrationManager.__init__-45"><span class="linenos">45</span></a><span class="sd">        </span>
</span><span id="DockerIntegrationManager.__init__-46"><a href="#DockerIntegrationManager.__init__-46"><span class="linenos">46</span></a><span class="sd">        Args:</span>
</span><span id="DockerIntegrationManager.__init__-47"><a href="#DockerIntegrationManager.__init__-47"><span class="linenos">47</span></a><span class="sd">            user_id: User ID to ensure consistency for (defaults to system USER_ID)</span>
</span><span id="DockerIntegrationManager.__init__-48"><a href="#DockerIntegrationManager.__init__-48"><span class="linenos">48</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DockerIntegrationManager.__init__-49"><a href="#DockerIntegrationManager.__init__-49"><span class="linenos">49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span> <span class="ow">or</span> <span class="n">get_userid</span><span class="p">()</span>
</span><span id="DockerIntegrationManager.__init__-50"><a href="#DockerIntegrationManager.__init__-50"><span class="linenos">50</span></a>        
</span><span id="DockerIntegrationManager.__init__-51"><a href="#DockerIntegrationManager.__init__-51"><span class="linenos">51</span></a>        <span class="c1"># Fix: Use the same robust project root detection as DockerUserSync</span>
</span><span id="DockerIntegrationManager.__init__-52"><a href="#DockerIntegrationManager.__init__-52"><span class="linenos">52</span></a>        <span class="n">current_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span><span id="DockerIntegrationManager.__init__-53"><a href="#DockerIntegrationManager.__init__-53"><span class="linenos">53</span></a>        <span class="n">project_root</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DockerIntegrationManager.__init__-54"><a href="#DockerIntegrationManager.__init__-54"><span class="linenos">54</span></a>        
</span><span id="DockerIntegrationManager.__init__-55"><a href="#DockerIntegrationManager.__init__-55"><span class="linenos">55</span></a>        <span class="c1"># Walk up the directory tree looking for project markers</span>
</span><span id="DockerIntegrationManager.__init__-56"><a href="#DockerIntegrationManager.__init__-56"><span class="linenos">56</span></a>        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">current_path</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.__init__-57"><a href="#DockerIntegrationManager.__init__-57"><span class="linenos">57</span></a>            <span class="c1"># Look for common project root indicators</span>
</span><span id="DockerIntegrationManager.__init__-58"><a href="#DockerIntegrationManager.__init__-58"><span class="linenos">58</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">parent</span> <span class="o">/</span> <span class="n">marker</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="DockerIntegrationManager.__init__-59"><a href="#DockerIntegrationManager.__init__-59"><span class="linenos">59</span></a>                <span class="s1">&#39;pyproject.toml&#39;</span><span class="p">,</span> <span class="s1">&#39;setup.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.git&#39;</span><span class="p">,</span>
</span><span id="DockerIntegrationManager.__init__-60"><a href="#DockerIntegrationManager.__init__-60"><span class="linenos">60</span></a>                <span class="s1">&#39;lightrag_server&#39;</span><span class="p">,</span> <span class="s1">&#39;lightrag_memory_server&#39;</span>
</span><span id="DockerIntegrationManager.__init__-61"><a href="#DockerIntegrationManager.__init__-61"><span class="linenos">61</span></a>            <span class="p">]):</span>
</span><span id="DockerIntegrationManager.__init__-62"><a href="#DockerIntegrationManager.__init__-62"><span class="linenos">62</span></a>                <span class="n">project_root</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="DockerIntegrationManager.__init__-63"><a href="#DockerIntegrationManager.__init__-63"><span class="linenos">63</span></a>                <span class="k">break</span>
</span><span id="DockerIntegrationManager.__init__-64"><a href="#DockerIntegrationManager.__init__-64"><span class="linenos">64</span></a>        
</span><span id="DockerIntegrationManager.__init__-65"><a href="#DockerIntegrationManager.__init__-65"><span class="linenos">65</span></a>        <span class="k">if</span> <span class="n">project_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.__init__-66"><a href="#DockerIntegrationManager.__init__-66"><span class="linenos">66</span></a>            <span class="c1"># Fallback to the old method if no markers found</span>
</span><span id="DockerIntegrationManager.__init__-67"><a href="#DockerIntegrationManager.__init__-67"><span class="linenos">67</span></a>            <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span><span id="DockerIntegrationManager.__init__-68"><a href="#DockerIntegrationManager.__init__-68"><span class="linenos">68</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DockerIntegrationManager: Using fallback path detection&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.__init__-69"><a href="#DockerIntegrationManager.__init__-69"><span class="linenos">69</span></a>        
</span><span id="DockerIntegrationManager.__init__-70"><a href="#DockerIntegrationManager.__init__-70"><span class="linenos">70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">project_root</span>
</span><span id="DockerIntegrationManager.__init__-71"><a href="#DockerIntegrationManager.__init__-71"><span class="linenos">71</span></a>        
</span><span id="DockerIntegrationManager.__init__-72"><a href="#DockerIntegrationManager.__init__-72"><span class="linenos">72</span></a>        <span class="c1"># Initialize Docker sync manager if available</span>
</span><span id="DockerIntegrationManager.__init__-73"><a href="#DockerIntegrationManager.__init__-73"><span class="linenos">73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DockerIntegrationManager.__init__-74"><a href="#DockerIntegrationManager.__init__-74"><span class="linenos">74</span></a>        <span class="k">if</span> <span class="n">DockerUserSync</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.__init__-75"><a href="#DockerIntegrationManager.__init__-75"><span class="linenos">75</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.__init__-76"><a href="#DockerIntegrationManager.__init__-76"><span class="linenos">76</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span> <span class="o">=</span> <span class="n">DockerUserSync</span><span class="p">(</span><span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.__init__-77"><a href="#DockerIntegrationManager.__init__-77"><span class="linenos">77</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Docker sync manager initialized successfully&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.__init__-78"><a href="#DockerIntegrationManager.__init__-78"><span class="linenos">78</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.__init__-79"><a href="#DockerIntegrationManager.__init__-79"><span class="linenos">79</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize Docker sync manager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.__init__-80"><a href="#DockerIntegrationManager.__init__-80"><span class="linenos">80</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.__init__-81"><a href="#DockerIntegrationManager.__init__-81"><span class="linenos">81</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DockerUserSync not available - Docker integration disabled&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the Docker integration manager.</p>

<p>Args:
    user_id: User ID to ensure consistency for (defaults to system USER_ID)</p>
</div>


                            </div>
                            <div id="DockerIntegrationManager.user_id" class="classattr">
                                <div class="attr variable">
            <span class="name">user_id</span>

        
    </div>
    <a class="headerlink" href="#DockerIntegrationManager.user_id"></a>
    
    

                            </div>
                            <div id="DockerIntegrationManager.base_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">base_dir</span>

        
    </div>
    <a class="headerlink" href="#DockerIntegrationManager.base_dir"></a>
    
    

                            </div>
                            <div id="DockerIntegrationManager.docker_sync" class="classattr">
                                <div class="attr variable">
            <span class="name">docker_sync</span>

        
    </div>
    <a class="headerlink" href="#DockerIntegrationManager.docker_sync"></a>
    
    

                            </div>
                            <div id="DockerIntegrationManager.check_docker_consistency" class="classattr">
                                        <input id="DockerIntegrationManager.check_docker_consistency-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_docker_consistency</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="DockerIntegrationManager.check_docker_consistency-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DockerIntegrationManager.check_docker_consistency"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DockerIntegrationManager.check_docker_consistency-83"><a href="#DockerIntegrationManager.check_docker_consistency-83"><span class="linenos"> 83</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_docker_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-84"><a href="#DockerIntegrationManager.check_docker_consistency-84"><span class="linenos"> 84</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if Docker configurations are consistent with system USER_ID.</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-85"><a href="#DockerIntegrationManager.check_docker_consistency-85"><span class="linenos"> 85</span></a><span class="sd">        </span>
</span><span id="DockerIntegrationManager.check_docker_consistency-86"><a href="#DockerIntegrationManager.check_docker_consistency-86"><span class="linenos"> 86</span></a><span class="sd">        Returns:</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-87"><a href="#DockerIntegrationManager.check_docker_consistency-87"><span class="linenos"> 87</span></a><span class="sd">            Tuple of (is_consistent, message)</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-88"><a href="#DockerIntegrationManager.check_docker_consistency-88"><span class="linenos"> 88</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-89"><a href="#DockerIntegrationManager.check_docker_consistency-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-90"><a href="#DockerIntegrationManager.check_docker_consistency-90"><span class="linenos"> 90</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Docker sync not available - skipping consistency check&quot;</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-91"><a href="#DockerIntegrationManager.check_docker_consistency-91"><span class="linenos"> 91</span></a>        
</span><span id="DockerIntegrationManager.check_docker_consistency-92"><a href="#DockerIntegrationManager.check_docker_consistency-92"><span class="linenos"> 92</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-93"><a href="#DockerIntegrationManager.check_docker_consistency-93"><span class="linenos"> 93</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="o">.</span><span class="n">check_user_id_consistency</span><span class="p">()</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-94"><a href="#DockerIntegrationManager.check_docker_consistency-94"><span class="linenos"> 94</span></a>            <span class="n">all_consistent</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;consistent&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-95"><a href="#DockerIntegrationManager.check_docker_consistency-95"><span class="linenos"> 95</span></a>            
</span><span id="DockerIntegrationManager.check_docker_consistency-96"><a href="#DockerIntegrationManager.check_docker_consistency-96"><span class="linenos"> 96</span></a>            <span class="k">if</span> <span class="n">all_consistent</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-97"><a href="#DockerIntegrationManager.check_docker_consistency-97"><span class="linenos"> 97</span></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;All Docker configurations consistent with USER_ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-98"><a href="#DockerIntegrationManager.check_docker_consistency-98"><span class="linenos"> 98</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-99"><a href="#DockerIntegrationManager.check_docker_consistency-99"><span class="linenos"> 99</span></a>                <span class="n">inconsistent_servers</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-100"><a href="#DockerIntegrationManager.check_docker_consistency-100"><span class="linenos">100</span></a>                    <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
</span><span id="DockerIntegrationManager.check_docker_consistency-101"><a href="#DockerIntegrationManager.check_docker_consistency-101"><span class="linenos">101</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;consistent&#39;</span><span class="p">]</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-102"><a href="#DockerIntegrationManager.check_docker_consistency-102"><span class="linenos">102</span></a>                <span class="p">]</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-103"><a href="#DockerIntegrationManager.check_docker_consistency-103"><span class="linenos">103</span></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Inconsistent Docker servers: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inconsistent_servers</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-104"><a href="#DockerIntegrationManager.check_docker_consistency-104"><span class="linenos">104</span></a>                
</span><span id="DockerIntegrationManager.check_docker_consistency-105"><a href="#DockerIntegrationManager.check_docker_consistency-105"><span class="linenos">105</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-106"><a href="#DockerIntegrationManager.check_docker_consistency-106"><span class="linenos">106</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking Docker consistency: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.check_docker_consistency-107"><a href="#DockerIntegrationManager.check_docker_consistency-107"><span class="linenos">107</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error checking Docker consistency: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Check if Docker configurations are consistent with system USER_ID.</p>

<p>Returns:
    Tuple of (is_consistent, message)</p>
</div>


                            </div>
                            <div id="DockerIntegrationManager.ensure_docker_consistency" class="classattr">
                                        <input id="DockerIntegrationManager.ensure_docker_consistency-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ensure_docker_consistency</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">force_restart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="DockerIntegrationManager.ensure_docker_consistency-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DockerIntegrationManager.ensure_docker_consistency"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DockerIntegrationManager.ensure_docker_consistency-109"><a href="#DockerIntegrationManager.ensure_docker_consistency-109"><span class="linenos">109</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_docker_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_restart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-110"><a href="#DockerIntegrationManager.ensure_docker_consistency-110"><span class="linenos">110</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure Docker configurations are consistent with system USER_ID.</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-111"><a href="#DockerIntegrationManager.ensure_docker_consistency-111"><span class="linenos">111</span></a><span class="sd">        </span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-112"><a href="#DockerIntegrationManager.ensure_docker_consistency-112"><span class="linenos">112</span></a><span class="sd">        Args:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-113"><a href="#DockerIntegrationManager.ensure_docker_consistency-113"><span class="linenos">113</span></a><span class="sd">            force_restart: If True, restart containers even if not running</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-114"><a href="#DockerIntegrationManager.ensure_docker_consistency-114"><span class="linenos">114</span></a><span class="sd">            </span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-115"><a href="#DockerIntegrationManager.ensure_docker_consistency-115"><span class="linenos">115</span></a><span class="sd">        Returns:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-116"><a href="#DockerIntegrationManager.ensure_docker_consistency-116"><span class="linenos">116</span></a><span class="sd">            Tuple of (success, message)</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-117"><a href="#DockerIntegrationManager.ensure_docker_consistency-117"><span class="linenos">117</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-118"><a href="#DockerIntegrationManager.ensure_docker_consistency-118"><span class="linenos">118</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-119"><a href="#DockerIntegrationManager.ensure_docker_consistency-119"><span class="linenos">119</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Docker sync not available - skipping consistency enforcement&quot;</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-120"><a href="#DockerIntegrationManager.ensure_docker_consistency-120"><span class="linenos">120</span></a>        
</span><span id="DockerIntegrationManager.ensure_docker_consistency-121"><a href="#DockerIntegrationManager.ensure_docker_consistency-121"><span class="linenos">121</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-122"><a href="#DockerIntegrationManager.ensure_docker_consistency-122"><span class="linenos">122</span></a>            <span class="c1"># First check if sync is needed</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-123"><a href="#DockerIntegrationManager.ensure_docker_consistency-123"><span class="linenos">123</span></a>            <span class="n">is_consistent</span><span class="p">,</span> <span class="n">check_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_docker_consistency</span><span class="p">()</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-124"><a href="#DockerIntegrationManager.ensure_docker_consistency-124"><span class="linenos">124</span></a>            
</span><span id="DockerIntegrationManager.ensure_docker_consistency-125"><a href="#DockerIntegrationManager.ensure_docker_consistency-125"><span class="linenos">125</span></a>            <span class="k">if</span> <span class="n">is_consistent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_restart</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-126"><a href="#DockerIntegrationManager.ensure_docker_consistency-126"><span class="linenos">126</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Docker configurations already consistent&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-127"><a href="#DockerIntegrationManager.ensure_docker_consistency-127"><span class="linenos">127</span></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">check_message</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-128"><a href="#DockerIntegrationManager.ensure_docker_consistency-128"><span class="linenos">128</span></a>            <span class="k">elif</span> <span class="n">is_consistent</span> <span class="ow">and</span> <span class="n">force_restart</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-129"><a href="#DockerIntegrationManager.ensure_docker_consistency-129"><span class="linenos">129</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Docker configurations consistent, but force restart requested&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-130"><a href="#DockerIntegrationManager.ensure_docker_consistency-130"><span class="linenos">130</span></a>                <span class="c1"># Perform synchronization with force restart even if consistent</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-131"><a href="#DockerIntegrationManager.ensure_docker_consistency-131"><span class="linenos">131</span></a>                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="o">.</span><span class="n">sync_user_ids</span><span class="p">(</span><span class="n">force_restart</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-132"><a href="#DockerIntegrationManager.ensure_docker_consistency-132"><span class="linenos">132</span></a>                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-133"><a href="#DockerIntegrationManager.ensure_docker_consistency-133"><span class="linenos">133</span></a>                    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Successfully force restarted Docker containers with USER_ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-134"><a href="#DockerIntegrationManager.ensure_docker_consistency-134"><span class="linenos">134</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-135"><a href="#DockerIntegrationManager.ensure_docker_consistency-135"><span class="linenos">135</span></a>                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">message</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-136"><a href="#DockerIntegrationManager.ensure_docker_consistency-136"><span class="linenos">136</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-137"><a href="#DockerIntegrationManager.ensure_docker_consistency-137"><span class="linenos">137</span></a>                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Failed to force restart Docker containers&quot;</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-138"><a href="#DockerIntegrationManager.ensure_docker_consistency-138"><span class="linenos">138</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-139"><a href="#DockerIntegrationManager.ensure_docker_consistency-139"><span class="linenos">139</span></a>                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">message</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-140"><a href="#DockerIntegrationManager.ensure_docker_consistency-140"><span class="linenos">140</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-141"><a href="#DockerIntegrationManager.ensure_docker_consistency-141"><span class="linenos">141</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Docker inconsistency detected: </span><span class="si">{</span><span class="n">check_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-142"><a href="#DockerIntegrationManager.ensure_docker_consistency-142"><span class="linenos">142</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to synchronize Docker configurations...&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-143"><a href="#DockerIntegrationManager.ensure_docker_consistency-143"><span class="linenos">143</span></a>                
</span><span id="DockerIntegrationManager.ensure_docker_consistency-144"><a href="#DockerIntegrationManager.ensure_docker_consistency-144"><span class="linenos">144</span></a>                <span class="c1"># Perform synchronization</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-145"><a href="#DockerIntegrationManager.ensure_docker_consistency-145"><span class="linenos">145</span></a>                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="o">.</span><span class="n">sync_user_ids</span><span class="p">(</span><span class="n">force_restart</span><span class="o">=</span><span class="n">force_restart</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-146"><a href="#DockerIntegrationManager.ensure_docker_consistency-146"><span class="linenos">146</span></a>                
</span><span id="DockerIntegrationManager.ensure_docker_consistency-147"><a href="#DockerIntegrationManager.ensure_docker_consistency-147"><span class="linenos">147</span></a>                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-148"><a href="#DockerIntegrationManager.ensure_docker_consistency-148"><span class="linenos">148</span></a>                    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Successfully synchronized Docker configurations with USER_ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-149"><a href="#DockerIntegrationManager.ensure_docker_consistency-149"><span class="linenos">149</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-150"><a href="#DockerIntegrationManager.ensure_docker_consistency-150"><span class="linenos">150</span></a>                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">message</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-151"><a href="#DockerIntegrationManager.ensure_docker_consistency-151"><span class="linenos">151</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-152"><a href="#DockerIntegrationManager.ensure_docker_consistency-152"><span class="linenos">152</span></a>                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Failed to synchronize Docker configurations&quot;</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-153"><a href="#DockerIntegrationManager.ensure_docker_consistency-153"><span class="linenos">153</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-154"><a href="#DockerIntegrationManager.ensure_docker_consistency-154"><span class="linenos">154</span></a>                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">message</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-155"><a href="#DockerIntegrationManager.ensure_docker_consistency-155"><span class="linenos">155</span></a>                
</span><span id="DockerIntegrationManager.ensure_docker_consistency-156"><a href="#DockerIntegrationManager.ensure_docker_consistency-156"><span class="linenos">156</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-157"><a href="#DockerIntegrationManager.ensure_docker_consistency-157"><span class="linenos">157</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error ensuring Docker consistency: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-158"><a href="#DockerIntegrationManager.ensure_docker_consistency-158"><span class="linenos">158</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.ensure_docker_consistency-159"><a href="#DockerIntegrationManager.ensure_docker_consistency-159"><span class="linenos">159</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span></pre></div>


            <div class="docstring"><p>Ensure Docker configurations are consistent with system USER_ID.</p>

<p>Args:
    force_restart: If True, restart containers even if not running</p>

<p>Returns:
    Tuple of (success, message)</p>
</div>


                            </div>
                            <div id="DockerIntegrationManager.validate_system_consistency" class="classattr">
                                        <input id="DockerIntegrationManager.validate_system_consistency-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">validate_system_consistency</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="DockerIntegrationManager.validate_system_consistency-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DockerIntegrationManager.validate_system_consistency"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DockerIntegrationManager.validate_system_consistency-161"><a href="#DockerIntegrationManager.validate_system_consistency-161"><span class="linenos">161</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_system_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-162"><a href="#DockerIntegrationManager.validate_system_consistency-162"><span class="linenos">162</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform comprehensive validation of system consistency.</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-163"><a href="#DockerIntegrationManager.validate_system_consistency-163"><span class="linenos">163</span></a><span class="sd">        </span>
</span><span id="DockerIntegrationManager.validate_system_consistency-164"><a href="#DockerIntegrationManager.validate_system_consistency-164"><span class="linenos">164</span></a><span class="sd">        Returns:</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-165"><a href="#DockerIntegrationManager.validate_system_consistency-165"><span class="linenos">165</span></a><span class="sd">            Tuple of (is_consistent, message)</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-166"><a href="#DockerIntegrationManager.validate_system_consistency-166"><span class="linenos">166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-167"><a href="#DockerIntegrationManager.validate_system_consistency-167"><span class="linenos">167</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-168"><a href="#DockerIntegrationManager.validate_system_consistency-168"><span class="linenos">168</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Docker sync not available - skipping validation&quot;</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-169"><a href="#DockerIntegrationManager.validate_system_consistency-169"><span class="linenos">169</span></a>        
</span><span id="DockerIntegrationManager.validate_system_consistency-170"><a href="#DockerIntegrationManager.validate_system_consistency-170"><span class="linenos">170</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-171"><a href="#DockerIntegrationManager.validate_system_consistency-171"><span class="linenos">171</span></a>            <span class="n">is_consistent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_sync</span><span class="o">.</span><span class="n">validate_system_consistency</span><span class="p">()</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-172"><a href="#DockerIntegrationManager.validate_system_consistency-172"><span class="linenos">172</span></a>            
</span><span id="DockerIntegrationManager.validate_system_consistency-173"><a href="#DockerIntegrationManager.validate_system_consistency-173"><span class="linenos">173</span></a>            <span class="k">if</span> <span class="n">is_consistent</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-174"><a href="#DockerIntegrationManager.validate_system_consistency-174"><span class="linenos">174</span></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;System is fully consistent with USER_ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-175"><a href="#DockerIntegrationManager.validate_system_consistency-175"><span class="linenos">175</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-176"><a href="#DockerIntegrationManager.validate_system_consistency-176"><span class="linenos">176</span></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;System inconsistencies detected - check logs for details&quot;</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-177"><a href="#DockerIntegrationManager.validate_system_consistency-177"><span class="linenos">177</span></a>                
</span><span id="DockerIntegrationManager.validate_system_consistency-178"><a href="#DockerIntegrationManager.validate_system_consistency-178"><span class="linenos">178</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-179"><a href="#DockerIntegrationManager.validate_system_consistency-179"><span class="linenos">179</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error validating system consistency: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-180"><a href="#DockerIntegrationManager.validate_system_consistency-180"><span class="linenos">180</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.validate_system_consistency-181"><a href="#DockerIntegrationManager.validate_system_consistency-181"><span class="linenos">181</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span></pre></div>


            <div class="docstring"><p>Perform comprehensive validation of system consistency.</p>

<p>Returns:
    Tuple of (is_consistent, message)</p>
</div>


                            </div>
                            <div id="DockerIntegrationManager.pre_initialization_check" class="classattr">
                                        <input id="DockerIntegrationManager.pre_initialization_check-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pre_initialization_check</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">auto_fix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">force_restart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="DockerIntegrationManager.pre_initialization_check-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DockerIntegrationManager.pre_initialization_check"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DockerIntegrationManager.pre_initialization_check-183"><a href="#DockerIntegrationManager.pre_initialization_check-183"><span class="linenos">183</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pre_initialization_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto_fix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">force_restart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-184"><a href="#DockerIntegrationManager.pre_initialization_check-184"><span class="linenos">184</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform pre-initialization consistency check and optional auto-fix.</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-185"><a href="#DockerIntegrationManager.pre_initialization_check-185"><span class="linenos">185</span></a><span class="sd">        </span>
</span><span id="DockerIntegrationManager.pre_initialization_check-186"><a href="#DockerIntegrationManager.pre_initialization_check-186"><span class="linenos">186</span></a><span class="sd">        This method should be called before initializing the personal agent system</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-187"><a href="#DockerIntegrationManager.pre_initialization_check-187"><span class="linenos">187</span></a><span class="sd">        to ensure Docker configurations are consistent.</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-188"><a href="#DockerIntegrationManager.pre_initialization_check-188"><span class="linenos">188</span></a><span class="sd">        </span>
</span><span id="DockerIntegrationManager.pre_initialization_check-189"><a href="#DockerIntegrationManager.pre_initialization_check-189"><span class="linenos">189</span></a><span class="sd">        Args:</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-190"><a href="#DockerIntegrationManager.pre_initialization_check-190"><span class="linenos">190</span></a><span class="sd">            auto_fix: If True, automatically fix inconsistencies</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-191"><a href="#DockerIntegrationManager.pre_initialization_check-191"><span class="linenos">191</span></a><span class="sd">            force_restart: If True, restart containers even if not running</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-192"><a href="#DockerIntegrationManager.pre_initialization_check-192"><span class="linenos">192</span></a><span class="sd">            </span>
</span><span id="DockerIntegrationManager.pre_initialization_check-193"><a href="#DockerIntegrationManager.pre_initialization_check-193"><span class="linenos">193</span></a><span class="sd">        Returns:</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-194"><a href="#DockerIntegrationManager.pre_initialization_check-194"><span class="linenos">194</span></a><span class="sd">            Tuple of (ready_to_proceed, message)</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-195"><a href="#DockerIntegrationManager.pre_initialization_check-195"><span class="linenos">195</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-196"><a href="#DockerIntegrationManager.pre_initialization_check-196"><span class="linenos">196</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performing pre-initialization Docker consistency check for USER_ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-197"><a href="#DockerIntegrationManager.pre_initialization_check-197"><span class="linenos">197</span></a>        
</span><span id="DockerIntegrationManager.pre_initialization_check-198"><a href="#DockerIntegrationManager.pre_initialization_check-198"><span class="linenos">198</span></a>        <span class="c1"># Check current consistency</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-199"><a href="#DockerIntegrationManager.pre_initialization_check-199"><span class="linenos">199</span></a>        <span class="n">is_consistent</span><span class="p">,</span> <span class="n">check_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_docker_consistency</span><span class="p">()</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-200"><a href="#DockerIntegrationManager.pre_initialization_check-200"><span class="linenos">200</span></a>        
</span><span id="DockerIntegrationManager.pre_initialization_check-201"><a href="#DockerIntegrationManager.pre_initialization_check-201"><span class="linenos">201</span></a>        <span class="k">if</span> <span class="n">is_consistent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_restart</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-202"><a href="#DockerIntegrationManager.pre_initialization_check-202"><span class="linenos">202</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pre-initialization check passed - Docker configurations consistent&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-203"><a href="#DockerIntegrationManager.pre_initialization_check-203"><span class="linenos">203</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">check_message</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-204"><a href="#DockerIntegrationManager.pre_initialization_check-204"><span class="linenos">204</span></a>        <span class="k">elif</span> <span class="n">is_consistent</span> <span class="ow">and</span> <span class="n">force_restart</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-205"><a href="#DockerIntegrationManager.pre_initialization_check-205"><span class="linenos">205</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Docker configurations consistent, but force restart requested&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-206"><a href="#DockerIntegrationManager.pre_initialization_check-206"><span class="linenos">206</span></a>            <span class="c1"># Even if consistent, we need to restart if force_restart is True</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-207"><a href="#DockerIntegrationManager.pre_initialization_check-207"><span class="linenos">207</span></a>            <span class="k">if</span> <span class="n">auto_fix</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-208"><a href="#DockerIntegrationManager.pre_initialization_check-208"><span class="linenos">208</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing force restart of Docker containers...&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-209"><a href="#DockerIntegrationManager.pre_initialization_check-209"><span class="linenos">209</span></a>                <span class="n">fix_success</span><span class="p">,</span> <span class="n">fix_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_docker_consistency</span><span class="p">(</span><span class="n">force_restart</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-210"><a href="#DockerIntegrationManager.pre_initialization_check-210"><span class="linenos">210</span></a>                <span class="k">if</span> <span class="n">fix_success</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-211"><a href="#DockerIntegrationManager.pre_initialization_check-211"><span class="linenos">211</span></a>                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Force restart completed: </span><span class="si">{</span><span class="n">fix_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-212"><a href="#DockerIntegrationManager.pre_initialization_check-212"><span class="linenos">212</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-213"><a href="#DockerIntegrationManager.pre_initialization_check-213"><span class="linenos">213</span></a>                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Force restart failed: </span><span class="si">{</span><span class="n">fix_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-214"><a href="#DockerIntegrationManager.pre_initialization_check-214"><span class="linenos">214</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-215"><a href="#DockerIntegrationManager.pre_initialization_check-215"><span class="linenos">215</span></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Consistent but force restart requested (auto-fix disabled): </span><span class="si">{</span><span class="n">check_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-216"><a href="#DockerIntegrationManager.pre_initialization_check-216"><span class="linenos">216</span></a>        
</span><span id="DockerIntegrationManager.pre_initialization_check-217"><a href="#DockerIntegrationManager.pre_initialization_check-217"><span class="linenos">217</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pre-initialization check failed: </span><span class="si">{</span><span class="n">check_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-218"><a href="#DockerIntegrationManager.pre_initialization_check-218"><span class="linenos">218</span></a>        
</span><span id="DockerIntegrationManager.pre_initialization_check-219"><a href="#DockerIntegrationManager.pre_initialization_check-219"><span class="linenos">219</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_fix</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-220"><a href="#DockerIntegrationManager.pre_initialization_check-220"><span class="linenos">220</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Docker inconsistency detected (auto-fix disabled): </span><span class="si">{</span><span class="n">check_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-221"><a href="#DockerIntegrationManager.pre_initialization_check-221"><span class="linenos">221</span></a>        
</span><span id="DockerIntegrationManager.pre_initialization_check-222"><a href="#DockerIntegrationManager.pre_initialization_check-222"><span class="linenos">222</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to auto-fix Docker inconsistencies...&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-223"><a href="#DockerIntegrationManager.pre_initialization_check-223"><span class="linenos">223</span></a>        
</span><span id="DockerIntegrationManager.pre_initialization_check-224"><a href="#DockerIntegrationManager.pre_initialization_check-224"><span class="linenos">224</span></a>        <span class="c1"># Attempt to fix inconsistencies</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-225"><a href="#DockerIntegrationManager.pre_initialization_check-225"><span class="linenos">225</span></a>        <span class="n">fix_success</span><span class="p">,</span> <span class="n">fix_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_docker_consistency</span><span class="p">(</span><span class="n">force_restart</span><span class="o">=</span><span class="n">force_restart</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-226"><a href="#DockerIntegrationManager.pre_initialization_check-226"><span class="linenos">226</span></a>        
</span><span id="DockerIntegrationManager.pre_initialization_check-227"><a href="#DockerIntegrationManager.pre_initialization_check-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="n">fix_success</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-228"><a href="#DockerIntegrationManager.pre_initialization_check-228"><span class="linenos">228</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Auto-fix successful - system ready for initialization&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-229"><a href="#DockerIntegrationManager.pre_initialization_check-229"><span class="linenos">229</span></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Auto-fixed Docker inconsistencies: </span><span class="si">{</span><span class="n">fix_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-230"><a href="#DockerIntegrationManager.pre_initialization_check-230"><span class="linenos">230</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-231"><a href="#DockerIntegrationManager.pre_initialization_check-231"><span class="linenos">231</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Auto-fix failed - manual intervention required&quot;</span><span class="p">)</span>
</span><span id="DockerIntegrationManager.pre_initialization_check-232"><a href="#DockerIntegrationManager.pre_initialization_check-232"><span class="linenos">232</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Failed to auto-fix Docker inconsistencies: </span><span class="si">{</span><span class="n">fix_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Perform pre-initialization consistency check and optional auto-fix.</p>

<p>This method should be called before initializing the personal agent system
to ensure Docker configurations are consistent.</p>

<p>Args:
    auto_fix: If True, automatically fix inconsistencies
    force_restart: If True, restart containers even if not running</p>

<p>Returns:
    Tuple of (ready_to_proceed, message)</p>
</div>


                            </div>
                </section>
                <section id="check_docker_user_consistency">
                            <input id="check_docker_user_consistency-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_docker_user_consistency</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="check_docker_user_consistency-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_docker_user_consistency"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_docker_user_consistency-258"><a href="#check_docker_user_consistency-258"><span class="linenos">258</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_docker_user_consistency</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="check_docker_user_consistency-259"><a href="#check_docker_user_consistency-259"><span class="linenos">259</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience function to check Docker USER_ID consistency without fixing.</span>
</span><span id="check_docker_user_consistency-260"><a href="#check_docker_user_consistency-260"><span class="linenos">260</span></a><span class="sd">    </span>
</span><span id="check_docker_user_consistency-261"><a href="#check_docker_user_consistency-261"><span class="linenos">261</span></a><span class="sd">    Args:</span>
</span><span id="check_docker_user_consistency-262"><a href="#check_docker_user_consistency-262"><span class="linenos">262</span></a><span class="sd">        user_id: User ID to check consistency for (defaults to system USER_ID)</span>
</span><span id="check_docker_user_consistency-263"><a href="#check_docker_user_consistency-263"><span class="linenos">263</span></a><span class="sd">        </span>
</span><span id="check_docker_user_consistency-264"><a href="#check_docker_user_consistency-264"><span class="linenos">264</span></a><span class="sd">    Returns:</span>
</span><span id="check_docker_user_consistency-265"><a href="#check_docker_user_consistency-265"><span class="linenos">265</span></a><span class="sd">        Tuple of (is_consistent, message)</span>
</span><span id="check_docker_user_consistency-266"><a href="#check_docker_user_consistency-266"><span class="linenos">266</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_docker_user_consistency-267"><a href="#check_docker_user_consistency-267"><span class="linenos">267</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="check_docker_user_consistency-268"><a href="#check_docker_user_consistency-268"><span class="linenos">268</span></a>        <span class="n">manager</span> <span class="o">=</span> <span class="n">DockerIntegrationManager</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="check_docker_user_consistency-269"><a href="#check_docker_user_consistency-269"><span class="linenos">269</span></a>        <span class="k">return</span> <span class="n">manager</span><span class="o">.</span><span class="n">check_docker_consistency</span><span class="p">()</span>
</span><span id="check_docker_user_consistency-270"><a href="#check_docker_user_consistency-270"><span class="linenos">270</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="check_docker_user_consistency-271"><a href="#check_docker_user_consistency-271"><span class="linenos">271</span></a>        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error checking Docker consistency: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="check_docker_user_consistency-272"><a href="#check_docker_user_consistency-272"><span class="linenos">272</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="check_docker_user_consistency-273"><a href="#check_docker_user_consistency-273"><span class="linenos">273</span></a>        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span></pre></div>


            <div class="docstring"><p>Convenience function to check Docker USER_ID consistency without fixing.</p>

<p>Args:
    user_id: User ID to check consistency for (defaults to system USER_ID)</p>

<p>Returns:
    Tuple of (is_consistent, message)</p>
</div>


                </section>
                <section id="ensure_docker_user_consistency">
                            <input id="ensure_docker_user_consistency-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ensure_docker_user_consistency</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">auto_fix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">force_restart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="ensure_docker_user_consistency-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ensure_docker_user_consistency"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ensure_docker_user_consistency-235"><a href="#ensure_docker_user_consistency-235"><span class="linenos">235</span></a><span class="k">def</span><span class="w"> </span><span class="nf">ensure_docker_user_consistency</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">auto_fix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">force_restart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="ensure_docker_user_consistency-236"><a href="#ensure_docker_user_consistency-236"><span class="linenos">236</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience function to ensure Docker USER_ID consistency.</span>
</span><span id="ensure_docker_user_consistency-237"><a href="#ensure_docker_user_consistency-237"><span class="linenos">237</span></a><span class="sd">    </span>
</span><span id="ensure_docker_user_consistency-238"><a href="#ensure_docker_user_consistency-238"><span class="linenos">238</span></a><span class="sd">    This function can be called from agent initialization code to ensure</span>
</span><span id="ensure_docker_user_consistency-239"><a href="#ensure_docker_user_consistency-239"><span class="linenos">239</span></a><span class="sd">    Docker configurations are consistent before proceeding.</span>
</span><span id="ensure_docker_user_consistency-240"><a href="#ensure_docker_user_consistency-240"><span class="linenos">240</span></a><span class="sd">    </span>
</span><span id="ensure_docker_user_consistency-241"><a href="#ensure_docker_user_consistency-241"><span class="linenos">241</span></a><span class="sd">    Args:</span>
</span><span id="ensure_docker_user_consistency-242"><a href="#ensure_docker_user_consistency-242"><span class="linenos">242</span></a><span class="sd">        user_id: User ID to ensure consistency for (defaults to system USER_ID)</span>
</span><span id="ensure_docker_user_consistency-243"><a href="#ensure_docker_user_consistency-243"><span class="linenos">243</span></a><span class="sd">        auto_fix: If True, automatically fix inconsistencies</span>
</span><span id="ensure_docker_user_consistency-244"><a href="#ensure_docker_user_consistency-244"><span class="linenos">244</span></a><span class="sd">        force_restart: If True, restart containers even if not running</span>
</span><span id="ensure_docker_user_consistency-245"><a href="#ensure_docker_user_consistency-245"><span class="linenos">245</span></a><span class="sd">        </span>
</span><span id="ensure_docker_user_consistency-246"><a href="#ensure_docker_user_consistency-246"><span class="linenos">246</span></a><span class="sd">    Returns:</span>
</span><span id="ensure_docker_user_consistency-247"><a href="#ensure_docker_user_consistency-247"><span class="linenos">247</span></a><span class="sd">        Tuple of (ready_to_proceed, message)</span>
</span><span id="ensure_docker_user_consistency-248"><a href="#ensure_docker_user_consistency-248"><span class="linenos">248</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ensure_docker_user_consistency-249"><a href="#ensure_docker_user_consistency-249"><span class="linenos">249</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="ensure_docker_user_consistency-250"><a href="#ensure_docker_user_consistency-250"><span class="linenos">250</span></a>        <span class="n">manager</span> <span class="o">=</span> <span class="n">DockerIntegrationManager</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="ensure_docker_user_consistency-251"><a href="#ensure_docker_user_consistency-251"><span class="linenos">251</span></a>        <span class="k">return</span> <span class="n">manager</span><span class="o">.</span><span class="n">pre_initialization_check</span><span class="p">(</span><span class="n">auto_fix</span><span class="o">=</span><span class="n">auto_fix</span><span class="p">,</span> <span class="n">force_restart</span><span class="o">=</span><span class="n">force_restart</span><span class="p">)</span>
</span><span id="ensure_docker_user_consistency-252"><a href="#ensure_docker_user_consistency-252"><span class="linenos">252</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ensure_docker_user_consistency-253"><a href="#ensure_docker_user_consistency-253"><span class="linenos">253</span></a>        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error in Docker consistency check: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ensure_docker_user_consistency-254"><a href="#ensure_docker_user_consistency-254"><span class="linenos">254</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span id="ensure_docker_user_consistency-255"><a href="#ensure_docker_user_consistency-255"><span class="linenos">255</span></a>        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
</span></pre></div>


            <div class="docstring"><p>Convenience function to ensure Docker USER_ID consistency.</p>

<p>This function can be called from agent initialization code to ensure
Docker configurations are consistent before proceeding.</p>

<p>Args:
    user_id: User ID to ensure consistency for (defaults to system USER_ID)
    auto_fix: If True, automatically fix inconsistencies
    force_restart: If True, restart containers even if not running</p>

<p>Returns:
    Tuple of (ready_to_proceed, message)</p>
</div>


                </section>
                <section id="extract_content_from_smollm2_response">
                            <input id="extract_content_from_smollm2_response-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">extract_content_from_smollm2_response</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">text</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="extract_content_from_smollm2_response-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#extract_content_from_smollm2_response"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="extract_content_from_smollm2_response-113"><a href="#extract_content_from_smollm2_response-113"><span class="linenos">113</span></a><span class="k">def</span><span class="w"> </span><span class="nf">extract_content_from_smollm2_response</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="extract_content_from_smollm2_response-114"><a href="#extract_content_from_smollm2_response-114"><span class="linenos">114</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract readable content from SmolLM2 response, handling tool response tags properly.</span>
</span><span id="extract_content_from_smollm2_response-115"><a href="#extract_content_from_smollm2_response-115"><span class="linenos">115</span></a><span class="sd">    </span>
</span><span id="extract_content_from_smollm2_response-116"><a href="#extract_content_from_smollm2_response-116"><span class="linenos">116</span></a><span class="sd">    SmolLM2 sometimes wraps the entire response in &lt;tool_response&gt; tags, so we need to</span>
</span><span id="extract_content_from_smollm2_response-117"><a href="#extract_content_from_smollm2_response-117"><span class="linenos">117</span></a><span class="sd">    extract the content from inside these tags rather than removing them entirely.</span>
</span><span id="extract_content_from_smollm2_response-118"><a href="#extract_content_from_smollm2_response-118"><span class="linenos">118</span></a><span class="sd">    </span>
</span><span id="extract_content_from_smollm2_response-119"><a href="#extract_content_from_smollm2_response-119"><span class="linenos">119</span></a><span class="sd">    Args:</span>
</span><span id="extract_content_from_smollm2_response-120"><a href="#extract_content_from_smollm2_response-120"><span class="linenos">120</span></a><span class="sd">        text: Raw response text from SmolLM2</span>
</span><span id="extract_content_from_smollm2_response-121"><a href="#extract_content_from_smollm2_response-121"><span class="linenos">121</span></a><span class="sd">        </span>
</span><span id="extract_content_from_smollm2_response-122"><a href="#extract_content_from_smollm2_response-122"><span class="linenos">122</span></a><span class="sd">    Returns:</span>
</span><span id="extract_content_from_smollm2_response-123"><a href="#extract_content_from_smollm2_response-123"><span class="linenos">123</span></a><span class="sd">        Clean content text without tool call/response XML tags</span>
</span><span id="extract_content_from_smollm2_response-124"><a href="#extract_content_from_smollm2_response-124"><span class="linenos">124</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="extract_content_from_smollm2_response-125"><a href="#extract_content_from_smollm2_response-125"><span class="linenos">125</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="extract_content_from_smollm2_response-126"><a href="#extract_content_from_smollm2_response-126"><span class="linenos">126</span></a>        <span class="k">return</span> <span class="n">text</span>
</span><span id="extract_content_from_smollm2_response-127"><a href="#extract_content_from_smollm2_response-127"><span class="linenos">127</span></a>    
</span><span id="extract_content_from_smollm2_response-128"><a href="#extract_content_from_smollm2_response-128"><span class="linenos">128</span></a>    <span class="c1"># Remove tool call blocks (for input)</span>
</span><span id="extract_content_from_smollm2_response-129"><a href="#extract_content_from_smollm2_response-129"><span class="linenos">129</span></a>    <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;tool_call&gt;.*?&lt;/tool_call&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</span><span id="extract_content_from_smollm2_response-130"><a href="#extract_content_from_smollm2_response-130"><span class="linenos">130</span></a>    
</span><span id="extract_content_from_smollm2_response-131"><a href="#extract_content_from_smollm2_response-131"><span class="linenos">131</span></a>    <span class="c1"># Handle tool response blocks - extract content from inside the tags</span>
</span><span id="extract_content_from_smollm2_response-132"><a href="#extract_content_from_smollm2_response-132"><span class="linenos">132</span></a>    <span class="n">tool_response_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&lt;tool_response&gt;(.*?)&lt;/tool_response&gt;&quot;</span>
</span><span id="extract_content_from_smollm2_response-133"><a href="#extract_content_from_smollm2_response-133"><span class="linenos">133</span></a>    <span class="n">tool_response_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">tool_response_pattern</span><span class="p">,</span> <span class="n">cleaned_text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</span><span id="extract_content_from_smollm2_response-134"><a href="#extract_content_from_smollm2_response-134"><span class="linenos">134</span></a>    
</span><span id="extract_content_from_smollm2_response-135"><a href="#extract_content_from_smollm2_response-135"><span class="linenos">135</span></a>    <span class="k">if</span> <span class="n">tool_response_matches</span><span class="p">:</span>
</span><span id="extract_content_from_smollm2_response-136"><a href="#extract_content_from_smollm2_response-136"><span class="linenos">136</span></a>        <span class="c1"># If we found tool_response tags, check if they contain actual response content</span>
</span><span id="extract_content_from_smollm2_response-137"><a href="#extract_content_from_smollm2_response-137"><span class="linenos">137</span></a>        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">tool_response_matches</span><span class="p">:</span>
</span><span id="extract_content_from_smollm2_response-138"><a href="#extract_content_from_smollm2_response-138"><span class="linenos">138</span></a>            <span class="n">match_content</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="extract_content_from_smollm2_response-139"><a href="#extract_content_from_smollm2_response-139"><span class="linenos">139</span></a>            <span class="c1"># If the content looks like JSON (tool output), remove it</span>
</span><span id="extract_content_from_smollm2_response-140"><a href="#extract_content_from_smollm2_response-140"><span class="linenos">140</span></a>            <span class="k">if</span> <span class="n">match_content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">match_content</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">):</span>
</span><span id="extract_content_from_smollm2_response-141"><a href="#extract_content_from_smollm2_response-141"><span class="linenos">141</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="extract_content_from_smollm2_response-142"><a href="#extract_content_from_smollm2_response-142"><span class="linenos">142</span></a>                    <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">match_content</span><span class="p">)</span>  <span class="c1"># Validate it&#39;s JSON</span>
</span><span id="extract_content_from_smollm2_response-143"><a href="#extract_content_from_smollm2_response-143"><span class="linenos">143</span></a>                    <span class="c1"># It&#39;s JSON tool output, remove the entire block</span>
</span><span id="extract_content_from_smollm2_response-144"><a href="#extract_content_from_smollm2_response-144"><span class="linenos">144</span></a>                    <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;tool_response&gt;.*?&lt;/tool_response&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">cleaned_text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</span><span id="extract_content_from_smollm2_response-145"><a href="#extract_content_from_smollm2_response-145"><span class="linenos">145</span></a>                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
</span><span id="extract_content_from_smollm2_response-146"><a href="#extract_content_from_smollm2_response-146"><span class="linenos">146</span></a>                    <span class="c1"># Not valid JSON, might be actual response content, extract it</span>
</span><span id="extract_content_from_smollm2_response-147"><a href="#extract_content_from_smollm2_response-147"><span class="linenos">147</span></a>                    <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">tool_response_pattern</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">cleaned_text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</span><span id="extract_content_from_smollm2_response-148"><a href="#extract_content_from_smollm2_response-148"><span class="linenos">148</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="extract_content_from_smollm2_response-149"><a href="#extract_content_from_smollm2_response-149"><span class="linenos">149</span></a>                <span class="c1"># Not JSON, likely actual response content, extract it</span>
</span><span id="extract_content_from_smollm2_response-150"><a href="#extract_content_from_smollm2_response-150"><span class="linenos">150</span></a>                <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">tool_response_pattern</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">cleaned_text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</span><span id="extract_content_from_smollm2_response-151"><a href="#extract_content_from_smollm2_response-151"><span class="linenos">151</span></a>    
</span><span id="extract_content_from_smollm2_response-152"><a href="#extract_content_from_smollm2_response-152"><span class="linenos">152</span></a>    <span class="c1"># Clean up extra whitespace and newlines</span>
</span><span id="extract_content_from_smollm2_response-153"><a href="#extract_content_from_smollm2_response-153"><span class="linenos">153</span></a>    <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\n\s*\n&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cleaned_text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="extract_content_from_smollm2_response-154"><a href="#extract_content_from_smollm2_response-154"><span class="linenos">154</span></a>    
</span><span id="extract_content_from_smollm2_response-155"><a href="#extract_content_from_smollm2_response-155"><span class="linenos">155</span></a>    <span class="k">return</span> <span class="n">cleaned_text</span>
</span></pre></div>


            <div class="docstring"><p>Extract readable content from SmolLM2 response, handling tool response tags properly.</p>

<p>SmolLM2 sometimes wraps the entire response in <tool_response> tags, so we need to
extract the content from inside these tags rather than removing them entirely.</p>

<p>Args:
    text: Raw response text from SmolLM2</p>

<p>Returns:
    Clean content text without tool call/response XML tags</p>
</div>


                </section>
                <section id="format_smollm2_system_prompt">
                            <input id="format_smollm2_system_prompt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">format_smollm2_system_prompt</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="format_smollm2_system_prompt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#format_smollm2_system_prompt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="format_smollm2_system_prompt-69"><a href="#format_smollm2_system_prompt-69"><span class="linenos">69</span></a><span class="k">def</span><span class="w"> </span><span class="nf">format_smollm2_system_prompt</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="format_smollm2_system_prompt-70"><a href="#format_smollm2_system_prompt-70"><span class="linenos">70</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Format a system prompt for SmolLM2 with tool definitions.</span>
</span><span id="format_smollm2_system_prompt-71"><a href="#format_smollm2_system_prompt-71"><span class="linenos">71</span></a><span class="sd">    </span>
</span><span id="format_smollm2_system_prompt-72"><a href="#format_smollm2_system_prompt-72"><span class="linenos">72</span></a><span class="sd">    Args:</span>
</span><span id="format_smollm2_system_prompt-73"><a href="#format_smollm2_system_prompt-73"><span class="linenos">73</span></a><span class="sd">        tools: List of tool definitions in JSON schema format</span>
</span><span id="format_smollm2_system_prompt-74"><a href="#format_smollm2_system_prompt-74"><span class="linenos">74</span></a><span class="sd">        </span>
</span><span id="format_smollm2_system_prompt-75"><a href="#format_smollm2_system_prompt-75"><span class="linenos">75</span></a><span class="sd">    Returns:</span>
</span><span id="format_smollm2_system_prompt-76"><a href="#format_smollm2_system_prompt-76"><span class="linenos">76</span></a><span class="sd">        Formatted system prompt string</span>
</span><span id="format_smollm2_system_prompt-77"><a href="#format_smollm2_system_prompt-77"><span class="linenos">77</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="format_smollm2_system_prompt-78"><a href="#format_smollm2_system_prompt-78"><span class="linenos">78</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">tools</span><span class="p">:</span>
</span><span id="format_smollm2_system_prompt-79"><a href="#format_smollm2_system_prompt-79"><span class="linenos">79</span></a>        <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="format_smollm2_system_prompt-80"><a href="#format_smollm2_system_prompt-80"><span class="linenos">80</span></a>    
</span><span id="format_smollm2_system_prompt-81"><a href="#format_smollm2_system_prompt-81"><span class="linenos">81</span></a>    <span class="n">tools_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="format_smollm2_system_prompt-82"><a href="#format_smollm2_system_prompt-82"><span class="linenos">82</span></a>    
</span><span id="format_smollm2_system_prompt-83"><a href="#format_smollm2_system_prompt-83"><span class="linenos">83</span></a>    <span class="n">system_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are an expert in composing functions. You are given a question and a set of possible functions.</span>
</span><span id="format_smollm2_system_prompt-84"><a href="#format_smollm2_system_prompt-84"><span class="linenos">84</span></a><span class="s2">Based on the question, you will need to make one or more function/tool calls to achieve the purpose.</span>
</span><span id="format_smollm2_system_prompt-85"><a href="#format_smollm2_system_prompt-85"><span class="linenos">85</span></a><span class="s2">If none of the functions can be used, point it out and refuse to answer.</span>
</span><span id="format_smollm2_system_prompt-86"><a href="#format_smollm2_system_prompt-86"><span class="linenos">86</span></a><span class="s2">If the given question lacks the parameters required by the function, also point it out.</span>
</span><span id="format_smollm2_system_prompt-87"><a href="#format_smollm2_system_prompt-87"><span class="linenos">87</span></a>
</span><span id="format_smollm2_system_prompt-88"><a href="#format_smollm2_system_prompt-88"><span class="linenos">88</span></a><span class="s2">You have access to the following tools:</span>
</span><span id="format_smollm2_system_prompt-89"><a href="#format_smollm2_system_prompt-89"><span class="linenos">89</span></a><span class="s2">&lt;tools&gt;</span><span class="si">{</span><span class="n">tools_json</span><span class="si">}</span><span class="s2">&lt;/tools&gt;</span>
</span><span id="format_smollm2_system_prompt-90"><a href="#format_smollm2_system_prompt-90"><span class="linenos">90</span></a>
</span><span id="format_smollm2_system_prompt-91"><a href="#format_smollm2_system_prompt-91"><span class="linenos">91</span></a><span class="s2">The output MUST strictly adhere to the following format, and NO other text MUST be included.</span>
</span><span id="format_smollm2_system_prompt-92"><a href="#format_smollm2_system_prompt-92"><span class="linenos">92</span></a><span class="s2">The example format is as follows. Please make sure the parameter type is correct. If no function call is needed, please make the tool calls an empty list &#39;[]&#39;.</span>
</span><span id="format_smollm2_system_prompt-93"><a href="#format_smollm2_system_prompt-93"><span class="linenos">93</span></a><span class="s2">&lt;tool_call&gt;[</span>
</span><span id="format_smollm2_system_prompt-94"><a href="#format_smollm2_system_prompt-94"><span class="linenos">94</span></a><span class="se">{{</span><span class="s2">&quot;name&quot;: &quot;func_name1&quot;, &quot;arguments&quot;: </span><span class="se">{{</span><span class="s2">&quot;argument1&quot;: &quot;value1&quot;, &quot;argument2&quot;: &quot;value2&quot;</span><span class="se">}}}}</span><span class="s2">,</span>
</span><span id="format_smollm2_system_prompt-95"><a href="#format_smollm2_system_prompt-95"><span class="linenos">95</span></a><span class="s2">(more tool calls as required)</span>
</span><span id="format_smollm2_system_prompt-96"><a href="#format_smollm2_system_prompt-96"><span class="linenos">96</span></a><span class="s2">]&lt;/tool_call&gt;&quot;&quot;&quot;</span>
</span><span id="format_smollm2_system_prompt-97"><a href="#format_smollm2_system_prompt-97"><span class="linenos">97</span></a>    
</span><span id="format_smollm2_system_prompt-98"><a href="#format_smollm2_system_prompt-98"><span class="linenos">98</span></a>    <span class="k">return</span> <span class="n">system_prompt</span>
</span></pre></div>


            <div class="docstring"><p>Format a system prompt for SmolLM2 with tool definitions.</p>

<p>Args:
    tools: List of tool definitions in JSON schema format</p>

<p>Returns:
    Formatted system prompt string</p>
</div>


                </section>
                <section id="is_smollm2_model">
                            <input id="is_smollm2_model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_smollm2_model</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="is_smollm2_model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#is_smollm2_model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="is_smollm2_model-101"><a href="#is_smollm2_model-101"><span class="linenos">101</span></a><span class="k">def</span><span class="w"> </span><span class="nf">is_smollm2_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="is_smollm2_model-102"><a href="#is_smollm2_model-102"><span class="linenos">102</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the given model name is a SmolLM2 model.</span>
</span><span id="is_smollm2_model-103"><a href="#is_smollm2_model-103"><span class="linenos">103</span></a><span class="sd">    </span>
</span><span id="is_smollm2_model-104"><a href="#is_smollm2_model-104"><span class="linenos">104</span></a><span class="sd">    Args:</span>
</span><span id="is_smollm2_model-105"><a href="#is_smollm2_model-105"><span class="linenos">105</span></a><span class="sd">        model_name: Name of the model to check</span>
</span><span id="is_smollm2_model-106"><a href="#is_smollm2_model-106"><span class="linenos">106</span></a><span class="sd">        </span>
</span><span id="is_smollm2_model-107"><a href="#is_smollm2_model-107"><span class="linenos">107</span></a><span class="sd">    Returns:</span>
</span><span id="is_smollm2_model-108"><a href="#is_smollm2_model-108"><span class="linenos">108</span></a><span class="sd">        True if it&#39;s a SmolLM2 model, False otherwise</span>
</span><span id="is_smollm2_model-109"><a href="#is_smollm2_model-109"><span class="linenos">109</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="is_smollm2_model-110"><a href="#is_smollm2_model-110"><span class="linenos">110</span></a>    <span class="k">return</span> <span class="s2">&quot;smollm2&quot;</span> <span class="ow">in</span> <span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Check if the given model name is a SmolLM2 model.</p>

<p>Args:
    model_name: Name of the model to check</p>

<p>Returns:
    True if it's a SmolLM2 model, False otherwise</p>
</div>


                </section>
                <section id="parse_smollm2_response">
                            <input id="parse_smollm2_response-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">parse_smollm2_response</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">text</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>:</span></span>

                <label class="view-source-button" for="parse_smollm2_response-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#parse_smollm2_response"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="parse_smollm2_response-17"><a href="#parse_smollm2_response-17"><span class="linenos">17</span></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_smollm2_response</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
</span><span id="parse_smollm2_response-18"><a href="#parse_smollm2_response-18"><span class="linenos">18</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse a response from SmolLM2 model, extracting tool calls if present.</span>
</span><span id="parse_smollm2_response-19"><a href="#parse_smollm2_response-19"><span class="linenos">19</span></a><span class="sd">    </span>
</span><span id="parse_smollm2_response-20"><a href="#parse_smollm2_response-20"><span class="linenos">20</span></a><span class="sd">    SmolLM2 uses &lt;tool_call&gt; XML tags to wrap JSON tool call data.</span>
</span><span id="parse_smollm2_response-21"><a href="#parse_smollm2_response-21"><span class="linenos">21</span></a><span class="sd">    </span>
</span><span id="parse_smollm2_response-22"><a href="#parse_smollm2_response-22"><span class="linenos">22</span></a><span class="sd">    Args:</span>
</span><span id="parse_smollm2_response-23"><a href="#parse_smollm2_response-23"><span class="linenos">23</span></a><span class="sd">        text: Response text from the SmolLM2 model</span>
</span><span id="parse_smollm2_response-24"><a href="#parse_smollm2_response-24"><span class="linenos">24</span></a><span class="sd">        </span>
</span><span id="parse_smollm2_response-25"><a href="#parse_smollm2_response-25"><span class="linenos">25</span></a><span class="sd">    Returns:</span>
</span><span id="parse_smollm2_response-26"><a href="#parse_smollm2_response-26"><span class="linenos">26</span></a><span class="sd">        Either the original text (if no tool calls) or a list of tool call dictionaries</span>
</span><span id="parse_smollm2_response-27"><a href="#parse_smollm2_response-27"><span class="linenos">27</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="parse_smollm2_response-28"><a href="#parse_smollm2_response-28"><span class="linenos">28</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="parse_smollm2_response-29"><a href="#parse_smollm2_response-29"><span class="linenos">29</span></a>        <span class="k">return</span> <span class="n">text</span>
</span><span id="parse_smollm2_response-30"><a href="#parse_smollm2_response-30"><span class="linenos">30</span></a>    
</span><span id="parse_smollm2_response-31"><a href="#parse_smollm2_response-31"><span class="linenos">31</span></a>    <span class="c1"># Pattern to match &lt;tool_call&gt;...&lt;/tool_call&gt; blocks</span>
</span><span id="parse_smollm2_response-32"><a href="#parse_smollm2_response-32"><span class="linenos">32</span></a>    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&lt;tool_call&gt;(.*?)&lt;/tool_call&gt;&quot;</span>
</span><span id="parse_smollm2_response-33"><a href="#parse_smollm2_response-33"><span class="linenos">33</span></a>    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</span><span id="parse_smollm2_response-34"><a href="#parse_smollm2_response-34"><span class="linenos">34</span></a>    
</span><span id="parse_smollm2_response-35"><a href="#parse_smollm2_response-35"><span class="linenos">35</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
</span><span id="parse_smollm2_response-36"><a href="#parse_smollm2_response-36"><span class="linenos">36</span></a>        <span class="c1"># No tool calls found, return original text</span>
</span><span id="parse_smollm2_response-37"><a href="#parse_smollm2_response-37"><span class="linenos">37</span></a>        <span class="k">return</span> <span class="n">text</span>
</span><span id="parse_smollm2_response-38"><a href="#parse_smollm2_response-38"><span class="linenos">38</span></a>    
</span><span id="parse_smollm2_response-39"><a href="#parse_smollm2_response-39"><span class="linenos">39</span></a>    <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="parse_smollm2_response-40"><a href="#parse_smollm2_response-40"><span class="linenos">40</span></a>    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
</span><span id="parse_smollm2_response-41"><a href="#parse_smollm2_response-41"><span class="linenos">41</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="parse_smollm2_response-42"><a href="#parse_smollm2_response-42"><span class="linenos">42</span></a>            <span class="c1"># Clean up the JSON content</span>
</span><span id="parse_smollm2_response-43"><a href="#parse_smollm2_response-43"><span class="linenos">43</span></a>            <span class="n">json_content</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="parse_smollm2_response-44"><a href="#parse_smollm2_response-44"><span class="linenos">44</span></a>            
</span><span id="parse_smollm2_response-45"><a href="#parse_smollm2_response-45"><span class="linenos">45</span></a>            <span class="c1"># Parse the JSON</span>
</span><span id="parse_smollm2_response-46"><a href="#parse_smollm2_response-46"><span class="linenos">46</span></a>            <span class="n">parsed_calls</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_content</span><span class="p">)</span>
</span><span id="parse_smollm2_response-47"><a href="#parse_smollm2_response-47"><span class="linenos">47</span></a>            
</span><span id="parse_smollm2_response-48"><a href="#parse_smollm2_response-48"><span class="linenos">48</span></a>            <span class="c1"># Handle both single tool call and list of tool calls</span>
</span><span id="parse_smollm2_response-49"><a href="#parse_smollm2_response-49"><span class="linenos">49</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed_calls</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="parse_smollm2_response-50"><a href="#parse_smollm2_response-50"><span class="linenos">50</span></a>                <span class="n">tool_calls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parsed_calls</span><span class="p">)</span>
</span><span id="parse_smollm2_response-51"><a href="#parse_smollm2_response-51"><span class="linenos">51</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed_calls</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="parse_smollm2_response-52"><a href="#parse_smollm2_response-52"><span class="linenos">52</span></a>                <span class="n">tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parsed_calls</span><span class="p">)</span>
</span><span id="parse_smollm2_response-53"><a href="#parse_smollm2_response-53"><span class="linenos">53</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="parse_smollm2_response-54"><a href="#parse_smollm2_response-54"><span class="linenos">54</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected tool call format: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">parsed_calls</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="parse_smollm2_response-55"><a href="#parse_smollm2_response-55"><span class="linenos">55</span></a>                
</span><span id="parse_smollm2_response-56"><a href="#parse_smollm2_response-56"><span class="linenos">56</span></a>        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="parse_smollm2_response-57"><a href="#parse_smollm2_response-57"><span class="linenos">57</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse tool call JSON: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="parse_smollm2_response-58"><a href="#parse_smollm2_response-58"><span class="linenos">58</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw content: </span><span class="si">{</span><span class="n">json_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="parse_smollm2_response-59"><a href="#parse_smollm2_response-59"><span class="linenos">59</span></a>            <span class="k">continue</span>
</span><span id="parse_smollm2_response-60"><a href="#parse_smollm2_response-60"><span class="linenos">60</span></a>    
</span><span id="parse_smollm2_response-61"><a href="#parse_smollm2_response-61"><span class="linenos">61</span></a>    <span class="k">if</span> <span class="n">tool_calls</span><span class="p">:</span>
</span><span id="parse_smollm2_response-62"><a href="#parse_smollm2_response-62"><span class="linenos">62</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tool_calls</span><span class="p">)</span><span class="si">}</span><span class="s2"> tool calls from SmolLM2 response&quot;</span><span class="p">)</span>
</span><span id="parse_smollm2_response-63"><a href="#parse_smollm2_response-63"><span class="linenos">63</span></a>        <span class="k">return</span> <span class="n">tool_calls</span>
</span><span id="parse_smollm2_response-64"><a href="#parse_smollm2_response-64"><span class="linenos">64</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="parse_smollm2_response-65"><a href="#parse_smollm2_response-65"><span class="linenos">65</span></a>        <span class="c1"># Failed to parse any tool calls, return original text</span>
</span><span id="parse_smollm2_response-66"><a href="#parse_smollm2_response-66"><span class="linenos">66</span></a>        <span class="k">return</span> <span class="n">text</span>
</span></pre></div>


            <div class="docstring"><p>Parse a response from SmolLM2 model, extracting tool calls if present.</p>

<p>SmolLM2 uses <tool_call> XML tags to wrap JSON tool call data.</p>

<p>Args:
    text: Response text from the SmolLM2 model</p>

<p>Returns:
    Either the original text (if no tool calls) or a list of tool call dictionaries</p>
</div>


                </section>
                <section id="prepare_smollm2_messages">
                            <input id="prepare_smollm2_messages-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">prepare_smollm2_messages</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">query</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="prepare_smollm2_messages-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#prepare_smollm2_messages"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="prepare_smollm2_messages-158"><a href="#prepare_smollm2_messages-158"><span class="linenos">158</span></a><span class="k">def</span><span class="w"> </span><span class="nf">prepare_smollm2_messages</span><span class="p">(</span>
</span><span id="prepare_smollm2_messages-159"><a href="#prepare_smollm2_messages-159"><span class="linenos">159</span></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="prepare_smollm2_messages-160"><a href="#prepare_smollm2_messages-160"><span class="linenos">160</span></a>    <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="prepare_smollm2_messages-161"><a href="#prepare_smollm2_messages-161"><span class="linenos">161</span></a>    <span class="n">history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="prepare_smollm2_messages-162"><a href="#prepare_smollm2_messages-162"><span class="linenos">162</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span id="prepare_smollm2_messages-163"><a href="#prepare_smollm2_messages-163"><span class="linenos">163</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare messages for SmolLM2 in the expected format.</span>
</span><span id="prepare_smollm2_messages-164"><a href="#prepare_smollm2_messages-164"><span class="linenos">164</span></a><span class="sd">    </span>
</span><span id="prepare_smollm2_messages-165"><a href="#prepare_smollm2_messages-165"><span class="linenos">165</span></a><span class="sd">    Args:</span>
</span><span id="prepare_smollm2_messages-166"><a href="#prepare_smollm2_messages-166"><span class="linenos">166</span></a><span class="sd">        query: User query</span>
</span><span id="prepare_smollm2_messages-167"><a href="#prepare_smollm2_messages-167"><span class="linenos">167</span></a><span class="sd">        tools: Available tools in JSON schema format</span>
</span><span id="prepare_smollm2_messages-168"><a href="#prepare_smollm2_messages-168"><span class="linenos">168</span></a><span class="sd">        history: Previous conversation history</span>
</span><span id="prepare_smollm2_messages-169"><a href="#prepare_smollm2_messages-169"><span class="linenos">169</span></a><span class="sd">        </span>
</span><span id="prepare_smollm2_messages-170"><a href="#prepare_smollm2_messages-170"><span class="linenos">170</span></a><span class="sd">    Returns:</span>
</span><span id="prepare_smollm2_messages-171"><a href="#prepare_smollm2_messages-171"><span class="linenos">171</span></a><span class="sd">        List of message dictionaries formatted for SmolLM2</span>
</span><span id="prepare_smollm2_messages-172"><a href="#prepare_smollm2_messages-172"><span class="linenos">172</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="prepare_smollm2_messages-173"><a href="#prepare_smollm2_messages-173"><span class="linenos">173</span></a>    <span class="k">if</span> <span class="n">tools</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="prepare_smollm2_messages-174"><a href="#prepare_smollm2_messages-174"><span class="linenos">174</span></a>        <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="prepare_smollm2_messages-175"><a href="#prepare_smollm2_messages-175"><span class="linenos">175</span></a>        
</span><span id="prepare_smollm2_messages-176"><a href="#prepare_smollm2_messages-176"><span class="linenos">176</span></a>    <span class="k">if</span> <span class="n">history</span><span class="p">:</span>
</span><span id="prepare_smollm2_messages-177"><a href="#prepare_smollm2_messages-177"><span class="linenos">177</span></a>        <span class="n">messages</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="prepare_smollm2_messages-178"><a href="#prepare_smollm2_messages-178"><span class="linenos">178</span></a>        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span>
</span><span id="prepare_smollm2_messages-179"><a href="#prepare_smollm2_messages-179"><span class="linenos">179</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="prepare_smollm2_messages-180"><a href="#prepare_smollm2_messages-180"><span class="linenos">180</span></a>        <span class="n">system_content</span> <span class="o">=</span> <span class="n">format_smollm2_system_prompt</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
</span><span id="prepare_smollm2_messages-181"><a href="#prepare_smollm2_messages-181"><span class="linenos">181</span></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="prepare_smollm2_messages-182"><a href="#prepare_smollm2_messages-182"><span class="linenos">182</span></a>            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">system_content</span><span class="p">},</span>
</span><span id="prepare_smollm2_messages-183"><a href="#prepare_smollm2_messages-183"><span class="linenos">183</span></a>            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>
</span><span id="prepare_smollm2_messages-184"><a href="#prepare_smollm2_messages-184"><span class="linenos">184</span></a>        <span class="p">]</span>
</span><span id="prepare_smollm2_messages-185"><a href="#prepare_smollm2_messages-185"><span class="linenos">185</span></a>    
</span><span id="prepare_smollm2_messages-186"><a href="#prepare_smollm2_messages-186"><span class="linenos">186</span></a>    <span class="k">return</span> <span class="n">messages</span>
</span></pre></div>


            <div class="docstring"><p>Prepare messages for SmolLM2 in the expected format.</p>

<p>Args:
    query: User query
    tools: Available tools in JSON schema format
    history: Previous conversation history</p>

<p>Returns:
    List of message dictionaries formatted for SmolLM2</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>